{"meta":{"title":"é‡‘å­çˆ¸çˆ¸ã®å®¶","subtitle":"çƒ­çˆ±ç”Ÿæ´»ï¼Œå–œæ¬¢è½¯ä»¶","description":"æ¬¢è¿æ¥åˆ°é‡‘å­çˆ¸çˆ¸åšå®¢ã®å®¶","author":"é‡‘å­çˆ¸çˆ¸","url":"https://zhangxin66666.github.io","root":"/"},"pages":[{"title":"åˆ†ç±»","date":"2022-01-11T01:48:58.103Z","updated":"2022-01-11T01:48:58.103Z","comments":true,"path":"categories/index.html","permalink":"https://zhangxin66666.github.io/categories/index.html","excerpt":"","text":""},{"title":"","date":"2024-08-22T03:23:14.709Z","updated":"2024-08-22T03:23:14.709Z","comments":true,"path":"css/custom.css","permalink":"https://zhangxin66666.github.io/css/custom.css","excerpt":"","text":"/* æ–‡ç« é¡µH1-H6å›¾æ ‡æ ·å¼æ•ˆæœ */ h1::before, h2::before, h3::before, h4::before, h5::before, h6::before { -webkit-animation: ccc 1.6s linear infinite ; animation: ccc 1.6s linear infinite ; } @-webkit-keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } @keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } #content-inner.layout h1::before { color: #ef50a8 ; margin-left: -1.55rem; font-size: 1.3rem; margin-top: -0.23rem; } #content-inner.layout h2::before { color: #fb7061 ; margin-left: -1.35rem; font-size: 1.1rem; margin-top: -0.12rem; } #content-inner.layout h3::before { color: #ffbf00 ; margin-left: -1.22rem; font-size: 0.95rem; margin-top: -0.09rem; } #content-inner.layout h4::before { color: #a9e000 ; margin-left: -1.05rem; font-size: 0.8rem; margin-top: -0.09rem; } #content-inner.layout h5::before { color: #57c850 ; margin-left: -0.9rem; font-size: 0.7rem; margin-top: 0.0rem; } #content-inner.layout h6::before { color: #5ec1e0 ; margin-left: -0.9rem; font-size: 0.66rem; margin-top: 0.0rem; } #content-inner.layout h1:hover, #content-inner.layout h2:hover, #content-inner.layout h3:hover, #content-inner.layout h4:hover, #content-inner.layout h5:hover, #content-inner.layout h6:hover { color: #49b1f5 ; } #content-inner.layout h1:hover::before, #content-inner.layout h2:hover::before, #content-inner.layout h3:hover::before, #content-inner.layout h4:hover::before, #content-inner.layout h5:hover::before, #content-inner.layout h6:hover::before { color: #49b1f5 ; -webkit-animation: ccc 3.2s linear infinite ; animation: ccc 3.2s linear infinite ; } /* é¡µé¢è®¾ç½®iconè½¬åŠ¨é€Ÿåº¦è°ƒæ•´ */ #rightside_config i.fas.fa-cog.fa-spin { animation: fa-spin 5s linear infinite ; } /*--------æ›´æ¢å­—ä½“------------*/ @font-face { font-family: 'tzy'; /* å­—ä½“åè‡ªå®šä¹‰å³å¯ */ src: url('https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/font/ZhuZiAWan.woff2'); /* å­—ä½“æ–‡ä»¶è·¯å¾„ */ font-display: swap; } /*body,*/ /*.gitcalendar {*/ /* font-family: tzy !important;*/ /*}*/ .categoryBar-list { max-height: 400px; } .clock-row { overflow: hidden; text-overflow: ellipsis; } /*3sä¸ºåŠ è½½åŠ¨ç”»çš„æ—¶é—´ï¼Œ1ä¸ºåŠ è½½åŠ¨ç”»çš„æ¬¡æ•°ï¼Œease-in-outä¸ºåŠ¨ç”»æ•ˆæœ*/ #page-header, #web_bg { -webkit-animation: imgblur 2s 1 ease-in-out; animation: imgblur 2s 1 ease-in-out; } @keyframes imgblur { 0% { filter: blur(5px); } 100% { filter: blur(0px); } } /*é€‚é…ä½¿ç”¨-webkitå†…æ ¸çš„æµè§ˆå™¨ */ @-webkit-keyframes imgblur { 0% { -webkit-filter: blur(5px); } 100% { -webkit-filter: blur(0px); } } .table-wrap img { margin: .6rem auto .1rem !important; } /* æ ‡ç­¾å¤–æŒ‚ ç½‘ç«™å¡ç‰‡ start */ .site-card-group img { margin: 0 auto .1rem !important; } .site-card-group .info a img { margin-right: 10px !important; } [data-theme='dark'] .site-card-group .site-card .info .title { color: #f0f0f0 !important; } [data-theme='dark'] .site-card-group .site-card .info .desc { color: rgba(255, 255, 255, .7) !important; } .site-card-group .info .desc { margin-top: 4px !important; } /* ä»£ç å—é¢œè‰² */ figure.highlight pre .addition { color: #00bf03 !important; }"},{"title":"ç•™è¨€æ¿","date":"2022-01-11T01:48:58.203Z","updated":"2022-01-11T01:48:58.203Z","comments":true,"path":"message/index.html","permalink":"https://zhangxin66666.github.io/message/index.html","excerpt":"","text":"æœ¬é¡µé¢è¿˜åœ¨å¼€å‘ä¸­â€¦â€¦"},{"title":"æ ‡ç­¾","date":"2022-01-11T01:48:58.203Z","updated":"2022-01-11T01:48:58.203Z","comments":true,"path":"tags/index.html","permalink":"https://zhangxin66666.github.io/tags/index.html","excerpt":"","text":""},{"title":"","date":"2024-08-22T03:23:14.738Z","updated":"2024-08-22T03:23:14.738Z","comments":true,"path":"js/chocolate.js","permalink":"https://zhangxin66666.github.io/js/chocolate.js","excerpt":"","text":"// å‹æƒ…é“¾æ¥é¡µé¢ å¤´åƒæ‰¾ä¸åˆ°æ—¶ æ›¿æ¢å›¾ç‰‡ if (location.href.indexOf(\"link\") !== -1) { var imgObj = document.getElementsByTagName(\"img\"); for (i = 0; i < imgObj.length; i++) { imgObj[i].onerror = function() { this.src = \"https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/friend_404.gif\" } } } $(function() { // æ°”æ³¡ function bubble() { $('#page-header').circleMagic({ radius: 10, density: .2, color: 'rgba(255,255,255,.4)', clearOffset: 0.99 }); }! function(p) { p.fn.circleMagic = function(t) { var o, a, n, r, e = !0, i = [], d = p.extend({ color: \"rgba(255,0,0,.5)\", radius: 10, density: .3, clearOffset: .2 }, t), l = this[0]; function c() { e = !(document.body.scrollTop > a) } function s() { o = l.clientWidth, a = l.clientHeight, l.height = a + \"px\", n.width = o, n.height = a } function h() { if (e) for (var t in r.clearRect(0, 0, o, a), i) i[t].draw(); requestAnimationFrame(h) } function f() { var t = this; function e() { t.pos.x = Math.random() * o, t.pos.y = a + 100 * Math.random(), t.alpha = .1 + Math.random() * d.clearOffset, t.scale = .1 + .3 * Math.random(), t.speed = Math.random(), \"random\" === d.color ? t.color = \"rgba(\" + Math.floor(255 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.random().toPrecision(2) + \")\" : t.color = d.color } t.pos = {}, e(), this.draw = function() { t.alpha"},{"title":"å…³äºæˆ‘","date":"2024-08-22T03:23:14.738Z","updated":"2024-08-22T03:23:14.738Z","comments":true,"path":"å…³äºæˆ‘/index.html","permalink":"https://zhangxin66666.github.io/%E5%85%B3%E4%BA%8E%E6%88%91/index.html","excerpt":"","text":"å…³äºæˆ‘åå¹´ç”Ÿæ­»ä¸¤èŒ«èŒ«,å†™ç¨‹åºï¼Œåˆ°å¤©äº®ã€‚åƒè¡Œä»£ç ï¼ŒBugä½•å¤„è—ã€‚çºµä½¿ä¸Šçº¿åˆæ€æ ·ï¼Œæœä»¤æ”¹ï¼Œå¤•æ–­è‚ ã€‚é¢†å¯¼æ¯å¤©æ–°æƒ³æ³•ï¼Œå¤©å¤©æ”¹ï¼Œæ—¥æ—¥å¿™ã€‚ ç›¸é¡¾æ— è¨€ï¼ŒæƒŸæœ‰æ³ªåƒè¡Œã€‚æ¯æ™šç¯ç«é˜‘çŠå¤„ï¼Œç¨‹åºå‘˜ï¼ŒåˆåŠ ç­ï¼Œå·¥ä½œç‹‚~ æ¥ä¸€å¼ æ¥¼ä¸»æ— ç¾é¢œç”Ÿæ´»ç…§ï¼Œè§ç¬‘äº†ï¼ğŸ¤£ğŸ¤£ğŸ¤£ åŸºæœ¬ä¿¡æ¯ ç±»åˆ« ä¿¡æ¯ å‡ºç”Ÿå¹´æœˆ 1990å¹´2æœˆ ç°å±…åœ° åŒ—äº¬å¸‚æœé˜³åŒº ç±è´¯ è¾½å®çœé”¦å·å¸‚ é‚®ç®± &#56;&#x33;&#52;&#x36;&#x31;&#51;&#x32;&#x40;&#x71;&#113;&#x2e;&#99;&#111;&#x6d; æ•™è‚²ç»å† æ—¶é—´ å­¦æ ¡ ä¸“ä¸š å¤‡æ³¨ 2009.09~2013.07 æ²ˆé˜³åŒ–å·¥å¤§å­¦ ç”µå­ç§‘å­¦ä¸æŠ€æœ¯ ç»Ÿæ‹›æœ¬ç§‘ 2006.09~2009.07 è¾½å®çœåŒ—é•‡å¸‚é«˜çº§ä¸­å­¦ é«˜çº§åŸºç¡€æ•™è‚² å¸‚é‡ç‚¹ å·¥ä½œç»å† æ—¶é—´ å…¬å¸ èŒä½ 2021.04~è‡³ä»Š é¾™æ¹–é›†å›¢ Java å¼€å‘å·¥ç¨‹å¸ˆ 2017.05~2021.04 åŒ…å¤´å¸‚åŒ…é“¶æ¶ˆè´¹é‡‘èè‚¡ä»½æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ 2016.09~2017.04 å¤§è¿çµåŠ¨ç§‘æŠ€å‘å±•æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ 2013.07~2016.08 å¤§è¿å®‰å‰å°¼å°”ç§‘æŠ€æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ ä¸“ä¸šæŠ€èƒ½ Java åŸºç¡€æ‰å®ã€æŒæ¡ JVM åŸç†ã€å¤šçº¿ç¨‹ã€ç½‘ç»œåŸç†ã€è®¾è®¡æ¨¡å¼ã€å¸¸ç”¨çš„æ•°æ®ç»“æ„å’Œç®—æ³• ç†Ÿæ‚‰ Windowsã€Macã€Linux æ“ä½œç³»ç»Ÿï¼Œç†Ÿç»ƒä½¿ç”¨ linux å¸¸ç”¨æ“ä½œæŒ‡ä»¤ ç†Ÿç»ƒä½¿ç”¨ IntelliJ IDEA å¼€å‘å·¥å…·(åŠå„ç§æ’ä»¶)ã€ç†Ÿç»ƒä½¿ç”¨ Git ç‰ˆæœ¬åŒæ­¥å·¥å…· é˜…è¯»è¿‡ Springã€SpringMVCã€ç­‰å¼€æºæ¡†æ¶æºç ï¼Œç†è§£å…¶è®¾è®¡åŸç†åŠåº•å±‚æ¶æ„ï¼Œå…·å¤‡æ¡†æ¶å®šåˆ¶å¼€å‘èƒ½åŠ› ç†è§£ Redis çº¿ç¨‹æ¨¡å‹ï¼ŒNetty çº¿ç¨‹æ¨¡å‹ï¼ŒæŒæ¡åŸºäºå“åº”å¼çš„å¼‚æ­¥éé˜»å¡æ¨¡å‹çš„åŸºæœ¬åŸç†ï¼Œäº†è§£ Webflux ç†Ÿç»ƒæŒæ¡åˆ†å¸ƒå¼ç¼“å­˜ Redisã€Elaticsearchï¼Œå¯¹åˆ†å¸ƒå¼é”ï¼Œå¹‚ç­‰ç­‰å¸¸è§é—®é¢˜æœ‰æ·±å…¥ç ”ç©¶åŠå¤šå¹´å®æˆ˜ç»éªŒ ç†Ÿæ‚‰å¸¸è§æ¶ˆæ¯ä¸­é—´ä»¶çš„ä½¿ç”¨ï¼Œæœ‰å¤šå¹´ RabbitMQ çš„å®æˆ˜å¼€å‘ç»éªŒï¼Œå¯¹é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—æœ‰æ·±å…¥ç†è§£ ç†Ÿç»ƒæŒæ¡ Mysql äº‹åŠ¡ï¼Œç´¢å¼•ï¼Œé”ï¼ŒSQL ä¼˜åŒ–ç›¸å…³çŸ¥è¯†ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯ç»™å‡ºè¯¦ç»†åŠé«˜æ€§èƒ½è®¾è®¡æ–¹æ¡ˆ ç†Ÿç»ƒä½¿ç”¨æ•°æ®åº“æ“ä½œæ¡†æ¶ Mybatisã€Mybatsi-plus è¿›è¡Œé«˜æ•ˆä¸šåŠ¡åŠŸèƒ½å¼€å‘ æŒæ¡ springCloud ç›¸å…³æ¡†æ¶ï¼Œå¯¹ SpringBootã€SpringCloud åŸç†æœ‰ä¸€å®šäº†è§£ï¼Œæœ‰æˆç†Ÿé¡¹ç›®ç»éªŒ ç†Ÿæ‚‰å®šæ—¶ä»»åŠ¡åŠå»¶è¿Ÿä»»åŠ¡ç­‰ä¸šåŠ¡ç›¸å…³è®¾è®¡ï¼Œå¦‚ xxl-jobï¼Œå»¶è¿Ÿæ¶ˆæ¯ç­‰ç›¸å…³æŠ€æœ¯æœ‰å¤šå¹´å¼€å‘ç»éªŒ ç†Ÿæ‚‰å¾®æœåŠ¡æ€æƒ³ï¼ŒMVC åˆ†å±‚ï¼ŒDDD ç†è®ºï¼ŒæœåŠ¡æ‹†åˆ†ï¼Œæ²»ç†ï¼Œç›‘æ§ï¼ŒæœåŠ¡ç†”æ–­ï¼Œé™çº§ç­‰ç›¸å…³èƒ½åŠ› ç†Ÿæ‚‰ jvm åŸç†ï¼Œç†Ÿæ‚‰åƒåœ¾å›æ”¶ä»¥ jvm æ€§èƒ½è°ƒä¼˜æŠ€æœ¯ï¼Œæœ‰è¿‡çº¿ä¸ŠæœåŠ¡å™¨æ€§èƒ½ç›‘æµ‹åŠè°ƒä¼˜ç»éªŒ ç†Ÿæ‚‰å¤šçº¿ç¨‹åŠçº¿ç¨‹æ± ä½¿ç”¨ï¼Œæœ‰å¤šå¹´å¤šçº¿ç¨‹ä¸šåŠ¡å¤„ç†ç»éªŒï¼Œå°è£…è¿‡å¤šçº¿ç¨‹æ‰¹å¤„ç†å·¥å…·ç±»ç­‰å…¬ç”¨ç»„å»º äº†è§£ Mysql åˆ†åº“åˆ†è¡¨ç›¸å…³åŸç†ï¼Œå¦‚ Sardingsphereã€Mycat ç­‰æ¡†æ¶æœ‰ç›¸å…³ä½¿ç”¨ç»éªŒ äº†è§£æ“ä½œç³»ç»Ÿåº•å±‚åŸç†ä»¥åŠ Cã€C++ç¨‹åºå¼€å‘ï¼Œå¯¹è®¡ç®—æœºåº•å±‚åŸç†æœ‰åˆæ­¥äº†è§£ äº†è§£å‰ç«¯å¼€å‘ï¼Œäº†è§£ htmlï¼Œcssï¼Œjsï¼Œvue ç­‰å‰ç«¯æŠ€æœ¯ï¼Œå¯¹å‰ç«¯å¼€å‘æœ‰ä¸€å®šçš„äº†è§£ ç ”ç©¶è¿‡å•ç‰‡æœºç­‰ç¡¬ä»¶å¼€å‘ï¼Œå–œæ¬¢ç§‘æŠ€äº§å“ï¼Œå–œæ¬¢è½¯ä»¶ï¼Œå–œæ¬¢æŠ˜è…¾å„ç§ç”µå­äº§å“ä»¥åŠè½¯ä»¶ é¡¹ç›®ç»éªŒâ€‹ é¡¹ç›®ç»éªŒåªå†™äº†åœ¨åŒ—äº¬ä¹‹åå‚ä¸è¿‡çš„ç›¸å…³é¡¹ç›®ï¼Œåœ¨å¤§è¿åšçš„é¡¹ç›®åå‘äºä¼ ç»Ÿï¼Œé¡¹ç›®ä¹Ÿéƒ½æ˜¯å•ç‚¹éƒ¨ç½²ï¼Œä¸»è¦ç”¨çš„æ¡†æ¶éƒ½æ˜¯springã€mybatisã€Hibernateã€springMVCç­‰ç›¸äº’ç»“åˆä½¿ç”¨ï¼Œå³ï¼šSSMï¼ŒSSHï¼Œç›¸æ¯”äºspringBootæ¥è¯´ä¸å€¼ä¸€æï¼Œç°åœ¨åº”è¯¥æ²¡æœ‰å‡ ä¸ªå…¬å¸è¿˜æ²¡ç”¨springBootäº†å§(#^.^#)ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåˆšæ¯•ä¸šé‚£ä¼šï¼Œåšäº†åŠå¹´çš„Cè¯­è¨€åµŒå…¥å¼å¼€å‘ï¼Œå¤–åŒ…åˆ°å¤§è¿ä¸œè½¯åšå¯¹æ—¥çš„ä½³èƒ½ç›¸æœºç³»ç»Ÿï¼Œè™½ç„¶ç›®å‰æˆ‘å·²ç»åšäº†å¤šå¹´çš„javaå¼€å‘ï¼Œä½†æ˜¯é‚£æ¯•ç«Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å‚åŠ å¼€å‘é¡¹ç›®ï¼Œäººéƒ½æ˜¯æœ‰åˆæ‹æƒ…èŠ‚çš„å˜›ï¼Œå¯¹è‡ªå·±çš„ç¬¬ä¸€æ¬¡å¿µå¿µä¸å¿˜(æˆ‘æŒ‡å¾—æ˜¯å·¥ä½œğŸ¤­)ï¼Œé‚£åŠå¹´è®©æˆ‘å¯¹ç¡¬ä»¶åº•å±‚æœ‰äº†ä¸€äº›ç†è§£ï¼Œä¹Ÿç®—æ˜¯æœ€å¤§çš„æ”¶è·äº†å§ã€‚ â€”â€” åŒ…é“¶æ¶ˆè´¹é‡‘è(ç°åï¼šè’™å•†æ¶ˆè´¹) â€”â€”â€‹ åŒ…å¤´å¸‚åŒ…é“¶æ¶ˆè´¹é‡‘èè‚¡ä»½æœ‰é™å…¬å¸æ˜¯ç»ä¸­å›½é“¶ç›‘ä¼šæ‰¹å‡†æˆç«‹çš„æŒç‰Œæ¶ˆè´¹é‡‘èå…¬å¸ï¼Œç”±åŒ…å•†é“¶è¡Œå‘èµ·è®¾ç«‹ï¼ŒåŒ…é“¶æ¶ˆè´¹é‡‘èä¸ºä¸ªäººæ¶ˆè´¹è€…æä¾›æ¶ˆè´¹ä¿¡è´·æœåŠ¡ã€‚å…¶ä¸»è¦åˆä½œæ¸ é“æœ‰ï¼šè¯å¤§è´¢å¯Œï¼Œäº¬ä¸œé‡‘æ¡ï¼Œå¾®ç²’è´·ï¼Œå»å“ªå„¿ï¼Œäº¬ä¸œå€Ÿè´·å¹³å°ï¼Œåˆ†æœŸä¹ï¼Œå°ç±³ç­‰å¤šå®¶æ”¾æ¬¾æ¸ é“ã€‚ç›®å‰ï¼Œå·²ç´¯è®¡å®Œæˆ 1200 å¤šä¸‡å®¢æˆ·æ³¨å†Œå’Œ 320 å¤šäº¿æ”¾æ¬¾è§„æ¨¡ã€‚ acsï¼šæ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿä¸»è¦åŒ…å«ä¿¡è´·æ ¸ç®—ä¸šåŠ¡å’Œè™šæ‹Ÿè´¦æˆ·ä¸šåŠ¡ï¼Œä¿¡è´·æ ¸ç®—ä¸»è¦è´Ÿè´£å€Ÿè¿˜æ¬¾ã€æ ¸é”€å‡å…äº¤æ˜“ã€åˆ©æ¯ã€ç½šæ¯è®¡æã€å„ç§è´¹ç”¨ç­‰ä¸šåŠ¡çš„è®¡ç®—å’Œè½åœ°ï¼Œæ—¥ç»ˆç”Ÿæˆäº¤æ˜“æµæ°´æ–‡ä»¶ä¾›ä¼šè®¡æ ¸ç®—ç³»ç»Ÿç”Ÿæˆä¼šè®¡åˆ†å½•ï¼›è™šæ‹Ÿè´¦æˆ·éƒ¨åˆ†ä¸»è¦ä¸ºæ¸…ç»“ç®—äººå‘˜æä¾›äº¤æ˜“äº§ç”Ÿçš„ä¸åŒèµ„é‡‘è´¦æˆ·é‡‘é¢çš„å˜åŒ–åŠèµ„é‡‘æµå‘ï¼Œä¸ºæ¸…ç»“ç®—äººå‘˜å¯¹è´¦æä¾›æ•°æ®æ”¯æŒï¼›ç³»ç»Ÿå¯ä»¥å¤„ç†æ¯åˆ†é’Ÿå³°å€¼ 640 å¤šç¬”æˆä¿¡ç”³è¯·ï¼Œæ¯å°æ—¶å³°å€¼ 2 ä¸‡ç¬”æˆä¿¡ç”³è¯·ï¼Œè´·åæ”¯æŒæ¯å°æ—¶ 17 ä¸‡å®¢æˆ·æ•°æ®ã€‚æ ¸å¿ƒæ—¥ç»ˆå¤„ç†é‡è¾¾ 152 ä¸‡ç¬”(å€Ÿæ®æ•°é‡)ã€‚ glsï¼šè´¢åŠ¡æ ¸ç®—ç³»ç»Ÿå¯¹æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿæ—¥ç»ˆç”Ÿæˆçš„äº¤æ˜“æµæ°´è§£æä¹‹åæŒ‰ç…§åˆ†å½•å€Ÿè´·è§„åˆ™ç”Ÿæˆè´¢åŠ¡åˆ†å½•æ–‡ä»¶äº¤ç»™é‡‘è¶ç³»ç»Ÿï¼Œ17 å¹´è´¢åŠ¡æ ¸ç®—ç³»ç»Ÿæ˜¯ä¹°æ¥çš„ç³»ç»Ÿï¼Œ19 å¹´ç”±æˆ‘é‡æ–°å¼€å‘å‡ºå±äºå…¬å¸è‡ªå·±çš„è´¢åŠ¡æ ¸ç®—ç³»ç»Ÿï¼Œå¹¶å¢åŠ äº†è´¢åŠ¡å¯¹è´¦åŠŸèƒ½(æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿå’Œè´¢åŠ¡åˆ†å½•å¯¹è´¦)ï¼Œä¸ä½†åŠæ—¶å‘ç°çº¿ä¸Šäº¤æ˜“çš„é”™è¯¯æ•°æ®ï¼ŒåŠæ—¶è§£å†³é—®é¢˜ï¼Œæ›´æå‡äº†æœˆç»ˆå¯¹è´¦ï¼Œå¹´ç»“çš„æ•ˆç‡ï¼Œå®ç°äº†è´¢åŠ¡å¯¹è´¦è‡ªåŠ¨åŒ–ï¼Œè§£å†³äº†å¹´ç»“äººå·¥å¯¹è´¦çš„ç—›ç‚¹ã€‚ ecifï¼šæ¸ é“ç³»ç»Ÿè¦è´Ÿè´£å¯¹æ¥ç¬¬ä¸‰æ–¹å¼•æµæ¸ é“ï¼Œå®¢æˆ·é€šè¿‡ç¬¬ä¸‰æ–¹æ¸ é“æˆä¿¡ã€å€Ÿæ¬¾ï¼Œæ¸ é“å¼•æµåˆ°åŒ…é“¶ï¼Œç”±äºä¸åŒæ¸ é“çš„æˆä¿¡ã€æ”¾æ¬¾ä¸šåŠ¡é€»è¾‘ä¸åŒï¼Œé’ˆå¯¹ä¸åŒæ¸ é“æä¾›ä¸åŒçš„åŠŸèƒ½å¼€å‘ã€‚å…¶ä¸­éƒ¨åˆ†æ¸ é“ç§¯ç´¯ä¸€å¤©å®¢æˆ·æˆä¿¡è¯·æ±‚æŒ‡å®šæ—¶é—´ç»Ÿä¸€å‘é€æˆä¿¡ç”³è¯·åˆ°åŒ…é“¶ï¼Œç³»ç»Ÿå¯å¤„ç†æ¯åˆ†é’Ÿ 800 ç¬”æˆä¿¡è¯·æ±‚ã€‚ cssï¼šæ¸…ç»“ç®—ç³»ç»Ÿæ­¤ç³»ç»Ÿæ˜¯å…¬å¸å†…éƒ¨æ¸…ç»“ç®—äººå‘˜ä½¿ç”¨çš„å†…éƒ¨ä¸šåŠ¡ç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½æœ‰ä¸ªäººæº¢ç¼´æ¬¾è´¦æˆ·ç®¡ç†ã€å¯¹å…¬ä»˜æ¬¾ã€å¯¹ç§ä»˜æ¬¾ã€é€€æ¬¾ä»¥åŠæ¸…ç»“ç®—åŒäº‹è½¬è´¦ä¸šåŠ¡çš„å‘èµ·å’Œå®¡æ ¸åŠŸèƒ½ è”åˆè´·æ¬¾ç³»ç»Ÿä¸»è¦åŠŸèƒ½æœ‰è”åˆè´·æ¬¾åè®®ï¼Œè·¯ç”±é…ç½®ï¼Œè·¯ç”±è§„åˆ™ï¼Œå€Ÿæ®è¿˜æ¬¾è®¡åˆ’æ‹†åˆ†ï¼Œèµ„æ–¹æˆä¿¡ï¼Œå€Ÿæ®ã€äº¤æ˜“æµæ°´æ–‡ä»¶ï¼Œè”åˆè´·æ¬¾æˆä¿¡å½±éŸ³èµ„æ–™æ¨é€ ç›‘ç®¡æŠ¥é€ç³»ç»ŸæŒ‰ç…§ç›‘ç®¡æŠ¥é€éœ€æ±‚ï¼Œå¯¹å€Ÿæ®(æ¯æœˆæŠ¥é€å…¨é‡æ•°æ®)ï¼Œè¿˜æ¬¾è®¡åˆ’ï¼Œè¿˜æ¬¾æµæ°´ï¼Œå®¢æˆ·ï¼Œäº§å“ï¼Œæ ¸é”€ï¼Œå€Ÿæ¬¾ç”³è¯·ï¼Œèµ„äº§è¯åˆ¸åŒ–ï¼Œäº”çº§åˆ†ç±»ç­‰ä¿¡æ¯è¿›è¡ŒåŠ å·¥ä¹‹åæ¨é€ç»™ç›‘ç®¡æŠ¥é€ç³»ç»Ÿ è‡ªæˆ‘è¯„ä»·ä¸šç²¾äºå‹¤ï¼Œè’äºå¬‰ ã€è¡Œæˆäºæ€ï¼Œæ¯äºéšã€‚ æ€§æ ¼ä¹è§‚å¼€æœ—ï¼Œè¯ç—¨ï¼Œçƒ­çˆ±ç”Ÿæ´»ï¼Œå–œæ¬¢æ‹è§†é¢‘è®°å½•ç”Ÿæ´»ï¼Œå–œæ¬¢åˆ†äº«çŸ¥è¯†ï¼Œåˆ†äº«æŠ€æœ¯ï¼Œåˆ†äº«ç”Ÿæ´»ä¸­çš„ç‚¹ç‚¹æ»´æ»´ï¼Œè„¾æ°”å¥½ï¼Œæ€•è€å©† ä¸ªäººçˆ±å¥½ ç”µå­ç§‘æŠ€äº§å“ è½¯ä»¶ â€”â€” å–œæ¬¢winã€Macã€Android å¥½ç”¨æ— å¹¿å‘Šè½¯ä»¶ç ”ç©¶åŠåˆ†äº« è¶³çƒ â€”â€” å–œæ¬¢ä½†æ˜¯æ²¡æœºä¼šç©ï¼Œæ€€å¿µé«˜ä¸­æ—¶ä»£å‘€â€¦. ä¸‰å›½æ€ â€”â€” åŸºæœ¬å·²ç»è¢«å‡‰ä¼é€¼åˆ°é€€æ¸¸äº†â€¦.è€Œä¸”ç”Ÿæ´»ä¸­ä¹Ÿå¾ˆéš¾æ‰¾åˆ°ä¸€èµ·ç©è¿™ä¸ªæ¸¸æˆçš„æœ‹å‹äº†ğŸ¤£ é€›Bç«™ â€”â€” ç”Ÿæ´»åŒºå’Œç§‘æŠ€åŒºä¸€ä¸ªä¸çŸ¥åé˜¿å©†ä¸»ğŸ˜‚ï¼Œä½›ç³»æ›´æ–°è§†é¢‘ ğŸ‘‰ ç‚¹å‡»æ‰“å¼€æˆ‘çš„Bç«™ä¸ªäººç©ºé—´ è®°å¾—ä¸‰è¿ ğŸ‘ğŸ‘ğŸ‘ çœ‹ç”µå½± â€”â€” å–œæ¬¢ç§‘å¹»ã€æ¼«å¨ç²‰ã€è¿½æ–—ç½—å¤§é™†â€¦.."},{"title":"æŠ€æœ¯ç¬”è®°","date":"2022-01-11T01:48:58.204Z","updated":"2022-01-11T01:48:58.204Z","comments":true,"path":"æŠ€æœ¯ç¬”è®°/index.html","permalink":"https://zhangxin66666.github.io/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/index.html","excerpt":"","text":"æˆ‘æ˜¯æŠ€æœ¯ç¬”è®°"}],"posts":[{"title":"Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(2)â€”â€”sds","slug":"5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(2)â€”â€”sds","date":"2024-12-29T16:00:00.000Z","updated":"2024-12-30T06:11:41.977Z","comments":true,"path":"2024/12/30/5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(2)â€”â€”sds/","link":"","permalink":"https://zhangxin66666.github.io/2024/12/30/5.%E7%BC%93%E5%AD%98/Redis%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3(2)%E2%80%94%E2%80%94sds/","excerpt":"","text":"ä¸ç®¡åœ¨å“ªé—¨ç¼–ç¨‹è¯­è¨€å½“ä¸­ï¼Œå­—ç¬¦ä¸²éƒ½å‡ ä¹æ˜¯ä½¿ç”¨æœ€å¤šçš„æ•°æ®ç»“æ„ã€‚sdsæ­£æ˜¯åœ¨Redisä¸­è¢«å¹¿æ³›ä½¿ç”¨çš„å­—ç¬¦ä¸²ç»“æ„ï¼Œå®ƒçš„å…¨ç§°æ˜¯Simple Dynamic Stringã€‚ä¸å…¶å®ƒè¯­è¨€ç¯å¢ƒä¸­å‡ºç°çš„å­—ç¬¦ä¸²ç›¸æ¯”ï¼Œå®ƒå…·æœ‰å¦‚ä¸‹æ˜¾è‘—çš„ç‰¹ç‚¹ï¼š å¯åŠ¨æ€æ‰©å±•å†…å­˜ã€‚sdsè¡¨ç¤ºçš„å­—ç¬¦ä¸²å…¶å†…å®¹å¯ä»¥ä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥è¿½åŠ ã€‚åœ¨å¾ˆå¤šè¯­è¨€ä¸­å­—ç¬¦ä¸²ä¼šåˆ†ä¸ºmutableå’Œimmutableä¸¤ç§ï¼Œæ˜¾ç„¶sdså±äºmutableç±»å‹çš„ã€‚äºŒè¿›åˆ¶å®‰å…¨ï¼ˆBinary Safeï¼‰ã€‚sdsèƒ½å­˜å‚¨ä»»æ„äºŒè¿›åˆ¶æ•°æ®ï¼Œè€Œä¸ä»…ä»…æ˜¯å¯æ‰“å°å­—ç¬¦ã€‚ä¸ä¼ ç»Ÿçš„Cè¯­è¨€å­—ç¬¦ä¸²ç±»å‹å…¼å®¹ã€‚è¿™ä¸ªçš„å«ä¹‰æ¥ä¸‹æ¥é©¬ä¸Šä¼šè®¨è®ºã€‚çœ‹åˆ°è¿™é‡Œï¼Œå¾ˆå¤šå¯¹Redisæœ‰æ‰€äº†è§£çš„åŒå­¦å¯èƒ½å·²ç»äº§ç”Ÿäº†ä¸€ä¸ªç–‘é—®ï¼šRediså·²ç»å¯¹å¤–æš´éœ²äº†ä¸€ä¸ªå­—ç¬¦ä¸²ç»“æ„ï¼Œå«åšstringï¼Œé‚£è¿™é‡Œæ‰€è¯´çš„sdsåˆ°åº•å’Œstringæ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿå¯èƒ½æœ‰äººä¼šçŒœï¼šstringæ˜¯åŸºäºsdså®ç°çš„ã€‚è¿™ä¸ªçŒœæƒ³å·²ç»éå¸¸æ¥è¿‘äº‹å®ï¼Œä½†åœ¨æè¿°ä¸Šè¿˜ä¸å¤ªå‡†ç¡®ã€‚æœ‰å…³stringå’Œsdsä¹‹é—´å…³ç³»çš„è¯¦ç»†åˆ†æï¼Œæˆ‘ä»¬æ”¾åœ¨åé¢å†è®²ã€‚ç°åœ¨ä¸ºäº†æ–¹ä¾¿è®¨è®ºï¼Œè®©æˆ‘ä»¬å…ˆæš‚æ—¶ç®€å•åœ°è®¤ä¸ºï¼Œstringçš„åº•å±‚å®ç°å°±æ˜¯sdsã€‚ åœ¨è®¨è®ºsdsçš„å…·ä½“å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç«™åœ¨Redisä½¿ç”¨è€…çš„è§’åº¦ï¼Œæ¥è§‚å¯Ÿä¸€ä¸‹stringæ‰€æ”¯æŒçš„ä¸€äº›ä¸»è¦æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ“ä½œç¤ºä¾‹ï¼š ä»¥ä¸Šè¿™äº›æ“ä½œéƒ½æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç®€å•è§£é‡Šä¸€ä¸‹ï¼š åˆå§‹çš„å­—ç¬¦ä¸²çš„å€¼è®¾ä¸ºâ€tieleiâ€ã€‚ç¬¬3æ­¥é€šè¿‡appendå‘½ä»¤å¯¹å­—ç¬¦ä¸²è¿›è¡Œäº†è¿½åŠ ï¼Œå˜æˆäº†â€tielei zhangâ€ã€‚ç„¶åé€šè¿‡setbitå‘½ä»¤å°†ç¬¬53ä¸ªbitè®¾ç½®æˆäº†1ã€‚bitçš„åç§»é‡ä»å·¦è¾¹å¼€å§‹ç®—ï¼Œä»0å¼€å§‹ã€‚å…¶ä¸­ç¬¬48ï½55bitæ˜¯ä¸­é—´çš„ç©ºæ ¼é‚£ä¸ªå­—ç¬¦ï¼Œå®ƒçš„ASCIIç æ˜¯0x20ã€‚å°†ç¬¬53ä¸ªbitè®¾ç½®æˆ1ä¹‹åï¼Œå®ƒçš„ASCIIç å˜æˆäº†0x24ï¼Œæ‰“å°å‡ºæ¥å°±æ˜¯â€™$â€™ã€‚å› æ­¤ï¼Œç°åœ¨å­—ç¬¦ä¸²çš„å€¼å˜æˆäº†â€tielei$zhangâ€ã€‚æœ€åé€šè¿‡getrangeå–ä»å€’æ•°ç¬¬5ä¸ªå­—èŠ‚åˆ°å€’æ•°ç¬¬1ä¸ªå­—èŠ‚çš„å†…å®¹ï¼Œå¾—åˆ°â€zhangâ€ã€‚è¿™äº›å‘½ä»¤çš„å®ç°ï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯å’Œsdsçš„å®ç°æœ‰å…³çš„ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹è¯¦ç»†è®¨è®ºã€‚ sdsçš„æ•°æ®ç»“æ„å®šä¹‰æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Cè¯­è¨€ä¸­ï¼Œå­—ç¬¦ä¸²æ˜¯ä»¥â€™\\0â€™å­—ç¬¦ç»“å°¾ï¼ˆNULLç»“æŸç¬¦ï¼‰çš„å­—ç¬¦æ•°ç»„æ¥å­˜å‚¨çš„ï¼Œé€šå¸¸è¡¨è¾¾ä¸ºå­—ç¬¦æŒ‡é’ˆçš„å½¢å¼ï¼ˆchar *ï¼‰ã€‚å®ƒä¸å…è®¸å­—èŠ‚0å‡ºç°åœ¨å­—ç¬¦ä¸²ä¸­é—´ï¼Œå› æ­¤ï¼Œå®ƒä¸èƒ½ç”¨æ¥å­˜å‚¨ä»»æ„çš„äºŒè¿›åˆ¶æ•°æ®ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨sds.hä¸­æ‰¾åˆ°sdsçš„ç±»å‹å®šä¹‰ï¼š typedef char *sds;è‚¯å®šæœ‰äººæ„Ÿåˆ°å›°æƒ‘äº†ï¼Œç«Ÿç„¶sdså°±ç­‰åŒäºchar *ï¼Ÿæˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œsdså’Œä¼ ç»Ÿçš„Cè¯­è¨€å­—ç¬¦ä¸²ä¿æŒç±»å‹å…¼å®¹ï¼Œå› æ­¤å®ƒä»¬çš„ç±»å‹å®šä¹‰æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯char *ã€‚åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªCè¯­è¨€å­—ç¬¦ä¸²çš„åœ°æ–¹ï¼Œä¹Ÿç¡®å®å¯ä»¥ä¼ å…¥ä¸€ä¸ªsdsã€‚ä½†æ˜¯ï¼Œsdså’Œchar *å¹¶ä¸ç­‰åŒã€‚sdsæ˜¯Binary Safeçš„ï¼Œå®ƒå¯ä»¥å­˜å‚¨ä»»æ„äºŒè¿›åˆ¶æ•°æ®ï¼Œä¸èƒ½åƒCè¯­è¨€å­—ç¬¦ä¸²é‚£æ ·ä»¥å­—ç¬¦â€™\\0â€™æ¥æ ‡è¯†å­—ç¬¦ä¸²çš„ç»“æŸï¼Œå› æ­¤å®ƒå¿…ç„¶æœ‰ä¸ªé•¿åº¦å­—æ®µã€‚ä½†è¿™ä¸ªé•¿åº¦å­—æ®µåœ¨å“ªé‡Œå‘¢ï¼Ÿå®é™…ä¸Šsdsè¿˜åŒ…å«ä¸€ä¸ªheaderç»“æ„ï¼š 12345678910111213141516171819202122232425262728struct __attribute__ ((__packed__)) sdshdr5 &#123;unsigned char flags; /* 3 lsb of type, and 5 msb of string length */char buf[];&#125;;struct __attribute__ ((__packed__)) sdshdr8 &#123;uint8_t len; /* used */uint8_t alloc; /* excluding the header and null terminator */unsigned char flags; /* 3 lsb of type, 5 unused bits */char buf[];&#125;;struct __attribute__ ((__packed__)) sdshdr16 &#123;uint16_t len; /* used */uint16_t alloc; /* excluding the header and null terminator */unsigned char flags; /* 3 lsb of type, 5 unused bits */char buf[];&#125;;struct __attribute__ ((__packed__)) sdshdr32 &#123;uint32_t len; /* used */uint32_t alloc; /* excluding the header and null terminator */unsigned char flags; /* 3 lsb of type, 5 unused bits */char buf[];&#125;;struct __attribute__ ((__packed__)) sdshdr64 &#123;uint64_t len; /* used */uint64_t alloc; /* excluding the header and null terminator */unsigned char flags; /* 3 lsb of type, 5 unused bits */char buf[];&#125;; sdsä¸€å…±æœ‰5ç§ç±»å‹çš„headerã€‚ä¹‹æ‰€ä»¥æœ‰5ç§ï¼Œæ˜¯ä¸ºäº†èƒ½è®©ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨ä¸åŒå¤§å°çš„headerã€‚è¿™æ ·ï¼ŒçŸ­å­—ç¬¦ä¸²å°±èƒ½ä½¿ç”¨è¾ƒå°çš„headerï¼Œä»è€ŒèŠ‚çœå†…å­˜ã€‚ ä¸€ä¸ªsdså­—ç¬¦ä¸²çš„å®Œæ•´ç»“æ„ï¼Œç”±åœ¨å†…å­˜åœ°å€ä¸Šå‰åç›¸é‚»çš„ä¸¤éƒ¨åˆ†ç»„æˆï¼š ä¸€ä¸ªheaderã€‚é€šå¸¸åŒ…å«å­—ç¬¦ä¸²çš„é•¿åº¦(len)ã€æœ€å¤§å®¹é‡(alloc)å’Œflagsã€‚sdshdr5æœ‰æ‰€ä¸åŒã€‚ä¸€ä¸ªå­—ç¬¦æ•°ç»„ã€‚è¿™ä¸ªå­—ç¬¦æ•°ç»„çš„é•¿åº¦ç­‰äºæœ€å¤§å®¹é‡+1ã€‚çœŸæ­£æœ‰æ•ˆçš„å­—ç¬¦ä¸²æ•°æ®ï¼Œå…¶é•¿åº¦é€šå¸¸å°äºæœ€å¤§å®¹é‡ã€‚åœ¨çœŸæ­£çš„å­—ç¬¦ä¸²æ•°æ®ä¹‹åï¼Œæ˜¯ç©ºä½™æœªç”¨çš„å­—èŠ‚ï¼ˆä¸€èˆ¬ä»¥å­—èŠ‚0å¡«å……ï¼‰ï¼Œå…è®¸åœ¨ä¸é‡æ–°åˆ†é…å†…å­˜çš„å‰æä¸‹è®©å­—ç¬¦ä¸²æ•°æ®å‘ååšæœ‰é™çš„æ‰©å±•ã€‚åœ¨çœŸæ­£çš„å­—ç¬¦ä¸²æ•°æ®ä¹‹åï¼Œè¿˜æœ‰ä¸€ä¸ªNULLç»“æŸç¬¦ï¼Œå³ASCIIç ä¸º0çš„â€™\\0â€™å­—ç¬¦ã€‚è¿™æ˜¯ä¸ºäº†å’Œä¼ ç»ŸCå­—ç¬¦ä¸²å…¼å®¹ã€‚ä¹‹æ‰€ä»¥å­—ç¬¦æ•°ç»„çš„é•¿åº¦æ¯”æœ€å¤§å®¹é‡å¤š1ä¸ªå­—èŠ‚ï¼Œå°±æ˜¯ä¸ºäº†åœ¨å­—ç¬¦ä¸²é•¿åº¦è¾¾åˆ°æœ€å¤§å®¹é‡æ—¶ä»ç„¶æœ‰1ä¸ªå­—èŠ‚å­˜æ”¾NULLç»“æŸç¬¦ã€‚é™¤äº†sdshdr5ä¹‹å¤–ï¼Œå…¶å®ƒ4ä¸ªheaderçš„ç»“æ„éƒ½åŒ…å«3ä¸ªå­—æ®µï¼š len: è¡¨ç¤ºå­—ç¬¦ä¸²çš„çœŸæ­£é•¿åº¦ï¼ˆä¸åŒ…å«NULLç»“æŸç¬¦åœ¨å†…ï¼‰ã€‚alloc: è¡¨ç¤ºå­—ç¬¦ä¸²çš„æœ€å¤§å®¹é‡ï¼ˆä¸åŒ…å«æœ€åå¤šä½™çš„é‚£ä¸ªå­—èŠ‚ï¼‰ã€‚flags: æ€»æ˜¯å ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚å…¶ä¸­çš„æœ€ä½3ä¸ªbitç”¨æ¥è¡¨ç¤ºheaderçš„ç±»å‹ã€‚headerçš„ç±»å‹å…±æœ‰5ç§ï¼Œåœ¨sds.hä¸­æœ‰å¸¸é‡å®šä¹‰ã€‚#define SDS_TYPE_5 0#define SDS_TYPE_8 1#define SDS_TYPE_16 2#define SDS_TYPE_32 3#define SDS_TYPE_64 4sdsçš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬æœ‰å¿…è¦éå¸¸ä»”ç»†åœ°å»è§£æå®ƒã€‚ ä¸Šå›¾æ˜¯sdsçš„ä¸€ä¸ªå†…éƒ¨ç»“æ„çš„ä¾‹å­ã€‚å›¾ä¸­å±•ç¤ºäº†ä¸¤ä¸ªsdså­—ç¬¦ä¸²s1å’Œs2çš„å†…å­˜ç»“æ„ï¼Œä¸€ä¸ªä½¿ç”¨sdshdr8ç±»å‹çš„headerï¼Œå¦ä¸€ä¸ªä½¿ç”¨sdshdr16ç±»å‹çš„headerã€‚ä½†å®ƒä»¬éƒ½è¡¨è¾¾äº†åŒæ ·çš„ä¸€ä¸ªé•¿åº¦ä¸º6çš„å­—ç¬¦ä¸²çš„å€¼ï¼šâ€tieleiâ€ã€‚ä¸‹é¢æˆ‘ä»¬ç»“åˆä»£ç ï¼Œæ¥è§£é‡Šæ¯ä¸€éƒ¨åˆ†çš„ç»„æˆã€‚ sdsçš„å­—ç¬¦æŒ‡é’ˆï¼ˆs1å’Œs2ï¼‰å°±æ˜¯æŒ‡å‘çœŸæ­£çš„æ•°æ®ï¼ˆå­—ç¬¦æ•°ç»„ï¼‰å¼€å§‹çš„ä½ç½®ï¼Œè€Œheaderä½äºå†…å­˜åœ°å€è¾ƒä½çš„æ–¹å‘ã€‚åœ¨sds.hä¸­æœ‰ä¸€äº›è·Ÿè§£æheaderæœ‰å…³çš„å®å®šä¹‰ï¼š 12345#define SDS_TYPE_MASK 7#define SDS_TYPE_BITS 3#define SDS_HDR_VAR(T,s) struct sdshdr##T *sh = (void*)((s)-(sizeof(struct sdshdr##T)));#define SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))#define SDS_TYPE_5_LEN(f) ((f)&gt;&gt;SDS_TYPE_BITS) å…¶ä¸­SDS_HDRç”¨æ¥ä»sdså­—ç¬¦ä¸²è·å¾—headerèµ·å§‹ä½ç½®çš„æŒ‡é’ˆï¼Œæ¯”å¦‚SDS_HDR(8, s1)è¡¨ç¤ºs1çš„headeræŒ‡é’ˆï¼ŒSDS_HDR(16, s2)è¡¨ç¤ºs2çš„headeræŒ‡é’ˆã€‚ å½“ç„¶ï¼Œä½¿ç”¨SDS_HDRä¹‹å‰æˆ‘ä»¬å¿…é¡»å…ˆçŸ¥é“åˆ°åº•æ˜¯å“ªä¸€ç§headerï¼Œè¿™æ ·æˆ‘ä»¬æ‰çŸ¥é“SDS_HDRç¬¬1ä¸ªå‚æ•°åº”è¯¥ä¼ ä»€ä¹ˆã€‚ç”±sdså­—ç¬¦æŒ‡é’ˆè·å¾—headerç±»å‹çš„æ–¹æ³•æ˜¯ï¼Œå…ˆå‘ä½åœ°å€æ–¹å‘åç§»1ä¸ªå­—èŠ‚çš„ä½ç½®ï¼Œå¾—åˆ°flagså­—æ®µã€‚æ¯”å¦‚ï¼Œs1[-1]å’Œs2[-1]åˆ†åˆ«è·å¾—äº†s1å’Œs2çš„flagsçš„å€¼ã€‚ç„¶åå–flagsçš„æœ€ä½3ä¸ªbitå¾—åˆ°headerçš„ç±»å‹ã€‚ ç”±äºs1[-1] == 0x01 == SDS_TYPE_8ï¼Œå› æ­¤s1çš„headerç±»å‹æ˜¯sdshdr8ã€‚ç”±äºs2[-1] == 0x02 == SDS_TYPE_16ï¼Œå› æ­¤s2çš„headerç±»å‹æ˜¯sdshdr16ã€‚æœ‰äº†headeræŒ‡é’ˆï¼Œå°±èƒ½å¾ˆå¿«å®šä½åˆ°å®ƒçš„lenå’Œallocå­—æ®µï¼š s1çš„headerä¸­ï¼Œlençš„å€¼ä¸º0x06ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²æ•°æ®é•¿åº¦ä¸º6ï¼›allocçš„å€¼ä¸º0x80ï¼Œè¡¨ç¤ºå­—ç¬¦æ•°ç»„æœ€å¤§å®¹é‡ä¸º128ã€‚s2çš„headerä¸­ï¼Œlençš„å€¼ä¸º0x0006ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²æ•°æ®é•¿åº¦ä¸º6ï¼›allocçš„å€¼ä¸º0x03E8ï¼Œè¡¨ç¤ºå­—ç¬¦æ•°ç»„æœ€å¤§å®¹é‡ä¸º1000ã€‚ï¼ˆæ³¨æ„ï¼šå›¾ä¸­æ˜¯æŒ‰å°ç«¯åœ°å€æ„æˆï¼‰åœ¨å„ä¸ªheaderçš„ç±»å‹å®šä¹‰ä¸­ï¼Œè¿˜æœ‰å‡ ä¸ªéœ€è¦æˆ‘ä»¬æ³¨æ„çš„åœ°æ–¹ï¼š åœ¨å„ä¸ªheaderçš„å®šä¹‰ä¸­ä½¿ç”¨äº†__attribute__ ((packed))ï¼Œæ˜¯ä¸ºäº†è®©ç¼–è¯‘å™¨ä»¥ç´§å‡‘æ¨¡å¼æ¥åˆ†é…å†…å­˜ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªå±æ€§ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šä¸ºstructçš„å­—æ®µåšä¼˜åŒ–å¯¹é½ï¼Œåœ¨å…¶ä¸­å¡«å……ç©ºå­—èŠ‚ã€‚é‚£æ ·çš„è¯ï¼Œå°±ä¸èƒ½ä¿è¯headerå’Œsdsçš„æ•°æ®éƒ¨åˆ†ç´§ç´§å‰åç›¸é‚»ï¼Œä¹Ÿä¸èƒ½æŒ‰ç…§å›ºå®šå‘ä½åœ°å€æ–¹å‘åç§»1ä¸ªå­—èŠ‚çš„æ–¹å¼æ¥è·å–flagså­—æ®µäº†ã€‚åœ¨å„ä¸ªheaderçš„å®šä¹‰ä¸­æœ€åæœ‰ä¸€ä¸ªchar buf[]ã€‚æˆ‘ä»¬æ³¨æ„åˆ°è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰æŒ‡æ˜é•¿åº¦çš„å­—ç¬¦æ•°ç»„ï¼Œè¿™æ˜¯Cè¯­è¨€ä¸­å®šä¹‰å­—ç¬¦æ•°ç»„çš„ä¸€ç§ç‰¹æ®Šå†™æ³•ï¼Œç§°ä¸ºæŸ”æ€§æ•°ç»„ï¼ˆflexible array memberï¼‰ï¼Œåªèƒ½å®šä¹‰åœ¨ä¸€ä¸ªç»“æ„ä½“çš„æœ€åä¸€ä¸ªå­—æ®µä¸Šã€‚å®ƒåœ¨è¿™é‡Œåªæ˜¯èµ·åˆ°ä¸€ä¸ªæ ‡è®°çš„ä½œç”¨ï¼Œè¡¨ç¤ºåœ¨flagså­—æ®µåé¢å°±æ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œæˆ–è€…è¯´ï¼Œå®ƒæŒ‡æ˜äº†ç´§è·Ÿåœ¨flagså­—æ®µåé¢çš„è¿™ä¸ªå­—ç¬¦æ•°ç»„åœ¨ç»“æ„ä½“ä¸­çš„åç§»ä½ç½®ã€‚è€Œç¨‹åºåœ¨ä¸ºheaderåˆ†é…çš„å†…å­˜çš„æ—¶å€™ï¼Œå®ƒå¹¶ä¸å ç”¨å†…å­˜ç©ºé—´ã€‚å¦‚æœè®¡ç®—sizeof(struct sdshdr16)çš„å€¼ï¼Œé‚£ä¹ˆç»“æœæ˜¯5ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­æ²¡æœ‰bufå­—æ®µã€‚sdshdr5ä¸å…¶å®ƒå‡ ä¸ªheaderç»“æ„ä¸åŒï¼Œå®ƒä¸åŒ…å«allocå­—æ®µï¼Œè€Œé•¿åº¦ä½¿ç”¨flagsçš„é«˜5ä½æ¥å­˜å‚¨ã€‚å› æ­¤ï¼Œå®ƒä¸èƒ½ä¸ºå­—ç¬¦ä¸²åˆ†é…ç©ºä½™ç©ºé—´ã€‚å¦‚æœå­—ç¬¦ä¸²éœ€è¦åŠ¨æ€å¢é•¿ï¼Œé‚£ä¹ˆå®ƒå°±å¿…ç„¶è¦é‡æ–°åˆ†é…å†…å­˜æ‰è¡Œã€‚æ‰€ä»¥è¯´ï¼Œè¿™ç§ç±»å‹çš„sdså­—ç¬¦ä¸²æ›´é€‚åˆå­˜å‚¨é™æ€çš„çŸ­å­—ç¬¦ä¸²ï¼ˆé•¿åº¦å°äº32ï¼‰ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬éå¸¸æ¸…æ¥šåœ°çœ‹åˆ°äº†ï¼šsdså­—ç¬¦ä¸²çš„headerï¼Œå…¶å®éšè—åœ¨çœŸæ­£çš„å­—ç¬¦ä¸²æ•°æ®çš„å‰é¢ï¼ˆä½åœ°å€æ–¹å‘ï¼‰ã€‚è¿™æ ·çš„ä¸€ä¸ªå®šä¹‰ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªå¥½å¤„ï¼š headerå’Œæ•°æ®ç›¸é‚»ï¼Œè€Œä¸ç”¨åˆ†æˆä¸¤å—å†…å­˜ç©ºé—´æ¥å•ç‹¬åˆ†é…ã€‚è¿™æœ‰åˆ©äºå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜å­˜å‚¨æ•ˆç‡ï¼ˆmemory efficiencyï¼‰ã€‚è™½ç„¶headeræœ‰å¤šä¸ªç±»å‹ï¼Œä½†sdså¯ä»¥ç”¨ç»Ÿä¸€çš„char *æ¥è¡¨è¾¾ã€‚ä¸”å®ƒä¸ä¼ ç»Ÿçš„Cè¯­è¨€å­—ç¬¦ä¸²ä¿æŒç±»å‹å…¼å®¹ã€‚å¦‚æœä¸€ä¸ªsdsé‡Œé¢å­˜å‚¨çš„æ˜¯å¯æ‰“å°å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠå®ƒä¼ ç»™Cå‡½æ•°ï¼Œæ¯”å¦‚ä½¿ç”¨strcmpæ¯”è¾ƒå­—ç¬¦ä¸²å¤§å°ï¼Œæˆ–è€…ä½¿ç”¨printfè¿›è¡Œæ‰“å°ã€‚å¼„æ¸…äº†sdsçš„æ•°æ®ç»“æ„ï¼Œå®ƒçš„å…·ä½“æ“ä½œå‡½æ•°å°±æ¯”è¾ƒå¥½ç†è§£äº†ã€‚ sdsçš„ä¸€äº›åŸºç¡€å‡½æ•°sdslen(const sds s): è·å–sdså­—ç¬¦ä¸²é•¿åº¦ã€‚sdssetlen(sds s, size_t newlen): è®¾ç½®sdså­—ç¬¦ä¸²é•¿åº¦ã€‚sdsinclen(sds s, size_t inc): å¢åŠ sdså­—ç¬¦ä¸²é•¿åº¦ã€‚sdsalloc(const sds s): è·å–sdså­—ç¬¦ä¸²å®¹é‡ã€‚sdssetalloc(sds s, size_t newlen): è®¾ç½®sdså­—ç¬¦ä¸²å®¹é‡ã€‚sdsavail(const sds s): è·å–sdså­—ç¬¦ä¸²ç©ºä½™ç©ºé—´ï¼ˆå³alloc - lenï¼‰ã€‚sdsHdrSize(char type): æ ¹æ®headerç±»å‹å¾—åˆ°headerå¤§å°ã€‚sdsReqType(size_t string_size): æ ¹æ®å­—ç¬¦ä¸²æ•°æ®é•¿åº¦è®¡ç®—æ‰€éœ€è¦çš„headerç±»å‹ã€‚è¿™é‡Œæˆ‘ä»¬æŒ‘é€‰sdslenå’ŒsdsReqTypeçš„ä»£ç ï¼Œå¯Ÿçœ‹ä¸€ä¸‹ã€‚ 12345678910111213141516171819202122232425262728static inline size_t sdslen(const sds s) &#123;unsigned char flags = s[-1];switch(flags&amp;SDS_TYPE_MASK) &#123;case SDS_TYPE_5:return SDS_TYPE_5_LEN(flags);case SDS_TYPE_8:return SDS_HDR(8,s)-&gt;len;case SDS_TYPE_16:return SDS_HDR(16,s)-&gt;len;case SDS_TYPE_32:return SDS_HDR(32,s)-&gt;len;case SDS_TYPE_64:return SDS_HDR(64,s)-&gt;len;&#125;return 0;&#125;static inline char sdsReqType(size_t string_size) &#123;if (string_size &lt; 1&lt;&lt;5)return SDS_TYPE_5;if (string_size &lt; 1&lt;&lt;8)return SDS_TYPE_8;if (string_size &lt; 1&lt;&lt;16)return SDS_TYPE_16;if (string_size &lt; 1ll&lt;&lt;32)return SDS_TYPE_32;return SDS_TYPE_64;&#125; è·Ÿå‰é¢çš„åˆ†æç±»ä¼¼ï¼Œsdslenå…ˆç”¨s[-1]å‘ä½åœ°å€æ–¹å‘åç§»1ä¸ªå­—èŠ‚ï¼Œå¾—åˆ°flagsï¼›ç„¶åä¸SDS_TYPE_MASKè¿›è¡ŒæŒ‰ä½ä¸ï¼Œå¾—åˆ°headerç±»å‹ï¼›ç„¶åæ ¹æ®ä¸åŒçš„headerç±»å‹ï¼Œè°ƒç”¨SDS_HDRå¾—åˆ°headerèµ·å§‹æŒ‡é’ˆï¼Œè¿›è€Œè·å¾—lenå­—æ®µã€‚ é€šè¿‡sdsReqTypeçš„ä»£ç ï¼Œå¾ˆå®¹æ˜“çœ‹åˆ°ï¼š é•¿åº¦åœ¨0å’Œ2^5-1ä¹‹é—´ï¼Œé€‰ç”¨SDS_TYPE_5ç±»å‹çš„headerã€‚é•¿åº¦åœ¨2^5å’Œ2^8-1ä¹‹é—´ï¼Œé€‰ç”¨SDS_TYPE_8ç±»å‹çš„headerã€‚é•¿åº¦åœ¨2^8å’Œ2^16-1ä¹‹é—´ï¼Œé€‰ç”¨SDS_TYPE_16ç±»å‹çš„headerã€‚é•¿åº¦åœ¨2^16å’Œ2^32-1ä¹‹é—´ï¼Œé€‰ç”¨SDS_TYPE_32ç±»å‹çš„headerã€‚é•¿åº¦å¤§äº2^32çš„ï¼Œé€‰ç”¨SDS_TYPE_64ç±»å‹çš„headerã€‚èƒ½è¡¨ç¤ºçš„æœ€å¤§é•¿åº¦ä¸º2^64-1ã€‚æ³¨ï¼šsdsReqTypeçš„å®ç°ä»£ç ï¼Œç›´åˆ°3.2.0ï¼Œå®ƒåœ¨é•¿åº¦è¾¹ç•Œå€¼ä¸Šéƒ½ä¸€ç›´å­˜åœ¨é—®é¢˜ï¼Œç›´åˆ°æœ€è¿‘3.2 branchä¸Šçš„commit 6032340æ‰ä¿®å¤ã€‚ sdsçš„åˆ›å»ºå’Œé”€æ¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869sds sdsnewlen(const void *init, size_t initlen) &#123;void *sh;sds s;char type = sdsReqType(initlen);/* Empty strings are usually created in order to append. Use type 8* since type 5 is not good at this. */if (type == SDS_TYPE_5 &amp;&amp; initlen == 0) type = SDS_TYPE_8;int hdrlen = sdsHdrSize(type);unsigned char *fp; /* flags pointer. */ sh = s_malloc(hdrlen+initlen+1); if (!init) memset(sh, 0, hdrlen+initlen+1); if (sh == NULL) return NULL; s = (char*)sh+hdrlen; fp = ((unsigned char*)s)-1; switch(type) &#123; case SDS_TYPE_5: &#123; *fp = type | (initlen &lt;&lt; SDS_TYPE_BITS); break; &#125; case SDS_TYPE_8: &#123; SDS_HDR_VAR(8,s); sh-&gt;len = initlen; sh-&gt;alloc = initlen; *fp = type; break; &#125; case SDS_TYPE_16: &#123; SDS_HDR_VAR(16,s); sh-&gt;len = initlen; sh-&gt;alloc = initlen; *fp = type; break; &#125; case SDS_TYPE_32: &#123; SDS_HDR_VAR(32,s); sh-&gt;len = initlen; sh-&gt;alloc = initlen; *fp = type; break; &#125; case SDS_TYPE_64: &#123; SDS_HDR_VAR(64,s); sh-&gt;len = initlen; sh-&gt;alloc = initlen; *fp = type; break; &#125; &#125; if (initlen &amp;&amp; init) memcpy(s, init, initlen); s[initlen] = &#x27;\\0&#x27;; return s;&#125;sds sdsempty(void) &#123;return sdsnewlen(&quot;&quot;,0);&#125;sds sdsnew(const char *init) &#123;size_t initlen = (init == NULL) ? 0 : strlen(init);return sdsnewlen(init, initlen);&#125;void sdsfree(sds s) &#123;if (s == NULL) return;s_free((char*)s-sdsHdrSize(s[-1]));&#125; sdsnewlenåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸ºinitlençš„sdså­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨initæŒ‡å‘çš„å­—ç¬¦æ•°ç»„ï¼ˆä»»æ„äºŒè¿›åˆ¶æ•°æ®ï¼‰æ¥åˆå§‹åŒ–æ•°æ®ã€‚å¦‚æœinitä¸ºNULLï¼Œé‚£ä¹ˆä½¿ç”¨å…¨0æ¥åˆå§‹åŒ–æ•°æ®ã€‚å®ƒçš„å®ç°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼š å¦‚æœè¦åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º0çš„ç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä¸ä½¿ç”¨SDS_TYPE_5ç±»å‹çš„headerï¼Œè€Œæ˜¯è½¬è€Œä½¿ç”¨SDS_TYPE_8ç±»å‹çš„headerã€‚è¿™æ˜¯å› ä¸ºåˆ›å»ºçš„ç©ºå­—ç¬¦ä¸²ä¸€èˆ¬æ¥ä¸‹æ¥çš„æ“ä½œå¾ˆå¯èƒ½æ˜¯è¿½åŠ æ•°æ®ï¼Œä½†SDS_TYPE_5ç±»å‹çš„sdså­—ç¬¦ä¸²ä¸é€‚åˆè¿½åŠ æ•°æ®ï¼ˆä¼šå¼•å‘å†…å­˜é‡æ–°åˆ†é…ï¼‰ã€‚éœ€è¦çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ€§è¿›è¡Œåˆ†é…ï¼Œå…¶ä¸­åŒ…å«ä¸‰éƒ¨åˆ†ï¼šheaderã€æ•°æ®ã€æœ€åçš„å¤šä½™å­—èŠ‚ï¼ˆhdrlen+initlen+1ï¼‰ã€‚åˆå§‹åŒ–çš„sdså­—ç¬¦ä¸²æ•°æ®æœ€åä¼šè¿½åŠ ä¸€ä¸ªNULLç»“æŸç¬¦ï¼ˆs[initlen] = â€˜\\0â€™ï¼‰ã€‚å…³äºsdsfreeï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šå†…å­˜è¦æ•´ä½“é‡Šæ”¾ï¼Œæ‰€ä»¥è¦å…ˆè®¡ç®—å‡ºheaderèµ·å§‹æŒ‡é’ˆï¼ŒæŠŠå®ƒä¼ ç»™s_freeå‡½æ•°ã€‚è¿™ä¸ªæŒ‡é’ˆä¹Ÿæ­£æ˜¯åœ¨sdsnewlenä¸­è°ƒç”¨s_mallocè¿”å›çš„é‚£ä¸ªåœ°å€ã€‚ sdsçš„è¿æ¥ï¼ˆè¿½åŠ ï¼‰æ“ä½œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263sds sdscatlen(sds s, const void *t, size_t len) &#123;size_t curlen = sdslen(s); s = sdsMakeRoomFor(s,len); if (s == NULL) return NULL; memcpy(s+curlen, t, len); sdssetlen(s, curlen+len); s[curlen+len] = &#x27;\\0&#x27;; return s;&#125;sds sdscat(sds s, const char *t) &#123;return sdscatlen(s, t, strlen(t));&#125;sds sdscatsds(sds s, const sds t) &#123;return sdscatlen(s, t, sdslen(t));&#125;sds sdsMakeRoomFor(sds s, size_t addlen) &#123;void *sh, *newsh;size_t avail = sdsavail(s);size_t len, newlen;char type, oldtype = s[-1] &amp; SDS_TYPE_MASK;int hdrlen; /* Return ASAP if there is enough space left. */ if (avail &gt;= addlen) return s; len = sdslen(s); sh = (char*)s-sdsHdrSize(oldtype); newlen = (len+addlen); if (newlen &lt; SDS_MAX_PREALLOC) newlen *= 2; else newlen += SDS_MAX_PREALLOC; type = sdsReqType(newlen); /* Don&#x27;t use type 5: the user is appending to the string and type 5 is * not able to remember empty space, so sdsMakeRoomFor() must be called * at every appending operation. */ if (type == SDS_TYPE_5) type = SDS_TYPE_8; hdrlen = sdsHdrSize(type); if (oldtype==type) &#123; newsh = s_realloc(sh, hdrlen+newlen+1); if (newsh == NULL) return NULL; s = (char*)newsh+hdrlen; &#125; else &#123; /* Since the header size changes, need to move the string forward, * and can&#x27;t use realloc */ newsh = s_malloc(hdrlen+newlen+1); if (newsh == NULL) return NULL; memcpy((char*)newsh+hdrlen, s, len+1); s_free(sh); s = (char*)newsh+hdrlen; s[-1] = type; sdssetlen(s, len); &#125; sdssetalloc(s, newlen); return s;&#125; sdscatlenå°†tæŒ‡å‘çš„é•¿åº¦ä¸ºlençš„ä»»æ„äºŒè¿›åˆ¶æ•°æ®è¿½åŠ åˆ°sdså­—ç¬¦ä¸²sçš„åé¢ã€‚æœ¬æ–‡å¼€å¤´æ¼”ç¤ºçš„stringçš„appendå‘½ä»¤ï¼Œå†…éƒ¨å°±æ˜¯è°ƒç”¨sdscatlenæ¥å®ç°çš„ã€‚ åœ¨sdscatlençš„å®ç°ä¸­ï¼Œå…ˆè°ƒç”¨sdsMakeRoomForæ¥ä¿è¯å­—ç¬¦ä¸²sæœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥è¿½åŠ é•¿åº¦ä¸ºlençš„æ•°æ®ã€‚sdsMakeRoomForå¯èƒ½ä¼šåˆ†é…æ–°çš„å†…å­˜ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šã€‚ sdsMakeRoomForæ˜¯sdså®ç°ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªå‡½æ•°ã€‚å…³äºå®ƒçš„å®ç°ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼š å¦‚æœåŸæ¥å­—ç¬¦ä¸²ä¸­çš„ç©ºä½™ç©ºé—´å¤Ÿç”¨ï¼ˆavail &gt;= addlenï¼‰ï¼Œé‚£ä¹ˆå®ƒä»€ä¹ˆä¹Ÿä¸åšï¼Œç›´æ¥è¿”å›ã€‚å¦‚æœéœ€è¦åˆ†é…ç©ºé—´ï¼Œå®ƒä¼šæ¯”å®é™…è¯·æ±‚çš„è¦å¤šåˆ†é…ä¸€äº›ï¼Œä»¥é˜²å¤‡æ¥ä¸‹æ¥ç»§ç»­è¿½åŠ ã€‚å®ƒåœ¨å­—ç¬¦ä¸²å·²ç»æ¯”è¾ƒé•¿çš„æƒ…å†µä¸‹è¦è‡³å°‘å¤šåˆ†é…SDS_MAX_PREALLOCä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªå¸¸é‡åœ¨sds.hä¸­å®šä¹‰ä¸º(1024*1024)=1MBã€‚æŒ‰åˆ†é…åçš„ç©ºé—´å¤§å°ï¼Œå¯èƒ½éœ€è¦æ›´æ¢headerç±»å‹ï¼ˆåŸæ¥headerçš„allocå­—æ®µå¤ªçŸ­ï¼Œè¡¨è¾¾ä¸äº†å¢åŠ åçš„å®¹é‡ï¼‰ã€‚å¦‚æœéœ€è¦æ›´æ¢headerï¼Œé‚£ä¹ˆæ•´ä¸ªå­—ç¬¦ä¸²ç©ºé—´ï¼ˆåŒ…æ‹¬headerï¼‰éƒ½éœ€è¦é‡æ–°åˆ†é…ï¼ˆs_mallocï¼‰ï¼Œå¹¶æ‹·è´åŸæ¥çš„æ•°æ®åˆ°æ–°çš„ä½ç½®ã€‚å¦‚æœä¸éœ€è¦æ›´æ¢headerï¼ˆåŸæ¥çš„headerå¤Ÿç”¨ï¼‰ï¼Œé‚£ä¹ˆè°ƒç”¨ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„s_reallocï¼Œè¯•å›¾åœ¨åŸæ¥çš„åœ°å€ä¸Šé‡æ–°åˆ†é…ç©ºé—´ã€‚s_reallocçš„å…·ä½“å®ç°å¾—çœ‹Redisç¼–è¯‘çš„æ—¶å€™é€‰ç”¨äº†å“ªä¸ªallocatorï¼ˆåœ¨Linuxä¸Šé»˜è®¤ä½¿ç”¨jemallocï¼‰ã€‚ä½†ä¸ç®¡æ˜¯å“ªä¸ªreallocçš„å®ç°ï¼Œå®ƒæ‰€è¡¨è¾¾çš„å«ä¹‰åŸºæœ¬æ˜¯ç›¸åŒçš„ï¼šå®ƒå°½é‡åœ¨åŸæ¥åˆ†é…å¥½çš„åœ°å€ä½ç½®é‡æ–°åˆ†é…ï¼Œå¦‚æœåŸæ¥çš„åœ°å€ä½ç½®æœ‰è¶³å¤Ÿçš„ç©ºä½™ç©ºé—´å®Œæˆé‡æ–°åˆ†é…ï¼Œé‚£ä¹ˆå®ƒè¿”å›çš„æ–°åœ°å€ä¸ä¼ å…¥çš„æ—§åœ°å€ç›¸åŒï¼›å¦åˆ™ï¼Œå®ƒåˆ†é…æ–°çš„åœ°å€å—ï¼Œå¹¶è¿›è¡Œæ•°æ®æ¬è¿ã€‚å‚è§http://man.cx/reallocã€‚ä»sdscatlençš„å‡½æ•°æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ç§ä½¿ç”¨æ¨¡å¼ï¼šè°ƒç”¨å®ƒçš„æ—¶å€™ï¼Œä¼ å…¥ä¸€ä¸ªæ—§çš„sdså˜é‡ï¼Œç„¶åå®ƒè¿”å›ä¸€ä¸ªæ–°çš„sdså˜é‡ã€‚ç”±äºå®ƒçš„å†…éƒ¨å®ç°å¯èƒ½ä¼šé€ æˆåœ°å€å˜åŒ–ï¼Œå› æ­¤è°ƒç”¨è€…åœ¨è°ƒç”¨å®Œä¹‹åï¼ŒåŸæ¥æ—§çš„å˜é‡å°±å¤±æ•ˆäº†ï¼Œè€Œéƒ½åº”è¯¥ç”¨æ–°è¿”å›çš„å˜é‡æ¥æ›¿æ¢ã€‚ä¸ä»…ä»…æ˜¯sdscatlenå‡½æ•°ï¼Œsdsä¸­çš„å…¶å®ƒå‡½æ•°ï¼ˆæ¯”å¦‚sdscpyã€sdstrimã€sdsjoinç­‰ï¼‰ï¼Œè¿˜æœ‰Redisä¸­å…¶å®ƒä¸€äº›èƒ½è‡ªåŠ¨æ‰©å±•å†…å­˜çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ziplistï¼‰ï¼Œä¹Ÿéƒ½æ˜¯åŒæ ·çš„ä½¿ç”¨æ¨¡å¼ã€‚ æµ…è°ˆsdsä¸stringçš„å…³ç³»ç°åœ¨æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹æœ¬æ–‡å¼€å¤´ç»™å‡ºçš„stringæ“ä½œçš„ä¾‹å­ã€‚ appendæ“ä½œä½¿ç”¨sdsçš„sdscatlenæ¥å®ç°ã€‚å‰é¢å·²ç»æåˆ°ã€‚setbitå’Œgetrangeéƒ½æ˜¯å…ˆæ ¹æ®keyå–åˆ°æ•´ä¸ªsdså­—ç¬¦ä¸²ï¼Œç„¶åå†ä»å­—ç¬¦ä¸²é€‰å–æˆ–ä¿®æ”¹æŒ‡å®šçš„éƒ¨åˆ†ã€‚ç”±äºsdså°±æ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œæ‰€ä»¥å¯¹å®ƒçš„æŸä¸€éƒ¨åˆ†è¿›è¡Œæ“ä½œä¼¼ä¹éƒ½æ¯”è¾ƒç®€å•ã€‚ä½†æ˜¯ï¼Œstringé™¤äº†æ”¯æŒè¿™äº›æ“ä½œä¹‹å¤–ï¼Œå½“å®ƒå­˜å‚¨çš„å€¼æ˜¯ä¸ªæ•°å­—çš„æ—¶å€™ï¼Œå®ƒè¿˜æ”¯æŒincrã€decrç­‰æ“ä½œã€‚é‚£ä¹ˆï¼Œå½“stringå­˜å‚¨æ•°å­—å€¼çš„æ—¶å€™ï¼Œå®ƒçš„å†…éƒ¨å­˜å‚¨è¿˜æ˜¯sdså—ï¼Ÿå®é™…ä¸Šï¼Œä¸æ˜¯äº†ã€‚è€Œä¸”ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œsetbitå’Œgetrangeçš„å®ç°ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚è¿™äº›ç»†èŠ‚ï¼Œæˆ‘ä»¬æ”¾åœ¨ä¸‹ä¸€ç¯‡ä»‹ç»robjçš„æ—¶å€™å†è¿›è¡Œç³»ç»Ÿåœ°è®¨è®ºã€‚","categories":[{"name":"5.ç¼“å­˜","slug":"5-ç¼“å­˜","permalink":"https://zhangxin66666.github.io/categories/5-%E7%BC%93%E5%AD%98/"}],"tags":[{"name":"redis","slug":"redis","permalink":"https://zhangxin66666.github.io/tags/redis/"}]},{"title":"Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(3)â€”â€”robj","slug":"5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(3)â€”â€”robj","date":"2024-12-29T16:00:00.000Z","updated":"2024-12-30T06:13:49.761Z","comments":true,"path":"2024/12/30/5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(3)â€”â€”robj/","link":"","permalink":"https://zhangxin66666.github.io/2024/12/30/5.%E7%BC%93%E5%AD%98/Redis%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3(3)%E2%80%94%E2%80%94robj/","excerpt":"","text":"ä»Redisçš„ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹ï¼Œä¸€ä¸ªRedisèŠ‚ç‚¹åŒ…å«å¤šä¸ªdatabaseï¼ˆéclusteræ¨¡å¼ä¸‹é»˜è®¤æ˜¯16ä¸ªï¼Œclusteræ¨¡å¼ä¸‹åªèƒ½æ˜¯1ä¸ªï¼‰ï¼Œè€Œä¸€ä¸ªdatabaseç»´æŠ¤äº†ä»key spaceåˆ°object spaceçš„æ˜ å°„å…³ç³»ã€‚è¿™ä¸ªæ˜ å°„å…³ç³»çš„keyæ˜¯stringç±»å‹ï¼Œè€Œvalueå¯ä»¥æ˜¯å¤šç§æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ï¼šstring, list, hashç­‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œkeyçš„ç±»å‹å›ºå®šæ˜¯stringï¼Œè€Œvalueå¯èƒ½çš„ç±»å‹æ˜¯å¤šä¸ªã€‚ è€Œä»Rediså†…éƒ¨å®ç°çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨å‰é¢ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»æåˆ°è¿‡ï¼Œä¸€ä¸ªdatabaseå†…çš„è¿™ä¸ªæ˜ å°„å…³ç³»æ˜¯ç”¨ä¸€ä¸ªdictæ¥ç»´æŠ¤çš„ã€‚dictçš„keyå›ºå®šç”¨ä¸€ç§æ•°æ®ç»“æ„æ¥è¡¨è¾¾å°±å¤Ÿäº†ï¼Œè¿™å°±æ˜¯åŠ¨æ€å­—ç¬¦ä¸²sdsã€‚è€Œvalueåˆ™æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†åœ¨åŒä¸€ä¸ªdictå†…èƒ½å¤Ÿå­˜å‚¨ä¸åŒç±»å‹çš„valueï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªé€šç”¨çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªé€šç”¨çš„æ•°æ®ç»“æ„å°±æ˜¯robjï¼ˆå…¨åæ˜¯redisObjectï¼‰ã€‚ä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœvalueæ˜¯ä¸€ä¸ªlistï¼Œé‚£ä¹ˆå®ƒçš„å†…éƒ¨å­˜å‚¨ç»“æ„æ˜¯ä¸€ä¸ªquicklistï¼ˆquicklistçš„å…·ä½“å®ç°æˆ‘ä»¬æ”¾åœ¨åé¢çš„æ–‡ç« è®¨è®ºï¼‰ï¼›å¦‚æœvalueæ˜¯ä¸€ä¸ªstringï¼Œé‚£ä¹ˆå®ƒçš„å†…éƒ¨å­˜å‚¨ç»“æ„ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸€ä¸ªsdsã€‚å½“ç„¶å®é™…æƒ…å†µæ›´å¤æ‚ä¸€ç‚¹ï¼Œæ¯”å¦‚ä¸€ä¸ªstringç±»å‹çš„valueï¼Œå¦‚æœå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œé‚£ä¹ˆRediså†…éƒ¨è¿˜ä¼šæŠŠå®ƒè½¬æˆlongå‹æ¥å­˜å‚¨ï¼Œä»è€Œå‡å°å†…å­˜ä½¿ç”¨ã€‚è€Œä¸€ä¸ªrobjæ—¢èƒ½è¡¨ç¤ºä¸€ä¸ªsdsï¼Œä¹Ÿèƒ½è¡¨ç¤ºä¸€ä¸ªquicklistï¼Œç”šè‡³è¿˜èƒ½è¡¨ç¤ºä¸€ä¸ªlongå‹ã€‚ robjçš„æ•°æ®ç»“æ„å®šä¹‰åœ¨server.hä¸­æˆ‘ä»¬æ‰¾åˆ°è·Ÿrobjå®šä¹‰ç›¸å…³çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼ˆæ³¨æ„ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¸­çš„ä»£ç ç‰‡æ®µå…¨éƒ¨æ¥æºäºRedisæºç çš„3.2åˆ†æ”¯ï¼‰ï¼š 1234567891011121314151617181920212223242526272829/* Object types */#define OBJ_STRING 0#define OBJ_LIST 1#define OBJ_SET 2#define OBJ_ZSET 3#define OBJ_HASH 4/* Objects encoding. Some kind of objects like Strings and Hashes can be* internally represented in multiple ways. The &#x27;encoding&#x27; field of the object* is set to one of this fields for this object. */ #define OBJ_ENCODING_RAW 0 /* Raw representation */ #define OBJ_ENCODING_INT 1 /* Encoded as integer */ #define OBJ_ENCODING_HT 2 /* Encoded as hash table */ #define OBJ_ENCODING_ZIPMAP 3 /* Encoded as zipmap */ #define OBJ_ENCODING_LINKEDLIST 4 /* Encoded as regular linked list */ #define OBJ_ENCODING_ZIPLIST 5 /* Encoded as ziplist */ #define OBJ_ENCODING_INTSET 6 /* Encoded as intset */ #define OBJ_ENCODING_SKIPLIST 7 /* Encoded as skiplist */ #define OBJ_ENCODING_EMBSTR 8 /* Embedded sds string encoding */ #define OBJ_ENCODING_QUICKLIST 9 /* Encoded as linked list of ziplists */#define LRU_BITS 24typedef struct redisObject &#123;unsigned type:4;unsigned encoding:4;unsigned lru:LRU_BITS; /* lru time (relative to server.lruclock) */int refcount;void *ptr;&#125; robj; ä¸€ä¸ªrobjåŒ…å«å¦‚ä¸‹5ä¸ªå­—æ®µï¼š type: å¯¹è±¡çš„æ•°æ®ç±»å‹ã€‚å 4ä¸ªbitã€‚å¯èƒ½çš„å–å€¼æœ‰5ç§ï¼šOBJ_STRING, OBJ_LIST, OBJ_SET, OBJ_ZSET, OBJ_HASHï¼Œåˆ†åˆ«å¯¹åº”Rediså¯¹å¤–æš´éœ²çš„5ç§æ•°æ®ç»“æ„ï¼ˆå³æˆ‘ä»¬åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„ç¬¬ä¸€ä¸ªå±‚é¢çš„5ç§æ•°æ®ç»“æ„ï¼‰ã€‚encoding: å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºæ–¹å¼ï¼ˆä¹Ÿå¯ä»¥ç§°ä¸ºç¼–ç ï¼‰ã€‚å 4ä¸ªbitã€‚å¯èƒ½çš„å–å€¼æœ‰10ç§ï¼Œå³å‰é¢ä»£ç ä¸­çš„10ä¸ªOBJ_ENCODING_XXXå¸¸é‡ã€‚lru: åšLRUæ›¿æ¢ç®—æ³•ç”¨ï¼Œå 24ä¸ªbitã€‚è¿™ä¸ªä¸æ˜¯æˆ‘ä»¬è¿™é‡Œè®¨è®ºçš„é‡ç‚¹ï¼Œæš‚æ—¶å¿½ç•¥ã€‚refcount: å¼•ç”¨è®¡æ•°ã€‚å®ƒå…è®¸robjå¯¹è±¡åœ¨æŸäº›æƒ…å†µä¸‹è¢«å…±äº«ã€‚ptr: æ•°æ®æŒ‡é’ˆã€‚æŒ‡å‘çœŸæ­£çš„æ•°æ®ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªä»£è¡¨stringçš„robjï¼Œå®ƒçš„ptrå¯èƒ½æŒ‡å‘ä¸€ä¸ªsdsç»“æ„ï¼›ä¸€ä¸ªä»£è¡¨listçš„robjï¼Œå®ƒçš„ptrå¯èƒ½æŒ‡å‘ä¸€ä¸ªquicklistã€‚è¿™é‡Œç‰¹åˆ«éœ€è¦ä»”ç»†å¯Ÿçœ‹çš„æ˜¯encodingå­—æ®µã€‚å¯¹äºåŒä¸€ä¸ªtypeï¼Œè¿˜å¯èƒ½å¯¹åº”ä¸åŒçš„encodingï¼Œè¿™è¯´æ˜åŒæ ·çš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå¯èƒ½å­˜åœ¨ä¸åŒçš„å†…éƒ¨è¡¨ç¤ºæ–¹å¼ã€‚è€Œä¸åŒçš„å†…éƒ¨è¡¨ç¤ºï¼Œåœ¨å†…å­˜å ç”¨å’ŒæŸ¥æ‰¾æ€§èƒ½ä¸Šä¼šæœ‰æ‰€ä¸åŒã€‚ æ¯”å¦‚ï¼Œå½“type = OBJ_STRINGçš„æ—¶å€™ï¼Œè¡¨ç¤ºè¿™ä¸ªrobjå­˜å‚¨çš„æ˜¯ä¸€ä¸ªstringï¼Œè¿™æ—¶encodingå¯ä»¥æ˜¯ä¸‹é¢3ç§ä¸­çš„ä¸€ç§ï¼š OBJ_ENCODING_RAW: stringé‡‡ç”¨åŸç”Ÿçš„è¡¨ç¤ºæ–¹å¼ï¼Œå³ç”¨sdsæ¥è¡¨ç¤ºã€‚OBJ_ENCODING_INT: stringé‡‡ç”¨æ•°å­—çš„è¡¨ç¤ºæ–¹å¼ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªlongå‹ã€‚OBJ_ENCODING_EMBSTR: stringé‡‡ç”¨ä¸€ç§ç‰¹æ®Šçš„åµŒå…¥å¼çš„sdsæ¥è¡¨ç¤ºã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šè®¨è®ºåˆ°è¿™ä¸ªç»†èŠ‚ã€‚å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼šå½“type = OBJ_HASHçš„æ—¶å€™ï¼Œè¡¨ç¤ºè¿™ä¸ªrobjå­˜å‚¨çš„æ˜¯ä¸€ä¸ªhashï¼Œè¿™æ—¶encodingå¯ä»¥æ˜¯ä¸‹é¢2ç§ä¸­çš„ä¸€ç§ï¼š OBJ_ENCODING_HT: hashé‡‡ç”¨ä¸€ä¸ªdictæ¥è¡¨ç¤ºã€‚OBJ_ENCODING_ZIPLIST: hashé‡‡ç”¨ä¸€ä¸ªziplistæ¥è¡¨ç¤ºï¼ˆziplistçš„å…·ä½“å®ç°æˆ‘ä»¬æ”¾åœ¨åé¢çš„æ–‡ç« è®¨è®ºï¼‰ã€‚æœ¬æ–‡å‰©ä½™ä¸»è¦éƒ¨åˆ†å°†é’ˆå¯¹è¡¨ç¤ºstringçš„robjå¯¹è±¡ï¼Œå›´ç»•å®ƒçš„3ç§ä¸åŒçš„encodingæ¥æ·±å…¥è®¨è®ºã€‚å‰é¢ä»£ç æ®µä¸­å‡ºç°çš„æ‰€æœ‰10ç§encodingï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å…ˆç®€å•è§£é‡Šä¸€ä¸‹ï¼Œåœ¨è¿™ä¸ªç³»åˆ—åé¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥è¿˜æœ‰æœºä¼šç¢°åˆ°å®ƒä»¬ã€‚ OBJ_ENCODING_RAW: æœ€åŸç”Ÿçš„è¡¨ç¤ºæ–¹å¼ã€‚å…¶å®åªæœ‰stringç±»å‹æ‰ä¼šç”¨è¿™ä¸ªencodingå€¼ï¼ˆè¡¨ç¤ºæˆsdsï¼‰ã€‚OBJ_ENCODING_INT: è¡¨ç¤ºæˆæ•°å­—ã€‚å®é™…ç”¨longè¡¨ç¤ºã€‚OBJ_ENCODING_HT: è¡¨ç¤ºæˆdictã€‚OBJ_ENCODING_ZIPMAP: æ˜¯ä¸ªæ—§çš„è¡¨ç¤ºæ–¹å¼ï¼Œå·²ä¸å†ç”¨ã€‚åœ¨å°äºRedis 2.6çš„ç‰ˆæœ¬ä¸­æ‰æœ‰ã€‚OBJ_ENCODING_LINKEDLIST: ä¹Ÿæ˜¯ä¸ªæ—§çš„è¡¨ç¤ºæ–¹å¼ï¼Œå·²ä¸å†ç”¨ã€‚OBJ_ENCODING_ZIPLIST: è¡¨ç¤ºæˆziplistã€‚OBJ_ENCODING_INTSET: è¡¨ç¤ºæˆintsetã€‚ç”¨äºsetæ•°æ®ç»“æ„ã€‚OBJ_ENCODING_SKIPLIST: è¡¨ç¤ºæˆskiplistã€‚ç”¨äºsorted setæ•°æ®ç»“æ„ã€‚OBJ_ENCODING_EMBSTR: è¡¨ç¤ºæˆä¸€ç§ç‰¹æ®Šçš„åµŒå…¥å¼çš„sdsã€‚OBJ_ENCODING_QUICKLIST: è¡¨ç¤ºæˆquicklistã€‚ç”¨äºlistæ•°æ®ç»“æ„ã€‚æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹robjçš„ä½œç”¨ï¼š ä¸ºå¤šç§æ•°æ®ç±»å‹æä¾›ä¸€ç§ç»Ÿä¸€çš„è¡¨ç¤ºæ–¹å¼ã€‚å…è®¸åŒä¸€ç±»å‹çš„æ•°æ®é‡‡ç”¨ä¸åŒçš„å†…éƒ¨è¡¨ç¤ºï¼Œä»è€Œåœ¨æŸäº›æƒ…å†µä¸‹å°½é‡èŠ‚çœå†…å­˜ã€‚æ”¯æŒå¯¹è±¡å…±äº«å’Œå¼•ç”¨è®¡æ•°ã€‚å½“å¯¹è±¡è¢«å…±äº«çš„æ—¶å€™ï¼Œåªå ç”¨ä¸€ä»½å†…å­˜æ‹·è´ï¼Œè¿›ä¸€æ­¥èŠ‚çœå†…å­˜ã€‚string robjçš„ç¼–ç è¿‡ç¨‹å½“æˆ‘ä»¬æ‰§è¡ŒRedisçš„setå‘½ä»¤çš„æ—¶å€™ï¼ŒRedisé¦–å…ˆå°†æ¥æ”¶åˆ°çš„valueå€¼ï¼ˆstringç±»å‹ï¼‰è¡¨ç¤ºæˆä¸€ä¸ªtype = OBJ_STRINGå¹¶ä¸”encoding = OBJ_ENCODING_RAWçš„robjå¯¹è±¡ï¼Œç„¶ååœ¨å­˜å…¥å†…éƒ¨å­˜å‚¨ä¹‹å‰å…ˆæ‰§è¡Œä¸€ä¸ªç¼–ç è¿‡ç¨‹ï¼Œè¯•å›¾å°†å®ƒè¡¨ç¤ºæˆå¦ä¸€ç§æ›´èŠ‚çœå†…å­˜çš„encodingæ–¹å¼ã€‚è¿™ä¸€è¿‡ç¨‹çš„æ ¸å¿ƒä»£ç ï¼Œæ˜¯object.cä¸­çš„tryObjectEncodingå‡½æ•°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778robj *tryObjectEncoding(robj *o) &#123;long value;sds s = o-&gt;ptr;size_t len; /* Make sure this is a string object, the only type we encode * in this function. Other types use encoded memory efficient * representations but are handled by the commands implementing * the type. */ serverAssertWithInfo(NULL,o,o-&gt;type == OBJ_STRING); /* We try some specialized encoding only for objects that are * RAW or EMBSTR encoded, in other words objects that are still * in represented by an actually array of chars. */ if (!sdsEncodedObject(o)) return o; /* It&#x27;s not safe to encode shared objects: shared objects can be shared * everywhere in the &quot;object space&quot; of Redis and may end in places where * they are not handled. We handle them only as values in the keyspace. */ if (o-&gt;refcount &gt; 1) return o; /* Check if we can represent this string as a long integer. * Note that we are sure that a string larger than 21 chars is not * representable as a 32 nor 64 bit integer. */ len = sdslen(s); if (len &lt;= 21 &amp;&amp; string2l(s,len,&amp;value)) &#123; /* This object is encodable as a long. Try to use a shared object. * Note that we avoid using shared integers when maxmemory is used * because every object needs to have a private LRU field for the LRU * algorithm to work well. */ if ((server.maxmemory == 0 || (server.maxmemory_policy != MAXMEMORY_VOLATILE_LRU &amp;&amp; server.maxmemory_policy != MAXMEMORY_ALLKEYS_LRU)) &amp;&amp; value &gt;= 0 &amp;&amp; value &lt; OBJ_SHARED_INTEGERS) &#123; decrRefCount(o); incrRefCount(shared.integers[value]); return shared.integers[value]; &#125; else &#123; if (o-&gt;encoding == OBJ_ENCODING_RAW) sdsfree(o-&gt;ptr); o-&gt;encoding = OBJ_ENCODING_INT; o-&gt;ptr = (void*) value; return o; &#125; &#125; /* If the string is small and is still RAW encoded, * try the EMBSTR encoding which is more efficient. * In this representation the object and the SDS string are allocated * in the same chunk of memory to save space and cache misses. */ if (len &lt;= OBJ_ENCODING_EMBSTR_SIZE_LIMIT) &#123; robj *emb; if (o-&gt;encoding == OBJ_ENCODING_EMBSTR) return o; emb = createEmbeddedStringObject(s,sdslen(s)); decrRefCount(o); return emb; &#125; /* We can&#x27;t encode the object... * * Do the last try, and at least optimize the SDS string inside * the string object to require little space, in case there * is more than 10% of free space at the end of the SDS string. * * We do that only for relatively large strings as this branch * is only entered if the length of the string is greater than * OBJ_ENCODING_EMBSTR_SIZE_LIMIT. */ if (o-&gt;encoding == OBJ_ENCODING_RAW &amp;&amp; sdsavail(s) &gt; len/10) &#123; o-&gt;ptr = sdsRemoveFreeSpace(o-&gt;ptr); &#125; /* Return the original object. */ return o;&#125; è¿™æ®µä»£ç æ‰§è¡Œçš„æ“ä½œæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä»”ç»†çœ‹ä¸€ä¸‹æ¯ä¸€æ­¥çš„æ“ä½œï¼š ç¬¬1æ­¥æ£€æŸ¥ï¼Œæ£€æŸ¥typeã€‚ç¡®ä¿åªå¯¹stringç±»å‹çš„å¯¹è±¡è¿›è¡Œæ“ä½œã€‚ç¬¬2æ­¥æ£€æŸ¥ï¼Œæ£€æŸ¥encodingã€‚sdsEncodedObjectæ˜¯å®šä¹‰åœ¨server.hä¸­çš„ä¸€ä¸ªå®ï¼Œç¡®ä¿åªå¯¹OBJ_ENCODING_RAWå’ŒOBJ_ENCODING_EMBSTRç¼–ç çš„stringå¯¹è±¡è¿›è¡Œæ“ä½œã€‚è¿™ä¸¤ç§ç¼–ç çš„stringéƒ½é‡‡ç”¨sdsæ¥å­˜å‚¨ï¼Œå¯ä»¥å°è¯•è¿›ä¸€æ­¥ç¼–ç å¤„ç†ã€‚#define sdsEncodedObject(objptr) (objptr-&gt;encoding == OBJ_ENCODING_RAW || objptr-&gt;encoding == OBJ_ENCODING_EMBSTR)ç¬¬3æ­¥æ£€æŸ¥ï¼Œæ£€æŸ¥refcountã€‚å¼•ç”¨è®¡æ•°å¤§äº1çš„å…±äº«å¯¹è±¡ï¼Œåœ¨å¤šå¤„è¢«å¼•ç”¨ã€‚ç”±äºç¼–ç è¿‡ç¨‹ç»“æŸårobjçš„å¯¹è±¡æŒ‡é’ˆå¯èƒ½ä¼šå˜åŒ–ï¼ˆæˆ‘ä»¬åœ¨å‰ä¸€ç¯‡ä»‹ç»sdscatlenå‡½æ•°çš„æ—¶å€™æåˆ°è¿‡ç±»ä¼¼è¿™ç§æ¥å£ä½¿ç”¨æ¨¡å¼ï¼‰ï¼Œè¿™æ ·å¯¹äºå¼•ç”¨è®¡æ•°å¤§äº1çš„å¯¹è±¡ï¼Œå°±éœ€è¦æ›´æ–°æ‰€æœ‰åœ°æ–¹çš„å¼•ç”¨ï¼Œè¿™ä¸å®¹æ˜“åšåˆ°ã€‚å› æ­¤ï¼Œå¯¹äºè®¡æ•°å¤§äº1çš„å¯¹è±¡ä¸åšç¼–ç å¤„ç†ã€‚è¯•å›¾å°†å­—ç¬¦ä¸²è½¬æˆ64ä½çš„longã€‚64ä½çš„longæ‰€èƒ½è¡¨è¾¾çš„æ•°æ®èŒƒå›´æ˜¯-2^63åˆ°2^63-1ï¼Œç”¨åè¿›åˆ¶è¡¨è¾¾å‡ºæ¥æœ€é•¿æ˜¯20ä½æ•°ï¼ˆåŒ…æ‹¬è´Ÿå·ï¼‰ã€‚è¿™é‡Œåˆ¤æ–­å°äºç­‰äº21ï¼Œä¼¼ä¹æ˜¯å†™å¤šäº†ï¼Œå®é™…åˆ¤æ–­å°äºç­‰äº20å°±å¤Ÿäº†ï¼ˆå¦‚æœæˆ‘ç®—é”™äº†è¯·ä¸€å®šå‘Šè¯‰æˆ‘å“¦ï¼‰ã€‚string2lå¦‚æœå°†å­—ç¬¦ä¸²è½¬æˆlongè½¬æˆåŠŸäº†ï¼Œé‚£ä¹ˆä¼šè¿”å›1å¹¶ä¸”å°†è½¬å¥½çš„longå­˜åˆ°valueå˜é‡é‡Œã€‚åœ¨è½¬æˆlongæˆåŠŸæ—¶ï¼Œåˆåˆ†ä¸ºä¸¤ç§æƒ…å†µã€‚ç¬¬ä¸€ç§æƒ…å†µï¼šå¦‚æœRedisçš„é…ç½®ä¸è¦æ±‚è¿è¡ŒLRUæ›¿æ¢ç®—æ³•ï¼Œä¸”è½¬æˆçš„longå‹æ•°å­—çš„å€¼åˆæ¯”è¾ƒå°ï¼ˆå°äºOBJ_SHARED_INTEGERSï¼Œåœ¨ç›®å‰çš„å®ç°ä¸­è¿™ä¸ªå€¼æ˜¯10000ï¼‰ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨å…±äº«æ•°å­—å¯¹è±¡æ¥è¡¨ç¤ºã€‚ä¹‹æ‰€ä»¥è¿™é‡Œçš„åˆ¤æ–­è·ŸLRUæœ‰å…³ï¼Œæ˜¯å› ä¸ºLRUç®—æ³•è¦æ±‚æ¯ä¸ªrobjæœ‰ä¸åŒçš„lruå­—æ®µå€¼ï¼Œæ‰€ä»¥ç”¨äº†LRUå°±ä¸èƒ½å…±äº«robjã€‚shared.integersæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º10000çš„æ•°ç»„ï¼Œé‡Œé¢é¢„å­˜äº†10000ä¸ªå°çš„æ•°å­—å¯¹è±¡ã€‚è¿™äº›å°æ•°å­—å¯¹è±¡éƒ½æ˜¯encoding = OBJ_ENCODING_INTçš„string robjå¯¹è±¡ã€‚ç¬¬äºŒç§æƒ…å†µï¼šå¦‚æœå‰ä¸€æ­¥ä¸èƒ½ä½¿ç”¨å…±äº«å°å¯¹è±¡æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆå°†åŸæ¥çš„robjç¼–ç æˆencoding = OBJ_ENCODING_INTï¼Œè¿™æ—¶ptrå­—æ®µç›´æ¥å­˜æˆè¿™ä¸ªlongå‹çš„å€¼ã€‚æ³¨æ„ptrå­—æ®µæœ¬æ¥æ˜¯ä¸€ä¸ªvoid *æŒ‡é’ˆï¼ˆå³å­˜å‚¨çš„æ˜¯å†…å­˜åœ°å€ï¼‰ï¼Œå› æ­¤åœ¨64ä½æœºå™¨ä¸Šæœ‰64ä½å®½åº¦ï¼Œæ­£å¥½èƒ½å­˜å‚¨ä¸€ä¸ª64ä½çš„longå‹å€¼ã€‚è¿™æ ·ï¼Œé™¤äº†robjæœ¬èº«ä¹‹å¤–ï¼Œå®ƒå°±ä¸å†éœ€è¦é¢å¤–çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨å­—ç¬¦ä¸²å€¼ã€‚æ¥ä¸‹æ¥æ˜¯å¯¹äºé‚£äº›ä¸èƒ½è½¬æˆ64ä½longçš„å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†ã€‚æœ€åå†åšä¸¤æ­¥å¤„ç†ï¼šå¦‚æœå­—ç¬¦ä¸²é•¿åº¦è¶³å¤Ÿå°ï¼ˆå°äºç­‰äºOBJ_ENCODING_EMBSTR_SIZE_LIMITï¼Œå®šä¹‰ä¸º44ï¼‰ï¼Œé‚£ä¹ˆè°ƒç”¨createEmbeddedStringObjectç¼–ç æˆencoding = OBJ_ENCODING_EMBSTRï¼›å¦‚æœå‰é¢æ‰€æœ‰çš„ç¼–ç å°è¯•éƒ½æ²¡æœ‰æˆåŠŸï¼ˆä»ç„¶æ˜¯OBJ_ENCODING_RAWï¼‰ï¼Œä¸”sdsé‡Œç©ºä½™å­—èŠ‚è¿‡å¤šï¼Œé‚£ä¹ˆåšæœ€åä¸€æ¬¡åŠªåŠ›ï¼Œè°ƒç”¨sdsçš„sdsRemoveFreeSpaceæ¥å£æ¥é‡Šæ”¾ç©ºä½™å­—èŠ‚ã€‚å…¶ä¸­è°ƒç”¨çš„createEmbeddedStringObjectï¼Œæˆ‘ä»¬æœ‰å¿…è¦çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç ï¼š 123456789101112131415161718192021robj *createEmbeddedStringObject(const char *ptr, size_t len) &#123;robj *o = zmalloc(sizeof(robj)+sizeof(struct sdshdr8)+len+1);struct sdshdr8 *sh = (void*)(o+1); o-&gt;type = OBJ_STRING; o-&gt;encoding = OBJ_ENCODING_EMBSTR; o-&gt;ptr = sh+1; o-&gt;refcount = 1; o-&gt;lru = LRU_CLOCK(); sh-&gt;len = len; sh-&gt;alloc = len; sh-&gt;flags = SDS_TYPE_8; if (ptr) &#123; memcpy(sh-&gt;buf,ptr,len); sh-&gt;buf[len] = &#x27;\\0&#x27;; &#125; else &#123; memset(sh-&gt;buf,0,len+1); &#125; return o;&#125; createEmbeddedStringObjectå¯¹sdsé‡æ–°åˆ†é…å†…å­˜ï¼Œå°†robjå’Œsdsæ”¾åœ¨ä¸€ä¸ªè¿ç»­çš„å†…å­˜å—ä¸­åˆ†é…ï¼Œè¿™æ ·å¯¹äºçŸ­å­—ç¬¦ä¸²çš„å­˜å‚¨æœ‰åˆ©äºå‡å°‘å†…å­˜ç¢ç‰‡ã€‚è¿™ä¸ªè¿ç»­çš„å†…å­˜å—åŒ…å«å¦‚ä¸‹å‡ éƒ¨åˆ†ï¼š 16ä¸ªå­—èŠ‚çš„robjç»“æ„ã€‚3ä¸ªå­—èŠ‚çš„sdshdr8å¤´ã€‚æœ€å¤š44ä¸ªå­—èŠ‚çš„sdså­—ç¬¦æ•°ç»„ã€‚1ä¸ªNULLç»“æŸç¬¦ã€‚åŠ èµ·æ¥ä¸€å…±ä¸è¶…è¿‡64å­—èŠ‚ï¼ˆ16+3+44+1ï¼‰ï¼Œå› æ­¤è¿™æ ·çš„ä¸€ä¸ªçŸ­å­—ç¬¦ä¸²å¯ä»¥å®Œå…¨åˆ†é…åœ¨ä¸€ä¸ª64å­—èŠ‚é•¿åº¦çš„å†…å­˜å—ä¸­ã€‚ string robjçš„è§£ç è¿‡ç¨‹å½“æˆ‘ä»¬éœ€è¦è·å–å­—ç¬¦ä¸²çš„å€¼ï¼Œæ¯”å¦‚æ‰§è¡Œgetå‘½ä»¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸å‰é¢è®²çš„ç¼–ç è¿‡ç¨‹ç›¸åçš„æ“ä½œâ€”â€”è§£ç ã€‚ è¿™ä¸€è§£ç è¿‡ç¨‹çš„æ ¸å¿ƒä»£ç ï¼Œæ˜¯object.cä¸­çš„getDecodedObjectå‡½æ•°ã€‚ 1234567891011121314151617robj *getDecodedObject(robj *o) &#123;robj *dec; if (sdsEncodedObject(o)) &#123; incrRefCount(o); return o; &#125; if (o-&gt;type == OBJ_STRING &amp;&amp; o-&gt;encoding == OBJ_ENCODING_INT) &#123; char buf[32]; ll2string(buf,32,(long)o-&gt;ptr); dec = createStringObject(buf,strlen(buf)); return dec; &#125; else &#123; serverPanic(&quot;Unknown encoding type&quot;); &#125;&#125; è¿™ä¸ªè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œéœ€è¦æˆ‘ä»¬æ³¨æ„çš„ç‚¹æœ‰ï¼š ç¼–ç ä¸ºOBJ_ENCODING_RAWå’ŒOBJ_ENCODING_EMBSTRçš„å­—ç¬¦ä¸²robjå¯¹è±¡ï¼Œä¸åšå˜åŒ–ï¼ŒåŸå°ä¸åŠ¨è¿”å›ã€‚ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦ï¼Œè¿™ä¸¤ç§ç¼–ç æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå†…éƒ¨éƒ½æ˜¯å°è£…çš„sdsã€‚ç¼–ç ä¸ºæ•°å­—çš„å­—ç¬¦ä¸²robjå¯¹è±¡ï¼Œå°†longé‡æ–°è½¬ä¸ºåè¿›åˆ¶å­—ç¬¦ä¸²çš„å½¢å¼ï¼Œç„¶åè°ƒç”¨createStringObjectè½¬ä¸ºsdsçš„è¡¨ç¤ºã€‚æ³¨æ„ï¼šè¿™é‡Œç”±longè½¬æˆçš„sdså­—ç¬¦ä¸²é•¿åº¦è‚¯å®šä¸è¶…è¿‡20ï¼Œè€Œæ ¹æ®createStringObjectçš„å®ç°ï¼Œå®ƒä»¬è‚¯å®šä¼šè¢«ç¼–ç æˆOBJ_ENCODING_EMBSTRçš„å¯¹è±¡ã€‚createStringObjectçš„ä»£ç å¦‚ä¸‹ï¼š 123456robj *createStringObject(const char *ptr, size_t len) &#123;if (len &lt;= OBJ_ENCODING_EMBSTR_SIZE_LIMIT)return createEmbeddedStringObject(ptr,len);elsereturn createRawStringObject(ptr,len);&#125; å†è°ˆsdsä¸stringçš„å…³ç³»åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç®€å•åœ°æåˆ°äº†sdsä¸stringçš„å…³ç³»ï¼›åœ¨æœ¬æ–‡ä»‹ç»äº†robjçš„æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬é‡æ–°æ€»ç»“ä¸€ä¸‹sdsä¸stringçš„å…³ç³»ã€‚ ç¡®åˆ‡åœ°è¯´ï¼Œstringåœ¨Redisä¸­æ˜¯ç”¨ä¸€ä¸ªrobjæ¥è¡¨ç¤ºçš„ã€‚ç”¨æ¥è¡¨ç¤ºstringçš„robjå¯èƒ½ç¼–ç æˆ3ç§å†…éƒ¨è¡¨ç¤ºï¼šOBJ_ENCODING_RAW, OBJ_ENCODING_EMBSTR, OBJ_ENCODING_INTã€‚å…¶ä¸­å‰ä¸¤ç§ç¼–ç ä½¿ç”¨çš„æ˜¯sdsæ¥å­˜å‚¨ï¼Œæœ€åä¸€ç§OBJ_ENCODING_INTç¼–ç ç›´æ¥æŠŠstringå­˜æˆäº†longå‹ã€‚åœ¨å¯¹stringè¿›è¡Œincr, decrç­‰æ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœå®ƒå†…éƒ¨æ˜¯OBJ_ENCODING_INTç¼–ç ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è¿›è¡ŒåŠ å‡æ“ä½œï¼›å¦‚æœå®ƒå†…éƒ¨æ˜¯OBJ_ENCODING_RAWæˆ–OBJ_ENCODING_EMBSTRç¼–ç ï¼Œé‚£ä¹ˆRedisä¼šå…ˆè¯•å›¾æŠŠsdså­˜å‚¨çš„å­—ç¬¦ä¸²è½¬æˆlongå‹ï¼Œå¦‚æœèƒ½è½¬æˆåŠŸï¼Œå†è¿›è¡ŒåŠ å‡æ“ä½œã€‚å¯¹ä¸€ä¸ªå†…éƒ¨è¡¨ç¤ºæˆlongå‹çš„stringæ‰§è¡Œappend, setbit, getrangeè¿™äº›å‘½ä»¤ï¼Œé’ˆå¯¹çš„ä»ç„¶æ˜¯stringçš„å€¼ï¼ˆå³åè¿›åˆ¶è¡¨ç¤ºçš„å­—ç¬¦ä¸²ï¼‰ï¼Œè€Œä¸æ˜¯é’ˆå¯¹å†…éƒ¨è¡¨ç¤ºçš„longå‹è¿›è¡Œæ“ä½œã€‚æ¯”å¦‚å­—ç¬¦ä¸²â€32â€ï¼Œå¦‚æœæŒ‰ç…§å­—ç¬¦æ•°ç»„æ¥è§£é‡Šï¼Œå®ƒåŒ…å«ä¸¤ä¸ªå­—ç¬¦ï¼Œå®ƒä»¬çš„ASCIIç åˆ†åˆ«æ˜¯0x33å’Œ0x32ã€‚å½“æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤setbit key 7 0çš„æ—¶å€™ï¼Œç›¸å½“äºæŠŠå­—ç¬¦0x33å˜æˆäº†0x32ï¼Œè¿™æ ·å­—ç¬¦ä¸²çš„å€¼å°±å˜æˆäº†â€22â€ã€‚è€Œå¦‚æœå°†å­—ç¬¦ä¸²â€32â€æŒ‰ç…§å†…éƒ¨çš„64ä½longå‹æ¥è§£é‡Šï¼Œé‚£ä¹ˆå®ƒæ˜¯0x0000000000000020ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šæ‰§è¡Œsetbitä½æ“ä½œï¼Œç»“æœå°±å®Œå…¨ä¸å¯¹äº†ã€‚å› æ­¤ï¼Œåœ¨è¿™äº›å‘½ä»¤çš„å®ç°ä¸­ï¼Œä¼šæŠŠlongå‹å…ˆè½¬æˆå­—ç¬¦ä¸²å†è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚ç”±äºç¯‡å¹…åŸå› ï¼Œè¿™ä¸‰ä¸ªå‘½ä»¤çš„å®ç°ä»£ç è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒRedisæºç ï¼št_string.cä¸­çš„appendCommandå‡½æ•°ï¼›biops.cä¸­çš„setbitCommandå‡½æ•°ï¼›t_string.cä¸­çš„getrangeCommandå‡½æ•°ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œappendå’Œsetbitå‘½ä»¤çš„å®ç°ä¸­ï¼Œéƒ½ä¼šæœ€ç»ˆè°ƒç”¨åˆ°db.cä¸­çš„dbUnshareStringValueå‡½æ•°ï¼Œå°†stringå¯¹è±¡çš„å†…éƒ¨ç¼–ç è½¬æˆOBJ_ENCODING_RAWçš„ï¼ˆåªæœ‰è¿™ç§ç¼–ç çš„robjå¯¹è±¡ï¼Œå…¶å†…éƒ¨çš„sds æ‰èƒ½åœ¨åé¢è‡ªç”±è¿½åŠ æ–°çš„å†…å®¹ï¼‰ï¼Œå¹¶è§£é™¤å¯èƒ½å­˜åœ¨çš„å¯¹è±¡å…±äº«çŠ¶æ€ã€‚è¿™é‡Œé¢è°ƒç”¨äº†å‰é¢æåˆ°çš„getDecodedObjectã€‚ 12345678910robj *dbUnshareStringValue(redisDb *db, robj *key, robj *o) &#123;serverAssert(o-&gt;type == OBJ_STRING);if (o-&gt;refcount != 1 || o-&gt;encoding != OBJ_ENCODING_RAW) &#123;robj *decoded = getDecodedObject(o);o = createRawStringObject(decoded-&gt;ptr, sdslen(decoded-&gt;ptr));decrRefCount(decoded);dbOverwrite(db,key,o);&#125;return o;&#125; robjçš„å¼•ç”¨è®¡æ•°æ“ä½œå°†robjçš„å¼•ç”¨è®¡æ•°åŠ 1å’Œå‡1çš„æ“ä½œï¼Œå®šä¹‰åœ¨object.cä¸­ï¼š 1234567891011121314151617181920void incrRefCount(robj *o) &#123;o-&gt;refcount++;&#125;void decrRefCount(robj *o) &#123;if (o-&gt;refcount &lt;= 0) serverPanic(&quot;decrRefCount against refcount &lt;= 0&quot;);if (o-&gt;refcount == 1) &#123;switch(o-&gt;type) &#123;case OBJ_STRING: freeStringObject(o); break;case OBJ_LIST: freeListObject(o); break;case OBJ_SET: freeSetObject(o); break;case OBJ_ZSET: freeZsetObject(o); break;case OBJ_HASH: freeHashObject(o); break;default: serverPanic(&quot;Unknown object type&quot;); break;&#125;zfree(o);&#125; else &#123;o-&gt;refcount--;&#125;&#125; æˆ‘ä»¬ç‰¹åˆ«å…³æ³¨ä¸€ä¸‹å°†å¼•ç”¨è®¡æ•°å‡1çš„æ“ä½œdecrRefCountã€‚å¦‚æœåªå‰©ä¸‹æœ€åä¸€ä¸ªå¼•ç”¨äº†ï¼ˆrefcountå·²ç»æ˜¯1äº†ï¼‰ï¼Œé‚£ä¹ˆåœ¨decrRefCountè¢«è°ƒç”¨åï¼Œæ•´ä¸ªrobjå°†è¢«é‡Šæ”¾ã€‚ æ³¨æ„ï¼šRedisçš„delå‘½ä»¤å°±ä¾èµ–decrRefCountæ“ä½œå°†valueé‡Šæ”¾æ‰ã€‚ ç»è¿‡äº†æœ¬æ–‡çš„è®¨è®ºï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºï¼Œrobjæ‰€è¡¨ç¤ºçš„å°±æ˜¯Rediså¯¹å¤–æš´éœ²çš„ç¬¬ä¸€å±‚é¢çš„æ•°æ®ç»“æ„ï¼šstring, list, hash, set, sorted setï¼Œè€Œæ¯ä¸€ç§æ•°æ®ç»“æ„çš„åº•å±‚å®ç°æ‰€å¯¹åº”çš„æ˜¯å“ªä¸ªï¼ˆæˆ–å“ªäº›ï¼‰ç¬¬äºŒå±‚é¢çš„æ•°æ®ç»“æ„ï¼ˆdict, sds, ziplist, quicklist, skiplist, ç­‰ï¼‰ï¼Œåˆ™é€šè¿‡ä¸åŒçš„encodingæ¥åŒºåˆ†ã€‚å¯ä»¥è¯´ï¼Œrobjæ˜¯è”ç»“ä¸¤ä¸ªå±‚é¢çš„æ•°æ®ç»“æ„çš„æ¡¥æ¢ã€‚ æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†OBJ_STRINGç±»å‹çš„å­—ç¬¦ä¸²å¯¹è±¡çš„åº•å±‚å®ç°ï¼Œå…¶ç¼–ç å’Œè§£ç è¿‡ç¨‹åœ¨Redisé‡Œéå¸¸é‡è¦ï¼Œåº”ç”¨å¹¿æ³›ï¼Œæˆ‘ä»¬åœ¨åé¢çš„è®¨è®ºä¸­å¯èƒ½è¿˜ä¼šé‡åˆ°ã€‚ç°åœ¨æœ‰äº†robjçš„æ¦‚å¿µåŸºç¡€ï¼Œæˆ‘ä»¬ä¸‹ä¸€ç¯‡ä¼šè®¨è®ºziplistï¼Œä»¥åŠå®ƒä¸hashçš„å…³ç³»ã€‚","categories":[{"name":"5.ç¼“å­˜","slug":"5-ç¼“å­˜","permalink":"https://zhangxin66666.github.io/categories/5-%E7%BC%93%E5%AD%98/"}],"tags":[{"name":"redis","slug":"redis","permalink":"https://zhangxin66666.github.io/tags/redis/"}]},{"title":"Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(4)â€”â€”ziplist","slug":"5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(4)â€”â€”ziplist","date":"2024-12-29T16:00:00.000Z","updated":"2024-12-30T06:24:59.653Z","comments":true,"path":"2024/12/30/5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(4)â€”â€”ziplist/","link":"","permalink":"https://zhangxin66666.github.io/2024/12/30/5.%E7%BC%93%E5%AD%98/Redis%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3(4)%E2%80%94%E2%80%94ziplist/","excerpt":"","text":"åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä»‹ç»ä¸€ä¸ªæ–°çš„Rediså†…éƒ¨æ•°æ®ç»“æ„â€”â€”ziplistï¼Œç„¶ååœ¨æ–‡ç« ååŠéƒ¨åˆ†æˆ‘ä»¬ä¼šè®¨è®ºä¸€ä¸‹åœ¨robj, dictå’Œziplistçš„åŸºç¡€ä¸Šï¼ŒRediså¯¹å¤–æš´éœ²çš„hashç»“æ„æ˜¯æ€æ ·æ„å»ºèµ·æ¥çš„ã€‚ æˆ‘ä»¬åœ¨è®¨è®ºä¸­è¿˜ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªRedisé…ç½®ï¼ˆåœ¨redis.confä¸­çš„ADVANCED CONFIGéƒ¨åˆ†ï¼‰ï¼š 12hash-max-ziplist-entries 512hash-max-ziplist-value 64 æœ¬æ–‡çš„ååŠéƒ¨åˆ†ä¼šå¯¹è¿™ä¸¤ä¸ªé…ç½®åšè¯¦ç»†çš„è§£é‡Šã€‚ ä»€ä¹ˆæ˜¯ziplistRediså®˜æ–¹å¯¹äºziplistçš„å®šä¹‰æ˜¯ï¼ˆå‡ºè‡ªziplist.cçš„æ–‡ä»¶å¤´éƒ¨æ³¨é‡Šï¼‰ï¼š The ziplist is a specially encoded dually linked list that is designed to be very memory efficient. It stores both strings and integer values, where integers are encoded as actual integers instead of a series of characters. It allows push and pop operations on either side of the list in O(1) time. ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯è¯´ï¼šziplistæ˜¯ä¸€ä¸ªç»è¿‡ç‰¹æ®Šç¼–ç çš„åŒå‘é“¾è¡¨ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡å°±æ˜¯ä¸ºäº†æé«˜å­˜å‚¨æ•ˆç‡ã€‚ziplistå¯ä»¥ç”¨äºå­˜å‚¨å­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼Œå…¶ä¸­æ•´æ•°æ˜¯æŒ‰çœŸæ­£çš„äºŒè¿›åˆ¶è¡¨ç¤ºè¿›è¡Œç¼–ç çš„ï¼Œè€Œä¸æ˜¯ç¼–ç æˆå­—ç¬¦ä¸²åºåˆ—ã€‚å®ƒèƒ½ä»¥O(1)çš„æ—¶é—´å¤æ‚åº¦åœ¨è¡¨çš„ä¸¤ç«¯æä¾›pushå’Œpopæ“ä½œã€‚ å®é™…ä¸Šï¼Œziplistå……åˆ†ä½“ç°äº†Rediså¯¹äºå­˜å‚¨æ•ˆç‡çš„è¿½æ±‚ã€‚ä¸€ä¸ªæ™®é€šçš„åŒå‘é“¾è¡¨ï¼Œé“¾è¡¨ä¸­æ¯ä¸€é¡¹éƒ½å ç”¨ç‹¬ç«‹çš„ä¸€å—å†…å­˜ï¼Œå„é¡¹ä¹‹é—´ç”¨åœ°å€æŒ‡é’ˆï¼ˆæˆ–å¼•ç”¨ï¼‰è¿æ¥èµ·æ¥ã€‚è¿™ç§æ–¹å¼ä¼šå¸¦æ¥å¤§é‡çš„å†…å­˜ç¢ç‰‡ï¼Œè€Œä¸”åœ°å€æŒ‡é’ˆä¹Ÿä¼šå ç”¨é¢å¤–çš„å†…å­˜ã€‚è€Œziplistå´æ˜¯å°†è¡¨ä¸­æ¯ä¸€é¡¹å­˜æ”¾åœ¨å‰åè¿ç»­çš„åœ°å€ç©ºé—´å†…ï¼Œä¸€ä¸ªziplistæ•´ä½“å ç”¨ä¸€å¤§å—å†…å­˜ã€‚å®ƒæ˜¯ä¸€ä¸ªè¡¨ï¼ˆlistï¼‰ï¼Œä½†å…¶å®ä¸æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼ˆlinked listï¼‰ã€‚ å¦å¤–ï¼Œziplistä¸ºäº†åœ¨ç»†èŠ‚ä¸ŠèŠ‚çœå†…å­˜ï¼Œå¯¹äºå€¼çš„å­˜å‚¨é‡‡ç”¨äº†å˜é•¿çš„ç¼–ç æ–¹å¼ï¼Œå¤§æ¦‚æ„æ€æ˜¯è¯´ï¼Œå¯¹äºå¤§çš„æ•´æ•°ï¼Œå°±å¤šç”¨ä¸€äº›å­—èŠ‚æ¥å­˜å‚¨ï¼Œè€Œå¯¹äºå°çš„æ•´æ•°ï¼Œå°±å°‘ç”¨ä¸€äº›å­—èŠ‚æ¥å­˜å‚¨ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å¾ˆå¿«å°±ä¼šè®¨è®ºåˆ°è¿™äº›å®ç°ç»†èŠ‚ã€‚ ziplistçš„æ•°æ®ç»“æ„å®šä¹‰ziplistçš„æ•°æ®ç»“æ„ç»„æˆæ˜¯æœ¬æ–‡è¦è®¨è®ºçš„é‡ç‚¹ã€‚å®é™…ä¸Šï¼Œziplistè¿˜æ˜¯ç¨å¾®æœ‰ç‚¹å¤æ‚çš„ï¼Œå®ƒå¤æ‚çš„åœ°æ–¹å°±åœ¨äºå®ƒçš„æ•°æ®ç»“æ„å®šä¹‰ã€‚ä¸€æ—¦ç†è§£äº†æ•°æ®ç»“æ„ï¼Œå®ƒçš„ä¸€äº›æ“ä½œä¹Ÿå°±æ¯”è¾ƒå®¹æ˜“ç†è§£äº†ã€‚ æˆ‘ä»¬æ¥ä¸‹æ¥å…ˆä»æ€»ä½“ä¸Šä»‹ç»ä¸€ä¸‹ziplistçš„æ•°æ®ç»“æ„å®šä¹‰ï¼Œç„¶åä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œé€šè¿‡ä¾‹å­æ¥è§£é‡Šziplistçš„æ„æˆã€‚å¦‚æœä½ çœ‹æ‡‚äº†è¿™ä¸€éƒ¨åˆ†ï¼Œæœ¬æ–‡çš„ä»»åŠ¡å°±ç®—å®Œæˆäº†ä¸€å¤§åŠäº†ã€‚ ä»å®è§‚ä¸Šçœ‹ï¼Œziplistçš„å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š â€¦ å„ä¸ªéƒ¨åˆ†åœ¨å†…å­˜ä¸Šæ˜¯å‰åç›¸é‚»çš„ï¼Œå®ƒä»¬åˆ†åˆ«çš„å«ä¹‰å¦‚ä¸‹ï¼š : 32bitï¼Œè¡¨ç¤ºziplistå ç”¨çš„å­—èŠ‚æ€»æ•°ï¼ˆä¹ŸåŒ…æ‹¬æœ¬èº«å ç”¨çš„4ä¸ªå­—èŠ‚ï¼‰ã€‚: 32bitï¼Œè¡¨ç¤ºziplistè¡¨ä¸­æœ€åä¸€é¡¹ï¼ˆentryï¼‰åœ¨ziplistä¸­çš„åç§»å­—èŠ‚æ•°ã€‚çš„å­˜åœ¨ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰¾åˆ°æœ€åä¸€é¡¹ï¼ˆä¸ç”¨éå†æ•´ä¸ªziplistï¼‰ï¼Œä»è€Œå¯ä»¥åœ¨ziplistå°¾ç«¯å¿«é€Ÿåœ°æ‰§è¡Œpushæˆ–popæ“ä½œã€‚: 16bitï¼Œ è¡¨ç¤ºziplistä¸­æ•°æ®é¡¹ï¼ˆentryï¼‰çš„ä¸ªæ•°ã€‚zllenå­—æ®µå› ä¸ºåªæœ‰16bitï¼Œæ‰€ä»¥å¯ä»¥è¡¨è¾¾çš„æœ€å¤§å€¼ä¸º2^16-1ã€‚è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœziplistä¸­æ•°æ®é¡¹ä¸ªæ•°è¶…è¿‡äº†16bitèƒ½è¡¨è¾¾çš„æœ€å¤§å€¼ï¼Œziplistä»ç„¶å¯ä»¥æ¥è¡¨ç¤ºã€‚é‚£æ€ä¹ˆè¡¨ç¤ºå‘¢ï¼Ÿè¿™é‡Œåšäº†è¿™æ ·çš„è§„å®šï¼šå¦‚æœå°äºç­‰äº2^16-2ï¼ˆä¹Ÿå°±æ˜¯ä¸ç­‰äº2^16-1ï¼‰ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºziplistä¸­æ•°æ®é¡¹çš„ä¸ªæ•°ï¼›å¦åˆ™ï¼Œä¹Ÿå°±æ˜¯ç­‰äº16bitå…¨ä¸º1çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±ä¸è¡¨ç¤ºæ•°æ®é¡¹ä¸ªæ•°äº†ï¼Œè¿™æ—¶å€™è¦æƒ³çŸ¥é“ziplistä¸­æ•°æ®é¡¹æ€»æ•°ï¼Œé‚£ä¹ˆå¿…é¡»å¯¹ziplistä»å¤´åˆ°å°¾éå†å„ä¸ªæ•°æ®é¡¹ï¼Œæ‰èƒ½è®¡æ•°å‡ºæ¥ã€‚: è¡¨ç¤ºçœŸæ­£å­˜æ”¾æ•°æ®çš„æ•°æ®é¡¹ï¼Œé•¿åº¦ä¸å®šã€‚ä¸€ä¸ªæ•°æ®é¡¹ï¼ˆentryï¼‰ä¹Ÿæœ‰å®ƒè‡ªå·±çš„å†…éƒ¨ç»“æ„ï¼Œè¿™ä¸ªç¨åå†è§£é‡Šã€‚: ziplistæœ€å1ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªç»“æŸæ ‡è®°ï¼Œå€¼å›ºå®šç­‰äº255ã€‚ä¸Šé¢çš„å®šä¹‰ä¸­è¿˜å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼š, , æ—¢ç„¶å æ®å¤šä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆåœ¨å­˜å‚¨çš„æ—¶å€™å°±æœ‰å¤§ç«¯ï¼ˆbig endianï¼‰å’Œå°ç«¯ï¼ˆlittle endianï¼‰çš„åŒºåˆ«ã€‚ziplisté‡‡å–çš„æ˜¯å°ç«¯æ¨¡å¼æ¥å­˜å‚¨ï¼Œè¿™åœ¨ä¸‹é¢æˆ‘ä»¬ä»‹ç»å…·ä½“ä¾‹å­çš„æ—¶å€™è¿˜ä¼šå†è¯¦ç»†è§£é‡Šã€‚ æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ¯ä¸€ä¸ªæ•°æ®é¡¹çš„æ„æˆï¼š æˆ‘ä»¬çœ‹åˆ°åœ¨çœŸæ­£çš„æ•°æ®ï¼ˆï¼‰å‰é¢ï¼Œè¿˜æœ‰ä¸¤ä¸ªå­—æ®µï¼š : è¡¨ç¤ºå‰ä¸€ä¸ªæ•°æ®é¡¹å ç”¨çš„æ€»å­—èŠ‚æ•°ã€‚è¿™ä¸ªå­—æ®µçš„ç”¨å¤„æ˜¯ä¸ºäº†è®©ziplistèƒ½å¤Ÿä»åå‘å‰éå†ï¼ˆä»åä¸€é¡¹çš„ä½ç½®ï¼Œåªéœ€å‘å‰åç§»prevrawlenä¸ªå­—èŠ‚ï¼Œå°±æ‰¾åˆ°äº†å‰ä¸€é¡¹ï¼‰ã€‚è¿™ä¸ªå­—æ®µé‡‡ç”¨å˜é•¿ç¼–ç ã€‚: è¡¨ç¤ºå½“å‰æ•°æ®é¡¹çš„æ•°æ®é•¿åº¦ï¼ˆå³éƒ¨åˆ†çš„é•¿åº¦ï¼‰ã€‚ä¹Ÿé‡‡ç”¨å˜é•¿ç¼–ç ã€‚é‚£ä¹ˆå’Œæ˜¯æ€ä¹ˆè¿›è¡Œå˜é•¿ç¼–ç çš„å‘¢ï¼Ÿå„ä½è¯»è€…æ‰“èµ·ç²¾ç¥äº†ï¼Œæˆ‘ä»¬ç»ˆäºè®²åˆ°äº†ziplistçš„å®šä¹‰ä¸­æœ€ç¹ççš„åœ°æ–¹äº†ã€‚ å…ˆè¯´ã€‚å®ƒæœ‰ä¸¤ç§å¯èƒ½ï¼Œæˆ–è€…æ˜¯1ä¸ªå­—èŠ‚ï¼Œæˆ–è€…æ˜¯5ä¸ªå­—èŠ‚ï¼š å¦‚æœå‰ä¸€ä¸ªæ•°æ®é¡¹å ç”¨å­—èŠ‚æ•°å°äº254ï¼Œé‚£ä¹ˆå°±åªç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œè¿™ä¸ªå­—èŠ‚çš„å€¼å°±æ˜¯å‰ä¸€ä¸ªæ•°æ®é¡¹çš„å ç”¨å­—èŠ‚æ•°ã€‚å¦‚æœå‰ä¸€ä¸ªæ•°æ®é¡¹å ç”¨å­—èŠ‚æ•°å¤§äºç­‰äº254ï¼Œé‚£ä¹ˆå°±ç”¨5ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œå…¶ä¸­ç¬¬1ä¸ªå­—èŠ‚çš„å€¼æ˜¯254ï¼ˆä½œä¸ºè¿™ç§æƒ…å†µçš„ä¸€ä¸ªæ ‡è®°ï¼‰ï¼Œè€Œåé¢4ä¸ªå­—èŠ‚ç»„æˆä¸€ä¸ªæ•´å‹å€¼ï¼Œæ¥çœŸæ­£å­˜å‚¨å‰ä¸€ä¸ªæ•°æ®é¡¹çš„å ç”¨å­—èŠ‚æ•°ã€‚æœ‰äººä¼šé—®äº†ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰255çš„æƒ…å†µå‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºï¼š255å·²ç»å®šä¹‰ä¸ºziplistç»“æŸæ ‡è®°çš„å€¼äº†ã€‚åœ¨ziplistçš„å¾ˆå¤šæ“ä½œçš„å®ç°ä¸­ï¼Œéƒ½ä¼šæ ¹æ®æ•°æ®é¡¹çš„ç¬¬1ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯255æ¥åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯åˆ°è¾¾ziplistçš„ç»“å°¾äº†ï¼Œå› æ­¤ä¸€ä¸ªæ­£å¸¸çš„æ•°æ®çš„ç¬¬1ä¸ªå­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯çš„ç¬¬1ä¸ªå­—èŠ‚ï¼‰æ˜¯ä¸èƒ½å¤Ÿå–255è¿™ä¸ªå€¼çš„ï¼Œå¦åˆ™å°±å†²çªäº†ã€‚ è€Œå­—æ®µå°±æ›´åŠ å¤æ‚äº†ï¼Œå®ƒæ ¹æ®ç¬¬1ä¸ªå­—èŠ‚çš„ä¸åŒï¼Œæ€»å…±åˆ†ä¸º9ç§æƒ…å†µï¼ˆä¸‹é¢çš„è¡¨ç¤ºæ³•æ˜¯æŒ‰äºŒè¿›åˆ¶è¡¨ç¤ºï¼‰ï¼š |00pppppp| - 1 byteã€‚ç¬¬1ä¸ªå­—èŠ‚æœ€é«˜ä¸¤ä¸ªbitæ˜¯00ï¼Œé‚£ä¹ˆå­—æ®µåªæœ‰1ä¸ªå­—èŠ‚ï¼Œå‰©ä½™çš„6ä¸ªbitç”¨æ¥è¡¨ç¤ºé•¿åº¦å€¼ï¼Œæœ€é«˜å¯ä»¥è¡¨ç¤º63 (2^6-1)ã€‚|01pppppp|qqqqqqqq| - 2 bytesã€‚ç¬¬1ä¸ªå­—èŠ‚æœ€é«˜ä¸¤ä¸ªbitæ˜¯01ï¼Œé‚£ä¹ˆå­—æ®µå 2ä¸ªå­—èŠ‚ï¼Œæ€»å…±æœ‰14ä¸ªbitç”¨æ¥è¡¨ç¤ºé•¿åº¦å€¼ï¼Œæœ€é«˜å¯ä»¥è¡¨ç¤º16383 (2^14-1)ã€‚|10__|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 bytesã€‚ç¬¬1ä¸ªå­—èŠ‚æœ€é«˜ä¸¤ä¸ªbitæ˜¯10ï¼Œé‚£ä¹ˆlenå­—æ®µå 5ä¸ªå­—èŠ‚ï¼Œæ€»å…±ä½¿ç”¨32ä¸ªbitæ¥è¡¨ç¤ºé•¿åº¦å€¼ï¼ˆ6ä¸ªbitèˆå¼ƒä¸ç”¨ï¼‰ï¼Œæœ€é«˜å¯ä»¥è¡¨ç¤º2^32-1ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨å‰ä¸‰ç§æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯æŒ‰å­—ç¬¦ä¸²æ¥å­˜å‚¨çš„ï¼›ä»ä¸‹é¢ç¬¬4ç§æƒ…å†µå¼€å§‹ï¼Œå¼€å§‹å˜ä¸ºæŒ‰æ•´æ•°æ¥å­˜å‚¨äº†ã€‚|11000000| - 1 byteã€‚å­—æ®µå ç”¨1ä¸ªå­—èŠ‚ï¼Œå€¼ä¸º0xC0ï¼Œåé¢çš„æ•°æ®å­˜å‚¨ä¸º2ä¸ªå­—èŠ‚çš„int16_tç±»å‹ã€‚|11010000| - 1 byteã€‚å­—æ®µå ç”¨1ä¸ªå­—èŠ‚ï¼Œå€¼ä¸º0xD0ï¼Œåé¢çš„æ•°æ®å­˜å‚¨ä¸º4ä¸ªå­—èŠ‚çš„int32_tç±»å‹ã€‚|11100000| - 1 byteã€‚å­—æ®µå ç”¨1ä¸ªå­—èŠ‚ï¼Œå€¼ä¸º0xE0ï¼Œåé¢çš„æ•°æ®å­˜å‚¨ä¸º8ä¸ªå­—èŠ‚çš„int64_tç±»å‹ã€‚|11110000| - 1 byteã€‚å­—æ®µå ç”¨1ä¸ªå­—èŠ‚ï¼Œå€¼ä¸º0xF0ï¼Œåé¢çš„æ•°æ®å­˜å‚¨ä¸º3ä¸ªå­—èŠ‚é•¿çš„æ•´æ•°ã€‚|11111110| - 1 byteã€‚å­—æ®µå ç”¨1ä¸ªå­—èŠ‚ï¼Œå€¼ä¸º0xFEï¼Œåé¢çš„æ•°æ®å­˜å‚¨ä¸º1ä¸ªå­—èŠ‚çš„æ•´æ•°ã€‚|1111xxxx| - - (xxxxçš„å€¼åœ¨0001å’Œ1101ä¹‹é—´)ã€‚è¿™æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œxxxxä»1åˆ°13ä¸€å…±13ä¸ªå€¼ï¼Œè¿™æ—¶å°±ç”¨è¿™13ä¸ªå€¼æ¥è¡¨ç¤ºçœŸæ­£çš„æ•°æ®ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ˜¯è¡¨ç¤ºçœŸæ­£çš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ•°æ®é•¿åº¦äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåé¢ä¸å†éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å­—æ®µæ¥è¡¨ç¤ºçœŸæ­£çš„æ•°æ®äº†ï¼Œè€Œæ˜¯å’ŒåˆäºŒä¸ºä¸€äº†ã€‚å¦å¤–ï¼Œç”±äºxxxxåªèƒ½å–0001å’Œ1101è¿™13ä¸ªå€¼äº†ï¼ˆå…¶å®ƒå¯èƒ½çš„å€¼å’Œå…¶å®ƒæƒ…å†µå†²çªäº†ï¼Œæ¯”å¦‚0000å’Œ1110åˆ†åˆ«åŒå‰é¢ç¬¬7ç§ç¬¬8ç§æƒ…å†µå†²çªï¼Œ1111è·Ÿç»“æŸæ ‡è®°å†²çªï¼‰ï¼Œè€Œå°æ•°å€¼åº”è¯¥ä»0å¼€å§‹ï¼Œå› æ­¤è¿™13ä¸ªå€¼åˆ†åˆ«è¡¨ç¤º0åˆ°12ï¼Œå³xxxxçš„å€¼å‡å»1æ‰æ˜¯å®ƒæ‰€è¦è¡¨ç¤ºçš„é‚£ä¸ªæ•´æ•°æ•°æ®çš„å€¼ã€‚å¥½äº†ï¼Œziplistçš„æ•°æ®ç»“æ„å®šä¹‰ï¼Œæˆ‘ä»¬ä»‹ç»å®Œäº†ï¼Œç°åœ¨æˆ‘ä»¬çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚ ä¸Šå›¾æ˜¯ä¸€ä»½çœŸå®çš„ziplistæ•°æ®ã€‚æˆ‘ä»¬é€é¡¹è§£è¯»ä¸€ä¸‹ï¼š è¿™ä¸ªziplistä¸€å…±åŒ…å«33ä¸ªå­—èŠ‚ã€‚å­—èŠ‚ç¼–å·ä»byte[0]åˆ°byte[32]ã€‚å›¾ä¸­æ¯ä¸ªå­—èŠ‚çš„å€¼ä½¿ç”¨16è¿›åˆ¶è¡¨ç¤ºã€‚å¤´4ä¸ªå­—èŠ‚ï¼ˆ0x21000000ï¼‰æ˜¯æŒ‰å°ç«¯ï¼ˆlittle endianï¼‰æ¨¡å¼å­˜å‚¨çš„å­—æ®µã€‚ä»€ä¹ˆæ˜¯å°ç«¯å‘¢ï¼Ÿå°±æ˜¯æŒ‡æ•°æ®çš„ä½å­—èŠ‚ä¿å­˜åœ¨å†…å­˜çš„ä½åœ°å€ä¸­ï¼ˆå‚è§ç»´åŸºç™¾ç§‘è¯æ¡Endiannessï¼‰ã€‚å› æ­¤ï¼Œè¿™é‡Œçš„å€¼åº”è¯¥è§£ææˆ0x00000021ï¼Œç”¨åè¿›åˆ¶è¡¨ç¤ºæ­£å¥½å°±æ˜¯33ã€‚æ¥ä¸‹æ¥4ä¸ªå­—èŠ‚ï¼ˆbyte[4..7]ï¼‰æ˜¯ï¼Œç”¨å°ç«¯å­˜å‚¨æ¨¡å¼æ¥è§£é‡Šï¼Œå®ƒçš„å€¼æ˜¯0x0000001Dï¼ˆå€¼ä¸º29ï¼‰ï¼Œè¡¨ç¤ºæœ€åä¸€ä¸ªæ•°æ®é¡¹åœ¨byte[29]çš„ä½ç½®ï¼ˆé‚£ä¸ªæ•°æ®é¡¹ä¸º0x05FE14ï¼‰ã€‚å†æ¥ä¸‹æ¥2ä¸ªå­—èŠ‚ï¼ˆbyte[8..9]ï¼‰ï¼Œå€¼ä¸º0x0004ï¼Œè¡¨ç¤ºè¿™ä¸ªziplisté‡Œä¸€å…±å­˜æœ‰4é¡¹æ•°æ®ã€‚æ¥ä¸‹æ¥6ä¸ªå­—èŠ‚ï¼ˆbyte[10..15]ï¼‰æ˜¯ç¬¬1ä¸ªæ•°æ®é¡¹ã€‚å…¶ä¸­ï¼Œprevrawlen=0ï¼Œå› ä¸ºå®ƒå‰é¢æ²¡æœ‰æ•°æ®é¡¹ï¼›len=4ï¼Œç›¸å½“äºå‰é¢å®šä¹‰çš„9ç§æƒ…å†µä¸­çš„ç¬¬1ç§ï¼Œè¡¨ç¤ºåé¢4ä¸ªå­—èŠ‚æŒ‰å­—ç¬¦ä¸²å­˜å‚¨æ•°æ®ï¼Œæ•°æ®çš„å€¼ä¸ºâ€nameâ€ã€‚æ¥ä¸‹æ¥8ä¸ªå­—èŠ‚ï¼ˆbyte[16..23]ï¼‰æ˜¯ç¬¬2ä¸ªæ•°æ®é¡¹ï¼Œä¸å‰é¢æ•°æ®é¡¹å­˜å‚¨æ ¼å¼ç±»ä¼¼ï¼Œå­˜å‚¨1ä¸ªå­—ç¬¦ä¸²â€tieleiâ€ã€‚æ¥ä¸‹æ¥5ä¸ªå­—èŠ‚ï¼ˆbyte[24..28]ï¼‰æ˜¯ç¬¬3ä¸ªæ•°æ®é¡¹ï¼Œä¸å‰é¢æ•°æ®é¡¹å­˜å‚¨æ ¼å¼ç±»ä¼¼ï¼Œå­˜å‚¨1ä¸ªå­—ç¬¦ä¸²â€ageâ€ã€‚æ¥ä¸‹æ¥3ä¸ªå­—èŠ‚ï¼ˆbyte[29..31]ï¼‰æ˜¯æœ€åä¸€ä¸ªæ•°æ®é¡¹ï¼Œå®ƒçš„æ ¼å¼ä¸å‰é¢çš„æ•°æ®é¡¹å­˜å‚¨æ ¼å¼ä¸å¤ªä¸€æ ·ã€‚å…¶ä¸­ï¼Œç¬¬1ä¸ªå­—èŠ‚prevrawlen=5ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªæ•°æ®é¡¹å ç”¨5ä¸ªå­—èŠ‚ï¼›ç¬¬2ä¸ªå­—èŠ‚=FEï¼Œç›¸å½“äºå‰é¢å®šä¹‰çš„9ç§æƒ…å†µä¸­çš„ç¬¬8ç§ï¼Œæ‰€ä»¥åé¢è¿˜æœ‰1ä¸ªå­—èŠ‚ç”¨æ¥è¡¨ç¤ºçœŸæ­£çš„æ•°æ®ï¼Œå¹¶ä¸”ä»¥æ•´æ•°è¡¨ç¤ºã€‚å®ƒçš„å€¼æ˜¯20ï¼ˆ0x14ï¼‰ã€‚æœ€å1ä¸ªå­—èŠ‚ï¼ˆbyte[32]ï¼‰è¡¨ç¤ºï¼Œæ˜¯å›ºå®šçš„å€¼255ï¼ˆ0xFFï¼‰ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œè¿™ä¸ªziplisté‡Œå­˜äº†4ä¸ªæ•°æ®é¡¹ï¼Œåˆ†åˆ«ä¸ºï¼š å­—ç¬¦ä¸²: â€œnameâ€å­—ç¬¦ä¸²: â€œtieleiâ€å­—ç¬¦ä¸²: â€œageâ€æ•´æ•°: 20ï¼ˆå¥½å§ï¼Œè¢«ä½ å‘ç°äº†~~tieleiå®é™…ä¸Šå½“ç„¶ä¸æ˜¯20å²ï¼Œä»–å“ªæœ‰é‚£ä¹ˆå¹´è½»å•Šâ€¦â€¦ï¼‰ å®é™…ä¸Šï¼Œè¿™ä¸ªziplistæ˜¯é€šè¿‡ä¸¤ä¸ªhsetå‘½ä»¤åˆ›å»ºå‡ºæ¥çš„ã€‚è¿™ä¸ªæˆ‘ä»¬ååŠéƒ¨åˆ†ä¼šå†æåˆ°ã€‚ å¥½äº†ï¼Œæ—¢ç„¶ä½ å·²ç»é˜…è¯»åˆ°è¿™é‡Œäº†ï¼Œè¯´æ˜ä½ è¿˜æ˜¯å¾ˆæœ‰è€å¿ƒçš„ï¼ˆå…¶å®æˆ‘å†™åˆ°è¿™é‡Œä¹Ÿå·²ç»ç´¯å¾—ä¸è¡Œäº†ï¼‰ã€‚å¯ä»¥å…ˆæŠŠæœ¬æ–‡æ”¶è—ï¼Œä¼‘æ¯ä¸€ä¸‹ï¼Œå›å¤´å†çœ‹ååŠéƒ¨åˆ†ã€‚ æ¥ä¸‹æ¥æˆ‘è¦è´´ä¸€äº›ä»£ç äº†ã€‚ ziplistçš„æ¥å£æˆ‘ä»¬å…ˆä¸ç€æ€¥çœ‹å®ç°ï¼Œå…ˆæ¥æŒ‘å‡ ä¸ªziplistçš„é‡è¦çš„æ¥å£ï¼Œçœ‹çœ‹å®ƒä»¬é•¿ä»€ä¹ˆæ ·å­ï¼š 12345678910unsigned char *ziplistNew(void);unsigned char *ziplistMerge(unsigned char **first, unsigned char **second);unsigned char *ziplistPush(unsigned char *zl, unsigned char *s, unsigned int slen, int where);unsigned char *ziplistIndex(unsigned char *zl, int index);unsigned char *ziplistNext(unsigned char *zl, unsigned char *p);unsigned char *ziplistPrev(unsigned char *zl, unsigned char *p);unsigned char *ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen);unsigned char *ziplistDelete(unsigned char *zl, unsigned char **p);unsigned char *ziplistFind(unsigned char *p, unsigned char *vstr, unsigned int vlen, unsigned int skip);unsigned int ziplistLen(unsigned char *zl); æˆ‘ä»¬ä»è¿™äº›æ¥å£çš„åå­—å°±å¯ä»¥ç²—ç•¥çŒœå‡ºå®ƒä»¬çš„åŠŸèƒ½ï¼Œä¸‹é¢ç®€å•è§£é‡Šä¸€ä¸‹ï¼š ziplistçš„æ•°æ®ç±»å‹ï¼Œæ²¡æœ‰ç”¨è‡ªå®šä¹‰çš„structä¹‹ç±»çš„æ¥è¡¨è¾¾ï¼Œè€Œå°±æ˜¯ç®€å•çš„unsigned char *ã€‚è¿™æ˜¯å› ä¸ºziplistæœ¬è´¨ä¸Šå°±æ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼Œå†…éƒ¨ç»„æˆç»“æ„åˆæ˜¯ä¸€ä¸ªé«˜åº¦åŠ¨æ€çš„è®¾è®¡ï¼ˆå˜é•¿ç¼–ç ï¼‰ï¼Œä¹Ÿæ²¡æ³•ç”¨ä¸€ä¸ªå›ºå®šçš„æ•°æ®ç»“æ„æ¥è¡¨è¾¾ã€‚ziplistNew: åˆ›å»ºä¸€ä¸ªç©ºçš„ziplistï¼ˆåªåŒ…å«ï¼‰ã€‚ziplistMerge: å°†ä¸¤ä¸ªzipliståˆå¹¶æˆä¸€ä¸ªæ–°çš„ziplistã€‚ziplistPush: åœ¨ziplistçš„å¤´éƒ¨æˆ–å°¾ç«¯æ’å…¥ä¸€æ®µæ•°æ®ï¼ˆäº§ç”Ÿä¸€ä¸ªæ–°çš„æ•°æ®é¡¹ï¼‰ã€‚æ³¨æ„ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„è¿”å›å€¼ï¼Œæ˜¯ä¸€ä¸ªæ–°çš„ziplistã€‚è°ƒç”¨æ–¹å¿…é¡»ç”¨è¿™é‡Œè¿”å›çš„æ–°çš„ziplistï¼Œæ›¿æ¢ä¹‹å‰ä¼ è¿›æ¥çš„æ—§çš„ziplistå˜é‡ï¼Œè€Œç»è¿‡è¿™ä¸ªå‡½æ•°å¤„ç†ä¹‹åï¼ŒåŸæ¥æ—§çš„ziplistå˜é‡å°±å¤±æ•ˆäº†ã€‚ä¸ºä»€ä¹ˆä¸€ä¸ªç®€å•çš„æ’å…¥æ“ä½œä¼šå¯¼è‡´äº§ç”Ÿä¸€ä¸ªæ–°çš„ziplistå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºziplistæ˜¯ä¸€å—è¿ç»­ç©ºé—´ï¼Œå¯¹å®ƒçš„è¿½åŠ æ“ä½œï¼Œä¼šå¼•å‘å†…å­˜çš„reallocï¼Œå› æ­¤ziplistçš„å†…å­˜ä½ç½®å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰ä»‹ç»sdsçš„æ–‡ç« ä¸­æåˆ°è¿‡ç±»ä¼¼è¿™ç§æ¥å£ä½¿ç”¨æ¨¡å¼ï¼ˆå‚è§sdscatlenå‡½æ•°çš„è¯´æ˜ï¼‰ã€‚ziplistIndex: è¿”å›indexå‚æ•°æŒ‡å®šçš„æ•°æ®é¡¹çš„å†…å­˜ä½ç½®ã€‚indexå¯ä»¥æ˜¯è´Ÿæ•°ï¼Œè¡¨ç¤ºä»å°¾ç«¯å‘å‰è¿›è¡Œç´¢å¼•ã€‚ziplistNextå’ŒziplistPrevåˆ†åˆ«è¿”å›ä¸€ä¸ªziplistä¸­æŒ‡å®šæ•°æ®é¡¹pçš„åä¸€é¡¹å’Œå‰ä¸€é¡¹ã€‚ziplistInsert: åœ¨ziplistçš„ä»»æ„æ•°æ®é¡¹å‰é¢æ’å…¥ä¸€ä¸ªæ–°çš„æ•°æ®é¡¹ã€‚ziplistDelete: åˆ é™¤æŒ‡å®šçš„æ•°æ®é¡¹ã€‚ziplistFind: æŸ¥æ‰¾ç»™å®šçš„æ•°æ®ï¼ˆç”±vstrå’ŒvlenæŒ‡å®šï¼‰ã€‚æ³¨æ„å®ƒæœ‰ä¸€ä¸ªskipå‚æ•°ï¼Œè¡¨ç¤ºæŸ¥æ‰¾çš„æ—¶å€™æ¯æ¬¡æ¯”è¾ƒä¹‹é—´è¦è·³è¿‡å‡ ä¸ªæ•°æ®é¡¹ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªå‚æ•°å‘¢ï¼Ÿå…¶å®è¿™ä¸ªå‚æ•°çš„ä¸»è¦ç”¨é€”æ˜¯å½“ç”¨ziplistè¡¨ç¤ºhashç»“æ„çš„æ—¶å€™ï¼Œæ˜¯æŒ‰ç…§ä¸€ä¸ªfieldï¼Œä¸€ä¸ªvalueæ¥ä¾æ¬¡å­˜å…¥ziplistçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¶æ•°ç´¢å¼•çš„æ•°æ®é¡¹å­˜fieldï¼Œå¥‡æ•°ç´¢å¼•çš„æ•°æ®é¡¹å­˜valueã€‚å½“æŒ‰ç…§fieldçš„å€¼è¿›è¡ŒæŸ¥æ‰¾çš„æ—¶å€™ï¼Œå°±éœ€è¦æŠŠå¥‡æ•°é¡¹è·³è¿‡å»ã€‚ziplistLen: è®¡ç®—ziplistçš„é•¿åº¦ï¼ˆå³åŒ…å«æ•°æ®é¡¹çš„ä¸ªæ•°ï¼‰ã€‚ziplistçš„æ’å…¥é€»è¾‘è§£æziplistçš„ç›¸å…³æ¥å£çš„å…·ä½“å®ç°ï¼Œè¿˜æ˜¯æœ‰äº›å¤æ‚çš„ï¼Œé™äºç¯‡å¹…çš„åŸå› ï¼Œæˆ‘ä»¬è¿™é‡Œåªç»“åˆä»£ç æ¥è®²è§£æ’å…¥çš„é€»è¾‘ã€‚æ’å…¥æ˜¯å¾ˆæœ‰ä»£è¡¨æ€§çš„æ“ä½œï¼Œé€šè¿‡è¿™éƒ¨åˆ†æ¥ä¸€çª¥ziplistå†…éƒ¨çš„å®ç°ï¼Œå…¶å®ƒéƒ¨åˆ†çš„å®ç°æˆ‘ä»¬ä¹Ÿå°±ä¼šå¾ˆå®¹æ˜“ç†è§£äº†ã€‚ ziplistPushå’ŒziplistInsertéƒ½æ˜¯æ’å…¥ï¼Œåªæ˜¯å¯¹äºæ’å…¥ä½ç½®çš„é™å®šä¸åŒã€‚å®ƒä»¬åœ¨å†…éƒ¨å®ç°éƒ½ä¾èµ–ä¸€ä¸ªåä¸º__ziplistInsertçš„å†…éƒ¨å‡½æ•°ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼ˆå‡ºè‡ªziplist.cï¼‰: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889static unsigned char *__ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen) &#123;size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), reqlen;unsigned int prevlensize, prevlen = 0;size_t offset;int nextdiff = 0;unsigned char encoding = 0;long long value = 123456789; /* initialized to avoid warning. Using a valuethat is easy to see if for some reasonwe use it uninitialized. */zlentry tail; /* Find out prevlen for the entry that is inserted. */ if (p[0] != ZIP_END) &#123; ZIP_DECODE_PREVLEN(p, prevlensize, prevlen); &#125; else &#123; unsigned char *ptail = ZIPLIST_ENTRY_TAIL(zl); if (ptail[0] != ZIP_END) &#123; prevlen = zipRawEntryLength(ptail); &#125; &#125; /* See if the entry can be encoded */ if (zipTryEncoding(s,slen,&amp;value,&amp;encoding)) &#123; /* &#x27;encoding&#x27; is set to the appropriate integer encoding */ reqlen = zipIntSize(encoding); &#125; else &#123; /* &#x27;encoding&#x27; is untouched, however zipEncodeLength will use the * string length to figure out how to encode it. */ reqlen = slen; &#125; /* We need space for both the length of the previous entry and * the length of the payload. */ reqlen += zipPrevEncodeLength(NULL,prevlen); reqlen += zipEncodeLength(NULL,encoding,slen); /* When the insert position is not equal to the tail, we need to * make sure that the next entry can hold this entry&#x27;s length in * its prevlen field. */ nextdiff = (p[0] != ZIP_END) ? zipPrevLenByteDiff(p,reqlen) : 0; /* Store offset because a realloc may change the address of zl. */ offset = p-zl; zl = ziplistResize(zl,curlen+reqlen+nextdiff); p = zl+offset; /* Apply memory move when necessary and update tail offset. */ if (p[0] != ZIP_END) &#123; /* Subtract one because of the ZIP_END bytes */ memmove(p+reqlen,p-nextdiff,curlen-offset-1+nextdiff); /* Encode this entry&#x27;s raw length in the next entry. */ zipPrevEncodeLength(p+reqlen,reqlen); /* Update offset for tail */ ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+reqlen); /* When the tail contains more than one entry, we need to take * &quot;nextdiff&quot; in account as well. Otherwise, a change in the * size of prevlen doesn&#x27;t have an effect on the *tail* offset. */ zipEntry(p+reqlen, &amp;tail); if (p[reqlen+tail.headersize+tail.len] != ZIP_END) &#123; ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff); &#125; &#125; else &#123; /* This element will be the new tail. */ ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(p-zl); &#125; /* When nextdiff != 0, the raw length of the next entry has changed, so * we need to cascade the update throughout the ziplist */ if (nextdiff != 0) &#123; offset = p-zl; zl = __ziplistCascadeUpdate(zl,p+reqlen); p = zl+offset; &#125; /* Write the entry */ p += zipPrevEncodeLength(p,prevlen); p += zipEncodeLength(p,encoding,slen); if (ZIP_IS_STR(encoding)) &#123; memcpy(p,s,slen); &#125; else &#123; zipSaveInteger(p,value,encoding); &#125; ZIPLIST_INCR_LENGTH(zl,1); return zl;&#125; æˆ‘ä»¬æ¥ç®€å•è§£æä¸€ä¸‹è¿™æ®µä»£ç ï¼š è¿™ä¸ªå‡½æ•°æ˜¯åœ¨æŒ‡å®šçš„ä½ç½®pæ’å…¥ä¸€æ®µæ–°çš„æ•°æ®ï¼Œå¾…æ’å…¥æ•°æ®çš„åœ°å€æŒ‡é’ˆæ˜¯sï¼Œé•¿åº¦ä¸ºslenã€‚æ’å…¥åå½¢æˆä¸€ä¸ªæ–°çš„æ•°æ®é¡¹ï¼Œå æ®åŸæ¥pçš„é…ç½®ï¼ŒåŸæ¥ä½äºpä½ç½®çš„æ•°æ®é¡¹ä»¥åŠåé¢çš„æ‰€æœ‰æ•°æ®é¡¹ï¼Œéœ€è¦ç»Ÿä¸€å‘åç§»åŠ¨ï¼Œç»™æ–°æ’å…¥çš„æ•°æ®é¡¹ç•™å‡ºç©ºé—´ã€‚å‚æ•°pæŒ‡å‘çš„æ˜¯ziplistä¸­æŸä¸€ä¸ªæ•°æ®é¡¹çš„èµ·å§‹ä½ç½®ï¼Œæˆ–è€…åœ¨å‘å°¾ç«¯æ’å…¥çš„æ—¶å€™ï¼Œå®ƒæŒ‡å‘ziplistçš„ç»“æŸæ ‡è®°ã€‚å‡½æ•°å¼€å§‹å…ˆè®¡ç®—å‡ºå¾…æ’å…¥ä½ç½®å‰ä¸€ä¸ªæ•°æ®é¡¹çš„é•¿åº¦prevlenã€‚è¿™ä¸ªé•¿åº¦è¦å­˜å…¥æ–°æ’å…¥çš„æ•°æ®é¡¹çš„å­—æ®µã€‚ç„¶åè®¡ç®—å½“å‰æ•°æ®é¡¹å ç”¨çš„æ€»å­—èŠ‚æ•°reqlenï¼Œå®ƒåŒ…å«ä¸‰éƒ¨åˆ†ï¼š, å’ŒçœŸæ­£çš„æ•°æ®ã€‚å…¶ä¸­çš„æ•°æ®éƒ¨åˆ†ä¼šé€šè¿‡è°ƒç”¨zipTryEncodingå…ˆæ¥å°è¯•è½¬æˆæ•´æ•°ã€‚ç”±äºæ’å…¥å¯¼è‡´çš„ziplistå¯¹äºå†…å­˜çš„æ–°å¢éœ€æ±‚ï¼Œé™¤äº†å¾…æ’å…¥æ•°æ®é¡¹å ç”¨çš„reqlenä¹‹å¤–ï¼Œè¿˜è¦è€ƒè™‘åŸæ¥pä½ç½®çš„æ•°æ®é¡¹ï¼ˆç°åœ¨è¦æ’åœ¨å¾…æ’å…¥æ•°æ®é¡¹ä¹‹åï¼‰çš„å­—æ®µçš„å˜åŒ–ã€‚æœ¬æ¥å®ƒä¿å­˜çš„æ˜¯å‰ä¸€é¡¹çš„æ€»é•¿åº¦ï¼Œç°åœ¨å˜æˆäº†ä¿å­˜å½“å‰æ’å…¥çš„æ•°æ®é¡¹çš„æ€»é•¿åº¦ã€‚è¿™æ ·å®ƒçš„å­—æ®µæœ¬èº«éœ€è¦çš„å­˜å‚¨ç©ºé—´ä¹Ÿå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸ªå˜åŒ–å¯èƒ½æ˜¯å˜å¤§ä¹Ÿå¯èƒ½æ˜¯å˜å°ã€‚è¿™ä¸ªå˜åŒ–äº†å¤šå°‘çš„å€¼nextdiffï¼Œæ˜¯è°ƒç”¨zipPrevLenByteDiffè®¡ç®—å‡ºæ¥çš„ã€‚å¦‚æœå˜å¤§äº†ï¼Œnextdiffæ˜¯æ­£å€¼ï¼Œå¦åˆ™æ˜¯è´Ÿå€¼ã€‚ç°åœ¨å¾ˆå®¹æ˜“ç®—å‡ºæ¥æ’å…¥åæ–°çš„ziplistéœ€è¦å¤šå°‘å­—èŠ‚äº†ï¼Œç„¶åè°ƒç”¨ziplistResizeæ¥é‡æ–°è°ƒæ•´å¤§å°ã€‚ziplistResizeçš„å®ç°é‡Œä¼šè°ƒç”¨allocatorçš„zreallocï¼Œå®ƒæœ‰å¯èƒ½ä¼šé€ æˆæ•°æ®æ‹·è´ã€‚ç°åœ¨é¢å¤–çš„ç©ºé—´æœ‰äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å°†åŸæ¥pä½ç½®çš„æ•°æ®é¡¹ä»¥åŠåé¢çš„æ‰€æœ‰æ•°æ®éƒ½å‘åæŒªåŠ¨ï¼Œå¹¶ä¸ºå®ƒè®¾ç½®æ–°çš„å­—æ®µã€‚æ­¤å¤–ï¼Œè¿˜å¯èƒ½éœ€è¦è°ƒæ•´ziplistçš„å­—æ®µã€‚æœ€åï¼Œç»„è£…æ–°çš„å¾…æ’å…¥æ•°æ®é¡¹ï¼Œæ”¾åœ¨ä½ç½®pã€‚hashä¸ziplisthashæ˜¯Redisä¸­å¯ä»¥ç”¨æ¥å­˜å‚¨ä¸€ä¸ªå¯¹è±¡ç»“æ„çš„æ¯”è¾ƒç†æƒ³çš„æ•°æ®ç±»å‹ã€‚ä¸€ä¸ªå¯¹è±¡çš„å„ä¸ªå±æ€§ï¼Œæ­£å¥½å¯¹åº”ä¸€ä¸ªhashç»“æ„çš„å„ä¸ªfieldã€‚ æˆ‘ä»¬åœ¨ç½‘ä¸Šå¾ˆå®¹æ˜“æ‰¾åˆ°è¿™æ ·ä¸€äº›æŠ€æœ¯æ–‡ç« ï¼Œå®ƒä»¬ä¼šè¯´å­˜å‚¨ä¸€ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨hashæ¯”stringè¦èŠ‚çœå†…å­˜ã€‚å®é™…ä¸Šè¿™ä¹ˆè¯´æ˜¯æœ‰å‰æçš„ï¼Œå…·ä½“å–å†³äºå¯¹è±¡æ€ä¹ˆæ¥å­˜å‚¨ã€‚å¦‚æœä½ æŠŠå¯¹è±¡çš„å¤šä¸ªå±æ€§å­˜å‚¨åˆ°å¤šä¸ªkeyä¸Šï¼ˆå„ä¸ªå±æ€§å€¼å­˜æˆstringï¼‰ï¼Œå½“ç„¶å çš„å†…å­˜è¦å¤šã€‚ä½†å¦‚æœä½ é‡‡ç”¨ä¸€äº›åºåˆ—åŒ–æ–¹æ³•ï¼Œæ¯”å¦‚Protocol Buffersï¼Œæˆ–è€…Apache Thriftï¼Œå…ˆæŠŠå¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç„¶åå†å­˜å…¥åˆ°Redisçš„stringä¸­ï¼Œé‚£ä¹ˆè·Ÿhashç›¸æ¯”ï¼Œå“ªä¸€ç§æ›´çœå†…å­˜ï¼Œå°±ä¸ä¸€å®šäº†ã€‚ å½“ç„¶ï¼Œhashæ¯”åºåˆ—åŒ–åå†å­˜å…¥stringçš„æ–¹å¼ï¼Œåœ¨æ”¯æŒçš„æ“ä½œå‘½ä»¤ä¸Šï¼Œè¿˜æ˜¯æœ‰ä¼˜åŠ¿çš„ï¼šå®ƒæ—¢æ”¯æŒå¤šä¸ªfieldåŒæ—¶å­˜å–ï¼ˆhmset/hmgetï¼‰ï¼Œä¹Ÿæ”¯æŒæŒ‰ç…§æŸä¸ªç‰¹å®šçš„fieldå•ç‹¬å­˜å–ï¼ˆhset/hgetï¼‰ã€‚ å®é™…ä¸Šï¼Œhashéšç€æ•°æ®çš„å¢å¤§ï¼Œå…¶åº•å±‚æ•°æ®ç»“æ„çš„å®ç°æ˜¯ä¼šå‘ç”Ÿå˜åŒ–çš„ï¼Œå½“ç„¶å­˜å‚¨æ•ˆç‡ä¹Ÿå°±ä¸åŒã€‚åœ¨fieldæ¯”è¾ƒå°‘ï¼Œå„ä¸ªvalueå€¼ä¹Ÿæ¯”è¾ƒå°çš„æ—¶å€™ï¼Œhashé‡‡ç”¨ziplistæ¥å®ç°ï¼›è€Œéšç€fieldå¢å¤šå’Œvalueå€¼å¢å¤§ï¼Œhashå¯èƒ½ä¼šå˜æˆdictæ¥å®ç°ã€‚å½“hashåº•å±‚å˜æˆdictæ¥å®ç°çš„æ—¶å€™ï¼Œå®ƒçš„å­˜å‚¨æ•ˆç‡å°±æ²¡æ³•è·Ÿé‚£äº›åºåˆ—åŒ–æ–¹å¼ç›¸æ¯”äº†ã€‚ å½“æˆ‘ä»¬ä¸ºæŸä¸ªkeyç¬¬ä¸€æ¬¡æ‰§è¡Œ hset key field value å‘½ä»¤çš„æ—¶å€™ï¼ŒRedisä¼šåˆ›å»ºä¸€ä¸ªhashç»“æ„ï¼Œè¿™ä¸ªæ–°åˆ›å»ºçš„hashåº•å±‚å°±æ˜¯ä¸€ä¸ªziplistã€‚ 123456robj *createHashObject(void) &#123;unsigned char *zl = ziplistNew();robj *o = createObject(OBJ_HASH, zl);o-&gt;encoding = OBJ_ENCODING_ZIPLIST;return o;&#125; ä¸Šé¢çš„createHashObjectå‡½æ•°ï¼Œå‡ºè‡ªobject.cï¼Œå®ƒè´Ÿè´£çš„ä»»åŠ¡å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„hashç»“æ„ã€‚å¯ä»¥çœ‹å‡ºï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªtype = OBJ_HASHä½†encoding = OBJ_ENCODING_ZIPLISTçš„robjå¯¹è±¡ã€‚ å®é™…ä¸Šï¼Œæœ¬æ–‡å‰é¢ç»™å‡ºçš„é‚£ä¸ªziplistå®ä¾‹ï¼Œå°±æ˜¯ç”±å¦‚ä¸‹ä¸¤ä¸ªå‘½ä»¤æ„å»ºå‡ºæ¥çš„ã€‚ 12hset user:100 name tieleihset user:100 age 20 æ¯æ‰§è¡Œä¸€æ¬¡hsetå‘½ä»¤ï¼Œæ’å…¥çš„fieldå’Œvalueåˆ†åˆ«ä½œä¸ºä¸€ä¸ªæ–°çš„æ•°æ®é¡¹æ’å…¥åˆ°ziplistä¸­ï¼ˆå³æ¯æ¬¡hsetäº§ç”Ÿä¸¤ä¸ªæ•°æ®é¡¹ï¼‰ã€‚ å½“éšç€æ•°æ®çš„æ’å…¥ï¼Œhashåº•å±‚çš„è¿™ä¸ªziplistå°±å¯èƒ½ä¼šè½¬æˆdictã€‚é‚£ä¹ˆåˆ°åº•æ’å…¥å¤šå°‘æ‰ä¼šè½¬å‘¢ï¼Ÿ è¿˜è®°å¾—æœ¬æ–‡å¼€å¤´æåˆ°çš„ä¸¤ä¸ªRedisé…ç½®å—ï¼Ÿ 12hash-max-ziplist-entries 512hash-max-ziplist-value 64 è¿™ä¸ªé…ç½®çš„æ„æ€æ˜¯è¯´ï¼Œåœ¨å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€æ»¡è¶³çš„æ—¶å€™ï¼Œziplistä¼šè½¬æˆdictï¼š å½“hashä¸­çš„æ•°æ®é¡¹ï¼ˆå³field-valueå¯¹ï¼‰çš„æ•°ç›®è¶…è¿‡512çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ziplistæ•°æ®é¡¹è¶…è¿‡1024çš„æ—¶å€™ï¼ˆè¯·å‚è€ƒt_hash.cä¸­çš„hashTypeSetå‡½æ•°ï¼‰ã€‚å½“hashä¸­æ’å…¥çš„ä»»æ„ä¸€ä¸ªvalueçš„é•¿åº¦è¶…è¿‡äº†64çš„æ—¶å€™ï¼ˆè¯·å‚è€ƒt_hash.cä¸­çš„hashTypeTryConversionå‡½æ•°ï¼‰ã€‚Redisçš„hashä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡ï¼Œæ˜¯å› ä¸ºå½“ziplistå˜å¾—å¾ˆå¤§çš„æ—¶å€™ï¼Œå®ƒæœ‰å¦‚ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š æ¯æ¬¡æ’å…¥æˆ–ä¿®æ”¹å¼•å‘çš„reallocæ“ä½œä¼šæœ‰æ›´å¤§çš„æ¦‚ç‡é€ æˆå†…å­˜æ‹·è´ï¼Œä»è€Œé™ä½æ€§èƒ½ã€‚ä¸€æ—¦å‘ç”Ÿå†…å­˜æ‹·è´ï¼Œå†…å­˜æ‹·è´çš„æˆæœ¬ä¹Ÿç›¸åº”å¢åŠ ï¼Œå› ä¸ºè¦æ‹·è´æ›´å¤§çš„ä¸€å—æ•°æ®ã€‚å½“ziplistæ•°æ®é¡¹è¿‡å¤šçš„æ—¶å€™ï¼Œåœ¨å®ƒä¸Šé¢æŸ¥æ‰¾æŒ‡å®šçš„æ•°æ®é¡¹å°±ä¼šæ€§èƒ½å˜å¾—å¾ˆä½ï¼Œå› ä¸ºziplistä¸Šçš„æŸ¥æ‰¾éœ€è¦è¿›è¡Œéå†ã€‚æ€»ä¹‹ï¼Œziplistæœ¬æ¥å°±è®¾è®¡ä¸ºå„ä¸ªæ•°æ®é¡¹æŒ¨åœ¨ä¸€èµ·ç»„æˆè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¿™ç§ç»“æ„å¹¶ä¸æ“…é•¿åšä¿®æ”¹æ“ä½œã€‚ä¸€æ—¦æ•°æ®å‘ç”Ÿæ”¹åŠ¨ï¼Œå°±ä¼šå¼•å‘å†…å­˜reallocï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ‹·è´ã€‚","categories":[{"name":"5.ç¼“å­˜","slug":"5-ç¼“å­˜","permalink":"https://zhangxin66666.github.io/categories/5-%E7%BC%93%E5%AD%98/"}],"tags":[{"name":"redis","slug":"redis","permalink":"https://zhangxin66666.github.io/tags/redis/"}]},{"title":"Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(5)â€”â€”quicklist","slug":"5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(5)â€”â€”quicklist","date":"2024-12-29T16:00:00.000Z","updated":"2024-12-30T06:44:20.736Z","comments":true,"path":"2024/12/30/5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(5)â€”â€”quicklist/","link":"","permalink":"https://zhangxin66666.github.io/2024/12/30/5.%E7%BC%93%E5%AD%98/Redis%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3(5)%E2%80%94%E2%80%94quicklist/","excerpt":"","text":"åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸ªRediså†…éƒ¨æ•°æ®ç»“æ„â€”â€”quicklistã€‚Rediså¯¹å¤–æš´éœ²çš„listæ•°æ®ç±»å‹ï¼Œå®ƒåº•å±‚å®ç°æ‰€ä¾èµ–çš„å†…éƒ¨æ•°æ®ç»“æ„å°±æ˜¯quicklistã€‚ æˆ‘ä»¬åœ¨è®¨è®ºä¸­è¿˜ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªRedisé…ç½®ï¼ˆåœ¨redis.confä¸­çš„ADVANCED CONFIGéƒ¨åˆ†ï¼‰ï¼š 12list-max-ziplist-size -2list-compress-depth 0 æˆ‘ä»¬åœ¨è®¨è®ºä¸­ä¼šè¯¦ç»†è§£é‡Šè¿™ä¸¤ä¸ªé…ç½®çš„å«ä¹‰ã€‚ æ³¨ï¼šæœ¬æ–‡è®¨è®ºçš„quicklistå®ç°åŸºäºRedisæºç çš„3.2åˆ†æ”¯ã€‚ quicklistæ¦‚è¿°Rediså¯¹å¤–æš´éœ²çš„ä¸Šå±‚listæ•°æ®ç±»å‹ï¼Œç»å¸¸è¢«ç”¨ä½œé˜Ÿåˆ—ä½¿ç”¨ã€‚æ¯”å¦‚å®ƒæ”¯æŒçš„å¦‚ä¸‹ä¸€äº›æ“ä½œï¼š lpush: åœ¨å·¦ä¾§ï¼ˆå³åˆ—è¡¨å¤´éƒ¨ï¼‰æ’å…¥æ•°æ®ã€‚rpop: åœ¨å³ä¾§ï¼ˆå³åˆ—è¡¨å°¾éƒ¨ï¼‰åˆ é™¤æ•°æ®ã€‚rpush: åœ¨å³ä¾§ï¼ˆå³åˆ—è¡¨å°¾éƒ¨ï¼‰æ’å…¥æ•°æ®ã€‚lpop: åœ¨å·¦ä¾§ï¼ˆå³åˆ—è¡¨å¤´éƒ¨ï¼‰åˆ é™¤æ•°æ®ã€‚è¿™äº›æ“ä½œéƒ½æ˜¯O(1)æ—¶é—´å¤æ‚åº¦çš„ã€‚ å½“ç„¶ï¼Œlistä¹Ÿæ”¯æŒåœ¨ä»»æ„ä¸­é—´ä½ç½®çš„å­˜å–æ“ä½œï¼Œæ¯”å¦‚lindexå’Œlinsertï¼Œä½†å®ƒä»¬éƒ½éœ€è¦å¯¹listè¿›è¡Œéå†ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦è¾ƒé«˜ï¼Œä¸ºO(N)ã€‚ æ¦‚å†µèµ·æ¥ï¼Œlistå…·æœ‰è¿™æ ·çš„ä¸€äº›ç‰¹ç‚¹ï¼šå®ƒæ˜¯ä¸€ä¸ªèƒ½ç»´æŒæ•°æ®é¡¹å…ˆåé¡ºåºçš„åˆ—è¡¨ï¼ˆå„ä¸ªæ•°æ®é¡¹çš„å…ˆåé¡ºåºç”±æ’å…¥ä½ç½®å†³å®šï¼‰ï¼Œä¾¿äºåœ¨è¡¨çš„ä¸¤ç«¯è¿½åŠ å’Œåˆ é™¤æ•°æ®ï¼Œè€Œå¯¹äºä¸­é—´ä½ç½®çš„å­˜å–å…·æœ‰O(N)çš„æ—¶é—´å¤æ‚åº¦ã€‚è¿™ä¸æ­£æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨æ‰€å…·æœ‰çš„ç‰¹ç‚¹å—ï¼Ÿ listçš„å†…éƒ¨å®ç°quicklistæ­£æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚åœ¨quicklist.cçš„æ–‡ä»¶å¤´éƒ¨æ³¨é‡Šä¸­ï¼Œæ˜¯è¿™æ ·æè¿°quicklistçš„ï¼š A doubly linked list of ziplists å®ƒç¡®å®æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªziplistçš„åŒå‘é“¾è¡¨ã€‚ è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ æˆ‘ä»¬çŸ¥é“ï¼ŒåŒå‘é“¾è¡¨æ˜¯ç”±å¤šä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ç»„æˆçš„ã€‚è¿™ä¸ªæè¿°çš„æ„æ€æ˜¯ï¼šquicklistçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªziplistã€‚ziplistæˆ‘ä»¬å·²ç»åœ¨ä¸Šä¸€ç¯‡ä»‹ç»è¿‡ã€‚ ziplistæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªèƒ½ç»´æŒæ•°æ®é¡¹å…ˆåé¡ºåºçš„åˆ—è¡¨ï¼ˆæŒ‰æ’å…¥ä½ç½®ï¼‰ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå†…å­˜ç´§ç¼©çš„åˆ—è¡¨ï¼ˆå„ä¸ªæ•°æ®é¡¹åœ¨å†…å­˜ä¸Šå‰åç›¸é‚»ï¼‰ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªåŒ…å«3ä¸ªèŠ‚ç‚¹çš„quicklistï¼Œå¦‚æœæ¯ä¸ªèŠ‚ç‚¹çš„zipliståˆåŒ…å«4ä¸ªæ•°æ®é¡¹ï¼Œé‚£ä¹ˆå¯¹å¤–è¡¨ç°ä¸Šï¼Œè¿™ä¸ªlistå°±æ€»å…±åŒ…å«12ä¸ªæ•°æ®é¡¹ã€‚ quicklistçš„ç»“æ„ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼Ÿæ€»ç»“èµ·æ¥ï¼Œå¤§æ¦‚åˆæ˜¯ä¸€ä¸ªç©ºé—´å’Œæ—¶é—´çš„æŠ˜ä¸­ï¼š åŒå‘é“¾è¡¨ä¾¿äºåœ¨è¡¨çš„ä¸¤ç«¯è¿›è¡Œpushå’Œpopæ“ä½œï¼Œä½†æ˜¯å®ƒçš„å†…å­˜å¼€é”€æ¯”è¾ƒå¤§ã€‚é¦–å…ˆï¼Œå®ƒåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé™¤äº†è¦ä¿å­˜æ•°æ®ä¹‹å¤–ï¼Œè¿˜è¦é¢å¤–ä¿å­˜ä¸¤ä¸ªæŒ‡é’ˆï¼›å…¶æ¬¡ï¼ŒåŒå‘é“¾è¡¨çš„å„ä¸ªèŠ‚ç‚¹æ˜¯å•ç‹¬çš„å†…å­˜å—ï¼Œåœ°å€ä¸è¿ç»­ï¼ŒèŠ‚ç‚¹å¤šäº†å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚ziplistç”±äºæ˜¯ä¸€æ•´å—è¿ç»­å†…å­˜ï¼Œæ‰€ä»¥å­˜å‚¨æ•ˆç‡å¾ˆé«˜ã€‚ä½†æ˜¯ï¼Œå®ƒä¸åˆ©äºä¿®æ”¹æ“ä½œï¼Œæ¯æ¬¡æ•°æ®å˜åŠ¨éƒ½ä¼šå¼•å‘ä¸€æ¬¡å†…å­˜çš„reallocã€‚ç‰¹åˆ«æ˜¯å½“ziplisté•¿åº¦å¾ˆé•¿çš„æ—¶å€™ï¼Œä¸€æ¬¡reallocå¯èƒ½ä¼šå¯¼è‡´å¤§æ‰¹é‡çš„æ•°æ®æ‹·è´ï¼Œè¿›ä¸€æ­¥é™ä½æ€§èƒ½ã€‚äºæ˜¯ï¼Œç»“åˆäº†åŒå‘é“¾è¡¨å’Œziplistçš„ä¼˜ç‚¹ï¼Œquicklistå°±åº”è¿è€Œç”Ÿäº†ã€‚ ä¸è¿‡ï¼Œè¿™ä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªæ–°é—®é¢˜ï¼šåˆ°åº•ä¸€ä¸ªquicklistèŠ‚ç‚¹åŒ…å«å¤šé•¿çš„zipliståˆé€‚å‘¢ï¼Ÿæ¯”å¦‚ï¼ŒåŒæ ·æ˜¯å­˜å‚¨12ä¸ªæ•°æ®é¡¹ï¼Œæ—¢å¯ä»¥æ˜¯ä¸€ä¸ªquickliståŒ…å«3ä¸ªèŠ‚ç‚¹ï¼Œè€Œæ¯ä¸ªèŠ‚ç‚¹çš„zipliståˆåŒ…å«4ä¸ªæ•°æ®é¡¹ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªquickliståŒ…å«6ä¸ªèŠ‚ç‚¹ï¼Œè€Œæ¯ä¸ªèŠ‚ç‚¹çš„zipliståˆåŒ…å«2ä¸ªæ•°æ®é¡¹ã€‚ è¿™åˆæ˜¯ä¸€ä¸ªéœ€è¦æ‰¾å¹³è¡¡ç‚¹çš„éš¾é¢˜ã€‚æˆ‘ä»¬åªä»å­˜å‚¨æ•ˆç‡ä¸Šåˆ†æä¸€ä¸‹ï¼š æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistè¶ŠçŸ­ï¼Œåˆ™å†…å­˜ç¢ç‰‡è¶Šå¤šã€‚å†…å­˜ç¢ç‰‡å¤šäº†ï¼Œæœ‰å¯èƒ½åœ¨å†…å­˜ä¸­äº§ç”Ÿå¾ˆå¤šæ— æ³•è¢«åˆ©ç”¨çš„å°ç¢ç‰‡ï¼Œä»è€Œé™ä½å­˜å‚¨æ•ˆç‡ã€‚è¿™ç§æƒ…å†µçš„æç«¯æ˜¯æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„zipliståªåŒ…å«ä¸€ä¸ªæ•°æ®é¡¹ï¼Œè¿™å°±èœ•åŒ–æˆä¸€ä¸ªæ™®é€šçš„åŒå‘é“¾è¡¨äº†ã€‚æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistè¶Šé•¿ï¼Œåˆ™ä¸ºzipliståˆ†é…å¤§å—è¿ç»­å†…å­˜ç©ºé—´çš„éš¾åº¦å°±è¶Šå¤§ã€‚æœ‰å¯èƒ½å‡ºç°å†…å­˜é‡Œæœ‰å¾ˆå¤šå°å—çš„ç©ºé—²ç©ºé—´ï¼ˆå®ƒä»¬åŠ èµ·æ¥å¾ˆå¤šï¼‰ï¼Œä½†å´æ‰¾ä¸åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—²ç©ºé—´åˆ†é…ç»™ziplistçš„æƒ…å†µã€‚è¿™åŒæ ·ä¼šé™ä½å­˜å‚¨æ•ˆç‡ã€‚è¿™ç§æƒ…å†µçš„æç«¯æ˜¯æ•´ä¸ªquickliståªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€æœ‰çš„æ•°æ®é¡¹éƒ½åˆ†é…åœ¨è¿™ä»…æœ‰çš„ä¸€ä¸ªèŠ‚ç‚¹çš„ziplisté‡Œé¢ã€‚è¿™å…¶å®èœ•åŒ–æˆä¸€ä¸ªziplistäº†ã€‚å¯è§ï¼Œä¸€ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistè¦ä¿æŒä¸€ä¸ªåˆç†çš„é•¿åº¦ã€‚é‚£åˆ°åº•å¤šé•¿åˆç†å‘¢ï¼Ÿè¿™å¯èƒ½å–å†³äºå…·ä½“åº”ç”¨åœºæ™¯ã€‚å®é™…ä¸Šï¼ŒRedisæä¾›äº†ä¸€ä¸ªé…ç½®å‚æ•°list-max-ziplist-sizeï¼Œå°±æ˜¯ä¸ºäº†è®©ä½¿ç”¨è€…å¯ä»¥æ¥æ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œè°ƒæ•´ã€‚ 1list-max-ziplist-size -2 æˆ‘ä»¬æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‚æ•°çš„å«ä¹‰ã€‚å®ƒå¯ä»¥å–æ­£å€¼ï¼Œä¹Ÿå¯ä»¥å–è´Ÿå€¼ã€‚ å½“å–æ­£å€¼çš„æ—¶å€™ï¼Œè¡¨ç¤ºæŒ‰ç…§æ•°æ®é¡¹ä¸ªæ•°æ¥é™å®šæ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplisté•¿åº¦ã€‚æ¯”å¦‚ï¼Œå½“è¿™ä¸ªå‚æ•°é…ç½®æˆ5çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯ä¸ªquicklistèŠ‚ç‚¹çš„ziplistæœ€å¤šåŒ…å«5ä¸ªæ•°æ®é¡¹ã€‚ å½“å–è´Ÿå€¼çš„æ—¶å€™ï¼Œè¡¨ç¤ºæŒ‰ç…§å ç”¨å­—èŠ‚æ•°æ¥é™å®šæ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplisté•¿åº¦ã€‚è¿™æ—¶ï¼Œå®ƒåªèƒ½å–-1åˆ°-5è¿™äº”ä¸ªå€¼ï¼Œæ¯ä¸ªå€¼å«ä¹‰å¦‚ä¸‹ï¼š -5: æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistå¤§å°ä¸èƒ½è¶…è¿‡64 Kbã€‚ï¼ˆæ³¨ï¼š1kb =&gt; 1024 bytesï¼‰-4: æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistå¤§å°ä¸èƒ½è¶…è¿‡32 Kbã€‚-3: æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistå¤§å°ä¸èƒ½è¶…è¿‡16 Kbã€‚-2: æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistå¤§å°ä¸èƒ½è¶…è¿‡8 Kbã€‚ï¼ˆ-2æ˜¯Redisç»™å‡ºçš„é»˜è®¤å€¼ï¼‰-1: æ¯ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistå¤§å°ä¸èƒ½è¶…è¿‡4 Kbã€‚å¦å¤–ï¼Œlistçš„è®¾è®¡ç›®æ ‡æ˜¯èƒ½å¤Ÿç”¨æ¥å­˜å‚¨å¾ˆé•¿çš„æ•°æ®åˆ—è¡¨çš„ã€‚æ¯”å¦‚ï¼ŒRediså®˜ç½‘ç»™å‡ºçš„è¿™ä¸ªæ•™ç¨‹ï¼šWriting a simple Twitter clone with PHP and Redisï¼Œå°±æ˜¯ä½¿ç”¨listæ¥å­˜å‚¨ç±»ä¼¼Twitterçš„timelineæ•°æ®ã€‚ å½“åˆ—è¡¨å¾ˆé•¿çš„æ—¶å€™ï¼Œæœ€å®¹æ˜“è¢«è®¿é—®çš„å¾ˆå¯èƒ½æ˜¯ä¸¤ç«¯çš„æ•°æ®ï¼Œä¸­é—´çš„æ•°æ®è¢«è®¿é—®çš„é¢‘ç‡æ¯”è¾ƒä½ï¼ˆè®¿é—®èµ·æ¥æ€§èƒ½ä¹Ÿå¾ˆä½ï¼‰ã€‚å¦‚æœåº”ç”¨åœºæ™¯ç¬¦åˆè¿™ä¸ªç‰¹ç‚¹ï¼Œé‚£ä¹ˆlistè¿˜æä¾›äº†ä¸€ä¸ªé€‰é¡¹ï¼Œèƒ½å¤ŸæŠŠä¸­é—´çš„æ•°æ®èŠ‚ç‚¹è¿›è¡Œå‹ç¼©ï¼Œä»è€Œè¿›ä¸€æ­¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚Redisçš„é…ç½®å‚æ•°list-compress-depthå°±æ˜¯ç”¨æ¥å®Œæˆè¿™ä¸ªè®¾ç½®çš„ã€‚ 1list-compress-depth 0 è¿™ä¸ªå‚æ•°è¡¨ç¤ºä¸€ä¸ªquicklistä¸¤ç«¯ä¸è¢«å‹ç¼©çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚æ³¨ï¼šè¿™é‡Œçš„èŠ‚ç‚¹ä¸ªæ•°æ˜¯æŒ‡quickliståŒå‘é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œè€Œä¸æ˜¯æŒ‡ziplisté‡Œé¢çš„æ•°æ®é¡¹ä¸ªæ•°ã€‚å®é™…ä¸Šï¼Œä¸€ä¸ªquicklistèŠ‚ç‚¹ä¸Šçš„ziplistï¼Œå¦‚æœè¢«å‹ç¼©ï¼Œå°±æ˜¯æ•´ä½“è¢«å‹ç¼©çš„ã€‚ å‚æ•°list-compress-depthçš„å–å€¼å«ä¹‰å¦‚ä¸‹ï¼š 0: æ˜¯ä¸ªç‰¹æ®Šå€¼ï¼Œè¡¨ç¤ºéƒ½ä¸å‹ç¼©ã€‚è¿™æ˜¯Redisçš„é»˜è®¤å€¼ã€‚1: è¡¨ç¤ºquicklistä¸¤ç«¯å„æœ‰1ä¸ªèŠ‚ç‚¹ä¸å‹ç¼©ï¼Œä¸­é—´çš„èŠ‚ç‚¹å‹ç¼©ã€‚2: è¡¨ç¤ºquicklistä¸¤ç«¯å„æœ‰2ä¸ªèŠ‚ç‚¹ä¸å‹ç¼©ï¼Œä¸­é—´çš„èŠ‚ç‚¹å‹ç¼©ã€‚3: è¡¨ç¤ºquicklistä¸¤ç«¯å„æœ‰3ä¸ªèŠ‚ç‚¹ä¸å‹ç¼©ï¼Œä¸­é—´çš„èŠ‚ç‚¹å‹ç¼©ã€‚ä¾æ­¤ç±»æ¨â€¦ç”±äº0æ˜¯ä¸ªç‰¹æ®Šå€¼ï¼Œå¾ˆå®¹æ˜“çœ‹å‡ºquicklistçš„å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹æ€»æ˜¯ä¸è¢«å‹ç¼©çš„ï¼Œä»¥ä¾¿äºåœ¨è¡¨çš„ä¸¤ç«¯è¿›è¡Œå¿«é€Ÿå­˜å–ã€‚ Rediså¯¹äºquicklistå†…éƒ¨èŠ‚ç‚¹çš„å‹ç¼©ç®—æ³•ï¼Œé‡‡ç”¨çš„LZFâ€”â€”ä¸€ç§æ— æŸå‹ç¼©ç®—æ³•ã€‚ quicklistçš„æ•°æ®ç»“æ„å®šä¹‰quicklistç›¸å…³çš„æ•°æ®ç»“æ„å®šä¹‰å¯ä»¥åœ¨quicklist.hä¸­æ‰¾åˆ°ï¼š 1234567891011121314151617181920212223242526typedef struct quicklistNode &#123;struct quicklistNode *prev;struct quicklistNode *next;unsigned char *zl;unsigned int sz; /* ziplist size in bytes */unsigned int count : 16; /* count of items in ziplist */unsigned int encoding : 2; /* RAW==1 or LZF==2 */unsigned int container : 2; /* NONE==1 or ZIPLIST==2 */unsigned int recompress : 1; /* was this node previous compressed? */unsigned int attempted_compress : 1; /* node can&#x27;t compress; too small */unsigned int extra : 10; /* more bits to steal for future usage */&#125; quicklistNode;typedef struct quicklistLZF &#123;unsigned int sz; /* LZF size in bytes*/char compressed[];&#125; quicklistLZF;typedef struct quicklist &#123;quicklistNode *head;quicklistNode *tail;unsigned long count; /* total count of all entries in all ziplists */unsigned int len; /* number of quicklistNodes */int fill : 16; /* fill factor for individual nodes */unsigned int compress : 16; /* depth of end nodes not to compress;0=off */&#125; quicklist; quicklistNodeç»“æ„ä»£è¡¨quicklistçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ï¼š prev: æŒ‡å‘é“¾è¡¨å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚next: æŒ‡å‘é“¾è¡¨åä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚zl: æ•°æ®æŒ‡é’ˆã€‚å¦‚æœå½“å‰èŠ‚ç‚¹çš„æ•°æ®æ²¡æœ‰å‹ç¼©ï¼Œé‚£ä¹ˆå®ƒæŒ‡å‘ä¸€ä¸ªziplistç»“æ„ï¼›å¦åˆ™ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªquicklistLZFç»“æ„ã€‚sz: è¡¨ç¤ºzlæŒ‡å‘çš„ziplistçš„æ€»å¤§å°ï¼ˆåŒ…æ‹¬zlbytes, zltail, zllen, zlendå’Œå„ä¸ªæ•°æ®é¡¹ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœziplistè¢«å‹ç¼©äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªszçš„å€¼ä»ç„¶æ˜¯å‹ç¼©å‰çš„ziplistå¤§å°ã€‚count: è¡¨ç¤ºziplisté‡Œé¢åŒ…å«çš„æ•°æ®é¡¹ä¸ªæ•°ã€‚è¿™ä¸ªå­—æ®µåªæœ‰16bitã€‚ç¨åæˆ‘ä»¬ä¼šä¸€èµ·è®¡ç®—ä¸€ä¸‹è¿™16bitæ˜¯å¦å¤Ÿç”¨ã€‚encoding: è¡¨ç¤ºziplistæ˜¯å¦å‹ç¼©äº†ï¼ˆä»¥åŠç”¨äº†å“ªä¸ªå‹ç¼©ç®—æ³•ï¼‰ã€‚ç›®å‰åªæœ‰ä¸¤ç§å–å€¼ï¼š2è¡¨ç¤ºè¢«å‹ç¼©äº†ï¼ˆè€Œä¸”ç”¨çš„æ˜¯LZFå‹ç¼©ç®—æ³•ï¼‰ï¼Œ1è¡¨ç¤ºæ²¡æœ‰å‹ç¼©ã€‚container: æ˜¯ä¸€ä¸ªé¢„ç•™å­—æ®µã€‚æœ¬æ¥è®¾è®¡æ˜¯ç”¨æ¥è¡¨æ˜ä¸€ä¸ªquicklistèŠ‚ç‚¹ä¸‹é¢æ˜¯ç›´æ¥å­˜æ•°æ®ï¼Œè¿˜æ˜¯ä½¿ç”¨ziplistå­˜æ•°æ®ï¼Œæˆ–è€…ç”¨å…¶å®ƒçš„ç»“æ„æ¥å­˜æ•°æ®ï¼ˆç”¨ä½œä¸€ä¸ªæ•°æ®å®¹å™¨ï¼Œæ‰€ä»¥å«containerï¼‰ã€‚ä½†æ˜¯ï¼Œåœ¨ç›®å‰çš„å®ç°ä¸­ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼2ï¼Œè¡¨ç¤ºä½¿ç”¨ziplistä½œä¸ºæ•°æ®å®¹å™¨ã€‚recompress: å½“æˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼lindexè¿™æ ·çš„å‘½ä»¤æŸ¥çœ‹äº†æŸä¸€é¡¹æœ¬æ¥å‹ç¼©çš„æ•°æ®æ—¶ï¼Œéœ€è¦æŠŠæ•°æ®æš‚æ—¶è§£å‹ï¼Œè¿™æ—¶å°±è®¾ç½®recompress=1åšä¸€ä¸ªæ ‡è®°ï¼Œç­‰æœ‰æœºä¼šå†æŠŠæ•°æ®é‡æ–°å‹ç¼©ã€‚attempted_compress: è¿™ä¸ªå€¼åªå¯¹Redisçš„è‡ªåŠ¨åŒ–æµ‹è¯•ç¨‹åºæœ‰ç”¨ã€‚æˆ‘ä»¬ä¸ç”¨ç®¡å®ƒã€‚extra: å…¶å®ƒæ‰©å±•å­—æ®µã€‚ç›®å‰Redisçš„å®ç°é‡Œä¹Ÿæ²¡ç”¨ä¸Šã€‚quicklistLZFç»“æ„è¡¨ç¤ºä¸€ä¸ªè¢«å‹ç¼©è¿‡çš„ziplistã€‚å…¶ä¸­ï¼š sz: è¡¨ç¤ºå‹ç¼©åçš„ziplistå¤§å°ã€‚compressed: æ˜¯ä¸ªæŸ”æ€§æ•°ç»„ï¼ˆflexible array memberï¼‰ï¼Œå­˜æ”¾å‹ç¼©åçš„ziplistå­—èŠ‚æ•°ç»„ã€‚çœŸæ­£è¡¨ç¤ºquicklistçš„æ•°æ®ç»“æ„æ˜¯åŒåçš„quicklistè¿™ä¸ªstructï¼š head: æŒ‡å‘å¤´èŠ‚ç‚¹ï¼ˆå·¦ä¾§ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰çš„æŒ‡é’ˆã€‚tail: æŒ‡å‘å°¾èŠ‚ç‚¹ï¼ˆå³ä¾§ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰çš„æŒ‡é’ˆã€‚count: æ‰€æœ‰ziplistæ•°æ®é¡¹çš„ä¸ªæ•°æ€»å’Œã€‚len: quicklistèŠ‚ç‚¹çš„ä¸ªæ•°ã€‚fill: 16bitï¼Œziplistå¤§å°è®¾ç½®ï¼Œå­˜æ”¾list-max-ziplist-sizeå‚æ•°çš„å€¼ã€‚compress: 16bitï¼ŒèŠ‚ç‚¹å‹ç¼©æ·±åº¦è®¾ç½®ï¼Œå­˜æ”¾list-compress-depthå‚æ•°çš„å€¼ã€‚ ä¸Šå›¾æ˜¯ä¸€ä¸ªquicklistçš„ç»“æ„å›¾ä¸¾ä¾‹ã€‚å›¾ä¸­ä¾‹å­å¯¹åº”çš„ziplistå¤§å°é…ç½®å’ŒèŠ‚ç‚¹å‹ç¼©æ·±åº¦é…ç½®ï¼Œå¦‚ä¸‹ï¼š 12list-max-ziplist-size 3list-compress-depth 2 è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬éœ€è¦æ³¨æ„çš„å‡ ç‚¹æ˜¯ï¼š ä¸¤ç«¯å„æœ‰2ä¸ªæ©™é»„è‰²çš„èŠ‚ç‚¹ï¼Œæ˜¯æ²¡æœ‰è¢«å‹ç¼©çš„ã€‚å®ƒä»¬çš„æ•°æ®æŒ‡é’ˆzlæŒ‡å‘çœŸæ­£çš„ziplistã€‚ä¸­é—´çš„å…¶å®ƒèŠ‚ç‚¹æ˜¯è¢«å‹ç¼©è¿‡çš„ï¼Œå®ƒä»¬çš„æ•°æ®æŒ‡é’ˆzlæŒ‡å‘è¢«å‹ç¼©åçš„ziplistç»“æ„ï¼Œå³ä¸€ä¸ªquicklistLZFç»“æ„ã€‚å·¦ä¾§å¤´èŠ‚ç‚¹ä¸Šçš„ziplisté‡Œæœ‰2é¡¹æ•°æ®ï¼Œå³ä¾§å°¾èŠ‚ç‚¹ä¸Šçš„ziplisté‡Œæœ‰1é¡¹æ•°æ®ï¼Œä¸­é—´å…¶å®ƒèŠ‚ç‚¹ä¸Šçš„ziplisté‡Œéƒ½æœ‰3é¡¹æ•°æ®ï¼ˆåŒ…æ‹¬å‹ç¼©çš„èŠ‚ç‚¹å†…éƒ¨ï¼‰ã€‚è¿™è¡¨ç¤ºåœ¨è¡¨çš„ä¸¤ç«¯æ‰§è¡Œè¿‡å¤šæ¬¡pushå’Œpopæ“ä½œåçš„ä¸€ä¸ªçŠ¶æ€ã€‚ç°åœ¨æˆ‘ä»¬æ¥å¤§æ¦‚è®¡ç®—ä¸€ä¸‹quicklistNodeç»“æ„ä¸­çš„countå­—æ®µè¿™16bitæ˜¯å¦å¤Ÿç”¨ã€‚ æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œziplistå¤§å°å—åˆ°list-max-ziplist-sizeå‚æ•°çš„é™åˆ¶ã€‚æŒ‰ç…§æ­£å€¼å’Œè´Ÿå€¼æœ‰ä¸¤ç§æƒ…å†µï¼š å½“è¿™ä¸ªå‚æ•°å–æ­£å€¼çš„æ—¶å€™ï¼Œå°±æ˜¯æ°å¥½è¡¨ç¤ºä¸€ä¸ªquicklistNodeç»“æ„ä¸­zlæ‰€æŒ‡å‘çš„ziplistæ‰€åŒ…å«çš„æ•°æ®é¡¹çš„æœ€å¤§å€¼ã€‚list-max-ziplist-sizeå‚æ•°æ˜¯ç”±quicklistç»“æ„çš„fillå­—æ®µæ¥å­˜å‚¨çš„ï¼Œè€Œfillå­—æ®µæ˜¯16bitï¼Œæ‰€ä»¥å®ƒæ‰€èƒ½è¡¨è¾¾çš„å€¼èƒ½å¤Ÿç”¨16bitæ¥è¡¨ç¤ºã€‚å½“è¿™ä¸ªå‚æ•°å–è´Ÿå€¼çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè¡¨ç¤ºçš„ziplistæœ€å¤§é•¿åº¦æ˜¯64 Kbã€‚è€Œziplistä¸­æ¯ä¸€ä¸ªæ•°æ®é¡¹ï¼Œæœ€å°‘éœ€è¦2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼š1ä¸ªå­—èŠ‚çš„prevrawlenï¼Œ1ä¸ªå­—èŠ‚çš„dataï¼ˆlenå­—æ®µå’ŒdataåˆäºŒä¸ºä¸€ï¼›è¯¦è§ä¸Šä¸€ç¯‡ï¼‰ã€‚æ‰€ä»¥ï¼Œziplistä¸­æ•°æ®é¡¹çš„ä¸ªæ•°ä¸ä¼šè¶…è¿‡32 Kï¼Œç”¨16bitæ¥è¡¨è¾¾è¶³å¤Ÿäº†ã€‚å®é™…ä¸Šï¼Œåœ¨ç›®å‰çš„quicklistçš„å®ç°ä¸­ï¼Œziplistçš„å¤§å°è¿˜ä¼šå—åˆ°å¦å¤–çš„é™åˆ¶ï¼Œæ ¹æœ¬ä¸ä¼šè¾¾åˆ°è¿™é‡Œæ‰€åˆ†æçš„æœ€å¤§å€¼ã€‚ ä¸‹é¢è¿›å…¥ä»£ç åˆ†æé˜¶æ®µã€‚ quicklistçš„åˆ›å»ºå½“æˆ‘ä»¬ä½¿ç”¨lpushæˆ–rpushå‘½ä»¤ç¬¬ä¸€æ¬¡å‘ä¸€ä¸ªä¸å­˜åœ¨çš„listé‡Œé¢æ’å…¥æ•°æ®çš„æ—¶å€™ï¼ŒRedisä¼šé¦–å…ˆè°ƒç”¨quicklistCreateæ¥å£åˆ›å»ºä¸€ä¸ªç©ºçš„quicklistã€‚ 1234567891011quicklist *quicklistCreate(void) &#123;struct quicklist *quicklist; quicklist = zmalloc(sizeof(*quicklist)); quicklist-&gt;head = quicklist-&gt;tail = NULL; quicklist-&gt;len = 0; quicklist-&gt;count = 0; quicklist-&gt;compress = 0; quicklist-&gt;fill = -2; return quicklist;&#125; åœ¨å¾ˆå¤šä»‹ç»æ•°æ®ç»“æ„çš„ä¹¦ä¸Šï¼Œå®ç°åŒå‘é“¾è¡¨çš„æ—¶å€™ç»å¸¸ä¼šå¤šå¢åŠ ä¸€ä¸ªç©ºä½™çš„å¤´èŠ‚ç‚¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ’å…¥å’Œåˆ é™¤æ“ä½œçš„æ–¹ä¾¿ã€‚ä»ä¸Šé¢quicklistCreateçš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œquicklistæ˜¯ä¸€ä¸ªä¸åŒ…å«ç©ºä½™å¤´èŠ‚ç‚¹çš„åŒå‘é“¾è¡¨ï¼ˆheadå’Œtailéƒ½åˆå§‹åŒ–ä¸ºNULLï¼‰ã€‚ quicklistçš„pushæ“ä½œquicklistçš„pushæ“ä½œæ˜¯è°ƒç”¨quicklistPushæ¥å®ç°çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354void quicklistPush(quicklist *quicklist, void *value, const size_t sz,int where) &#123;if (where == QUICKLIST_HEAD) &#123;quicklistPushHead(quicklist, value, sz);&#125; else if (where == QUICKLIST_TAIL) &#123;quicklistPushTail(quicklist, value, sz);&#125;&#125;/* Add new entry to head node of quicklist.** Returns 0 if used existing head.* Returns 1 if new head created. */ int quicklistPushHead(quicklist *quicklist, void *value, size_t sz) &#123; quicklistNode *orig_head = quicklist-&gt;head; if (likely( _quicklistNodeAllowInsert(quicklist-&gt;head, quicklist-&gt;fill, sz))) &#123; quicklist-&gt;head-&gt;zl = ziplistPush(quicklist-&gt;head-&gt;zl, value, sz, ZIPLIST_HEAD); quicklistNodeUpdateSz(quicklist-&gt;head); &#125; else &#123; quicklistNode *node = quicklistCreateNode(); node-&gt;zl = ziplistPush(ziplistNew(), value, sz, ZIPLIST_HEAD); quicklistNodeUpdateSz(node); _quicklistInsertNodeBefore(quicklist, quicklist-&gt;head, node); &#125; quicklist-&gt;count++; quicklist-&gt;head-&gt;count++; return (orig_head != quicklist-&gt;head); &#125;/* Add new entry to tail node of quicklist.** Returns 0 if used existing tail.* Returns 1 if new tail created. */ int quicklistPushTail(quicklist *quicklist, void *value, size_t sz) &#123; quicklistNode *orig_tail = quicklist-&gt;tail; if (likely( _quicklistNodeAllowInsert(quicklist-&gt;tail, quicklist-&gt;fill, sz))) &#123; quicklist-&gt;tail-&gt;zl = ziplistPush(quicklist-&gt;tail-&gt;zl, value, sz, ZIPLIST_TAIL); quicklistNodeUpdateSz(quicklist-&gt;tail); &#125; else &#123; quicklistNode *node = quicklistCreateNode(); node-&gt;zl = ziplistPush(ziplistNew(), value, sz, ZIPLIST_TAIL); quicklistNodeUpdateSz(node); _quicklistInsertNodeAfter(quicklist, quicklist-&gt;tail, node); &#125; quicklist-&gt;count++; quicklist-&gt;tail-&gt;count++; return (orig_tail != quicklist-&gt;tail); &#125; ä¸ç®¡æ˜¯åœ¨å¤´éƒ¨è¿˜æ˜¯å°¾éƒ¨æ’å…¥æ•°æ®ï¼Œéƒ½åŒ…å«ä¸¤ç§æƒ…å†µï¼š å¦‚æœå¤´èŠ‚ç‚¹ï¼ˆæˆ–å°¾èŠ‚ç‚¹ï¼‰ä¸Šziplistå¤§å°æ²¡æœ‰è¶…è¿‡é™åˆ¶ï¼ˆå³_quicklistNodeAllowInsertè¿”å›1ï¼‰ï¼Œé‚£ä¹ˆæ–°æ•°æ®è¢«ç›´æ¥æ’å…¥åˆ°ziplistä¸­ï¼ˆè°ƒç”¨ziplistPushï¼‰ã€‚å¦‚æœå¤´èŠ‚ç‚¹ï¼ˆæˆ–å°¾èŠ‚ç‚¹ï¼‰ä¸Šziplistå¤ªå¤§äº†ï¼Œé‚£ä¹ˆæ–°åˆ›å»ºä¸€ä¸ªquicklistNodeèŠ‚ç‚¹ï¼ˆå¯¹åº”åœ°ä¹Ÿä¼šæ–°åˆ›å»ºä¸€ä¸ªziplistï¼‰ï¼Œç„¶åæŠŠè¿™ä¸ªæ–°åˆ›å»ºçš„èŠ‚ç‚¹æ’å…¥åˆ°quickliståŒå‘é“¾è¡¨ä¸­ï¼ˆè°ƒç”¨_quicklistInsertNodeAfterï¼‰ã€‚åœ¨_quicklistInsertNodeAfterçš„å®ç°ä¸­ï¼Œè¿˜ä¼šæ ¹æ®list-compress-depthçš„é…ç½®å°†é‡Œé¢çš„èŠ‚ç‚¹è¿›è¡Œå‹ç¼©ã€‚å®ƒçš„å®ç°æ¯”è¾ƒç¹çï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸å±•å¼€è®¨è®ºäº†ã€‚ quicklistçš„å…¶å®ƒæ“ä½œquicklistçš„æ“ä½œè¾ƒå¤šï¼Œä¸”å®ç°ç»†èŠ‚éƒ½æ¯”è¾ƒç¹æ‚ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ†ææºç äº†ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€äº›æ¯”è¾ƒé‡è¦çš„æ“ä½œã€‚ quicklistçš„popæ“ä½œæ˜¯è°ƒç”¨quicklistPopCustomæ¥å®ç°çš„ã€‚quicklistPopCustomçš„å®ç°è¿‡ç¨‹åŸºæœ¬ä¸Šè·ŸquicklistPushç›¸åï¼Œå…ˆä»å¤´éƒ¨æˆ–å°¾éƒ¨èŠ‚ç‚¹çš„ziplistä¸­æŠŠå¯¹åº”çš„æ•°æ®é¡¹åˆ é™¤ï¼Œå¦‚æœåœ¨åˆ é™¤åziplistä¸ºç©ºäº†ï¼Œé‚£ä¹ˆå¯¹åº”çš„å¤´éƒ¨æˆ–å°¾éƒ¨èŠ‚ç‚¹ä¹Ÿè¦åˆ é™¤ã€‚åˆ é™¤åè¿˜å¯èƒ½æ¶‰åŠåˆ°é‡Œé¢èŠ‚ç‚¹çš„è§£å‹ç¼©é—®é¢˜ã€‚ quicklistä¸ä»…å®ç°äº†ä»å¤´éƒ¨æˆ–å°¾éƒ¨æ’å…¥ï¼Œä¹Ÿå®ç°äº†ä»ä»»æ„æŒ‡å®šçš„ä½ç½®æ’å…¥ã€‚quicklistInsertAfterå’ŒquicklistInsertBeforeå°±æ˜¯åˆ†åˆ«åœ¨æŒ‡å®šä½ç½®åé¢å’Œå‰é¢æ’å…¥æ•°æ®é¡¹ã€‚è¿™ç§åœ¨ä»»æ„æŒ‡å®šä½ç½®æ’å…¥æ•°æ®çš„æ“ä½œï¼Œæƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œæœ‰ä¼—å¤šçš„é€»è¾‘åˆ†æ”¯ã€‚ å½“æ’å…¥ä½ç½®æ‰€åœ¨çš„ziplistå¤§å°æ²¡æœ‰è¶…è¿‡é™åˆ¶æ—¶ï¼Œç›´æ¥æ’å…¥åˆ°ziplistä¸­å°±å¥½äº†ï¼›å½“æ’å…¥ä½ç½®æ‰€åœ¨çš„ziplistå¤§å°è¶…è¿‡äº†é™åˆ¶ï¼Œä½†æ’å…¥çš„ä½ç½®ä½äºziplistä¸¤ç«¯ï¼Œå¹¶ä¸”ç›¸é‚»çš„quicklisté“¾è¡¨èŠ‚ç‚¹çš„ziplistå¤§å°æ²¡æœ‰è¶…è¿‡é™åˆ¶ï¼Œé‚£ä¹ˆå°±è½¬è€Œæ’å…¥åˆ°ç›¸é‚»çš„é‚£ä¸ªquicklisté“¾è¡¨èŠ‚ç‚¹çš„ziplistä¸­ï¼›å½“æ’å…¥ä½ç½®æ‰€åœ¨çš„ziplistå¤§å°è¶…è¿‡äº†é™åˆ¶ï¼Œä½†æ’å…¥çš„ä½ç½®ä½äºziplistä¸¤ç«¯ï¼Œå¹¶ä¸”ç›¸é‚»çš„quicklisté“¾è¡¨èŠ‚ç‚¹çš„ziplistå¤§å°ä¹Ÿè¶…è¿‡é™åˆ¶ï¼Œè¿™æ—¶éœ€è¦æ–°åˆ›å»ºä¸€ä¸ªquicklisté“¾è¡¨èŠ‚ç‚¹æ’å…¥ã€‚å¯¹äºæ’å…¥ä½ç½®æ‰€åœ¨çš„ziplistå¤§å°è¶…è¿‡äº†é™åˆ¶çš„å…¶å®ƒæƒ…å†µï¼ˆä¸»è¦å¯¹åº”äºåœ¨ziplistä¸­é—´æ’å…¥æ•°æ®çš„æƒ…å†µï¼‰ï¼Œåˆ™éœ€è¦æŠŠå½“å‰zipliståˆ†è£‚ä¸ºä¸¤ä¸ªèŠ‚ç‚¹ï¼Œç„¶åå†å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ’å…¥æ•°æ®ã€‚quicklistSetOptionsç”¨äºè®¾ç½®ziplistå¤§å°é…ç½®å‚æ•°ï¼ˆlist-max-ziplist-sizeï¼‰å’ŒèŠ‚ç‚¹å‹ç¼©æ·±åº¦é…ç½®å‚æ•°ï¼ˆlist-compress-depthï¼‰ã€‚ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†ç›¸åº”çš„å€¼åˆ†åˆ«è®¾ç½®ç»™quicklistç»“æ„çš„fillå­—æ®µå’Œcompresså­—æ®µã€‚","categories":[{"name":"5.ç¼“å­˜","slug":"5-ç¼“å­˜","permalink":"https://zhangxin66666.github.io/categories/5-%E7%BC%93%E5%AD%98/"}],"tags":[{"name":"redis","slug":"redis","permalink":"https://zhangxin66666.github.io/tags/redis/"}]},{"title":"Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(1)â€”â€”dict","slug":"5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(1)â€”â€”dict","date":"2024-12-25T16:00:00.000Z","updated":"2024-12-30T06:06:47.619Z","comments":true,"path":"2024/12/26/5.ç¼“å­˜/Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(1)â€”â€”dict/","link":"","permalink":"https://zhangxin66666.github.io/2024/12/26/5.%E7%BC%93%E5%AD%98/Redis%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3(1)%E2%80%94%E2%80%94dict/","excerpt":"","text":"å¦‚æœä½ ä½¿ç”¨è¿‡Redisï¼Œä¸€å®šä¼šåƒæˆ‘ä¸€æ ·å¯¹å®ƒçš„å†…éƒ¨å®ç°äº§ç”Ÿå…´è¶£ã€‚ã€ŠRediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£ã€‹æ˜¯æˆ‘å‡†å¤‡å†™çš„ä¸€ä¸ªç³»åˆ—ï¼Œä¹Ÿæ˜¯æˆ‘ä¸ªäººå¯¹äºä¹‹å‰ç ”ç©¶Redisçš„ä¸€ä¸ªé˜¶æ®µæ€§æ€»ç»“ï¼Œç€é‡è®²è§£Redisåœ¨å†…å­˜ä¸­çš„æ•°æ®ç»“æ„å®ç°ï¼ˆæš‚ä¸æ¶‰åŠæŒä¹…åŒ–çš„è¯é¢˜ï¼‰ã€‚Redisæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„æœåŠ¡å™¨ï¼ˆdata structures serverï¼‰ï¼Œä»¥é«˜æ•ˆçš„æ–¹å¼å®ç°äº†å¤šç§ç°æˆçš„æ•°æ®ç»“æ„ï¼Œç ”ç©¶å®ƒçš„æ•°æ®ç»“æ„å’ŒåŸºäºå…¶ä¸Šçš„ç®—æ³•ï¼Œå¯¹äºæˆ‘ä»¬è‡ªå·±æå‡å±€éƒ¨ç®—æ³•çš„ç¼–ç¨‹æ°´å¹³æœ‰å¾ˆé‡è¦çš„å‚è€ƒæ„ä¹‰ã€‚ å½“æˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­æåˆ°Redisçš„â€œæ•°æ®ç»“æ„â€ï¼Œå¯èƒ½æ˜¯åœ¨ä¸¤ä¸ªä¸åŒçš„å±‚é¢æ¥è®¨è®ºå®ƒã€‚ ç¬¬ä¸€ä¸ªå±‚é¢ï¼Œæ˜¯ä»ä½¿ç”¨è€…çš„è§’åº¦ã€‚æ¯”å¦‚ï¼š stringlisthashsetsorted setè¿™ä¸€å±‚é¢ä¹Ÿæ˜¯Redisæš´éœ²ç»™å¤–éƒ¨çš„è°ƒç”¨æ¥å£ã€‚ ç¬¬äºŒä¸ªå±‚é¢ï¼Œæ˜¯ä»å†…éƒ¨å®ç°çš„è§’åº¦ï¼Œå±äºæ›´åº•å±‚çš„å®ç°ã€‚æ¯”å¦‚ï¼š dictsdsziplistquicklistskiplistç¬¬ä¸€ä¸ªå±‚é¢çš„â€œæ•°æ®ç»“æ„â€ï¼ŒRedisçš„å®˜æ–¹æ–‡æ¡£(http://redis.io/topics/data-types-intro)æœ‰è¯¦ç»†çš„ä»‹ç»ã€‚æœ¬æ–‡çš„é‡ç‚¹åœ¨äºè®¨è®ºç¬¬äºŒä¸ªå±‚é¢ï¼ŒRedisæ•°æ®ç»“æ„çš„å†…éƒ¨å®ç°ï¼Œä»¥åŠè¿™ä¸¤ä¸ªå±‚é¢çš„æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ï¼šRediså¦‚ä½•é€šè¿‡ç»„åˆç¬¬äºŒä¸ªå±‚é¢çš„å„ç§åŸºç¡€æ•°æ®ç»“æ„æ¥å®ç°ç¬¬ä¸€ä¸ªå±‚é¢çš„æ›´é«˜å±‚çš„æ•°æ®ç»“æ„ã€‚ åœ¨è®¨è®ºä»»ä½•ä¸€ä¸ªç³»ç»Ÿçš„å†…éƒ¨å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½è¦å…ˆæ˜ç¡®å®ƒçš„è®¾è®¡åŸåˆ™ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½æ›´æ·±åˆ»åœ°ç†è§£å®ƒä¸ºä»€ä¹ˆä¼šè¿›è¡Œå¦‚æ­¤è®¾è®¡çš„çœŸæ­£æ„å›¾ã€‚åœ¨æœ¬æ–‡æ¥ä¸‹æ¥çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ä»¥ä¸‹å‡ ç‚¹ï¼š å­˜å‚¨æ•ˆç‡ï¼ˆmemory efficiencyï¼‰ã€‚Redisæ˜¯ä¸“ç”¨äºå­˜å‚¨æ•°æ®çš„ï¼Œå®ƒå¯¹äºè®¡ç®—æœºèµ„æºçš„ä¸»è¦æ¶ˆè€—å°±åœ¨äºå†…å­˜ï¼Œå› æ­¤èŠ‚çœå†…å­˜æ˜¯å®ƒéå¸¸éå¸¸é‡è¦çš„ä¸€ä¸ªæ–¹é¢ã€‚è¿™æ„å‘³ç€Redisä¸€å®šæ˜¯éå¸¸ç²¾ç»†åœ°è€ƒè™‘äº†å‹ç¼©æ•°æ®ã€å‡å°‘å†…å­˜ç¢ç‰‡ç­‰é—®é¢˜ã€‚å¿«é€Ÿå“åº”æ—¶é—´ï¼ˆfast response timeï¼‰ã€‚ä¸å¿«é€Ÿå“åº”æ—¶é—´ç›¸å¯¹çš„ï¼Œæ˜¯é«˜ååé‡ï¼ˆhigh throughputï¼‰ã€‚Redisæ˜¯ç”¨äºæä¾›åœ¨çº¿è®¿é—®çš„ï¼Œå¯¹äºå•ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´è¦æ±‚å¾ˆé«˜ï¼Œå› æ­¤ï¼Œå¿«é€Ÿå“åº”æ—¶é—´æ˜¯æ¯”é«˜ååé‡æ›´é‡è¦çš„ç›®æ ‡ã€‚æœ‰æ—¶å€™ï¼Œè¿™ä¸¤ä¸ªç›®æ ‡æ˜¯çŸ›ç›¾çš„ã€‚å•çº¿ç¨‹ï¼ˆsingle-threadedï¼‰ã€‚Redisçš„æ€§èƒ½ç“¶é¢ˆä¸åœ¨äºCPUèµ„æºï¼Œè€Œåœ¨äºå†…å­˜è®¿é—®å’Œç½‘ç»œIOã€‚è€Œé‡‡ç”¨å•çº¿ç¨‹çš„è®¾è®¡å¸¦æ¥çš„å¥½å¤„æ˜¯ï¼Œæå¤§ç®€åŒ–äº†æ•°æ®ç»“æ„å’Œç®—æ³•çš„å®ç°ã€‚ç›¸åï¼ŒRedisé€šè¿‡å¼‚æ­¥IOå’Œpipeliningç­‰æœºåˆ¶æ¥å®ç°é«˜é€Ÿçš„å¹¶å‘è®¿é—®ã€‚æ˜¾ç„¶ï¼Œå•çº¿ç¨‹çš„è®¾è®¡ï¼Œå¯¹äºå•ä¸ªè¯·æ±‚çš„å¿«é€Ÿå“åº”æ—¶é—´ä¹Ÿæå‡ºäº†æ›´é«˜çš„è¦æ±‚ã€‚æœ¬æ–‡æ˜¯ã€ŠRediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£ã€‹ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œè®²è¿°Redisä¸€ä¸ªé‡è¦çš„åŸºç¡€æ•°æ®ç»“æ„ï¼šdictã€‚ dictæ˜¯ä¸€ä¸ªç”¨äºç»´æŠ¤keyå’Œvalueæ˜ å°„å…³ç³»çš„æ•°æ®ç»“æ„ï¼Œä¸å¾ˆå¤šè¯­è¨€ä¸­çš„Mapæˆ–dictionaryç±»ä¼¼ã€‚Redisçš„ä¸€ä¸ªdatabaseä¸­æ‰€æœ‰keyåˆ°valueçš„æ˜ å°„ï¼Œå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªdictæ¥ç»´æŠ¤çš„ã€‚ä¸è¿‡ï¼Œè¿™åªæ˜¯å®ƒåœ¨Redisä¸­çš„ä¸€ä¸ªç”¨é€”è€Œå·²ï¼Œå®ƒåœ¨Redisä¸­è¢«ä½¿ç”¨çš„åœ°æ–¹è¿˜æœ‰å¾ˆå¤šã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªRedis hashç»“æ„ï¼Œå½“å®ƒçš„fieldè¾ƒå¤šæ—¶ï¼Œä¾¿ä¼šé‡‡ç”¨dictæ¥å­˜å‚¨ã€‚å†æ¯”å¦‚ï¼ŒRedisé…åˆä½¿ç”¨dictå’Œskiplistæ¥å…±åŒç»´æŠ¤ä¸€ä¸ªsorted setã€‚è¿™äº›ç»†èŠ‚æˆ‘ä»¬åé¢å†è®¨è®ºï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é›†ä¸­ç²¾åŠ›è®¨è®ºdictæœ¬èº«çš„å®ç°ã€‚ dictæœ¬è´¨ä¸Šæ˜¯ä¸ºäº†è§£å†³ç®—æ³•ä¸­çš„æŸ¥æ‰¾é—®é¢˜ï¼ˆSearchingï¼‰ï¼Œä¸€èˆ¬æŸ¥æ‰¾é—®é¢˜çš„è§£æ³•åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼šä¸€ä¸ªæ˜¯åŸºäºå„ç§å¹³è¡¡æ ‘ï¼Œä¸€ä¸ªæ˜¯åŸºäºå“ˆå¸Œè¡¨ã€‚æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„å„ç§Mapæˆ–dictionaryï¼Œå¤§éƒ½æ˜¯åŸºäºå“ˆå¸Œè¡¨å®ç°çš„ã€‚åœ¨ä¸è¦æ±‚æ•°æ®æœ‰åºå­˜å‚¨ï¼Œä¸”èƒ½ä¿æŒè¾ƒä½çš„å“ˆå¸Œå€¼å†²çªæ¦‚ç‡çš„å‰æä¸‹ï¼ŒåŸºäºå“ˆå¸Œè¡¨çš„æŸ¥æ‰¾æ€§èƒ½èƒ½åšåˆ°éå¸¸é«˜æ•ˆï¼Œæ¥è¿‘O(1)ï¼Œè€Œä¸”å®ç°ç®€å•ã€‚ åœ¨Redisä¸­ï¼Œdictä¹Ÿæ˜¯ä¸€ä¸ªåŸºäºå“ˆå¸Œè¡¨çš„ç®—æ³•ã€‚å’Œä¼ ç»Ÿçš„å“ˆå¸Œç®—æ³•ç±»ä¼¼ï¼Œå®ƒé‡‡ç”¨æŸä¸ªå“ˆå¸Œå‡½æ•°ä»keyè®¡ç®—å¾—åˆ°åœ¨å“ˆå¸Œè¡¨ä¸­çš„ä½ç½®ï¼Œé‡‡ç”¨æ‹‰é“¾æ³•è§£å†³å†²çªï¼Œå¹¶åœ¨è£…è½½å› å­ï¼ˆload factorï¼‰è¶…è¿‡é¢„å®šå€¼æ—¶è‡ªåŠ¨æ‰©å±•å†…å­˜ï¼Œå¼•å‘é‡å“ˆå¸Œï¼ˆrehashingï¼‰ã€‚Redisçš„dictå®ç°æœ€æ˜¾è‘—çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±åœ¨äºå®ƒçš„é‡å“ˆå¸Œã€‚å®ƒé‡‡ç”¨äº†ä¸€ç§ç§°ä¸ºå¢é‡å¼é‡å“ˆå¸Œï¼ˆincremental rehashingï¼‰çš„æ–¹æ³•ï¼Œåœ¨éœ€è¦æ‰©å±•å†…å­˜æ—¶é¿å…ä¸€æ¬¡æ€§å¯¹æ‰€æœ‰keyè¿›è¡Œé‡å“ˆå¸Œï¼Œè€Œæ˜¯å°†é‡å“ˆå¸Œæ“ä½œåˆ†æ•£åˆ°å¯¹äºdictçš„å„ä¸ªå¢åˆ æ”¹æŸ¥çš„æ“ä½œä¸­å»ã€‚è¿™ç§æ–¹æ³•èƒ½åšåˆ°æ¯æ¬¡åªå¯¹ä¸€å°éƒ¨åˆ†keyè¿›è¡Œé‡å“ˆå¸Œï¼Œè€Œæ¯æ¬¡é‡å“ˆå¸Œä¹‹é—´ä¸å½±å“dictçš„æ“ä½œã€‚dictä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡ï¼Œæ˜¯ä¸ºäº†é¿å…é‡å“ˆå¸ŒæœŸé—´å•ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´å‰§çƒˆå¢åŠ ï¼Œè¿™ä¸å‰é¢æåˆ°çš„â€œå¿«é€Ÿå“åº”æ—¶é—´â€çš„è®¾è®¡åŸåˆ™æ˜¯ç›¸ç¬¦çš„ã€‚ ä¸‹é¢è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚ dictçš„æ•°æ®ç»“æ„å®šä¹‰ä¸ºäº†å®ç°å¢é‡å¼é‡å“ˆå¸Œï¼ˆincremental rehashingï¼‰ï¼Œdictçš„æ•°æ®ç»“æ„é‡ŒåŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ã€‚åœ¨é‡å“ˆå¸ŒæœŸé—´ï¼Œæ•°æ®ä»ç¬¬ä¸€ä¸ªå“ˆå¸Œè¡¨å‘ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨è¿ç§»ã€‚ dictçš„Cä»£ç å®šä¹‰å¦‚ä¸‹ï¼ˆå‡ºè‡ªRedisæºç dict.hï¼‰ï¼š 123456789101112131415161718192021222324252627282930313233343536ypedef struct dictEntry &#123; void *key; union &#123; void *val; uint64_t u64; int64_t s64; double d; &#125; v; struct dictEntry *next;&#125; dictEntry;typedef struct dictType &#123; unsigned int (*hashFunction)(const void *key); void *(*keyDup)(void *privdata, const void *key); void *(*valDup)(void *privdata, const void *obj); int (*keyCompare)(void *privdata, const void *key1, const void *key2); void (*keyDestructor)(void *privdata, void *key); void (*valDestructor)(void *privdata, void *obj);&#125; dictType;/* This is our hash table structure. Every dictionary has two of this as we * implement incremental rehashing, for the old to the new table. */typedef struct dictht &#123; dictEntry **table; unsigned long size; unsigned long sizemask; unsigned long used;&#125; dictht;typedef struct dict &#123; dictType *type; void *privdata; dictht ht[2]; long rehashidx; /* rehashing not in progress if rehashidx == -1 */ int iterators; /* number of iterators currently running */&#125; dict; ä¸ºäº†èƒ½æ›´æ¸…æ¥šåœ°å±•ç¤ºdictçš„æ•°æ®ç»“æ„å®šä¹‰ï¼Œæˆ‘ä»¬ç”¨ä¸€å¼ ç»“æ„å›¾æ¥è¡¨ç¤ºå®ƒã€‚å¦‚ä¸‹ã€‚ ç»“åˆä¸Šé¢çš„ä»£ç å’Œç»“æ„å›¾ï¼Œå¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹å‡ºdictçš„ç»“æ„ã€‚ä¸€ä¸ªdictç”±å¦‚ä¸‹è‹¥å¹²é¡¹ç»„æˆï¼š ä¸€ä¸ªæŒ‡å‘dictTypeç»“æ„çš„æŒ‡é’ˆï¼ˆtypeï¼‰ã€‚å®ƒé€šè¿‡è‡ªå®šä¹‰çš„æ–¹å¼ä½¿å¾—dictçš„keyå’Œvalueèƒ½å¤Ÿå­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®ã€‚ä¸€ä¸ªç§æœ‰æ•°æ®æŒ‡é’ˆï¼ˆprivdataï¼‰ã€‚ç”±è°ƒç”¨è€…åœ¨åˆ›å»ºdictçš„æ—¶å€™ä¼ è¿›æ¥ã€‚ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼ˆht[2]ï¼‰ã€‚åªæœ‰åœ¨é‡å“ˆå¸Œçš„è¿‡ç¨‹ä¸­ï¼Œht[0]å’Œht[1]æ‰éƒ½æœ‰æ•ˆã€‚è€Œåœ¨å¹³å¸¸æƒ…å†µä¸‹ï¼Œåªæœ‰ht[0]æœ‰æ•ˆï¼Œht[1]é‡Œé¢æ²¡æœ‰ä»»ä½•æ•°æ®ã€‚ä¸Šå›¾è¡¨ç¤ºçš„å°±æ˜¯é‡å“ˆå¸Œè¿›è¡Œåˆ°ä¸­é—´æŸä¸€æ­¥æ—¶çš„æƒ…å†µã€‚å½“å‰é‡å“ˆå¸Œç´¢å¼•ï¼ˆrehashidxï¼‰ã€‚å¦‚æœrehashidx = -1ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰åœ¨é‡å“ˆå¸Œè¿‡ç¨‹ä¸­ï¼›å¦åˆ™ï¼Œè¡¨ç¤ºå½“å‰æ­£åœ¨è¿›è¡Œé‡å“ˆå¸Œï¼Œä¸”å®ƒçš„å€¼è®°å½•äº†å½“å‰é‡å“ˆå¸Œè¿›è¡Œåˆ°å“ªä¸€æ­¥äº†ã€‚å½“å‰æ­£åœ¨è¿›è¡Œéå†çš„iteratorçš„ä¸ªæ•°ã€‚è¿™ä¸æ˜¯æˆ‘ä»¬ç°åœ¨è®¨è®ºçš„é‡ç‚¹ï¼Œæš‚æ—¶å¿½ç•¥ã€‚dictTypeç»“æ„åŒ…å«è‹¥å¹²å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºdictçš„è°ƒç”¨è€…å¯¹æ¶‰åŠkeyå’Œvalueçš„å„ç§æ“ä½œè¿›è¡Œè‡ªå®šä¹‰ã€‚è¿™äº›æ“ä½œåŒ…å«ï¼š hashFunctionï¼Œå¯¹keyè¿›è¡Œå“ˆå¸Œå€¼è®¡ç®—çš„å“ˆå¸Œç®—æ³•ã€‚keyDupå’ŒvalDupï¼Œåˆ†åˆ«å®šä¹‰keyå’Œvalueçš„æ‹·è´å‡½æ•°ï¼Œç”¨äºåœ¨éœ€è¦çš„æ—¶å€™å¯¹keyå’Œvalueè¿›è¡Œæ·±æ‹·è´ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¼ é€’å¯¹è±¡æŒ‡é’ˆã€‚keyCompareï¼Œå®šä¹‰ä¸¤ä¸ªkeyçš„æ¯”è¾ƒæ“ä½œï¼Œåœ¨æ ¹æ®keyè¿›è¡ŒæŸ¥æ‰¾æ—¶ä¼šç”¨åˆ°ã€‚keyDestructorå’ŒvalDestructorï¼Œåˆ†åˆ«å®šä¹‰å¯¹keyå’Œvalueçš„ææ„å‡½æ•°ã€‚ç§æœ‰æ•°æ®æŒ‡é’ˆï¼ˆprivdataï¼‰å°±æ˜¯åœ¨dictTypeçš„æŸäº›æ“ä½œè¢«è°ƒç”¨æ—¶ä¼šä¼ å›ç»™è°ƒç”¨è€…ã€‚ éœ€è¦è¯¦ç»†å¯Ÿçœ‹çš„æ˜¯dicthtç»“æ„ã€‚å®ƒå®šä¹‰ä¸€ä¸ªå“ˆå¸Œè¡¨çš„ç»“æ„ï¼Œç”±å¦‚ä¸‹è‹¥å¹²é¡¹ç»„æˆï¼š ä¸€ä¸ªdictEntryæŒ‡é’ˆæ•°ç»„ï¼ˆtableï¼‰ã€‚keyçš„å“ˆå¸Œå€¼æœ€ç»ˆæ˜ å°„åˆ°è¿™ä¸ªæ•°ç»„çš„æŸä¸ªä½ç½®ä¸Šï¼ˆå¯¹åº”ä¸€ä¸ªbucketï¼‰ã€‚å¦‚æœå¤šä¸ªkeyæ˜ å°„åˆ°åŒä¸€ä¸ªä½ç½®ï¼Œå°±å‘ç”Ÿäº†å†²çªï¼Œé‚£ä¹ˆå°±æ‹‰å‡ºä¸€ä¸ªdictEntryé“¾è¡¨ã€‚sizeï¼šæ ‡è¯†dictEntryæŒ‡é’ˆæ•°ç»„çš„é•¿åº¦ã€‚å®ƒæ€»æ˜¯2çš„æŒ‡æ•°ã€‚sizemaskï¼šç”¨äºå°†å“ˆå¸Œå€¼æ˜ å°„åˆ°tableçš„ä½ç½®ç´¢å¼•ã€‚å®ƒçš„å€¼ç­‰äº(size-1)ï¼Œæ¯”å¦‚7, 15, 31, 63ï¼Œç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºçš„å„ä¸ªbitå…¨1çš„æ•°å­—ã€‚æ¯ä¸ªkeyå…ˆç»è¿‡hashFunctionè®¡ç®—å¾—åˆ°ä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œç„¶åè®¡ç®—(å“ˆå¸Œå€¼ &amp; sizemask)å¾—åˆ°åœ¨tableä¸Šçš„ä½ç½®ã€‚ç›¸å½“äºè®¡ç®—å–ä½™(å“ˆå¸Œå€¼ % size)ã€‚usedï¼šè®°å½•dictä¸­ç°æœ‰çš„æ•°æ®ä¸ªæ•°ã€‚å®ƒä¸sizeçš„æ¯”å€¼å°±æ˜¯è£…è½½å› å­ï¼ˆload factorï¼‰ã€‚è¿™ä¸ªæ¯”å€¼è¶Šå¤§ï¼Œå“ˆå¸Œå€¼å†²çªæ¦‚ç‡è¶Šé«˜ã€‚dictEntryç»“æ„ä¸­åŒ…å«k, vå’ŒæŒ‡å‘é“¾è¡¨ä¸‹ä¸€é¡¹çš„nextæŒ‡é’ˆã€‚kæ˜¯voidæŒ‡é’ˆï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥æŒ‡å‘ä»»ä½•ç±»å‹ã€‚væ˜¯ä¸ªunionï¼Œå½“å®ƒçš„å€¼æ˜¯uint64_tã€int64_tæˆ–doubleç±»å‹æ—¶ï¼Œå°±ä¸å†éœ€è¦é¢å¤–çš„å­˜å‚¨ï¼Œè¿™æœ‰åˆ©äºå‡å°‘å†…å­˜ç¢ç‰‡ã€‚å½“ç„¶ï¼Œvä¹Ÿå¯ä»¥æ˜¯voidæŒ‡é’ˆï¼Œä»¥ä¾¿èƒ½å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®ã€‚ dictçš„åˆ›å»ºï¼ˆdictCreateï¼‰ 12345678910111213141516171819202122232425262728dict *dictCreate(dictType *type,void *privDataPtr)&#123;dict *d = zmalloc(sizeof(*d)); _dictInit(d,type,privDataPtr); return d;&#125;int _dictInit(dict *d, dictType *type,void *privDataPtr)&#123;_dictReset(&amp;d-&gt;ht[0]);_dictReset(&amp;d-&gt;ht[1]);d-&gt;type = type;d-&gt;privdata = privDataPtr;d-&gt;rehashidx = -1;d-&gt;iterators = 0;return DICT_OK;&#125;static void _dictReset(dictht *ht)&#123;ht-&gt;table = NULL;ht-&gt;size = 0;ht-&gt;sizemask = 0;ht-&gt;used = 0;&#125; dictCreateä¸ºdictçš„æ•°æ®ç»“æ„åˆ†é…ç©ºé—´å¹¶ä¸ºå„ä¸ªå˜é‡èµ‹åˆå€¼ã€‚å…¶ä¸­ä¸¤ä¸ªå“ˆå¸Œè¡¨ht[0]å’Œht[1]èµ·å§‹éƒ½æ²¡æœ‰åˆ†é…ç©ºé—´ï¼ŒtableæŒ‡é’ˆéƒ½èµ‹ä¸ºNULLã€‚è¿™æ„å‘³ç€è¦ç­‰ç¬¬ä¸€ä¸ªæ•°æ®æ’å…¥æ—¶æ‰ä¼šçœŸæ­£åˆ†é…ç©ºé—´ã€‚ dictçš„æŸ¥æ‰¾ï¼ˆdictFindï¼‰ 12345678910111213141516171819202122#define dictIsRehashing(d) ((d)-&gt;rehashidx != -1)dictEntry *dictFind(dict *d, const void *key)&#123;dictEntry *he;unsigned int h, idx, table; if (d-&gt;ht[0].used + d-&gt;ht[1].used == 0) return NULL; /* dict is empty */ if (dictIsRehashing(d)) _dictRehashStep(d); h = dictHashKey(d, key); for (table = 0; table &lt;= 1; table++) &#123; idx = h &amp; d-&gt;ht[table].sizemask; he = d-&gt;ht[table].table[idx]; while(he) &#123; if (key==he-&gt;key || dictCompareKeys(d, key, he-&gt;key)) return he; he = he-&gt;next; &#125; if (!dictIsRehashing(d)) return NULL; &#125; return NULL;&#125; ä¸Šè¿°dictFindçš„æºç ï¼Œæ ¹æ®dictå½“å‰æ˜¯å¦æ­£åœ¨é‡å“ˆå¸Œï¼Œä¾æ¬¡åšäº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š å¦‚æœå½“å‰æ­£åœ¨è¿›è¡Œé‡å“ˆå¸Œï¼Œé‚£ä¹ˆå°†é‡å“ˆå¸Œè¿‡ç¨‹å‘å‰æ¨è¿›ä¸€æ­¥ï¼ˆå³è°ƒç”¨_dictRehashStepï¼‰ã€‚å®é™…ä¸Šï¼Œé™¤äº†æŸ¥æ‰¾ï¼Œæ’å…¥å’Œåˆ é™¤ä¹Ÿéƒ½ä¼šè§¦å‘è¿™ä¸€åŠ¨ä½œã€‚è¿™å°±å°†é‡å“ˆå¸Œè¿‡ç¨‹åˆ†æ•£åˆ°å„ä¸ªæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤æ“ä½œä¸­å»äº†ï¼Œè€Œä¸æ˜¯é›†ä¸­åœ¨æŸä¸€ä¸ªæ“ä½œä¸­ä¸€æ¬¡æ€§åšå®Œã€‚è®¡ç®—keyçš„å“ˆå¸Œå€¼ï¼ˆè°ƒç”¨dictHashKeyï¼Œé‡Œé¢çš„å®ç°ä¼šè°ƒç”¨å‰é¢æåˆ°çš„hashFunctionï¼‰ã€‚å…ˆåœ¨ç¬¬ä¸€ä¸ªå“ˆå¸Œè¡¨ht[0]ä¸Šè¿›è¡ŒæŸ¥æ‰¾ã€‚åœ¨tableæ•°ç»„ä¸Šå®šä½åˆ°å“ˆå¸Œå€¼å¯¹åº”çš„ä½ç½®ï¼ˆå¦‚å‰æ‰€è¿°ï¼Œé€šè¿‡å“ˆå¸Œå€¼ä¸sizemaskè¿›è¡ŒæŒ‰ä½ä¸ï¼‰ï¼Œç„¶ååœ¨å¯¹åº”çš„dictEntryé“¾è¡¨ä¸Šè¿›è¡ŒæŸ¥æ‰¾ã€‚æŸ¥æ‰¾çš„æ—¶å€™éœ€è¦å¯¹keyè¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ—¶å€™è°ƒç”¨dictCompareKeysï¼Œå®ƒé‡Œé¢çš„å®ç°ä¼šè°ƒç”¨åˆ°å‰é¢æåˆ°çš„keyCompareã€‚å¦‚æœæ‰¾åˆ°å°±è¿”å›è¯¥é¡¹ã€‚å¦åˆ™ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥ã€‚åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨é‡å“ˆå¸Œï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆåœ¨ht[0]ä¸Šçš„æŸ¥æ‰¾ç»“æœå°±æ˜¯æœ€ç»ˆç»“æœï¼ˆæ²¡æ‰¾åˆ°ï¼Œè¿”å›NULLï¼‰ã€‚å¦åˆ™ï¼Œåœ¨ht[1]ä¸Šè¿›è¡ŒæŸ¥æ‰¾ï¼ˆè¿‡ç¨‹ä¸ä¸Šä¸€æ­¥ç›¸åŒï¼‰ã€‚ä¸‹é¢æˆ‘ä»¬æœ‰å¿…è¦çœ‹ä¸€ä¸‹å¢é‡å¼é‡å“ˆå¸Œçš„_dictRehashStepçš„å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748static void _dictRehashStep(dict *d) &#123;if (d-&gt;iterators == 0) dictRehash(d,1);&#125;int dictRehash(dict *d, int n) &#123;int empty_visits = n*10; /* Max number of empty buckets to visit. */if (!dictIsRehashing(d)) return 0; while(n-- &amp;&amp; d-&gt;ht[0].used != 0) &#123; dictEntry *de, *nextde; /* Note that rehashidx can&#x27;t overflow as we are sure there are more * elements because ht[0].used != 0 */ assert(d-&gt;ht[0].size &gt; (unsigned long)d-&gt;rehashidx); while(d-&gt;ht[0].table[d-&gt;rehashidx] == NULL) &#123; d-&gt;rehashidx++; if (--empty_visits == 0) return 1; &#125; de = d-&gt;ht[0].table[d-&gt;rehashidx]; /* Move all the keys in this bucket from the old to the new hash HT */ while(de) &#123; unsigned int h; nextde = de-&gt;next; /* Get the index in the new hash table */ h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[1].sizemask; de-&gt;next = d-&gt;ht[1].table[h]; d-&gt;ht[1].table[h] = de; d-&gt;ht[0].used--; d-&gt;ht[1].used++; de = nextde; &#125; d-&gt;ht[0].table[d-&gt;rehashidx] = NULL; d-&gt;rehashidx++; &#125; /* Check if we already rehashed the whole table... */ if (d-&gt;ht[0].used == 0) &#123; zfree(d-&gt;ht[0].table); d-&gt;ht[0] = d-&gt;ht[1]; _dictReset(&amp;d-&gt;ht[1]); d-&gt;rehashidx = -1; return 0; &#125; /* More to rehash... */ return 1;&#125; dictRehashæ¯æ¬¡å°†é‡å“ˆå¸Œè‡³å°‘å‘å‰æ¨è¿›næ­¥ï¼ˆé™¤éä¸åˆ°næ­¥æ•´ä¸ªé‡å“ˆå¸Œå°±ç»“æŸäº†ï¼‰ï¼Œæ¯ä¸€æ­¥éƒ½å°†ht[0]ä¸ŠæŸä¸€ä¸ªbucketï¼ˆå³ä¸€ä¸ªdictEntryé“¾è¡¨ï¼‰ä¸Šçš„æ¯ä¸€ä¸ªdictEntryç§»åŠ¨åˆ°ht[1]ä¸Šï¼Œå®ƒåœ¨ht[1]ä¸Šçš„æ–°ä½ç½®æ ¹æ®ht[1]çš„sizemaskè¿›è¡Œé‡æ–°è®¡ç®—ã€‚rehashidxè®°å½•äº†å½“å‰å°šæœªè¿ç§»ï¼ˆæœ‰å¾…è¿ç§»ï¼‰çš„ht[0]çš„bucketä½ç½®ã€‚ å¦‚æœdictRehashè¢«è°ƒç”¨çš„æ—¶å€™ï¼ŒrehashidxæŒ‡å‘çš„bucketé‡Œä¸€ä¸ªdictEntryä¹Ÿæ²¡æœ‰ï¼Œé‚£ä¹ˆå®ƒå°±æ²¡æœ‰å¯è¿ç§»çš„æ•°æ®ã€‚è¿™æ—¶å®ƒå°è¯•åœ¨ht[0].tableæ•°ç»„ä¸­ä¸æ–­å‘åéå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸‹ä¸€ä¸ªå­˜æœ‰æ•°æ®çš„bucketä½ç½®ã€‚å¦‚æœä¸€ç›´æ‰¾ä¸åˆ°ï¼Œåˆ™æœ€å¤šèµ°n*10æ­¥ï¼Œæœ¬æ¬¡é‡å“ˆå¸Œæš‚å‘Šç»“æŸã€‚ æœ€åï¼Œå¦‚æœht[0]ä¸Šçš„æ•°æ®éƒ½è¿ç§»åˆ°ht[1]ä¸Šäº†ï¼ˆå³d-&gt;ht[0].used == 0ï¼‰ï¼Œé‚£ä¹ˆæ•´ä¸ªé‡å“ˆå¸Œç»“æŸï¼Œht[0]å˜æˆht[1]çš„å†…å®¹ï¼Œè€Œht[1]é‡ç½®ä¸ºç©ºã€‚ æ ¹æ®ä»¥ä¸Šå¯¹äºé‡å“ˆå¸Œè¿‡ç¨‹çš„åˆ†æï¼Œæˆ‘ä»¬å®¹æ˜“çœ‹å‡ºï¼Œæœ¬æ–‡å‰é¢çš„dictç»“æ„å›¾ä¸­æ‰€å±•ç¤ºçš„æ­£æ˜¯rehashidx=2æ—¶çš„æƒ…å†µï¼Œå‰é¢ä¸¤ä¸ªbucketï¼ˆht[0].table[0]å’Œht[0].table[1]ï¼‰éƒ½å·²ç»è¿ç§»åˆ°ht[1]ä¸Šå»äº†ã€‚ dictçš„æ’å…¥ï¼ˆdictAddå’ŒdictReplaceï¼‰dictAddæ’å…¥æ–°çš„ä¸€å¯¹keyå’Œvalueï¼Œå¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œåˆ™æ’å…¥å¤±è´¥ã€‚ dictReplaceä¹Ÿæ˜¯æ’å…¥ä¸€å¯¹keyå’Œvalueï¼Œä¸è¿‡åœ¨keyå­˜åœ¨çš„æ—¶å€™ï¼Œå®ƒä¼šæ›´æ–°valueã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960int dictAdd(dict *d, void *key, void *val)&#123;dictEntry *entry = dictAddRaw(d,key); if (!entry) return DICT_ERR; dictSetVal(d, entry, val); return DICT_OK;&#125;dictEntry *dictAddRaw(dict *d, void *key)&#123;int index;dictEntry *entry;dictht *ht; if (dictIsRehashing(d)) _dictRehashStep(d); /* Get the index of the new element, or -1 if * the element already exists. */ if ((index = _dictKeyIndex(d, key)) == -1) return NULL; /* Allocate the memory and store the new entry. * Insert the element in top, with the assumption that in a database * system it is more likely that recently added entries are accessed * more frequently. */ ht = dictIsRehashing(d) ? &amp;d-&gt;ht[1] : &amp;d-&gt;ht[0]; entry = zmalloc(sizeof(*entry)); entry-&gt;next = ht-&gt;table[index]; ht-&gt;table[index] = entry; ht-&gt;used++; /* Set the hash entry fields. */ dictSetKey(d, entry, key); return entry;&#125;static int _dictKeyIndex(dict *d, const void *key)&#123;unsigned int h, idx, table;dictEntry *he; /* Expand the hash table if needed */ if (_dictExpandIfNeeded(d) == DICT_ERR) return -1; /* Compute the key hash value */ h = dictHashKey(d, key); for (table = 0; table &lt;= 1; table++) &#123; idx = h &amp; d-&gt;ht[table].sizemask; /* Search if this slot does not already contain the given key */ he = d-&gt;ht[table].table[idx]; while(he) &#123; if (key==he-&gt;key || dictCompareKeys(d, key, he-&gt;key)) return -1; he = he-&gt;next; &#125; if (!dictIsRehashing(d)) break; &#125; return idx;&#125; ä»¥ä¸Šæ˜¯dictAddçš„å…³é”®å®ç°ä»£ç ã€‚æˆ‘ä»¬ä¸»è¦éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š å®ƒä¹Ÿä¼šè§¦å‘æ¨è¿›ä¸€æ­¥é‡å“ˆå¸Œï¼ˆ_dictRehashStepï¼‰ã€‚å¦‚æœæ­£åœ¨é‡å“ˆå¸Œä¸­ï¼Œå®ƒä¼šæŠŠæ•°æ®æ’å…¥åˆ°ht[1]ï¼›å¦åˆ™æ’å…¥åˆ°ht[0]ã€‚åœ¨å¯¹åº”çš„bucketä¸­æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œæ€»æ˜¯æ’å…¥åˆ°dictEntryçš„å¤´éƒ¨ã€‚å› ä¸ºæ–°æ•°æ®æ¥ä¸‹æ¥è¢«è®¿é—®çš„æ¦‚ç‡å¯èƒ½æ¯”è¾ƒé«˜ï¼Œè¿™æ ·å†æ¬¡æŸ¥æ‰¾å®ƒæ—¶å°±æ¯”è¾ƒæ¬¡æ•°è¾ƒå°‘ã€‚_dictKeyIndexåœ¨dictä¸­å¯»æ‰¾æ’å…¥ä½ç½®ã€‚å¦‚æœä¸åœ¨é‡å“ˆå¸Œè¿‡ç¨‹ä¸­ï¼Œå®ƒåªæŸ¥æ‰¾ht[0]ï¼›å¦åˆ™æŸ¥æ‰¾ht[0]å’Œht[1]ã€‚_dictKeyIndexå¯èƒ½è§¦å‘dictå†…å­˜æ‰©å±•ï¼ˆ_dictExpandIfNeededï¼Œå®ƒå°†å“ˆå¸Œè¡¨é•¿åº¦æ‰©å±•ä¸ºåŸæ¥ä¸¤å€ï¼Œå…·ä½“è¯·å‚è€ƒdict.cä¸­æºç ï¼‰ã€‚dictReplaceåœ¨dictAddåŸºç¡€ä¸Šå®ç°ï¼Œå¦‚ä¸‹ï¼š 1234567891011121314151617181920int dictReplace(dict *d, void *key, void *val)&#123;dictEntry *entry, auxentry; /* Try to add the element. If the key * does not exists dictAdd will suceed. */ if (dictAdd(d, key, val) == DICT_OK) return 1; /* It already exists, get the entry */ entry = dictFind(d, key); /* Set the new value and free the old one. Note that it is important * to do that in this order, as the value may just be exactly the same * as the previous one. In this context, think to reference counting, * you want to increment (set), and then decrement (free), and not the * reverse. */ auxentry = *entry; dictSetVal(d, entry, val); dictFreeVal(d, &amp;auxentry); return 0;&#125; åœ¨keyå·²ç»å­˜åœ¨çš„æƒ…å†µä¸‹ï¼ŒdictReplaceä¼šåŒæ—¶è°ƒç”¨dictAddå’ŒdictFindï¼Œè¿™å…¶å®ç›¸å½“äºä¸¤æ¬¡æŸ¥æ‰¾è¿‡ç¨‹ã€‚è¿™é‡ŒRedisçš„ä»£ç ä¸å¤Ÿä¼˜åŒ–ã€‚ dictçš„åˆ é™¤ï¼ˆdictDeleteï¼‰dictDeleteçš„æºç è¿™é‡Œå¿½ç•¥ï¼Œå…·ä½“è¯·å‚è€ƒdict.cã€‚éœ€è¦ç¨åŠ æ³¨æ„çš„æ˜¯ï¼š dictDeleteä¹Ÿä¼šè§¦å‘æ¨è¿›ä¸€æ­¥é‡å“ˆå¸Œï¼ˆ_dictRehashStepï¼‰å¦‚æœå½“å‰ä¸åœ¨é‡å“ˆå¸Œè¿‡ç¨‹ä¸­ï¼Œå®ƒåªåœ¨ht[0]ä¸­æŸ¥æ‰¾è¦åˆ é™¤çš„keyï¼›å¦åˆ™ht[0]å’Œht[1]å®ƒéƒ½è¦æŸ¥æ‰¾ã€‚åˆ é™¤æˆåŠŸåä¼šè°ƒç”¨keyå’Œvalueçš„ææ„å‡½æ•°ï¼ˆkeyDestructorå’ŒvalDestructorï¼‰ã€‚","categories":[{"name":"5.ç¼“å­˜","slug":"5-ç¼“å­˜","permalink":"https://zhangxin66666.github.io/categories/5-%E7%BC%93%E5%AD%98/"}],"tags":[{"name":"redis","slug":"redis","permalink":"https://zhangxin66666.github.io/tags/redis/"}]},{"title":"redisé¢è¯•","slug":"5.ç¼“å­˜/é¢è¯•-redis","date":"2024-12-24T16:00:00.000Z","updated":"2024-12-26T02:00:51.617Z","comments":true,"path":"2024/12/25/5.ç¼“å­˜/é¢è¯•-redis/","link":"","permalink":"https://zhangxin66666.github.io/2024/12/25/5.%E7%BC%93%E5%AD%98/%E9%9D%A2%E8%AF%95-redis/","excerpt":"","text":"1.redisåŸºæœ¬æ•°æ®ç±»å‹åŠå¸¸ç”¨åœºæ™¯2.redisæ•°æ®ç±»å‹åº•å±‚æ•°æ®ç»“æ„3.rediså•çº¿ç¨‹ä¸ºä»€ä¹ˆå¿«redisçš„é€Ÿåº¦éå¸¸çš„å¿«ï¼Œå•æœºçš„rediså°±å¯ä»¥æ”¯æ’‘æ¯ç§’10å‡ ä¸‡çš„å¹¶å‘ï¼Œç›¸å¯¹äºmysqlæ¥è¯´ï¼Œæ€§èƒ½æ˜¯mysqlçš„å‡ åå€ã€‚é€Ÿåº¦å¿«çš„åŸå› ä¸»è¦æœ‰å‡ ç‚¹ï¼š å®Œå…¨åŸºäºå†…å­˜æ“ä½œ Cè¯­è¨€å®ç°ï¼Œä¼˜åŒ–è¿‡çš„æ•°æ®ç»“æ„ï¼ŒåŸºäºå‡ ç§åŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œredisåšäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œæ€§èƒ½æé«˜ ä½¿ç”¨å•çº¿ç¨‹ï¼Œæ— ä¸Šä¸‹æ–‡çš„åˆ‡æ¢æˆæœ¬ åŸºäºéé˜»å¡çš„IOå¤šè·¯å¤ç”¨æœºåˆ¶ 4.rediså•çº¿ç¨‹æ¨¡å‹5.é‚£ä¸ºä»€ä¹ˆRedis6.0ä¹‹ååˆæ”¹ç”¨å¤šçº¿ç¨‹å‘¢?redisä½¿ç”¨å¤šçº¿ç¨‹å¹¶éæ˜¯å®Œå…¨æ‘’å¼ƒå•çº¿ç¨‹ï¼Œredisè¿˜æ˜¯ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œåªæ˜¯ä½¿ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†æ•°æ®çš„è¯»å†™å’Œåè®®è§£æï¼Œæ‰§è¡Œå‘½ä»¤è¿˜æ˜¯ä½¿ç”¨å•çº¿ç¨‹ã€‚ è¿™æ ·åšçš„ç›®çš„æ˜¯å› ä¸ºredisçš„æ€§èƒ½ç“¶é¢ˆåœ¨äºç½‘ç»œIOè€ŒéCPUï¼Œä½¿ç”¨å¤šçº¿ç¨‹èƒ½æå‡IOè¯»å†™çš„æ•ˆç‡ï¼Œä»è€Œæ•´ä½“æé«˜redisçš„æ€§èƒ½ã€‚ 6.ç¼“å­˜é›ªå´©ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜ç©¿é€åŠè§£å†³æ–¹æ¡ˆ ç¼“å­˜é›ªå´©ï¼šç¼“å­˜åŒä¸€æ—¶é—´å¤§é¢ç§¯å¤±æ•ˆï¼Œåé¢è¯·æ±‚éƒ½è½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆå¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚ è¿‡æœŸæ—¶é—´éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸ ç¼“å­˜é¢„çƒ­ï¼šé¡¹ç›®å¯åŠ¨åŠ è½½ç¼“å­˜åˆ°redis äº’æ–¥é”ï¼šä¿®æ”¹çš„æ—¶å€™åªå…è®¸ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æ•°æ®åº“ï¼Œå…¶ä»–è¯»å†™çº¿ç¨‹ç­‰å¾… åŠ ç›¸åº”ç¼“å­˜æ ‡è®°ï¼Œè®°å½•ç¼“å­˜æ˜¯å¦å¤±æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œæ›´æ–°ç¼“å­˜(å†…å­˜æ¶ˆè€—å¤§ï¼Œä¸€èˆ¬ä¸ç”¨) ç¼“å­˜ç©¿é€ï¼šæŒ‡æ•°æ®åº“æ²¡æœ‰æ•°æ®ï¼Œå¯¼è‡´è¯·æ±‚è½åˆ°æ•°æ®åº“ä¸Š æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œå¯¹idè¿›è¡Œè§„åˆ™æ‹¦æˆª ç¼“å­˜å–ä¸åˆ°æ•°æ®ï¼Œè®¾ç½®nullå€¼åˆ°ç¼“å­˜ï¼Œè®¾ç½®çŸ­æ—¶é—´è¶…æ—¶ï¼Œé˜²æ­¢ç½‘ç»œæ”»å‡» å¸ƒéš†è¿‡æ»¤å™¨ï¼Œæ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„bitmapä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®å°±ä¼šè¢«è¿™ä¸ªbitmapæ‹¦æˆª ç¼“å­˜å‡»ç©¿ï¼šç¼“å­˜æ²¡æœ‰ï¼Œæ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ç¼“å­˜æ—¶é—´åˆ°æœŸï¼‰ï¼Œå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶å¤§é‡è¯·æ±‚è½åˆ°æ•°æ®åº“ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥è¯¢åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸ keyä¸è¿‡æœŸ åŠ äº’æ–¥é” 7.å¤§key8.çƒ­key9.Redisçš„è¿‡æœŸç­–ç•¥æœ‰å“ªäº›10.redisæ·˜æ±°ç­–ç•¥ï¼Ÿï¼ˆåŒé—®é¢˜å®šæœŸ+æƒ°æ€§éƒ½æ²¡æœ‰åˆ é™¤è¿‡æœŸçš„keyæ€ä¹ˆåŠï¼Ÿï¼‰11.redisåˆ†å¸ƒå¼é”ã€zkåˆ†å¸ƒå¼é”ï¼ˆæ™®é€šã€æœ‰åºä¸¤ç§ï¼‰ã€redissionåˆ†å¸ƒå¼é”12.redisæŒä¹…åŒ–ä¸¤ç§æ–¹å¼ï¼ˆAOF&amp;RDBï¼‰RDBçš„åŸç†æ˜¯ä»€ä¹ˆ ç»™å‡ºä¸¤ä¸ªè¯æ±‡å°±å¯ä»¥äº†ï¼Œforkå’Œcowã€‚forkæ˜¯æŒ‡redisé€šè¿‡åˆ›å»ºå­è¿›ç¨‹æ¥è¿›è¡ŒRDBæ“ä½œï¼ŒcowæŒ‡çš„æ˜¯copy on writeï¼Œå­è¿›ç¨‹åˆ›å»ºåï¼Œçˆ¶å­è¿›ç¨‹å…±äº«æ•°æ®æ®µï¼Œçˆ¶è¿›ç¨‹ç»§ç»­æä¾›è¯»å†™æœåŠ¡ï¼Œå†™è„çš„é¡µé¢æ•°æ®ä¼šé€æ¸å’Œå­è¿›ç¨‹åˆ†ç¦»å¼€æ¥ã€‚ æ³¨ï¼šå›ç­”è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œå¦‚æœä½ è¿˜èƒ½è¯´å‡ºAOFå’ŒRDBçš„ä¼˜ç¼ºç‚¹ï¼Œæˆ‘è§‰å¾—æˆ‘æ˜¯é¢è¯•å®˜åœ¨è¿™ä¸ªé—®é¢˜ä¸Šæˆ‘ä¼šç»™ä½ ç‚¹èµï¼Œä¸¤è€…å…¶å®åŒºåˆ«è¿˜æ˜¯å¾ˆå¤§çš„ 13.redisä¸»ä»å¤åˆ¶åŸç†ï¼ˆå…¨é‡åŒæ­¥&amp;å¢é‡åŒæ­¥ï¼‰14.rediså“¨å…µæ¨¡å¼15.redisé›†ç¾¤æ¨¡å¼16.ä¸€è‡´æ€§hash17.rediså’Œæ•°æ®åº“æ•°æ®ä¸€è‡´æ€§é—®é¢˜18.BloomFilterè¿‡æ»¤å™¨åŸç†19.åœºæ™¯é¢˜æ’è¡Œæ¦œï¼ˆå¤šç»´åº¦ï¼‰ ç­¾åˆ° rediså®ç°æ¶ˆæ¯é˜Ÿåˆ— ä¸€èˆ¬ä½¿ç”¨listç»“æ„ä½œä¸ºé˜Ÿåˆ—ï¼Œrpushç”Ÿäº§æ¶ˆæ¯ï¼Œlpopæ¶ˆè´¹æ¶ˆæ¯ã€‚å½“lpopæ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¦é€‚å½“sleepä¸€ä¼šå†é‡è¯•ã€‚ å¦‚æœå¯¹æ–¹è¿½é—®å¯ä¸å¯ä»¥ä¸ç”¨sleepå‘¢ï¼Ÿ listè¿˜æœ‰ä¸ªæŒ‡ä»¤å«blpopï¼Œåœ¨æ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒä¼šé˜»å¡ä½ç›´åˆ°æ¶ˆæ¯åˆ°æ¥ã€‚ å¦‚æœå¯¹æ–¹æ¥ç€è¿½é—®èƒ½ä¸èƒ½ç”Ÿäº§ä¸€æ¬¡æ¶ˆè´¹å¤šæ¬¡å‘¢ï¼Ÿ ä½¿ç”¨pub/subä¸»é¢˜è®¢é˜…è€…æ¨¡å¼ï¼Œå¯ä»¥å®ç° 1:N çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ å¦‚æœå¯¹æ–¹ç»§ç»­è¿½é—® pub/su bæœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ åœ¨æ¶ˆè´¹è€…ä¸‹çº¿çš„æƒ…å†µä¸‹ï¼Œç”Ÿäº§çš„æ¶ˆæ¯ä¼šä¸¢å¤±ï¼Œå¾—ä½¿ç”¨ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—å¦‚RocketMQç­‰ã€‚ å¦‚æœå¯¹æ–¹ç©¶æTMè¿½é—®Rediså¦‚ä½•å®ç°å»¶æ—¶é˜Ÿåˆ—ï¼Ÿ ä½¿ç”¨sortedsetï¼Œæ‹¿æ—¶é—´æˆ³ä½œä¸ºscoreï¼Œæ¶ˆæ¯å†…å®¹ä½œä¸ºkeyè°ƒç”¨zaddæ¥ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ç”¨zrangebyscoreæŒ‡ä»¤è·å–Nç§’ä¹‹å‰çš„æ•°æ®è½®è¯¢è¿›è¡Œå¤„ç†ã€‚ Rediså•çº¿ç¨‹æ¨¡å‹RedisåŸºäºReactoræ¨¡å¼å¼€å‘çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ˜¯å•çº¿ç¨‹çš„ï¼Œé‡‡ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶ç›‘å¬å¤šä¸ªSockerï¼Œæ ¹æ®Sockerä¸Šçš„äº‹ä»¶ç±»å‹é€‰æ‹©å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œå¯ä»¥å®ç°é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡ã€‚æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨åŒ…å«4ä¸ªéƒ¨åˆ†ï¼Œå¤šä¸ªSockerï¼ŒIOå¤šè·¯å¤ç”¨ç¨‹åºï¼Œæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨å’Œäº‹ä»¶å¤„ç†å™¨(å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ï¼Œå‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œé“¾æ¥åº”ç­”å¤„ç†å™¨)ï¼Œå¤šä¸ªSocketå¯èƒ½å¹¶å‘äº§ç”Ÿä¸åŒæ“ä½œï¼Œæ¯ä¸ªæ“ä½œå¯¹åº”ä¸åŒçš„æ–‡ä»¶äº‹ä»¶ï¼Œä½†æ˜¯IOå¤šè·¯å¤ç”¨ä¼šç›‘å¬å¤šä¸ªSocketï¼Œä¼šå°†Socketæ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¯æ¬¡ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªSocketç»™æ—¶é—´åˆ†æ´¾å™¨ï¼Œæ—¶é—´åˆ†æ´¾å™¨æŠŠSocketç»™å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚ å•çº¿ç¨‹å¿«çš„åŸå› ï¼š1.çº¯å†…å­˜æ“ä½œï¼›2.æ ¸å¿ƒæ˜¯åŸºäºéé˜»å¡çš„IOå¤šè·¯å¤ç”¨æœºåˆ¶ï¼›3.å•çº¿ç¨‹åè€Œé¿å…å¤šçº¿ç¨‹çš„é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢ åˆ†å¸ƒå¼é”æ€ä¹ˆå®ç°çš„ï¼Ÿ åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”ï¼šå”¯ä¸€ç´¢å¼•ï¼ŒçŠ¶æ€æœºå”¯ä¸€è”åˆç´¢å¼• åŸºäºç¼“å­˜ï¼ˆRedisç­‰ï¼‰å®ç°åˆ†å¸ƒå¼é”ï¼šSET key value NX PX 30000 åŸºäºZookeeperå®ç°åˆ†å¸ƒå¼é”ï¼› setnxç”¨åˆ°çš„å‚æ•°SET key value NX PX 30000 ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæŠŠkeyã€value setåˆ°redisä¸­çš„ç­–ç•¥ nx ï¼š not exists, åªæœ‰key ä¸å­˜åœ¨æ—¶æ‰æŠŠkey value set åˆ°redis xx ï¼š is exists ï¼Œåªæœ‰ key å­˜åœ¨æ˜¯ï¼Œæ‰æŠŠkey value set åˆ°redis ç¬¬å››ä¸ªå‚æ•°ï¼šè¿‡æœŸæ—¶é—´å•ä½ ex ï¼šseconds ç§’ px : milliseconds æ¯«ç§’ ä½¿ç”¨å…¶ä»–å€¼ï¼ŒæŠ›å‡º å¼‚å¸¸ ï¼š redis.clients.jedis.exceptions.JedisDataException : ERR syntax error ç¬¬äº”ä¸ªå‚æ•°ï¼šæœ‰ä¸¤ç§å¯é€‰çš„å€¼ï¼Œ int å’Œlong çš„timeï¼Œéƒ½æ˜¯è¿‡æœŸæ—¶é—´ ï¼Œexpx å‚æ•°æ˜¯pxçš„æ—¶å€™ï¼Œä½¿ç”¨longç±»å‹çš„å‚æ•°ï¼Œå¯ä»¥è¡¨ç¤ºæ›´å¤šæ—¶é—´ - Redisè¿‡æœŸé”®åˆ é™¤ç­–ç•¥Rediså¯¹äºè¿‡æœŸé”®æœ‰ä¸‰ç§æ¸…é™¤ç­–ç•¥ï¼š è¢«åŠ¨åˆ é™¤ï¼šå½“è¯»/å†™ä¸€ä¸ªå·²ç»è¿‡æœŸçš„keyæ—¶ï¼Œä¼šè§¦å‘æƒ°æ€§åˆ é™¤ç­–ç•¥ï¼Œç›´æ¥åˆ é™¤æ‰è¿™ä¸ªè¿‡æœŸkey ä¸»åŠ¨åˆ é™¤ï¼šç”±äºæƒ°æ€§åˆ é™¤ç­–ç•¥æ— æ³•ä¿è¯å†·æ•°æ®è¢«åŠæ—¶åˆ æ‰ï¼Œæ‰€ä»¥Redisä¼šå®šæœŸä¸»åŠ¨æ·˜æ±°ä¸€æ‰¹å·²è¿‡æœŸçš„key å½“å‰å·²ç”¨å†…å­˜è¶…è¿‡maxmemoryé™å®šæ—¶ï¼Œè§¦å‘ä¸»åŠ¨æ¸…ç†ç­–ç•¥ ä¸»åŠ¨æ¸…ç†ç­–ç•¥åœ¨Redis 4.0 ä¹‹å‰ä¸€å…±å®ç°äº† 6 ç§å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œåœ¨ 4.0 ä¹‹åï¼Œåˆå¢åŠ äº† 2 ç§ç­–ç•¥ï¼Œæ€»å…±8ç§ï¼š a) é’ˆå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyåšå¤„ç†ï¼š volatile-ttlï¼šåœ¨ç­›é€‰æ—¶ï¼Œä¼šé’ˆå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ï¼Œæ ¹æ®è¿‡æœŸæ—¶é—´çš„å…ˆåè¿›è¡Œåˆ é™¤ï¼Œè¶Šæ—©è¿‡æœŸçš„è¶Šå…ˆè¢«åˆ é™¤ã€‚ volatile-randomï¼šå°±åƒå®ƒçš„åç§°ä¸€æ ·ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ä¸­ï¼Œè¿›è¡Œéšæœºåˆ é™¤ã€‚ volatile-lruï¼šä¼šä½¿ç”¨ LRU ç®—æ³•ç­›é€‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹åˆ é™¤ã€‚ volatile-lfuï¼šä¼šä½¿ç”¨ LFU ç®—æ³•ç­›é€‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹åˆ é™¤ã€‚ b) é’ˆå¯¹æ‰€æœ‰çš„keyåšå¤„ç†ï¼š allkeys-randomï¼šä»æ‰€æœ‰é”®å€¼å¯¹ä¸­éšæœºé€‰æ‹©å¹¶åˆ é™¤æ•°æ®ã€‚ allkeys-lruï¼šä½¿ç”¨ LRU ç®—æ³•åœ¨æ‰€æœ‰æ•°æ®ä¸­è¿›è¡Œç­›é€‰åˆ é™¤ã€‚ allkeys-lfuï¼šä½¿ç”¨ LFU ç®—æ³•åœ¨æ‰€æœ‰æ•°æ®ä¸­è¿›è¡Œç­›é€‰åˆ é™¤ã€‚ c) ä¸å¤„ç†ï¼š noevictionï¼šä¸ä¼šå‰”é™¤ä»»ä½•æ•°æ®ï¼Œæ‹’ç»æ‰€æœ‰å†™å…¥æ“ä½œå¹¶è¿”å›å®¢æˆ·ç«¯é”™è¯¯ä¿¡æ¯â€(error) OOM command not allowed when used memoryâ€ï¼Œæ­¤æ—¶Redisåªå“åº”è¯»æ“ä½œã€‚ LRU ç®—æ³•ï¼ˆLeast Recently Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ æ·˜æ±°å¾ˆä¹…æ²¡è¢«è®¿é—®è¿‡çš„æ•°æ®ï¼Œä»¥æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ä½œä¸ºå‚è€ƒã€‚ LFU ç®—æ³•ï¼ˆLeast Frequently Usedï¼Œæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ æ·˜æ±°æœ€è¿‘ä¸€æ®µæ—¶é—´è¢«è®¿é—®æ¬¡æ•°æœ€å°‘çš„æ•°æ®ï¼Œä»¥æ¬¡æ•°ä½œä¸ºå‚è€ƒã€‚ å½“å­˜åœ¨çƒ­ç‚¹æ•°æ®æ—¶ï¼ŒLRUçš„æ•ˆç‡å¾ˆå¥½ï¼Œä½†å¶å‘æ€§çš„ã€å‘¨æœŸæ€§çš„æ‰¹é‡æ“ä½œä¼šå¯¼è‡´LRUå‘½ä¸­ç‡æ€¥å‰§ä¸‹é™ï¼Œç¼“å­˜æ±¡æŸ“æƒ…å†µæ¯”è¾ƒä¸¥é‡ã€‚è¿™æ—¶ä½¿ç”¨LFUå¯èƒ½æ›´å¥½ç‚¹ã€‚æ ¹æ®è‡ªèº«ä¸šåŠ¡ç±»å‹ï¼Œé…ç½®å¥½maxmemory-policy(é»˜è®¤æ˜¯noeviction)ï¼Œæ¨èä½¿ç”¨volatile-lruã€‚å¦‚æœä¸è®¾ç½®æœ€å¤§å†…å­˜ï¼Œå½“ Redis å†…å­˜è¶…å‡ºç‰©ç†å†…å­˜é™åˆ¶æ—¶ï¼Œå†…å­˜çš„æ•°æ®ä¼šå¼€å§‹å’Œç£ç›˜äº§ç”Ÿé¢‘ç¹çš„äº¤æ¢ (swap)ï¼Œä¼šè®© Redis çš„æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚å½“Redisè¿è¡Œåœ¨ä¸»ä»æ¨¡å¼æ—¶ï¼Œåªæœ‰ä¸»ç»“ç‚¹æ‰ä¼šæ‰§è¡Œè¿‡æœŸåˆ é™¤ç­–ç•¥ï¼Œç„¶åæŠŠåˆ é™¤æ“ä½œâ€del keyâ€åŒæ­¥åˆ°ä»ç»“ç‚¹åˆ é™¤æ•°æ®ã€‚ RedisæŒä¹…åŒ– RDBå¿«ç…§(snapshot) Redis å°†å†…å­˜æ•°æ®å¿«ç…§ä¿å­˜åœ¨åå­—ä¸º dump.rdb çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚å¯ä»¥å¯¹ Redis è¿›è¡Œè®¾ç½®ï¼Œ è®©å®ƒåœ¨â€œ N ç§’å†…æ•°æ®é›†è‡³å°‘æœ‰ M ä¸ªæ”¹åŠ¨â€è¿™ä¸€æ¡ä»¶è¢«æ»¡è¶³æ—¶ï¼Œ è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡æ•°æ®ï¼›**# save 60 1000 //** (60ç§’æ”¹1000æ¬¡è¿›è¡Œä¸€æ¬¡RDBæŒä¹…åŒ–)å…³é—­RDBåªéœ€è¦å°†æ‰€æœ‰çš„saveä¿å­˜ç­–ç•¥æ³¨é‡Šæ‰å³å¯ã€‚ é—®é¢˜ï¼šä¼šé˜»å¡å®¢æˆ·ç«¯å‘½ä»¤ã€‚ è¿˜å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ç”ŸæˆRDBå¿«ç…§ï¼Œè¿›å…¥rediså®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤saveæˆ–bgsaveå¯ä»¥ç”Ÿæˆdump.rdbæ–‡ä»¶ï¼Œæ¯æ¬¡å‘½ä»¤æ‰§è¡Œéƒ½ä¼šå°†æ‰€æœ‰rediså†…å­˜å¿«ç…§åˆ°ä¸€ä¸ªæ–°çš„rdbæ–‡ä»¶é‡Œï¼Œå¹¶è¦†ç›–åŸæœ‰rdbå¿«ç…§æ–‡ä»¶ã€‚ bgsaveçš„å†™æ—¶å¤åˆ¶(COW)æœºåˆ¶ï¼šRedis å€ŸåŠ©æ“ä½œç³»ç»Ÿæä¾›çš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼ˆCopy-On-Write, COWï¼‰ï¼Œåœ¨ç”Ÿæˆå¿«ç…§çš„åŒæ—¶ï¼Œä¾ç„¶å¯ä»¥æ­£å¸¸å¤„ç†å†™å‘½ä»¤ã€‚bgsave å­è¿›ç¨‹æ˜¯ç”±ä¸»çº¿ç¨‹ fork ç”Ÿæˆçš„ï¼Œå¯ä»¥å…±äº«ä¸»çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜æ•°æ®ã€‚bgsave å­è¿›ç¨‹è¿è¡Œåï¼Œå¼€å§‹è¯»å–ä¸»çº¿ç¨‹çš„å†…å­˜æ•°æ®ï¼Œå¹¶æŠŠå®ƒä»¬å†™å…¥ RDB æ–‡ä»¶ã€‚æ­¤æ—¶ï¼Œå¦‚æœä¸»çº¿ç¨‹å¯¹è¿™äº›æ•°æ®ä¹Ÿéƒ½æ˜¯è¯»æ“ä½œï¼Œé‚£ä¹ˆï¼Œä¸»çº¿ç¨‹å’Œ bgsave å­è¿›ç¨‹ç›¸äº’ä¸å½±å“ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸»çº¿ç¨‹è¦ä¿®æ”¹ä¸€å—æ•°æ®ï¼Œé‚£ä¹ˆï¼Œè¿™å—æ•°æ®å°±ä¼šè¢«å¤åˆ¶ä¸€ä»½ï¼Œç”Ÿæˆè¯¥æ•°æ®çš„å‰¯æœ¬ã€‚ç„¶åï¼Œbgsave å­è¿›ç¨‹ä¼šæŠŠè¿™ä¸ªå‰¯æœ¬æ•°æ®å†™å…¥ RDB æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹ä»ç„¶å¯ä»¥ä¿®æ”¹åŸæ¥çš„æ•°æ®ã€‚ AOF(append-only file) å¦‚æœ Redis å› ä¸ºæŸäº›åŸå› è€Œé€ æˆæ•…éšœåœæœºï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†ä¸¢å¤±æœ€è¿‘å†™å…¥ã€ä¸”ä»æœªä¿å­˜åˆ°å¿«ç…§ä¸­çš„é‚£äº›æ•°æ®ã€‚ä» 1.1 ç‰ˆæœ¬å¼€å§‹ï¼Œ Redis å¢åŠ äº†ä¸€ç§å®Œå…¨è€ä¹…çš„æŒä¹…åŒ–æ–¹å¼ï¼š AOF æŒä¹…åŒ–ï¼Œå°†ä¿®æ”¹çš„æ¯ä¸€æ¡æŒ‡ä»¤è®°å½•è¿›æ–‡ä»¶appendonly.aofä¸­(å…ˆå†™å…¥os cacheï¼Œæ¯éš”ä¸€æ®µæ—¶é—´fsyncåˆ°ç£ç›˜) ç¼“å­˜ä¸æ•°æ®åº“æ•°æ®ä¸€è‡´æ€§ è§£å†³æ–¹æ¡ˆï¼š å¯¹äºå¹¶å‘å‡ ç‡å¾ˆå°çš„æ•°æ®(å¦‚ä¸ªäººç»´åº¦çš„è®¢å•æ•°æ®ã€ç”¨æˆ·æ•°æ®ç­‰)ï¼Œè¿™ç§å‡ ä¹ä¸ç”¨è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œå¾ˆå°‘ä¼šå‘ç”Ÿç¼“å­˜ä¸ä¸€è‡´ï¼Œå¯ä»¥ç»™ç¼“å­˜æ•°æ®åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´è§¦å‘è¯»çš„ä¸»åŠ¨æ›´æ–°å³å¯ã€‚ å°±ç®—å¹¶å‘å¾ˆé«˜ï¼Œå¦‚æœä¸šåŠ¡ä¸Šèƒ½å®¹å¿çŸ­æ—¶é—´çš„ç¼“å­˜æ•°æ®ä¸ä¸€è‡´(å¦‚å•†å“åç§°ï¼Œå•†å“åˆ†ç±»èœå•ç­‰)ï¼Œç¼“å­˜åŠ ä¸Šè¿‡æœŸæ—¶é—´ä¾ç„¶å¯ä»¥è§£å†³å¤§éƒ¨åˆ†ä¸šåŠ¡å¯¹äºç¼“å­˜çš„è¦æ±‚ã€‚ å¦‚æœä¸èƒ½å®¹å¿ç¼“å­˜æ•°æ®ä¸ä¸€è‡´ï¼Œå¯ä»¥é€šè¿‡åŠ è¯»å†™é”ä¿è¯å¹¶å‘è¯»å†™æˆ–å†™å†™çš„æ—¶å€™æŒ‰é¡ºåºæ’å¥½é˜Ÿï¼Œè¯»è¯»çš„æ—¶å€™ç›¸å½“äºæ— é”ã€‚ ä¹Ÿå¯ä»¥ç”¨é˜¿é‡Œå¼€æºçš„canalé€šè¿‡ç›‘å¬æ•°æ®åº“çš„binlogæ—¥å¿—åŠæ—¶çš„å»ä¿®æ”¹ç¼“å­˜ï¼Œä½†æ˜¯å¼•å…¥äº†æ–°çš„ä¸­é—´ä»¶ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚","categories":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"}],"tags":[{"name":"redis","slug":"redis","permalink":"https://zhangxin66666.github.io/tags/redis/"}]},{"title":"JVMé¢è¯•","slug":"3.jvm/é¢è¯•-JVM","date":"2024-12-22T16:00:00.000Z","updated":"2024-12-24T08:20:42.398Z","comments":true,"path":"2024/12/23/3.jvm/é¢è¯•-JVM/","link":"","permalink":"https://zhangxin66666.github.io/2024/12/23/3.jvm/%E9%9D%A2%E8%AF%95-JVM/","excerpt":"","text":"1.jvmå†…å­˜æ¨¡å‹ å †ï¼šå †Javaè™šæ‹Ÿæœºä¸­æœ€å¤§çš„ä¸€å—å†…å­˜ï¼Œæ˜¯çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹æ•°ç»„éƒ½æ˜¯åœ¨å †ä¸Šåˆ†é…ç©ºé—´ã€‚å †åŒºç»†åˆ†ä¸ºYoundåŒºå¹´è½»ä»£å’ŒOldåŒºè€å¹´ä»£ï¼Œå…¶ä¸­å¹´è½»ä»£åˆåˆ†ä¸ºEdenã€S0ã€S1 3ä¸ªéƒ¨åˆ†ï¼Œä»–ä»¬é»˜è®¤çš„æ¯”ä¾‹æ˜¯8:1:1çš„å¤§å°ã€‚ æ ˆï¼šæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„å†…å­˜åŒºåŸŸï¼Œæ¯ä¸ªæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåœ¨æ ˆåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹å°±å¯¹åº”ç€æ ˆçš„å…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚æ¯ä¸ªæ ˆå¸§çš„ç»“æ„åˆåŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€ã€‚ å±€éƒ¨å˜é‡è¡¨ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚å½“ç¬¬ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä»–çš„å‚æ•°ä¼šè¢«ä¼ é€’è‡³ä»0å¼€å§‹çš„è¿ç»­çš„å±€éƒ¨å˜é‡è¡¨ä¸­ã€‚ æ“ä½œæ•°æ ˆç”¨äºä¸€äº›å­—èŠ‚ç æŒ‡ä»¤ä»å±€éƒ¨å˜é‡è¡¨ä¸­ä¼ é€’è‡³æ“ä½œæ•°æ ˆï¼Œä¹Ÿç”¨æ¥å‡†å¤‡æ–¹æ³•è°ƒç”¨çš„å‚æ•°ä»¥åŠæ¥æ”¶æ–¹æ³•è¿”å›ç»“æœã€‚ åŠ¨æ€è¿æ¥ç”¨äºå°†ç¬¦å·å¼•ç”¨è¡¨ç¤ºçš„æ–¹æ³•è½¬æ¢ä¸ºå®é™…æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚ å…ƒæ•°æ®ï¼šåœ¨Java1.7ä¹‹å‰ï¼ŒåŒ…å«æ–¹æ³•åŒºçš„æ¦‚å¿µï¼Œå¸¸é‡æ± å°±å­˜åœ¨äºæ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰ä¸­ï¼Œè€Œæ–¹æ³•åŒºæœ¬èº«æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œåœ¨1.7ä¹‹ååˆ™æ˜¯æŠŠå¸¸é‡æ± ç§»åˆ°äº†å †å†…ï¼Œ1.8ä¹‹åç§»å‡ºäº†æ°¸ä¹…ä»£çš„æ¦‚å¿µ(æ–¹æ³•åŒºçš„æ¦‚å¿µä»ç„¶ä¿ç•™)ï¼Œå®ç°æ–¹å¼åˆ™æ˜¯ç°åœ¨çš„å…ƒæ•°æ®ã€‚å®ƒåŒ…å«ç±»çš„å…ƒä¿¡æ¯å’Œè¿è¡Œæ—¶å¸¸é‡æ± ã€‚ Classæ–‡ä»¶å°±æ˜¯ç±»å’Œæ¥å£çš„å®šä¹‰ä¿¡æ¯ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± å°±æ˜¯ç±»å’Œæ¥å£çš„å¸¸é‡æ± è¿è¡Œæ—¶çš„è¡¨ç°å½¢å¼ã€‚ æœ¬åœ°æ–¹æ³•æ ˆï¼šä¸»è¦ç”¨äºæ‰§è¡Œæœ¬åœ°nativeæ–¹æ³•çš„åŒºåŸŸ ç¨‹åºè®¡æ•°å™¨ï¼šä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„åŒºåŸŸï¼Œç”¨äºè®°å½•å½“å‰çº¿ç¨‹ä¸‹è™šæ‹Ÿæœºæ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç çš„æŒ‡ä»¤åœ°å€ PC å¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ 2.PCå¯„å­˜å™¨ä¸ºä»€ä¹ˆä¼šè¢«è®¾å®šä¸ºçº¿ç¨‹ç§æœ‰çš„ï¼Ÿå¤šçº¿ç¨‹åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´æ®µå†…åªä¼šæ‰§è¡Œå…¶ä¸­æŸä¸€ä¸ªçº¿ç¨‹æ–¹æ³•ï¼ŒCPUä¼šä¸åœçš„åšä»»åŠ¡åˆ‡æ¢ï¼Œè¿™æ ·å¿…ç„¶ä¼šå¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ã€‚ä¸ºäº†èƒ½å¤Ÿå‡†ç¡®çš„è®°å½•å„ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å½“å‰å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œæ‰€ä»¥ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½åˆ†é…äº†ä¸€ä¸ªPCå¯„å­˜å™¨ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ç‹¬ç«‹è®¡ç®—ï¼Œä¸ä¼šäº’ç›¸å½±å“ 3.ä»€ä¹ˆæ˜¯è™šæ‹Ÿæœºæ ˆï¼ˆçº¿ç¨‹ç§æœ‰ï¼‰ï¼Ÿä¸»ç®¡ Java ç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„æ ˆå¸§(Stack Frameï¼‰ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡ Java æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ä¸€è‡´ã€‚ ç‰¹ç‚¹ï¼Ÿ æ ˆæ˜¯ä¸€ç§å¿«é€Ÿæœ‰æ•ˆçš„åˆ†é…å­˜å‚¨æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦ä»…æ¬¡äºç¨‹åºè®¡æ•°å™¨ JVM ç›´æ¥å¯¹è™šæ‹Ÿæœºæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼šæ¯ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œä¼´éšç€å…¥æ ˆï¼ˆè¿›æ ˆ/å‹æ ˆï¼‰ï¼Œæ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆ æ ˆä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜ å¯ä»¥é€šè¿‡å‚æ•°-Xssæ¥è®¾ç½®çº¿ç¨‹çš„æœ€å¤§æ ˆç©ºé—´ï¼Œæ ˆçš„å¤§å°ç›´æ¥å†³å®šäº†å‡½æ•°è°ƒç”¨çš„æœ€å¤§å¯è¾¾æ·±åº¦ è¯¥åŒºåŸŸæœ‰å“ªäº›å¼‚å¸¸ï¼Ÿ å¦‚æœé‡‡ç”¨å›ºå®šå¤§å°çš„ Java è™šæ‹Ÿæœºæ ˆï¼Œé‚£æ¯ä¸ªçº¿ç¨‹çš„ Java è™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ç‹¬ç«‹é€‰å®šã€‚å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡ Java è™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJava è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª StackOverflowError å¼‚å¸¸ å¦‚æœ Java è™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œé‚£ Java è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªOutOfMemoryErrorå¼‚å¸¸ æ ˆå¸§çš„å†…éƒ¨ç»“æ„ï¼Ÿ å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰ æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰(æˆ–ç§°ä¸ºè¡¨è¾¾å¼æ ˆ) åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ï¼šæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨ æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰ï¼šæ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸é€€å‡ºçš„åœ°å€ ä¸€äº›é™„åŠ ä¿¡æ¯ 4.ä»€ä¹ˆæ˜¯æœ¬åœ°æ–¹æ³•æ ˆï¼ˆçº¿ç¨‹ç§æœ‰ï¼‰ï¼Ÿ æœ¬åœ°æ–¹æ³•æ¥å£ ä¸€ä¸ª Native Method å°±æ˜¯ä¸€ä¸ª Java è°ƒç”¨é Java ä»£ç çš„æ¥å£ã€‚æˆ‘ä»¬çŸ¥é“çš„ Unsafe ç±»å°±æœ‰å¾ˆå¤šæœ¬åœ°æ–¹æ³•ã€‚ æœ¬åœ°æ–¹æ³•æ ˆ(Native Method Stack) Java è™šæ‹Ÿæœºæ ˆç”¨äºç®¡ç† Java æ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨ 5.ä»€ä¹ˆæ˜¯æ–¹æ³•åŒºï¼ˆçº¿ç¨‹å…±äº«ï¼‰ï¼Ÿæ–¹æ³•åŒºï¼ˆmethod areaï¼‰åªæ˜¯ JVM è§„èŒƒä¸­å®šä¹‰çš„ä¸€ä¸ªæ¦‚å¿µï¼Œç”¨äºå­˜å‚¨ç±»ä¿¡æ¯ã€å¸¸é‡æ± ã€é™æ€å˜é‡ã€JITç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ï¼Œå¹¶æ²¡æœ‰è§„å®šå¦‚ä½•å»å®ç°å®ƒï¼Œä¸åŒçš„å‚å•†æœ‰ä¸åŒçš„å®ç°ã€‚è€Œ**æ°¸ä¹…ä»£ï¼ˆPermGenï¼‰**æ˜¯ **Hotspot** è™šæ‹Ÿæœºç‰¹æœ‰çš„æ¦‚å¿µï¼Œ Java8 çš„æ—¶å€™åˆè¢«**å…ƒç©ºé—´**å–ä»£äº†ï¼Œæ°¸ä¹…ä»£å’Œå…ƒç©ºé—´éƒ½å¯ä»¥ç†è§£ä¸ºæ–¹æ³•åŒºçš„è½åœ°å®ç°ã€‚ JDK1.8ä¹‹å‰è°ƒèŠ‚æ–¹æ³•åŒºå¤§å°ï¼š 12-XX:PermSize=N //æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰åˆå§‹å¤§å°-XX:MaxPermSize=N //æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰æœ€å¤§å¤§å°ï¼Œè¶…å‡ºè¿™ä¸ªå€¼å°†ä¼šæŠ›å‡ºOutOfMemoryError JDK1.8å¼€å§‹æ–¹æ³•åŒºï¼ˆHotSpotçš„æ°¸ä¹…ä»£ï¼‰è¢«å½»åº•åˆ é™¤äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å…ƒç©ºé—´ï¼Œå…ƒç©ºé—´ç›´æ¥ä½¿ç”¨çš„æ˜¯æœ¬æœºå†…å­˜ã€‚å‚æ•°è®¾ç½®ï¼š 12-XX:MetaspaceSize=N //è®¾ç½®Metaspaceçš„åˆå§‹ï¼ˆå’Œæœ€å°å¤§å°ï¼‰-XX:MaxMetaspaceSize=N //è®¾ç½®Metaspaceçš„æœ€å¤§å¤§å° 6.æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³» 7.å †åŒºå†…å­˜æ˜¯æ€ä¹ˆç»†åˆ†çš„ï¼Ÿ å¯¹äºå¤§å¤šæ•°åº”ç”¨ï¼ŒJava å †æ˜¯ Java è™šæ‹Ÿæœºç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼Œè¢«æ‰€æœ‰çº¿ç¨‹å…±äº«ã€‚æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°æ®éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚ ä¸ºäº†è¿›è¡Œé«˜æ•ˆçš„åƒåœ¾å›æ”¶ï¼Œè™šæ‹ŸæœºæŠŠå †å†…å­˜é€»è¾‘ä¸Šåˆ’åˆ†æˆä¸‰å—åŒºåŸŸï¼ˆåˆ†ä»£çš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¼˜åŒ– GC æ€§èƒ½ï¼‰ï¼š æ–°ç”Ÿå¸¦ï¼ˆå¹´è½»ä»£ï¼‰ï¼šæ–°å¯¹è±¡å’Œæ²¡è¾¾åˆ°ä¸€å®šå¹´é¾„çš„å¯¹è±¡éƒ½åœ¨æ–°ç”Ÿä»£ è€å¹´ä»£ï¼ˆå…»è€åŒºï¼‰ï¼šè¢«é•¿æ—¶é—´ä½¿ç”¨çš„å¯¹è±¡ï¼Œè€å¹´ä»£çš„å†…å­˜ç©ºé—´åº”è¯¥è¦æ¯”å¹´è½»ä»£æ›´å¤§ Java è™šæ‹Ÿæœºè§„èŒƒè§„å®šï¼ŒJava å †å¯ä»¥æ˜¯å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œåªè¦é€»è¾‘ä¸Šæ˜¯è¿ç»­çš„å³å¯ï¼Œåƒç£ç›˜ç©ºé—´ä¸€æ ·ã€‚å®ç°æ—¶ï¼Œæ—¢å¯ä»¥æ˜¯å›ºå®šå¤§å°ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯æ‰©å±•çš„ï¼Œä¸»æµè™šæ‹Ÿæœºéƒ½æ˜¯å¯æ‰©å±•çš„ï¼ˆé€šè¿‡ -Xmx å’Œ -Xms æ§åˆ¶ï¼‰ï¼Œå¦‚æœå †ä¸­æ²¡æœ‰å®Œæˆå®ä¾‹åˆ†é…ï¼Œå¹¶ä¸”å †æ— æ³•å†æ‰©å±•æ—¶ï¼Œå°±ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚ å¹´è½»ä»£ (Young Generation) å¹´è½»ä»£æ˜¯æ‰€æœ‰æ–°å¯¹è±¡åˆ›å»ºçš„åœ°æ–¹ã€‚å½“å¡«å……å¹´è½»ä»£æ—¶ï¼Œæ‰§è¡Œåƒåœ¾æ”¶é›†ã€‚è¿™ç§åƒåœ¾æ”¶é›†ç§°ä¸º Minor GCã€‚å¹´è½»ä¸€ä»£è¢«åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†â€”â€”ä¼Šç”¸å›­ï¼ˆEden Memoryï¼‰å’Œä¸¤ä¸ªå¹¸å­˜åŒºï¼ˆSurvivor Memoryï¼Œè¢«ç§°ä¸ºfrom/toæˆ–s0/s1ï¼‰ï¼Œé»˜è®¤æ¯”ä¾‹æ˜¯8:1:1 å¤§å¤šæ•°æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä½äº Eden å†…å­˜ç©ºé—´ä¸­ å½“ Eden ç©ºé—´è¢«å¯¹è±¡å¡«å……æ—¶ï¼Œæ‰§è¡ŒMinor GCï¼Œå¹¶å°†æ‰€æœ‰å¹¸å­˜è€…å¯¹è±¡ç§»åŠ¨åˆ°ä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´ä¸­ Minor GC æ£€æŸ¥å¹¸å­˜è€…å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´ã€‚æ‰€ä»¥æ¯æ¬¡ï¼Œä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´æ€»æ˜¯ç©ºçš„ ç»è¿‡å¤šæ¬¡ GC å¾ªç¯åå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡è¢«ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚é€šå¸¸ï¼Œè¿™æ˜¯é€šè¿‡è®¾ç½®å¹´è½»ä¸€ä»£å¯¹è±¡çš„å¹´é¾„é˜ˆå€¼æ¥å®ç°çš„ï¼Œç„¶åä»–ä»¬æ‰æœ‰èµ„æ ¼æå‡åˆ°è€ä¸€ä»£ è€å¹´ä»£(Old Generation) æ—§çš„ä¸€ä»£å†…å­˜åŒ…å«é‚£äº›ç»è¿‡è®¸å¤šè½®å°å‹ GC åä»ç„¶å­˜æ´»çš„å¯¹è±¡ã€‚é€šå¸¸ï¼Œåƒåœ¾æ”¶é›†æ˜¯åœ¨è€å¹´ä»£å†…å­˜æ»¡æ—¶æ‰§è¡Œçš„ã€‚è€å¹´ä»£åƒåœ¾æ”¶é›†ç§°ä¸º ä¸»GCï¼ˆMajor GCï¼‰ï¼Œé€šå¸¸éœ€è¦æ›´é•¿çš„æ—¶é—´ã€‚ å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼ˆå¤§å¯¹è±¡æ˜¯æŒ‡éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼‰ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é¿å…åœ¨ Eden åŒºå’Œä¸¤ä¸ªSurvivor åŒºä¹‹é—´å‘ç”Ÿå¤§é‡çš„å†…å­˜æ‹·è´ 8.JVMä¸­å¯¹è±¡åœ¨å †ä¸­çš„ç”Ÿå‘½å‘¨æœŸ? åœ¨ JVM å†…å­˜æ¨¡å‹çš„å †ä¸­ï¼Œå †è¢«åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ æ–°ç”Ÿä»£åˆè¢«è¿›ä¸€æ­¥åˆ’åˆ†ä¸º EdenåŒº å’Œ SurvivoråŒºï¼ŒSurvivor åŒºç”± From Survivor å’Œ To Survivor ç»„æˆ å½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¯¹è±¡ä¼šè¢«ä¼˜å…ˆåˆ†é…åˆ°æ–°ç”Ÿä»£çš„ Eden åŒº æ­¤æ—¶ JVM ä¼šç»™å¯¹è±¡å®šä¹‰ä¸€ä¸ªå¯¹è±¡å¹´è½»è®¡æ•°å™¨ï¼ˆ-XX:MaxTenuringThresholdï¼‰ å½“ Eden ç©ºé—´ä¸è¶³æ—¶ï¼ŒJVM å°†æ‰§è¡Œæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ï¼ˆMinor GCï¼‰ JVM ä¼šæŠŠå­˜æ´»çš„å¯¹è±¡è½¬ç§»åˆ° Survivor ä¸­ï¼Œå¹¶ä¸”å¯¹è±¡å¹´é¾„ +1 å¯¹è±¡åœ¨ Survivor ä¸­åŒæ ·ä¹Ÿä¼šç»å† Minor GCï¼Œæ¯ç»å†ä¸€æ¬¡ Minor GCï¼Œå¯¹è±¡å¹´é¾„éƒ½ä¼š+1 å¦‚æœåˆ†é…çš„å¯¹è±¡è¶…è¿‡äº†-XX:PetenureSizeThresholdï¼Œå¯¹è±¡ä¼šç›´æ¥è¢«åˆ†é…åˆ°è€å¹´ä»£ 9.JVMä¸­å¯¹è±¡çš„åˆ†é…è¿‡ç¨‹?ä¸ºå¯¹è±¡åˆ†é…å†…å­˜æ˜¯ä¸€ä»¶éå¸¸ä¸¥è°¨å’Œå¤æ‚çš„ä»»åŠ¡ï¼ŒJVM çš„è®¾è®¡è€…ä»¬ä¸ä»…éœ€è¦è€ƒè™‘å†…å­˜å¦‚ä½•åˆ†é…ã€åœ¨å“ªé‡Œåˆ†é…ç­‰é—®é¢˜ï¼Œå¹¶ä¸”ç”±äºå†…å­˜åˆ†é…ç®—æ³•å’Œå†…å­˜å›æ”¶ç®—æ³•å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘ GC æ‰§è¡Œå®Œå†…å­˜å›æ”¶åæ˜¯å¦ä¼šåœ¨å†…å­˜ç©ºé—´ä¸­äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚ new çš„å¯¹è±¡å…ˆæ”¾åœ¨ä¼Šç”¸å›­åŒºï¼Œæ­¤åŒºæœ‰å¤§å°é™åˆ¶ å½“ä¼Šç”¸å›­çš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVM çš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆMinor GCï¼‰ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚å†åŠ è½½æ–°çš„å¯¹è±¡æ”¾åˆ°ä¼Šç”¸å›­åŒº ç„¶åå°†ä¼Šç”¸å›­ä¸­çš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€… 0 åŒº å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¸Šæ¬¡å¹¸å­˜ä¸‹æ¥çš„æ”¾åˆ°å¹¸å­˜è€… 0 åŒºï¼Œå¦‚æœæ²¡æœ‰å›æ”¶ï¼Œå°±ä¼šæ”¾åˆ°å¹¸å­˜è€… 1 åŒº å¦‚æœå†æ¬¡ç»å†åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ”¾å›å¹¸å­˜è€… 0 åŒºï¼Œæ¥ç€å†å»å¹¸å­˜è€… 1 åŒº ä»€ä¹ˆæ—¶å€™æ‰ä¼šå»å…»è€åŒºå‘¢ï¼Ÿ é»˜è®¤æ˜¯ 15 æ¬¡å›æ”¶æ ‡è®° åœ¨å…»è€åŒºï¼Œç›¸å¯¹æ‚ é—²ã€‚å½“å…»è€åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œå†æ¬¡è§¦å‘ Major GCï¼Œè¿›è¡Œå…»è€åŒºçš„å†…å­˜æ¸…ç† è‹¥å…»è€åŒºæ‰§è¡Œäº† Major GC ä¹‹åå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”Ÿ OOM å¼‚å¸¸ 10.é™æ€å˜é‡ä¸å±€éƒ¨å˜é‡çš„å¯¹æ¯”å˜é‡æŒ‰ç…§æ•°æ®ç±»å‹ï¼šåŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨æ•°æ®ç±»å‹ å˜é‡æŒ‰ç…§ç±»ä¸­å£°æ˜ä½ç½®ï¼šæˆå‘˜å˜é‡ï¼ˆç±»å˜é‡ ï½“ï½”ï½ï½”ï½‰ï½ƒ ï¼Œå±€éƒ¨å˜é‡ï¼‰ å±€éƒ¨å˜é‡ æˆå‘˜å˜é‡ åœ¨ä½¿ç”¨å‰éƒ½ç»è¿‡é»˜è®¤èµ‹å€¼ï¼Œï½‰ï½ï½”æ˜¾å¼èµ‹å€¼ã€‚ å®ä¾‹å˜é‡ éšç€å¯¹è±¡åˆ›å»ºä¼šåœ¨å †ç©ºé—´ä¸­åˆ†é…å®ä¾‹å˜é‡ç©ºé—´ï¼Œå¹¶è¿›è¡Œé»˜è®¤èµ‹å€¼ã€‚ å±€éƒ¨å˜é‡æ˜¾å¼èµ‹å€¼ï¼Œå¦åˆ™æ²¡æ³•ä½¿ç”¨ã€‚ åœ¨æ ˆå¸§ä¸­ï¼Œä¸æ€§èƒ½è°ƒä¼˜æœ€ä¸ºå¯†åˆ‡çš„å°±æ˜¯å±€éƒ¨å˜é‡è¡¨ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆæ–¹æ³•çš„ä¼ é€’ã€‚ åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«å±€éƒ¨å˜é‡è¡¨ä¸­ç›´æ¥å¼•ç”¨æˆ–é—´æ¥å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶ã€‚ 11.æ–¹æ³•é‡å†™çš„æœ¬è´¨æ‰¾åˆ°æ“ä½œæ•°æ ˆé¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œè®°åšï¼£ã€‚ å¦‚æœåœ¨ç±»å‹ï¼£ä¸­æ‰¾åˆ°ä¸å¸¸é‡ä¸­çš„æè¿°ç¬¦å’Œç®€å•åç§°éƒ½ç›¸ç¬¦çš„æ–¹æ³•ï¼Œåˆ™è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒï¼Œå¦‚æœé€šè¿‡åˆ™è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç»“æŸï¼›å¦‚æœä¸é€šè¿‡åˆ™è¿”å›java.lang.IllegalAccessErrorã€‚ å¦åˆ™ï¼ŒæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šä¾æ¬¡å¯¹Cçš„å„ä¸ªçˆ¶ç±»è¿›è¡Œç¬¬äºŒæ­¥çš„æœç´¢å’ŒéªŒè¯è¿‡ç¨‹ã€‚ å¦‚æœå§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡ºjava.lang.AbstractMethodErrorå¼‚å¸¸ã€‚ java.lang.IllegalAccessError ç¨‹åºè¯•å›¾è®¿é—®æˆ–è€…ä¿®æ”¹ä¸€ä¸ªå±æ€§æˆ–è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªå±æ€§æˆ–è€…æ–¹æ³•ï¼Œä½ æ²¡æœ‰æƒé™è®¿é—®ï¼Œä¸€èˆ¬çš„ï¼Œè¿™ä¸ªä¼šå¼•èµ·ç¼–è¯‘æœŸå¼‚å¸¸ï¼Œè¿™ä¸ªé”™è¯¯ å¦‚æœå‘ç”Ÿåœ¨è¿è¡Œæ—¶ï¼Œå°±è¯´æ˜ä¸€ä¸ªç±»å‘ç”Ÿäº†ä¸å…¼å®¹çš„æ”¹å˜ã€‚ è¡¥å……ï¼šå¤šæ€çš„æœ¬è´¨å°±æ˜¯æŒ‡å‘åŒä¸€ä¸ªè™šæ–¹æ³•è¡¨çš„å¼•ç”¨ã€‚ 12.å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ ç±»åŠ è½½æ£€æŸ¥ï¼šè™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆå°†å»æ£€æŸ¥è¿™ä¸ªç±»æ˜¯å¦å·²è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£å¿…é¡»å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹ï¼šç±»åŠ è½½è¿‡ç¨‹ä¸­ä¼šé€šè¿‡jvmè‡ªå¸¦çš„ä¸‰ä¸ªç±»åŠ è½½å™¨æŒ‰ç…§åŒäº²å§”æ´¾æœºåˆ¶è¿›è¡Œç±»åŠ è½½è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¸¸è§çš„ClassNotFoundExceptionå°±æ˜¯åœ¨è¿™é‡Œå‘ç”Ÿçš„ï¼Œæˆ‘ä»¬ä»£ç ä¸­çš„é™æ€ä»£ç å—é‡Œé¢çš„å†…å®¹ä¹Ÿæ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰§è¡Œçš„ã€‚ åˆ†é…å†…å­˜ï¼šåœ¨ç±»åŠ è½½æ£€æŸ¥é€šè¿‡åï¼Œè™šæ‹Ÿæœºå°†ä¸ºæ–°ç”Ÿå¯¹è±¡åˆ†é…å†…å­˜ã€‚å¯¹è±¡æ‰€éœ€å†…å­˜çš„å¤§å°åœ¨ç±»åŠ è½½å®Œæˆåä¾¿å¯å®Œå…¨ç¡®å®šï¼Œä¸ºå¯¹è±¡åˆ†é…ç©ºé—´çš„ä»»åŠ¡ç­‰åŒäºæŠŠ ä¸€å—ç¡®å®šå¤§å°çš„å†…å­˜ä»Javaå †ä¸­åˆ’åˆ†å‡ºæ¥ã€‚ åˆå§‹åŒ–é›¶å€¼ï¼šå†…å­˜åˆ†é…å®Œæˆåï¼Œè™šæ‹Ÿæœºéœ€è¦å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰ï¼Œè¿™ä¸€æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨Javaä»£ç ä¸­å¯ä»¥ä¸èµ‹åˆå§‹å€¼å°±ç›´æ¥ä½¿ç”¨ï¼Œç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼ã€‚ è®¾ç½®å¯¹è±¡å¤´ï¼šåˆå§‹åŒ–é›¶å€¼ä¹‹åï¼Œè™šæ‹Ÿæœºè¦å¯¹å¯¹è±¡è¿›è¡Œå¿…è¦çš„è®¾ç½®ï¼Œä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯(å³å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹)ã€å¯¹è±¡çš„å“ˆå¸Œç ï¼ˆHashCodeï¼‰ã€å¯¹è±¡çš„GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡çš„å¯¹è±¡å¤´Object Headerä¹‹ä¸­ã€‚ æ‰§è¡Œæ–¹æ³•ï¼šæ‰§è¡Œæ–¹æ³•ï¼Œå³å¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ã€‚å¯¹åº”åˆ°è¯­è¨€å±‚é¢ä¸Šè®²ï¼Œå°±æ˜¯ä¸ºå±æ€§èµ‹å€¼ï¼ˆæ³¨æ„ï¼Œè¿™ä¸ä¸Šé¢çš„èµ‹é›¶å€¼ä¸åŒï¼Œè¿™æ˜¯ç”±ç¨‹åºå‘˜èµ‹çš„å€¼ï¼‰ï¼Œå’Œæ‰§è¡Œæ„é€ æ–¹æ³•ã€‚ 13.å¯¹è±¡åˆ†é…è¿‡ç¨‹1.newçš„å¯¹è±¡å…ˆæ”¾åœ¨ä¼Šç”¸å›­åŒºï¼Œæ­¤åŒºæœ‰å¤§å°é™åˆ¶ã€‚ 2.å½“ä¼Šç”¸å›­çš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºæœ‰éœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå°†ä¼Šç”¸å›­åŒºçš„ä¸åœ¨è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡é”€æ¯ï¼Œåœ¨åŠ è½½æ–°çš„å¯¹è±¡æ”¾åœ¨ä¼Šç”¸å›­åŒºã€‚ 3.ç„¶åå°†ä¼Šç”¸å›­åŒºå‰©ä½™çš„å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€…0. 4.å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¸Šæ¬¡å¹¸å­˜ä¸‹æ¥çš„æ”¾åˆ°å¹¸å­˜è€…0åŒºçš„ï¼Œæ¥ç€å†å»å¹¸å­˜è€…1åŒºã€‚ 5.å•¥æ—¶å€™å»å…»è€åŒºå‘¢ï¼Ÿå¯ä»¥è®¾ç½®æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯15æ¬¡ã€‚-XX:MaxTenuringThreshold= (ä¼Šç”¸å›­åŒºæ»¡äº†ä¼šè§¦å‘ygcï¼Œå°†å¹¸å­˜è€…åŒºåŸŸå’Œä¼Šç”¸å›­åŒºéƒ½å›æ”¶ä¸€ä¸‹ï¼Œä½†æ˜¯å¹¸å­˜è€…åŒºæ»¡äº†ä¸ä¼šè§¦å‘åƒåœ¾å›æ”¶) æ€»ç»“ï¼šé’ˆå¯¹å¹¸å­˜è€…S0ï¼ŒS1åŒºçš„æ€»ç»“ï¼šå¤åˆ¶ä¹‹åæœ‰äº¤æ¢ï¼Œè°ç©ºè°æ˜¯toã€‚å…³äºåƒåœ¾å›æ”¶ï¼Œé¢‘ç¹åœ¨æ–°ç”ŸåŒºæ”¶é›†ï¼Œå¾ˆå°‘åœ¨å…»è€åŒºæ”¶é›†ï¼Œå‡ ä¹ä¸åœ¨æ°¸ä¹…åŒºæˆ–è€…å…ƒç©ºé—´æ”¶é›†ã€‚ 14.ç±»çš„åŠ è½½è¿‡ç¨‹ åŠ è½½-&gt;é“¾æ¥ï¼ˆéªŒè¯ï¼Œå‡†å¤‡ï¼Œè§£æï¼‰-&gt;åˆå§‹åŒ– 1ï¼‰åŠ è½½ é€šè¿‡å…¨é™å®šç±»ååŠ è½½ä¸€ä¸ªç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼Œå°†é™æ€ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„Classå¯¹è±¡ åŠ è½½.classæ–‡ä»¶çš„æ–¹å¼ï¼š ä»æœ¬åœ°ç³»ç»Ÿä¸­ç›´æ¥åŠ è½½ é€šè¿‡ç½‘ç»œè·å–ï¼Œå…¸å‹åœºæ™¯ï¼šWeb Applet ä»zipå‹ç¼©åŒ…ä¸­è¯»å–ï¼Œæˆä¸ºæ—¥åjar ï¼Œwaræ ¼å¼çš„åŸºç¡€ è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä½¿ç”¨æœ€å¤šçš„æ˜¯ï¼šåŠ¨æ€ä»£ç†æŠ€æœ¯ å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼šå…¸å‹åœºæ™¯JSP ä»ä¸“æœ‰æ•°æ®åº“æå–.classæ–‡ä»¶ï¼Œæ¯”è¾ƒå°‘è§ ä»åŠ å¯†æ–‡ä»¶ä¸­è·å–ï¼Œå…¸å‹çš„é˜²Classæ–‡ä»¶è¢«åç¼–è¯‘çš„ä¿æŠ¤æªæ–½ 2ï¼‰é“¾æ¥ 1.éªŒè¯ï¼šç¡®ä¿classæ–‡ä»¶å†…å®¹ä¸ä¼šå±å®³åˆ°å½“å‰è™šæ‹Ÿæœº 2.å‡†å¤‡ï¼šä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®åˆå§‹å€¼ï¼Œä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…ç©ºé—´åˆå§‹åŒ–ï¼Œç±»å˜é‡åˆ†é…åœ¨æ–¹æ³•åŒºï¼Œå®ä¾‹å˜é‡åˆ†é…åœ¨å †ç©ºé—´ã€‚ 3.è§£æï¼šå°†å¸¸é‡æ± çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ 3ï¼‰åˆå§‹åŒ– æ‰§è¡Œç±»æ„é€ å™¨æ–¹æ³•ï¼ˆå®Œæˆé™æ€å±æ€§å’Œé™æ€ä»£ç å—å˜é‡çš„èµ‹å€¼æ“ä½œï¼‰çš„è¿‡ç¨‹ï¼Œæ­¤æ–¹æ³•ä¸éœ€è¦å®šä¹‰ï¼Œæ˜¯javacå®Œæˆçš„ã€‚ clinit()ä¸åŒäºç±»çš„æ„é€ å™¨,ä»–åªä¼šåŠ è½½ä¸€æ¬¡ã€‚è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„clinit()æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„clinit()å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚ è™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„clinit()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”ã€‚ ä»»ä½•ä¸€ä¸ªç±»å£°æ˜ä»¥åï¼Œå†…éƒ¨è‡³å°‘å­˜åœ¨ä¸€ä¸ªç±»çš„æ„é€ å™¨ 15.ç±»åŠ è½½å™¨ JDKè‡ªå¸¦æœ‰ä¸‰ä¸ªç±»åŠ è½½å™¨ï¼šbootstrapClassLoader(å¼•å¯¼ç±»åŠ è½½å™¨)ã€ExtClassLoader(æ‰©å±•ç±»åŠ è½½å™¨)ã€AppClassLoader(ç³»ç»Ÿç±»åŠ è½½å™¨)ï¼ŒbootstrapClassLoaderæ˜¯ExtClassLoaderçš„çˆ¶ç±»åŠ è½½å™¨(å¹¶ä¸æ˜¯é›†æˆå…³ç³»ï¼Œæ˜¯å±æ€§å…³ç³»)é»˜è®¤åŠ è½½%JAVA_HOME%/libä¸‹çš„jaråŒ…å’Œclassæ–‡ä»¶ExtClassLoaderæ˜¯AppClassLoaderçš„çˆ¶ç±»åŠ è½½å™¨ï¼Œé»˜è®¤åŠ è½½%JAVA_HOME%/lib/extæ–‡ä»¶å¤¹ä¸‹çš„jaråŒ…å’Œclassæ–‡ä»¶AppClassLoaderæ˜¯è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½classpathä¸‹çš„ç±»æ–‡ä»¶ 1ï¼‰å¯åŠ¨ç±»åŠ è½½å™¨ å¯åŠ¨ç±»åŠ è½½å™¨ BootStrap ClassLoader åŠ è½½javaæ ¸å¿ƒç±»åº“ï¼ŒåªåŠ è½½java javax sunå¼€å¤´çš„ç±» 2ï¼‰ç³»ç»Ÿç±»åŠ è½½å™¨ extends ClassLoader java ClassLoader.getSystemClassLoader(); åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰ç±»ï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨ 3ï¼‰æ‹“å±•ç±»åŠ è½½å™¨ extends ClassLoader java SystemClassLoader.getParent(); 4ï¼‰ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨ extends ClassLoader 1.ä¸ºä»€ä¹ˆè¦ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ 1éš”ç¦»åŠ è½½ç±»` `ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼` `æ‰©å±•åŠ è½½æº` `é˜²æ­¢æºç æ³„éœ² 2.ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ­¥éª¤ï¼Ÿ jdk1.2ä¹‹å‰ï¼Œç»§æ‰¿ClassLoaderé‡å†™loadClass().jdk1.2ä¹‹åå»ºè®®é‡å†™findClass() ä¹Ÿå¯ä»¥ç»§æ‰¿URLClassLoader,é¿å…äº†è‡ªå·±ç¼–å†™findClass()ä»¥åŠè·å–è‡ªå·±ç æµçš„æ–¹å¼ã€‚ 3.ClassLoader å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ªClassLoader(ä¸åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨) 1234getParent() è¿”å›çˆ¶ç±»åŠ è½½å™¨loadClass(String name) è¿”å›Classå®ä¾‹findClass(String name) è¿”å›Classå®ä¾‹defineClass(String name,byte[] b ,int off,int len) æŠŠå­—èŠ‚æ•°ç»„bä¸­çš„å†…å®¹è½¬æ¢ä¸ºä¸€ä¸ªjavaç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹ 16.JVMç±»åŠ è½½æœºåˆ¶æœ‰å“ªäº›ï¼Ÿ å…¨ç›˜è´Ÿè´£ï¼Œå½“ä¸€ä¸ªç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½æŸä¸ªClassæ—¶ï¼Œè¯¥Classæ‰€ä¾èµ–çš„å’Œå¼•ç”¨çš„å…¶ä»–Classä¹Ÿå°†ç”±è¯¥ç±»åŠ è½½å™¨è´Ÿè´£è½½å…¥ï¼Œé™¤éæ˜¾ç¤ºä½¿ç”¨å¦å¤–ä¸€ä¸ªç±»åŠ è½½å™¨æ¥è½½å…¥ çˆ¶ç±»å§”æ‰˜ï¼Œå…ˆè®©çˆ¶ç±»åŠ è½½å™¨è¯•å›¾åŠ è½½è¯¥ç±»ï¼Œåªæœ‰åœ¨çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»æ—¶æ‰å°è¯•ä»è‡ªå·±çš„ç±»è·¯å¾„ä¸­åŠ è½½è¯¥ç±» ç¼“å­˜æœºåˆ¶ï¼Œç¼“å­˜æœºåˆ¶å°†ä¼šä¿è¯æ‰€æœ‰åŠ è½½è¿‡çš„Classéƒ½ä¼šè¢«ç¼“å­˜ï¼Œå½“ç¨‹åºä¸­éœ€è¦ä½¿ç”¨æŸä¸ªClassæ—¶ï¼Œç±»åŠ è½½å™¨å…ˆä»ç¼“å­˜åŒºå¯»æ‰¾è¯¥Classï¼Œåªæœ‰ç¼“å­˜åŒºä¸å­˜åœ¨ï¼Œç³»ç»Ÿæ‰ä¼šè¯»å–è¯¥ç±»å¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æ¢æˆClasså¯¹è±¡ï¼Œå­˜å…¥ç¼“å­˜åŒºã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¿®æ”¹äº†Classåï¼Œå¿…é¡»é‡å¯JVMï¼Œç¨‹åºçš„ä¿®æ”¹æ‰ä¼šç”Ÿæ•ˆ åŒäº²å§”æ´¾æœºåˆ¶, å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¯·æ±‚å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨å»å®Œæˆï¼Œä¾æ¬¡å‘ä¸Šï¼Œå› æ­¤ï¼Œæ‰€æœ‰çš„ç±»åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥è¢«ä¼ é€’åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åœ¨å®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»æ—¶ï¼Œå³æ— æ³•å®Œæˆè¯¥åŠ è½½ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½è¯¥ç±»ã€‚ 17.åŒäº²å§”æ´¾æœºåˆ¶åˆ†ä¸ºå‘ä¸Šå§”æ´¾å’Œå‘ä¸‹æŸ¥æ‰¾ï¼Œæ¯ä¸€ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰å„è‡ªçš„ç¼“å­˜ï¼Œéƒ½ä¼šè®°å½•è‡ªå·±åŠ è½½è¿‡çš„ç±»ï¼Œå½“ä¸€ä¸ªç±»éœ€è¦åŠ è½½ï¼ŒAppClassLoaderå…ˆæŸ¥æ‰¾è‡ªå·±çš„ç¼“å­˜æœ‰æ²¡æœ‰åŠ è½½è¿‡è¿™ä¸ªç±»ï¼Œæ²¡æœ‰åŠ è½½è¿‡å°±ä¼šè°ƒç”¨ExtClassLoaderå»æŸ¥æ‰¾ï¼ŒExtClassLoaderæ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±ä¼šè°ƒç”¨bootstrapClassLoaderç±»å»åŠ è½½ï¼Œå¦‚æœbootstrapClassLoaderæ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±ä¼šå»ä»–çš„ç±»åŠ è½½è·¯å¾„æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ExtClassLoaderå°±ä¼šæŸ¥æ‰¾ä»–çš„ç±»åŠ è½½è·¯å¾„ï¼Œå‘ä¸Šå§”æ´¾å°±æ˜¯æŸ¥æ‰¾ç¼“å­˜ï¼ŒæŸ¥æ‰¾åˆ°bootstrapClassLoaderä½ç½®ï¼Œå‘ä¸‹æŸ¥æ‰¾å°±æ˜¯æŸ¥æ‰¾ç±»åŠ è½½è·¯å¾„ï¼ŒæŸ¥æ‰¾åˆ°å‘èµ·çš„ç±»åŠ è½½å™¨ä¸ºæ­¢ã€‚ javaè™šæ‹Ÿæœºå¯¹classæ–‡ä»¶é‡‡ç”¨çš„æ˜¯æŒ‰éœ€åŠ è½½ï¼Œè€Œä¸”åŠ è½½æŸä¸ªç±»çš„classæ–‡ä»¶æ—¶ï¼Œjavaè™šæ‹Ÿæœºé‡‡ç”¨çš„æ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå°±æ˜¯æŠŠè¯·æ±‚äº¤ç”±çˆ¶ç±»åŠ è½½å™¨å¤„ç†ï¼Œå®ƒæ˜¯ä¸€ç§ä»»åŠ¡å§”æ´¾æ¨¡å¼ 1ï¼‰å·¥ä½œåŸç† å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œä»–å¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œã€‚ å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†è¾¾åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ã€‚ å¦‚æœçˆ¶åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤ç±»åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚ 2ï¼‰ä¸¾ä¾‹ 1.è°ƒç”¨JDBCæ¥å£ï¼Œæ¥å£æ˜¯å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œä½†æ˜¯å®ç°ç±»æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½çš„ã€‚ 2.å‡è®¾å½“å‰åŠ è½½çš„æ˜¯java.lang.Objectè¿™ä¸ªç±»ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¯¥ç±»å±äºJDKä¸­æ ¸å¿ƒå¾—ä¸èƒ½å†æ ¸å¿ƒçš„ä¸€ä¸ªç±»ï¼Œå› æ­¤ä¸€å®šåªèƒ½ç”±å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚å½“JVMå‡†å¤‡åŠ è½½java.lang.Objectæ—¶ï¼ŒJVMé»˜è®¤ä¼šä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨å»åŠ è½½ï¼ŒæŒ‰ç…§ä¸Šé¢4æ­¥åŠ è½½çš„é€»è¾‘ï¼Œåœ¨ç¬¬1æ­¥ä»ç³»ç»Ÿç±»çš„ç¼“å­˜ä¸­è‚¯å®šæŸ¥æ‰¾ä¸åˆ°è¯¥ç±»ï¼Œäºæ˜¯è¿›å…¥ç¬¬2æ­¥ã€‚ç”±äºä»ç³»ç»Ÿç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼Œäºæ˜¯æ‰©å±•ç±»åŠ è½½å™¨ç»§ç»­ä»ç¬¬1æ­¥å¼€å§‹é‡å¤ã€‚ç”±äºæ‰©å±•ç±»åŠ è½½å™¨çš„ç¼“å­˜ä¸­ä¹Ÿä¸€å®šæŸ¥æ‰¾ä¸åˆ°è¯¥ç±»ï¼Œå› æ­¤è¿›å…¥ç¬¬2æ­¥ã€‚æ‰©å±•ç±»çš„çˆ¶åŠ è½½å™¨æ˜¯null,å› æ­¤ç³»ç»Ÿè°ƒç”¨findClass(String)ï¼Œæœ€ç»ˆé€šè¿‡å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚ 3ï¼‰ä¼˜ç‚¹ 1ã€å®‰å…¨æ€§ï¼Œé¿å…è‡ªå·±å†™çš„ç±»æ›¿æ¢æ‰javaæ ¸å¿ƒç±»ï¼›ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒAPIè¢«éšæ„ç¯¡æ”¹ 2ã€é¿å…ç±»é‡å¤åŠ è½½ï¼Œç›¸åŒclassæ–‡ä»¶ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½çš„ä¹Ÿæ˜¯ä¸¤ä¸ªç±»ã€‚ 4ï¼‰åŒäº²å§”æ‰˜æ¨¡å¼çš„å¼Šç«¯ æ£€æŸ¥ç±»æ˜¯å¦åŠ è½½çš„å§”æ‰˜è¿‡ç¨‹æ˜¯å•å‘çš„ï¼Œè¿™ä¸ªæ–¹å¼è™½ç„¶ä»ç»“æ„ä¸Šè¯´æ¯”è¾ƒæ¸…æ™°ï¼Œä½¿å„ä¸ªClassLoaderçš„èŒè´£éå¸¸æ˜ç¡®ï¼Œä½†æ˜¯åŒæ—¶ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œå³é¡¶å±‚çš„ClassLoaderæ— æ³•è®¿é—®åº•å±‚çš„ClassLoaderæ‰€åŠ è½½çš„ç±»ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨ä¸­çš„ç±»ä¸ºç³»ç»Ÿæ ¸å¿ƒç±»ï¼ŒåŒ…æ‹¬ä¸€äº›é‡è¦çš„ç³»ç»Ÿæ¥å£ï¼Œè€Œåœ¨åº”ç”¨ç±»åŠ è½½å™¨ä¸­ï¼Œä¸ºåº”ç”¨ç±»ã€‚æŒ‰ç…§è¿™ç§æ¨¡å¼ï¼Œåº”ç”¨ç±»è®¿é—®ç³»ç»Ÿç±»è‡ªç„¶æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç³»ç»Ÿç±»è®¿é—®åº”ç”¨ç±»å°±ä¼šå‡ºç°é—®é¢˜ã€‚æ¯”å¦‚åœ¨ç³»ç»Ÿç±»ä¸­æä¾›äº†ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£éœ€è¦åœ¨åº”ç”¨ç±»ä¸­å¾—ä»¥å®ç°ï¼Œè¯¥æ¥å£è¿˜ç»‘å®šä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºè¯¥æ¥å£çš„å®ä¾‹ï¼Œè€Œæ¥å£å’Œå·¥å‚æ–¹æ³•éƒ½åœ¨å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ã€‚è¿™æ—¶ï¼Œå°±ä¼šå‡ºç°è¯¥å·¥å‚æ–¹æ³•æ— æ³•åˆ›å»ºç”±åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½çš„åº”ç”¨å®ä¾‹çš„é—®é¢˜ã€‚ 5ï¼‰æ€è€ƒ å¦‚æœåœ¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ä¸­é‡å†™java.lang.ClassLoader.loadClass(String)æˆ–java.lang.ClassLoader.loadClass(String, boolean)æ–¹æ³•,æŠ¹å»å…¶ä¸­çš„åŒäº²å§”æ´¾æœºåˆ¶,ä»…ä¿ç•™ä¸Šé¢è¿™4æ­¥ä¸­çš„ç¬¬1æ­¥ä¸ç¬¬4æ­¥ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å°±èƒ½å¤ŸåŠ è½½æ ¸å¿ƒç±»åº“äº†å‘¢? è¿™ä¹Ÿä¸è¡Œ!å› ä¸ºJDKè¿˜ä¸ºæ ¸å¿ƒç±»åº“æä¾›äº†ä¸€å±‚ä¿æŠ¤æœºåˆ¶ã€‚ä¸ç®¡æ˜¯è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œè¿˜æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨è¿˜æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼Œæœ€ç»ˆéƒ½å¿…é¡»è°ƒç”¨java.lang.classLoader.defineClass(String,byte[], int, int, ProtectionDomain)æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•ä¼šæ‰§è¡ŒpreDefineClass()æ¥å£ï¼Œè¯¥æ¥å£ä¸­æä¾›äº†å¯¹JDKæ ¸å¿ƒç±»åº“çš„ä¿æŠ¤ã€‚ 6ï¼‰ç‰¹æ®Šæƒ…å†µ: ç”±äºJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚ç±»åŠ è½½å™¨çš„åŠ è½½æœºåˆ¶ä¸€å®šè¦ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œåªæ˜¯å»ºè®®é‡‡ç”¨è¿™ç§æ–¹å¼è€Œå·±ã€‚ æ¯”å¦‚åœ¨Tomcatä¸­ï¼Œç±»åŠ è½½å™¨æ‰€é‡‡ç”¨çš„åŠ è½½æœºåˆ¶å°±å’Œä¼ ç»Ÿçš„åŒäº²å§”æ´¾æ¨¡å‹æœ‰ä¸€å®šåŒºåˆ«ï¼Œå½“ç¼ºçœçš„ç±»åŠ è½½å™¨æ¥æ”¶åˆ°ä¸€ä¸ªç±»çš„åŠ è½½ä»»åŠ¡æ—¶ï¼Œé¦–å…ˆä¼šç”±å®ƒè‡ªè¡ŒåŠ è½½ï¼Œå½“å®ƒåŠ è½½å¤±è´¥æ—¶ï¼Œæ‰ä¼šå°†ç±»çš„åŠ è½½ä»»åŠ¡å§”æ´¾ç»™å®ƒçš„è¶…ç±»åŠ è½½å™¨å»æ‰§è¡Œï¼Œè¿™åŒæ—¶ä¹Ÿæ˜¯Servletè§„èŒƒæ¨èçš„ä¸€ç§åšæ³•ã€‚ 18.ç ´ååŒäº²å§”æ´¾æœºåˆ¶â‘ ç ´ååŒäº²å§”æ´¾æœºåˆ¶1 åŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸æ˜¯ä¸€ä¸ªå…·æœ‰å¼ºåˆ¶æ€§çº¦æŸçš„æ¨¡å‹ï¼Œè€Œæ˜¯Javaè®¾è®¡è€…æ¨èç»™å¼€å‘è€…ä»¬çš„ç±»åŠ è½½å™¨å®ç°æ–¹å¼ã€‚ åœ¨Javaçš„ä¸–ç•Œä¸­å¤§éƒ¨åˆ†çš„ç±»åŠ è½½å™¨éƒ½éµå¾ªè¿™ä¸ªæ¨¡å‹ï¼Œä½†ä¹Ÿæœ‰ä¾‹å¤–çš„æƒ…å†µï¼Œç›´åˆ°Javaæ¨¡å—åŒ–å‡ºç°ä¸ºæ­¢ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹ä¸»è¦å‡ºç°è¿‡3æ¬¡è¾ƒå¤§è§„æ¨¡â€œè¢«ç ´åâ€çš„æƒ…å†µã€‚ ç¬¬ä¸€æ¬¡ç ´ååŒäº²å§”æ´¾æœºåˆ¶: åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸€æ¬¡â€œè¢«ç ´åâ€å…¶å®å‘ç”Ÿåœ¨åŒäº²å§”æ´¾æ¨¡å‹å‡ºç°ä¹‹å‰â€“å³JDK1.2é¢ä¸–ä»¥å‰çš„â€œè¿œå¤â€æ—¶ä»£ã€‚ ç”±äºåŒäº²å§”æ´¾æ¨¡å‹åœ¨JDK 1.2ä¹‹åæ‰è¢«å¼•å…¥ï¼Œä½†æ˜¯ç±»åŠ è½½å™¨çš„æ¦‚å¿µå’ŒæŠ½è±¡ç±»java.lang.ClassLoaderåˆ™åœ¨Javaçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸­å°±å·²ç»å­˜åœ¨ï¼Œé¢å¯¹å·²ç»å­˜åœ¨çš„ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„ä»£ç ï¼ŒJavaè®¾è®¡è€…ä»¬å¼•å…¥åŒäº²å§”æ´¾æ¨¡å‹æ—¶ä¸å¾—ä¸åšå‡ºä¸€äº›å¦¥åï¼Œä¸ºäº†å…¼å®¹è¿™äº›å·²æœ‰ä»£ç ï¼Œæ— æ³•å†ä»¥æŠ€æœ¯æ‰‹æ®µé¿å…loadClass()è¢«å­ç±»è¦†ç›–çš„å¯èƒ½æ€§ï¼Œåªèƒ½åœ¨JDK1.2ä¹‹åçš„java.lang.ClassLoaderä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„protectedæ–¹æ³•findClass()ï¼Œå¹¶å¼•å¯¼ç”¨æˆ·ç¼–å†™çš„ç±»åŠ è½½é€»è¾‘æ—¶å°½å¯èƒ½å»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œè€Œä¸æ˜¯åœ¨loadClass()ä¸­ç¼–å†™ä»£ç ã€‚ä¸ŠèŠ‚æˆ‘ä»¬å·²ç»åˆ†æè¿‡loadClass()æ–¹æ³•ï¼ŒåŒäº²å§”æ´¾çš„å…·ä½“é€»è¾‘å°±å®ç°åœ¨è¿™é‡Œé¢ï¼ŒæŒ‰ç…§loadClass()æ–¹æ³•çš„é€»è¾‘ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è‡ªå·±çš„findClass()æ–¹æ³•æ¥å®ŒæˆåŠ è½½ï¼Œè¿™æ ·æ—¢ä¸å½±å“ç”¨æˆ·æŒ‰ç…§è‡ªå·±çš„æ„æ„¿å»åŠ è½½ç±»ï¼Œåˆå¯ä»¥ä¿è¯æ–°å†™å‡ºæ¥çš„ç±»åŠ è½½å™¨æ˜¯ç¬¦åˆåŒäº²å§”æ´¾è§„åˆ™çš„ã€‚ ä¸ä»…è¦ç»§æ‰¿ClassLoaderç±»ï¼Œè¿˜è¦é‡å†™loadClasså’ŒfindClassæ–¹æ³• â‘¡ç ´ååŒäº²å§”æ´¾æœºåˆ¶2 ç¬¬äºŒæ¬¡ç ´ååŒäº²å§”æ´¾æœºåˆ¶:çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬äºŒæ¬¡â€œè¢«ç ´åâ€æ˜¯ç”±è¿™ä¸ªæ¨¡å‹è‡ªèº«çš„ç¼ºé™·å¯¼è‡´çš„ï¼ŒåŒäº²å§”æ´¾å¾ˆå¥½åœ°è§£å†³äº†å„ä¸ªç±»åŠ è½½å™¨åä½œæ—¶åŸºç¡€ç±»å‹çš„ä¸€è‡´æ€§é—®é¢˜ã€ˆè¶ŠåŸºç¡€çš„ç±»ç”±è¶Šä¸Šå±‚çš„åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼‰ï¼ŒåŸºç¡€ç±»å‹ä¹‹æ‰€ä»¥è¢«ç§°ä¸ºâ€œåŸºç¡€â€ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ€»æ˜¯ä½œä¸ºè¢«ç”¨æˆ·ä»£ç ç»§æ‰¿ã€è°ƒç”¨çš„APIå­˜åœ¨ï¼Œä½†ç¨‹åºè®¾è®¡å¾€å¾€æ²¡æœ‰ç»å¯¹ä¸å˜çš„å®Œç¾è§„åˆ™ï¼Œå¦‚æœæœ‰åŸºç¡€ç±»å‹åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ,é‚£è¯¥æ€ä¹ˆåŠå‘¢? è¿™å¹¶éæ˜¯ä¸å¯èƒ½å‡ºç°çš„äº‹æƒ…ï¼Œä¸€ä¸ªå…¸å‹çš„ä¾‹å­ä¾¿æ˜¯JNDIæœåŠ¡ï¼ŒJNDIç°åœ¨å·²ç»æ˜¯Javaçš„æ ‡å‡†æœåŠ¡ï¼Œå®ƒçš„ä»£ç ç”±å¯åŠ¨ç±»åŠ è½½å™¨æ¥å®ŒæˆåŠ è½½ï¼ˆåœ¨JDK 1.3æ—¶åŠ å…¥åˆ°rt.jarçš„)ï¼Œè‚¯å®šå±äºJavaä¸­å¾ˆåŸºç¡€çš„ç±»å‹äº†ã€‚ä½†JNDIå­˜åœ¨çš„ç›®çš„å°±æ˜¯å¯¹èµ„æºè¿›è¡ŒæŸ¥æ‰¾å’Œé›†ä¸­ç®¡ç†ï¼Œå®ƒéœ€è¦è°ƒç”¨ç”±å…¶ä»–å‚å•†å®ç°å¹¶éƒ¨ç½²åœ¨åº”ç”¨ç¨‹åºçš„ClassPathä¸‹çš„NDIæœåŠ¡æä¾›è€…æ¥å£ï¼ˆService Provider Interfaceï¼ŒSPIï¼‰çš„ä»£ç ï¼Œç°åœ¨é—®é¢˜æ¥äº†ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨æ˜¯ç»ä¸å¯èƒ½è®¤è¯†ã€åŠ è½½è¿™äº›ä»£ç çš„ï¼Œé‚£è¯¥æ€ä¹ˆåŠ?(SPI:åœ¨Javaå¹³å°ä¸­ï¼Œé€šå¸¸æŠŠæ ¸å¿ƒç±»rt.jarä¸­æä¾›å¤–éƒ¨æœåŠ¡ã€å¯ç”±åº”ç”¨å±‚è‡ªè¡Œå®ç°çš„æ¥å£ç§°ä¸ºSPI) ä¸ºäº†è§£å†³è¿™ä¸ªå›°å¢ƒï¼ŒJavaçš„è®¾è®¡å›¢é˜Ÿåªå¥½å¼•å…¥äº†ä¸€ä¸ªä¸å¤ªä¼˜é›…çš„è®¾è®¡:çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThread ContextClassLoader)ã€‚è¿™ä¸ªç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡java.lang.Threadç±»çš„setContextClassLoader()æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹æ—¶è¿˜æœªè®¾ç½®ï¼Œå®ƒå°†ä¼šä»çˆ¶çº¿ç¨‹ä¸­ç»§æ‰¿ä¸€ä¸ªï¼Œå¦‚æœåœ¨åº”ç”¨ç¨‹åºçš„å…¨å±€èŒƒå›´å†…éƒ½æ²¡æœ‰è®¾ç½®è¿‡çš„è¯ï¼Œé‚£è¿™ä¸ªç±»åŠ è½½å™¨é»˜è®¤å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚ æœ‰äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œç¨‹åºå°±å¯ä»¥åšä¸€äº›â€œèˆå¼Šâ€çš„äº‹æƒ…äº†ã€‚JNDIæœåŠ¡ä½¿ç”¨è¿™ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å»åŠ è½½æ‰€éœ€çš„SPIæœåŠ¡ä»£ç ï¼Œè¿™æ˜¯ä¸€ç§çˆ¶ç±»åŠ è½½å™¨å»è¯·æ±‚å­ç±»åŠ è½½å™¨å®Œæˆç±»åŠ è½½çš„è¡Œä¸ºï¼Œè¿™ç§è¡Œä¸ºå®é™…ä¸Šæ˜¯æ‰“é€šäº†åŒäº²å§”æ´¾æ¨¡å‹çš„å±‚æ¬¡ç»“æ„æ¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œå·²ç»è¿èƒŒäº†åŒäº²å§”æ´¾æ¨¡å‹çš„ä¸€èˆ¬æ€§åŸåˆ™ï¼Œä½†ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ã€‚Javaä¸­æ¶‰åŠSPIçš„åŠ è½½åŸºæœ¬ä¸Šéƒ½é‡‡ç”¨è¿™ç§æ–¹å¼æ¥å®Œæˆï¼Œä¾‹å¦‚NDIã€JDBCã€JCEã€JAXBå’ŒBTç­‰ã€‚ä¸è¿‡ï¼Œå½“SPIçš„æœåŠ¡æä¾›è€…å¤šäºä¸€ä¸ªçš„æ—¶å€™ï¼Œä»£ç å°±åªèƒ½æ ¹æ®å…·ä½“æä¾›è€…çš„ç±»å‹æ¥ç¡¬ç¼–ç åˆ¤æ–­ï¼Œä¸ºäº†æ¶ˆé™¤è¿™ç§æä¸ä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œåœ¨JDK 6æ—¶ï¼ŒJDKæä¾›äº†java.util.ServiceLoaderç±»ï¼Œä»¥META-INF/servicesä¸­çš„é…ç½®ä¿¡æ¯ï¼Œè¾…ä»¥è´£ä»»é“¾æ¨¡å¼ï¼Œè¿™æ‰ç®—æ˜¯ç»™SPIçš„åŠ è½½æä¾›äº†ä¸€ç§ç›¸å¯¹åˆç†çš„è§£å†³æ–¹æ¡ˆã€‚ é»˜è®¤ä¸Šä¸‹æ–‡åŠ è½½å™¨å°±æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ï¼Œè¿™æ ·ä»¥ä¸Šä¸‹æ–‡åŠ è½½å™¨ä¸ºä¸­ä»‹ï¼Œä½¿å¾—å¯åŠ¨ç±»åŠ è½½å™¨ä¸­çš„ä»£ç ä¹Ÿå¯ä»¥è®¿é—®åº”ç”¨ç±»åŠ è½½å™¨ä¸­çš„ç±»ã€‚ â‘¢ç ´ååŒäº²å§”æ´¾æœºåˆ¶3 ç¬¬ä¸‰æ¬¡ç ´ååŒäº²å§”æ´¾æœºåˆ¶: åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸‰æ¬¡â€œè¢«ç ´åâ€æ˜¯ç”±äºç”¨æˆ·å¯¹ç¨‹åºåŠ¨æ€æ€§çš„è¿½æ±‚è€Œå¯¼è‡´çš„ã€‚å¦‚:ä»£ç çƒ­æ›¿æ¢ï¼ˆHot Swap)ã€æ¨¡å—çƒ­éƒ¨ç½²ï¼ˆHot Deploymentï¼‰ç­‰ IBMå…¬å¸ä¸»å¯¼çš„JSR-291(å³OSGi R4.2ï¼‰å®ç°æ¨¡å—åŒ–çƒ­éƒ¨ç½²çš„å…³é”®æ˜¯å®ƒè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æœºåˆ¶çš„å®ç°ï¼Œæ¯ä¸€ä¸ªç¨‹åºæ¨¡å—ï¼ˆOSGiä¸­ç§°ä¸ºBundle)éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå½“éœ€è¦æ›´æ¢ä¸€ä¸ªBundleæ—¶ï¼Œå°±æŠŠBundleè¿åŒç±»åŠ è½½å™¨ä¸€èµ·æ¢æ‰ä»¥å®ç°ä»£ç çš„çƒ­æ›¿æ¢ã€‚åœ¨OSGiç¯å¢ƒä¸‹ï¼Œç±»åŠ è½½å™¨ä¸å†åŒäº²å§”æ´¾æ¨¡å‹æ¨èçš„æ ‘çŠ¶ç»“æ„ï¼Œè€Œæ˜¯è¿›ä¸€æ­¥å‘å±•ä¸ºæ›´åŠ å¤æ‚çš„ç½‘çŠ¶ç»“æ„ã€‚ å½“æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼ŒOSGiå°†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œç±»æœç´¢:ï¼ˆä¸ç»†è®²ï¼‰ 1ï¼‰å°†ä»¥java.*å¼€å¤´çš„ç±»ï¼Œå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚ 2ï¼‰å¦åˆ™ï¼Œå°†å§”æ´¾åˆ—è¡¨åå•å†…çš„ç±»ï¼Œå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚ 3ï¼‰å¦åˆ™ï¼Œå°†Importåˆ—è¡¨ä¸­çš„ç±»ï¼Œå§”æ´¾ç»™Exportè¿™ä¸ªç±»çš„Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚ 4ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾å½“å‰Bundleçš„ClassPathï¼Œä½¿ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚ 5ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾ç±»æ˜¯å¦åœ¨è‡ªå·±çš„Fragment Bundleä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å§”æ´¾ç»™Fragment Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚ 6ï¼‰å¦åˆ™ï¼ŒæŸ¥æ‰¾Dynamic Importåˆ—è¡¨çš„Bundleï¼Œå§”æ´¾ç»™å¯¹åº”Bundleçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚ 7ï¼‰å¦åˆ™ï¼Œç±»æŸ¥æ‰¾å¤±è´¥ã€‚ è¯´æ˜:åªæœ‰å¼€å¤´ä¸¤ç‚¹ä»ç„¶ç¬¦åˆåŒäº²å§”æ´¾æ¨¡å‹çš„åŸåˆ™ï¼Œå…¶ä½™çš„ç±»æŸ¥æ‰¾éƒ½æ˜¯åœ¨å¹³çº§çš„ç±»åŠ è½½å™¨ä¸­è¿›è¡Œçš„ å°ç»“: è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†â€œè¢«ç ´åâ€è¿™ä¸ªè¯æ¥å½¢å®¹ä¸Šè¿°ä¸ç¬¦åˆåŒäº²å§”æ´¾æ¨¡å‹åŸåˆ™çš„è¡Œä¸ºï¼Œä½†è¿™é‡Œâ€œè¢«ç ´åâ€å¹¶ä¸ä¸€å®šæ˜¯å¸¦æœ‰è´¬ä¹‰çš„ã€‚åªè¦æœ‰æ˜ç¡®çš„ç›®çš„å’Œå……åˆ†çš„ç†ç”±ï¼Œçªç ´æ—§æœ‰åŸåˆ™æ— ç–‘æ˜¯ä¸€ç§åˆ›æ–°ã€‚ æ­£å¦‚:OSGiä¸­çš„ç±»åŠ è½½å™¨çš„è®¾è®¡ä¸ç¬¦åˆä¼ ç»Ÿçš„åŒäº²å§”æ´¾çš„ç±»åŠ è½½å™¨æ¶æ„ï¼Œä¸”ä¸šç•Œå¯¹å…¶ä¸ºäº†å®ç°çƒ­éƒ¨ç½²è€Œå¸¦æ¥çš„é¢å¤–çš„é«˜å¤æ‚åº¦è¿˜å­˜åœ¨ä¸å°‘äº‰è®®ï¼Œä½†å¯¹è¿™æ–¹é¢æœ‰äº†è§£çš„æŠ€æœ¯äººå‘˜åŸºæœ¬è¿˜æ˜¯èƒ½è¾¾æˆä¸€ä¸ªå…±è¯†ï¼Œè®¤ä¸ºOSGiä¸­å¯¹ç±»åŠ è½½å™¨çš„è¿ç”¨æ˜¯å€¼å¾—å­¦ä¹ çš„ï¼Œå®Œå…¨å¼„æ‡‚äº†OSGiçš„å®ç°ï¼Œå°±ç®—æ˜¯æŒæ¡äº†ç±»åŠ è½½å™¨çš„ç²¾ç²¹ã€‚ 19.çƒ­æ›¿æ¢çš„å®ç°çƒ­æ›¿æ¢æ˜¯æŒ‡åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸åœæ­¢æœåŠ¡ï¼Œåªé€šè¿‡æ›¿æ¢ç¨‹åºæ–‡ä»¶æ¥ä¿®æ”¹ç¨‹åºçš„è¡Œä¸ºã€‚çƒ­æ›¿æ¢çš„å…³é”®éœ€æ±‚åœ¨äºæœåŠ¡ä¸èƒ½ä¸­æ–­ï¼Œä¿®æ”¹å¿…é¡»ç«‹å³è¡¨ç°æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿä¹‹ä¸­ã€‚åŸºæœ¬ä¸Šå¤§éƒ¨åˆ†è„šæœ¬è¯­è¨€éƒ½æ˜¯å¤©ç”Ÿæ”¯æŒçƒ­æ›¿æ¢çš„ï¼Œæ¯”å¦‚: PHPï¼Œåªè¦æ›¿æ¢äº†PHPæºæ–‡ä»¶ï¼Œè¿™ç§æ”¹åŠ¨å°±ä¼šç«‹å³ç”Ÿæ•ˆï¼Œè€Œæ— éœ€é‡å¯WebæœåŠ¡å™¨ã€‚ ä½†å¯¹Javaæ¥è¯´ï¼Œçƒ­æ›¿æ¢å¹¶éå¤©ç”Ÿå°±æ”¯æŒï¼Œå¦‚æœä¸€ä¸ªç±»å·²ç»åŠ è½½åˆ°ç³»ç»Ÿä¸­ï¼Œé€šè¿‡ä¿®æ”¹ç±»æ–‡ä»¶ï¼Œå¹¶æ— æ³•è®©ç³»ç»Ÿå†æ¥åŠ è½½å¹¶é‡æ–°å®šä¹‰è¿™ä¸ªç±»ã€‚å› æ­¤ï¼Œåœ¨Javaä¸­å®ç°è¿™ä¸€åŠŸèƒ½çš„ä¸€ä¸ªå¯è¡Œçš„æ–¹æ³•å°±æ˜¯çµæ´»è¿ç”¨ClassLoaderã€‚ æ³¨æ„:ç”±ä¸åŒClassLoaderåŠ è½½çš„åŒåç±»å±äºä¸åŒçš„ç±»å‹ï¼Œä¸èƒ½ç›¸äº’è½¬æ¢å’Œå…¼å®¹ã€‚å³ä¸¤ä¸ªä¸åŒçš„ClassLoaderåŠ è½½åŒä¸ªç±»ï¼Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œä¼šè®¤ä¸ºè¿™2ä¸ªç±»æ˜¯å®Œå…¨ä¸åŒçš„ã€‚ æ ¹æ®è¿™ä¸ªç‰¹ç‚¹ï¼Œå¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿçƒ­æ›¿æ¢çš„å®ç°ï¼ŒåŸºæœ¬æ€è·¯å¦‚ä¸‹å›¾æ‰€ç¤º: 20.Class.forName()å’ŒClassLoader.loadClass()åŒºåˆ«? Class.forName(): å°†ç±»çš„.classæ–‡ä»¶åŠ è½½åˆ°jvmä¸­ä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹ç±»è¿›è¡Œè§£é‡Šï¼Œæ‰§è¡Œç±»ä¸­çš„staticå—ï¼› ClassLoader.loadClass(): åªå¹²ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å°†.classæ–‡ä»¶åŠ è½½åˆ°jvmä¸­ï¼Œä¸ä¼šæ‰§è¡Œstaticä¸­çš„å†…å®¹,åªæœ‰åœ¨newInstanceæ‰ä¼šå»æ‰§è¡Œstaticå—ã€‚ Class.forName(name, initialize, loader)å¸¦å‚å‡½æ•°ä¹Ÿå¯æ§åˆ¶æ˜¯å¦åŠ è½½staticå—ã€‚å¹¶ä¸”åªæœ‰è°ƒç”¨äº†newInstance()æ–¹æ³•é‡‡ç”¨è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ›å»ºç±»çš„å¯¹è±¡ ã€‚ 21.ä»€ä¹ˆæ˜¯ TLAB ï¼ˆThread Local Allocation Bufferï¼‰? ä»å†…å­˜æ¨¡å‹è€Œä¸æ˜¯åƒåœ¾å›æ”¶çš„è§’åº¦ï¼Œå¯¹ Eden åŒºåŸŸç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼ŒJVM ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œå®ƒåŒ…å«åœ¨ Eden ç©ºé—´å†… å¤šçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨ TLAB å¯ä»¥é¿å…ä¸€ç³»åˆ—çš„éçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½æå‡å†…å­˜åˆ†é…çš„ååé‡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ç§å†…å­˜åˆ†é…æ–¹å¼ç§°ä¸ºå¿«é€Ÿåˆ†é…ç­–ç•¥ OpenJDK è¡ç”Ÿå‡ºæ¥çš„ JVM å¤§éƒ½æä¾›äº† TLAB è®¾è®¡ 22.ä¸ºä»€ä¹ˆè¦æœ‰ TLAB ? å †åŒºæ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°å †åŒºä¸­çš„å…±äº«æ•°æ® ç”±äºå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨ JVM ä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä»å †åŒºä¸­åˆ’åˆ†å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ ä¸ºé¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œè¿›è€Œå½±å“åˆ†é…é€Ÿåº¦ å°½ç®¡ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½èƒ½å¤Ÿåœ¨ TLAB ä¸­æˆåŠŸåˆ†é…å†…å­˜ï¼Œä½† JVM ç¡®å®æ˜¯å°† TLAB ä½œä¸ºå†…å­˜åˆ†é…çš„é¦–é€‰ã€‚ åœ¨ç¨‹åºä¸­ï¼Œå¯ä»¥é€šè¿‡ -XX:UseTLAB è®¾ç½®æ˜¯å¦å¼€å¯ TLAB ç©ºé—´ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒTLAB ç©ºé—´çš„å†…å­˜éå¸¸å°ï¼Œä»…å æœ‰æ•´ä¸ª Eden ç©ºé—´çš„ 1%ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ -XX:TLABWasteTargetPercent è®¾ç½® TLAB ç©ºé—´æ‰€å ç”¨ Eden ç©ºé—´çš„ç™¾åˆ†æ¯”å¤§å°ã€‚ ä¸€æ—¦å¯¹è±¡åœ¨ TLAB ç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼ŒJVM å°±ä¼šå°è¯•ç€é€šè¿‡ä½¿ç”¨åŠ é”æœºåˆ¶ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œç›´æ¥åœ¨ Eden ç©ºé—´ä¸­åˆ†é…å†…å­˜ã€‚ 23.ClassLoaderæºç è§£æClassLoader ä¸ç°æœ‰ç±»åŠ è½½çš„å…³ç³»ï¼š é™¤äº†ä»¥ä¸Šè™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥å®šåˆ¶è‡ªå·±çš„ç±»åŠ è½½å™¨ã€‚Java æä¾›äº†æŠ½è±¡ç±» java.lang.ClassLoaderï¼Œæ‰€æœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨éƒ½åº”è¯¥ç»§æ‰¿ ClassLoader ç±»ã€‚ 1ï¼‰ClassLoaderçš„ä¸»è¦æ–¹æ³•public final ClassLoader getParent()è¿”å›è¯¥ç±»åŠ è½½å™¨çš„è¶…ç±»åŠ è½½å™¨ public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundExceptionåŠ è½½åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹ã€‚å¦‚æœæ‰¾ä¸åˆ°ç±»ï¼Œåˆ™è¿”å›ClassNotFoundExceptionå¼‚å¸¸ã€‚ è¯¥æ–¹æ³•ä¸­çš„é€»è¾‘å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼çš„å®ç°ã€‚ protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundExceptionæŸ¥æ‰¾äºŒè¿›åˆ¶åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹ã€‚è¿™æ˜¯ä¸€ä¸ªå—ä¿æŠ¤çš„æ–¹æ³•ï¼ŒJVMé¼“åŠ±æˆ‘ä»¬é‡å†™æ­¤æ–¹æ³•ï¼Œéœ€è¦è‡ªå®šä¹‰åŠ è½½å™¨éµå¾ªåŒäº²å§”æ‰˜æœºåˆ¶ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æ£€æŸ¥å®Œçˆ¶ç±»åŠ è½½å™¨ä¹‹åè¢«loadClass()æ–¹æ³•è°ƒç”¨ã€‚ åœ¨JDK1.2ä¹‹å‰ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½æ—¶ï¼Œæ€»ä¼šå»ç»§æ‰¿ClassLoaderç±»å¹¶é‡å†™loadClassæ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½ç±»ã€‚ä½†æ˜¯åœ¨JDK1.2ä¹‹åå·²ä¸å†å»ºè®®ç”¨æˆ·å»è¦†ç›–loadClass()æ–¹æ³•ï¼Œè€Œæ˜¯å»ºè®®æŠŠè‡ªå®šä¹‰çš„ç±»åŠ è½½é€»è¾‘å†™åœ¨findClass()æ–¹æ³•ä¸­ï¼Œä»å‰é¢çš„åˆ†æå¯çŸ¥ï¼Œ findClass()æ–¹æ³•æ˜¯åœ¨loadClass()æ–¹æ³•ä¸­è¢«è°ƒç”¨çš„ï¼Œå½“loadClass()æ–¹æ³•ä¸­çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥åï¼Œåˆ™ä¼šè°ƒç”¨è‡ªå·±çš„findClass()æ–¹æ³•æ¥å®Œæˆç±»åŠ è½½ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ä¹Ÿç¬¦åˆåŒäº²å§”æ‰˜æ¨¡å¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ClassLoaderç±»ä¸­å¹¶æ²¡æœ‰å®ç°findClass()æ–¹æ³•çš„å…·ä½“ä»£ç é€»è¾‘ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ï¼ŒåŒæ—¶åº”è¯¥çŸ¥é“çš„æ˜¯findClassæ–¹æ³•é€šå¸¸æ˜¯å’ŒdefineClassæ–¹æ³•ä¸€èµ·ä½¿ç”¨çš„ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œä¼šç›´æ¥è¦†ç›–ClassLoaderçš„findClass()æ–¹æ³•å¹¶ç¼–å†™åŠ è½½è§„åˆ™ï¼Œå–å¾—è¦åŠ è½½ç±»çš„å­—èŠ‚ç åè½¬æ¢æˆæµï¼Œç„¶åè°ƒç”¨defineClass()æ–¹æ³•ç”Ÿæˆç±»çš„Classå¯¹è±¡ã€‚ protected final Class&lt;?&gt; defineClass(byte[] b, int off, int len)æ ¹æ®ç»™å®šçš„å­—èŠ‚æ•°ç»„bè½¬æ¢ä¸ºClassçš„å®ä¾‹ï¼Œoffå’Œlenå‚æ•°è¡¨ç¤ºå®é™…Classä¿¡æ¯åœ¨byteæ•°ç»„ä¸­çš„ä½ç½®å’Œé•¿åº¦ï¼Œå…¶ä¸­byteæ•°ç»„bæ˜¯ClassLoaderä»å¤–éƒ¨è·å–çš„ã€‚è¿™æ˜¯å—ä¿æŠ¤çš„æ–¹æ³•ï¼Œåªæœ‰åœ¨è‡ªå®šä¹‰ClassLoaderå­ç±»ä¸­å¯ä»¥ä½¿ç”¨ã€‚ defineClass()æ–¹æ³•æ˜¯ç”¨æ¥å°†byteå­—èŠ‚æµè§£ææˆJVMèƒ½å¤Ÿè¯†åˆ«çš„Classå¯¹è±¡(ClassLoaderä¸­å·²å®ç°è¯¥æ–¹æ³•é€»è¾‘)ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•ä¸ä»…èƒ½å¤Ÿé€šè¿‡classæ–‡ä»¶å®ä¾‹åŒ–classå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼å®ä¾‹åŒ–classå¯¹è±¡ï¼Œå¦‚é€šè¿‡ç½‘ç»œæ¥æ”¶ä¸€ä¸ªç±»çš„å­—èŠ‚ç ï¼Œç„¶åè½¬æ¢ä¸ºbyteå­—èŠ‚æµåˆ›å»ºå¯¹åº”çš„Classå¯¹è±¡ã€‚ defineClass()æ–¹æ³•é€šå¸¸ä¸findClass()æ–¹æ³•ä¸€èµ·ä½¿ç”¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œä¼šç›´æ¥è¦†ç›–ClassLoaderçš„findClass()æ–¹æ³•å¹¶ç¼–å†™åŠ è½½è§„åˆ™ï¼Œå–å¾—è¦åŠ è½½ç±»çš„å­—èŠ‚ç åè½¬æ¢æˆæµï¼Œç„¶åè°ƒç”¨defineClass()æ–¹æ³•ç”Ÿæˆç±»çš„Classå¯¹è±¡ã€‚ 123456789101112131415/** * ç¼–å†™findClassæ–¹æ³•çš„é€»è¾‘ */ @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; // è·å–ç±»çš„classæ–‡ä»¶å­—èŠ‚æ•°ç»„ byte[] classData = getClassData(name); if (classData == null) &#123; throw new ClassNotFoundException(); &#125; else &#123; //ç›´æ¥ç”Ÿæˆclasså¯¹è±¡ return defineClass(name, classData, 0, classData.length); &#125; &#125; protected final void resolveClass(Class&lt;?&gt; c)é“¾æ¥æŒ‡å®šçš„ä¸€ä¸ªJavaç±»ã€‚ä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥ä½¿ç”¨ç±»çš„Classå¯¹è±¡åˆ›å»ºå®Œæˆçš„åŒæ—¶ä¹Ÿè¢«è§£æ(å³åŠ è½½çš„åŒæ—¶ä¹Ÿè¿›è¡Œè§£æ)ã€‚å‰é¢æˆ‘ä»¬è¯´é“¾æ¥é˜¶æ®µä¸»è¦æ˜¯å¯¹å­—èŠ‚ç è¿›è¡ŒéªŒè¯ï¼Œä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®åˆå§‹å€¼åŒæ—¶å°†å­—èŠ‚ç æ–‡ä»¶ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚ protected final Class&lt;?&gt; findLoadedClass(String name)æŸ¥æ‰¾åç§°ä¸ºnameçš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯finalæ–¹æ³•ï¼Œæ— æ³•è¢«ä¿®æ”¹ã€‚ private final ClassLoader parentå®ƒä¹Ÿæ˜¯ä¸€ä¸ªClassLoaderçš„å®ä¾‹ï¼Œè¿™ä¸ªå­—æ®µæ‰€è¡¨ç¤ºçš„ClassLoaderä¹Ÿç§°ä¸ºè¿™ä¸ªClassLoaderçš„åŒäº²ã€‚åœ¨ç±»åŠ è½½çš„è¿‡ç¨‹ä¸­,ClassLoaderå¯èƒ½ä¼šå°†æŸäº›è¯·æ±‚äº¤äºˆè‡ªå·±çš„åŒäº²å¤„ç†ã€‚ â‘ loadClass()çš„å‰–ææµ‹è¯•ä»£ç  1ClassLoader.getSystemClassLoader().loadClass(&quot;com.atguig.java.User&quot;); æ¶‰åŠåˆ°å¯¹å¦‚ä¸‹æ–¹æ³•çš„è°ƒç”¨ 123456789101112131415161718192021222324252627282930313233343536373839404142protected Class&lt;?&gt; loadClass(String name, boolean resolve)//resolve:true-åŠ è½½classçš„åŒæ—¶è¿›è¡Œè§£ææ“ä½œã€‚ throws ClassNotFoundException&#123; synchronized (getClassLoadingLock(name)) &#123; //åŒæ­¥æ“ä½œï¼Œä¿è¯åªèƒ½åŠ è½½ä¸€æ¬¡ã€‚ // First, check if the class has already been loaded //é¦–å…ˆï¼Œåœ¨ç¼“å­˜ä¸­åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½åŒåçš„ç±» Class&lt;?&gt; c = findLoadedClass(name); if (c == null) &#123; long t0 = System.nanoTime(); try &#123; //è·å–å½“å‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ã€‚ if (parent != null) &#123; //å¦‚æœå­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è°ƒç”¨çˆ¶ç±»åŠ è½½å™¨è¿›è¡Œç±»çš„åŠ è½½ï¼ˆé€’å½’ï¼‰ c = parent.loadClass(name, false); &#125; else &#123; //parentä¸ºnull:çˆ¶ç±»åŠ è½½å™¨æ˜¯å¼•å¯¼ç±»åŠ æ•™å™¨ c = findBootstrapClassOrNull(name); &#125; &#125; catch (ClassNotFoundException e) &#123; // ClassNotFoundException thrown if class not found // from the non-null parent class loader &#125; if (c == null) &#123;//å½“å‰ç±»çš„åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æœªåŠ è½½æ­¤ç±»oræ­¤ç±»çš„åŠ è½½å™¨æœªåŠ è½½æ­¤ç±» // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); //è°ƒç”¨å½“å‰ClassLoaderçš„findClass() c = findClass(name); // this is the defining class loader; record the stats sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0); sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); &#125; &#125; if (resolve) &#123; //æ˜¯å¦è¿›è¡Œè§£ææ“ä½œ resolveClass(c); &#125; return c; &#125;&#125; 2ï¼‰SecureClassLoaderä¸URLClassLoaderæ¥ç€SecureClassLoaderæ‰©å±•äº†ClassLoaderï¼Œæ–°å¢äº†å‡ ä¸ªä¸ä½¿ç”¨ç›¸å…³çš„ä»£ç æº(å¯¹ä»£ç æºçš„ä½ç½®åŠå…¶è¯ä¹¦çš„éªŒè¯)å’Œæƒé™å®šä¹‰ç±»éªŒè¯(ä¸»è¦æŒ‡å¯¹classæºç çš„è®¿é—®æƒé™)çš„æ–¹æ³•ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¸ä¼šç›´æ¥è·Ÿè¿™ä¸ªç±»æ‰“äº¤é“ï¼Œæ›´å¤šæ˜¯ä¸å®ƒçš„å­ç±»URLClassLoaderæœ‰æ‰€å…³è”ã€‚ å‰é¢è¯´è¿‡ï¼ŒClassLoaderæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¾ˆå¤šæ–¹æ³•æ˜¯ç©ºçš„æ²¡æœ‰å®ç°ï¼Œæ¯”å¦‚ findClass()ã€findResource()ç­‰ã€‚è€ŒURLClassLoaderè¿™ä¸ªå®ç°ç±»ä¸ºè¿™äº›æ–¹æ³•æä¾›äº†å…·ä½“çš„å®ç°ã€‚å¹¶æ–°å¢äº†URLClassPathç±»ååŠ©å–å¾—Classå­—èŠ‚ç æµç­‰åŠŸèƒ½ã€‚åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿URLClassLoaderç±»ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è‡ªå·±å»ç¼–å†™findClass()æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´ã€‚ 3ï¼‰ExtClassLoaderä¸AppClassLoaderäº†è§£å®ŒURLClassLoaderåæ¥ç€çœ‹çœ‹å‰©ä½™çš„ä¸¤ä¸ªç±»åŠ è½½å™¨ï¼Œå³æ‹“å±•ç±»åŠ è½½å™¨ExtClassLoaderå’Œç³»ç»Ÿç±»åŠ è½½AppClassLoaderï¼Œè¿™ä¸¤ä¸ªç±»éƒ½ç»§æ‰¿è‡ªURLClassLoaderï¼Œæ˜¯sun.misc.Launcherçš„é™æ€å†…éƒ¨ç±»ã€‚ sun.misc.Launcherä¸»è¦è¢«ç³»ç»Ÿç”¨äºå¯åŠ¨ä¸»åº”ç”¨ç¨‹åºï¼ŒExtClassLoaderå’ŒAppClassLoaderéƒ½æ˜¯ç”±sun.misc.Launcheråˆ›å»ºçš„ï¼Œå…¶ç±»ä¸»è¦ç±»ç»“æ„å¦‚ä¸‹: æˆ‘ä»¬å‘ç°ExtClassLoaderå¹¶æ²¡æœ‰é‡å†™loadClass()æ–¹æ³•ï¼Œè¿™è¶³çŸ£è¯´æ˜å…¶éµå¾ªåŒäº²å§”æ´¾æ¨¡å¼ï¼Œè€ŒAppClassLoaderé‡è½½äº†loadclass()æ–¹æ³•ï¼Œä½†æœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯çˆ¶ç±»loadClass()æ–¹æ³•ï¼Œå› æ­¤ä¾ç„¶éµå®ˆåŒäº²å§”æ´¾æ¨¡å¼ã€‚ 4ï¼‰Class.forNameä¸ClassLoader.loadClass()Class.forName():æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•,æœ€å¸¸ç”¨çš„æ˜¯Class.forName(String className);æ ¹æ®ä¼ å…¥çš„ç±»çš„å…¨é™å®šåè¿”å›ä¸€ä¸ªClasså¯¹è±¡ã€‚è¯¥æ–¹æ³•åœ¨å°†Classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜çš„åŒæ—¶,ä¼šæ‰§è¡Œç±»çš„åˆå§‹åŒ–ã€‚ å¦‚:Class.forName( &quot;com.atguigu.java.Helloworld&quot;) ; 12ClassLoader.loadClass()`:è¿™æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•,éœ€è¦ä¸€ä¸ª`ClassLoader`å¯¹è±¡æ¥è°ƒç”¨è¯¥æ–¹æ³•ã€‚è¯¥æ–¹æ³•å°†classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜æ—¶,å¹¶ä¸ä¼šæ‰§è¡Œç±»çš„åˆå§‹åŒ–,ç›´åˆ°è¿™ä¸ªç±»ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰è¿›è¡Œåˆå§‹åŒ–ã€‚è¯¥æ–¹æ³•å› ä¸ºéœ€è¦å¾—åˆ°ä¸ª`ClassLoader`å¯¹è±¡,æ‰€ä»¥å¯ä»¥æ ¹æ®éœ€è¦æŒ‡å®šä½¿ç”¨å“ªä¸ªç±»åŠ è½½å™¨.å¦‚: `ClassLoader cl=......;cl.loadClass (&quot;com.atguigu.java.Helloworld&quot; ); 24.ç±»åŠ è½½å™¨Java9æ–°ç‰¹æ€§ä¸ºäº†ä¿è¯å…¼å®¹æ€§ï¼ŒJDK 9æ²¡æœ‰ä»æ ¹æœ¬ä¸Šæ”¹å˜ä¸‰å±‚ç±»åŠ è½½å™¨æ¶æ„å’ŒåŒäº²å§”æ´¾æ¨¡å‹ï¼Œä½†ä¸ºäº†æ¨¡å—åŒ–ç³»ç»Ÿçš„é¡ºåˆ©è¿è¡Œï¼Œä»ç„¶å‘ç”Ÿäº†ä¸€äº›å€¼å¾—è¢«æ³¨æ„çš„å˜åŠ¨ã€‚ 1.æ‰©å±•æœºåˆ¶è¢«ç§»é™¤ï¼Œæ‰©å±•ç±»åŠ è½½å™¨ç”±äºå‘åå…¼å®¹æ€§çš„åŸå› è¢«ä¿ç•™ï¼Œä¸è¿‡è¢«é‡å‘½åä¸ºå¹³å°ç±»åŠ è½½å™¨ï¼ˆplatform classloader)ã€‚å¯ä»¥é€šè¿‡ClassLoaderçš„æ–°æ–¹æ³•getPlatformClassLoader()æ¥è·å–ã€‚ JDK 9æ—¶åŸºäºæ¨¡å—åŒ–è¿›è¡Œæ„å»ºï¼ˆåŸæ¥çš„ rt.jar å’Œ tools.jar è¢«æ‹†åˆ†æˆæ•°åä¸ª JMOD æ–‡ä»¶)ï¼Œå…¶ä¸­çš„Javaç±»åº“å°±å·²å¤©ç„¶åœ°æ»¡è¶³äº†å¯æ‰©å±•çš„éœ€æ±‚ï¼Œé‚£è‡ªç„¶æ— é¡»å†ä¿ç•™\\lib\\ext ç›®å½•ï¼Œæ­¤å‰ä½¿ç”¨è¿™ä¸ªç›®å½•æˆ–è€… java.ext.dirsç³»ç»Ÿå˜é‡æ¥æ‰©å±•JDKåŠŸèƒ½çš„æœºåˆ¶å·²ç»æ²¡æœ‰ç»§ç»­å­˜åœ¨çš„ä»·å€¼äº†ã€‚ 2.å¹³å°ç±»åŠ è½½å™¨å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨éƒ½ä¸å†ç»§æ‰¿è‡ª java.net.URLClassLoaderã€‚ ç°åœ¨å¯åŠ¨ç±»åŠ è½½å™¨ã€å¹³å°ç±»åŠ è½½å™¨ã€åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨å…¨éƒ½ç»§æ‰¿äºjdk.internal.loader.BuiltinClassLoaderã€‚ å¦‚æœæœ‰ç¨‹åºç›´æ¥ä¾èµ–äº†è¿™ç§ç»§æ‰¿å…³ç³»ï¼Œæˆ–è€…ä¾èµ–äº†URLClassLoaderç±»çš„ç‰¹å®šæ–¹æ³•ï¼Œé‚£ä»£ç å¾ˆå¯èƒ½ä¼šåœ¨ JDK9åŠæ›´é«˜ç‰ˆæœ¬çš„JDKä¸­å´©æºƒã€‚ 3.åœ¨Java 9ä¸­ï¼Œç±»åŠ è½½å™¨æœ‰äº†åç§°ã€‚è¯¥åç§°åœ¨æ„é€ æ–¹æ³•ä¸­æŒ‡å®šï¼Œå¯ä»¥é€šè¿‡getName()æ–¹æ³•æ¥è·å–ã€‚å¹³å°ç±»åŠ è½½å™¨çš„åç§°æ˜¯platformï¼Œåº”ç”¨ç±»åŠ è½½å™¨çš„åç§°æ˜¯appã€‚ç±»åŠ è½½å™¨çš„åç§°åœ¨è°ƒè¯•ä¸ç±»åŠ è½½å™¨ç›¸å…³çš„é—®é¢˜æ—¶ä¼šéå¸¸æœ‰ç”¨ã€‚ 4.å¯åŠ¨ç±»åŠ è½½å™¨ç°åœ¨æ˜¯åœ¨jvmå†…éƒ¨å’Œjavaç±»åº“å…±åŒåä½œå®ç°çš„ç±»åŠ è½½å™¨ã€ˆä»¥å‰æ˜¯C++å®ç°)ï¼Œä½†ä¸ºäº†ä¸ä¹‹å‰ä»£ç å…¼å®¹ï¼Œåœ¨è·å–å¯åŠ¨ç±»åŠ è½½å™¨çš„åœºæ™¯ä¸­ä»ç„¶ä¼šè¿”å›nullï¼Œè€Œä¸ä¼šå¾—åˆ°BootClassLoaderå®ä¾‹ã€‚ 5.ç±»åŠ è½½çš„å§”æ´¾å…³ç³»ä¹Ÿå‘ç”Ÿäº†å˜åŠ¨ã€‚ å½“å¹³å°åŠåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚ï¼Œåœ¨å§”æ´¾ç»™çˆ¶åŠ è½½å™¨åŠ è½½å‰ï¼Œè¦å…ˆåˆ¤æ–­è¯¥ç±»æ˜¯å¦èƒ½å¤Ÿå½’å±åˆ°æŸä¸€ä¸ªç³»ç»Ÿæ¨¡å—ä¸­ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°è¿™æ ·çš„å½’å±å…³ç³»ï¼Œå°±è¦ä¼˜å…ˆå§”æ´¾ç»™è´Ÿè´£é‚£ä¸ªæ¨¡å—çš„åŠ è½½å™¨å®ŒæˆåŠ è½½ã€‚ åœ¨Javaæ¨¡å—åŒ–ç³»ç»Ÿæ˜ç¡®è§„å®šäº†ä¸‰ä¸ªç±»åŠ è½½å™¨è´Ÿè´£å„è‡ªåŠ è½½çš„æ¨¡å—ã€‚ 25.ä¸¤ç§ç±»è£…è½½æ–¹å¼Javaä¸­çš„æ‰€æœ‰ç±»ï¼Œéƒ½éœ€è¦ç”±ç±»åŠ è½½å™¨è£…è½½åˆ°JVMä¸­æ‰èƒ½è¿è¡Œã€‚ç±»åŠ è½½å™¨æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç±»ï¼Œè€Œå®ƒçš„å·¥ä½œå°±æ˜¯æŠŠclassæ–‡ä»¶ä»ç¡¬ç›˜è¯»å–åˆ°å†…å­˜ä¸­ã€‚åœ¨å†™ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å‡ ä¹ä¸éœ€è¦å…³å¿ƒç±»çš„åŠ è½½ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯éšå¼è£…è½½çš„ï¼Œé™¤éæˆ‘ä»¬æœ‰ç‰¹æ®Šçš„ç”¨æ³•ï¼Œåƒæ˜¯åå°„ï¼Œå°±éœ€è¦æ˜¾å¼çš„åŠ è½½æ‰€éœ€è¦çš„ç±»ã€‚ ç±»è£…è½½æ–¹å¼ï¼Œæœ‰ä¸¤ç§ ï¼š 1.éšå¼è£…è½½ï¼Œ ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å½“ç¢°åˆ°é€šè¿‡new ç­‰æ–¹å¼ç”Ÿæˆå¯¹è±¡æ—¶ï¼Œéšå¼è°ƒç”¨ç±»è£…è½½å™¨åŠ è½½å¯¹åº”çš„ç±»åˆ°jvmä¸­ï¼Œ 2.æ˜¾å¼è£…è½½ï¼Œ é€šè¿‡class.forname()ç­‰æ–¹æ³•ï¼Œæ˜¾å¼åŠ è½½éœ€è¦çš„ç±» Javaç±»çš„åŠ è½½æ˜¯åŠ¨æ€çš„ï¼Œå®ƒå¹¶ä¸ä¼šä¸€æ¬¡æ€§å°†æ‰€æœ‰ç±»å…¨éƒ¨åŠ è½½åå†è¿è¡Œï¼Œè€Œæ˜¯ä¿è¯ç¨‹åºè¿è¡Œçš„åŸºç¡€ç±»(åƒæ˜¯åŸºç±»)å®Œå…¨åŠ è½½åˆ°jvmä¸­ï¼Œè‡³äºå…¶ä»–ç±»ï¼Œåˆ™åœ¨éœ€è¦çš„æ—¶å€™æ‰åŠ è½½ã€‚è¿™å½“ç„¶å°±æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜å¼€é”€ã€‚ 26.æ·±æ‹·è´å’Œæµ…æ‹·è´æµ…æ‹·è´ï¼ˆshallowCopyï¼‰åªæ˜¯å¢åŠ äº†ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å·²å­˜åœ¨çš„å†…å­˜åœ°å€ï¼Œ æ·±æ‹·è´ï¼ˆdeepCopyï¼‰æ˜¯å¢åŠ äº†ä¸€ä¸ªæŒ‡é’ˆå¹¶ä¸”ç”³è¯·äº†ä¸€ä¸ªæ–°çš„å†…å­˜ï¼Œä½¿è¿™ä¸ªå¢åŠ çš„æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªæ–°çš„å†…å­˜ï¼Œ ä½¿ç”¨æ·±æ‹·è´çš„æƒ…å†µä¸‹ï¼Œé‡Šæ”¾å†…å­˜çš„æ—¶å€™ä¸ä¼šå› ä¸ºå‡ºç°æµ…æ‹·è´æ—¶é‡Šæ”¾åŒä¸€ä¸ªå†…å­˜çš„é”™è¯¯ã€‚ æµ…å¤åˆ¶ï¼šä»…ä»…æ˜¯æŒ‡å‘è¢«å¤åˆ¶çš„å†…å­˜åœ°å€ï¼Œå¦‚æœåŸåœ°å€å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæµ…å¤åˆ¶å‡ºæ¥çš„å¯¹è±¡ä¹Ÿä¼šç›¸åº”çš„æ”¹å˜ã€‚ æ·±å¤åˆ¶ï¼šåœ¨è®¡ç®—æœºä¸­å¼€è¾Ÿä¸€å—æ–°çš„å†…å­˜åœ°å€ç”¨äºå­˜æ”¾å¤åˆ¶çš„å¯¹è±¡ã€‚ 27.å¯¹è±¡åˆ›å»ºçš„å‡ ç§æ–¹å¼ 28.ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ä¸¤ç§æ–¹å¼ç±»åŠ è½½å®Œæˆåï¼Œæ¥ç€ä¼šåœ¨Javaå †ä¸­åˆ’åˆ†ä¸€å—å†…å­˜åˆ†é…ç»™å¯¹è±¡ã€‚å†…å­˜åˆ†é…æ ¹æ®Javaå †æ˜¯å¦è§„æ•´ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š æŒ‡é’ˆç¢°æ’ï¼šå¦‚æœJavaå †çš„å†…å­˜æ˜¯è§„æ•´ï¼Œå³æ‰€æœ‰ç”¨è¿‡çš„å†…å­˜æ”¾åœ¨ä¸€è¾¹ï¼Œè€Œç©ºé—²çš„çš„æ”¾åœ¨å¦ä¸€è¾¹ã€‚åˆ†é…å†…å­˜æ—¶å°†ä½äºä¸­é—´çš„æŒ‡é’ˆæŒ‡ç¤ºå™¨å‘ç©ºé—²çš„å†…å­˜ç§»åŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»ï¼Œè¿™æ ·ä¾¿å®Œæˆåˆ†é…å†…å­˜å·¥ä½œã€‚ ç©ºé—²åˆ—è¡¨ï¼šå¦‚æœJavaå †çš„å†…å­˜ä¸æ˜¯è§„æ•´çš„ï¼Œåˆ™éœ€è¦ç”±è™šæ‹Ÿæœºç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨æ¥è®°å½•é‚£äº›å†…å­˜æ˜¯å¯ç”¨çš„ï¼Œè¿™æ ·åœ¨åˆ†é…çš„æ—¶å€™å¯ä»¥ä»åˆ—è¡¨ä¸­æŸ¥è¯¢åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜åˆ†é…ç»™å¯¹è±¡ï¼Œå¹¶åœ¨åˆ†é…åæ›´æ–°åˆ—è¡¨è®°å½•ã€‚ é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼æ˜¯ç”± Java å †æ˜¯å¦è§„æ•´æ¥å†³å®šçš„ï¼Œè€Œ Java å †æ˜¯å¦è§„æ•´åˆç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†åŠŸèƒ½å†³å®šã€‚ 29.å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ä¸­å¤„ç†å¹¶å‘å®‰å…¨é—®é¢˜å¯¹è±¡çš„åˆ›å»ºåœ¨è™šæ‹Ÿæœºä¸­æ˜¯ä¸€ä¸ªéå¸¸é¢‘ç¹çš„è¡Œä¸ºï¼Œå“ªæ€•åªæ˜¯ä¿®æ”¹ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„ä½ç½®ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½å‡ºç°æ­£åœ¨ç»™å¯¹è±¡ A åˆ†é…å†…å­˜ï¼ŒæŒ‡é’ˆè¿˜æ²¡æ¥å¾—åŠä¿®æ”¹ï¼Œå¯¹è±¡ B åˆåŒæ—¶ä½¿ç”¨äº†åŸæ¥çš„æŒ‡é’ˆæ¥åˆ†é…å†…å­˜çš„æƒ…å†µã€‚è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š å¯¹åˆ†é…å†…å­˜ç©ºé—´çš„åŠ¨ä½œè¿›è¡ŒåŒæ­¥å¤„ç†ï¼ˆé‡‡ç”¨ CAS + å¤±è´¥é‡è¯•æ¥ä¿éšœæ›´æ–°æ“ä½œçš„åŸå­æ€§ï¼‰ï¼› æŠŠå†…å­˜åˆ†é…çš„åŠ¨ä½œæŒ‰ç…§çº¿ç¨‹åˆ’åˆ†åœ¨ä¸åŒçš„ç©ºé—´ä¹‹ä¸­è¿›è¡Œï¼Œå³æ¯ä¸ªçº¿ç¨‹åœ¨ Java å †ä¸­é¢„å…ˆåˆ†é…ä¸€å°å—å†…å­˜ï¼Œç§°ä¸ºæœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²ï¼ˆThread Local Allocation Buffer, TLABï¼‰ã€‚å“ªä¸ªçº¿ç¨‹è¦åˆ†é…å†…å­˜ï¼Œå°±åœ¨å“ªä¸ªçº¿ç¨‹çš„ TLAB ä¸Šåˆ†é…ã€‚åªæœ‰ TLAB ç”¨å®Œå¹¶åˆ†é…æ–°çš„ TLAB æ—¶ï¼Œæ‰éœ€è¦åŒæ­¥é”ã€‚é€šè¿‡-XX:+/-UserTLABå‚æ•°æ¥è®¾å®šè™šæ‹Ÿæœºæ˜¯å¦ä½¿ç”¨TLABã€‚ 30.ä»‹ç»ä¸€ä¸‹å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨çš„åŒºåˆ«ï¼Ÿ1ï¼‰å¼ºå¼•ç”¨ æˆ‘ä»¬å¹³æ—¶newäº†ä¸€ä¸ªå¯¹è±¡å°±æ˜¯å¼ºå¼•ç”¨ï¼Œä¾‹å¦‚ Object obj = new Object(); å³ä½¿åœ¨å†…å­˜ä¸è¶³çš„æƒ…å†µä¸‹ï¼ŒJVMå®æ„¿æŠ›å‡ºOutOfMemoryé”™è¯¯ä¹Ÿä¸ä¼šå›æ”¶è¿™ç§å¯¹è±¡ã€‚ 2ï¼‰è½¯å¼•ç”¨ å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è½¯å¼•ç”¨ï¼Œåˆ™å†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶å®ƒï¼›å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³äº†ï¼Œå°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡çš„å†…å­˜ã€‚ 1SoftReference&lt;String&gt; softRef=new SoftReference&lt;String&gt;(str); // è½¯å¼•ç”¨ ç”¨å¤„ï¼š è½¯å¼•ç”¨åœ¨å®é™…ä¸­æœ‰é‡è¦çš„åº”ç”¨ï¼Œä¾‹å¦‚æµè§ˆå™¨çš„åé€€æŒ‰é’®ã€‚æŒ‰åé€€æ—¶ï¼Œè¿™ä¸ªåé€€æ—¶æ˜¾ç¤ºçš„ç½‘é¡µå†…å®¹æ˜¯é‡æ–°è¿›è¡Œè¯·æ±‚è¿˜æ˜¯ä»ç¼“å­˜ä¸­å–å‡ºå‘¢ï¼Ÿè¿™å°±è¦çœ‹å…·ä½“çš„å®ç°ç­–ç•¥äº†ã€‚ ï¼ˆ1ï¼‰å¦‚æœä¸€ä¸ªç½‘é¡µåœ¨æµè§ˆç»“æŸæ—¶å°±è¿›è¡Œå†…å®¹çš„å›æ”¶ï¼Œåˆ™æŒ‰åé€€æŸ¥çœ‹å‰é¢æµè§ˆè¿‡çš„é¡µé¢æ—¶ï¼Œéœ€è¦é‡æ–°æ„å»º ï¼ˆ2ï¼‰å¦‚æœå°†æµè§ˆè¿‡çš„ç½‘é¡µå­˜å‚¨åˆ°å†…å­˜ä¸­ä¼šé€ æˆå†…å­˜çš„å¤§é‡æµªè´¹ï¼Œç”šè‡³ä¼šé€ æˆå†…å­˜æº¢å‡º å¦‚ä¸‹ä»£ç ï¼š 12345678Browser prev = new Browser(); // è·å–é¡µé¢è¿›è¡Œæµè§ˆSoftReference sr = new SoftReference(prev); // æµè§ˆå®Œæ¯•åç½®ä¸ºè½¯å¼•ç”¨ if(sr.get()!=null)&#123; rev = (Browser) sr.get(); // è¿˜æ²¡æœ‰è¢«å›æ”¶å™¨å›æ”¶ï¼Œç›´æ¥è·å–&#125;else&#123; prev = new Browser(); // ç”±äºå†…å­˜åƒç´§ï¼Œæ‰€ä»¥å¯¹è½¯å¼•ç”¨çš„å¯¹è±¡å›æ”¶äº† sr = new SoftReference(prev); // é‡æ–°æ„å»º&#125; 3ï¼‰å¼±å¼•ç”¨ å…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒæ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ 123456String str=new String(&quot;abc&quot;); WeakReference&lt;String&gt; abcWeakRef = new WeakReference&lt;String&gt;(str);str=null;ç­‰ä»·äºstr = null;System.gc(); 4ï¼‰è™šå¼•ç”¨ å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚è™šå¼•ç”¨ä¸»è¦ç”¨æ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶çš„æ´»åŠ¨ã€‚ 31.æ€ä¹ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶ï¼Ÿåƒåœ¾æ”¶é›†å™¨åœ¨åšåƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦åˆ¤å®šçš„å°±æ˜¯å“ªäº›å†…å­˜æ˜¯éœ€è¦è¢«å›æ”¶çš„ï¼Œå“ªäº›å¯¹è±¡æ˜¯ã€Œå­˜æ´»ã€çš„ï¼Œæ˜¯ä¸å¯ä»¥è¢«å›æ”¶çš„ï¼›å“ªäº›å¯¹è±¡å·²ç»ã€Œæ­»æ‰ã€äº†ï¼Œéœ€è¦è¢«å›æ”¶ã€‚ ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•æ¥åˆ¤æ–­ï¼š å¼•ç”¨è®¡æ•°å™¨æ³•ï¼šä¸ºæ¯ä¸ªå¯¹è±¡åˆ›å»ºä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œæœ‰å¯¹è±¡å¼•ç”¨æ—¶è®¡æ•°å™¨ +1ï¼Œå¼•ç”¨è¢«é‡Šæ”¾æ—¶è®¡æ•° -1ï¼Œå½“è®¡æ•°å™¨ä¸º 0 æ—¶å°±å¯ä»¥è¢«å›æ”¶ã€‚å®ƒæœ‰ä¸€ä¸ªç¼ºç‚¹ä¸èƒ½è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼› å¯è¾¾æ€§åˆ†æç®—æ³•ï¼šä» GC Roots å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ã€‚å½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Roots æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯å¯ä»¥è¢«å›æ”¶çš„ã€‚ 32.åœ¨Javaä¸­ï¼Œå¯¹è±¡ä»€ä¹ˆæ—¶å€™å¯ä»¥è¢«åƒåœ¾å›æ”¶å½“å¯¹è±¡å¯¹å½“å‰ä½¿ç”¨è¿™ä¸ªå¯¹è±¡çš„åº”ç”¨ç¨‹åºå˜å¾—ä¸å¯è§¦åŠçš„æ—¶å€™ï¼Œè¿™ä¸ªå¯¹è±¡å°±å¯ä»¥è¢«å›æ”¶äº†ã€‚åƒåœ¾å›æ”¶ä¸ä¼šå‘ç”Ÿåœ¨æ°¸ä¹…ä»£ï¼Œå¦‚æœæ°¸ä¹…ä»£æ»¡äº†æˆ–è€…æ˜¯è¶…è¿‡äº†ä¸´ç•Œå€¼ï¼Œä¼šè§¦å‘å®Œå…¨åƒåœ¾å›æ”¶(Full GC)ã€‚å¦‚æœä½ ä»”ç»†æŸ¥çœ‹åƒåœ¾æ”¶é›†å™¨çš„è¾“å‡ºä¿¡æ¯ï¼Œå°±ä¼šå‘ç°æ°¸ä¹…ä»£ä¹Ÿæ˜¯è¢«å›æ”¶çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ­£ç¡®çš„æ°¸ä¹…ä»£å¤§å°å¯¹é¿å…Full GCæ˜¯éå¸¸é‡è¦çš„åŸå› ã€‚ 33.JVM è¿è¡Œæ—¶å †å†…å­˜å¦‚ä½•åˆ†ä»£?Java å †ä» GC çš„è§’åº¦è¿˜å¯ä»¥ç»†åˆ†ä¸º: æ–°ç”Ÿä»£(Eden åŒºã€ From Survivor åŒºå’Œ To Survivor åŒº)å’Œè€å¹´ä»£ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼š å †å¤§å° = æ–°ç”Ÿä»£ + è€å¹´ä»£ã€‚å…¶ä¸­ï¼Œå †çš„å¤§å°å¯ä»¥é€šè¿‡å‚æ•° â€“Xmsã€-Xmx æ¥æŒ‡å®šã€‚ é»˜è®¤çš„ï¼Œæ–°ç”Ÿä»£ ( Young ) ä¸è€å¹´ä»£ ( Old ) çš„æ¯”ä¾‹çš„å€¼ä¸º 1:2 ( è¯¥å€¼å¯ä»¥é€šè¿‡å‚æ•° â€“XX:NewRatio æ¥æŒ‡å®š )ï¼Œ å³ï¼šæ–°ç”Ÿä»£ ( Young ) = 1/3 çš„å †ç©ºé—´å¤§å°ã€‚è€å¹´ä»£ ( Old ) = 2/3 çš„å †ç©ºé—´å¤§å°ã€‚ å…¶ä¸­ï¼Œæ–°ç”Ÿä»£ ( Young ) è¢«ç»†åˆ†ä¸º Eden å’Œ ä¸¤ä¸ª Survivor åŒºåŸŸï¼Œè¿™ä¸¤ä¸ª Survivor åŒºåŸŸåˆ†åˆ«è¢«å‘½åä¸º from å’Œ toï¼Œä»¥ç¤ºåŒºåˆ† é»˜è®¤çš„ï¼ŒEden: from : to = 8 :1 : 1 ( å¯ä»¥é€šè¿‡å‚æ•°â€“XX:SurvivorRatio æ¥è®¾å®š )ï¼Œå³ï¼š Eden = 8/10 çš„æ–°ç”Ÿä»£ç©ºé—´å¤§å°ï¼Œfrom = to = 1/10 çš„æ–°ç”Ÿä»£ç©ºé—´å¤§å°ã€‚ JVM æ¯æ¬¡åªä¼šä½¿ç”¨ Eden å’Œå…¶ä¸­çš„ä¸€å— Survivor åŒºåŸŸæ¥ä¸ºå¯¹è±¡æœåŠ¡ï¼Œæ‰€ä»¥æ— è®ºä»€ä¹ˆæ—¶å€™ï¼Œæ€»æ˜¯æœ‰ä¸€å—SurvivoråŒºåŸŸæ˜¯ç©ºé—²ç€çš„ã€‚ å› æ­¤ï¼Œæ–°ç”Ÿä»£å®é™…å¯ç”¨çš„å†…å­˜ç©ºé—´ä¸º 9/10 ( å³90% )çš„æ–°ç”Ÿä»£ç©ºé—´ã€‚ æ–°ç”Ÿä»£ æ˜¯ç”¨æ¥å­˜æ”¾æ–°ç”Ÿçš„å¯¹è±¡ã€‚ä¸€èˆ¬å æ®å †çš„ 1/3 ç©ºé—´ã€‚ç”±äºé¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œæ‰€ä»¥æ–°ç”Ÿä»£ä¼šé¢‘ç¹è§¦å‘MinorGC è¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ–°ç”Ÿä»£åˆåˆ†ä¸º EdenåŒºã€ ServivorFromã€ ServivorTo ä¸‰ä¸ªåŒºã€‚Eden åŒºJava æ–°å¯¹è±¡çš„å‡ºç”Ÿåœ°ï¼ˆå¦‚æœæ–°åˆ›å»ºçš„å¯¹è±¡å ç”¨å†…å­˜å¾ˆå¤§ï¼Œåˆ™ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ï¼‰ã€‚å½“ Eden åŒºå†…å­˜ä¸å¤Ÿçš„æ—¶å€™å°±ä¼šè§¦å‘ MinorGCï¼Œå¯¹æ–°ç”Ÿä»£åŒºè¿›è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚Servivor from åŒºä¸Šä¸€æ¬¡ GC çš„å¹¸å­˜è€…ï¼Œä½œä¸ºè¿™ä¸€æ¬¡ GC çš„è¢«æ‰«æè€…ã€‚Servivor to åŒºä¿ç•™äº†ä¸€æ¬¡ MinorGC è¿‡ç¨‹ä¸­çš„å¹¸å­˜è€…ã€‚MinorGC çš„è¿‡ç¨‹ï¼ˆå¤åˆ¶-&gt;æ¸…ç©º-&gt;äº’æ¢ï¼‰MinorGC é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€‚ edenã€ servicorFrom å¤åˆ¶åˆ° ServicorToï¼Œå¹´é¾„+1é¦–å…ˆï¼ŒæŠŠ Eden å’Œ ServivorFrom åŒºåŸŸä¸­å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ° ServicorTo åŒºåŸŸï¼ˆå¦‚æœæœ‰å¯¹è±¡çš„å¹´é¾„ä»¥åŠè¾¾åˆ°äº†è€å¹´çš„æ ‡å‡†ï¼Œåˆ™èµ‹å€¼åˆ°è€å¹´ä»£åŒºï¼‰ï¼ŒåŒæ—¶æŠŠè¿™äº›å¯¹è±¡çš„å¹´é¾„+1ï¼ˆå¦‚æœ ServicorTo ä¸å¤Ÿä½ç½®äº†å°±æ”¾åˆ°è€å¹´åŒºï¼‰ï¼› æ¸…ç©º edenã€ servicorFromç„¶åï¼Œæ¸…ç©º Eden å’Œ ServicorFrom ä¸­çš„å¯¹è±¡ï¼› ServicorTo å’Œ ServicorFrom äº’æ¢æœ€åï¼Œ ServicorTo å’Œ ServicorFrom äº’æ¢ï¼ŒåŸ ServicorTo æˆä¸ºä¸‹ä¸€æ¬¡ GC æ—¶çš„ ServicorFromåŒºã€‚ è€å¹´ä»£ ä¸»è¦å­˜æ”¾åº”ç”¨ç¨‹åºä¸­ç”Ÿå‘½å‘¨æœŸé•¿çš„å†…å­˜å¯¹è±¡ã€‚è€å¹´ä»£çš„å¯¹è±¡æ¯”è¾ƒç¨³å®šï¼Œæ‰€ä»¥ MajorGC ï¼ˆå¸¸å¸¸ç§°ä¹‹ä¸º FULL GCï¼‰ä¸ä¼šé¢‘ç¹æ‰§è¡Œã€‚åœ¨è¿›è¡Œ FULL GCå‰ä¸€èˆ¬éƒ½å…ˆè¿›è¡Œäº†ä¸€æ¬¡ MinorGCï¼Œä½¿å¾—æœ‰æ–°ç”Ÿä»£çš„å¯¹è±¡æ™‹èº«å…¥è€å¹´ä»£ï¼Œå¯¼è‡´ç©ºé—´ä¸å¤Ÿç”¨æ—¶æ‰è§¦å‘ã€‚å½“æ— æ³•æ‰¾åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´åˆ†é…ç»™æ–°åˆ›å»ºçš„è¾ƒå¤§å¯¹è±¡æ—¶ä¹Ÿä¼šæå‰è§¦å‘ä¸€æ¬¡ MajorGC è¿›è¡Œåƒåœ¾å›æ”¶è…¾å‡ºç©ºé—´ã€‚FULL GC é‡‡ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•ï¼šé¦–å…ˆæ‰«æä¸€æ¬¡æ‰€æœ‰è€å¹´ä»£ï¼Œæ ‡è®°å‡ºå­˜æ´»çš„å¯¹è±¡ï¼Œç„¶åå›æ”¶æ²¡æœ‰æ ‡è®°çš„å¯¹è±¡ã€‚ ajorGC çš„è€—æ—¶æ¯”è¾ƒé•¿ï¼Œå› ä¸ºè¦æ‰«æå†å›æ”¶ã€‚ FULL GC ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œä¸ºäº†å‡å°‘å†…å­˜æŸè€—ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦è¿›è¡Œåˆå¹¶æˆ–è€…æ ‡è®°å‡ºæ¥æ–¹ä¾¿ä¸‹æ¬¡ç›´æ¥åˆ†é…ã€‚å½“è€å¹´ä»£ä¹Ÿæ»¡äº†è£…ä¸ä¸‹çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡º OOMï¼ˆOut of Memoryï¼‰å¼‚å¸¸ã€‚ æ°¸ä¹…ä»£ æŒ‡å†…å­˜çš„æ°¸ä¹…ä¿å­˜åŒºåŸŸï¼Œä¸»è¦å­˜æ”¾ Class å’Œ Metaï¼ˆå…ƒæ•°æ®ï¼‰çš„ä¿¡æ¯,Class åœ¨è¢«åŠ è½½çš„æ—¶å€™è¢«æ”¾å…¥æ°¸ä¹…åŒºåŸŸï¼Œ å®ƒå’Œå’Œå­˜æ”¾å®ä¾‹çš„åŒºåŸŸä¸åŒ,GC ä¸ä¼šåœ¨ä¸»ç¨‹åºè¿è¡ŒæœŸå¯¹æ°¸ä¹…åŒºåŸŸè¿›è¡Œæ¸…ç†ã€‚æ‰€ä»¥è¿™ä¹Ÿå¯¼è‡´äº†æ°¸ä¹…ä»£çš„åŒºåŸŸä¼šéšç€åŠ è½½çš„ Class çš„å¢å¤šè€Œèƒ€æ»¡ï¼Œæœ€ç»ˆæŠ›å‡º OOM å¼‚å¸¸ã€‚ 34.JVMå†…å­˜ä¸ºä»€ä¹ˆè¦åˆ†æˆæ–°ç”Ÿä»£ï¼Œè€å¹´ä»£ï¼ŒæŒä¹…ä»£ã€‚æ–°ç”Ÿä»£ä¸­ä¸ºä»€ä¹ˆè¦åˆ†ä¸ºEdenå’ŒSurvivorè¿™æ ·åˆ’åˆ†çš„ç›®çš„æ˜¯ä¸ºäº†ä½¿ JVM èƒ½å¤Ÿæ›´å¥½çš„ç®¡ç†å †å†…å­˜ä¸­çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬å†…å­˜çš„åˆ†é…ä»¥åŠå›æ”¶ã€‚ 1ï¼‰å…±äº«å†…å­˜åŒºåˆ’åˆ† å…±äº«å†…å­˜åŒº = æŒä¹…å¸¦ + å † æŒä¹…å¸¦ = æ–¹æ³•åŒº + å…¶ä»– Javaå † = è€å¹´ä»£ + æ–°ç”Ÿä»£ æ–°ç”Ÿä»£ = Eden + S0 + S1 2ï¼‰ä¸€äº›å‚æ•°çš„é…ç½® é»˜è®¤çš„ï¼Œæ–°ç”Ÿä»£ ( Young ) ä¸è€å¹´ä»£ ( Old ) çš„æ¯”ä¾‹çš„å€¼ä¸º 1:2 ï¼Œå¯ä»¥é€šè¿‡å‚æ•° â€“XX:NewRatio é…ç½®ã€‚ é»˜è®¤çš„ï¼ŒEden : from : to = 8 : 1 : 1 ( å¯ä»¥é€šè¿‡å‚æ•° â€“XX:SurvivorRatio æ¥è®¾å®š) SurvivoråŒºä¸­çš„å¯¹è±¡è¢«å¤åˆ¶æ¬¡æ•°ä¸º15(å¯¹åº”è™šæ‹Ÿæœºå‚æ•° -XX:+MaxTenuringThreshold) 35.ä¸ºä»€ä¹ˆè¦åˆ†ä¸ºEdenå’ŒSurvivor?ä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸¤ä¸ªSurvivoråŒºï¼Ÿ å¦‚æœæ²¡æœ‰Survivorï¼ŒEdenåŒºæ¯è¿›è¡Œä¸€æ¬¡Minor GCï¼Œå­˜æ´»çš„å¯¹è±¡å°±ä¼šè¢«é€åˆ°è€å¹´ä»£ã€‚è€å¹´ä»£å¾ˆå¿«è¢«å¡«æ»¡ï¼Œè§¦å‘Major GC.è€å¹´ä»£çš„å†…å­˜ç©ºé—´è¿œå¤§äºæ–°ç”Ÿä»£ï¼Œè¿›è¡Œä¸€æ¬¡Full GCæ¶ˆè€—çš„æ—¶é—´æ¯”Minor GCé•¿å¾—å¤š,æ‰€ä»¥éœ€è¦åˆ†ä¸ºEdenå’ŒSurvivorã€‚ Survivorçš„å­˜åœ¨æ„ä¹‰ï¼Œå°±æ˜¯å‡å°‘è¢«é€åˆ°è€å¹´ä»£çš„å¯¹è±¡ï¼Œè¿›è€Œå‡å°‘Full GCçš„å‘ç”Ÿï¼ŒSurvivorçš„é¢„ç­›é€‰ä¿è¯ï¼Œåªæœ‰ç»å†16æ¬¡Minor GCè¿˜èƒ½åœ¨æ–°ç”Ÿä»£ä¸­å­˜æ´»çš„å¯¹è±¡ï¼Œæ‰ä¼šè¢«é€åˆ°è€å¹´ä»£ã€‚ è®¾ç½®ä¸¤ä¸ªSurvivoråŒºæœ€å¤§çš„å¥½å¤„å°±æ˜¯è§£å†³äº†ç¢ç‰‡åŒ–ï¼Œåˆšåˆšæ–°å»ºçš„å¯¹è±¡åœ¨Edenä¸­ï¼Œç»å†ä¸€æ¬¡Minor GCï¼ŒEdenä¸­çš„å­˜æ´»å¯¹è±¡å°±ä¼šè¢«ç§»åŠ¨åˆ°ç¬¬ä¸€å—survivor space S0ï¼ŒEdenè¢«æ¸…ç©ºï¼›ç­‰EdenåŒºå†æ»¡äº†ï¼Œå°±å†è§¦å‘ä¸€æ¬¡Minor GCï¼ŒEdenå’ŒS0ä¸­çš„å­˜æ´»å¯¹è±¡åˆä¼šè¢«å¤åˆ¶é€å…¥ç¬¬äºŒå—survivor space S1ï¼ˆè¿™ä¸ªè¿‡ç¨‹éå¸¸é‡è¦ï¼Œå› ä¸ºè¿™ç§å¤åˆ¶ç®—æ³•ä¿è¯äº†S1ä¸­æ¥è‡ªS0å’ŒEdenä¸¤éƒ¨åˆ†çš„å­˜æ´»å¯¹è±¡å ç”¨è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œé¿å…äº†ç¢ç‰‡åŒ–çš„å‘ç”Ÿï¼‰ 36.JVMä¸­ä¸€æ¬¡å®Œæ•´çš„GCæµç¨‹æ˜¯æ€æ ·çš„ï¼Œå¯¹è±¡å¦‚ä½•æ™‹å‡åˆ°è€å¹´ä»£å…ˆæè¿°ä¸€ä¸‹Javaå †å†…å­˜åˆ’åˆ†ï¼Œå†è§£é‡ŠMinor GCï¼ŒMajor GCï¼Œfull GCï¼Œæè¿°å®ƒä»¬ä¹‹é—´è½¬åŒ–æµç¨‹ã€‚ Javaå † = è€å¹´ä»£ + æ–°ç”Ÿä»£ æ–°ç”Ÿä»£ = Eden + S0 + S1 å½“ Eden åŒºçš„ç©ºé—´æ»¡äº†ï¼Œ Javaè™šæ‹Ÿæœºä¼šè§¦å‘ä¸€æ¬¡ Minor GCï¼Œä»¥æ”¶é›†æ–°ç”Ÿä»£çš„åƒåœ¾ï¼Œå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡ï¼Œåˆ™ä¼šè½¬ç§»åˆ° SurvivoråŒºã€‚ å¤§å¯¹è±¡ï¼ˆéœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„Javaå¯¹è±¡ï¼Œå¦‚é‚£ç§å¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼‰ç›´æ¥è¿›å…¥è€å¹´æ€ï¼› å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿï¼Œå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡Minor GCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”è¢«Survivorå®¹çº³çš„è¯ï¼Œå¹´é¾„è®¾ä¸º1ï¼Œæ¯ç†¬è¿‡ä¸€æ¬¡Minor GCï¼Œå¹´é¾„+1ï¼Œè‹¥å¹´é¾„è¶…è¿‡ä¸€å®šé™åˆ¶ï¼ˆ15ï¼‰ï¼Œåˆ™è¢«æ™‹å‡åˆ°è€å¹´æ€ã€‚å³é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´æ€ã€‚ è€å¹´ä»£æ»¡äº†è€Œæ— æ³•å®¹çº³æ›´å¤šçš„å¯¹è±¡ï¼ŒMinor GC ä¹‹åé€šå¸¸å°±ä¼šè¿›è¡ŒFull GCï¼ŒFull GC æ¸…ç†æ•´ä¸ªå†…å­˜å † â€“ åŒ…æ‹¬å¹´è½»ä»£å’Œå¹´è€ä»£ã€‚ Major GC å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œæ¸…ç†è€å¹´åŒºï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡Minor GCï¼Œæ¯”Minor GCæ…¢10å€ä»¥ä¸Šã€‚ 37.JVMä¸­çš„æ°¸ä¹…ä»£ä¸­ä¼šå‘ç”Ÿåƒåœ¾å›æ”¶å—åƒåœ¾å›æ”¶ä¸ä¼šå‘ç”Ÿåœ¨æ°¸ä¹…ä»£ï¼Œå¦‚æœæ°¸ä¹…ä»£æ»¡äº†æˆ–è€…æ˜¯è¶…è¿‡äº†ä¸´ç•Œå€¼ï¼Œä¼šè§¦å‘å®Œå…¨åƒåœ¾å›æ”¶(Full GC)ã€‚å¦‚æœä½ ä»”ç»†æŸ¥çœ‹åƒåœ¾æ”¶é›†å™¨çš„è¾“å‡ºä¿¡æ¯ï¼Œå°±ä¼šå‘ç°æ°¸ä¹…ä»£ä¹Ÿæ˜¯è¢«å›æ”¶çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ­£ç¡®çš„æ°¸ä¹…ä»£å¤§å°å¯¹é¿å…Full GCæ˜¯éå¸¸é‡è¦çš„åŸå› ã€‚è¯·å‚è€ƒä¸‹Java8ï¼šä»æ°¸ä¹…ä»£åˆ°å…ƒæ•°æ®åŒº(è¯‘è€…æ³¨ï¼šJava8ä¸­å·²ç»ç§»é™¤äº†æ°¸ä¹…ä»£ï¼Œæ–°åŠ äº†ä¸€ä¸ªå«åšå…ƒæ•°æ®åŒºçš„nativeå†…å­˜åŒº) 38.JAVA8 ä¸å…ƒæ•°æ®åœ¨ Java8 ä¸­ï¼Œ æ°¸ä¹…ä»£å·²ç»è¢«ç§»é™¤ï¼Œè¢«ä¸€ä¸ªç§°ä¸ºâ€œå…ƒæ•°æ®åŒºâ€ï¼ˆå…ƒç©ºé—´ï¼‰çš„åŒºåŸŸæ‰€å–ä»£ã€‚å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œå…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼š å…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚ ç±»çš„å…ƒæ•°æ®æ”¾å…¥native memory, å­—ç¬¦ä¸²æ± å’Œç±»çš„é™æ€å˜é‡æ”¾å…¥ java å †ä¸­ï¼Œ è¿™æ ·å¯ä»¥åŠ è½½å¤šå°‘ç±»çš„å…ƒæ•°æ®å°±ä¸å†ç”±MaxPermSize æ§åˆ¶, è€Œç”±ç³»ç»Ÿçš„å®é™…å¯ç”¨ç©ºé—´æ¥æ§åˆ¶ 39.å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥è¢«å›æ”¶ï¼Ÿåˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š å¼•ç”¨è®¡æ•°ï¼š æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°å±æ€§ï¼Œæ–°å¢ä¸€ä¸ªå¼•ç”¨æ—¶è®¡æ•°åŠ 1ï¼Œå¼•ç”¨é‡Šæ”¾æ—¶è®¡æ•°å‡1ï¼Œè®¡æ•°ä¸º0æ—¶å¯ä»¥å›æ”¶ã€‚æ­¤æ–¹æ³•ç®€å•ï¼Œæ— æ³•è§£å†³å¯¹è±¡ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚ å¯è¾¾æ€§åˆ†æï¼ˆReachability Analysisï¼‰ï¼š ä»GC Rootså¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ã€‚å½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ï¼Œä¸å¯è¾¾å¯¹è±¡ã€‚ 40.å¼•ç”¨è®¡æ•°æ³•åœ¨ Java ä¸­ï¼Œå¼•ç”¨å’Œå¯¹è±¡æ˜¯æœ‰å…³è”çš„ã€‚å¦‚æœè¦æ“ä½œå¯¹è±¡åˆ™å¿…é¡»ç”¨å¼•ç”¨è¿›è¡Œã€‚å› æ­¤ï¼Œå¾ˆæ˜¾ç„¶ä¸€ä¸ªç®€å•çš„åŠæ³•æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥å›æ”¶ã€‚ç®€å•è¯´ï¼Œå³ä¸€ä¸ªå¯¹è±¡å¦‚æœæ²¡æœ‰ä»»ä½•ä¸ä¹‹å…³è”çš„å¼•ç”¨ï¼Œ å³ä»–ä»¬çš„å¼•ç”¨è®¡æ•°éƒ½ä¸ä¸º 0ï¼Œ åˆ™è¯´æ˜å¯¹è±¡ä¸å¤ªå¯èƒ½å†è¢«ç”¨åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯å¯å›æ”¶å¯¹è±¡ã€‚ 41.å¯è¾¾æ€§åˆ†æä¸ºäº†è§£å†³å¼•ç”¨è®¡æ•°æ³•çš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œ Java ä½¿ç”¨äº†å¯è¾¾æ€§åˆ†æçš„æ–¹æ³•ã€‚é€šè¿‡ä¸€ç³»åˆ—çš„â€œGC rootsâ€å¯¹è±¡ä½œä¸ºèµ·ç‚¹æœç´¢ã€‚å¦‚æœåœ¨â€œGC rootsâ€å’Œä¸€ä¸ªå¯¹è±¡ä¹‹é—´æ²¡æœ‰å¯è¾¾è·¯å¾„ï¼Œåˆ™ç§°è¯¥å¯¹è±¡æ˜¯ä¸å¯è¾¾çš„ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œä¸å¯è¾¾å¯¹è±¡ä¸ç­‰ä»·äºå¯å›æ”¶å¯¹è±¡ï¼Œ ä¸å¯è¾¾å¯¹è±¡å˜ä¸ºå¯å›æ”¶å¯¹è±¡è‡³å°‘è¦ç»è¿‡ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ã€‚ä¸¤æ¬¡æ ‡è®°åä»ç„¶æ˜¯å¯å›æ”¶å¯¹è±¡ï¼Œåˆ™å°†é¢ä¸´å›æ”¶ã€‚ 42.Minor GCä¸Full GCåˆ†åˆ«åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿæ–°ç”Ÿä»£å†…å­˜ä¸å¤Ÿç”¨æ—¶å€™å‘ç”ŸMGCä¹Ÿå«YGCï¼ŒJVMå†…å­˜ä¸å¤Ÿçš„æ—¶å€™å‘ç”ŸFGC 43.æ ‡è®°æ¸…é™¤ç®—æ³•å½“æˆåŠŸåŒºåˆ†å‡ºå†…å­˜ä¸­å­˜æ´»å¯¹è±¡å’Œæ­»äº¡å¯¹è±¡åï¼ŒGCæ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œé‡Šæ”¾æ‰æ— ç”¨å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä»¥ä¾¿æœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜ç©ºé—´ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ã€‚ç›®å‰åœ¨JVMä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‰ç§åƒåœ¾æ”¶é›†ç®—æ³•æ˜¯æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå¤åˆ¶ç®—æ³•ï¼Œæ ‡è®°-å‹ç¼©ç®—æ³•ã€‚ å½“å †ä¸­çš„æœ‰æ•ˆå†…å­˜ç©ºé—´è¢«è€—å°½æ—¶ï¼Œå°±ä¼šåœæ­¢æ•´ä¸ªç¨‹åºï¼Œç„¶åè¿›è¡Œä¸¤é¡¹å·¥ä½œï¼Œç¬¬ä¸€é¡¹æ˜¯æ ‡è®°ï¼Œç¬¬äºŒé¡¹åˆ™æ˜¯æ¸…é™¤ã€‚ æ ‡è®°ï¼šä»å¼•ç”¨è·ŸèŠ‚ç‚¹å¼€å§‹éå†ï¼Œæ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚ä¸€èˆ¬æ˜¯åœ¨å¯¹è±¡çš„Headerä¸­è®°å½•ä¸ºå¯è¾¾å¯¹è±¡ã€‚ æ¸…é™¤ï¼šå¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡åœ¨å…¶headerä¸­æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶ã€‚ ä¼˜ç‚¹ï¼šä¸éœ€è¦è¿›è¡Œå¯¹è±¡çš„ç§»åŠ¨ï¼Œå¹¶ä¸”ä»…å¯¹ä¸å­˜æ´»çš„å¯¹è±¡è¿›è¡Œå¤„ç†ï¼Œå­˜æ´»å¯¹è±¡æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹æä¸ºé«˜æ•ˆã€‚ ç¼ºç‚¹ï¼šæ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹çš„æ•ˆç‡éƒ½ä¸é«˜ï¼Œè¿™ç§æ–¹æ³•éœ€è¦ä½¿ç”¨ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ¥è®°å½•æ‰€æœ‰çš„ç©ºé—²åŒºåŸŸä»¥åŠå¤§å°ï¼Œå¯¹ç©ºé—²åˆ—è¡¨çš„ç®¡ç†ä¼šå¢åŠ åˆ†é…å¯¹è±¡æ—¶çš„å·¥ä½œé‡ï¼›æ ‡è®°æ¸…é™¤åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ï¼Œè™½ç„¶ç©ºé—²åŒºåŸŸçš„å¤§å°æ˜¯è¶³å¤Ÿçš„ï¼Œä½†å´å¯èƒ½æ²¡æœ‰ä¸€ä¸ªå•ä¸€çš„åŒºåŸŸèƒ½æ»¡è¶³è¿™æ¬¡åˆ†é…æ‰€éœ€å¤§å°ï¼Œåˆ†é…è¿˜ä¼šå¤±è´¥ï¼Œä¸å¾—ä¸è§¦å‘å†ä¸€æ¬¡çš„åƒåœ¾å›æ”¶ã€‚ ä½•ä¸ºæ¸…é™¤ï¼šæ‰€è°“æ¸…é™¤ï¼Œå¹¶ä¸æ˜¯å¹¶ä¸æ˜¯çœŸçš„ç½®ç©ºï¼Œè€Œæ˜¯æŠŠéœ€è¦æ¸…é™¤çš„å¯¹è±¡åœ°å€ä¿å­˜åœ¨ç©ºé—²çš„åœ°å€åˆ—è¡¨é‡Œï¼Œä¸‹æ¬¡æœ‰æ–°çš„å¯¹è±¡éœ€è¦åŠ è½½æ—¶ï¼Œåˆ¤æ–­åƒåœ¾çš„ä½ç½®ç©ºé—´æ˜¯å¤Ÿå¤Ÿï¼Œå¤Ÿå°±å­˜æ”¾ã€‚ 44.æ ‡è®°æ•´ç†ç®—æ³•ç®—æ³•æ ‡è®°çš„è¿‡ç¨‹ä¸æ ‡è®°æ¸…é™¤ç®—æ³•ä¸­çš„æ ‡è®°è¿‡ç¨‹ä¸€æ ·ï¼Œä½†æ˜¯å¯¹æ ‡è®°åå‡ºçš„åƒåœ¾å¯¹è±¡çš„å¤„ç†æƒ…å†µæœ‰æ‰€ä¸åŒï¼Œä»–ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡è¿›è¡Œæ¸…ç†ï¼Œè€Œæ˜¯è®©æ‰€æœ‰çš„å¯¹è±¡éƒ½åƒä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚åœ¨åŸºäºæ ‡è®°æ•´ç†ç®—æ³•çš„æ”¶é›†é½å®ç°ä¸­ï¼Œä¸€èˆ¬å¢åŠ å¥æŸ„å’Œå¥æŸ„è¡¨ã€‚ ä¼˜ç‚¹ï¼šç»è¿‡æ•´ç†ä¹‹åï¼Œæ–°å¯¹è±¡çš„åˆ†é…åªéœ€è¦é€šè¿‡æŒ‡é’ˆç¢°æ’ä¾¿èƒ½å®Œæˆï¼Œæ¯”è¾ƒç®€å•ï¼›ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œç©ºé—²åŒºåŸŸçš„ä½ç½®æ˜¯å§‹ç»ˆå¯çŸ¥çš„ï¼Œä¹Ÿä¸ä¼šå†æœ‰ç¢ç‰‡çš„é—®é¢˜äº†ã€‚ ç¼ºç‚¹ï¼šï¼§ï¼£æš‚åœçš„æ—¶é—´ä¼šå¢é•¿ï¼Œå› ä¸ºä½ éœ€è¦å°†æ‰€æœ‰çš„å¯¹è±¡éƒ½æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„åœ°æ–¹ï¼Œè¿˜å¾—æ›´æ–°ä»–ä»¬çš„å¼•ç”¨åœ°å€ã€‚ 45.å¤åˆ¶ç®—æ³•å¤åˆ¶ç®—æ³•ä¸»è¦æ˜¯ä¸ºäº†å…‹æœå¥æŸ„çš„å¼€é”€å’Œè§£å†³å †ç¢ç‰‡çš„åƒåœ¾å›æ”¶ã€‚å®ƒå°†å†…å­˜æŒ‰ç…§å®¹é‡åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ï¼Œå½“è¿™ä¸€å—çš„å†…å­˜ç”¨å®Œäº†ï¼Œå°±å°†è¿˜æ´»ç€çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å†…å­˜ä¸Šé¢ï¼ˆç©ºé—²é¢ï¼‰ï¼Œç„¶åå†æŠŠå·²ä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚ å¤åˆ¶ç®—æ³•æ¯”è¾ƒé€‚åˆäºæ–°ç”Ÿä»£ï¼ˆçŸ­ç”Ÿå­˜æœŸçš„å¯¹è±¡ï¼‰ï¼Œåœ¨è€å¹´ä»£ï¼ˆé•¿ç”Ÿå­˜æœŸçš„å¯¹è±¡ï¼‰ä¸­ï¼Œå¯¹è±¡å­˜æ´»ç‡æ¯”è¾ƒé«˜ï¼Œå¦‚æœæ‰§è¡Œè¾ƒå¤šçš„å¤åˆ¶æ“ä½œï¼Œæ•ˆç‡å°†ä¼šå˜ä½ã€‚æ‰€ä»¥è€å¹´ä»£ä¸€èˆ¬ä¼šé€‰ç”¨å…¶ä»–ç®—æ³•ï¼Œå¦‚æ ‡è®°æ•´ç†ç®—æ³•ã€‚ä¸€ç§å…¸å‹çš„åŸºäºå¤åˆ¶ç®—æ³•çš„åƒåœ¾å›æ”¶æ˜¯stop-and-copyç®—æ³•ï¼Œä»–å°†å †åˆ†ä¸ºå¯¹è±¡åŒºå’Œç©ºé—²åŒºï¼Œåœ¨å¯¹è±¡åŒºä¸ç©ºé—²åŒºçš„åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œç¨‹åºæš‚åœæ‰§è¡Œã€‚ ä¼˜ç‚¹ï¼šæ ‡è®°é˜¶æ®µå’Œå¤åˆ¶é˜¶æ®µå¯ä»¥åŒæ—¶è¿›è¡Œï¼Œæ¯æ¬¡åªå¯¹ä¸€å—å†…å­˜è¿›è¡Œå›æ”¶ï¼Œè¿è¡Œé«˜æ•ˆï¼Œåªéœ€è¦ç§»åŠ¨æ ˆé¡¶æŒ‡é’ˆï¼ŒæŒ‰é¡ºåºåˆ†é…å†…å­˜å³å¯ï¼Œå®ç°ç®€å•ï¼Œå†…å­˜å›æ”¶æ—¶ï¼Œä¸ç”¨è€ƒè™‘å†…å­˜ç¢ç‰‡çš„å‡ºç°ã€‚ ç¼ºç‚¹ï¼šéœ€è¦ä¸€å—èƒ½å®¹çº³ä¸‹æ‰€æœ‰å­˜æ´»å¯¹è±¡çš„é¢å¤–çš„å†…å­˜ç©ºé—´ã€‚å› æ­¤ï¼Œå¯ä¸€æ¬¡æ€§åˆ†é…çš„æœ€å¤§å†…å­˜ç¼©å°äº†ä¸€åŠã€‚ 46.åˆ†ä»£æ”¶é›†ç®—æ³•å°†å †å†…å­˜åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£ï¼Œè€å¹´ä»£å’Œæ°¸ä¹…ä»£ã€‚æ–°ç”Ÿä»£åˆè¢«è¿›ä¸€æ­¥åˆ’åˆ†ä¸ºä¼Šç”¸å›­åŒºå’Œå¹¸å­˜è€…0ï¼Œå¹¸å­˜è€…1åŒºã€‚æ‰€æœ‰é€šè¿‡newåˆ›å»ºçš„å¯¹è±¡çš„å†…å­˜éƒ½åœ¨å †ä¸­åˆ†é…ï¼Œå…¶å¤§å°å¯ä»¥é€šè¿‡-Xmså’Œ-Xmxæ¥æ§åˆ¶ã€‚åˆ†ä»£æ”¶é›†ï¼Œæ˜¯åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼šä¸åŒçš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ä¸€æ ·çš„ã€‚å› æ­¤å¯ä»¥å°†ä¸åŒç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡åˆ†ä»£ï¼Œä¸åŒçš„ä»£é‡‡å–ä¸åŒçš„å›æ”¶ç®—æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œä»¥ä¾¿æé«˜å›æ”¶æ•ˆç‡ã€‚ æ–°ç”Ÿä»£ï¼šå‡ ä¹æ‰€æœ‰æ–°ç”Ÿæˆçš„å¯¹è±¡é¦–å…ˆéƒ½æ˜¯æ”¾åœ¨å¹´è½»ä»£çš„ã€‚æ–°ç”Ÿä»£å†…å­˜æŒ‰ç…§ 8:1:1 çš„æ¯”ä¾‹åˆ†ä¸ºä¸€ä¸ª Eden åŒºå’Œä¸¤ä¸ª Survivorï¼ˆSurvivor0ï¼ŒSurvivor1ï¼‰åŒºã€‚å¤§éƒ¨åˆ†å¯¹è±¡åœ¨ Eden åŒºä¸­ç”Ÿæˆã€‚å½“æ–°å¯¹è±¡ç”Ÿæˆï¼ŒEden ç©ºé—´ç”³è¯·å¤±è´¥ï¼ˆå› ä¸ºç©ºé—´ä¸è¶³ç­‰ï¼‰ï¼Œåˆ™ä¼šå‘èµ·ä¸€æ¬¡ GCï¼ˆScavenge GCï¼‰ã€‚å›æ”¶æ—¶å…ˆå°† Eden åŒºå­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ä¸€ä¸ª Survivor0 åŒºï¼Œç„¶åæ¸…ç©º Eden åŒºï¼Œå½“è¿™ä¸ª Survivor0 åŒºä¹Ÿå­˜æ”¾æ»¡äº†æ—¶ï¼Œåˆ™å°† Eden åŒºå’Œ Survivor0 åŒºå­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ª Survivor1 åŒºï¼Œç„¶åæ¸…ç©º Eden å’Œè¿™ä¸ª Survivor0 åŒºï¼Œæ­¤æ—¶ Survivor0 åŒºæ˜¯ç©ºçš„ï¼Œç„¶åå°† Survivor0 åŒºå’Œ Survivor1 åŒºäº¤æ¢ï¼Œå³ä¿æŒ Survivor1 åŒºä¸ºç©ºï¼Œ å¦‚æ­¤å¾€å¤ã€‚å½“ Survivor1 åŒºä¸è¶³ä»¥å­˜æ”¾ Eden å’Œ Survivor0 çš„å­˜æ´»å¯¹è±¡æ—¶ï¼Œå°±å°†å­˜æ´»å¯¹è±¡ç›´æ¥å­˜æ”¾åˆ°è€å¹´ä»£ã€‚å½“å¯¹è±¡åœ¨ Survivor åŒºèº²è¿‡ä¸€æ¬¡ GC çš„è¯ï¼Œå…¶å¯¹è±¡å¹´é¾„ä¾¿ä¼šåŠ  1ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå¯¹è±¡å¹´é¾„è¾¾åˆ° 15 å²ï¼Œå°±ä¼šç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚è‹¥æ˜¯è€å¹´ä»£ä¹Ÿæ»¡äº†å°±ä¼šè§¦å‘ä¸€æ¬¡ Full GCï¼Œä¹Ÿå°±æ˜¯æ–°ç”Ÿä»£ã€è€å¹´ä»£éƒ½è¿›è¡Œå›æ”¶ã€‚æ–°ç”Ÿä»£å¤§å°å¯ä»¥ç”±-Xmnæ¥æ§åˆ¶ï¼Œä¹Ÿå¯ä»¥ç”¨-XX:SurvivorRatioæ¥æ§åˆ¶ Eden å’Œ Survivor çš„æ¯”ä¾‹ã€‚ è€å¹´ä»£ï¼šåœ¨æ–°ç”Ÿä»£ä¸­ç»å†äº† N æ¬¡åƒåœ¾å›æ”¶åä»ç„¶å­˜æ´»çš„å¯¹è±¡ï¼Œå°±ä¼šè¢«æ”¾åˆ°å¹´è€ä»£ä¸­ã€‚å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºå¹´è€ä»£ä¸­å­˜æ”¾çš„éƒ½æ˜¯ä¸€äº›ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡ã€‚å†…å­˜æ¯”æ–°ç”Ÿä»£ä¹Ÿå¤§å¾ˆå¤šï¼ˆå¤§æ¦‚æ¯”ä¾‹æ˜¯ 1:2ï¼‰ï¼Œå½“è€å¹´ä»£å†…å­˜æ»¡æ—¶è§¦å‘ Major GC å³ Full GCï¼ŒFull GC å‘ç”Ÿé¢‘ç‡æ¯”è¾ƒä½ï¼Œè€å¹´ä»£å¯¹è±¡å­˜æ´»æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå­˜æ´»ç‡é«˜ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¤§å¯¹è±¡ä¼šè¢«ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ã€‚æ‰€è°“çš„å¤§å¯¹è±¡æ˜¯æŒ‡éœ€è¦å¤§é‡è¿ç»­å­˜å‚¨ç©ºé—´çš„å¯¹è±¡ï¼Œæœ€å¸¸è§çš„ä¸€ç§å¤§å¯¹è±¡å°±æ˜¯å¤§æ•°ç»„ã€‚å½“ç„¶åˆ†é…çš„è§„åˆ™å¹¶ä¸æ˜¯ç™¾åˆ†ä¹‹ç™¾å›ºå®šçš„ï¼Œè¿™è¦å–å†³äºå½“å‰ä½¿ç”¨çš„æ˜¯å“ªç§åƒåœ¾æ”¶é›†å™¨ç»„åˆå’Œ JVM çš„ç›¸å…³å‚æ•°ã€‚ æ°¸ä¹…ä»£ï¼šç”¨äºå­˜æ”¾é™æ€æ–‡ä»¶ï¼ˆclassç±»ã€æ–¹æ³•ï¼‰å’Œå¸¸é‡ç­‰ã€‚æ°¸ä¹…ä»£å¯¹åƒåœ¾å›æ”¶æ²¡æœ‰æ˜¾è‘—å½±å“ï¼Œä½†æ˜¯æœ‰äº›åº”ç”¨å¯èƒ½åŠ¨æ€ç”Ÿæˆæˆ–è€…è°ƒç”¨ä¸€äº›classï¼Œä¾‹å¦‚ Hibernate ç­‰ï¼Œåœ¨è¿™ç§æ—¶å€™éœ€è¦è®¾ç½®ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æŒä¹…ä»£ç©ºé—´æ¥å­˜æ”¾è¿™äº›è¿è¡Œè¿‡ç¨‹ä¸­æ–°å¢çš„ç±»ã€‚å¯¹æ°¸ä¹…ä»£çš„å›æ”¶ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šåºŸå¼ƒå¸¸é‡å’Œæ— ç”¨çš„ç±»ã€‚æ°¸ä¹…ä»£åœ¨ Java SE8 ç‰¹æ€§ä¸­å·²ç»è¢«ç§»é™¤äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å…ƒç©ºé—´ï¼ˆMetaSpaceï¼‰ï¼Œå› æ­¤ä¹Ÿä¸ä¼šå†å‡ºç°java.lang.OutOfMemoryError: PermGen errorçš„é”™è¯¯äº†ã€‚ ç‰¹åˆ«çš„ï¼Œåœ¨åˆ†ä»£æ”¶é›†ç®—æ³•ä¸­ï¼Œå¯¹è±¡çš„å­˜å‚¨å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š 1.å¯¹è±¡ä¼˜å…ˆåœ¨ä¼Šç”¸å›­åŒºåˆ†é… 2.å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ 3.é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£ï¼Œé»˜è®¤ä¸º15å² å¯¹äºæ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œä¸ºä»€ä¹ˆæ˜¯15å²ï¼Ÿ å®é™…ä¸Šï¼ŒHotSpotè™šæ‹Ÿæœºçš„å¯¹è±¡å¤´å…¶ä¸­ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œç ï¼ŒGCåˆ†ä»£å¹´é¾„ï¼Œé”çŠ¶æ€æ ‡å¿—ï¼Œçº¿ç¨‹æŒæœ‰çš„é”ï¼Œåå‘çº¿ç¨‹IDï¼Œåå‘æ—¶é—´æˆ³ç­‰ï¼Œè¿™éƒ¨åˆ†æ•°æ®çš„é•¿åº¦åœ¨32ä½å’Œ64ä½çš„è™šæ‹Ÿæœºä¸­åˆ†åˆ«ä¸º32bitå’Œ64bitï¼Œå®˜æ–¹ç§°ä¸ºmark wordã€‚åœ¨ 32 ä½çš„ HotSpot è™šæ‹Ÿæœºä¸­ï¼Œå¦‚æœå¯¹è±¡å¤„äºæœªè¢«é”å®šçš„çŠ¶æ€ä¸‹ï¼Œé‚£ä¹ˆMark Wordçš„ 32bit ç©ºé—´ä¸­ 25bit ç”¨äºå­˜å‚¨å¯¹è±¡å“ˆå¸Œç ï¼Œ4bit ç”¨äºå­˜å‚¨å¯¹è±¡åˆ†ä»£å¹´é¾„ï¼Œ2bit ç”¨äºå­˜å‚¨é”æ ‡å¿—ä½ï¼Œ1bit å›ºå®šä¸º 0ï¼Œå…¶ä¸­å¯¹è±¡çš„åˆ†ä»£å¹´é¾„å  4 ä½ï¼Œä¹Ÿå°±æ˜¯ä»0000åˆ°1111ï¼Œè€Œå…¶å€¼æœ€å¤§ä¸º 15ï¼Œæ‰€ä»¥åˆ†ä»£å¹´é¾„ä¹Ÿå°±ä¸å¯èƒ½è¶…è¿‡ 15 è¿™ä¸ªæ•°å€¼äº†ã€‚ GCçš„åˆ†ç±» æ–°ç”Ÿä»£GC Minor GC ï¼šå‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†åŠ¨ä½œï¼Œå› ä¸ºjavaå¯¹è±¡å¤§å¤šå…·æœ‰æœç”Ÿå¤•ç­çš„ç‰¹æ€§ï¼Œå› æ­¤MinorGCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡åƒåœ¾æ”¶é›†æ—¶éƒ½ä¼šå‘ç°æœ‰å¤§é‡å¯¹è±¡æ­»å»ï¼Œåªæœ‰å°‘é‡å­˜æ´»ï¼Œå› æ­¤å¯ä»¥é€‰ç”¨å¤åˆ¶ç®—æ³•ã€‚ è€å¹´ä»£GC Major GCï¼šå‘ç”Ÿåœ¨è€å¹´ä»£çš„åƒåœ¾å›æ”¶åŠ¨ä½œã€‚Major GC ç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡Minor GCã€‚ç”±äºè€å¹´ä»£ä¸­çš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿ï¼Œå› æ­¤Major GCå¹¶ä¸é¢‘ç¹ï¼Œä¸€èˆ¬éƒ½æ˜¯ç­‰å¾…è€å¹´ä»£æ»¡äº†ä¹‹åæ‰è¿›è¡ŒFull GCï¼Œè€Œä¸”å…¶é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Šã€‚å¦å¤–ï¼Œå¦‚æœåˆ†é…äº†Direct Memoryï¼Œåœ¨è€å¹´ä»£ä¸­è¿›è¡Œ Full GC æ—¶ï¼Œä¼šé¡ºä¾¿æ¸…ç†æ‰ Direct Memory ä¸­çš„åºŸå¼ƒå¯¹è±¡ã€‚è€Œè€å¹´ä»£ä¸­å› ä¸ºå¯¹è±¡å­˜æ´»ç‡é«˜ã€æ²¡æœ‰é¢å¤–ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œå°±å¿…é¡»ä½¿ç”¨â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•æˆ–â€œæ ‡è®°-æ•´ç†â€ç®—æ³•æ¥è¿›è¡Œå›æ”¶ã€‚æ–°ç”Ÿä»£é‡‡ç”¨ç©ºé—²æŒ‡é’ˆçš„æ–¹å¼æ¥æ§åˆ¶ GC è§¦å‘ï¼ŒæŒ‡é’ˆä¿æŒæœ€åä¸€ä¸ªåˆ†é…çš„å¯¹è±¡åœ¨æ–°ç”Ÿä»£åŒºé—´çš„ä½ç½®ï¼Œå½“æœ‰æ–°çš„å¯¹è±¡è¦åˆ†é…å†…å­˜æ—¶ï¼Œç”¨äºæ£€æŸ¥ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œä¸å¤Ÿå°±è§¦å‘ GCã€‚å½“è¿ç»­åˆ†é…å¯¹è±¡æ—¶ï¼Œå¯¹è±¡ä¼šé€æ¸ä» Eden åˆ° Survivorï¼Œæœ€ååˆ°è€å¹´ä»£ã€‚ 47.å¢é‡æ”¶é›†ç®—æ³•ä¸Šè¿°ç°æœ‰çš„ç®—æ³•ï¼Œåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨è½¯ä»¶å°†å¤„äºä¸€ç§STWçš„çŠ¶æ€ï¼Œåœ¨è¯¥çŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæš‚åœä¸€åˆ‡æ­£å¸¸çš„å·¥ä½œï¼Œç­‰å¾…åƒåœ¾å›æ”¶å®Œæˆã€‚å¦‚æœåƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«æŒ‚èµ·å¾ˆä¹…ï¼Œå°†ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒæˆ–è€…ç³»ç»Ÿç¨³å®šæ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå³å¯¹å®æ—¶åƒåœ¾æ”¶é›†ç®—æ³•çš„äºšä¹…ç›´æ¥å¯¼è‡´å¢é‡æ”¶é›†ç®—æ³•çš„äº§ç”Ÿã€‚ å¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„åƒåœ¾è¿›è¡Œå¤„ç†ï¼Œéœ€è¦é€ æˆç³»ç»Ÿé•¿æ—¶é—´çš„åœé¡¿ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡ï¼Œåƒåœ¾æ”¶é›†çº¿ç¨‹å€¼æ”¶é›†ä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹ï¼Œä¾æ¬¡åå¤ï¼Œä¸€ç›´åˆ°åƒåœ¾æ”¶é›†å®Œæˆã€‚ æ€»çš„æ¥è¯´ï¼Œå¢é‡æ”¶é›†ç®—æ³•çš„åŸºç¡€ä»ç„¶æ˜¯ä¼ ç»Ÿçš„æ ‡è®°-æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ã€‚å¢é‡æ”¶é›†ç®—æ³•é€šè¿‡å¯¹çº¿ç¨‹é—´å†²çªçš„å¦¥å–„å¤„ç†ï¼Œå…è®¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä»¥åˆ†é˜¶æ®µçš„æ–¹å¼å®Œæˆæ ‡è®°ï¼Œæ¸…ç†æˆ–å¤åˆ¶å·¥ä½œã€‚ ç¼ºç‚¹ï¼šçº¿ç¨‹åˆ‡æ¢å’Œä¸Šä¸‹æ–‡çš„è½¬æ¢æ¶ˆè€—æ€§èƒ½ï¼Œä¼šä½¿å¾—åƒåœ¾å›æ”¶çš„æ€»ä½“æˆæœ¬ä¸Šå‡ï¼Œé€ æˆç³»ç»Ÿååé‡çš„ä¸‹é™ã€‚ 48.åˆ†åŒºç®—æ³•åˆ†ä»£ç®—æ³•å°†æŒ‰ç…§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé•¿çŸ­åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åŒºç®—æ³•å°†æ•´ä¸ªå †ç©ºé—´åˆ’åˆ†æˆè¿ç»­çš„ä¸åŒçš„å°ç©ºé—´ã€‚æ¯ä¸€ä¸ªå°ç©ºé—´éƒ½ç‹¬ç«‹ä½¿ç”¨ï¼Œç‹¬ç«‹å›æ”¶ã€‚è¿™ç§ç®—æ³•çš„å¥½å¤„æ˜¯å¯ä»¥æ§åˆ¶ä¸€æ¬¡å›æ”¶å¤šå°‘ä¸ªå°åŒºé—´ã€‚ 55.åƒåœ¾åˆ¤æ–­ç®—æ³•ï¼‘ï¼‰å¼•ç”¨è®¡æ•°æ³• åœ¨è¿™ç§ç®—æ³•ä¸­ï¼Œå‡è®¾å †ä¸­æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºå¹¶ä¸”åˆå§‹åŒ–èµ‹å€¼ä»¥åï¼Œå¯¹è±¡çš„è®¡æ•°å™¨å°±ä¼šè®¾ç½®ä¸ºï¼‘ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨ä»–ï¼Œè®¡æ•°å™¨çš„å€¼å°±ä¼šï¼‹ï¼‘ï¼Œä¾‹å¦‚å°†å¯¹è±¡ï¼¢èµ‹å€¼ç»™å¯¹è±¡ï¼¡ï¼Œé‚£ä¹ˆï¼¢è¢«å¼•ç”¨ï¼Œï¼¢çš„å¼•ç”¨è®¡æ•°å™¨å°±ä¼šï¼‹ï¼‘. åä¹‹ï¼Œå½“å¼•ç”¨å¤±æ•ˆçš„æ—¶å€™ï¼Œæ¯”å¦‚ä¸€ä¸ªå¯¹è±¡çš„æŸä¸ªå¼•ç”¨è¢«è®¾ç½®äº†æ–°çš„å€¼ï¼Œåˆ™ä¹‹å‰è¢«å¼•ç”¨çš„å¯¹è±¡çš„è®¡æ•°å™¨å°±ä¼šï¼ï¼‘.è€Œé‚£äº›å¼•ç”¨è®¡æ•°ä¸ºï¼çš„å¯¹è±¡ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸ºåƒåœ¾ï¼Œå¯ä»¥è¢«æ”¶é›†ã€‚ ç‰¹åˆ«çš„ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«å½“åšåƒåœ¾æ”¶é›†æ—¶ï¼Œä»–å¼•ç”¨çš„ä»»ä½•å¯¹è±¡çš„è®¡æ•°å™¨çš„å€¼éƒ½ï¼ï¼‘. ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œå¯¹ç¨‹åºä¸è¢«é•¿æ—¶é—´æ‰“æ–­çš„å®æ—¶ç¯å¢ƒæ¯”è¾ƒæœ‰åˆ© ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„ç©ºé—´æ¥å­˜å‚¨è®¡æ•°å™¨ï¼Œéš¾ä»¥æ£€æµ‹å¯¹è±¡ä¹‹é—´çš„å¾ªç¯ä¾èµ– javaå¹¶æ²¡æœ‰é€‰æ‹©å¼•ç”¨è®¡æ•°ï¼Œæ˜¯å› ä¸ºå…¶å­˜åœ¨ä¸€ä¸ªåŸºæœ¬éš¾é¢˜ï¼Œä¹Ÿå°±æ˜¯å¾ˆéš¾å¤„ç†å¾ªç¯å¼•ç”¨å…³ç³»ã€‚ Pythonå¦‚ä½•è§£å†³å¾ªç¯å¼•ç”¨ï¼Ÿæ‰‹åŠ¨è§£å†³ï¼ˆåœ¨åˆé€‚çš„æ—¶æœºï¼Œæ¥è§¦å¼•ç”¨å…³ç³»ï¼‰ä½¿ç”¨å¼±å¼•ç”¨weakrefï¼ˆweakrefæ˜¯Pythonæä¾›çš„æ ‡å‡†åº“ï¼Œä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–ï¼‰ ï¼’ï¼‰å¯è¾¾æ€§åˆ†æç®—æ³• å¯è¾¾æ€§æ˜¯æŒ‡ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡ä¼šè¢«è‡³å°‘ä¸€ä¸ªåœ¨ç¨‹åºä¸­çš„å˜é‡é€šè¿‡ç›´æ¥æˆ–é—´æ¥çš„æ–¹å¼è¢«å…¶ä»–å¯è¾¾çš„å¯¹è±¡å¼•ç”¨ï¼Œåˆ™ç§°è¯¥å¯¹è±¡å°±æ˜¯å¯è¾¾çš„ã€‚ å¯¹è±¡æˆä¸ºå¯è¾¾å¯¹è±¡çš„ä¸¤ä¸ªæ¡ä»¶ï¼š å¯¹è±¡å±äºè·Ÿé›†ä¸­çš„å¯¹è±¡ å¯¹è±¡è¢«ä¸€ä¸ªå¯è¾¾çš„å¯¹è±¡å¼•ç”¨ 56.åœ¨javaè¯­è¨€ä¸­ï¼ŒGC ROOTS åŒ…æ‹¬ä»¥ä¸‹å‡ ç±»å…ƒç´ ï¼šè™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ï¼ˆå„ä¸ªçº¿ç¨‹è¢«è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å‚æ•°ï¼Œå±€éƒ¨å˜é‡ç­‰ï¼‰ æœ¬åœ°æ–¹æ³•æ ˆå†…JNIï¼ˆé€šå¸¸è¯´çš„æœ¬åœ°æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ï¼ˆjavaç±»çš„å¼•ç”¨ç±»å‹é™æ€å˜é‡ï¼‰ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString Tableï¼‰é‡Œçš„å¼•ç”¨ï¼‰ æ‰€æœ‰è¢«åŒæ­¥é”synchronizedæŒæœ‰çš„å¯¹è±¡ javaè™šæ‹Ÿæœºå†…éƒ¨çš„å¼•ç”¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„classå¯¹è±¡ï¼Œä¸€äº›å¸¸é©»çš„å¼‚å¸¸å¯¹è±¡ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰ æœ¬åœ°ä»£ç ç¼“å­˜ ä¸´æ—¶çš„ï¼ˆåˆ†ä»£æ”¶é›†ï¼Œå±€éƒ¨å›æ”¶ï¼‰ å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªroot ç”±äºrooté‡‡ç”¨æ ˆæ–¹å¼å­˜æ”¾å˜é‡å’ŒæŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªæŒ‡é’ˆï¼Œä»–ä¿å­˜äº†å †å†…å­˜é‡Œé¢çš„å¯¹è±¡ï¼Œä½†æ˜¯è‡ªå·±åˆä¸å­˜æ”¾åœ¨å †å†…å­˜é‡Œé¢ï¼Œé‚£ä»–å°±æ˜¯ä¸€ä¸ªrootã€‚ å¦‚æœè¦ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•æ¥åˆ¤æ–­å†…å­˜æ˜¯å¦å¯å›æ”¶ï¼Œé‚£ä¹ˆåˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ä¿éšœä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œã€‚è¿™ç‚¹ä¸æ»¡è¶³çš„è¯åˆ†æç»“æœçš„å‡†ç¡®æ€§å°±æ— æ³•ä¿è¯ã€‚è¿™ç‚¹ä¹Ÿæ˜¯å¯¼è‡´GCè¿›è¡Œæ—¶å¿…é¡»Stop the Worldçš„ä¸€ä¸ªé‡è¦åŸå› ã€‚ ä¼˜ç‚¹ï¼šå¯ä»¥è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œä¸éœ€è¦å ç”¨é¢å¤–çš„ç©ºé—´ ç¼ºç‚¹ï¼šå¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šæ›´æ–°å·²ç»è®¿é—®è¿‡çš„å¯¹è±¡çš„å¼•ç”¨ã€‚ 57.Minor GC,Major GC,fULL GCjvmåœ¨è¿›è¡ŒGCæ—¶ï¼Œå¹¶éæ¯æ¬¡éƒ½å¯¹ä¸Šé¢ä¸‰ä¸ªå†…å­˜åŒºåŸŸä¸€èµ·å›æ”¶çš„ï¼Œå¤§éƒ¨åˆ†å›æ”¶éƒ½æ˜¯æŒ‡æ–°ç”Ÿä»£ã€‚ é’ˆå¯¹hotSpotVMçš„å®ç°ï¼Œå®ƒé‡Œé¢çš„GCæŒ‰ç…§å›æ”¶åŒºåŸŸåˆ†ä¸ºä¸¤å¤§ç±»å‹ï¼šä¸€ç§æ˜¯éƒ¨åˆ†æ”¶é›†ï¼Œä¸€ç§æ˜¯FullGC 1.éƒ¨åˆ†æ”¶é›†ï¼šä¸æ˜¯å®Œæ•´æ”¶é›†æ•´ä¸ªJavaå †çš„åƒåœ¾å›æ”¶ï¼Œåˆåˆ†ä¸ºï¼š 1ï¼‰æ–°ç”Ÿä»£æ”¶é›†Minor GCï¼šåªæ˜¯æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›† 2ï¼‰è€å¹´ä»£æ”¶é›†Major GCï¼šåªæ˜¯è€å¹´ä»£çš„åƒåœ¾æ”¶é›† ç›®å‰åªæœ‰CMSGCæ‹¥æœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸ºï¼Œå¾ˆå¤šæ—¶å€™Minor GCä¼šå’ŒFullGCæ··æ·†ä½¿ç”¨ï¼Œéœ€è¦å…·ä½“åˆ†è¾¨è€å¹´ä»£å›æ”¶è¿˜æ˜¯æ•´å †å›æ”¶ã€‚ 3ï¼‰æ··åˆæ”¶é›†ï¼šæ”¶é›†æ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾ 2.æ•´å †æ”¶é›†ï¼šæ”¶é›†æ•´ä¸ªjavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾ 58.åˆ†ä»£å¼GCç­–ç•¥è§¦å‘æ¡ä»¶1ï¼‰å¹´è½»ä»£è§¦å‘æœºåˆ¶ 1.å½“å¹´è½»ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šå‡ºå‘minorGCï¼Œè¿™é‡Œçš„å¹´è½»ä»£æŒ‡çš„æ˜¯Edenæ»¡ï¼ŒSurvivoræ»¡ä¸ä¼šè§¦å‘GC 2.å› ä¸ºjavaå¯¹è±¡å¤§å¤šæ•°å­˜æ´»æ—¶é—´æ¯”è¾ƒçŸ­æš‚ï¼Œæ‰€ä»¥MinorGCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚ 3.MinorGCä¼šå¼•å‘STWï¼Œæš‚åœå…¶ä»–ç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œã€‚ 2ï¼‰è€å¹´ä»£GCè§¦å‘æœºåˆ¶ 1.æŒ‡çš„æ˜¯å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œå¯¹è±¡ä»è€å¹´ä»£æ¶ˆå¤±æ—¶ï¼Œæˆ‘ä»¬è¯´çš„MajorGCå’ŒFullGCå‘ç”Ÿäº†ã€‚ 2.å‡ºç°äº†MajorGCï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„MinorGCï¼Œä¹Ÿå°±æ˜¯åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³çš„æ—¶å€™ï¼Œä¼šå…ˆå°è¯•è§¦å‘minorGCï¼Œå¦‚æœä¹‹åç©ºé—´è¿˜æ˜¯ä¸è¶³ï¼Œåˆ™ä¼šè§¦å‘MajorGCã€‚ 3.MajorGCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”MinorGCæ…¢10å€ä»¥ä¸Šï¼ŒSTWæ—¶é—´æ›´é•¿ã€‚ 4.å¦‚æœMajorGCåï¼Œå†…å­˜è¿˜æ˜¯ä¸è¶³ï¼Œå°±ä¼šOOMã€‚ 3ï¼‰FullGCè§¦å‘æ¡ä»¶ 1.System.gc() ä¸æ˜¯ä¸€å®šæ‰§è¡Œçš„ã€‚ 2.è€å¹´ä»£ç©ºé—´ä¸è¶³ 3.æ–¹æ³•åŒºç©ºé—´ä¸è¶³ 4.é€šè¿‡Minor GCåè¿›å…¥è€å¹´ä»£çš„å¹³å‡å¤§å°å¤§äºè€å¹´ä»£çš„å¯ç”¨å†…å­˜ã€‚ 5.EdenåŒºï¼Œsurvivor0 åŒºå‘survivor1åŒºå¤åˆ¶æ—¶ï¼Œå¯¹è±¡å¤§å°å¤§äºTo Spaceå¯ç”¨åŒºåŸŸï¼Œåˆ™æŠŠè¯¥å¯¹è±¡è½¬å­˜åˆ°è€å¹´ä»£ï¼Œä¸”è€å¹´ä»£çš„å¯ç”¨å†…å­˜å°äºè¯¥å¯¹è±¡çš„å†…å­˜å°±ä¼šè§¦å‘GCã€‚ Full GCæ˜¯å¼€å‘æˆ–è€…è°ƒä¼˜ä¸­å°½é‡è¦é¿å…çš„ï¼Œè¿™æ ·æš‚åœæ—¶é—´ä¼šçŸ­ä¸€äº›ã€‚ 59.ä»é€ƒé€¸åˆ†æè§’åº¦åˆ†æå¯¹è±¡å†…å­˜åˆ†é…1ï¼‰å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å˜›ï¼Ÿ åœ¨javaè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨javaå †ä¸­åˆ†é…å†…å­˜çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ™®éçš„å¸¸è¯†ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æƒ…å†µï¼Œé‚£å°±æ˜¯å¦‚æœç»è¿‡é€ƒé€¸åˆ†æåå‘ç°ï¼Œä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆå°±å¯èƒ½ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚è¿™æ ·å°±æ— éœ€å†å †ä¸Šåˆ†é…å†…å­˜ï¼Œä¹Ÿæ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚è¿™æ˜¯æœ€å¸¸è§çš„å †å¤–å­˜å‚¨æŠ€æœ¯ã€‚ 2ï¼‰é€ƒé€¸åˆ†æ 1.å¦‚æœå°†å †ä¸Šçš„å¯¹è±¡åˆ†é…åˆ°æ ˆï¼Œéœ€è¦ä½¿ç”¨é€ƒé€¸åˆ†ææ‰‹æ®µã€‚ 2.è¿™æ˜¯ä¸€ç§å¯ä»¥æœ‰æ•ˆå‡å°‘javaç¨‹åºä¸­åŒæ­¥è´Ÿè½½å’Œå†…å­˜å †åˆ†é…å‹åŠ›çš„è·¨å‡½æ•°å…¨å±€æ•°æ®æµåˆ†æç®—æ³•ã€‚ 3.é€šè¿‡é€ƒé€¸åˆ†æï¼Œhotspotç¼–è¯‘å™¨èƒ½å¤Ÿåˆ†æå‡ºä¸€ä¸ªæ–°çš„å¯¹è±¡çš„å¼•ç”¨çš„é€‚ç”¨èŒƒå›´ä»è€Œå†³å®šæ˜¯å¦è¦å°†è¿™ä¸ªå¯¹è±¡åˆ†é…åˆ°å †ä¸Šã€‚ 4.é€ƒé€¸åˆ†æçš„åŸºæœ¬è¡Œä¸ºå°±æ˜¯åˆ†æå¯¹è±¡åŠ¨æ€ä½œç”¨åŸŸï¼š å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå¯¹è±¡åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ã€‚ å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå®ƒè¢«å¤–éƒ¨æ–¹æ³•æ‰€å¼•ç”¨ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿé€ƒé€¸ã€‚ä¾‹å¦‚ä½œä¸ºè°ƒç”¨å‚æ•°ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹ä¸­ã€‚ 5.æ²¡æœ‰å‘ç”Ÿé€ƒé€¸çš„å¯¹è±¡ï¼Œåˆ™å¯ä»¥åˆ†é…åˆ°æ ˆä¸Šï¼Œéšç€æ–¹æ³•çš„æ‰§è¡Œç»“æŸï¼Œæ ˆç©ºé—´å°±è¢«ç§»é™¤ï¼Œæ ˆç©ºé—´æŒ‡å‘å †ç©ºé—´å¯¹è±¡çš„å¼•ç”¨å°±æ²¡äº†ï¼Œç­‰åˆ°å¹´è½»ä»£GCï¼Œå¯¹è±¡å°±ä¼šè¢«å›æ”¶ã€‚ 3ï¼‰è¡¥å…… å…¶å®ä¸»è¦å°±æ˜¯è§£å†³äº†å¾ªç¯å¼•ç”¨ï¼Œæ²¡æœ‰é€ƒé€¸åˆ†æï¼Œè¿™ä¸ªå¯¹è±¡å¯èƒ½ä¸€ç›´ä¸è¢«å›æ”¶ï¼Œä½†æ˜¯æœ‰äº†é€ƒé€¸åˆ†æï¼Œæ ˆå¸§é”€æ¯ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯åƒåœ¾äº†ã€‚ 60.ä½¿ç”¨é€ƒé€¸åˆ†æå †ä»£ç è¿›è¡Œä¼˜åŒ–1ï¼‰æ ˆä¸Šåˆ†é… å°†å †åˆ†é…è½¬æ¢ä¸ºæ ˆåˆ†é…ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å­ç¨‹åºä¸­è¢«åˆ†é…ï¼Œè¦ä½¿æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ°¸è¿œä¸ä¼šé€ƒé€¸ï¼Œå¯¹è±¡å¯èƒ½æ˜¯æ ˆåˆ†é…çš„å€™é€‰ï¼Œè€Œä¸æ˜¯å †åˆ†é…ã€‚ JITç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚åˆ†é…å®Œæˆåï¼Œç»§ç»­åœ¨è°ƒç”¨æ ˆå†…æ‰§è¡Œï¼Œæœ€åçº¿ç¨‹ç»“æŸåï¼Œæ ˆç©ºé—´è¢«å›æ”¶ï¼Œå±€éƒ¨å˜é‡å¯¹è±¡ä¹Ÿè¢«å›æ”¶ã€‚è¿™æ ·å°±æ— éœ€è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚ å¸¸è§çš„æ ˆä¸Šåˆ†é…åœºæ™¯ï¼šåœ¨é€ƒé€¸åˆ†æä¸­ï¼Œå·²ç»è¯´æ˜äº†ã€‚åˆ†åˆ«æ˜¯ç»™æˆå‘˜å˜é‡èµ‹å€¼ï¼Œæ–¹æ³•è¿”å›å€¼ï¼Œå®ä¾‹å¼•ç”¨ä¼ é€’ã€‚ 1-XX:+DoEscapeAnalysis //é»˜è®¤å¼€å¯ 2ï¼‰åŒæ­¥çœç•¥ å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å‘ç°åªèƒ½ä»ä¸€ä¸ªçº¿ç¨‹è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡çš„æ“ä½œå¯ä»¥ä¸è€ƒè™‘åŒæ­¥ã€‚çº¿ç¨‹åŒæ­¥çš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼ŒåŒæ­¥çš„åæœæ˜¯é™ä½å¹¶å‘å’Œæ€§èƒ½ã€‚åœ¨åŠ¨æ€ç¼–è¯‘åŒæ­¥ä»£ç å—çš„æ—¶å€™ï¼Œjitç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†ææ¥åˆ¤æ–­åŒæ­¥å—æ‰€ä½¿ç”¨çš„é”çš„å¯¹è±¡æ˜¯å¦åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆJITç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™ä¸ªåŒæ­¥å—çš„æ—¶å€™å°±ä¼šå–æ¶ˆå¯¹è¿™éƒ¨åˆ†ä»£ç çš„åŒæ­¥ã€‚è¿™æ ·å°±èƒ½å¤§å¤§æé«˜å¹¶å‘æ€§èƒ½ï¼Œè¿™ä¸ªå–æ¶ˆçš„æ€§èƒ½å°±å«åšåŒæ­¥çœç•¥ï¼Œä¹Ÿå«é”æ¶ˆé™¤ã€‚ 3ï¼‰åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡æ›¿æ¢ æœ‰çš„å¯¹è±¡å¯èƒ½ä¸éœ€è¦ä½œä¸ºä¸€ä¸ªè¿ç»­çš„å†…å­˜ç»“æ„å­˜åœ¨ä¹Ÿå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹è±¡çš„éƒ¨åˆ†å¯ä»¥ä¸å­˜å‚¨åœ¨å†…å­˜ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ 1.æ ‡é‡æ˜¯æŒ‡ä¸€ä¸ªæ— æ³•åœ¨åˆ†è§£æˆæ›´å°çš„æ•°æ®çš„æ•°æ®ï¼ŒJavaä¸­çš„åŸå§‹æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ã€‚ç›¸å¯¹çš„ï¼Œé‚£äº›è¿˜å¯ä»¥åˆ†è§£çš„æ•°æ®å«åšèšåˆé‡ï¼Œjavaä¸­çš„å¯¹è±¡å°±æ˜¯èšåˆé‡ï¼Œå› ä¸ºä»–å¯ä»¥åˆ†è§£æˆå…¶ä»–èšåˆé‡å’Œæ ‡é‡ã€‚åœ¨JITé˜¶æ®µï¼Œå¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼Œå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–ç•Œè®¿é—®çš„è¯ï¼Œé‚£ä¹ˆç»è¿‡JITä¼˜åŒ–ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡æ‹†è§£æˆè‹¥å¹²ä¸ªå…¶ä¸­åŒ…å«çš„è‹¥å¹²ä¸ªæˆå‘˜å˜é‡æ¥ä»£æ›¿ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ ‡é‡æ›¿æ¢ã€‚ 2.æ ‡é‡æ›¿æ¢çš„å‚æ•°è®¾ç½® å‚æ•°-XXï¼š+EliminateAllocationså¼€å¯äº†æ ‡é‡æ›¿æ¢ï¼Œå…è®¸å°†å¯¹è±¡æ‰“æ•£åˆ†é…åœ¨æ ˆä¸Šã€‚ 3.é€ƒé€¸åˆ†ææŠ€æœ¯å¹¶ä¸æˆç†Ÿï¼Œå…¶æ ¹æœ¬åŸå› å°±æ˜¯æ— æ³•ä¿è¯é€ƒé€¸åˆ†æçš„æ€§èƒ½æ¶ˆè€—ä¸€å®šé«˜äºä»–çš„æ¶ˆè€—ã€‚è™½ç„¶ç»è¿‡é€ƒé€¸åˆ†æå¯ä»¥åšæ ‡é‡æ›¿æ¢ï¼Œæ ˆä¸Šåˆ†é…å’Œé”æ¶ˆé™¤ã€‚ä½†æ˜¯é€ƒé€¸åˆ†æè‡ªèº«ä¹Ÿæ˜¯éœ€è¦è¿›è¡Œä¸€ç³»åˆ—å¤æ‚çš„åˆ†æçš„ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„è¿‡ç¨‹ï¼Œè™½ç„¶å¹¶ä¸æˆç†Ÿï¼Œä½†æ˜¯ä»–ä¹Ÿæ˜¯å³æ—¶ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ä¸­ä¸€ä¸ªååˆ†é‡è¦çš„æ‰‹æ®µã€‚ é€šè¿‡é€ƒé€¸åˆ†æï¼Œjvmä¼šåœ¨æ ˆä¸Šåˆ†é…é‚£äº›ä¸ä¼šé€ƒé€¸çš„å¯¹è±¡ï¼Œè¿™åœ¨ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å–å†³äºjvmè®¾è®¡è€…çš„é€‰æ‹©ã€‚HotSpotè™šæ‹Ÿæœºä¸­å¹¶æœªè¿™ä¹ˆåšï¼Œæ‰€ä»¥å¯ä»¥æ˜ç¡®æ‰€æœ‰çš„å¯¹è±¡å®åŠ›éƒ½æ˜¯åˆ›å»ºåœ¨å †ä¸Šã€‚ internå­—ç¬¦ä¸²çš„ç¼“å­˜å’Œé™æ€å˜é‡æ›¾ç»éƒ½è¢«åˆ†é…åˆ°æ°¸ä¹…å¸¦ä¸Šï¼Œè€Œæ°¸ä¹…ä»£å·²ç»è¢«å…ƒæ•°æ®åŒºå–ä»£ã€‚ä½†æ˜¯ï¼Œinternå­—ç¬¦ä¸²ç¼“å­˜å’Œé™æ€å˜é‡å¹¶ä¸æ˜¯è¢«è½¬ç§»åˆ°å…ƒæ•°æ®åŒºï¼Œè€Œæ˜¯ç›´æ¥åœ¨å †ä¸Šåˆ†é… ï¼Œæ‰€ä»¥è¿™ä¸€ç‚¹åŒæ ·ç¬¦åˆå‰é¢çš„ä¸€ç‚¹ç»“è®ºï¼šå¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ†é…åœ¨å †ä¸Šã€‚ 61.åƒåœ¾å›æ”¶åˆ†ç±»æŒ‰ç…§åƒåœ¾å›æ”¶çº¿ç¨‹åˆ†ï¼šä¸²è¡Œåƒåœ¾å›æ”¶å™¨å’Œå¹¶è¡Œåƒåœ¾å›æ”¶å™¨ ä¸²è¡Œå›æ”¶æ˜¯æŒ‡åœ¨åŒä¸€æ—¶é—´æ®µå†…åªå…è®¸æœ‰ä¸€ä¸ªcpuæ‰§è¡Œåƒåœ¾å›æ”¶æ“ä½œï¼Œæ­¤æ—¶å·¥ä½œçº¿ç¨‹è¢«æš‚åœï¼Œç›´è‡³åƒåœ¾å›æ”¶ç»“æŸã€‚ å¹¶è¡Œåˆ™æ˜¯å…è®¸è¿ç”¨å¤šä¸ªcpuåŒæ—¶æ‰§è¡Œåƒåœ¾å›æ”¶æ“ä½œã€‚ æŒ‰ç…§å·¥ä½œæ¨¡å¼åˆ†ï¼šå¹¶å‘å¼åƒåœ¾å›æ”¶å™¨å’Œç‹¬å å¼åƒåœ¾å›æ”¶å™¨ å¹¶å‘å¼åƒåœ¾å›æ”¶å™¨ä¸åº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿ï¼Œå°½å¯èƒ½å‡å°‘åº”ç”¨ç¨‹åºæš‚åœæ—¶é—´ã€‚ ç‹¬å å¼åƒåœ¾å›æ”¶å™¨ä¸€æ—¦è¿è¡Œï¼Œå°±ç¦æ­¢åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œç›´åˆ°åƒåœ¾å›æ”¶è¿‡ç¨‹å®Œå…¨ç»“æŸã€‚ æŒ‰ç…§ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†ç±»ï¼Œå‹ç¼©åƒåœ¾å›æ”¶å™¨å’Œéå‹ç¼©åƒåœ¾å›æ”¶å™¨ å‹ç¼©å¼åƒåœ¾å›æ”¶å™¨ä¼šåœ¨å›æ”¶å®Œæˆåï¼Œå¯¹å­˜æ´»å¯¹è±¡è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œæ¶ˆé™¤å›æ”¶åçš„ç¢ç‰‡ã€‚ éå‹ç¼©å¼çš„åƒåœ¾å›æ”¶å™¨ä¸è¿›è¡Œè¿™æ­¥æ“ä½œã€‚ æŒ‰ç…§å·¥ä½œçš„å†…å­˜åŒºé—´åˆ†ï¼šåˆå¯åˆ†ä¸ºå¹´è½»ä»£çš„åƒåœ¾å›æ”¶å™¨å’Œè€å¹´ä»£çš„åƒåœ¾å›æ”¶å™¨ã€‚ 62.è¯„ä¼°GCçš„æ€§èƒ½æŒ‡æ ‡ååé‡ï¼šè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´å æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹ã€‚ï¼ˆæ€»è¿è¡Œæ—¶é—´=ç¨‹åºè¿è¡Œæ—¶é—´+åƒåœ¾å›æ”¶æ—¶é—´ï¼‰ æš‚åœæ—¶é—´ï¼šæ‰§è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹è¢«æš‚åœçš„æ—¶é—´ã€‚ æ”¶é›†é¢‘ç‡ï¼šç›¸å¯¹äºåº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼Œæ”¶é›†å‘ç”Ÿçš„é¢‘ç‡ã€‚ å†…å­˜å ç”¨ï¼šjavaå †åŒºæ‰€å å†…å­˜å¤§å°ã€‚ ä¸‰è€…æ€»ä½“è¡¨ç°ä¼šéšç€æŠ€æœ¯è¿›æ­¥è¶Šæ¥è¶Šå¥½ï¼Œä¸»è¦æŠ“ä½ä¸¤ç‚¹ï¼šååé‡å’Œæš‚åœæ—¶é—´ã€‚ å¦‚æœä»¥ååé‡ä¼˜å…ˆï¼Œé‚£ä¹ˆå¿…ç„¶éœ€è¦é™ä½å†…å­˜å›æ”¶çš„æ‰§è¡Œæ•ˆç‡ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´GCéœ€è¦æ›´é•¿çš„æ—¶é—´æ¥æ‰§è¡Œå†…å­˜å›æ”¶ã€‚å¦‚æœé€‰æ‹©ä½å»¶è¿Ÿä¼˜å…ˆï¼Œä¸ºäº†é™ä½æ¯æ¬¡å†…å­˜å›æ”¶æ—¶çš„æš‚åœæ—¶é—´ï¼Œä¹Ÿåªèƒ½é¢‘ç¹çš„æ‰§è¡Œå†…å­˜å›æ”¶ï¼Œä½†åˆå¼•èµ·äº†å¹´è½»ä»£å†…å­˜çš„ç¼©å‡å’Œå¯¼è‡´ç¨‹åºååé‡çš„ä¸‹é™ã€‚ æ ‡å‡†ï¼šåœ¨æœ€å¤§ååé‡ä¼˜å…ˆçš„æƒ…å†µä¸‹ï¼Œé™ä½åœé¡¿æ—¶é—´ã€‚ 63.ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°1ï¼‰åƒåœ¾æ”¶é›†å™¨å‘å±•å†å² 1JDK1.3å‘å¸ƒSerial GC ä»–æ˜¯ç¬¬ä¸€æ¬¾GCã€‚ParNewæ˜¯Serial çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚ 1JDK1.4å‘å¸ƒParallel GC å’Œ Concurrent Mark Sweep GCã€‚ 1JDK6ä¹‹åParallel GCç§°ä¸ºHotSpoté»˜è®¤åƒåœ¾å›æ”¶å™¨ã€‚ 1JDK1.7å¼•å…¥G1ã€‚ 1JDK9æŠŠG1å˜ä¸ºé»˜è®¤åƒåœ¾æ”¶é›†å™¨ï¼Œæ›¿ä»£CMSã€‚ 1JDK10ä¸­G1åƒåœ¾æ”¶é›†å™¨çš„å¹¶è¡Œå®Œæ•´åƒåœ¾å›æ”¶ï¼Œå®ç°å¹¶è¡Œæ€§æ¥æ”¹å–„æœ€åæƒ…å†µä¸‹çš„å»¶è¿Ÿã€‚ 1JDK11å¼•å…¥Epsilon GCã€‚åŒæ—¶å¼•å…¥ZGCã€‚ 1JDK12å¢å¼ºG1ï¼Œè‡ªåŠ¨è¿”å›æœªä½¿ç”¨å †å†…å­˜ç»™æ“ä½œç³»ç»Ÿï¼ŒåŒæ—¶å¼•å…¥Shenandoah GCã€‚ 1JDK13å¢å¼ºZGCã€‚ 1JDK14åˆ é™¤CMSï¼Œå¹¶æ‹“å±•ZGCçš„å¹³å°å…¼å®¹æ€§ã€‚ 2ï¼‰åƒåœ¾æ”¶é›†å™¨åˆ†ç±» ä¸²è¡Œå›æ”¶å™¨ï¼šSerialï¼ŒSerial Old å¹¶è¡Œå›æ”¶å™¨ï¼šParNewï¼ŒParallel Scavengeï¼ŒParallel Old å¹¶å‘å›æ”¶å™¨ï¼šCMS,Gl æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼šSerialï¼ŒParNewï¼ŒParallel Scavenge è€å¹´ä»£æ”¶é›†å™¨ï¼šSerial Oldï¼ŒParallel Oldï¼ŒCMS æ•´å †æ”¶é›†å™¨ï¼šG1 ä¸ºä»€ä¹ˆè¦æœ‰å¾ˆå¤šæ”¶é›†å™¨ï¼Ÿ å› ä¸ºjavaä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼Œç§»åŠ¨ç«¯ï¼ŒæœåŠ¡ç«¯ç­‰ã€‚æ‰€ä»¥å°±éœ€è¦é’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œæä¾›ä¸åŒçš„åƒåœ¾å›æ”¶å™¨ï¼Œæé«˜åƒåœ¾æ”¶é›†çš„æ€§èƒ½ã€‚ å¯¹åƒåœ¾æ”¶é›†å™¨è¿›è¡Œæ¯”è¾ƒåªæ˜¯å¯¹å…·ä½“åº”ç”¨åœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„æ”¶é›†å™¨ã€‚ å¦‚ä½•æŸ¥çœ‹é»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ï¼Ÿ 12345-XX:+PrintCommandLineFlags æŸ¥çœ‹å‘½ä»¤è¡Œç›¸å…³å‚æ•°ï¼ˆåŒ…å«åƒåœ¾æ”¶é›†å™¨ï¼‰ä½¿ç”¨å‘½ä»¤è¡ŒæŒ‡ä»¤ï¼šjinfo -flag ç›¸å…³åƒåœ¾å›æ”¶å™¨å‚æ•° è¿›ç¨‹IDParallel Scavenge å’Œ Parallel Old 64.Serial å›æ”¶å™¨ï¼ˆä¸²è¡Œå›æ”¶å™¨ï¼‰jdk1.3ä¹‹å‰å›æ”¶æ–°ç”Ÿä»£çš„å”¯ä¸€é€‰æ‹©ï¼ˆHotSpotåœ¨Clientæ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨ï¼‰ Serial æ”¶é›†å™¨é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œä¸²è¡Œå›æ”¶å’ŒSTWæœºåˆ¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶ã€‚ é™¤äº†å¹´è½»ä»£ï¼ŒSerialæ”¶é›†å™¨è¿˜æä¾›ç”¨äºæ‰§è¡Œè€å¹´ä»£åƒåœ¾å›æ”¶çš„Serial Oldæ”¶é›†å™¨ã€‚Serial Old æ”¶é›†å™¨åŒæ ·ä¹Ÿé‡‡ç”¨äº†ä¸²è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ï¼Œåªä¸è¿‡å†…å­˜å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯æ ‡è®°-å‹ç¼©ç®—æ³•ã€‚ Serial Oldæ˜¯è¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹é»˜è®¤çš„è€å¹´ä»£åƒåœ¾å›æ”¶å™¨ã€‚ Serial Oldåœ¨Serveræ¨¡å¼ä¸‹ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”ï¼š1.ä¸æ–°ç”Ÿä»£çš„Parallel Scavengeé…åˆä½¿ç”¨ 2.ä½œä¸ºè€å¹´ä»£CMSæ”¶é›†å™¨çš„åå¤‡åƒåœ¾æ”¶é›†æ–¹æ¡ˆã€‚ è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œä½†ä»–çš„å•çº¿ç¨‹çš„æ„ä¹‰å¹¶ä¸ä»…ä»…è¯´æ˜å®ƒåªä¼šä½¿ç”¨ä¸€ä¸ªCPUæˆ–ä¸€æ¡æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å®ƒè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°ä»–æ”¶é›†ç»“æŸã€‚ ä¼˜åŠ¿ï¼šç®€å•è€Œé«˜æ•ˆï¼Œå¯¹äºé™å®šå•ä¸ªCPUçš„ç¯å¢ƒæ¥è®²ï¼ŒSerialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œä¸“å¿ƒåšåƒåœ¾æ”¶é›†è‡ªç„¶å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚ï¼ˆè¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼‰ åœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œä½¿ç”¨-XX:UseSerialGC å‚æ•°å¯ä»¥æŒ‡å®šå¹´è½»ä»£å’Œè€å¹´ä»£éƒ½æ˜¯ç”¨ä¸²è¡Œæ”¶é›†å™¨ã€‚ï¼ˆç­‰ä»·äºæ–°ç”Ÿä»£ä½¿ç”¨Serial GCï¼Œè€å¹´ä»£ä½¿ç”¨Serial Old GCï¼‰ï¼Œä¸€èˆ¬åœ¨java webç¨‹åºä¸­æ˜¯ä¸ä¼šä½¿ç”¨è¿™ç§åƒåœ¾å›æ”¶å™¨çš„ã€‚ 65.ParNewå›æ”¶å™¨ï¼ˆå¹¶è¡Œå›æ”¶ï¼‰å¦‚æœè¯´Serial GCæ˜¯å¹´è½»ä»£ä¸­çš„å•çº¿ç¨‹åƒåœ¾æ”¶é›†å™¨ï¼Œé‚£ä¹ˆParNewæ”¶é›†å™¨åˆ™æ˜¯Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚ï¼ˆParæ˜¯Parallelçš„ç¼©å†™ Newåªèƒ½å¤„ç†æ–°ç”Ÿä»£ï¼‰ ParNewæ”¶é›†å™¨é™¤äº†é‡‡ç”¨å¹¶è¡Œå›æ”¶æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶å¤–ï¼Œä¸¤æ¬¾åƒåœ¾æ”¶é›†å™¨ä¹‹é—´å‡ ä¹æ²¡æœ‰å·®åˆ«ï¼Œä¹Ÿæ˜¯STWï¼Œä¹Ÿæ˜¯å¤åˆ¶ç®—æ³•ã€‚ ParNewæ˜¯å¾ˆå¤šJVMè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹æ–°ç”Ÿä»£çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨ã€‚ å¯¹äºæ–°ç”Ÿä»£ï¼Œå›æ”¶æ¬¡æ•°é¢‘ç¹ï¼Œä½¿ç”¨å¹¶è¡Œé«˜æ•ˆã€‚å¯¹äºè€å¹´ä»£ï¼Œå›æ”¶æ¬¡æ•°å°‘ï¼Œä½¿ç”¨ä¸²è¡Œæ–¹å¼èŠ‚çœèµ„æºã€‚ï¼ˆCPUå¹¶è¡Œéœ€è¦åˆ‡æ¢çº¿ç¨‹ï¼Œä¸²è¡Œå¯ä»¥çœå»åˆ‡æ¢çº¿ç¨‹çš„èµ„æºï¼‰ ç”±äºParNewæ”¶é›†å™¨æ˜¯å¹¶è¡Œå›æ”¶ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥æ–­å®šåœ¨ä»»ä½•åœºæ™¯ä¸‹ä»–çš„å›æ”¶æ•ˆç‡éƒ½æ¯”Serialæ”¶é›†å™¨æ›´é«˜æ•ˆï¼Ÿ 1.å¤šæ ¸ç³»ç»Ÿä¸‹ï¼Œå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œå¯ä»¥å¿«é€Ÿå®Œæˆåƒåœ¾æ”¶é›†ï¼Œæå‡ç¨‹åºååé‡ã€‚ 2.ä½†æ˜¯å•ä¸ªCPUä¸‹ï¼Œä»–ä¸ä¸€å®šæœ‰Serialæ”¶é›†å™¨æ›´é«˜æ•ˆã€‚é¿å…äº†çº¿ç¨‹åˆ‡æ¢ã€‚ é™¤äº†Serial å¤–ï¼Œç›®å‰åªæœ‰ParNew èƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œã€‚ åœ¨ç¨‹åºä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹-XX:UseParNewGCæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨ParNewæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ ã€‚ä»–è¡¨ç¤ºå¹´è½»ä»£ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨å¹¶ä¸å½±å“è€å¹´ä»£ã€‚ -XX:ParallelGCThreadsé™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤å¼€å¯å’ŒCPUæ•°ç›¸åŒçš„çº¿ç¨‹æ•°ã€‚ 66.Parallel Scavenge å›æ”¶å™¨ï¼ˆååé‡ä¼˜å…ˆï¼‰1ï¼‰æ¦‚è¿° HotSpotçš„å¹´è½»ä»£é™¤äº†æ‹¥æœ‰ParNewæ”¶é›†å™¨æ˜¯åŸºäºå¹¶è¡Œå›æ”¶çš„ä»¥å¤–ï¼ŒParallel Scavengeæ”¶é›†å™¨åŒæ ·ä¹Ÿé‡‡ç”¨äº†å¤åˆ¶ç®—æ³•ï¼Œå¹¶è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ã€‚ é‚£ä¹ˆä»–çš„å‡ºç°æ˜¯å¦å¤šæ­¤ä¸€ä¸¾å‘¢ï¼Ÿ 1.å’ŒParNewæ”¶é›†å™¨ä¸åŒï¼ŒParallel Scavengeæ”¶é›†å™¨çš„ç›®æ ‡åˆ™æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ï¼Œä»–ä¹Ÿè¢«ç§°ä¸ºååé‡ä¼˜å…ˆçš„åƒåœ¾æ”¶é›†å™¨ã€‚ 2.è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ä¹Ÿæ˜¯Parallel Scavengeä¸ParNewä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚ é«˜ååé‡å¯ä»¥é«˜æ•ˆç‡çš„åˆ©ç”¨CPUæ—¶é—´ï¼Œå°½å¿«å®Œæˆç¨‹åºçš„è¿ç®—ä»»åŠ¡ï¼Œä¸»è¦é€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ã€‚å› æ­¤ï¼Œå¸¸è§åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šé‚£äº›æ‰§è¡Œæ‰¹é‡å¤„ç†ï¼Œè®¢å•å¤„ç†ï¼Œå·¥èµ„æ”¯ä»˜ï¼Œç§‘å­¦è®¡ç®—çš„åº”ç”¨ç¨‹åºã€‚ Parallel æ”¶é›†å™¨åœ¨jdk1.6çš„æ—¶å€™æä¾›äº†ç”¨äºæ‰§è¡Œè€å¹´ä»£åƒåœ¾æœé›†çš„Parallel Oldæ”¶é›†å™¨ï¼Œç”¨æ¥æ›¿ä»£è€å¹´ä»£çš„Serial Oldæ”¶é›†å™¨ã€‚Parallel Oldæ”¶é›†å™¨é‡‡ç”¨äº†æ ‡è®°-å‹ç¼©ç®—æ³•ï¼Œä½†æ˜¯åŒæ ·ä¹Ÿæ˜¯åŸºäºå¹¶è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ã€‚ åœ¨ç¨‹åºååé‡ä¼˜å…ˆçš„åœºæ™¯ä¸­ï¼ŒParallelæ”¶é›†å™¨å’ŒParallel Oldæ”¶é›†å™¨çš„ç»„åˆï¼Œåœ¨Serveræ¨¡å¼ä¸‹çš„å†…å­˜å›æ”¶æ€§èƒ½å¾ˆä¸é”™ã€‚åœ¨Java8ä¸­ï¼Œé»˜è®¤æ˜¯æ­¤åƒåœ¾å›æ”¶å™¨ã€‚ 2ï¼‰å‚æ•°é…ç½® -XX:UseParallelGC æ‰‹åŠ¨æŒ‡å®šå¹´è½»ä»£ä½¿ç”¨Parallelå¹¶è¡Œæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚ -XX:+UseParallelOldGC æ‰‹åŠ¨æŒ‡å®šè€å¹´ä»£éƒ½æ˜¯ä½¿ç”¨å¹¶è¡Œå›æ”¶å™¨ã€‚ï¼ˆåˆ†åˆ«é€‚ç”¨äºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚é»˜è®¤æ˜¯JDK8å¼€å¯çš„ï¼‰ -XX:ParallelGCThreads è®¾ç½®å¹´è½»ä»£å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ã€‚ä¸€èˆ¬çš„æœ€å¥½ä¸CPUæ•°é‡ç›¸ç­‰ï¼Œé¿å…çº¿ç¨‹æ•°å½±å“æ”¶é›†å™¨æ€§èƒ½ã€‚ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼ŒCPUæ•°å°äº8ï¼ŒParallelGCThreadsçš„å€¼ç­‰äºCPUæ•°é‡ï¼Œå½“cpuæ•°å¤§äº8ä¸ªçš„æ—¶å€™ï¼ŒParallelGCThreadså€¼=3+[5*cpuæ•°]/8 ï¼‰ -XX:MaxGCPauseMillis è®¾ç½®åƒåœ¾æ”¶é›†å™¨æœ€å¤§åœé¡¿æ—¶é—´ï¼ˆSTWçš„æ—¶é—´ï¼Œå•ä½æ˜¯msï¼‰ ä¸ºäº†å°½å¯èƒ½æŠŠåœé¡¿æ—¶é—´æ§åˆ¶åœ¨MaxGCPauseMillsä»¥å†…ï¼Œæ”¶é›†å™¨åœ¨å·¥ä½œæ—¶ä¼šè°ƒæ•´Javaå †å¤§å°æˆ–è€…å…¶ä»–ä¸€äº›å‚æ•°ã€‚å¯¹äºç”¨æˆ·æ¥è®²ï¼Œåœé¡¿æ—¶é—´è¶ŠçŸ­ï¼Œä½“éªŒè¶Šå¥½ã€‚ä½†æ˜¯åœ¨æœåŠ¡å™¨ç«¯ï¼Œæˆ‘ä»¬æ³¨é‡é«˜å¹¶å‘ï¼Œæ•´ä½“çš„ååé‡ï¼Œæ‰€ä»¥æœåŠ¡ç«¯é€‚åˆParallelï¼Œè¿›è¡Œæ§åˆ¶ã€‚ï¼ˆè¯¥å‚æ•°è°¨æ…ä½¿ç”¨ï¼‰ -XX:GCTimeRatio åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´æ¯”ä¾‹ï¼ˆ=1/(N+1)ï¼‰ç”¨äºè¡¡é‡ååé‡å¤§å°ã€‚ -XX:UseAdaptiveSizePolicy è®¾ç½®Parallel Scavengeæ”¶é›†å™¨å…·æœ‰è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¹´è½»ä»£çš„å¤§å°ï¼ŒEdenå’Œå¹¸å­˜è€…çš„æ¯”ä¾‹ï¼Œæ™‹å‡è€å¹´ä»£çš„å¯¹è±¡å¹´é¾„ç­‰å‚æ•°ä¼šè¢«è‡ªåŠ¨è°ƒæ•´ï¼Œå·²ç»è¾¾åˆ°åœ¨å †å¤§å°ï¼Œååé‡å’Œåœé¡¿æ—¶é—´ä¹‹é—´çš„å¹³è¡¡ç‚¹ã€‚ åœ¨æ‰‹åŠ¨è°ƒä¼˜æ¯”è¾ƒå›°éš¾çš„åœºåˆï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ç§è‡ªé€‚åº”çš„æ–¹å¼ï¼Œä»…ä»…æŒ‡å®šè™šæ‹Ÿæœºçš„æœ€å¤§å †ï¼Œç›®æ ‡ååé‡å’Œåœé¡¿æ—¶é—´ï¼Œè®©è™šæ‹Ÿæœºè‡ªå·±å®Œæˆè°ƒä¼˜å·¥ä½œã€‚ 67.CMSå›æ”¶å™¨ï¼ˆä½å»¶è¿Ÿï¼‰1ï¼‰æ¦‚è¿° JDK1.5ï¼Œè¿™æ¬¾æ”¶é›†å™¨æ˜¯HotSpotè™šæ‹Ÿæœºç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å·¥ä½œã€‚ CMSçš„å…³æ³¨ç‚¹æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ã€‚åœé¡¿æ—¶é—´è¶ŠçŸ­å°±è¶Šé€‚åˆäºç”¨æˆ·äº¤äº’çš„ç¨‹åºï¼Œè‰¯å¥½çš„å“åº”é€Ÿåº¦èƒ½æå‡ç”¨æˆ·ä½“éªŒã€‚ ç›®å‰å¾ˆå¤§ä¸€éƒ¨åˆ†çš„javaåº”ç”¨é›†ä¸­åœ¨äº’è”ç½‘æˆ–è€…B/Sæ¶æ„ç³»ç»Ÿçš„æœåŠ¡ç«¯ä¸Šï¼Œè¿™ç±»åº”ç”¨å°¤å…¶é‡è§†æœåŠ¡çš„å“åº”é€Ÿåº¦ï¼Œå¸Œæœ›ç³»ç»Ÿåœæ®µæ—¶é—´æœ€çŸ­ï¼Œä»¥ç»™ç”¨æˆ·è¾ƒå¥½çš„ä½“éªŒæ„Ÿã€‚ CMSçš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå¹¶ä¸”ä¹Ÿä¼šSTWã€‚ ä¸å¹¸çš„æ˜¯ï¼ŒCMSä½œä¸ºè€å¹´ä»£çš„æ”¶é›†å™¨ï¼Œå´æ— æ³•ä¸JDK1.4ä¸­å·²ç»å­˜åœ¨çš„æ–°ç”Ÿä»£æ”¶é›†å™¨Parallel Scavenge é…åˆå·¥ä½œï¼Œæ‰€ä»¥åœ¨JDK1.5ä¸­ä½¿ç”¨CMSæ¥æ”¶é›†è€å¹´ä»£çš„æ—¶å€™ï¼Œæ–°ç”Ÿä»£åªèƒ½é€‰æ‹©ParNewæˆ–è€…Parialæ”¶é›†å™¨ä¸­çš„ä¸€ä¸ªã€‚ åœ¨G1å‡ºç°ä¹‹å‰ï¼ŒCMSè¿˜æ˜¯éå¸¸å¹¿æ³›çš„ï¼Œä¸€ç›´åˆ°ä»Šå¤©ï¼Œä»ç„¶æœ‰è®¸å¤šç³»ç»Ÿä½¿ç”¨CMS GCã€‚ 2ï¼‰CMSå·¥ä½œæµç¨‹ åˆå§‹æ ‡è®°ï¼šæ ‡è®°å‡ºGCROOTSèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼ˆé€Ÿåº¦å¿«ï¼‰ å¹¶å‘æ ‡è®°ï¼šä»GCROOTSçš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼ˆè€—æ—¶é•¿ï¼Œä½†æ˜¯ä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä»¥ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸€èµ·å¹¶å‘è¿è¡Œï¼‰ é‡æ–°æ ‡è®°ï¼šä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼ˆæ—¶é—´æ¯”åˆå§‹æ ‡è®°ç¨å¾®é•¿ï¼‰ å¹¶å‘æ¸…é™¤ï¼šæ¸…ç†åˆ é™¤æ‰æ ‡è®°é˜¶æ®µåˆ¤æ–­çš„å·²ç»æ­»äº¡çš„å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´ã€‚ï¼ˆç”±äºä¸éœ€è¦ç§»åŠ¨å­˜æ´»çš„å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„ï¼‰ åˆå§‹åŒ–æ ‡è®°å’Œå†æ¬¡æ ‡è®°ä»ç„¶è¦STWæœºåˆ¶ï¼Œç›®å‰æ‰€æœ‰çš„æ¥æ”¶é›†å™¨éƒ½åšä¸åˆ°å®Œå…¨ä¸éœ€è¦STWï¼Œåªæ˜¯å°½å¯èƒ½çš„ç¼©çŸ­æš‚åœæ—¶é—´ã€‚ç”±äºæœ€è€—è´¹æ—¶é—´çš„å¹¶å‘æ ‡è®°ä¸å¹¶å‘æ¸…é™¤é˜¶æ®µéƒ½ä¸éœ€è¦æš‚åœå·¥ä½œï¼Œæ‰€ä»¥æ•´ä½“çš„å›æ”¶æ˜¯ä½åœé¡¿çš„ã€‚ åœ¨CMSå›æ”¶è¿‡ç¨‹ä¸­ï¼Œè¿˜åº”è¯¥ç¡®ä¿åº”ç”¨ç¨‹åºçº¿ç¨‹æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ç”¨ã€‚å› æ­¤ï¼ŒCMSæ”¶é›†å™¨ä¸èƒ½åƒå…¶ä»–æ”¶é›†å™¨é‚£æ ·ç­‰åˆ°è€å¹´ä»£å‡ ä¹å®Œå…¨è¢«å¡«æ»¡äº†åœ¨è¿›è¡Œæ”¶é›†ï¼Œè€Œæ˜¯å½“å †å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°æŸä¸€é˜ˆå€¼æ—¶ï¼Œä¾¿å¼€å§‹è¿›è¡Œå›æ”¶ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºåœ¨CMSå·¥ä½œè¿‡ç¨‹ä¸­ä¾ç„¶æœ‰è¶³å¤Ÿçš„ç©ºé—´æ”¯æŒåº”ç”¨ç¨‹åºåœ¨è¿è¡Œã€‚è¦æ˜¯CMSè¿è¡ŒæœŸé—´é¢„ç•™çš„å†…å­˜æ— æ³•æ»¡è¶³ç¨‹åºéœ€è¦ï¼Œå°±ä¼šå‡ºç°ä¸€æ¬¡â€Concurrent Mode Failureâ€å¤±è´¥ï¼Œè¿™æ—¶è™šæ‹Ÿæœºå°†å¯åŠ¨é¢„å¤‡æ–¹æ¡ˆï¼Œä¸´æ—¶å¯åŠ¨Serial Oldæ”¶é›†å™¨æ¥é‡æ–°æ”¶é›†è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œè¿™æ ·åœé¡¿æ—¶é—´å°±å¾ˆé•¿äº†ã€‚ CMSçš„åƒåœ¾æ”¶é›†ç®—æ³•ä½¿ç”¨çš„æ˜¯æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œä¸å¯é¿å…çš„ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œæ— æ³•ä½¿ç”¨æŒ‡é’ˆç¢°æ’ï¼Œåªèƒ½é€‰æ‹©ç©ºé—²åˆ—è¡¨ã€‚ æ ‡è®°æ¸…é™¤ç®—æ³•ä¼šé€ æˆå†…å­˜ç¢ç‰‡ï¼Œä¸ºä»€ä¹ˆä¸æŠŠç®—æ³•æ¢æˆæ ‡è®°æ•´ç†ç®—æ³•å‘¢ï¼Ÿ å› ä¸ºå½“å¹¶å‘æ¸…é™¤æ—¶ï¼Œç”¨æ ‡è®°æ•´ç†ç®—æ³•æ•´ç†å†…å­˜çš„è¯ï¼ŒåŸæ¥çš„ç”¨æˆ·çº¿ç¨‹ä½¿ç”¨çš„å†…å­˜æ— æ³•ç»§ç»­ä½¿ç”¨ï¼Œè¦ä¿è¯ç”¨æˆ·çº¿ç¨‹è¿˜èƒ½ç»§ç»­æ‰§è¡Œï¼Œå‰ææ˜¯ä»–è¿è¡Œçš„èµ„æºä¸å—å½±å“ã€‚ ä¼˜ç‚¹ï¼šå¹¶å‘æ”¶é›†ï¼Œä½å»¶è¿Ÿ ç¼ºç‚¹ï¼šä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¯¹CPUèµ„æºæ•æ„Ÿï¼ˆå¹¶å‘é˜¶æ®µï¼Œå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹å¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼Œæ€»ååé‡é™ä½ï¼‰ï¼Œæ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ï¼ˆåœ¨å¹¶å‘é˜¶æ®µå¦‚æœäº§ç”Ÿæ–°çš„åƒåœ¾å¯¹è±¡ï¼ŒCMSæ— æ³•å¯¹è¿™äº›åƒåœ¾å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œæœ€ç»ˆä¼šå¯¼è‡´è¿™äº›æ–°äº§ç”Ÿ çš„åƒåœ¾å¯¹è±¡æ²¡æœ‰åŠæ—¶å›æ”¶ï¼Œåªèƒ½åœ¨ä¸‹ä¸€æ¬¡GCçš„æ—¶å€™é‡Šæ”¾è¿™äº›ä¹‹å‰æœªè¢«å›æ”¶çš„å†…å­˜ç©ºé—´ï¼‰ 3ï¼‰å‚æ•°è®¾ç½® -XX:+UseConcMarkSweepGC æ‰‹åŠ¨æŒ‡å®šä½¿ç”¨CMSæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ -XX:CMSlnitiatingOccupanyFraction è®¾ç½®å †ä½¿ç”¨ç‡çš„é˜ˆå€¼ï¼Œä¸€æ—¦è¾¾åˆ°é˜ˆå€¼ï¼Œä¾¿å¼€å§‹åƒåœ¾å›æ”¶ -XX:+UseCMSCompactAtFullCollection ç”¨äºæŒ‡å®šåœ¨æ‰§è¡Œå®ŒFull GCåå †å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œä»¥æ­¤é¿å…å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿã€‚ä¸è¿‡ç”±äºå†…å­˜å‹ç¼©æ•´ç†è¿‡ç¨‹æ— æ³•å¹¶å‘æ‰§è¡Œï¼Œæ‰€å¸¦æ¥çš„çš„é—®é¢˜å°±æ˜¯åœé¡¿æ—¶é—´å˜å¾—æ›´é•¿äº†ã€‚ -XX:+CMSFullGCsBeforeCompaction è®¾ç½®åœ¨æ‰§è¡Œäº†å¤šå°‘æ¬¡Full GCåå¯¹å†…å­˜è¿›è¡Œå‹ç¼©æ•´ç†ã€‚ -XX:ParallelCMSThreads è®¾ç½®CMSçº¿ç¨‹æ•°ã€‚CMSé»˜è®¤å¯åŠ¨çº¿ç¨‹æ•°æ˜¯ ï¼ˆParallelGCThreads+3ï¼‰/4ï¼ŒParallelGCThreads æ˜¯å¹´è½»ä»£å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ã€‚å½“CPUèµ„æºç´§å¼ æ—¶ï¼Œå—åˆ°CMSæ”¶é›†å™¨çº¿ç¨‹çš„å½±å“ï¼Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½åœ¨åƒåœ¾å›æ”¶èŠ‚ç‚¹å¯èƒ½ä¼šéå¸¸ç³Ÿç³•ã€‚ 4ï¼‰å°æŠ€å·§ HotSpotæœ‰è¿™ä¹ˆå¤šçš„åƒåœ¾å›æ”¶å™¨ï¼Œé‚£ä¹ˆå¦‚æœæœ‰äººé—®ï¼ŒSerial GCï¼ŒParallel GCï¼ŒConcurrent Mark Sweep GCè¿™ä¸‰ä¸ªGCæœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ æœ€å°åŒ–çš„ä½¿ç”¨å†…å­˜å’Œå¹¶è¡Œå¼€é”€ Serial GC æœ€å¤§åŒ–åº”ç”¨ç¨‹åºçš„ååé‡ Parallel GC æœ€å°åŒ–GCçš„ä¸­æ–­æˆ–åœé¡¿æ—¶é—´ CMS GC 5ï¼‰åç»­ç‰ˆæœ¬å˜åŒ– JDK9 å£°æ˜CMSä¸ºè¿‡æ—¶ï¼ŒJDK14ç›´æ¥åˆ æ‰äº†ï¼Œå¦‚æœä½¿ç”¨ä¸ä¼šæŠ¥é”™ï¼Œåªæ˜¯ä¼šç»™å‡ºè­¦å‘Šï¼Œå¹¶ä½¿ç”¨é»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ã€‚ 68.G1å›æ”¶å™¨ï¼ˆåŒºåŸŸåˆ†ä»£åŒ–ï¼‰1ï¼‰æ¦‚è¿° G1æ˜¯åœ¨java7å¼•å…¥çš„åƒåœ¾å›æ”¶å™¨ï¼Œä¸ºäº†é€‚åº”ä¸æ–­æ‰©å¤§çš„å†…å­˜å’Œä¸æ–­å¢åŠ çš„å¤„ç†å™¨æ•°é‡ï¼Œè¿›ä¸€æ­¥é™ä½æš‚åœæ—¶é—´ï¼ŒåŒæ—¶å…¼é¡¾è‰¯å¥½çš„ååé‡ã€‚ ä¸ºä»€ä¹ˆå«G1å›æ”¶å™¨ï¼Ÿ å› ä¸ºG1æ˜¯ä¸€ä¸ªå¹¶è¡Œå›æ”¶å™¨ï¼Œä»–æŠŠå †å†…å­˜åˆ†å‰²æˆå¾ˆå¤šä¸ç›¸å…³çš„åŒºåŸŸã€‚G1æœ‰è®¡åˆ’çš„é¿å…åœ¨æ•´ä¸ªjavaå †ä¸­è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†ã€‚G1è·Ÿè¸ªå„ä¸ªåŒºåŸŸé‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„åŒºåŸŸã€‚ ç”±äºè¿™ç§æ–¹å¼çš„ä¾§é‡ç‚¹åœ¨äºå›æ”¶åƒåœ¾æœ€å¤§é‡çš„åŒºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»™G1ä¸€ä¸ªåå­—ï¼Œåƒåœ¾ä¼˜å…ˆã€‚ G1ä¸»è¦é’ˆå¯¹é…å¤‡å¤šæ ¸CPUä»¥åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ï¼Œæ˜¯JDK9ä»¥åçš„é»˜è®¤åƒåœ¾å›æ”¶å™¨ï¼Œåœ¨JDK8è¿˜ä¸æ˜¯é»˜è®¤çš„åƒåœ¾å›æ”¶å™¨ï¼Œéœ€è¦ä½¿ç”¨-XX:UseGmentGCæ¥å¯ç”¨ã€‚ ä¸å…¶ä»–åƒåœ¾å›æ”¶å™¨ç›¸æ¯”ï¼ŒG1ä½¿ç”¨äº†å…¨æ–°çš„åˆ†åŒºç®—æ³•ï¼š 2ï¼‰ç‰¹ç‚¹ â‘ å¹¶è¡Œä¸å¹¶å‘ å¹¶è¡Œæ€§ï¼šG1åœ¨å›æ”¶æœŸé—´ï¼Œå¯ä»¥æœ‰å¤šä¸ªGCçº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œæœ‰æ•ˆåˆ©ç”¨å¤šæ ¸è®¡ç®—èƒ½åŠ›ã€‚æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹STWã€‚ å¹¶å‘æ€§ï¼šG1æ‹¥æœ‰ä¸åº”ç”¨ç¨‹åºäº¤æ›¿æ‰§è¡Œçš„èƒ½åŠ›ï¼Œéƒ¨åˆ†å·¥ä½œå¯ä»¥å’Œåº”ç”¨ç¨‹åºåŒæ—¶æ‰§è¡Œï¼Œå› æ­¤ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸ä¼šå†æ•´ä¸ªå›æ”¶é˜¶æ®µå‘ç”Ÿå®Œå…¨é˜»å¡åº”ç”¨ç¨‹åºçš„æƒ…å†µã€‚ â‘¡åˆ†ä»£æ”¶é›† ä»åˆ†ä»£ä¸Šçœ‹ï¼ŒG1ä¾ç„¶å±äºåˆ†ä»£å‹åƒåœ¾å›æ”¶å™¨ï¼Œä»–ä¼šåŒºåˆ†å¹´è½»ä»£å’Œè€å¹´ä»£ï¼Œå¹´è½»ä»£ä¾ç„¶æœ‰EdenåŒºå’Œå¹¸å­˜è€…åŒºã€‚ä½†ä»å †çš„ç»“æ„ä¸Šçœ‹ï¼Œä»–ä¸è¦æ±‚æ•´ä¸ªEdenåŒºï¼Œå¹´è½»ä»£æˆ–è€…è€å¹´ä»£éƒ½æ˜¯è¿ç»­çš„ï¼Œä¹Ÿä¸å†åšæŒå›ºå®šå¤§å°å’Œå›ºå®šæ•°é‡ã€‚ å°†å †ç©ºé—´åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼Œè¿™äº›åŒºåŸŸä¸­åŒ…å«äº†é€»è¾‘ä¸Šçš„å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚ å’Œä¹‹å‰çš„å„ç±»å›æ”¶å™¨ä¸åŒï¼Œä»–åŒæ—¶å…¼é¡¾å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚ â‘¢ç©ºé—´æ•´åˆ CMSï¼šæ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œå†…å­˜ç¢ç‰‡ï¼Œè‹¥å¹²æ¬¡GCåè¿›è¡Œä¸€æ¬¡ç¢ç‰‡æ•´ç†ã€‚ G1å°†å†…å­˜åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªå°åŒºåŸŸï¼Œå†…å­˜çš„å›æ”¶æ˜¯ä»¥ä¸€ä¸ªä¸ªå°åŒºåŸŸä¸ºå•ä½çš„ã€‚åŒºåŸŸä¹‹é—´æ˜¯å¤åˆ¶ç®—æ³•ï¼Œä½†æ˜¯æ•´ä½“ä¸Šå¯ä»¥çœ‹æˆæ ‡è®°å‹ç¼©ç®—æ³•ï¼Œä¸¤ç§ç®—æ³•éƒ½å¯ä»¥é¿å…å†…å­˜ç¢ç‰‡ã€‚è¿™ç§ç‰¹æ€§æœ‰åˆ©äºç¨‹åºé•¿æ—¶é—´è¿è¡Œï¼Œåˆ†é…å¤§å¯¹è±¡æ—¶ä¸ä¼šå› ä¸ºæ— æ³•æ‰¾åˆ°è¿ç»­å†…å­˜ç©ºé—´è€Œæå‰è§¦å‘ä¸‹ä¸€æ¬¡GCã€‚å°¤å…¶æ˜¯å½“javaå †éå¸¸å¤§çš„æ—¶å€™ï¼ŒG1çš„ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚ â‘£å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´ æ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„åŒºåŸŸï¼Œä¿è¯äº†G1æ”¶é›†å™¨åœ¨æœ‰é™çš„æ—¶é—´å†…å¯ä»¥è·å–å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ã€‚ 3ï¼‰ç¼ºç‚¹ åœ¨ç”¨æˆ·ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒG1æ— è®ºæ˜¯ä¸ºäº†åƒåœ¾æ”¶é›†äº§ç”Ÿçš„å†…å­˜å ç”¨è¿˜æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„é¢å¤–æ‰§è¡Œè´Ÿè½½éƒ½è¦æ¯”CMSé«˜ã€‚ ç»éªŒä¸Šæ¥è®²ï¼šåœ¨å°å†…å­˜åº”ç”¨ä¸ŠCMSçš„è¡¨ç°å¤§æ¦‚ç‡ä¼šä¼˜å…ˆäºG1ï¼Œè€ŒG1åœ¨å¤§å†…å­˜åº”ç”¨ä¸Šåˆ™å‘æŒ¥å…¶ä¼˜åŠ¿ã€‚å¹³è¡¡ç‚¹åœ¨6-8Gä¹‹é—´ã€‚ 4ï¼‰å‚æ•°è®¾ç½® -XX:+UseG1GC æ‰‹åŠ¨æŒ‡å®šä½¿ç”¨G1åƒåœ¾æ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ -XX:G1HeapRegionSize è®¾ç½®æ¯ä¸ªåŒºåŸŸçš„å¤§å°ã€‚å€¼æ˜¯2çš„å¹‚ï¼ŒèŒƒå›´æ˜¯1M-32Mä¹‹é—´ã€‚ -XX:MaxGCPauseMillis è®¾ç½®æœŸæœ›è¾¾åˆ°çš„æœ€å¤§GCåœé¡¿æ—¶é—´æŒ‡æ ‡ -XX:ParallelGCThread è®¾ç½®STWå·¥ä½œçº¿ç¨‹æ•°ï¼Œæœ€å¤šè®¾ç½®ä¸º8 -XX:ConcGCThreads è®¾ç½®å¹¶å‘æ ‡è®°çš„çº¿ç¨‹æ•° -XX:InitiatingHeapOccupancyPercent è®¾ç½®è§¦å‘å¹¶å‘GCå‘¨æœŸçš„javaå †å ç”¨ç‡é˜ˆå€¼ã€‚è¶…è¿‡æ­¤å€¼ï¼Œå°±ä¼šå‡ºå‘GCã€‚ 5ï¼‰G1è°ƒä¼˜çš„æ­¥éª¤ å¼€å¯åƒåœ¾æ”¶é›†å™¨ è®¾ç½®å †çš„æœ€å¤§å†…å­˜ è®¾ç½®æœ€å¤§åœé¡¿æ—¶é—´ G1æä¾›äº†ä¸‰ç§åƒåœ¾æ”¶é›†æ¨¡å¼ï¼šYoungGCï¼ŒMixed GCå’ŒFull GCï¼Œåœ¨ä¸åŒçš„æ¡ä»¶ä¸‹è¢«è§¦å‘ã€‚ 6ï¼‰é€‚ç”¨åœºæ™¯ é¢å‘æœåŠ¡ç«¯åº”ç”¨ï¼Œé’ˆå¯¹å…·æœ‰å¤§å†…å­˜ï¼Œå¤šå¤„ç†å™¨çš„æœºå™¨ éœ€è¦ä½GCå»¶è¿Ÿï¼Œå¹¶å…·æœ‰å¤§å †çš„åº”ç”¨ç¨‹åºæä¾›è§£å†³æ–¹æ¡ˆ ç”¨æ¥æ›¿æ¢æ‰jdk5çš„cms HotSpotåƒåœ¾æ”¶é›†å™¨ï¼Œé™¤äº†G1ä»¥å¤–ï¼Œå…¶ä»–çš„åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨å†…ç½®çš„JVMçº¿ç¨‹æ‰§è¡ŒGCçš„å¤šçº¿ç¨‹æ“ä½œï¼Œè€ŒG1 GCå¯ä»¥é‡‡ç”¨åº”ç”¨çº¿ç¨‹æ‰¿æ‹…åå°è¿è¡Œçš„GCå·¥ä½œï¼Œå³å½“JVMçš„GCçº¿ç¨‹å¤„ç†é€Ÿåº¦æ…¢æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨åº”ç”¨ç¨‹åºçº¿ç¨‹å¸®åŠ©åŠ é€Ÿåƒåœ¾æ”¶é›†è¿‡ç¨‹ã€‚ æ‰€æœ‰çš„åŒºåŸŸéƒ½å¤§å°ç›¸åŒï¼Œå¹¶ä¸”åœ¨JVMç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šè¢«æ”¹å˜ï¼Œè™½ç„¶è¿˜ä¿ç•™æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†æ˜¯æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†æ˜¯ç‰©ç†éš”ç¦»äº†ï¼Œä»–ä»¬éƒ½æ˜¯ä¸€éƒ¨åˆ†åŒºåŸŸçš„é›†åˆã€‚é€šè¿‡åŒºåŸŸçš„åŠ¨æ€åˆ†é…çš„æ–¹å¼å®ç°é€»è¾‘ä¸Šçš„è¿ç»­ã€‚ 7ï¼‰Humongous G1åƒåœ¾æ”¶é›†å™¨è¿˜å¢åŠ äº†ä¸€ç§æ–°çš„å†…å­˜åŒºåŸŸï¼Œå«åšHumongousï¼Œä¸»è¦å­˜å‚¨å¤§å¯¹è±¡ï¼Œå¦‚æœè¶…è¿‡1.5ä¸ªåŒºåŸŸï¼Œå°±æ”¾åˆ°Hã€‚ è®¾ç½®Hçš„åŸå› ï¼šå¯¹äºå †ä¸­çš„å¤§å¯¹è±¡ï¼Œé»˜è®¤ç›´æ¥ä¼šè¢«åˆ†é…åˆ°è€å¹´ä»£ï¼Œä½†æ˜¯å¦‚æœä»–æ˜¯ä¸€ä¸ªçŸ­æœŸçš„å¤§å¯¹è±¡ï¼Œå°±ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ æˆè´Ÿé¢å½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒG1åˆ’åˆ†äº†ä¸€ä¸ªHåŒºï¼Œä»–ä¸“é—¨ç”¨æ¥å­˜æ”¾å¤§å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªHåŒºè£…ä¸ä¸‹ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œé‚£ä¹ˆG1ä¼šå¯»æ‰¾è¿ç»­çš„HåŒºæ¥å­˜å‚¨ã€‚ä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨Full GCã€‚G1çš„å¤§å¤šæ•°è¡Œä¸ºéƒ½æŠŠHåŒºä½œä¸ºè€å¹´ä»£çš„ä¸€éƒ¨åˆ†æ¥çœ‹å¾…ã€‚ 8ï¼‰å›æ”¶è¿‡ç¨‹ G1 GCçš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªç¯èŠ‚ å¹´è½»ä»£GC è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ æ··åˆå›æ”¶ å¦‚æœéœ€è¦ï¼Œå•çº¿ç¨‹ï¼Œç‹¬å å¼ï¼Œé«˜å¼ºåº¦çš„Full GCè¿˜æ˜¯ç»§ç»­å­˜åœ¨çš„ã€‚ä»–é’ˆå¯¹GCçš„è¯„ä¼°å¤±è´¥æä¾›äº†ä¸€ç§å¤±è´¥ä¿æŠ¤æœºåˆ¶ï¼Œå³å¼ºåŠ›å›æ”¶ã€‚ åº”ç”¨ç¨‹åºåˆ†é…å†…å­˜ï¼Œå½“å¹´è½»ä»£çš„EdenåŒºç”¨å°½æ—¶å¼€å§‹å¹´è½»ä»£å›æ”¶è¿‡ç¨‹ï¼›G1çš„å¹´è½»ä»£æ”¶é›†é˜¶æ®µæ˜¯ä¸€ä¸ªå¹¶è¡Œçš„ç‹¬å å¼æ”¶é›†å™¨ã€‚åœ¨å¹´è½»ä»£å›æ”¶æœŸï¼ŒG1 GCæš‚åœæ‰€æœ‰åº”ç”¨ç¨‹åºçº¿ç¨‹ï¼Œå¯åŠ¨å¤šçº¿ç¨‹æ‰§è¡Œå¹´è½»ä»£å›æ”¶ã€‚ç„¶åä»å¹´è½»ä»£åŒºé—´ç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°SurvivoråŒºé—´æˆ–è€…è€å¹´ä»£åŒºé—´ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸¤ä¸ªåŒºé—´éƒ½ä¼šæ¶‰åŠã€‚ å½“å †å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸€å®šå€¼çš„æ—¶å€™ï¼Œå¼€å§‹è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ã€‚ æ ‡è®°å®Œæˆé©¬ä¸Šå¼€å§‹æ··åˆå›æ”¶è¿‡ç¨‹ã€‚å¯¹äºä¸€ä¸ªæ··åˆå›æ”¶æœŸï¼ŒG1 GCä»è€å¹´åŒºé—´ç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°ç©ºé—²åŒºé—´ï¼Œè¿™äº›ç©ºé—²åŒºé—´ä¹Ÿå°±æˆä¸ºäº†è€å¹´ä»£çš„ä¸€éƒ¨åˆ†ã€‚å’Œå¹´è½»ä»£ä¸åŒï¼Œè€å¹´ä»£çš„G1å›æ”¶å™¨å’Œå…¶ä»–GCä¸åŒï¼ŒG1çš„è€å¹´ä»£å›æ”¶å™¨ä¸éœ€è¦æ•´ä¸ªè€å¹´ä»£è¢«å›æ”¶ï¼Œä¸€æ¬¡åªéœ€è¦æ‰«æ/å›æ”¶ä¸€å°éƒ¨åˆ†è€å¹´ä»£çš„åŒºåŸŸå°±å¯ä»¥äº†ã€‚åŒæ—¶ï¼Œè¿™ä¸ªè€å¹´ä»£çš„åŒºåŸŸæ˜¯å’Œæ–°ç”Ÿä»£ä¸€èµ·è¢«å›æ”¶çš„ã€‚ â‘ è®°å¿†é›†ä¸å†™å±éšœ ä¸€ä¸ªå¯¹è±¡è¢«ä¸åŒåŒºåŸŸå¼•ç”¨çš„é—®é¢˜ ä¸€ä¸ªåŒºåŸŸä¸å¯èƒ½æ˜¯å­¤ç«‹çš„ï¼Œä¸€ä¸ªåŒºåŸŸä¸­çš„å¯¹è±¡å¯èƒ½è¢«å…¶ä»–ä»»æ„åŒºåŸŸä¸­çš„å¯¹è±¡å¼•ç”¨ï¼Œåˆ¤æ–­å¯¹è±¡å­˜æ´»æ—¶ï¼Œæ˜¯å¦éœ€è¦æ‰«ææ•´ä¸ªJavaå †æ‰èƒ½ä¿è¯å‡†ç¡®ï¼Ÿ åœ¨å…¶ä»–çš„åˆ†ä»£æ”¶é›†å™¨ï¼Œä¹Ÿå­˜åœ¨è¿™æ ·çš„é—®é¢˜ å›æ”¶æ–°ç”Ÿä»£ä¹Ÿä¸å¾—ä¸åŒæ—¶æ‰«æè€å¹´ä»£ï¼Ÿ è¿™æ ·çš„è¯ä¼šé™ä½Minor GCçš„æ•ˆç‡ è§£å†³æ–¹æ³• æ— è®ºG1è¿˜æ˜¯å…¶ä»–åƒåœ¾æ”¶é›†å™¨ï¼ŒJvméƒ½æ˜¯ä½¿ç”¨Remembered Set æ¥é¿å…å…¨å±€æ‰«æã€‚ æ¯ä¸ªåŒºåŸŸéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„Remembered Set ï¼› æ¯æ¬¡Referenceç±»å‹æ•°æ®å†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªWrite Barrieræš‚æ—¶ä¸­æ–­æ“ä½œï¼› ç„¶åæ£€æŸ¥å°†è¦å†™å…¥çš„å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å’Œè¯¥Referenceç±»å‹æ•°æ®åœ¨ä¸åŒçš„åŒºåŸŸ å¦‚æœä¸åŒï¼Œé€šè¿‡CardTableæŠŠç›¸å…³å¼•ç”¨ä¿¡æ¯è®°å½•åˆ°å¼•ç”¨æŒ‡å‘å¯¹è±¡çš„æ‰€åœ¨åŒºåŸŸå¯¹åº”çš„Remembered Set ä¸­ï¼› å½“è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œåœ¨GCè·ŸèŠ‚ç‚¹çš„æšä¸¾èŒƒå›´åŠ å…¥Remembered Setï¼›å°±å¯ä»¥ä¿è¯ä¸è¿›è¡Œå…¨å±€æ‰«æï¼Œä¹Ÿä¸ä¼šæœ‰é—æ¼ã€‚ â‘¡å¹´è½»ä»£GC JVMå¯åŠ¨æ—¶ï¼ŒG1å…ˆå‡†å¤‡å¥½EdenåŒºï¼Œç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸æ–­åˆ›å»ºå¯¹è±¡åˆ°EdenåŒºï¼Œå½“Edenç©ºé—´è€—å°½æ—¶ï¼ŒG1ä¼šå¯åŠ¨ä¸€æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚ å¹´è½»ä»£åƒåœ¾å›æ”¶åªä¼šå›æ”¶EdenåŒºå’Œå¹¸å­˜è€…åŒºã€‚ é¦–å…ˆG1åœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼ŒG1åˆ›å»ºå›æ”¶é›†ï¼Œå›æ”¶é›†æ˜¯æŒ‡éœ€è¦è¢«å›æ”¶çš„å†…å­˜åˆ†æ®µçš„é›†åˆï¼Œå¹´è½»ä»£å›æ”¶è¿‡ç¨‹çš„å›æ”¶é›†åŒ…å«å¹´è½»ä»£EdenåŒºå’Œå¹¸å­˜è€…åŒºæ‰€æœ‰çš„å†…å­˜å­—åˆ†æ®µã€‚ç„¶åå¼€å§‹è¿›è¡Œå¦‚ä¸‹å›æ”¶ï¼šæ‰«ææ ¹ æ›´æ–°RSet å¤„ç†RSet å¤åˆ¶å¯¹è±¡ å¤„ç†å¼•ç”¨ ç¬¬ä¸€é˜¶æ®µï¼Œæ‰«ææ ¹ã€‚ æ ¹æ˜¯æŒ‡staticå˜é‡æŒ‡å‘çš„å¯¹è±¡ï¼Œæ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•è°ƒç”¨é“¾æ¡ä¸Šçš„å±€éƒ¨å˜é‡ç­‰ã€‚æ ¹å¼•ç”¨è¿åŒRSetè®°å½•çš„å¤–éƒ¨å¼•ç”¨ä½œä¸ºæ‰«æå­˜æ´»å¯¹è±¡çš„å…¥å£ã€‚ ç¬¬äºŒé˜¶æ®µï¼Œæ›´æ–°RSetã€‚ å¤„ç†dirty card queue( è§å¤‡æ³¨)ä¸­çš„cardï¼Œæ›´æ–°RSetã€‚ æ­¤é˜¶æ®µå®Œæˆåï¼ŒRSetå¯ ä»¥å‡†ç¡®çš„åæ˜ è€å¹´ä»£å¯¹æ‰€åœ¨çš„å†…å­˜åˆ†æ®µä¸­å¯¹è±¡çš„å¼•ç”¨ã€‚ ç¬¬ä¸‰é˜¶æ®µï¼Œå¤„ç†RSet. è¯†åˆ«è¢«è€å¹´ä»£å¯¹è±¡æŒ‡å‘çš„Edenä¸­çš„å¯¹è±¡ï¼Œè¿™äº›è¢«æŒ‡å‘çš„Edenä¸­çš„å¯¹è±¡è¢«è®¤ä¸ºæ˜¯å­˜æ´»çš„å¯¹è±¡ã€‚ç¬¬å››é˜¶æ®µï¼Œå¤åˆ¶å¯¹è±¡ã€‚ æ­¤é˜¶æ®µï¼Œå¯¹è±¡æ ‘è¢«éå†ï¼ŒEdenåŒº å†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°SurvivoråŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µï¼ŒSurvivoråŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡å¦‚æœå¹´é¾„æœªè¾¾é˜ˆå€¼ï¼Œå¹´é¾„ä¼šåŠ 1ï¼Œè¾¾åˆ°é˜€å€¼ä¼šè¢«ä¼šè¢«å¤åˆ¶åˆ° 01dåŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µã€‚å¦‚æœSurvivorç©ºé—´ä¸å¤Ÿï¼ŒEdenç©º é—´çš„éƒ¨åˆ†æ•°æ®ä¼šç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ç©ºé—´ã€‚ ç¬¬äº”é˜¶æ®µï¼Œå¤„ç†å¼•ç”¨ã€‚ å¤„ç†Softï¼ŒWeakï¼ŒPhantom, Final, JNI Weakç­‰å¼•ç”¨ã€‚æœ€ç»ˆEdenç©ºé—´çš„æ•°æ®ä¸ºç©ºï¼ŒGCåœæ­¢å·¥ä½œï¼Œè€Œç›®æ ‡å†…å­˜ä¸­çš„å¯¹è±¡éƒ½æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œæ²¡æœ‰ç¢ç‰‡ï¼Œæ‰€ä»¥å¤åˆ¶è¿‡ç¨‹å¯ä»¥è¾¾åˆ°å†…å­˜æ•´ç†çš„æ•ˆæœï¼Œå‡å°‘ç¢ç‰‡ã€‚ â‘¡å¹¶å‘æ ‡è®°è¿‡ç¨‹ åˆå§‹æ ‡è®°é˜¶æ®µ æ ¹åŒºåŸŸæ‰«æ å¹¶å‘æ ‡è®° å†æ¬¡æ ‡è®° ç‹¬å æ ‡è®° ç‹¬å æ¸…ç† å¹¶å‘æ¸…ç†é˜¶æ®µ 1.åˆå§‹æ ‡è®°é˜¶æ®µ:æ ‡è®°ä»æ ¹èŠ‚ç‚¹ç›´æ¥å¯è¾¾çš„å¯¹è±¡ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯STWçš„ï¼Œå¹¶ä¸”ä¼šè§¦å‘- - æ¬¡å¹´è½»ä»£GCã€‚ 2.æ ¹åŒºåŸŸæ‰«æ(Root Region Scanning) : G1 GCæ‰«æSurvivoråŒºç›´æ¥å¯è¾¾çš„è€å¹´ä»£ï¼Œ åŒºåŸŸå¯¹è±¡ï¼Œå¹¶æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚è¿™ä¸€-è¿‡ç¨‹å¿…é¡»åœ¨young GCä¹‹å‰å®Œæˆã€‚ 3.å¹¶å‘æ ‡è®°(Concurrent Marking): åœ¨æ•´ä¸ªå †ä¸­è¿›è¡Œå¹¶å‘æ ‡è®°(å’Œåº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œ)ï¼Œ æ­¤è¿‡ç¨‹å¯èƒ½è¢«young GCä¸­æ–­ã€‚åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œè‹¥å‘ç°åŒºåŸŸå¯¹è±¡ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯åƒåœ¾,é‚£è¿™ä¸ªåŒºåŸŸä¼šè¢«ç«‹å³å›æ”¶ã€‚åŒæ—¶ï¼Œå¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œä¼šè®¡ç®—æ¯ä¸ªåŒºåŸŸçš„å¯¹è±¡æ´»æ€§(åŒºåŸŸä¸­å­˜æ´»å¯¹è±¡çš„æ¯”ä¾‹)ã€‚ 4.å†æ¬¡æ ‡è®°(Remark):ç”± äºåº”ç”¨ç¨‹åºæŒç»­è¿›è¡Œï¼Œéœ€è¦ä¿®æ­£ä¸Šä¸€- æ¬¡çš„æ ‡è®°ç»“æœã€‚æ˜¯STW çš„ã€‚G1ä¸­é‡‡ç”¨äº†æ¯”CMSæ›´å¿«çš„åˆå§‹å¿«ç…§ç®—æ³•:snapshot-at-the-beginning (SATB)ã€‚ 5.ç‹¬å æ¸…ç†(cleanup,STW):è®¡ç®—å„ä¸ªåŒºåŸŸçš„å­˜æ´»å¯¹è±¡å’ŒGCå›æ”¶æ¯”ä¾‹ï¼Œå¹¶è¿›è¡Œæ’åºï¼Œè¯†åˆ«å¯ä»¥æ··åˆå›æ”¶çš„åŒºåŸŸã€‚ä¸ºä¸‹é˜¶æ®µåšé“ºå«ã€‚æ˜¯STWçš„ã€‚ â¢è¿™ä¸ªé˜¶æ®µå¹¶ä¸ä¼šå®é™…ä¸Šå»åšåƒåœ¾çš„æ”¶é›†ã€‚ 6.å¹¶å‘æ¸…ç†é˜¶æ®µ:è¯†åˆ«å¹¶æ¸…ç†å®Œå…¨ç©ºé—²çš„åŒºåŸŸã€‚ â‘¢æ··åˆå›æ”¶ å½“è¶Šæ¥è¶Šå¤šçš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ï¼Œä¸ºäº†é¿å…å †å†…å­˜è¢«è€—å°½ï¼Œè™šæ‹Ÿæœºä¼šè§¦å‘ä¸€ä¸ªæ··åˆçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå³Mixed GCï¼Œè¯¥ç®—æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªOld GCï¼Œé™¤äº†å›æ”¶æ•´ä¸ªYoung Regionï¼Œè¿˜ä¼šå›æ”¶ä¸€éƒ¨åˆ†çš„Old Regionã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼šæ˜¯ä¸€éƒ¨åˆ†è€å¹´ä»£ï¼Œè€Œä¸æ˜¯å…¨éƒ¨è€å¹´ä»£ã€‚å¯ä»¥é€‰æ‹©å“ªäº›Old Regionè¿›è¡Œæ”¶é›†ã€‚ä»è€Œå¯ä»¥å¯¹åƒåœ¾å›æ”¶çš„è€—æ—¶æ—¶é—´è¿›è¡Œæ§åˆ¶ã€‚ä¹Ÿè¦æ³¨æ„çš„æ˜¯Mixed GCå¹¶ä¸æ˜¯Full GCã€‚ å¹¶å‘æ ‡è®°ç»“æŸä»¥åï¼Œè€å¹´ä»£ä¸­ç™¾åˆ†ç™¾ä¸ºåƒåœ¾çš„å†…å­˜åˆ†æ®µè¢«å›æ”¶äº†ï¼Œéƒ¨åˆ†ä¸ºåƒåœ¾çš„å†…å­˜åˆ†æ®µè¢«è®¡ç®—äº†å‡ºæ¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›è€å¹´ä»£çš„å†…å­˜åˆ†æ®µä¼šåˆ†8æ¬¡(å¯ä»¥é€šè¿‡-XX: G1MixedGCCountTargetè®¾ç½®)è¢«å›æ”¶ã€‚ æ··åˆå›æ”¶çš„å›æ”¶é›†(Collection Set)åŒ…æ‹¬å…«åˆ†ä¹‹- -çš„è€å¹´ä»£å†…å­˜åˆ†æ®µï¼ŒEdenåŒº å†…å­˜ åˆ†æ®µï¼ŒSurvivoråŒº å†…å­˜åˆ†æ®µã€‚æ··åˆå›æ”¶çš„ç®—æ³•å’Œå¹´è½»ä»£å›æ”¶çš„ç®—æ³•å®Œå…¨ä¸€æ ·ï¼Œ åªæ˜¯å›æ”¶é›†å¤šäº†è€å¹´ä»£çš„å†…å­˜åˆ†æ®µã€‚å…·ä½“è¿‡ç¨‹è¯·å‚è€ƒä¸Šé¢çš„å¹´è½»ä»£å›æ”¶è¿‡ç¨‹ã€‚ ç”±äºè€å¹´ä»£ä¸­çš„å†…å­˜åˆ†æ®µé»˜è®¤åˆ†8æ¬¡å›æ”¶ï¼ŒG1ä¼šä¼˜å…ˆå›æ”¶åƒåœ¾å¤šçš„å†…å­˜åˆ†æ®µã€‚åƒåœ¾å å†…å­˜åˆ†æ®µæ¯”ä¾‹è¶Šé«˜çš„ï¼Œè¶Šä¼šè¢«å…ˆå›æ”¶ã€‚å¹¶ä¸”æœ‰ä¸€ä¸ªé˜ˆå€¼ä¼šå†³å®šå†…å­˜åˆ†æ®µæ˜¯å¦è¢«å›æ”¶ï¼Œ-XX:G1MixedGCLiveThresholdPercentï¼Œé»˜è®¤ä¸º65%ï¼Œæ„æ€æ˜¯åƒåœ¾å å†…å­˜åˆ†æ®µæ¯”ä¾‹è¦è¾¾åˆ°65%æ‰ä¼šè¢«å›æ”¶ã€‚å¦‚æœåƒåœ¾å æ¯”å¤ªä½ï¼Œæ„å‘³ç€å­˜æ´»çš„å¯¹è±¡å æ¯”é«˜ï¼Œåœ¨å¤åˆ¶çš„æ—¶å€™ä¼šèŠ±è´¹æ›´å¤šçš„æ—¶é—´ã€‚ æ··åˆå›æ”¶å¹¶ä¸ä¸€å®šè¦è¿›è¡Œ8æ¬¡ã€‚æœ‰ä¸€ä¸ªé˜ˆå€¼-XX:G1HeapWastePercentï¼Œé»˜è®¤å€¼ä¸º10%ï¼Œæ„æ€æ˜¯å…è®¸æ•´ä¸ªå †å†…å­˜ä¸­æœ‰10%çš„ç©ºé—´è¢«æµªè´¹ï¼Œæ„å‘³ç€å¦‚æœå‘ç°å¯ä»¥å›æ”¶çš„åƒåœ¾å å †å†…å­˜çš„æ¯”ä¾‹ä½äº10%ï¼Œåˆ™ä¸å†è¿›è¡Œæ··åˆå›æ”¶ã€‚å› ä¸ºGCä¼šèŠ±è´¹å¾ˆå¤šçš„æ—¶é—´ä½†æ˜¯å›æ”¶åˆ°çš„å†…å­˜å´å¾ˆå°‘ã€‚ â‘£Full GC G1çš„åˆè¡·å°±æ˜¯è¦é¿å…Full GCçš„å‡ºç°ï¼Œä½†æ˜¯å¦‚æœä¸Šè¿°æ–¹å¼ä¸èƒ½æ­£å¸¸å·¥ä½œï¼ŒG1ä¼šåœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼Œä½¿ç”¨å•çº¿ç¨‹çš„å†…å­˜å›æ”¶ç®—æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæ€§èƒ½ä¼šéå¸¸å·®ï¼Œåº”ç”¨ç¨‹åºåœé¡¿æ—¶é—´ä¼šå¾ˆé•¿ã€‚ è¦é¿å…Full GCçš„å‘ç”Ÿï¼Œä¸€æ—¦å‘ç”Ÿéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”ŸFull GCå‘¢ï¼Ÿæ¯”å¦‚å †å†…å­˜å¤ªå°ï¼Œå½“G1åœ¨å¤åˆ¶å­˜æ´»å¯¹è±¡çš„æ—¶å€™æ²¡æœ‰ç©ºçš„å†…å­˜åˆ†æ®µå¯ç”¨ï¼Œåˆ™ä¼šå›é€€åˆ°Full GCï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥é€šè¿‡å¢å¤§å†…å­˜è§£å†³ã€‚ å¯¼è‡´G1Full GCçš„åŸå› å¯èƒ½æœ‰ä¸¤ä¸ª Evacuationçš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„to-spaceæ¥å­˜æ”¾æ™‹å‡çš„å¯¹è±¡ å¹¶å‘å¤„ç†è¿‡ç¨‹å®Œæˆä¹‹å‰ç©ºé—´è€—å°½ â‘¤G1å›æ”¶å™¨ä¼˜åŒ–å»ºè®® å¹´è½»ä»£å¤§å° é¿å…ä½¿ç”¨-Xmnæˆ–è€…-XX:NewRatioç­‰ç›¸å…³é€‰é¡¹æ˜¾å¼è®¾ç½®å¹´è½»ä»£çš„å¤§å° å›ºå®šå¹´è½»ä»£çš„å¤§å°ä¼šè¦†ç›–æš‚åœæ—¶é—´ç›®æ ‡ æš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªè¿‡ä¸¥è‹› G1 GCçš„ååé‡ç›®æ ‡æ˜¯90%çš„åº”ç”¨ç¨‹åºæ—¶é—´å’Œ10%çš„åƒåœ¾å›æ”¶æ—¶é—´ è¯„ä¼°G1 GCçš„ååé‡æ—¶ï¼Œæš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªä¸¥è‹›ã€‚ç›®æ ‡å¤ªä¸¥è‹›è¡¨ç¤ºä½ æ„¿æ„æ‰¿å—æ›´å¤šçš„åƒåœ¾å›æ”¶å¼€é”€ï¼Œè€Œè¿™äº›ä¼šç›´æ¥å½±å“åˆ°ååé‡ã€‚ 69.åƒåœ¾å›æ”¶å™¨æ€»ç»“1ï¼‰å¯¹æ¯” åƒåœ¾æ”¶é›†å™¨ åˆ†ç±» ä½œç”¨ä½ç½® ä½¿ç”¨ç®—æ³• ç‰¹ç‚¹ é€‚ç”¨åœºæ™¯ Serial ä¸²è¡Œ æ–°ç”Ÿä»£ å¤åˆ¶ç®—æ³• å“åº”é€Ÿåº¦ä¼˜å…ˆ å•CPUçš„clientæ¨¡å¼ ParNew å¹¶è¡Œ æ–°ç”Ÿä»£ å¤åˆ¶ç®—æ³• å“åº”é€Ÿåº¦ä¼˜å…ˆ å¤šCPUçš„serveræ¨¡å¼ä¸CMSé…åˆä½¿ç”¨ Parallel å¹¶è¡Œ æ–°ç”Ÿä»£ å¤åˆ¶ç®—æ³• ååé‡ä¼˜å…ˆ åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„åœºæ™¯ Serial Old ä¸²è¡Œ è€å¹´ä»£ æ ‡è®°å‹ç¼© å“åº”é€Ÿåº¦ä¼˜å…ˆ å•CPUçš„clientæ¨¡å¼ Parallel Old å¹¶è¡Œ è€å¹´ä»£ æ ‡è®°å‹ç¼© ååé‡ä¼˜å…ˆ åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„åœºæ™¯ CMS å¹¶å‘ è€å¹´ä»£ æ ‡è®°æ¸…é™¤ å“åº”é€Ÿåº¦ä¼˜å…ˆ äº’è”ç½‘/BSä¸šåŠ¡ G1 å¹¶å‘ï¼Œå¹¶è¡Œ æ–°ç”Ÿä»£ï¼Œè€å¹´ä»£ æ ‡è®°å‹ç¼©ï¼Œå¤åˆ¶ å“åº”é€Ÿåº¦ä¼˜å…ˆ æœåŠ¡ç«¯åº”ç”¨ GCå‘å±•é˜¶æ®µ Serial =&gt; Parallel(å¹¶è¡Œ) =&gt;CMS(å¹¶å‘)=&gt;G1=&gt;ZGC 2ï¼‰åƒåœ¾å›æ”¶å™¨çš„ç»„åˆ 3ï¼‰æ€ä¹ˆé€‰æ‹©åƒåœ¾å›æ”¶å™¨ï¼Ÿ 1.ä¼˜å…ˆè°ƒæ•´å †çš„å¤§å°è®©JVMè‡ªé€‚åº”å®Œæˆ 2.å¦‚æœå†…å­˜å°äº100Mï¼Œä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ 3.å¦‚æœæ˜¯å•æ ¸ï¼Œå•æœºç¨‹åºï¼Œå¹¶ä¸”æ²¡æœ‰åœé¡¿æ—¶é—´çš„è¦æ±‚ï¼Œä¸²è¡Œæ”¶é›†å™¨ 4.å¦‚æœæ˜¯å¤šCPUï¼Œéœ€è¦é«˜ååé‡ï¼Œå…è®¸åœé¡¿æ—¶é—´è¶…è¿‡1sï¼Œé€‰æ‹©å¹¶è¡Œæˆ–è€…JVMè‡ªå·±é€‰æ‹© 5.å¦‚æœæ˜¯å¤šCPUï¼Œè¿½æ±‚ä½åœé¡¿æ—¶é—´ï¼Œéœ€å¿«é€Ÿå“åº”ï¼Œä½¿ç”¨å¹¶å‘æ”¶é›†å™¨ å®˜æ–¹æ¨èG1ï¼Œæ€§èƒ½é«˜ã€‚ç°åœ¨äº’è”ç½‘çš„é¡¹ç›®ï¼ŒåŸºæœ¬éƒ½æ˜¯ä½¿ç”¨G1. æ²¡æœ‰æœ€å¥½çš„æ”¶é›†å™¨ï¼Œè°ƒä¼˜æ˜¯é’ˆå¯¹ç‰¹å®šåœºæ™¯ï¼Œç‰¹å®šéœ€æ±‚ã€‚ 70.CMSè¿è¡Œè¿‡ç¨‹ï¼Œç¼ºç‚¹ï¼Ÿæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ åˆå§‹æ ‡è®°(STW)ï¼š æš‚åœæ‰€æœ‰çš„å…¶ä»–çº¿ç¨‹(STW)ï¼Œå¹¶è®°å½•ä¸‹gc rootsç›´æ¥èƒ½å¼•ç”¨çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿« å¹¶å‘æ ‡è®°ï¼š å¹¶å‘æ ‡è®°é˜¶æ®µå°±æ˜¯ä»GC Rootsçš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼Œ è¿™ä¸ªè¿‡ç¨‹è€—æ—¶è¾ƒé•¿ä½†æ˜¯ä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œå› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œï¼Œå¯èƒ½ä¼šæœ‰å¯¼è‡´å·²ç»æ ‡è®°è¿‡çš„å¯¹è±¡çŠ¶æ€å‘ç”Ÿæ”¹å˜ã€‚ é‡æ–°æ ‡è®°(STW)ï¼š é‡æ–°æ ‡è®°é˜¶æ®µå°±æ˜¯ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´ä¸€èˆ¬ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µçš„æ—¶é—´ç¨é•¿ï¼Œè¿œè¿œæ¯”å¹¶å‘æ ‡è®°é˜¶æ®µæ—¶é—´çŸ­ã€‚ å¹¶å‘æ¸…ç†ï¼š å¼€å¯ç”¨æˆ·çº¿ç¨‹ï¼ŒåŒæ—¶GCçº¿ç¨‹å¼€å§‹å¯¹æœªæ ‡è®°çš„åŒºåŸŸåšæ¸…æ‰«ã€‚ å¹¶å‘é‡ç½®ï¼šé‡ç½®æœ¬æ¬¡GCè¿‡ç¨‹ä¸­çš„æ ‡è®°æ•°æ®ã€‚ ç¼ºç‚¹ï¼š å¯¹CPUèµ„æºæ•æ„Ÿï¼ˆä¼šå’ŒæœåŠ¡æŠ¢èµ„æºï¼‰ æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾(åœ¨å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…ç†é˜¶æ®µåˆäº§ç”Ÿåƒåœ¾ï¼Œè¿™ç§æµ®åŠ¨åƒåœ¾åªèƒ½ç­‰åˆ°ä¸‹ä¸€æ¬¡gcå†æ¸…ç†äº†)ï¼› å®ƒä½¿ç”¨çš„å›æ”¶ç®—æ³•-â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¼šå¯¼è‡´æ”¶é›†ç»“æŸæ—¶ä¼šæœ‰å¤§é‡ç©ºé—´ç¢ç‰‡äº§ç”Ÿï¼Œå½“ç„¶é€šè¿‡å‚æ•°-XX:+UseCMSCompactAtFullCollectionå¯ä»¥è®©jvmåœ¨æ‰§è¡Œå®Œæ ‡è®°æ¸…é™¤åå†åšæ•´ç† å¹¶å‘æ¨¡å¼å¤±è´¥(æœ€å¤§é—®é¢˜)ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸ç¡®å®šæ€§ï¼Œä¼šå­˜åœ¨ä¸Šä¸€æ¬¡åƒåœ¾å›æ”¶è¿˜æ²¡æ‰§è¡Œå®Œï¼Œç„¶ååƒåœ¾å›æ”¶åˆè¢«è§¦å‘çš„æƒ…å†µï¼Œç‰¹åˆ«æ˜¯åœ¨å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…ç†é˜¶æ®µä¼šå‡ºç°ï¼Œä¸€è¾¹å›æ”¶ï¼Œç³»ç»Ÿä¸€è¾¹è¿è¡Œï¼Œä¹Ÿè®¸æ²¡å›æ”¶å®Œå°±å†æ¬¡è§¦å‘full gcï¼Œä¹Ÿå°±æ˜¯â€concurrent mode failureâ€ï¼Œæ­¤æ—¶ä¼šè¿›å…¥stop the worldï¼Œç”¨serial oldåƒåœ¾æ”¶é›†å™¨æ¥å›æ”¶ 71.G1è¿è¡Œè¿‡ç¨‹G1æ”¶é›†å™¨ä¸€æ¬¡GCçš„è¿ä½œè¿‡ç¨‹å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š åˆå§‹æ ‡è®°ï¼ˆinitial markï¼ŒSTWï¼‰ï¼šæš‚åœæ‰€æœ‰çš„å…¶ä»–çº¿ç¨‹ï¼Œå¹¶è®°å½•ä¸‹gc rootsç›´æ¥èƒ½å¼•ç”¨çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿« ï¼› å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰ï¼šåŒCMSçš„å¹¶å‘æ ‡è®° æœ€ç»ˆæ ‡è®°ï¼ˆRemarkï¼ŒSTWï¼‰ï¼šåŒCMSçš„é‡æ–°æ ‡è®° ç­›é€‰å›æ”¶ï¼ˆCleanupï¼ŒSTWï¼‰ï¼šG1é‡‡ç”¨å¤åˆ¶ç®—æ³•å›æ”¶å‡ ä¹ä¸ä¼šæœ‰å¤ªå¤šå†…å­˜ç¢ç‰‡ 72.G1é€‚åˆä»€ä¹ˆåœºæ™¯ 50%ä»¥ä¸Šçš„å †è¢«å­˜æ´»å¯¹è±¡å ç”¨ å¯¹è±¡åˆ†é…å’Œæ™‹å‡çš„é€Ÿåº¦å˜åŒ–éå¸¸å¤§ åƒåœ¾å›æ”¶æ—¶é—´ç‰¹åˆ«é•¿ï¼Œè¶…è¿‡1ç§’ 8GBä»¥ä¸Šçš„å †å†…å­˜(å»ºè®®å€¼) åœé¡¿æ—¶é—´æ˜¯500msä»¥å†… 73.ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘Full GCï¼Ÿå¯¹äº Minor GCï¼Œå…¶è§¦å‘æ¡ä»¶éå¸¸ç®€å•ï¼Œå½“ Eden ç©ºé—´æ»¡æ—¶ï¼Œå°±å°†è§¦å‘ä¸€æ¬¡ Minor GCã€‚è€Œ Full GC åˆ™ç›¸å¯¹å¤æ‚ï¼Œæœ‰ä»¥ä¸‹æ¡ä»¶: è°ƒç”¨ System.gc() åªæ˜¯å»ºè®®è™šæ‹Ÿæœºæ‰§è¡Œ Full GCï¼Œä½†æ˜¯è™šæ‹Ÿæœºä¸ä¸€å®šçœŸæ­£å»æ‰§è¡Œã€‚ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯è®©è™šæ‹Ÿæœºç®¡ç†å†…å­˜ã€‚ è€å¹´ä»£ç©ºé—´ä¸è¶³ è€å¹´ä»£ç©ºé—´ä¸è¶³çš„å¸¸è§åœºæ™¯ä¸ºå‰æ–‡æ‰€è®²çš„å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ã€é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ç­‰ã€‚ ä¸ºäº†é¿å…ä»¥ä¸ŠåŸå› å¼•èµ·çš„ Full GCï¼Œåº”å½“å°½é‡ä¸è¦åˆ›å»ºè¿‡å¤§çš„å¯¹è±¡ä»¥åŠæ•°ç»„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¯ä»¥é€šè¿‡ -Xmn è™šæ‹Ÿæœºå‚æ•°è°ƒå¤§æ–°ç”Ÿä»£çš„å¤§å°ï¼Œè®©å¯¹è±¡å°½é‡åœ¨æ–°ç”Ÿä»£è¢«å›æ”¶æ‰ï¼Œä¸è¿›å…¥è€å¹´ä»£ã€‚è¿˜å¯ä»¥é€šè¿‡ -XX:MaxTenuringThreshold è°ƒå¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£çš„å¹´é¾„ï¼Œè®©å¯¹è±¡åœ¨æ–°ç”Ÿä»£å¤šå­˜æ´»ä¸€æ®µæ—¶é—´ã€‚ ç©ºé—´åˆ†é…æ‹…ä¿å¤±è´¥ ä½¿ç”¨å¤åˆ¶ç®—æ³•çš„ Minor GC éœ€è¦è€å¹´ä»£çš„å†…å­˜ç©ºé—´ä½œæ‹…ä¿ï¼Œå¦‚æœæ‹…ä¿å¤±è´¥ä¼šæ‰§è¡Œä¸€æ¬¡ Full GCã€‚ JDK 1.7 åŠä»¥å‰çš„æ°¸ä¹…ä»£ç©ºé—´ä¸è¶³ åœ¨ JDK 1.7 åŠä»¥å‰ï¼ŒHotSpot è™šæ‹Ÿæœºä¸­çš„æ–¹æ³•åŒºæ˜¯ç”¨æ°¸ä¹…ä»£å®ç°çš„ï¼Œæ°¸ä¹…ä»£ä¸­å­˜æ”¾çš„ä¸ºä¸€äº› Class çš„ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ç­‰æ•°æ®ã€‚ å½“ç³»ç»Ÿä¸­è¦åŠ è½½çš„ç±»ã€åå°„çš„ç±»å’Œè°ƒç”¨çš„æ–¹æ³•è¾ƒå¤šæ—¶ï¼Œæ°¸ä¹…ä»£å¯èƒ½ä¼šè¢«å æ»¡ï¼Œåœ¨æœªé…ç½®ä¸ºé‡‡ç”¨ CMS GC çš„æƒ…å†µä¸‹ä¹Ÿä¼šæ‰§è¡Œ Full GCã€‚å¦‚æœç»è¿‡ Full GC ä»ç„¶å›æ”¶ä¸äº†ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºä¼šæŠ›å‡º java.lang.OutOfMemoryErrorã€‚ ä¸ºé¿å…ä»¥ä¸ŠåŸå› å¼•èµ·çš„ Full GCï¼Œå¯é‡‡ç”¨çš„æ–¹æ³•ä¸ºå¢å¤§æ°¸ä¹…ä»£ç©ºé—´æˆ–è½¬ä¸ºä½¿ç”¨ CMS GCã€‚ Concurrent Mode Failure æ‰§è¡Œ CMS GC çš„è¿‡ç¨‹ä¸­åŒæ—¶æœ‰å¯¹è±¡è¦æ”¾å…¥è€å¹´ä»£ï¼Œè€Œæ­¤æ—¶è€å¹´ä»£ç©ºé—´ä¸è¶³(å¯èƒ½æ˜¯ GC è¿‡ç¨‹ä¸­æµ®åŠ¨åƒåœ¾è¿‡å¤šå¯¼è‡´æš‚æ—¶æ€§çš„ç©ºé—´ä¸è¶³)ï¼Œä¾¿ä¼šæŠ¥ Concurrent Mode Failure é”™è¯¯ï¼Œå¹¶è§¦å‘ Full GCã€‚ 74.å†…å­˜æº¢å‡ºä¸å†…å­˜æ³„æ¼1ï¼‰å†…å­˜æº¢å‡º å†…å­˜æº¢å‡ºæ˜¯ç›¸å¯¹äºå†…å­˜æ³„æ¼æ¥è¯´çš„ï¼Œå°½ç®¡æ›´å®¹æ˜“è¢«ç†è§£ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œå†…å­˜æº¢å‡ºä¹Ÿæ˜¯å¼•å‘ç¨‹åºå´©æºƒçš„ç½ªé­ç¥¸é¦–ä¹‹ä¸€ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒGCä¼šè¿›è¡Œå„ç§å¹´é¾„æ®µçš„åƒåœ¾å›æ”¶å®åœ¨ä¸è¡Œäº†å°±æ”¾å¤§æ‹›ï¼Œæ¥ä¸€æ¬¡Full GCæ“ä½œï¼Œè¿™æ—¶å€™ä¼šå›æ”¶å¤§é‡å†…å­˜ï¼Œä¾›åº”ç”¨ç¨‹åºç»§ç»­ä½¿ç”¨ã€‚javadocå¯¹OOMçš„è§£é‡Šæ˜¯ï¼šæ²¡æœ‰ç©ºé—²å†…å­˜ï¼Œå¹¶ä¸”åƒåœ¾æ”¶é›†å™¨ä¹Ÿæ— æ³•æä¾›æ›´å¤šå†…å­˜ã€‚ å †å†…å­˜ä¸å¤Ÿçš„åŸå› æœ‰ä¸¤ä¸ªï¼šjavaè™šæ‹Ÿæœºçš„å †å†…å­˜è®¾ç½®ä¸å¤Ÿã€‚ä»£ç ä¸­åˆ›å»ºäº†å¤§é‡çš„å¤§å¯¹è±¡ï¼Œå¹¶ä¸”é•¿æ—¶é—´ä¸èƒ½è¢«åƒåœ¾æ”¶é›†å™¨æ”¶é›†ï¼ˆå­˜åœ¨è¢«å¼•ç”¨ï¼‰ OOMä¹‹å‰ï¼Œé€šå¸¸åƒåœ¾æ”¶é›†å™¨ä¼šå…ˆè¿›è¡ŒGCï¼Œå½“ç„¶ä¹Ÿä¸æ˜¯ä»»ä½•æƒ…å†µä¸‹åƒåœ¾æ”¶é›†å™¨éƒ½ä¼šè¢«è§¦å‘ï¼šæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè¶…è¿‡å †ç©ºé—´å¤§å°çš„å¯¹è±¡ã€‚ 2ï¼‰å†…å­˜æ³„æ¼ åªæœ‰å¯¹è±¡ä¸åœ¨è¢«ç¨‹åºç”¨åˆ°äº†ï¼Œä½†æ˜¯GCåˆä¸èƒ½å›æ”¶ä»–ä»¬çš„æƒ…å†µï¼Œæ‰å«å†…å­˜æ³„æ¼ã€‚å®é™…ä¸Šä¸€äº›å¯¼è‡´å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå˜å¾—å¾ˆé•¿ç”šè‡³OOMçš„æ“ä½œï¼Œä¹Ÿç§°ä¸ºå†…å­˜æ³„æ¼ã€‚ å°½ç®¡å†…å­˜æ³„æ¼å¹¶ä¸ä¼šç«‹åˆ»å¼•èµ·ç¨‹åºå´©æºƒï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œç¨‹åºä¸­çš„å¯ç”¨å†…å­˜å°±ä¼šè¢«é€æ­¥èš•é£Ÿï¼Œç›´è‡³è€—å°½æ‰€æœ‰å†…å­˜ï¼Œæœ€ç»ˆå‡ºç°OOMï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚ è¿™é‡Œçš„å­˜å‚¨ç©ºé—´å¹¶ä¸æ˜¯æŒ‡ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯æŒ‡è™šæ‹Ÿå†…å­˜å¤§å°ï¼Œè¿™ä¸ªè™šæ‹Ÿå†…å­˜å–å†³äºç£ç›˜äº¤æ¢åŒºè®¾å®šçš„å¤§å°ã€‚ Exampleï¼š 1.å•ä¾‹æ¨¡å¼ï¼Œå•ä¾‹çš„ç”Ÿå‘½å‘¨æœŸé»˜è®¤å’Œåº”ç”¨ç¨‹åºä¸€æ ·é•¿ï¼Œæ‰€ä»¥å•ä¾‹ç¨‹åºä¸­ï¼Œå¦‚æœæŒæœ‰å¯¹å¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤–éƒ¨å¯¹è±¡æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼çš„äº§ç”Ÿã€‚ 2.ä¸€äº›æä¾›closeçš„èµ„æºæœªå…³é—­å¯¼è‡´å†…å­˜æ³„æ¼ï¼ˆæ•°æ®åº“è¿æ¥ï¼Œç½‘ç»œè¿æ¥ï¼Œioè¿æ¥ï¼‰ 75.Stop The WorldæŒ‡çš„æ˜¯GCäº‹ä»¶å‘ç”Ÿè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿåº”ç”¨ç¨‹åºçš„åœé¡¿ã€‚åœé¡¿äº§ç”Ÿæ—¶æ•´ä¸ªåº”ç”¨ç¨‹åºçº¿ç¨‹éƒ½ä¼šè¢«åœæ‰ï¼Œæ²¡æœ‰ä»»ä½•å“åº”ã€‚ STWäº‹ä»¶å’Œé‡‡ç”¨å“ªæ¬¾åƒåœ¾æ”¶é›†å™¨æ— å…³ï¼Œæ‰€æœ‰GCéƒ½æœ‰è¿™ä¸ªäº‹ä»¶ã€‚å®ƒæ˜¯ç”±JVMåœ¨åå°è‡ªåŠ¨å‘èµ·å’Œè‡ªåŠ¨å®Œæˆçš„ã€‚ 76.å®‰å…¨ç‚¹ä¸å®‰å…¨åŒºåŸŸ1ï¼‰å®‰å…¨ç‚¹ ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å¹¶ä¸æ˜¯åœ¨æ‰€æœ‰åœ°æ–¹éƒ½èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œåªæœ‰åœ¨ç‰¹å®šçš„ä½ç½®æ‰èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œè¿™äº›ä½ç½®ç§°ä¸ºå®‰å…¨ç‚¹ã€‚ å®‰å…¨ç‚¹å¤ªå°‘å¯èƒ½å¯¼è‡´GCç­‰å¾…æ—¶é—´å¤ªé•¿ï¼Œå¤ªå¤šå¯èƒ½å¯¼è‡´ç¨‹åºè¿è¡Œæ—¶çš„æ€§èƒ½é—®é¢˜ã€‚ æ–¹æ³•è°ƒç”¨ï¼Œå¾ªç¯è·³è½¬ï¼Œå¼‚å¸¸è·³è½¬ã€‚ å¦‚ä½•åœ¨GCå‘ç”Ÿæ—¶ï¼Œæ£€æŸ¥æ‰€æœ‰çº¿ç¨‹éƒ½è·‘åˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹åœä¸‹æ¥å‘¢ï¼Ÿ æŠ¢å…ˆå¼ä¸­æ–­ï¼ˆç›®å‰æ²¡æœ‰è™šæ‹Ÿæœºé‡‡ç”¨äº†ï¼‰ä¸­æ–­æ‰€æœ‰çº¿ç¨‹ï¼Œå“ªä¸ªæ²¡åˆ°å®‰å…¨ç‚¹å°±æ¢å¤çº¿ç¨‹ï¼Œè®©çº¿ç¨‹è·‘åˆ°å®‰å…¨ç‚¹ã€‚ ä¸»åŠ¨å¼ä¸­æ–­è®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—ï¼Œå„ä¸ªçº¿ç¨‹è¿è¡Œåˆ°å®‰å…¨ç‚¹çš„æ—¶å€™ä¸»åŠ¨è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œå¦‚æœä¸­æ–­æ ‡å¿—ä¸ºçœŸï¼Œåˆ™å°†è‡ªå·±è¿›è¡Œä¸­æ–­æŒ‚èµ·ã€‚ 2ï¼‰å®‰å…¨åŒºåŸŸ å®‰å…¨ç‚¹æœºåˆ¶ä¿è¯äº†ç¨‹åºæ‰§è¡Œæ—¶ï¼Œåœ¨ä¸å¤ªé•¿çš„æ—¶é—´å†…å°±ä¼šé‡åˆ°å¯è¿›å…¥çš„GCå®‰å…¨ç‚¹ï¼Œä½†æ˜¯å‡å¦‚ç¨‹åºå¤„äºsleepçŠ¶æ€ï¼Œè¿™æ—¶å€™çº¿ç¨‹æ— æ³•å“åº”jvmçš„ä¸­æ–­è¯·æ±‚ï¼Œèµ°åˆ°å®‰å…¨ç‚¹å»ä¸­æ–­æŒ‚èµ·ï¼Œjvmä¹Ÿä¸å¤ªå¯èƒ½çš„ç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå°±éœ€è¦å®‰å…¨åŒºåŸŸæ¥è§£å†³ã€‚ å®‰å…¨åŒºåŸŸæ˜¯æŒ‡åœ¨ä¸€æ®µä»£ç ç‰‡æ®µä¸­ï¼Œå¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»ä½•ä½ç½®å¼€å§‹GCéƒ½æ˜¯å®‰å…¨çš„ å®é™…æ‰§è¡Œæ—¶ å½“çº¿ç¨‹è¿è¡Œåˆ°å®‰å…¨åŒºåŸŸçš„ä»£ç æ—¶ï¼Œé¦–å…ˆæ ‡è¯†å·²ç»è¿›å…¥äº†å®‰å…¨åŒºåŸŸï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…å‘ç”ŸGCï¼ŒJVMä¼šå¿½ç•¥æ ‡è¯†ä¸ºå®‰å…¨åŒºåŸŸçŠ¶æ€çš„çº¿ç¨‹ã€‚ å½“çº¿ç¨‹å³å°†ç¦»å¼€å®‰å…¨åŒºåŸŸæ—¶ï¼Œä¼šæ£€æŸ¥jvmæ˜¯å¦å·²ç»å®ŒæˆGCï¼Œå¦‚æœå®Œæˆäº†ï¼Œåˆ™ç»§ç»­è¿è¡Œï¼Œå¦åˆ™çº¿ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°æ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€å®‰å…¨åŒºåŸŸçš„ä¿¡å·ä¸ºæ­¢ã€‚ 77.å†è°ˆå†…å­˜æ³„æ¼1ï¼‰å†…å­˜æ³„éœ²çš„ç†è§£ä¸åˆ†æ å¯è¾¾æ€§åˆ†æç®—æ³•æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œæœ¬è´¨éƒ½æ˜¯åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦è¿˜è¢«å¼•ç”¨ã€‚é‚£ä¹ˆå¯¹äºè¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºä»£ç çš„å®ç°ä¸åŒå°±ä¼šå‡ºç°å¾ˆå¤šç§å†…å­˜æ³„æ¼é—®é¢˜(è®©JVMè¯¯ä»¥ä¸ºæ­¤å¯¹è±¡è¿˜åœ¨å¼•ç”¨ä¸­ï¼Œæ— æ³•å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼)ã€‚ æ˜¯å¦è¿˜è¢«ä½¿ç”¨? æ˜¯ æ˜¯å¦è¿˜è¢«éœ€è¦? å¦ å†…å­˜æ³„æ¼(memory leak) çš„ç†è§£ ä¸¥æ ¼æ¥è¯´ï¼Œåªæœ‰å¯¹è±¡ä¸ä¼šå†è¢«ç¨‹åºç”¨åˆ°äº†ï¼Œä½†æ˜¯GCåˆä¸èƒ½å›æ”¶ä»–ä»¬çš„æƒ…å†µï¼Œæ‰å«å†…å­˜æ³„æ¼ã€‚ ä½†å®é™…æƒ…å†µå¾ˆå¤šæ—¶å€™ä¸€äº›ä¸å¤ªå¥½çš„å®è·µ(æˆ–ç–å¿½)ä¼šå¯¼è‡´å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå˜å¾—å¾ˆé•¿ç”šè‡³å¯¼è‡´0OMï¼Œä¹Ÿå¯ä»¥å«åšå®½æ³›æ„ä¹‰ä¸Šçš„â€œå†…å­˜æ³„æ¼â€ã€‚ å¯¹è±¡Xå¼•ç”¨å¯¹è±¡Y,Xçš„ç”Ÿå‘½å‘¨æœŸæ¯”Yçš„ç”Ÿå‘½å‘¨æœŸé•¿; é‚£ä¹ˆå½“Yç”Ÿå‘½å‘¨æœŸç»“æŸçš„æ—¶å€™ï¼ŒXä¾ç„¶å¼•ç”¨ç€Yï¼Œè¿™æ—¶å€™ï¼Œåƒåœ¾å›æ”¶æœŸæ˜¯ä¸ä¼šå›æ”¶å¯¹è±¡Yçš„; å¦‚æœå¯¹è±¡Xè¿˜å¼•ç”¨ç€ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒçŸ­çš„Aã€Bã€C,å¯¹è±¡Aåˆå¼•ç”¨ç€å¯¹è±¡aã€bã€cï¼Œè¿™æ ·å°±å¯èƒ½é€ æˆå¤§é‡æ— ç”¨çš„å¯¹è±¡ä¸èƒ½è¢«å›æ”¶ï¼Œè¿›è€Œå æ®äº†å†…å­˜èµ„æºï¼Œé€ æˆå†…å­˜æ³„æ¼ï¼Œç›´åˆ°å†…å­˜æº¢å‡ºã€‚ å†…å­˜æ³„æ¼ä¸å†…å­˜æº¢å‡ºçš„å…³ç³»: 11.å†…å­˜æ³„æ¼(memory leak ) ç”³è¯·äº†å†…å­˜ç”¨å®Œäº†ä¸é‡Šæ”¾ï¼Œæ¯”å¦‚ä¸€å…±æœ‰1024Mçš„å†…å­˜ï¼Œåˆ†é…äº†512M çš„å†…å­˜ä¸€-ç›´ä¸å›æ”¶ï¼Œé‚£ä¹ˆå¯ä»¥ ç”¨çš„å†…å­˜åªæœ‰512M äº†ï¼Œä»¿ä½›æ³„éœ²æ‰äº†ä¸€éƒ¨åˆ†; é€šä¿—ä¸€ç‚¹è®²çš„è¯ï¼Œå†…å­˜æ³„æ¼å°±æ˜¯[å ç€èŒ…å‘ä¸æ‹‰shi]ã€‚ 12.å†…å­˜æº¢å‡º(out of memory ) ç”³è¯·å†…å­˜æ—¶ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ä»¥ä½¿ç”¨; é€šä¿—ä¸€ç‚¹å„¿è®²ï¼Œ-ä¸€ä¸ªå•æ‰€å°±ä¸‰ä¸ªå‘ï¼Œæœ‰ä¸¤ä¸ªç«™ç€èŒ…å‘ä¸èµ°çš„(å†…å­˜æ³„æ¼)ï¼Œå‰©ä¸‹æœ€åä¸€ä¸ªå‘ï¼Œå•æ‰€è¡¨ç¤ºæ¥å¾…å‹åŠ›å¾ˆå¤§ï¼Œè¿™æ—¶å€™ä¸€ä¸‹å­æ¥äº†ä¸¤ä¸ªäººï¼Œå‘ä½(å†…å­˜)å°±ä¸å¤Ÿäº†ï¼Œå†…å­˜æ³„æ¼å˜æˆå†…å­˜æº¢å‡ºäº†ã€‚ å¯è§ï¼Œå†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºçš„å…³ç³»:å†…å­˜æ³„æ¼çš„å¢å¤šï¼Œæœ€ç»ˆä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚ 1æ³„æ¼çš„åˆ†ç±» ç»å¸¸å‘ç”Ÿ:å‘ç”Ÿå†…å­˜æ³„éœ²çš„ä»£ç ä¼šè¢«å¤šæ¬¡æ‰§è¡Œï¼Œæ¯æ¬¡æ‰§è¡Œï¼Œæ³„éœ²ä¸€å—å†…å­˜; å¶ç„¶å‘ç”Ÿ:åœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹æ‰ä¼šå‘ç”Ÿ ä¸€æ¬¡æ€§:å‘ç”Ÿå†…å­˜æ³„éœ²çš„æ–¹æ³•åªä¼šæ‰§è¡Œä¸€æ¬¡; éšå¼æ³„æ¼:ä¸€ ç›´å ç€å†…å­˜ä¸é‡Šæ”¾ï¼Œç›´åˆ°æ‰§è¡Œç»“æŸ;ä¸¥æ ¼çš„è¯´è¿™ä¸ªä¸ç®—å†…å­˜æ³„æ¼ï¼Œå› ä¸ºæœ€ç»ˆé‡Šæ”¾æ‰äº†ï¼Œä½†æ˜¯å¦‚æœæ‰§è¡Œæ—¶é—´ç‰¹åˆ«é•¿ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´å†…å­˜è€—å°½ã€‚ 2ï¼‰Javaä¸­å†…å­˜æ³„éœ²çš„8ç§æƒ…å†µ 11-é™æ€é›†åˆç±» é™æ€é›†åˆç±»ï¼Œå¦‚HashMapã€ LinkedListç­‰ç­‰ã€‚ å¦‚æœè¿™äº›å®¹å™¨ä¸ºé™æ€çš„ï¼Œé‚£ä¹ˆå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸä¸JVMç¨‹åºä¸€è‡´ï¼Œåˆ™å®¹å™¨ä¸­çš„å¯¹è±¡åœ¨ç¨‹åºç»“æŸä¹‹å‰å°†ä¸èƒ½è¢«é‡Šæ”¾ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ã€‚ç®€å•è€Œè¨€ï¼Œé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„å¼•ç”¨ï¼Œå°½ç®¡çŸ­ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ä¸å†ä½¿ç”¨ï¼Œä½†æ˜¯å› ä¸ºé•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡æŒæœ‰å®ƒçš„å¼•ç”¨è€Œå¯¼è‡´ä¸èƒ½è¢«å›æ”¶ã€‚ 12-å•ä¾‹æ¨¡å¼ å•ä¾‹æ¨¡å¼ï¼Œå’Œé™æ€é›†åˆå¯¼è‡´å†…å­˜æ³„éœ²çš„åŸå› ç±»ä¼¼ï¼Œå› ä¸ºå•ä¾‹çš„é™æ€ç‰¹æ€§ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå’ŒJVMçš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·é•¿ï¼Œæ‰€ä»¥å¦‚æœå•ä¾‹å¯¹è±¡å¦‚æœæŒæœ‰å¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤–éƒ¨å¯¹è±¡ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ 13-å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±» å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»ï¼Œå¦‚æœä¸€ä¸ªå¤–éƒ¨ç±»çš„å®ä¾‹å¯¹è±¡çš„æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå†…éƒ¨ç±»çš„å®ä¾‹å¯¹è±¡ã€‚ è¿™ä¸ªå†…éƒ¨ç±»å¯¹è±¡è¢«é•¿æœŸå¼•ç”¨äº†ï¼Œå³ä½¿é‚£ä¸ªå¤–éƒ¨ç±»å®ä¾‹å¯¹è±¡ä¸å†è¢«ä½¿ç”¨ï¼Œä½†ç”±äºå†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªå¤–éƒ¨ç±»å¯¹è±¡å°†ä¸ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œè¿™ä¹Ÿä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ 14-å„ç§è¿æ¥ï¼Œå¦‚æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥å’ŒIOè¿æ¥ç­‰ å„ç§è¿æ¥ï¼Œå¦‚æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥å’ŒIOè¿æ¥ç­‰ã€‚ åœ¨å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆéœ€è¦å»ºç«‹ä¸æ•°æ®åº“çš„è¿æ¥ï¼Œå½“ä¸å†ä½¿ç”¨æ—¶ï¼Œéœ€è¦è°ƒç”¨closeæ–¹æ³•æ¥é‡Šæ”¾ä¸æ•°æ®åº“çš„è¿æ¥ã€‚åªæœ‰è¿æ¥è¢«å…³é—­åï¼Œåƒåœ¾å›æ”¶å™¨æ‰ä¼šå›æ”¶å¯¹åº”çš„å¯¹è±¡ã€‚ å¦åˆ™ï¼Œå¦‚æœåœ¨è®¿é—®æ•°æ®åº“çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹Connectionã€ Statementæˆ–ResultSetä¸æ˜¾æ€§åœ°å…³é—­ï¼Œå°†ä¼šé€ æˆå¤§é‡çš„å¯¹è±¡æ— æ³•è¢«å›æ”¶ï¼Œä»è€Œå¼•èµ·å†…å­˜æ³„æ¼ã€‚ 15-å˜é‡ä¸åˆç†çš„ä½œç”¨åŸŸ å˜é‡ä¸åˆç†çš„ä½œç”¨åŸŸã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä¸€ä¸ªå˜é‡çš„å®šä¹‰çš„ä½œç”¨èŒƒå›´å¤§äºå…¶ä½¿ç”¨èŒƒå›´ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ²¡æœ‰åŠæ—¶åœ°æŠŠå¯¹è±¡è®¾ç½®ä¸ºnull,å¾ˆæœ‰å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼çš„å‘ç”Ÿã€‚ 16-æ”¹å˜å“ˆå¸Œå€¼ æ”¹å˜å“ˆå¸Œå€¼ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«å­˜å‚¨è¿›HashSeté›†åˆä¸­ä»¥åï¼Œå°±ä¸èƒ½ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„é‚£äº›å‚ä¸è®¡ç®—å“ˆå¸Œå€¼çš„å­—æ®µäº†ã€‚ å¦åˆ™ï¼Œå¯¹è±¡ä¿®æ”¹åçš„å“ˆå¸Œå€¼ä¸æœ€åˆå­˜å‚¨è¿›HashSeté›†åˆä¸­æ—¶çš„å“ˆå¸Œå€¼å°±ä¸åŒäº†ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿åœ¨containsæ–¹æ³•ä½¿ç”¨è¯¥å¯¹è±¡çš„å½“å‰å¼•ç”¨ä½œä¸ºçš„å‚æ•°å»HashSeté›†åˆä¸­æ£€ç´¢å¯¹è±¡ï¼Œä¹Ÿå°†è¿”å›æ‰¾ä¸åˆ°å¯¹è±¡çš„ç»“æœï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´æ— æ³•ä»HashSeté›†åˆä¸­å•ç‹¬åˆ é™¤å½“å‰å¯¹è±¡ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚ è¿™ä¹Ÿæ˜¯Stringä¸ºä»€ä¹ˆè¢«è®¾ç½®æˆäº†ä¸å¯å˜ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾å¿ƒåœ°æŠŠString å­˜å…¥HashSet,æˆ–è€…æŠŠ Stringå½“åšHashMap çš„keyå€¼; å½“æˆ‘ä»¬æƒ³æŠŠè‡ªå·±å®šä¹‰çš„ç±»ä¿å­˜åˆ°æ•£åˆ—è¡¨çš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯å¯¹è±¡çš„hashCodeä¸å¯å˜ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118public class ChangeHashCode &#123; public static void main(String[] args) &#123; HashSet set = new HashSet(); Person p1 = new Person(1001, &quot;AA&quot;); Person p2 = new Person(1002, &quot;BB&quot;); set.add(p1); set.add(p2); p1.name = &quot;CC&quot;;//å¯¼è‡´äº†å†…å­˜çš„æ³„æ¼ set.remove(p1); //åˆ é™¤å¤±è´¥ System.out.println(set); set.add(new Person(1001, &quot;CC&quot;)); System.out.println(set); set.add(new Person(1001, &quot;AA&quot;)); System.out.println(set); &#125;&#125;class Person &#123; int id; String name; public Person(int id, String name) &#123; this.id = id; this.name = name; &#125; @Override public boolean equals(Object o) &#123; if (this == o) return true; if (!(o instanceof Person)) return false; Person person = (Person) o; if (id != person.id) return false; return name != null ? name.equals(person.name) : person.name == null; &#125; @Override public int hashCode() &#123; int result = id; result = 31 * result + (name != null ? name.hashCode() : 0); return result; &#125; @Override public String toString() &#123; return &quot;Person&#123;&quot; + &quot;id=&quot; + id + &quot;, name=&#x27;&quot; + name + &#x27;\\&#x27;&#x27; + &#x27;&#125;&#x27;; &#125;&#125;ä¾‹2ï¼š/** * æ¼”ç¤ºå†…å­˜æ³„æ¼ * @author shkstart * @create 14:47 */public class ChangeHashCode1 &#123; public static void main(String[] args) &#123; HashSet&lt;Point&gt; hs = new HashSet&lt;Point&gt;(); Point cc = new Point(); cc.setX(10);//hashCode = 41 hs.add(cc); cc.setX(20);//hashCode = 51 æ­¤è¡Œä¸ºå¯¼è‡´äº†å†…å­˜çš„æ³„æ¼ System.out.println(&quot;hs.remove = &quot; + hs.remove(cc));//false hs.add(cc); System.out.println(&quot;hs.size = &quot; + hs.size());//size = 2 System.out.println(hs); &#125;&#125;class Point &#123; int x; public int getX() &#123; return x; &#125; public void setX(int x) &#123; this.x = x; &#125; @Override public int hashCode() &#123; final int prime = 31; int result = 1; result = prime * result + x; return result; &#125; @Override public boolean equals(Object obj) &#123; if (this == obj) return true; if (obj == null) return false; if (getClass() != obj.getClass()) return false; Point other = (Point) obj; if (x != other.x) return false; return true; &#125; @Override public String toString() &#123; return &quot;Point&#123;&quot; + &quot;x=&quot; + x + &#x27;&#125;&#x27;; &#125;&#125; 17-ç¼“å­˜æ³„éœ² å†…å­˜æ³„æ¼çš„å¦ä¸€ä¸ªå¸¸è§æ¥æºæ˜¯ç¼“å­˜ï¼Œ- -æ—¦ä½ æŠŠå¯¹è±¡å¼•ç”¨æ”¾å…¥åˆ°ç¼“å­˜ä¸­ï¼Œä»–å°±å¾ˆå®¹æ˜“é—å¿˜ã€‚æ¯”å¦‚:ä¹‹å‰é¡¹ç›®åœ¨ä¸€æ¬¡ä¸Šçº¿çš„æ—¶å€™ï¼Œåº”ç”¨å¯åŠ¨å¥‡æ…¢ç›´åˆ°å¤¯æ­»ï¼Œå°±æ˜¯å› ä¸ºä»£ç ä¸­ä¼šåŠ è½½-ä¸ªè¡¨ä¸­çš„æ•°æ®åˆ°ç¼“å­˜(å†…å­˜)ä¸­ï¼Œæµ‹è¯•ç¯å¢ƒåªæœ‰å‡ ç™¾æ¡æ•°æ®ï¼Œä½†æ˜¯ç”Ÿäº§ç¯å¢ƒæœ‰å‡ ç™¾ä¸‡çš„æ•°æ®ã€‚ å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨WeakHashMapä»£è¡¨ç¼“å­˜ï¼Œæ­¤ç§Mapçš„ç‰¹ç‚¹æ˜¯ï¼Œå½“é™¤äº†è‡ªèº«æœ‰å¯¹keyçš„å¼•ç”¨å¤–ï¼Œæ­¤keyæ²¡æœ‰å…¶ä»–å¼•ç”¨é‚£ä¹ˆæ­¤mapä¼šè‡ªåŠ¨ä¸¢å¼ƒæ­¤å€¼ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public class MapTest &#123; static Map wMap = new WeakHashMap(); static Map map = new HashMap(); public static void main(String[] args) &#123; init(); testWeakHashMap(); testHashMap(); &#125; public static void init() &#123; String ref1 = new String(&quot;obejct1&quot;); String ref2 = new String(&quot;obejct2&quot;); String ref3 = new String(&quot;obejct3&quot;); String ref4 = new String(&quot;obejct4&quot;); wMap.put(ref1, &quot;cacheObject1&quot;); wMap.put(ref2, &quot;cacheObject2&quot;); map.put(ref3, &quot;cacheObject3&quot;); map.put(ref4, &quot;cacheObject4&quot;); System.out.println(&quot;Stringå¼•ç”¨ref1ï¼Œref2ï¼Œref3ï¼Œref4 æ¶ˆå¤±&quot;); &#125; public static void testWeakHashMap() &#123; System.out.println(&quot;WeakHashMap GCä¹‹å‰&quot;); for (Object o : wMap.entrySet()) &#123; System.out.println(o); &#125; try &#123; System.gc(); TimeUnit.SECONDS.sleep(5); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;WeakHashMap GCä¹‹å&quot;); for (Object o : wMap.entrySet()) &#123; System.out.println(o); &#125; &#125; public static void testHashMap() &#123; System.out.println(&quot;HashMap GCä¹‹å‰&quot;); for (Object o : map.entrySet()) &#123; System.out.println(o); &#125; try &#123; System.gc(); TimeUnit.SECONDS.sleep(5); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;HashMap GCä¹‹å&quot;); for (Object o : map.entrySet()) &#123; System.out.println(o); &#125; &#125;&#125; ä¸Šé¢ä»£ç å’Œå›¾ç¤ºä¸»æ¼”æ¼”ç¤ºWeakHashMapå¦‚ä½•è‡ªåŠ¨é‡Šæ”¾ç¼“å­˜å¯¹è±¡ï¼Œå½“initå‡½ æ•°æ‰§è¡Œå®Œæˆåï¼Œå±€éƒ¨å˜é‡å­— ç¬¦ä¸²å¼•ç”¨weakd1 ,weakd2,d1,d2éƒ½ä¼šæ¶ˆå¤±ï¼Œæ­¤æ—¶åªæœ‰é™æ€mapä¸­ä¿å­˜ä¸­å¯¹å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯ä»¥ çœ‹åˆ°ï¼Œè°ƒç”¨gcä¹‹åï¼ŒHashMapçš„æ²¡æœ‰è¢«å›æ”¶ï¼Œè€ŒWeakHashMap é‡Œé¢çš„ç¼“å­˜è¢«å›æ”¶äº†ã€‚ 18-ç›‘å¬å™¨å’Œå›è°ƒ å†…å­˜æ³„æ¼ç¬¬ä¸‰ä¸ªå¸¸è§æ¥æºæ˜¯ç›‘å¬å™¨å’Œå…¶ä»–å›è°ƒï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨ä½ å®ç°çš„APIä¸­æ³¨å†Œå›è°ƒï¼Œå´æ²¡æœ‰æ˜¾ç¤ºçš„å–æ¶ˆï¼Œé‚£ä¹ˆå°±ä¼šç§¯èšã€‚ éœ€è¦ç¡®ä¿å›è°ƒç«‹å³è¢«å½“ä½œåƒåœ¾å›æ”¶çš„æœ€ä½³æ–¹æ³•æ˜¯åªä¿å­˜å®ƒçš„å¼±å¼•ç”¨ï¼Œä¾‹å¦‚å°†ä»–ä»¬ä¿å­˜æˆä¸ºWeakHashMapä¸­çš„é”®ã€‚ 3ï¼‰å†…å­˜æ³„éœ²æ¡ˆä¾‹åˆ†æ â‘ ä»£ç  123456789101112131415161718192021222324252627public class Stack &#123; private Object[] elements; private int size = 0; private static final int DEFAULT_INITIAL_CAPACITY = 16; public Stack() &#123; elements = new Object[DEFAULT_INITIAL_CAPACITY]; &#125; public void push(Object e) &#123; //å…¥æ ˆ ensureCapacity(); elements[size++] = e; &#125; public Object pop() &#123; if (size == 0) throw new EmptyStackException(); Object result = elements[--size]; elements[size] = null; return result; &#125; private void ensureCapacity() &#123; if (elements.length == size) elements = Arrays.copyOf(elements, 2 * size + 1); &#125;&#125; â‘¡åˆ†æ ä¸Šè¿°ç¨‹åºå¹¶æ²¡æœ‰æ˜æ˜¾çš„é”™è¯¯ï¼Œä½†æ˜¯è¿™æ®µç¨‹åºæœ‰ä¸€ä¸ªå†…å­˜æ³„æ¼ï¼Œéšç€GCæ´»åŠ¨çš„å¢åŠ ï¼Œæˆ–è€…å†…å­˜å ç”¨çš„ä¸æ–­å¢åŠ ï¼Œç¨‹åºæ€§èƒ½çš„é™ä½å°±ä¼šè¡¨ç°å‡ºæ¥ï¼Œä¸¥é‡æ—¶å¯å¯¼è‡´å†…å­˜æ³„æ¼ï¼Œä½†æ˜¯è¿™ç§å¤±è´¥æƒ…å†µç›¸å¯¹è¾ƒå°‘ã€‚ ä»£ç çš„ä¸»è¦é—®é¢˜åœ¨popå‡½æ•°ï¼Œä¸‹é¢é€šè¿‡è¿™å¼ å›¾ç¤ºå±•ç° å‡è®¾è¿™ä¸ªæ ˆ- -ç›´å¢é•¿ï¼Œå¢é•¿åå¦‚ä¸‹å›¾æ‰€ç¤º å½“è¿›è¡Œå¤§é‡çš„POPæ“ä½œæ—¶ï¼Œç”±äºå¼•ç”¨æœªè¿›è¡Œç½®ç©ºï¼Œgcæ˜¯ä¸ä¼šé‡Šæ”¾çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ ˆå…ˆå¢é•¿ï¼Œåœ¨æ”¶ç¼©ï¼Œé‚£ä¹ˆä»æ ˆä¸­å¼¹å‡ºçš„å¯¹è±¡å°†ä¸ä¼šè¢«å½“ä½œåƒåœ¾å›æ”¶ï¼Œå³ä½¿ç¨‹åºä¸å†ä½¿ç”¨æ ˆä¸­çš„è¿™äº›å¯¹è±¡ï¼Œä»–ä»¬ä¹Ÿä¸ä¼šå›æ”¶ï¼Œå› ä¸ºæ ˆä¸­ä»ç„¶ä¿å­˜è¿™å¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™ä¸ªå†…å­˜æ³„æ¼å¾ˆéšè”½ã€‚ â‘¢è§£å†³åŠæ³• å°†ä»£ç ä¸­çš„pop()æ–¹æ³•å˜æˆå¦‚ä¸‹æ–¹æ³•ï¼š 12345public Object pop() &#123; //å‡ºæ ˆ if (size == 0) throw new EmptyStackException(); return elements[--size];&#125; ä¸€æ—¦å¼•ç”¨è¿‡æœŸï¼Œæ¸…ç©ºè¿™äº›å¼•ç”¨ï¼Œå°†å¼•ç”¨ç½®ç©ºã€‚ 78.åˆ¤æ–­å…ƒç©ºé—´æ˜¯æ— ç”¨çš„ç±»æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰ä¸»è¦å›æ”¶çš„æ˜¯æ— ç”¨çš„ç±»ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»å‘¢ï¼Ÿç±»éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢3ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯ â€œæ— ç”¨çš„ç±»â€ ï¼š è¯¥ç±»æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚ åŠ è½½è¯¥ç±»çš„ ClassLoader å·²ç»è¢«å›æ”¶ã€‚ï¼ˆæ¡ä»¶è‹›åˆ»ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¼šè¢«å›æ”¶æ‰ï¼‰ è¯¥ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚ 79.åˆ›å»ºå¯¹è±¡çš„å‡ ç§æ–¹å¼1ï¼‰new newï¼ˆç›´æ¥new ï¼Œå·¥å‚æ¨¡å¼ï¼Œæ„å»ºè€…æ¨¡å¼ï¼‰ 2ï¼‰Class.forName().newInstance() åå°„çš„æ–¹å¼ï¼Œåªèƒ½è°ƒç”¨ç©ºå‚æ„é€ å™¨ï¼Œæƒé™æ˜¯public 3ï¼‰Constructor.newInstance(xxx) åå°„çš„æ–¹å¼ï¼Œå¯ä»¥è°ƒç”¨ç©ºå‚ï¼Œå¸¦å‚çš„æ„é€ å™¨ï¼Œæƒé™æ²¡è¦æ±‚ 4ï¼‰ä½¿ç”¨cloneï¼ˆï¼‰ ä¸è°ƒç”¨ä»»ä½•æ„é€ å™¨ï¼Œå½“å‰éœ€è¦å®ç°Cloneableæ¥å£ï¼Œå®ç°cloneï¼ˆï¼‰ï¼›åˆ†ä¸ºæ·±å…‹éš†å’Œæµ…å…‹éš† å¯¹è±¡åµŒå¥— 5ï¼‰ä½¿ç”¨ååºåˆ—åŒ– ä»æ–‡ä»¶ï¼Œç½‘ç»œä¸­è·å–ä¸€ä¸ªå¯¹è±¡çš„äºŒè¿›åˆ¶æµ 6ï¼‰ç¬¬ä¸‰æ–¹åº“Objenesis 80.å¯¹è±¡è®¿é—®å®šä½JVMæ˜¯å¦‚ä½•é€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨è®¿é—®åˆ°å…¶å†…éƒ¨çš„å¯¹è±¡å®ä¾‹å‘¢ï¼Ÿ å®šä½ï¼Œé€šè¿‡æ ˆä¸Šreferenceè®¿é—®ã€‚åˆ›å»ºå¯¹è±¡çš„ç›®çš„æ˜¯ä¸ºäº†ä½¿ç”¨å®ƒã€‚å¯¹è±¡è®¿é—®æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼š 1ï¼‰å¥æŸ„è®¿é—® ä¼˜ç‚¹ï¼šå¼•ç”¨ä¸­å­˜å‚¨ç¨³å®šå¥æŸ„åœ°å€ï¼Œå¯¹è±¡è¢«ç§»åŠ¨æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­å®ä¾‹æ•°æ®æŒ‡é’ˆå³å¯ï¼Œå¼•ç”¨æœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹ã€‚ ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–ç»´æŠ¤ä¸€ä¸ªå¥æŸ„ï¼Œæ•ˆç‡ä½ã€‚ 2ï¼‰ç›´æ¥æŒ‡é’ˆ(HotSpoté‡‡ç”¨) ä¼˜ç‚¹ï¼šæ•ˆç‡é«˜ 81.æ°¸ä¹…ä»£ä¸ºä»€ä¹ˆè¦è¢«å…ƒç©ºé—´æ›¿æ¢ï¼Ÿä»¥å‰ä½¿ç”¨è™šæ‹Ÿæœºå†…å­˜ï¼Œç°åœ¨ä½¿ç”¨æœ¬åœ°å†…å­˜ â‘ ä¸ºæ°¸ä¹…ä»£è®¾ç½®ç©ºé—´å¤§å°å¾ˆéš¾ç¡®å®š â‘¡å¯¹æ°¸ä¹…ä»£è°ƒä¼˜å›°éš¾ æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦åˆ†ä¸¤éƒ¨åˆ† å¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ 82.æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„å°½ç®¡æ‰€æœ‰æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸€äº›ç®€å•çš„å®ç°å¯èƒ½ä¸ä¼šé€‰æ‹©å»è¿›è¡Œåƒåœ¾å›æ”¶æˆ–è€…å‹ç¼©ï¼Œå¯¹äºhotspotè€Œè¨€ï¼Œæ–¹æ³•åŒºè¿˜æœ‰ä¸€ä¸ªåˆ«åå«éå †ï¼Œç›®çš„å°±æ˜¯è¦å’Œå †åˆ†å¼€ã€‚æ‰€ä»¥æ–¹æ³•åŒºå¯ä»¥çœ‹åšæ˜¯ä¸€å—ç‹¬ç«‹äºjavaå †çš„å†…å­˜ç©ºé—´ã€‚æ–¹æ³•åŒºä¸å †ç©ºé—´ä¸€æ ·ï¼Œæ˜¯å¤šçº¿ç¨‹å…±äº«çš„ï¼Œæ–¹æ³•åŒºåœ¨jvmå¯åŠ¨çš„æ—¶å€™è¢«åˆ›å»ºï¼Œå¹¶ä¸”ä»–çš„å®é™…ç‰©ç†å†…å­˜ç©ºé—´ä¸­å’Œjavaå †åŒºä¸€æ ·éƒ½å¯ä»¥æ˜¯ç‰©ç†ä¸Šä¸è¿ç»­çš„ã€‚æ–¹æ³•åŒºçš„å¤§å°å’Œå †ä¸€æ ·å¯ä»¥é€‰æ‹©å›ºå®šå¤§å°å’Œæ‰©å±•ã€‚æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šOOMã€‚å…³é—­jvmå°±ä¼šé‡Šæ”¾è¿™ä¸ªåŒºåŸŸçš„å†…å­˜ã€‚ ä»–ç”¨äºå­˜å‚¨å·²ç»è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ï¼Œå¸¸é‡ï¼Œé™æ€å˜é‡ï¼Œå³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚ 1ï¼‰ç±»å‹ä¿¡æ¯ å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼Œjvå¿…é¡»åœ¨æ–¹æ³•åŒºå­˜å‚¨ä¸€ä¸‹ç±»å‹ä¿¡æ¯ã€‚ å…¨é™å®šç±»åï¼Œç›´æ¥çˆ¶ç±»çš„å…¨é™å®šç±»åï¼Œè¿™ä¸ªç±»å‹çš„ä¿®é¥°ç¬¦ï¼Œè¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨ 2ï¼‰åŸŸä¿¡æ¯ jvmå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­ä¿å­˜ç±»å‹çš„æ‰€æœ‰åŸŸçš„ä¿¡æ¯ä»¥åŠåŸŸçš„å£°æ˜é¡ºåºã€‚ åŸŸçš„ç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šåŸŸåç§°ï¼ŒåŸŸç±»å‹ï¼ŒåŸŸä¿®é¥°ç¬¦ã€‚ 3ï¼‰æ–¹æ³•ä¿¡æ¯ jvmå¿…é¡»ä¿å­˜æ‰€æœ‰æ–¹æ³•çš„ä»¥ä¸‹ä¿¡æ¯ï¼ŒåŒåŸŸä¿¡æ¯ä¸€æ ·åŒ…æ‹¬å£°æ˜é¡ºåº æ–¹æ³•åç§°ï¼Œè¿”å›ç±»å‹ï¼Œå‚æ•°çš„æ•°é‡å’Œç±»å‹ï¼Œé¡ºåºï¼Œæ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼Œæ–¹æ³•çš„å­—èŠ‚ç ï¼Œæ“ä½œæ•°æ ˆï¼Œå±€éƒ¨å˜é‡è¡¨ä»¥åŠå¤§å°ï¼Œå¼‚å¸¸è¡¨ æ¯ä¸ªå¼‚å¸¸å¤„ç†çš„å¼€å§‹ä½ç½®ï¼Œç»“æŸä½ç½®ï¼Œä»£ç å¤„ç†åœ¨ç¨‹åºè®¡æ•°å™¨ä¸­çš„åç§»åœ°å€ï¼Œè¢«æ•è·çš„å¼‚å¸¸ç±»çš„å¸¸é‡æ± ç´¢å¼•ã€‚ 12345678910111213141516171819202122232425262728/** * @author yinhuidong * @createTime 2020-08-20-12:09 * 1.é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œä»–ä»¬æˆä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†ã€‚ * 2.ç±»å˜é‡è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œå³ä½¿æ²¡æœ‰å®ä¾‹æ—¶ä½ ä¹Ÿå¯ä»¥æ”¾é—®ä»–ã€‚ * 3.å…¨å±€å¸¸é‡ static final * è¢«å£°æ˜ä¸ºfinalçš„ç±»å˜é‡çš„å¤„ç†æ–¹æ³•åˆ™ä¸åŒï¼Œæ¯ä¸ªå…¨å±€å¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…äº†ã€‚ *å›¾ï¼šfinal-static * javap -v Order.class * javap -v -p DemoE.class &gt; DemoE.txt */public class DemoD &#123; public static void main(String[] args) &#123; Order order=null; order.hello(); &#125;&#125;class Order&#123; public static int a=1; public static final int b=2; static &#123; a=3; &#125; public final static void hello()&#123; System.out.println(&quot;a = &quot; + a+&quot;----&quot;+&quot;b = &quot; + b); System.out.println(&quot;hello&quot;); &#125;&#125; 4ï¼‰classæ–‡ä»¶ä¸­å¸¸é‡æ± çš„ç†è§£ æ–¹æ³•åŒºå†…éƒ¨åŒ…å«äº†è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå­—èŠ‚ç æ–‡ä»¶å†…éƒ¨åŒ…å«äº†å¸¸é‡æ± ã€‚ ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ± ï¼Ÿ javaä¸­çš„å­—èŠ‚ç éœ€è¦æ•°æ®æ”¯æŒï¼Œé€šå¸¸è¿™ç§æ•°æ®ä¼šå¾ˆå¤§ä»¥è‡³äºä¸èƒ½ç›´æ¥å­˜åˆ°å­—èŠ‚ç é‡Œï¼Œæ¢å¦ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å­˜åˆ°å¸¸é‡æ± ï¼Œè¿™ä¸ªå­—èŠ‚ç åŒ…å«äº†æŒ‡å‘å¸¸é‡æ± çš„å¼•ç”¨ï¼Œåœ¨åŠ¨æ€é“¾æ¥çš„æ—¶å€™å°±ä¼šç”¨åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ã€‚ ä¸€ä¸ªæœ‰æ•ˆçš„å­—èŠ‚ç æ–‡ä»¶ä¸­é™¤äº†åŒ…å«ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œå­—æ®µï¼Œæ–¹æ³•ä»¥åŠæ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜åŒ…å«ä¸€é¡¹ä¿¡æ¯é‚£å°±æ˜¯å¸¸é‡æ± è¡¨ï¼ŒåŒ…å«å„ç§å­—é¢é‡å’Œå¯¹åº”ç±»å‹ï¼ŒåŸŸå’Œæ–¹æ³•çš„ç¬¦å·å¼•ç”¨ã€‚ æ€»ç»“ï¼šå¸¸é‡æ± ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åï¼Œæ–¹æ³•åï¼Œå‚æ•°ç±»å‹ï¼Œå­—é¢é‡ç­‰ç±»å‹ã€‚ 5ï¼‰è¿è¡Œæ—¶å¸¸é‡æ±  æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œclassæ–‡ä»¶çš„å¸¸é‡æ± è¢«ç±»åŠ è½½å™¨åŠ è½½åˆ°è¿è¡Œæ—¶æ•°æ®åŒºå°±ä¼šåœ¨æ–¹æ³•åŒºç”Ÿæˆå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼ŒJVMä¸ºæ¯ä¸€ä¸ªå·²ç»åŠ è½½çš„ç±»æˆ–æ¥å£éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå¸¸é‡æ± ã€‚æ± å­ä¸­çš„æ•°æ®å°±åƒæ•°ç»„ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡ç´¢å¼•è®¿é—®çš„ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± åŒ…æ‹¬å¤šç§ä¸åŒçš„å˜é‡ï¼ŒåŒ…æ‹¬ç¼–è¯‘æœŸå°±å·²ç»æ˜ç¡®çš„æ•°å€¼å­—é¢é‡ï¼Œä¹ŸåŒ…æ‹¬åˆ°è¿è¡ŒæœŸè§£æåæ‰èƒ½è·å¾—çš„æ–¹æ³•æˆ–è€…å­—æ®µå¼•ç”¨ã€‚æ­¤æ—¶ä¸å†æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·åœ°å€äº†ï¼Œè¿™é‡Œæ¢ä½çœŸå®åœ°å€ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± åŠ¨æ€æ€§ï¼Œå½“åˆ›å»ºç±»æˆ–è€…æ¥å£çš„è¿è¡Œæ—¶å¸¸é‡æ± æ—¶ï¼Œå¦‚æœæ„é€ è¿è¡Œæ—¶å¸¸é‡æ± æ‰€éœ€çš„å†…å­˜ç©ºé—´è¶…è¿‡äº†æ–¹æ³•åŒºæ‰€èƒ½æä¾›çš„æœ€å¤§å€¼ï¼Œåˆ™ä¼šOOMã€‚ 83.å›¾è§£å¸¸é‡æ± æ“ä½œ 123456789public class DemoE &#123; public static void main(String[] args) &#123; int x=500; int y=100; int a=x/y; int b=50; System.out.println(a+b); &#125;&#125; è¿è¡Œæ—¶å¸¸é‡æ±  è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚ å¸¸é‡æ± è¡¨ç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ä¸ç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± ç›¸å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦å¤–ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯å…·å¤‡åŠ¨æ€æ€§ï¼ŒJavaè¯­è¨€å¹¶ä¸è¦æ±‚å¸¸é‡ä¸€å®šåªæœ‰ç¼–è¯‘æœŸæ‰èƒ½äº§ç”Ÿï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶éé¢„ç½®å…¥Classæ–‡ä»¶ä¸­å¸¸é‡æ± çš„å†…å®¹æ‰èƒ½è¿›å…¥æ–¹æ³•åŒºè¿è¡Œæ—¶å¸¸é‡æ± ï¼Œè¿è¡ŒæœŸé—´ä¹Ÿå¯ä»¥å°†æ–°çš„å¸¸é‡æ”¾å…¥æ± ä¸­ï¼Œè¿™ç§ç‰¹æ€§è¢«å¼€å‘äººå‘˜åˆ©ç”¨å¾—æ¯”è¾ƒå¤šçš„ä¾¿æ˜¯Stringç±»çš„intern()æ–¹æ³•ã€‚ 84.æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶1.ä¸€èˆ¬æ¥è¯´ï¼Œæ–¹æ³•åŒºçš„å›æ”¶æ•ˆæœä¸å¥½ï¼Œç‰¹åˆ«æ˜¯ç±»å‹çš„å¸è½½ï¼Œä½†æ˜¯æœ‰æ—¶å€™å›æ”¶åˆæ˜¯å¿…è¦çš„ 2.æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶ä¸»è¦æ˜¯ä¸¤éƒ¨åˆ†ï¼šåºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ 3.æ–¹æ³•åŒºå¸¸é‡æ± ä¸»è¦å­˜æ”¾ï¼šå­—é¢é‡å’Œç¬¦å·å¼•ç”¨ ç¬¦å·å¼•ç”¨åŒ…æ‹¬ï¼š1.ç±»å’Œæ¥å£çš„å…¨é™å®šç±»å2.å­—æ®µçš„åç§°å’Œæè¿°ç¬¦3.æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦ 4.åªè¦å¸¸é‡æ± ä¸­çš„å¸¸é‡æ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œå°±å¯ä»¥è¢«å›æ”¶ 5.åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å¯ä»¥è¢«å›æ”¶ 1.è¯¥ç±»æ‰€å±çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ 2.åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶ 3.è¯¥ç±»å¯¹åº”çš„Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„å¯¹è±¡ 85.ç›´æ¥å†…å­˜ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯jvmè§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚ ç›´æ¥å†…å­˜æ˜¯åœ¨javaå †å¤–ï¼Œç›´æ¥å‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜ç©ºé—´ã€‚ æ¥æºäºNIOï¼Œé€šè¿‡å­˜åœ¨å †ä¸­çš„DirectByteBufferæ“ä½œNativeå†…å­˜ï¼Œé€šå¸¸ï¼Œè®¿é—®ç›´æ¥å†…å­˜çš„é€Ÿåº¦ä¼šä¼˜äºjavaå †ï¼Œå³è¯»å†™æ€§èƒ½é«˜ï¼Œå› æ­¤å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè¯»å†™é¢‘ç¹çš„åœºåˆå¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œjavaçš„NIOåº“å…è®¸javaç¨‹åºä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒºã€‚ 12345678910public class DemoH &#123; private static Integer BUFFER=10*1024*1024; public static void main(String[] args) &#123; Scanner sc = new Scanner(System.in); ByteBuffer byteBuffer=ByteBuffer.allocate(BUFFER); sc.next(); byteBuffer=null; System.gc(); &#125;&#125; ä¹Ÿå¯èƒ½å¯¼è‡´OOMå¼‚å¸¸ï¼Œç”±äºç›´æ¥å†…å­˜åœ¨javaå †å¤–ï¼Œå› æ­¤å®ƒçš„å¤§å°ä¸ä¼šå—é™äº-XmxæŒ‡å®šçš„æœ€å¤§å †çš„å¤§å°ï¼Œä½†æ˜¯ç³»ç»Ÿå†…å­˜æ˜¯æœ‰é™çš„ï¼Œjavaå †å’Œç›´æ¥å†…å­˜çš„æ€»å’Œä¾ç„¶å—é™äºæ“ä½œç³»ç»Ÿèƒ½ç»™å‡ºçš„æœ€å¤§å†…å­˜ã€‚ ç¼ºç‚¹ï¼šåˆ†é…å›æ”¶æˆæœ¬é«˜ï¼Œä¸å—JVMå†…å­˜å›æ”¶ç®¡ç†ï¼Œç›´æ¥å†…å­˜å¤§å°å¯ä»¥é€šè¿‡MaxDirectMemorySizeè®¾ç½®ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸å †çš„æœ€å¤§å€¼-Xmxå‚æ•°å€¼ä¸€è‡´ï¼Œç®€å•ç†è§£javaè¿›ç¨‹å†…å­˜=javaå †+æœ¬åœ°å†…å­˜ã€‚ 86.é™æ€å˜é‡æ”¾åœ¨å“ªé‡Œ12345678910111213141516171819202122/** * @author yinhuidong * @createTime 2020-08-20-15:38 * åˆ†æï¼š * 1.newå‡ºæ¥çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡å®ä¾‹éƒ½åœ¨å †ç©ºé—´ * 2.1.6ï¼šobj1éšç€DemoGçš„ç±»å‹ä¿¡æ¯æ”¾åœ¨æ–¹æ³•åŒºï¼›1.7ï¼šæ”¾åœ¨å †ç©ºé—´ * 3.obj2æ˜¯å®ä¾‹å˜é‡ï¼Œåœ¨å †ç©ºé—´ * 4.obj3åœ¨fooæ–¹æ³•å¯¹åº”çš„æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ */public class DemoG &#123; static class Test&#123; static Order obj1=new Order(); //jdk7ä»¥å‰æ”¾åœ¨æ°¸ä¹…ä»£ï¼Œ7å¼€å§‹æ”¾åœ¨å †ç©ºé—´ Order obj2=new Order(); //å®ä¾‹å˜é‡ å †ç©ºé—´ void foo()&#123; Order obj3=new Order(); //æ–¹æ³•å†…éƒ¨å±€éƒ¨å˜é‡ æ ˆå¸§é‡Œé¢çš„å±€éƒ¨å˜é‡è¡¨ &#125; &#125; static class Order&#123; &#125;&#125; 87.æ‰§è¡Œå¼•æ“1.è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªç›¸å¯¹äºç‰©ç†æœºçš„æ¦‚å¿µï¼Œè¿™ä¸¤ç§æœºå™¨éƒ½æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ›ï¼Œå…¶åŒºåˆ«æ˜¯ç‰©ç†æœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç›´æ¥å»ºç«‹åœ¨å¤„ç†å™¨ï¼Œç¼“å­˜ï¼ŒæŒ‡ä»¤é›†å’Œæ“ä½œç³»ç»Ÿå±‚é¢çš„ï¼Œè€Œè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç”±è½¯ä»¶è‡ªè¡Œå®ç°çš„ï¼Œå› æ­¤å¯ä»¥ä¸å—ç‰©ç†æ¡ä»¶åˆ¶çº¦çš„å®šåˆ¶æŒ‡ä»¤é›†ä¸æ‰§è¡Œå¼•æ“çš„ç»“æ„ä½“ç³»ï¼Œèƒ½å¤Ÿæ‰§è¡Œé‚£äº›ä¸è¢«ç¡¬ä»¶ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤é›†æ ¼å¼ã€‚ 2.jvmçš„ä¸»è¦ä½œç”¨è´Ÿè´£è£…åœ¨å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œä½†æ˜¯å­—èŠ‚ç ä¸èƒ½ç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œæ‰§è¡Œå¼•æ“å°±æ˜¯å°†å­—èŠ‚ç æŒ‡ä»¤ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ã€‚ 3.å¤–è§‚ä¸Šçœ‹ï¼šjvmçš„æ‰§è¡Œå¼•æ“è¾“å…¥è¾“å‡ºéƒ½æ˜¯ä¸€è‡´çš„ï¼Œè¾“å…¥çš„æ˜¯å­—èŠ‚ç äºŒè¿›åˆ¶æµï¼Œå¤„ç†è¿‡ç¨‹æ˜¯å­—èŠ‚ç è§£ææ‰§è¡Œçš„è¿‡ç¨‹ï¼Œè¾“å‡ºçš„æ˜¯æ‰§è¡Œç»“æœã€‚ 88.javaä»£ç çš„ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹ å¤§éƒ¨åˆ†çš„ç¨‹åºä»£ç è½¬æ¢ä¸ºç‰©ç†æœºçš„ç›®æ ‡ä»£ç æˆ–è™šæ‹Ÿæœºèƒ½æ‰§è¡Œçš„æŒ‡ä»¤é›†ä¹‹å‰ï¼Œéƒ½éœ€è¦ç»è¿‡ä¸Šå›¾çš„æ­¥éª¤ã€‚ ä¸ºä»€ä¹ˆjavaç§°ä¸ºåŠè§£é‡Šå‹åŠç¼–è¯‘å‹è¯­è¨€ï¼Ÿ å› ä¸ºjvmçš„æ‰§è¡Œå¼•æ“æ˜¯è§£é‡Šå™¨å’Œjitå³æ—¶ç¼–è¯‘å™¨äº¤äº’å·¥ä½œçš„ã€‚ ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼Ÿä»€ä¹ˆæ˜¯JITç¼–è¯‘å™¨ï¼Ÿ è§£é‡Šå™¨ï¼šå°†å­—èŠ‚ç æŒ‡ä»¤é€è¡Œç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤å¹¶æ‰§è¡Œ ç¼–è¯‘å™¨ï¼šå°†æºä»£ç ç›´æ¥ç¼–è¯‘æˆå¯¹åº”çš„æœºå™¨æŒ‡ä»¤ã€‚ 89.JITå³æ—¶ç¼–è¯‘å™¨HotSpoté‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å…±å­˜çš„æ¶æ„ã€‚ç”±JVMå†³å®šä½•æ—¶ä½¿ç”¨å“ªç§æ–¹å¼æ‰§è¡Œã€‚ è§£é‡Šå™¨å¯ä»¥è¾¹è§£é‡Šè¾¹æ‰§è¡Œï¼Œè¿™æ ·ç¨‹åºå¯åŠ¨æ—¶é—´å°±ä¼šå˜å¿«ï¼ŒåŠæ—¶ç¼–è¯‘å™¨æ˜¯éƒ½ç¼–è¯‘å¥½äº†åœ¨æ‰§è¡Œï¼Œç¨‹åºå¯åŠ¨æ—¶é—´æ…¢ã€‚ä½†æ˜¯ä¸€æ—¦jitç¼–è¯‘å™¨æŠŠè¶Šæ¥è¶Šå¤šçš„ä»£ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ï¼Œæ‰§è¡Œæ•ˆç‡ç«‹é©¬èµ·é£ã€‚ 1ï¼‰çƒ­ç‚¹ä»£ç ä»¥åŠæ¢æµ‹æ–¹å¼ åˆ¤æ–­æ˜¯å¦å¯åŠ¨jitç¼–è¯‘å™¨å°†å­—èŠ‚ç ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œéœ€è¦æ ¹æ®æ‰§è¡Œçš„é¢‘ç‡è€Œå®šã€‚çƒ­ç‚¹ä»£ç å°±æ˜¯éœ€è¦è¢«ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç çš„å­—èŠ‚ç ï¼Œjitåœ¨è¿è¡Œæ—¶ä¼šé’ˆå¯¹é¢‘ç¹è°ƒç”¨çš„çƒ­ç‚¹ä»£ç ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œæå‡æ€§èƒ½ã€‚ 2ï¼‰OSRç¼–è¯‘ ä¸€ä¸ªæ–¹æ³•è¢«å¤šæ¬¡è°ƒç”¨ï¼Œæˆ–è€…ä¸€ä¸ªæ–¹æ³•ä½“å†…éƒ¨å¾ªç¯æ¬¡æ•°è¾ƒå¤šçš„å¾ªç¯ä½“éƒ½å¯ä»¥è¢«ç§°ä¸ºçƒ­ç‚¹ä»£ç ï¼Œå› æ­¤éƒ½å¯ä»¥é€šè¿‡jitç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯æ ˆä¸Šæ›¿æ¢.hotspoté‡‡ç”¨çš„çƒ­ç‚¹æ¢æµ‹æ–¹å¼æ˜¯åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ã€‚ ä¸ºæ¯ä¸ªæ–¹æ³•å»ºç«‹2ä¸ªä¸åŒç±»å‹çš„è®¡æ•°å™¨ï¼Œåˆ†åˆ«ä¸ºæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨å’Œå›è¾¹è®¡æ•°å™¨ 1.æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼šç»Ÿè®¡æ–¹æ³•è°ƒç”¨æ¬¡æ•°ï¼Œé»˜è®¤clientæ¨¡å¼ä¸‹1500ï¼Œserveræ¨¡å¼ä¸‹100002.å›è¾¹è®¡æ•°å™¨ï¼šç»Ÿè®¡å¾ªç¯æ‰§è¡Œæ¬¡æ•° å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå…ˆåˆ¤æ–­æœ‰æ²¡æœ‰jitç¼–è¯‘è¿‡ï¼Œæœ‰çš„è¯ç›´æ¥ä½¿ç”¨jitç¼–è¯‘åçš„æœºå™¨æŒ‡ä»¤ï¼Œæ²¡æœ‰çš„è¯è®¡æ•°å™¨+1ï¼Œç„¶ååˆ¤æ–­ä¸¤ä¸ªè®¡æ•°å™¨ä¹‹å’Œæ˜¯å¦è¶…è¿‡æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çš„é˜ˆå€¼ã€‚å¦‚æœè¶…è¿‡ï¼Œå°±ä¼šå‘jitå‘å‡ºå³æ—¶ç¼–è¯‘ç”³è¯·ã€‚ çƒ­åº¦è¡°å‡æ˜¯åœ¨è™šæ‹Ÿæœºè¿›è¡Œåƒåœ¾å›æ”¶çš„æ—¶å€™é¡ºä¾¿è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€æ®µæ—¶é—´æ–¹æ³•ä¸€ç›´æ²¡æœ‰æ‰§è¡Œï¼Œè®¡æ•°å™¨çš„è®¡æ•°å°±ä¼šå‡åŠã€‚ å¯ä»¥è‡ªå·±æ‰‹åŠ¨è®¾ç½®è™šæ‹Ÿæœºé‡‡ç”¨å“ªç§ç¼–è¯‘æ¨¡å¼ 3ï¼‰JDK9å¼•å…¥äº†AOTç¼–è¯‘å™¨ aotç¼–è¯‘å™¨åœ¨ç¨‹åºæ‰§è¡Œä¹‹å‰ï¼Œå°±å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç è¿‡ç¨‹ã€‚ å¥½å¤„ï¼šå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸å¿…é¢„çƒ­ã€‚ åå¤„ï¼šç”±äºæå‰ç¼–è¯‘æˆäº†æœºå™¨æŒ‡ä»¤ï¼Œæ— æ³•å®ç°javaä¸€æ¬¡ç¼–è¯‘åˆ°å¤„è¿è¡Œã€‚ 4ï¼‰JDK10çš„Graalç¼–è¯‘å™¨ å…¨æ–°çš„å³æ—¶ç¼–è¯‘å™¨ï¼Œå®éªŒé˜¶æ®µï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ï¼Œå‰æ™¯å¤§å¥½","categories":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"}],"tags":[{"name":"JVM","slug":"JVM","permalink":"https://zhangxin66666.github.io/tags/JVM/"}]},{"title":"ConcurrentHashMapæºç è§£è¯»","slug":"1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap","date":"2024-08-22T03:23:14.702Z","updated":"2024-08-22T03:23:14.702Z","comments":true,"path":"2024/08/22/1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap/","link":"","permalink":"https://zhangxin66666.github.io/2024/08/22/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ConcurrentHashMap/","excerpt":"","text":"#1.æˆå‘˜å˜é‡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147//æ•£åˆ—è¡¨æ•°ç»„çš„æœ€å¤§é™åˆ¶private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;//æ•£åˆ—è¡¨é»˜è®¤å€¼private static final int DEFAULT_CAPACITY = 16;static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;//å¹¶å‘çº§åˆ«ï¼šjdk7å†å²é—ç•™é—®é¢˜ï¼Œä»…ä»…åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨åˆ°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ä»£è¡¨å¹¶å‘çº§åˆ«private static final int DEFAULT_CONCURRENCY_LEVEL = 16;//è´Ÿè½½å› å­ï¼ŒJDK1.8ä¸­ ConcurrentHashMap æ˜¯å›ºå®šå€¼private static final float LOAD_FACTOR = 0.75f;//æ ‘åŒ–é˜ˆå€¼ï¼ŒæŒ‡å®šæ¡¶ä½ é“¾è¡¨é•¿åº¦è¾¾åˆ°8çš„è¯ï¼Œæœ‰å¯èƒ½å‘ç”Ÿæ ‘åŒ–æ“ä½œã€‚static final int TREEIFY_THRESHOLD = 8;//çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼static final int UNTREEIFY_THRESHOLD = 6;//è”åˆTREEIFY_THRESHOLDæ§åˆ¶æ¡¶ä½æ˜¯å¦æ ‘åŒ–ï¼Œåªæœ‰å½“tableæ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸” æŸä¸ªæ¡¶ä½ ä¸­çš„é“¾è¡¨é•¿åº¦è¾¾åˆ°8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–static final int MIN_TREEIFY_CAPACITY = 64;//çº¿ç¨‹è¿ç§»æ•°æ®æœ€å°æ­¥é•¿ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡æœ€å°åŒºé—´ä¸€ä¸ªå€¼private static final int MIN_TRANSFER_STRIDE = 16;//è®¡ç®—æ‰©å®¹æ—¶å€™ç”Ÿæˆçš„ä¸€ä¸ª æ ‡è¯†æˆ³private static int RESIZE_STAMP_BITS = 16;//ç»“æœæ˜¯65535 è¡¨ç¤ºå¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°private static final int MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1;//æ‰©å®¹ç›¸å…³private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;//å½“nodeèŠ‚ç‚¹hash=-1 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»è¢«è¿ç§»äº† ï¼ŒfwdèŠ‚ç‚¹static final int MOVED = -1; // hash for forwarding nodes//node hash=-2 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ– ä¸” å½“å‰èŠ‚ç‚¹ä¸ºtreebinå¯¹è±¡ ï¼Œä»£ç†æ“ä½œçº¢é»‘æ ‘static final int TREEBIN = -2; // hash for roots of treesstatic final int RESERVED = -3; // hash for transient reservations//è½¬åŒ–æˆäºŒè¿›åˆ¶å®é™…ä¸Šæ˜¯ 31ä¸ª 1 å¯ä»¥å°†ä¸€ä¸ªè´Ÿæ•°é€šè¿‡ä½ç§»è¿ç®—å¾—åˆ°ä¸€ä¸ªæ­£æ•°static final int HASH_BITS = 0x7fffffff; // usable bits of normal node hash//å½“å‰ç³»ç»Ÿçš„cpuæ•°é‡static final int NCPU = Runtime.getRuntime().availableProcessors();//ä¸ºäº†å…¼å®¹7ç‰ˆæœ¬çš„chpä¿å­˜çš„ï¼Œæ ¸å¿ƒä»£ç å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°private static final ObjectStreamField[] serialPersistentFields = &#123; new ObjectStreamField(&quot;segments&quot;, Segment[].class), new ObjectStreamField(&quot;segmentMask&quot;, Integer.TYPE), new ObjectStreamField(&quot;segmentShift&quot;, Integer.TYPE) &#125;;//æ•£åˆ—è¡¨ï¼Œé•¿åº¦ä¸€å®šæ˜¯2æ¬¡æ–¹æ•°transient volatile Node&lt;K,V&gt;[] table;//æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–°table èµ‹å€¼ç»™nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸ºNullprivate transient volatile Node&lt;K,V&gt;[] nextTable;//LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶ æˆ–è€… å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ°baseCountä¸­private transient volatile long baseCount;/** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private transient volatile int sizeCtl;/** * * æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œè®°å½•å½“å‰è¿›åº¦ã€‚æ‰€æœ‰çº¿ç¨‹éƒ½éœ€è¦ä»transferIndexä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œå»æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ã€‚ */private transient volatile int transferIndex;/** * LongAdderä¸­çš„cellsBuzy 0è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡åŠ é”çŠ¶æ€ */private transient volatile int cellsBusy;/** * LongAdderä¸­çš„cellsæ•°ç»„ï¼Œå½“baseCountå‘ç”Ÿç«äº‰åï¼Œä¼šåˆ›å»ºcellsæ•°ç»„ï¼Œ * çº¿ç¨‹ä¼šé€šè¿‡è®¡ç®—hashå€¼ å–åˆ° è‡ªå·±çš„cell ï¼Œå°†å¢é‡ç´¯åŠ åˆ°æŒ‡å®šcellä¸­ * æ€»æ•° = sum(cells) + baseCount */private transient volatile CounterCell[] counterCells;// Unsafe mechanicsprivate static final sun.misc.Unsafe U;/**è¡¨ç¤ºsizeCtlå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long SIZECTL;/**è¡¨ç¤ºtransferIndexå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long TRANSFERINDEX;/**è¡¨ç¤ºbaseCountå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long BASECOUNT;/**è¡¨ç¤ºcellsBusyå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLSBUSY;/**è¡¨ç¤ºcellValueå±æ€§åœ¨CounterCellä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLVALUE;/**è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€*/private static final long ABASE;private static final int ASHIFT;static &#123; try &#123; U = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = ConcurrentHashMap.class; SIZECTL = U.objectFieldOffset (k.getDeclaredField(&quot;sizeCtl&quot;)); TRANSFERINDEX = U.objectFieldOffset (k.getDeclaredField(&quot;transferIndex&quot;)); BASECOUNT = U.objectFieldOffset (k.getDeclaredField(&quot;baseCount&quot;)); CELLSBUSY = U.objectFieldOffset (k.getDeclaredField(&quot;cellsBusy&quot;)); Class&lt;?&gt; ck = CounterCell.class; CELLVALUE = U.objectFieldOffset (ck.getDeclaredField(&quot;value&quot;)); Class&lt;?&gt; ak = Node[].class; ABASE = U.arrayBaseOffset(ak); //è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°,scale è¡¨ç¤ºNode[]æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å° int scale = U.arrayIndexScale(ak); //1 0000 &amp; 0 1111 = 0 if ((scale &amp; (scale - 1)) != 0) throw new Error(&quot;data type scale not a power of two&quot;); //numberOfLeadingZeros() è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€å—ã€‚ //8 =&gt; 1000 numberOfLeadingZeros(8) = 28 //4 =&gt; 100 numberOfLeadingZeros(4) = 29 //ASHIFT = 31 - 29 = 2 ï¼Ÿï¼Ÿ //ABASE + ï¼ˆ5 &lt;&lt; ASHIFTï¼‰ ASHIFT = 31 - Integer.numberOfLeadingZeros(scale); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125; #2.åŸºç¡€æ–¹æ³•##2.1 spreadé«˜ä½è¿ç®— 123static final int spread(int h) &#123; return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;&#125; ##2.2 tabAtè¯¥æ–¹æ³•è·å–å¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„å¯¹è±¡fieldçš„å€¼ã€‚å®é™…ä¸Šè¿™æ®µä»£ç çš„å«ä¹‰ç­‰ä»·äºtab[i],ä½†æ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ tab[i]æ¥è®¡ç®—å‘¢ï¼Ÿ getObjectVolatileï¼Œä¸€æ—¦çœ‹åˆ° volatile å…³é”®å­—ï¼Œå°±è¡¨ç¤ºå¯è§æ€§ã€‚å› ä¸ºå¯¹ volatile å†™æ“ä½œ happen-before äº volatile è¯»æ“ä½œï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹å¯¹ table çš„ä¿®æ”¹å‡å¯¹ get è¯»å–å¯è§ï¼› è™½ç„¶ table æ•°ç»„æœ¬èº«æ˜¯å¢åŠ äº† volatile å±æ€§ï¼Œä½†æ˜¯â€œvolatile çš„æ•°ç»„åªé’ˆå¯¹æ•°ç»„çš„å¼•ç”¨å…·æœ‰volatile çš„è¯­ä¹‰ï¼Œè€Œä¸æ˜¯å®ƒçš„å…ƒç´ â€ã€‚ æ‰€ä»¥å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªæ•°ç»„çš„å…ƒç´ è¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ¥è¯»çš„æ—¶å€™ä¸ä¸€å®šèƒ½è¯»åˆ°æœ€æ–°çš„å€¼ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒDoug Lea ç›´æ¥é€šè¿‡ Unsafe ç±»æ¥å¯¹ table è¿›è¡Œæ“ä½œã€‚ 123static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i) &#123; return (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE);&#125; ##2.3 casTabAtcasè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ 1234static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v) &#123; return U.compareAndSwapObject(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, c, v);&#125; ##2.4 setTabAt 123static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v) &#123; U.putObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, v);&#125; ##2.5 resizeStampresizeStamp ç”¨æ¥ç”Ÿæˆä¸€ä¸ªå’Œæ‰©å®¹æœ‰å…³çš„æ‰©å®¹æˆ³ï¼Œå…·ä½“æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ 123static final int resizeStamp(int n) &#123; return Integer.numberOfLeadingZeros(n) | (1 &lt;&lt; (RESIZE_STAMP_BITS - 1));&#125; Integer.numberOfLeadingZeros è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›æ— ç¬¦å·æ•´æ•° n æœ€é«˜ä½é 0 ä½å‰é¢çš„ 0 çš„ä¸ªæ•°ã€‚ æ¯”å¦‚ 10 çš„äºŒè¿›åˆ¶æ˜¯ 0000 0000 0000 0000 0000 0000 0000 1010ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•è¿”å›çš„å€¼å°±æ˜¯ 28ã€‚ æ ¹æ® resizeStamp çš„è¿ç®—é€»è¾‘ï¼Œæˆ‘ä»¬æ¥æ¨æ¼”ä¸€ä¸‹ï¼Œå‡å¦‚ n=16ï¼Œé‚£ä¹ˆ resizeStamp(16)=32796è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ˜¯[0000 0000 0000 0000 1000 0000 0001 1100] æ¥ç€å†æ¥çœ‹,å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç ï¼š U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)rs å·¦ç§» 16 ä½ï¼Œç›¸å½“äºåŸæœ¬çš„äºŒè¿›åˆ¶ä½ä½å˜æˆäº†é«˜ä½ 1000 0000 0001 1100 0000 0000 00000000 ç„¶åå†+2 =1000 0000 0001 1100 0000 0000 0000 0000+10=1000 0000 0001 1100 0000 00000000 0010 é«˜ 16 ä½ä»£è¡¨æ‰©å®¹çš„æ ‡è®°ã€ä½ 16 ä½ä»£è¡¨å¹¶è¡Œæ‰©å®¹çš„çº¿ç¨‹æ•° è¿™æ ·æ¥å­˜å‚¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ 1ï¼Œé¦–å…ˆåœ¨ CHM ä¸­æ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰çš„æ•°ç»„éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹æ¥å…±åŒè´Ÿè´£ 2ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡æ‰©å®¹éƒ½ç”Ÿæˆå”¯ä¸€çš„ç”Ÿæˆæˆ³ï¼Œæ¯æ¬¡æ–°çš„æ‰©å®¹ï¼Œéƒ½æœ‰ä¸€ä¸ªä¸åŒçš„ nï¼Œè¿™ä¸ªç”Ÿæˆæˆ³å°±æ˜¯æ ¹æ® n æ¥è®¡ç®—å‡ºæ¥çš„ä¸€ä¸ªæ•°å­—ï¼Œn ä¸åŒï¼Œè¿™ä¸ªæ•°å­—ä¹Ÿä¸åŒ ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•æ‰©å®¹çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯+2 å› ä¸º 1 è¡¨ç¤ºåˆå§‹åŒ–ï¼Œ2 è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹ï¼Œè€Œä¸”å¯¹ sizeCtl çš„æ“ä½œéƒ½æ˜¯åŸºäºä½è¿ç®—çš„ï¼Œæ‰€ä»¥ä¸ä¼šå…³å¿ƒå®ƒæœ¬èº«çš„æ•°å€¼æ˜¯å¤šå°‘ï¼Œåªå…³å¿ƒå®ƒåœ¨äºŒè¿›åˆ¶ä¸Šçš„æ•°å€¼ï¼Œè€Œ sc + 1 ä¼šåœ¨ä½ 16 ä½ä¸ŠåŠ  1ã€‚##2.6 tableSizeForç»è¿‡å¤šæ¬¡ä½ç§»è¿”å›å¤§äºç­‰äºcçš„æœ€å°çš„äºŒæ¬¡æ–¹æ•° 1234567891011121314151617181920 /** * Returns a power of two table size for the given desired capacity. * See Hackers Delight, sec 3.2 * è¿”å›&gt;=cçš„æœ€å°çš„2çš„æ¬¡æ–¹æ•° * c=28 * n=27 =&gt; 0b 11011 * 11011 | 01101 =&gt; 11111 * 11111 | 00111 =&gt; 11111 * .... * =&gt; 11111 + 1 =100000 = 32 */private static final int tableSizeFor(int c) &#123; int n = c - 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;&#125; #3. æ„é€ æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public ConcurrentHashMap() &#123;&#125;public ConcurrentHashMap(int initialCapacity) &#123; if (initialCapacity &lt; 0) throw new IllegalArgumentException(); //å¦‚æœæŒ‡å®šçš„å®¹é‡è¶…è¿‡å…è®¸çš„æœ€å¤§å€¼ï¼Œè®¾ç½®ä¸ºæœ€å¤§å€¼ int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1)); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125;public ConcurrentHashMap(Map&lt;? extends K, ? extends V&gt; m) &#123; this.sizeCtl = DEFAULT_CAPACITY; putAll(m);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor) &#123; this(initialCapacity, loadFactor, 1);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) &#123; //å‚æ•°æ ¡éªŒ if (!(loadFactor &gt; 0.0f) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0) throw new IllegalArgumentException(); //å¦‚æœåˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«ï¼Œé‚£å°±è®¾ç½®åˆå§‹å®¹é‡ä¸ºå¹¶å‘çº§åˆ« if (initialCapacity &lt; concurrencyLevel) initialCapacity = concurrencyLevel; //16/0.75 +1 = 22 long size = (long)(1.0 + (long)initialCapacity / loadFactor); // 22 - &gt; 32 int cap = (size &gt;= (long)MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)size); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125; #4.put 1234public V put(K key, V value) &#123; //å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Œé»˜è®¤æ˜¯false return putVal(key, value, false);&#125; #5 putVal 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129final V putVal(K key, V value, boolean onlyIfAbsent) &#123; //æ§åˆ¶k å’Œ v ä¸èƒ½ä¸ºnull if (key == null || value == null) throw new NullPointerException(); //é€šè¿‡spreadæ–¹æ³•ï¼Œå¯ä»¥è®©é«˜ä½ä¹Ÿèƒ½å‚ä¸è¿›å¯»å€è¿ç®—ã€‚ int hash = spread(key.hashCode()); //binCountè¡¨ç¤ºå½“å‰k-v å°è£…æˆnodeåæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½® //0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸ºnullï¼Œnodeå¯ä»¥ç›´æ¥æ”¾ç€ //2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»å¯èƒ½æ˜¯çº¢é»‘æ ‘ int binCount = 0; //tab å¼•ç”¨mapå¯¹è±¡çš„table //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //f è¡¨ç¤ºæ¡¶ä½çš„å¤´ç»“ç‚¹ //n è¡¨ç¤ºæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ //i è¡¨ç¤ºkeyé€šè¿‡å¯»å€è®¡ç®—åï¼Œå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ //fh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„hashå€¼ Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼šæˆç«‹ï¼Œè¡¨ç¤ºå½“å‰mapä¸­çš„tableå°šæœªåˆå§‹åŒ–.. if (tab == null || (n = tab.length) == 0) //æœ€ç»ˆå½“å‰çº¿ç¨‹éƒ½ä¼šè·å–åˆ°æœ€æ–°çš„map.tableå¼•ç”¨ã€‚ tab = initTable(); //CASE2ï¼ši è¡¨ç¤ºkeyä½¿ç”¨è·¯ç”±å¯»å€ç®—æ³•å¾—åˆ° keyå¯¹åº” tableæ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹ f else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123; //è¿›å…¥åˆ°CASE2ä»£ç å— å‰ç½®æ¡ä»¶ å½“å‰tableæ•°ç»„iæ¡¶ä½æ˜¯Nullæ—¶ã€‚ //ä½¿ç”¨CASæ–¹å¼ è®¾ç½® æŒ‡å®šæ•°ç»„iæ¡¶ä½ ä¸º new Node&lt;K,V&gt;(hash, key, value, null),å¹¶ä¸”æœŸæœ›å€¼æ˜¯null //casæ“ä½œæˆåŠŸ è¡¨ç¤ºokï¼Œç›´æ¥break forå¾ªç¯å³å¯ //casæ“ä½œå¤±è´¥ï¼Œè¡¨ç¤ºåœ¨å½“å‰çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å…¶å®ƒçº¿ç¨‹å…ˆä½ ä¸€æ­¥å‘æŒ‡å®šiæ¡¶ä½è®¾ç½®å€¼äº†ã€‚ //å½“å‰çº¿ç¨‹åªèƒ½å†æ¬¡è‡ªæ—‹ï¼Œå»èµ°å…¶å®ƒé€»è¾‘ã€‚ if (casTabAt(tab, i, null, new Node&lt;K,V&gt;(hash, key, value, null))) break; // no lock when adding to empty bin &#125; //CASE3ï¼šå‰ç½®æ¡ä»¶ï¼Œæ¡¶ä½çš„å¤´ç»“ç‚¹ä¸€å®šä¸æ˜¯nullã€‚ //æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ ä¸º FWDç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰mapæ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­.. else if ((fh = f.hash) == MOVED) //çœ‹åˆ°fwdèŠ‚ç‚¹åï¼Œå½“å‰èŠ‚ç‚¹æœ‰ä¹‰åŠ¡å¸®åŠ©å½“å‰mapå¯¹è±¡å®Œæˆè¿ç§»æ•°æ®çš„å·¥ä½œ //å¸®åŠ©æ‰©å®¹ tab = helpTransfer(tab, f); //CASE4ï¼šå½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else &#123; //å½“æ’å…¥keyå­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™oldValï¼Œè¿”å›ç»™putæ–¹æ³•è°ƒç”¨å¤„.. V oldVal = null; //ä½¿ç”¨sync åŠ é”â€œå¤´èŠ‚ç‚¹â€ï¼Œç†è®ºä¸Šæ˜¯â€œå¤´ç»“ç‚¹â€ synchronized (f) &#123; //ä¸ºä»€ä¹ˆåˆè¦å¯¹æ¯”ä¸€ä¸‹ï¼Œçœ‹çœ‹å½“å‰æ¡¶ä½çš„å¤´èŠ‚ç‚¹ æ˜¯å¦ä¸º ä¹‹å‰è·å–çš„å¤´ç»“ç‚¹ï¼Ÿ //ä¸ºäº†é¿å…å…¶å®ƒçº¿ç¨‹å°†è¯¥æ¡¶ä½çš„å¤´ç»“ç‚¹ä¿®æ”¹æ‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ä»sync åŠ é” å°±æœ‰é—®é¢˜äº†ã€‚ä¹‹åæ‰€æœ‰æ“ä½œéƒ½ä¸ç”¨åœ¨åšäº†ã€‚ if (tabAt(tab, i) == f) &#123;//æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å’±ä»¬ åŠ é” çš„å¯¹è±¡æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥è¿›æ¥é€ äº†ï¼ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰æ¡¶ä½å°±æ˜¯æ™®é€šé“¾è¡¨æ¡¶ä½ã€‚ if (fh &gt;= 0) &#123; //1.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­æ‰€æœ‰å…ƒç´ çš„keyéƒ½ä¸ä¸€è‡´æ—¶ï¼Œå½“å‰çš„æ’å…¥æ“ä½œæ˜¯è¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ //2.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­çš„æŸä¸ªå…ƒç´ çš„keyä¸€è‡´æ—¶ï¼Œå½“å‰æ’å…¥æ“ä½œå¯èƒ½å°±æ˜¯æ›¿æ¢äº†ã€‚binCountè¡¨ç¤ºå†²çªä½ç½®ï¼ˆbinCount - 1ï¼‰ binCount = 1; //è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œeæ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ã€‚ for (Node&lt;K,V&gt; e = f;; ++binCount) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹ key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash æˆç«‹ è¡¨ç¤ºå¾ªç¯çš„å½“å‰å…ƒç´ çš„hashå€¼ä¸æ’å…¥èŠ‚ç‚¹çš„hashå€¼ä¸€è‡´ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ //æ¡ä»¶äºŒï¼š((ek = e.key) == key ||(ek != null &amp;&amp; key.equals(ek))) // æˆç«‹ï¼šè¯´æ˜å¾ªç¯çš„å½“å‰èŠ‚ç‚¹ä¸æ’å…¥èŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå‘ç”Ÿå†²çªäº† if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å°†å½“å‰å¾ªç¯çš„å…ƒç´ çš„ å€¼ èµ‹å€¼ç»™oldVal oldVal = e.val; if (!onlyIfAbsent) e.val = value; break; &#125; //å½“å‰å…ƒç´  ä¸ æ’å…¥å…ƒç´ çš„keyä¸ä¸€è‡´ æ—¶ï¼Œä¼šèµ°ä¸‹é¢ç¨‹åºã€‚ //1.æ›´æ–°å¾ªç¯å¤„ç†èŠ‚ç‚¹ä¸º å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ //2.åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯nullï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æ˜¯é˜Ÿå°¾äº†ï¼Œæ’å…¥æ•°æ®éœ€è¦è¿½åŠ åˆ°é˜Ÿå°¾èŠ‚ç‚¹çš„åé¢ã€‚ Node&lt;K,V&gt; pred = e; if ((e = e.next) == null) &#123; pred.next = new Node&lt;K,V&gt;(hash, key, value, null); break; &#125; &#125; &#125; //å‰ç½®æ¡ä»¶ï¼Œè¯¥æ¡¶ä½ä¸€å®šä¸æ˜¯é“¾è¡¨ //æ¡ä»¶æˆç«‹ï¼Œè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //p è¡¨ç¤ºçº¢é»‘æ ‘ä¸­å¦‚æœä¸ä½ æ’å…¥èŠ‚ç‚¹çš„key æœ‰å†²çªèŠ‚ç‚¹çš„è¯ ï¼Œåˆ™putTreeVal æ–¹æ³• ä¼šè¿”å›å†²çªèŠ‚ç‚¹çš„å¼•ç”¨ã€‚ Node&lt;K,V&gt; p; //å¼ºåˆ¶è®¾ç½®binCountä¸º2ï¼Œå› ä¸ºbinCount &lt;= 1 æ—¶æœ‰å…¶å®ƒå«ä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºäº†2 binCount = 2; //æ¡ä»¶ä¸€ï¼šæˆç«‹ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„keyä¸çº¢é»‘æ ‘ä¸­çš„æŸä¸ªèŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå†²çªäº† if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != null) &#123; //å°†å†²çªèŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal oldVal = p.val; if (!onlyIfAbsent) p.val = value; &#125; &#125; &#125; &#125; //è¯´æ˜å½“å‰æ¡¶ä½ä¸ä¸ºnullï¼Œå¯èƒ½æ˜¯çº¢é»‘æ ‘ ä¹Ÿå¯èƒ½æ˜¯é“¾è¡¨ if (binCount != 0) &#123; //å¦‚æœbinCount&gt;=8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ if (binCount &gt;= TREEIFY_THRESHOLD) //è°ƒç”¨è½¬åŒ–é“¾è¡¨ä¸ºçº¢é»‘æ ‘çš„æ–¹æ³• treeifyBin(tab, i); //è¯´æ˜å½“å‰çº¿ç¨‹æ’å…¥çš„æ•°æ®keyï¼Œä¸åŸæœ‰k-vå‘ç”Ÿå†²çªï¼Œéœ€è¦å°†åŸæ•°æ®vè¿”å›ç»™è°ƒç”¨è€…ã€‚ if (oldVal != null) return oldVal; break; &#125; &#125; &#125; //1.ç»Ÿè®¡å½“å‰tableä¸€å…±æœ‰å¤šå°‘æ•°æ® //2.åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹ã€‚ addCount(1L, binCount); return null;&#125; #6 initTableæ•°ç»„åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ã€‚ sizeCtl ï¼šè¿™ä¸ªæ ‡å¿—æ˜¯åœ¨ Node æ•°ç»„åˆå§‹åŒ–æˆ–è€…æ‰©å®¹çš„æ—¶å€™çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†ï¼Œè´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–è€…æ‰©å®¹æ“ä½œã€‚ -1 ä»£è¡¨æ­£åœ¨åˆå§‹åŒ– -N ä»£è¡¨æœ‰ N-1 ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè¿™é‡Œä¸æ˜¯ç®€å•çš„ç†è§£æˆ n ä¸ªçº¿ç¨‹ï¼ŒsizeCtl å°±æ˜¯-N 0 æ ‡è¯† Node æ•°ç»„è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ­£æ•°ä»£è¡¨åˆå§‹åŒ–æˆ–è€…ä¸‹ä¸€æ¬¡æ‰©å®¹çš„å¤§å° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/** * Initializes table, using the size recorded in sizeCtl. * * sizeCtl &lt; 0 * * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * * * sizeCtl &gt; 0 * * * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private final Node&lt;K,V&gt;[] initTable() &#123; //tab å¼•ç”¨map.table //sc sizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab; int sc; //è‡ªæ—‹ æ¡ä»¶ï¼šmap.table å°šæœªåˆå§‹åŒ– while ((tab = table) == null || tab.length == 0) &#123; if ((sc = sizeCtl) &lt; 0) //å¤§æ¦‚ç‡å°±æ˜¯-1ï¼Œè¡¨ç¤ºå…¶å®ƒçº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ›å»ºtableçš„è¿‡ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ²¡æœ‰ç«äº‰åˆ°åˆå§‹åŒ–tableçš„é”ã€‚ Thread.yield(); // lost initialization race; just spin //1.sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° //2.å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° //3.å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123; try &#123; //è¿™é‡Œä¸ºä»€ä¹ˆåˆè¦åˆ¤æ–­å‘¢ï¼Ÿ é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œç„¶åå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–..å¯¼è‡´ä¸¢å¤±æ•°æ®ã€‚ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å…¶å®ƒçº¿ç¨‹éƒ½æ²¡æœ‰è¿›å…¥è¿‡è¿™ä¸ªifå—ï¼Œå½“å‰çº¿ç¨‹å°±æ˜¯å…·å¤‡åˆå§‹åŒ–tableæƒåˆ©äº†ã€‚ if ((tab = table) == null || tab.length == 0) &#123; //scå¤§äº0 åˆ›å»ºtableæ—¶ ä½¿ç”¨ scä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼. int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY; @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n]; //æœ€ç»ˆèµ‹å€¼ç»™ map.table table = tab = nt; //n &gt;&gt;&gt; 2 =&gt; ç­‰äº 1/4 n n - (1/4)n = 3/4 n =&gt; 0.75 * n //sc 0.75 n è¡¨ç¤ºä¸‹ä¸€æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ã€‚ sc = n - (n &gt;&gt;&gt; 2); &#125; &#125; finally &#123; //1.å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹è¯ï¼Œscè¡¨ç¤ºçš„æ˜¯ ä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼ //2.è¡¨ç¤ºå½“å‰çº¿ç¨‹ å¹¶ä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥åˆ°else if å— æ—¶ï¼Œå°† //sizeCtl è®¾ç½®ä¸ºäº†-1 ï¼Œé‚£ä¹ˆè¿™æ—¶éœ€è¦å°†å…¶ä¿®æ”¹ä¸º è¿›å…¥æ—¶çš„å€¼ã€‚ sizeCtl = sc; &#125; break; &#125; &#125; return tab;&#125; #7 addCount 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124private final void addCount(long x, int check) &#123; //as è¡¨ç¤º LongAdder.cells //b è¡¨ç¤ºLongAdder.base //s è¡¨ç¤ºå½“å‰map.tableä¸­å…ƒç´ çš„æ•°é‡ CounterCell[] as; long b, s; //æ¡ä»¶ä¸€ï¼štrue-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®ç´¯åŠ åˆ° base //æ¡ä»¶äºŒï¼šfalse-&gt;è¡¨ç¤ºå†™baseæˆåŠŸï¼Œæ•°æ®ç´¯åŠ åˆ°baseä¸­äº†ï¼Œå½“å‰ç«äº‰ä¸æ¿€çƒˆï¼Œä¸éœ€è¦åˆ›å»ºcells // true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ if ((as = counterCells) != null || !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) &#123; //æœ‰å‡ ç§æƒ…å†µè¿›å…¥åˆ°ifå—ä¸­ï¼Ÿ //1.true-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® //2.true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ //a è¡¨ç¤ºå½“å‰çº¿ç¨‹hashå¯»å€å‘½ä¸­çš„cell CounterCell a; //v è¡¨ç¤ºå½“å‰çº¿ç¨‹å†™cellæ—¶çš„æœŸæœ›å€¼ long v; //m è¡¨ç¤ºå½“å‰cellsæ•°ç»„çš„é•¿åº¦ int m; //true -&gt; æœªç«äº‰ false-&gt;å‘ç”Ÿç«äº‰ boolean uncontended = true; //æ¡ä»¶ä¸€ï¼šas == null || (m = as.length - 1) &lt; 0 //true-&gt; è¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯é€šè¿‡ å†™baseç«äº‰å¤±è´¥ ç„¶åè¿›å…¥çš„ifå—ï¼Œå°±éœ€è¦è°ƒç”¨fullAddCountæ–¹æ³•å»æ‰©å®¹ æˆ–è€… é‡è¯•.. LongAdder.longAccumulate //æ¡ä»¶äºŒï¼ša = as[ThreadLocalRandom.getProbe() &amp; m]) == null å‰ç½®æ¡ä»¶ï¼šcellså·²ç»åˆå§‹åŒ–äº† //true-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„cellè¡¨æ ¼æ˜¯ä¸ªç©ºï¼Œéœ€è¦å½“å‰çº¿ç¨‹è¿›å…¥fullAddCountæ–¹æ³•å»åˆå§‹åŒ– cellï¼Œæ”¾å…¥å½“å‰ä½ç½®. //æ¡ä»¶ä¸‰ï¼š!(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x) // false-&gt;å–åå¾—åˆ°falseï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellæˆåŠŸ // true-&gt;å–åå¾—åˆ°true,è¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellå¤±è´¥ï¼Œéœ€è¦è¿›å…¥fullAddCountè¿›è¡Œé‡è¯• æˆ–è€… æ‰©å®¹ cellsã€‚ if (as == null || (m = as.length - 1) &lt; 0 || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null || !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x)) ) &#123; fullAddCount(x, uncontended); //è€ƒè™‘åˆ°fullAddCounté‡Œé¢çš„äº‹æƒ…æ¯”è¾ƒç´¯ï¼Œå°±è®©å½“å‰çº¿ç¨‹ ä¸å‚ä¸åˆ° æ‰©å®¹ç›¸å…³çš„é€»è¾‘äº†ï¼Œç›´æ¥è¿”å›åˆ°è°ƒç”¨ç‚¹ã€‚ return; &#125; if (check &lt;= 1) return; //è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼ s = sumCount(); &#125; //è¡¨ç¤ºä¸€å®šæ˜¯ä¸€ä¸ªputæ“ä½œè°ƒç”¨çš„addCount if (check &gt;= 0) &#123; //tab è¡¨ç¤ºmap.table //nt è¡¨ç¤ºmap.nextTable //n è¡¨ç¤ºmap.tableæ•°ç»„çš„é•¿åº¦ //sc è¡¨ç¤ºsizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab, nt; int n, sc; /** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */ //è‡ªæ—‹ //æ¡ä»¶ä¸€ï¼šs &gt;= (long)(sc = sizeCtl) // true-&gt; 1.å½“å‰sizeCtlä¸ºä¸€ä¸ªè´Ÿæ•° è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­.. // 2.å½“å‰sizeCtlæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼ // false-&gt; è¡¨ç¤ºå½“å‰tableå°šæœªè¾¾åˆ°æ‰©å®¹æ¡ä»¶ //æ¡ä»¶äºŒï¼š(tab = table) != null // æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š(n = tab.length) &lt; MAXIMUM_CAPACITY // true-&gt;å½“å‰tableé•¿åº¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œåˆ™å¯ä»¥è¿›è¡Œæ‰©å®¹ã€‚ while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp; (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123; //æ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ //16 -&gt; 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011 int rs = resizeStamp(n); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰tableæ­£åœ¨æ‰©å®¹ // å½“å‰çº¿ç¨‹ç†è®ºä¸Šåº”è¯¥ååŠ©tableå®Œæˆæ‰©å®¹ if (sc &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼š(nt = nextTable) == null // true-&gt;è¡¨ç¤ºæœ¬æ¬¡æ‰©å®¹ç»“æŸ // false-&gt;æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0) break; //å‰ç½®æ¡ä»¶ï¼šå½“å‰tableæ­£åœ¨æ‰§è¡Œæ‰©å®¹ä¸­.. å½“å‰çº¿ç¨‹æœ‰æœºä¼šå‚ä¸è¿›æ‰©å®¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸå‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå¹¶ä¸”å°†scä½16ä½å€¼åŠ 1ï¼Œè¡¨ç¤ºå¤šäº†ä¸€ä¸ªçº¿ç¨‹å‚ä¸å·¥ä½œ //æ¡ä»¶å¤±è´¥ï¼š1.å½“å‰æœ‰å¾ˆå¤šçº¿ç¨‹éƒ½åœ¨æ­¤å¤„å°è¯•ä¿®æ”¹sizeCtlï¼Œæœ‰å…¶å®ƒä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æˆåŠŸäº†ï¼Œå¯¼è‡´ä½ çš„scæœŸæœ›å€¼ä¸å†…å­˜ä¸­çš„å€¼ä¸ä¸€è‡´ ä¿®æ”¹å¤±è´¥ // 2.transfer ä»»åŠ¡å†…éƒ¨çš„çº¿ç¨‹ä¹Ÿä¿®æ”¹äº†sizeCtlã€‚ if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) //ååŠ©æ‰©å®¹çº¿ç¨‹ï¼ŒæŒæœ‰nextTableå‚æ•° transfer(tab, nt); &#125; //1000 0000 0001 1011 0000 0000 0000 0000 +2 =&gt; 1000 0000 0001 1011 0000 0000 0000 0010 //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨transferæ–¹æ³•éœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)) //è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ ä¸æŒæœ‰nextTable transfer(tab, null); s = sumCount(); &#125; &#125;&#125; #8. transferConcurrentHashMap æ”¯æŒå¹¶å‘æ‰©å®¹ï¼Œå®ç°æ–¹å¼æ˜¯ï¼ŒæŠŠ Node æ•°ç»„è¿›è¡Œæ‹†åˆ†ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†è‡ªå·±çš„åŒºåŸŸï¼Œå‡è®¾ table æ•°ç»„æ€»é•¿åº¦æ˜¯ 64ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å¯ä»¥åˆ†åˆ° 16 ä¸ª bucketã€‚ç„¶åæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„èŒƒå›´ï¼ŒæŒ‰ç…§å€’åºæ¥åšè¿ç§»ã€‚ é€šè¿‡ for è‡ªå¾ªç¯å¤„ç†æ¯ä¸ªæ§½ä½ä¸­çš„é“¾è¡¨å…ƒç´ ï¼Œé»˜è®¤ advace ä¸ºçœŸï¼Œé€šè¿‡ CAS è®¾ç½® transferIndexå±æ€§å€¼ï¼Œå¹¶åˆå§‹åŒ– i å’Œ bound å€¼ï¼Œi æŒ‡å½“å‰å¤„ç†çš„æ§½ä½åºå·ï¼Œbound æŒ‡éœ€è¦å¤„ç†çš„æ§½ä½è¾¹ç•Œï¼Œå…ˆå¤„ç†æ§½ä½ 31 çš„èŠ‚ç‚¹ï¼› ï¼ˆbound,iï¼‰ =(16,31) ä» 31 çš„ä½ç½®å¾€å‰æ¨åŠ¨ã€‚ æ¯å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ‰©å®¹æ“ä½œï¼Œå°±é€šè¿‡ cas æ‰§è¡Œ sc-1ã€‚ æ¥ç€åˆ¤æ–­(sc-2) !=resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT ; å¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºå½“å‰ä¸ºæ•´ä¸ªæ‰©å®¹æ“ä½œçš„ æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ„å‘³ç€æ•´ä¸ªæ‰©å®¹æ“ä½œå°±ç»“æŸäº†ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜è¿˜å¾—ç»§ç»­ã€‚ è¿™ä¹ˆåšçš„ç›®çš„ï¼Œä¸€æ–¹é¢æ˜¯é˜²æ­¢ä¸åŒæ‰©å®¹ä¹‹é—´å‡ºç°ç›¸åŒçš„ sizeCtlï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œè¿˜å¯ä»¥é¿å…sizeCtl çš„ ABA é—®é¢˜å¯¼è‡´çš„æ‰©å®¹é‡å çš„æƒ…å†µã€‚ æ‰©å®¹å›¾è§£åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å½“æ›´æ–°åçš„é”®å€¼å¯¹æ€»æ•° baseCount &gt;= é˜ˆå€¼ sizeCtl æ—¶ï¼Œè¿›è¡Œrehashï¼Œè¿™é‡Œé¢ä¼šæœ‰ä¸¤ä¸ªé€»è¾‘ã€‚ å¦‚æœå½“å‰æ­£åœ¨å¤„äºæ‰©å®¹é˜¶æ®µï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šåŠ å…¥å¹¶ä¸”ååŠ©æ‰©å®¹ã€‚ å¦‚æœå½“å‰æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œåˆ™ç›´æ¥è§¦å‘æ‰©å®¹æ“ä½œã€‚ æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®çš„è½¬ç§»å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯æŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ä½†æ˜¯è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåœ¨æ‰©å®¹çš„æ—¶å€™å…¶ä»–çº¿ç¨‹ä¹Ÿå¯èƒ½æ­£åœ¨æ·»åŠ å…ƒç´ ï¼Œè¿™æ—¶åˆè§¦å‘äº†æ‰©å®¹æ€ä¹ˆåŠï¼Ÿå¯èƒ½å¤§å®¶æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åŠ äº’æ–¥é”ï¼ŒæŠŠè½¬ç§»è¿‡ç¨‹é”ä½ï¼Œè™½ç„¶æ˜¯å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¼šå¸¦æ¥è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ã€‚å› ä¸ºäº’æ–¥é”ä¼šå¯¼è‡´æ‰€æœ‰è®¿é—®ä¸´ç•ŒåŒºçš„çº¿ç¨‹é™·å…¥åˆ°é˜»å¡çŠ¶æ€ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹è€—æ—¶è¶Šé•¿ï¼Œå…¶ä»–ç«äº‰çº¿ç¨‹å°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¯¼è‡´ååé‡è¾ƒä½ã€‚è€Œä¸”è¿˜å¯èƒ½å¯¼è‡´æ­»é”ã€‚ è€Œ ConcurrentHashMap å¹¶æ²¡æœ‰ç›´æ¥åŠ é”ï¼Œè€Œæ˜¯é‡‡ç”¨ CAS å®ç°æ— é”çš„å¹¶å‘åŒæ­¥ç­–ç•¥ï¼Œæœ€ç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ã€‚ å®ƒæŠŠ Node æ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹é”è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingNodeèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å®ƒçš„æºç å®ç°ã€‚ fwd:è¿™ä¸ªç±»æ˜¯ä¸ªæ ‡è¯†ç±»ï¼Œç”¨äºæŒ‡å‘æ–°è¡¨ç”¨çš„ï¼Œå…¶ä»–çº¿ç¨‹é‡åˆ°è¿™ä¸ªç±»ä¼šä¸»åŠ¨è·³è¿‡è¿™ä¸ªç±»ï¼Œå› ä¸ºè¿™ä¸ªç±»è¦ä¹ˆå°±æ˜¯æ‰©å®¹è¿ç§»æ­£åœ¨è¿›è¡Œï¼Œè¦ä¹ˆå°±æ˜¯å·²ç»å®Œæˆæ‰©å®¹è¿ç§»ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç±»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå†è¿›è¡Œæ“ä½œã€‚ advance:è¿™ä¸ªå˜é‡æ˜¯ç”¨äºæç¤ºä»£ç æ˜¯å¦è¿›è¡Œæ¨è¿›å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ¡¶å¤„ç†å®Œï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ¡¶çš„æ ‡è¯†ã€‚ finishing:è¿™ä¸ªå˜é‡ç”¨äºæç¤ºæ‰©å®¹æ˜¯å¦ç»“æŸç”¨çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) &#123; //n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰tableæ•°ç»„çš„é•¿åº¦ //stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ int n = tab.length, stride; // stride å›ºå®šä¸º 16 if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE) stride = MIN_TRANSFER_STRIDE; // subdivide range //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯ååŠ©æ‰©å®¹çš„çº¿ç¨‹.. if (nextTab == null) &#123; // initiating try &#123; //åˆ›å»ºäº†ä¸€ä¸ªæ¯”æ‰©å®¹ä¹‹å‰å¤§ä¸€å€çš„table @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1]; nextTab = nt; &#125; catch (Throwable ex) &#123; // try to cope with OOME sizeCtl = Integer.MAX_VALUE; return; &#125; //èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTable ï¼Œæ–¹ä¾¿ååŠ©æ‰©å®¹çº¿ç¨‹ æ‹¿åˆ°æ–°è¡¨ nextTable = nextTab; //è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ã€‚indexè®¡æ•°æ˜¯ä»1å¼€å§‹è®¡ç®—çš„ã€‚ transferIndex = n; &#125; //è¡¨ç¤ºæ–°æ•°ç»„çš„é•¿åº¦ int nextn = nextTab.length; //fwd èŠ‚ç‚¹ï¼Œå½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸ºfwdèŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹ æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œä¼šæœ‰ä¸åŒé€»è¾‘ã€‚ ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab); //æ¨è¿›æ ‡è®° boolean advance = true; //å®Œæˆæ ‡è®° boolean finishing = false; // to ensure sweep before committing nextTab //i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½ //bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ int i = 0, bound = 0; //è‡ªæ—‹ for (;;) &#123; //f æ¡¶ä½çš„å¤´ç»“ç‚¹ //fh å¤´ç»“ç‚¹çš„hash Node&lt;K,V&gt; f; int fh; /** * 1.ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡åŒºé—´ * 2.ç»´æŠ¤å½“å‰çº¿ç¨‹ä»»åŠ¡è¿›åº¦ï¼ˆi è¡¨ç¤ºå½“å‰å¤„ç†çš„æ¡¶ä½ï¼‰ * 3.ç»´æŠ¤mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„è¿›åº¦ */ while (advance) &#123; //åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ //åˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡ int nextIndex, nextBound; //CASE1: //æ¡ä»¶ä¸€ï¼š--i &gt;= bound //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œè¿˜æœ‰ç›¸åº”çš„åŒºé—´çš„æ¡¶ä½è¦å¤„ç†ï¼Œ--i å°±è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ª æ¡¶ä½. //ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… if (--i &gt;= bound || finishing) advance = false; //CASE2: //å‰ç½®æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½éƒ½åˆ†é…å®Œæ¯•äº†ï¼Œæ²¡æœ‰åŒºé—´å¯åˆ†é…äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„iå˜é‡ä¸º-1 è·³å‡ºå¾ªç¯åï¼Œæ‰§è¡Œé€€å‡ºè¿ç§»ä»»åŠ¡ç›¸å…³çš„ç¨‹åº //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½å°šæœªåˆ†é…å®Œæ¯•ï¼Œè¿˜æœ‰åŒºé—´å¯åˆ†é… else if ((nextIndex = transferIndex) &lt;= 0) &#123; i = -1; advance = false; &#125; //CASE3: //å‰ç½®æ¡ä»¶ï¼š1ã€å½“å‰çº¿ç¨‹éœ€è¦åˆ†é…ä»»åŠ¡åŒºé—´ 2.å…¨å±€èŒƒå›´å†…è¿˜æœ‰æ¡¶ä½å°šæœªè¿ç§» //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡æˆåŠŸ //æ¡ä»¶å¤±è´¥ï¼šè¯´æ˜åˆ†é…ç»™å½“å‰çº¿ç¨‹å¤±è´¥ï¼Œåº”è¯¥æ˜¯å’Œå…¶å®ƒçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰å§ else if (U.compareAndSwapInt (this, TRANSFERINDEX, nextIndex, nextBound = (nextIndex &gt; stride ? nextIndex - stride : 0))) &#123; bound = nextBound; i = nextIndex - 1; advance = false; &#125; &#125; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼ši &lt; 0 //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) &#123; //ä¿å­˜sizeCtl çš„å˜é‡ int sc; if (finishing) &#123; nextTable = null; table = nextTab; sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1); return; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜è®¾ç½®sizeCtl ä½16ä½ -1 æˆåŠŸï¼Œå½“å‰çº¿ç¨‹å¯ä»¥æ­£å¸¸é€€å‡º if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) &#123; //1000 0000 0001 1011 0000 0000 0000 0000 //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯æœ€åä¸€ä¸ªé€€å‡ºtransferä»»åŠ¡çš„çº¿ç¨‹ if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) //æ­£å¸¸é€€å‡º return; finishing = advance = true; i = n; // recheck before commit &#125; &#125; //å‰ç½®æ¡ä»¶ï¼šã€CASE2~CASE4ã€‘ å½“å‰çº¿ç¨‹ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œæ­£åœ¨è¿›è¡Œä¸­ //CASE2: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸ºfwdèŠ‚ç‚¹å³å¯ã€‚ else if ((f = tabAt(tab, i)) == null) advance = casTabAt(tab, i, null, fwd); //CASE3: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å†æ¬¡æ›´æ–°å½“å‰çº¿ç¨‹ä»»åŠ¡ç´¢å¼•ï¼Œå†æ¬¡å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½ æˆ–è€… å…¶å®ƒæ“ä½œ else if ((fh = f.hash) == MOVED) advance = true; // already processed //CASE4: //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸”nodeèŠ‚ç‚¹ ä¸æ˜¯ fwdèŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»ã€‚ else &#123; //sync åŠ é”å½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ synchronized (f) &#123; //é˜²æ­¢åœ¨ä½ åŠ é”å¤´å¯¹è±¡ä¹‹å‰ï¼Œå½“å‰æ¡¶ä½çš„å¤´å¯¹è±¡è¢«å…¶å®ƒå†™çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œå¯¼è‡´ä½ ç›®å‰åŠ é”å¯¹è±¡é”™è¯¯... if (tabAt(tab, i) == f) &#123; //ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨ //hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨ Node&lt;K,V&gt; ln, hn; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½ if (fh &gt;= 0) &#123; //lastRun //å¯ä»¥è·å–å‡º å½“å‰é“¾è¡¨ æœ«å°¾è¿ç»­é«˜ä½ä¸å˜çš„ node int runBit = fh &amp; n; Node&lt;K,V&gt; lastRun = f; for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º ä½ä½é“¾è¡¨ï¼Œé‚£ä¹ˆå°±è®© ln æŒ‡å‘ ä½ä½é“¾è¡¨ if (runBit == 0) &#123; ln = lastRun; hn = null; &#125; //å¦åˆ™ï¼Œè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º é«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘ é«˜ä½é“¾è¡¨ else &#123; hn = lastRun; ln = null; &#125; for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn); &#125; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //è½¬æ¢å¤´ç»“ç‚¹ä¸º treeBinå¼•ç”¨ t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //ä½ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘ä½ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘ä½ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; lo = null, loTail = null; //é«˜ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘é«˜ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘é«˜ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; hi = null, hiTail = null; //lc è¡¨ç¤ºä½ä½é“¾è¡¨å…ƒç´ æ•°é‡ //hc è¡¨ç¤ºé«˜ä½é“¾è¡¨å…ƒç´ æ•°é‡ int lc = 0, hc = 0; //è¿­ä»£TreeBinä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹ è‡³ å°¾èŠ‚ç‚¹ for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) &#123; // h è¡¨ç¤ºå¾ªç¯å¤„ç†å½“å‰å…ƒç´ çš„ hash int h = e.hash; //ä½¿ç”¨å½“å‰èŠ‚ç‚¹ æ„å»ºå‡ºæ¥çš„ æ–°çš„ TreeNode TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt; (h, e.key, e.val, null, null); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹ å±äºä½ä½é“¾ èŠ‚ç‚¹ if ((h &amp; n) == 0) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä½ä½é“¾è¡¨ è¿˜æ²¡æœ‰æ•°æ® if ((p.prev = loTail) == null) lo = p; //è¯´æ˜ ä½ä½é“¾è¡¨å·²ç»æœ‰æ•°æ®äº†ï¼Œæ­¤æ—¶å½“å‰å…ƒç´  è¿½åŠ åˆ° ä½ä½é“¾è¡¨çš„æœ«å°¾å°±è¡Œäº† else loTail.next = p; //å°†ä½ä½é“¾è¡¨å°¾æŒ‡é’ˆæŒ‡å‘ p èŠ‚ç‚¹ loTail = p; ++lc; &#125; //å½“å‰èŠ‚ç‚¹ å±äº é«˜ä½é“¾ èŠ‚ç‚¹ else &#123; if ((p.prev = hiTail) == null) hi = p; else hiTail.next = p; hiTail = p; ++hc; &#125; &#125; ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) : (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t; hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) : (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; &#125; &#125; &#125; &#125;&#125; é“¾è¡¨è¿ç§»åŸç† 1ï¼‰é«˜ä½ä½åŸç†åˆ†æ ConcurrentHashMap åœ¨åšé“¾è¡¨è¿ç§»æ—¶ï¼Œä¼šç”¨é«˜ä½ä½æ¥å®ç°ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜è¦åˆ†æä¸€ä¸‹ 1ï¼Œå¦‚ä½•å®ç°é«˜ä½ä½é“¾è¡¨çš„åŒºåˆ† å‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªé˜Ÿåˆ—ç¬¬ 14 ä¸ªæ§½ä½æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åï¼Œé“¾è¡¨å…ƒç´ ä¸ªæ•°å·²ç»è¾¾åˆ°äº† 8ï¼Œä¸”æ•°ç»„é•¿åº¦ä¸º 16ï¼Œä¼˜å…ˆé€šè¿‡æ‰©å®¹æ¥ç¼“è§£é“¾è¡¨è¿‡é•¿çš„é—®é¢˜ å‡å¦‚å½“å‰çº¿ç¨‹æ­£åœ¨å¤„ç†æ§½ä½ä¸º 14 çš„èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œåœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆå®šä¹‰ä¸¤ä¸ªå˜é‡èŠ‚ç‚¹ ln å’Œ hnï¼Œå®é™…å°±æ˜¯ lowNode å’Œ HighNodeï¼Œåˆ†åˆ«ä¿å­˜ hash å€¼çš„ç¬¬ x ä½ä¸º 0 å’Œä¸ç­‰äº0 çš„èŠ‚ç‚¹ é€šè¿‡ fn&amp;n å¯ä»¥æŠŠè¿™ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ åˆ†ä¸ºä¸¤ç±»ï¼ŒA ç±»æ˜¯ hash å€¼çš„ç¬¬ X ä½ä¸º 0ï¼ŒB ç±»æ˜¯ hash å€¼çš„ç¬¬ x ä½ä¸ºä¸ç­‰äº 0ï¼ˆè‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåŒºåˆ†ï¼Œç¨ååˆ†æï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ lastRun è®°å½•æœ€åè¦å¤„ç†çš„èŠ‚ç‚¹ã€‚æœ€ç»ˆè¦è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼ŒA ç±»çš„é“¾è¡¨ä¿æŒä½ç½®ä¸åŠ¨ï¼ŒB ç±»çš„é“¾è¡¨ä¸º 14+16(æ‰©å®¹å¢åŠ çš„é•¿åº¦)=30 æŠŠ 14 æ§½ä½çš„é“¾è¡¨å•ç‹¬ä¼¶å‡ºæ¥ï¼Œç”¨è“è‰²è¡¨ç¤º fn&amp;n=0 çš„èŠ‚ç‚¹ï¼Œå‡å¦‚é“¾è¡¨çš„åˆ†ç±»æ˜¯è¿™æ · 1234567for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125;&#125; é€šè¿‡ä¸Šé¢è¿™æ®µä»£ç éå†ï¼Œä¼šè®°å½• runBit ä»¥åŠ lastRunï¼ŒæŒ‰ç…§ä¸Šé¢è¿™ä¸ªç»“æ„ï¼Œé‚£ä¹ˆ runBit åº”è¯¥æ˜¯è“è‰²èŠ‚ç‚¹ï¼ŒlastRun åº”è¯¥æ˜¯ç¬¬ 6 ä¸ªèŠ‚ç‚¹æ¥ç€ï¼Œå†é€šè¿‡è¿™æ®µä»£ç è¿›è¡Œéå†ï¼Œç”Ÿæˆ ln é“¾ä»¥åŠ hn é“¾ 1234567for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);&#125; æ¥ç€ï¼Œé€šè¿‡ CAS æ“ä½œï¼ŒæŠŠ hn é“¾æ”¾åœ¨ i+n ä¹Ÿå°±æ˜¯ 14+16 çš„ä½ç½®ï¼Œln é“¾ä¿æŒåŸæ¥çš„ä½ç½®ä¸åŠ¨ã€‚å¹¶ä¸”è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º fwdï¼Œè¡¨ç¤ºå·²ç»è¢«å½“å‰çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ 123setTabAt(nextTab, i, ln);setTabAt(nextTab, i + n, hn);setTabAt(tab, i, fwd); è¿ç§»å®Œæˆä»¥åçš„æ•°æ®åˆ†å¸ƒå¦‚ä¸‹ 2)ä¸ºä»€ä¹ˆè¦åšé«˜ä½ä½çš„åˆ’åˆ† è¦æƒ³äº†è§£è¿™ä¹ˆè®¾è®¡çš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦ä» ConcurrentHashMap çš„æ ¹æ®ä¸‹æ ‡è·å–å¯¹è±¡çš„ç®—æ³•æ¥çœ‹ï¼Œåœ¨ putVal æ–¹æ³•ä¸­ 1018 è¡Œï¼š (f = tabAt(tab, i = (n - 1) &amp; hash)) == null é€šè¿‡(n-1) &amp; hash æ¥è·å¾—åœ¨ table ä¸­çš„æ•°ç»„ä¸‹æ ‡æ¥è·å–èŠ‚ç‚¹æ•°æ®ï¼Œã€&amp;è¿ç®—æ˜¯äºŒè¿›åˆ¶è¿ç®—ç¬¦ï¼Œ1&amp; 1=1ï¼Œå…¶ä»–éƒ½ä¸º 0ã€‘ã€‚ #9.helpTransferå¦‚æœå¯¹åº”çš„èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ hash æ˜¯ä¸æ˜¯ç­‰äº MOVED(-1)ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ForwardingNode èŠ‚ç‚¹ï¼Œæ„å‘³ç€æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé‚£ä¹ˆå½“å‰ç°åœ¨ç›´æ¥å¸®åŠ©å®ƒè¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤è°ƒç”¨ helpTransferæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455final Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123; //nextTab å¼•ç”¨çš„æ˜¯ fwd.nextTable == map.nextTable ç†è®ºä¸Šæ˜¯è¿™æ ·ã€‚ //sc ä¿å­˜map.sizeCtl Node&lt;K,V&gt;[] nextTab; int sc; //æ¡ä»¶ä¸€ï¼štab != null æ’æˆç«‹ true //æ¡ä»¶äºŒï¼š(f instanceof ForwardingNode) æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š((ForwardingNode&lt;K,V&gt;)f).nextTable) != null æ’æˆç«‹ true if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp; (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != null) &#123; //æ‹¿å½“å‰æ ‡çš„é•¿åº¦ è·å– æ‰©å®¹æ ‡è¯†æˆ³ å‡è®¾ 16 -&gt; 32 æ‰©å®¹ï¼š1000 0000 0001 1011 int rs = resizeStamp(tab.length); //æ¡ä»¶ä¸€ï¼šnextTab == nextTable //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼š1.nextTableè¢«è®¾ç½®ä¸ºNull äº†ï¼Œæ‰©å®¹å®Œæ¯•åï¼Œä¼šè¢«è®¾ä¸ºNull // 2.å†æ¬¡å‡ºå‘æ‰©å®¹äº†...å’±ä»¬æ‹¿åˆ°çš„nextTab ä¹Ÿå·²ç»è¿‡æœŸäº†... //æ¡ä»¶äºŒï¼štable == tab //æˆç«‹ï¼šè¯´æ˜ æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¿˜æœªå®Œæˆ //ä¸æˆç«‹ï¼šè¯´æ˜æ‰©å®¹å·²ç»ç»“æŸäº†ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œæœ€åé€€å‡ºçš„çº¿ç¨‹ ä¼šè®¾ç½® nextTable ä¸º table //æ¡ä»¶ä¸‰ï¼š(sc = sizeCtl) &lt; 0 //æˆç«‹ï¼šè¯´æ˜æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼šè¯´æ˜sizeCtlå½“å‰æ˜¯ä¸€ä¸ªå¤§äº0çš„æ•°ï¼Œæ­¤æ—¶ä»£è¡¨ä¸‹æ¬¡æ‰©å®¹çš„é˜ˆå€¼ï¼Œå½“å‰æ‰©å®¹å·²ç»ç»“æŸã€‚ while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼štransferIndex &lt;= 0 // true-&gt;è¯´æ˜mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„ä»»åŠ¡å·²ç»åˆ†é…å®Œäº†ï¼Œå½“å‰çº¿ç¨‹è¿›å»ä¹Ÿæ²¡æ´»å¹².. // false-&gt;è¿˜æœ‰ä»»åŠ¡å¯ä»¥åˆ†é…ã€‚ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || transferIndex &lt;= 0) break; if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) &#123; transfer(tab, nextTab); break; &#125; &#125; return nextTab; &#125; return table;&#125; #10.get 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public V get(Object key) &#123; //tab å¼•ç”¨map.table //e å½“å‰å…ƒç´  //p ç›®æ ‡èŠ‚ç‚¹ //n tableæ•°ç»„é•¿åº¦ //eh å½“å‰å…ƒç´ hash //ek å½“å‰å…ƒç´ key Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek; //æ‰°åŠ¨è¿ç®—åå¾—åˆ° æ›´æ•£åˆ—çš„hashå€¼ int h = spread(key.hashCode()); //æ¡ä»¶ä¸€ï¼š(tab = table) != null //true-&gt;è¡¨ç¤ºå·²ç»putè¿‡æ•°æ®ï¼Œå¹¶ä¸”mapå†…éƒ¨çš„tableä¹Ÿå·²ç»åˆå§‹åŒ–å®Œæ¯• //false-&gt;è¡¨ç¤ºåˆ›å»ºå®Œmapåï¼Œå¹¶æ²¡æœ‰putè¿‡æ•°æ®ï¼Œmapå†…éƒ¨çš„tableæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å†™æ•°æ®æ—¶ä¼šè§¦å‘åˆ›å»ºé€»è¾‘ã€‚ //æ¡ä»¶äºŒï¼š(n = tab.length) &gt; 0 true-&gt;è¡¨ç¤ºtableå·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(e = tabAt(tab, (n - 1) &amp; h)) != null //true-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ æœ‰å€¼ //false-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ä¸­æ˜¯nullï¼Œæ˜¯nullç›´æ¥è¿”å›null if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123; //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ® //å¯¹æ¯”å¤´ç»“ç‚¹hashä¸æŸ¥è¯¢keyçš„hashæ˜¯å¦ä¸€è‡´ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹ä¸æŸ¥è¯¢Keyçš„hashå€¼ å®Œå…¨ä¸€è‡´ if ((eh = e.hash) == h) &#123; //å®Œå…¨æ¯”å¯¹ æŸ¥è¯¢key å’Œ å¤´ç»“ç‚¹çš„key //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹å°±æ˜¯æŸ¥è¯¢æ•°æ® if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) return e.val; &#125; //æ¡ä»¶æˆç«‹ï¼š //1.-1 fwd è¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ï¼Œä¸”å½“å‰æŸ¥è¯¢çš„è¿™ä¸ªæ¡¶ä½çš„æ•°æ® å·²ç»è¢«è¿ç§»èµ°äº† //2.-2 TreeBinèŠ‚ç‚¹ï¼Œéœ€è¦ä½¿ç”¨TreeBin æä¾›çš„find æ–¹æ³•æŸ¥è¯¢ã€‚ else if (eh &lt; 0) return (p = e.find(h, key)) != null ? p.val : null; //å½“å‰æ¡¶ä½å·²ç»å½¢æˆé“¾è¡¨çš„è¿™ç§æƒ…å†µ while ((e = e.next) != null) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) return e.val; &#125; &#125; return null;&#125; #11.remove 123public V remove(Object key) &#123; return replaceNode(key, null, null);&#125; #12.replaceNode 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143final V replaceNode(Object key, V value, Object cv) &#123; //è®¡ç®—keyç»è¿‡æ‰°åŠ¨è¿ç®—åçš„hash int hash = spread(key.hashCode()); //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //fè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ //nè¡¨ç¤ºå½“å‰tableæ•°ç»„é•¿åº¦ //iè¡¨ç¤ºhashå‘½ä¸­æ¡¶ä½ä¸‹æ ‡ //fhè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ hash Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼štab == null true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶äºŒï¼š(n = tab.length) == 0 true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(f = tabAt(tab, i = (n - 1) &amp; hash)) == null true -&gt; è¡¨ç¤ºå‘½ä¸­æ¡¶ä½ä¸­ä¸ºnullï¼Œç›´æ¥breakï¼Œ ä¼šè¿”å› if (tab == null || (n = tab.length) == 0 || (f = tabAt(tab, i = (n - 1) &amp; hash)) == null) break; //CASE2ï¼š //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ä¸­ï¼Œå½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ©tableå®Œæˆæ‰©å®¹ã€‚ else if ((fh = f.hash) == MOVED) tab = helpTransfer(tab, f); //CASE3: //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //å½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ &quot;é“¾è¡¨&quot; ä¹Ÿå¯èƒ½ æ˜¯ &quot;çº¢é»‘æ ‘&quot; TreeBin else &#123; //ä¿ç•™æ›¿æ¢ä¹‹å‰çš„æ•°æ®å¼•ç”¨ V oldVal = null; //æ ¡éªŒæ ‡è®° boolean validated = false; //åŠ é”å½“å‰æ¡¶ä½ å¤´ç»“ç‚¹ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ ä»£ç å—ã€‚ synchronized (f) &#123; //åˆ¤æ–­syncåŠ é”æ˜¯å¦ä¸ºå½“å‰æ¡¶ä½ å¤´èŠ‚ç‚¹ï¼Œé˜²æ­¢å…¶å®ƒçº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹åŠ é”æˆåŠŸä¹‹å‰ï¼Œä¿®æ”¹è¿‡ æ¡¶ä½ çš„å¤´ç»“ç‚¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šå½“å‰æ¡¶ä½å¤´ç»“ç‚¹ ä»ç„¶ä¸ºfï¼Œå…¶å®ƒçº¿ç¨‹æ²¡ä¿®æ”¹è¿‡ã€‚ if (tabAt(tab, i) == f) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ¡¶ä½ ä¸º é“¾è¡¨ æˆ–è€… å•ä¸ª node if (fh &gt;= 0) &#123; validated = true; //e è¡¨ç¤ºå½“å‰å¾ªç¯å¤„ç†å…ƒç´  //pred è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ Node&lt;K,V&gt; e = f, pred = null; for (;;) &#123; //å½“å‰èŠ‚ç‚¹key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash true-&gt;è¯´æ˜å½“å‰èŠ‚ç‚¹çš„hashä¸æŸ¥æ‰¾èŠ‚ç‚¹hashä¸€è‡´ //æ¡ä»¶äºŒï¼š((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) //if æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜key ä¸æŸ¥è¯¢çš„keyå®Œå…¨ä¸€è‡´ã€‚ if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å½“å‰èŠ‚ç‚¹çš„value V ev = e.val; //æ¡ä»¶ä¸€ï¼šcv == null true-&gt;æ›¿æ¢çš„å€¼ä¸ºnull é‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªåˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == ev || (ev != null &amp;&amp; cv.equals(ev)) é‚£ä¹ˆæ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (cv == null || cv == ev || (ev != null &amp;&amp; cv.equals(ev))) &#123; //åˆ é™¤ æˆ–è€… æ›¿æ¢ //å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ° oldVal = ev; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (value != null) //ç›´æ¥æ›¿æ¢ e.val = value; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰èŠ‚ç‚¹éå¤´ç»“ç‚¹ else if (pred != null) //å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ pred.next = e.next; else //è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸º å¤´ç»“ç‚¹ï¼Œåªéœ€è¦å°† æ¡¶ä½è®¾ç½®ä¸ºå¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ setTabAt(tab, i, e.next); &#125; break; &#125; pred = e; if ((e = e.next) == null) break; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šTreeBinèŠ‚ç‚¹ã€‚ else if (f instanceof TreeBin) &#123; validated = true; //è½¬æ¢ä¸ºå®é™…ç±»å‹ TreeBin t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //r è¡¨ç¤º çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ //p è¡¨ç¤º çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾åˆ°å¯¹åº”key ä¸€è‡´çš„node TreeNode&lt;K,V&gt; r, p; //æ¡ä»¶ä¸€ï¼š(r = t.root) != null ç†è®ºä¸Šæ˜¯æˆç«‹ //æ¡ä»¶äºŒï¼šTreeNode.findTreeNode ä»¥å½“å‰èŠ‚ç‚¹ä¸ºå…¥å£ï¼Œå‘ä¸‹æŸ¥æ‰¾keyï¼ˆåŒ…æ‹¬æœ¬èº«èŠ‚ç‚¹ï¼‰ // true-&gt;è¯´æ˜æŸ¥æ‰¾åˆ°ç›¸åº”key å¯¹åº”çš„nodeèŠ‚ç‚¹ã€‚ä¼šèµ‹å€¼ç»™p if ((r = t.root) != null &amp;&amp; (p = r.findTreeNode(hash, key, null)) != null) &#123; //ä¿å­˜p.val åˆ°pv V pv = p.val; //æ¡ä»¶ä¸€ï¼šcv == null æˆç«‹ï¼šä¸å¿…å¯¹valueï¼Œå°±åšæ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == pv ||(pv != null &amp;&amp; cv.equals(pv)) æˆç«‹ï¼šè¯´æ˜â€œå¯¹æ¯”å€¼â€ä¸å½“å‰pèŠ‚ç‚¹çš„å€¼ ä¸€è‡´ if (cv == null || cv == pv || (pv != null &amp;&amp; cv.equals(pv))) &#123; //æ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ oldVal = pv; //æ¡ä»¶æˆç«‹ï¼šæ›¿æ¢æ“ä½œ if (value != null) p.val = value; //åˆ é™¤æ“ä½œ else if (t.removeTreeNode(p)) //è¿™é‡Œæ²¡åšåˆ¤æ–­ï¼Œç›´æ¥æäº†...å¾ˆç–‘æƒ‘ setTabAt(tab, i, untreeify(t.first)); &#125; &#125; &#125; &#125; &#125; //å½“å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½ å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹ é”é”™å¯¹è±¡æ—¶ï¼Œvalidated ä¸ºfalseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡for è‡ªæ—‹ if (validated) &#123; if (oldVal != null) &#123; //æ›¿æ¢çš„å€¼ ä¸ºnullï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼ŒoldVal ï¼=null æˆç«‹ï¼Œè¯´æ˜åˆ é™¤æˆåŠŸï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‚ if (value == null) addCount(-1L, -1); return oldVal; &#125; break; &#125; &#125; &#125; return null;&#125; #13.TreeBin##13.1 å±æ€§ 1234567891011121314151617//çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ TreeNode&lt;K,V&gt; root;//é“¾è¡¨çš„å¤´èŠ‚ç‚¹volatile TreeNode&lt;K,V&gt; first;//ç­‰å¾…è€…çº¿ç¨‹ï¼ˆå½“å‰lockStateæ˜¯è¯»é”çŠ¶æ€ï¼‰volatile Thread waiter;/** * 1.å†™é”çŠ¶æ€ å†™æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ°TreeBinä¸­çš„å†™çº¿ç¨‹ åŒä¸€æ—¶åˆ» åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ 1 * 2.è¯»é”çŠ¶æ€ è¯»é”æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBinå¯¹è±¡ä¸­è·å–æ•°æ®ã€‚ æ¯ä¸€ä¸ªçº¿ç¨‹ éƒ½ä¼šç»™ lockStat + 4 * 3.ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“TreeBinä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆå°±å°†lockStateçš„æœ€ä½2ä½ è®¾ç½®ä¸º 0b 10 */volatile int lockState;// values for lockStatestatic final int WRITER = 1; // set while holding write lockstatic final int WAITER = 2; // set when waiting for write lockstatic final int READER = 4; // increment value for setting read lock ##13.2 æ„é€ å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586TreeBin(TreeNode&lt;K,V&gt; b) &#123; //è®¾ç½®èŠ‚ç‚¹hashä¸º-2 è¡¨ç¤ºæ­¤èŠ‚ç‚¹æ˜¯TreeBinèŠ‚ç‚¹ super(TREEBIN, null, null, null); //ä½¿ç”¨first å¼•ç”¨ treeNodeé“¾è¡¨ this.first = b; //r çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹å¼•ç”¨ TreeNode&lt;K,V&gt; r = null; //xè¡¨ç¤ºéå†çš„å½“å‰èŠ‚ç‚¹ for (TreeNode&lt;K,V&gt; x = b, next; x != null; x = next) &#123; next = (TreeNode&lt;K,V&gt;)x.next; //å¼ºåˆ¶è®¾ç½®å½“å‰æ’å…¥èŠ‚ç‚¹çš„å·¦å³å­æ ‘ä¸ºnull x.left = x.right = null; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¢é»‘æ ‘ æ˜¯ä¸€ä¸ªç©ºæ ‘ï¼Œé‚£ä¹ˆè®¾ç½®æ’å…¥å…ƒç´  ä¸ºæ ¹èŠ‚ç‚¹ if (r == null) &#123; //æ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸€å®šä¸º null x.parent = null; //é¢œè‰²æ”¹ä¸ºé»‘è‰² x.red = false; //è®©rå¼•ç”¨xæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚ r = x; &#125; else &#123; //éç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œéƒ½ä¼šæ¥å¸¦elseåˆ†æ”¯ï¼Œæ­¤æ—¶çº¢é»‘æ ‘å·²ç»æœ‰æ•°æ®äº† //k è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„key K k = x.key; //h è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„hash int h = x.hash; //kc è¡¨ç¤º æ’å…¥èŠ‚ç‚¹keyçš„classç±»å‹ Class&lt;?&gt; kc = null; //p è¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; p = r; for (;;) &#123; //dir (-1, 1) //-1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼å¤§äº å½“å‰pèŠ‚ç‚¹çš„hash //1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰pèŠ‚ç‚¹çš„hash //ph pè¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„hash int dir, ph; //ä¸´æ—¶èŠ‚ç‚¹ key K pk = p.key; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰èŠ‚ç‚¹ if ((ph = p.hash) &gt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å·¦å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = -1; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å¤§äº å½“å‰èŠ‚ç‚¹ else if (ph &lt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å³å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = 1; //å¦‚æœæ‰§è¡Œåˆ° CASE3ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„hash ä¸ å½“å‰èŠ‚ç‚¹çš„hashä¸€è‡´ï¼Œä¼šåœ¨case3 åšå‡ºæœ€ç»ˆæ’åºã€‚æœ€ç»ˆ //æ‹¿åˆ°çš„dir ä¸€å®šä¸æ˜¯0ï¼Œï¼ˆ-1ï¼Œ 1ï¼‰ else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) dir = tieBreakOrder(k, pk); //xp æƒ³è¦è¡¨ç¤ºçš„æ˜¯ æ’å…¥èŠ‚ç‚¹çš„ çˆ¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; xp = p; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰pèŠ‚ç‚¹ å³ä¸ºæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ //æ¡ä»¶ä¸æˆç«‹ï¼šè¯´æ˜pèŠ‚ç‚¹ åº•ä¸‹è¿˜æœ‰å±‚æ¬¡ï¼Œéœ€è¦å°†pæŒ‡å‘ pçš„å·¦å­èŠ‚ç‚¹ æˆ–è€… å³å­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºç»§ç»­å‘ä¸‹æœç´¢ã€‚ if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //è®¾ç½®æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸º å½“å‰èŠ‚ç‚¹ x.parent = xp; //å°äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ if (dir &lt;= 0) xp.left = x; //å¤§äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ else xp.right = x; //æ’å…¥èŠ‚ç‚¹åï¼Œçº¢é»‘æ ‘æ€§è´¨ å¯èƒ½ä¼šè¢«ç ´åï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ å¹³è¡¡æ–¹æ³• r = balanceInsertion(r, x); break; &#125; &#125; &#125; &#125; //å°†r èµ‹å€¼ç»™ TreeBinå¯¹è±¡çš„ rootå¼•ç”¨ã€‚ this.root = r; assert checkInvariants(root);&#125; ##13.3 putTreeVal 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970final TreeNode&lt;K,V&gt; putTreeVal(int h, K k, V v) &#123; Class&lt;?&gt; kc = null; boolean searched = false; for (TreeNode&lt;K,V&gt; p = root;;) &#123; int dir, ph; K pk; if (p == null) &#123; first = root = new TreeNode&lt;K,V&gt;(h, k, v, null, null); break; &#125; else if ((ph = p.hash) &gt; h) dir = -1; else if (ph &lt; h) dir = 1; else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk))) return p; else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) &#123; if (!searched) &#123; TreeNode&lt;K,V&gt; q, ch; searched = true; if (((ch = p.left) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null) || ((ch = p.right) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null)) return q; &#125; dir = tieBreakOrder(k, pk); &#125; TreeNode&lt;K,V&gt; xp = p; if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹xp å³ä¸º x èŠ‚ç‚¹çš„çˆ¸çˆ¸ //x è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹ //f è€çš„å¤´ç»“ç‚¹ TreeNode&lt;K,V&gt; x, f = first; first = x = new TreeNode&lt;K,V&gt;(h, k, v, f, xp); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜é“¾è¡¨æœ‰æ•°æ® if (f != null) //è®¾ç½®è€çš„å¤´ç»“ç‚¹çš„å‰ç½®å¼•ç”¨ä¸º å½“å‰çš„å¤´ç»“ç‚¹ã€‚ f.prev = x; if (dir &lt;= 0) xp.left = x; else xp.right = x; if (!xp.red) x.red = true; else &#123; //è¡¨ç¤º å½“å‰æ–°æ’å…¥èŠ‚ç‚¹åï¼Œæ–°æ’å…¥èŠ‚ç‚¹ ä¸ çˆ¶èŠ‚ç‚¹ å½¢æˆ â€œçº¢çº¢ç›¸è¿â€ lockRoot(); try &#123; //å¹³è¡¡çº¢é»‘æ ‘ï¼Œä½¿å…¶å†æ¬¡ç¬¦åˆè§„èŒƒã€‚ root = balanceInsertion(root, x); &#125; finally &#123; unlockRoot(); &#125; &#125; break; &#125; &#125; assert checkInvariants(root); return null;&#125; ##13.4 find 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748final Node&lt;K,V&gt; find(int h, Object k) &#123; if (k != null) &#123; //e è¡¨ç¤ºå¾ªç¯è¿­ä»£çš„å½“å‰èŠ‚ç‚¹ è¿­ä»£çš„æ˜¯firstå¼•ç”¨çš„é“¾è¡¨ for (Node&lt;K,V&gt; e = first; e != null; ) &#123; //s ä¿å­˜çš„æ˜¯lockä¸´æ—¶çŠ¶æ€ //ek é“¾è¡¨å½“å‰èŠ‚ç‚¹ çš„key int s; K ek; //(WAITER|WRITER) =&gt; 0010 | 0001 =&gt; 0011 //lockState &amp; 0011 != 0 æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰TreeBin æœ‰ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… ç›®å‰æœ‰å†™æ“ä½œçº¿ç¨‹æ­£åœ¨åŠ é” if (((s = lockState) &amp; (WAITER|WRITER)) != 0) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek)))) return e; e = e.next; &#125; //å‰ç½®æ¡ä»¶ï¼šå½“å‰TreeBinä¸­ ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… å†™çº¿ç¨‹ éƒ½æ²¡æœ‰ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ·»åŠ è¯»é”æˆåŠŸ else if (U.compareAndSwapInt(this, LOCKSTATE, s, s + READER)) &#123; TreeNode&lt;K,V&gt; r, p; try &#123; //æŸ¥è¯¢æ“ä½œ p = ((r = root) == null ? null : r.findTreeNode(h, k, null)); &#125; finally &#123; //w è¡¨ç¤ºç­‰å¾…è€…çº¿ç¨‹ Thread w; //U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) //1.å½“å‰çº¿ç¨‹æŸ¥è¯¢çº¢é»‘æ ‘ç»“æŸï¼Œé‡Šæ”¾å½“å‰çº¿ç¨‹çš„è¯»é” å°±æ˜¯è®© lockstate å€¼ - 4 //(READER|WAITER) = 0110 =&gt; è¡¨ç¤ºå½“å‰åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œä¸”â€œæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…â€ //å½“å‰è¯»çº¿ç¨‹ä¸º TreeBinä¸­çš„æœ€åä¸€ä¸ªè¯»çº¿ç¨‹ã€‚ //2.(w = waiter) != null è¯´æ˜æœ‰ä¸€ä¸ªå†™çº¿ç¨‹åœ¨ç­‰å¾…è¯»æ“ä½œå…¨éƒ¨ç»“æŸã€‚ if (U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) &amp;&amp; (w = waiter) != null) //ä½¿ç”¨unpark è®© å†™çº¿ç¨‹ æ¢å¤è¿è¡ŒçŠ¶æ€ã€‚ LockSupport.unpark(w); &#125; return p; &#125; &#125; &#125; return null;&#125; #æ€»ç»“åœ¨java8ä¸­ï¼ŒConcurrentHashMapä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»„åˆæ–¹å¼ï¼Œåˆ©ç”¨caså’Œsynchronizedä¿è¯å¹¶å‘å†™çš„å®‰å…¨ã€‚ å¼•å…¥çº¢é»‘æ ‘çš„åŸå› ï¼šé“¾è¡¨æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸ºOnï¼Œä½†æ˜¯çº¢é»‘æ ‘çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(log(n)),æ‰€ä»¥åœ¨èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¢é»‘æ ‘å¯ä»¥å¤§å¤§æå‡æ€§èƒ½ã€‚ é“¾å¼æ¡¶æ˜¯ä¸€ä¸ªç”±nodeèŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ã€‚æ ‘çŠ¶æ¡¶æ˜¯ä¸€é¢—ç”±TreeNodeèŠ‚ç‚¹ç»„æˆçš„çº¢é»‘æ ‘ã€‚è¾“çš„æ ¹èŠ‚ç‚¹ä¸ºTreeBinç±»å‹ã€‚ å½“é“¾è¡¨é•¿åº¦å¤§äº8æ•´ä¸ªhashè¡¨é•¿åº¦å¤§äº64çš„æ—¶å€™ï¼Œå°±ä¼šè½¬åŒ–ä¸ºTreeBinã€‚TreeBinä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯çº¢é»‘æ ‘å¯¹è±¡ã€‚åœ¨ConcurrentHashMapçš„tableæ•°ç»„ä¸­ï¼Œå­˜æ”¾çš„å°±æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNoeå¯¹è±¡ã€‚ æ•°ç»„tableæ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œæ‰€ä»¥initTable()å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ é‡è¦çš„å±æ€§å°±æ˜¯sizeCtlï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹æ“ä½œçš„è¿‡ç¨‹ï¼š â— -1ä»£è¡¨tableæ­£åœ¨åˆå§‹åŒ–ï¼Œå…¶ä»–çº¿ç¨‹ç›´æ¥joinç­‰å¾…ã€‚ â— -Nä»£è¡¨æœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œä¸¥æ ¼æ¥è¯´ï¼Œå½“å…¶ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œåªç”¨åˆ°äº†ä½16ä½ï¼Œå¦‚æœä½16ä½ä¸ºMï¼Œæ­¤æ—¶æœ‰M-1ä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹ã€‚ â— å¤§äº0æœ‰ä¸¤ç§æƒ…å†µï¼šå¦‚æœtableæ²¡æœ‰åˆå§‹åŒ–ï¼Œå¥¹å°±è¡¨ç¤ºtableåˆå§‹åŒ–çš„å¤§å°ï¼Œå¦‚æœtableåˆå§‹åŒ–å®Œäº†ï¼Œå°±è¡¨ç¤ºtableçš„å®¹é‡ï¼Œé»˜è®¤æ˜¯tableå¤§å°çš„å››åˆ†ä¹‹ä¸‰ã€‚ Transfer()æ‰©å®¹ tableæ•°æ®è½¬ç§»åˆ°nextTableã€‚æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼ŒæŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ConcurrentHashMapç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒæŠŠtableæ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹æ‰€è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„ Bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰Bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ helpTransfer()å¸®åŠ©æ‰©å®¹ ConcurrentHashMapå¹¶å‘æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œå…¶ä»–çº¿ç¨‹ä¼šå¸®åŠ©æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å¤šçº¿ç¨‹æ‰©å®¹ã€‚ ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œé»˜è®¤åˆå§‹é•¿åº¦ä¸º16ï¼Œå½“å¾€tableä¸­ç»§ç»­æ·»åŠ å…ƒç´ æ—¶ï¼Œé€šè¿‡Hashå€¼è·Ÿæ•°ç»„é•¿åº¦å–ä½™æ¥å†³å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªBucketä½ç½®ï¼Œå¦‚æœå‡ºç°æ”¾åœ¨åŒä¸€ä¸ªä½ç½®ï¼Œå°±ä¼˜å…ˆä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼Œåœ¨åŒä¸€ä¸ªä½ç½®çš„ä¸ªæ•°è¾¾åˆ°äº†8ä¸ªä»¥ä¸Šï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦è¿˜å°äº64ï¼Œå°±ä¼šæ‰©å®¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64ï¼Œå°±ä¼šå°†è¯¥èŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢æˆæ ‘ã€‚ é€šè¿‡æ‰©å®¹æ•°ç»„çš„æ–¹å¼æ¥æŠŠè¿™äº›èŠ‚ç‚¹åˆ†æ•£å¼€ã€‚ç„¶åå°†è¿™äº›å…ƒç´ å¤åˆ¶åˆ°æ‰©å®¹åçš„æ–°æ•°ç»„ä¸­ï¼ŒåŒä¸€ä¸ªBucketä¸­çš„å…ƒç´ é€šè¿‡Hashå€¼çš„æ•°ç»„é•¿åº¦ä½æ¥é‡æ–°ç¡®å®šä½ç½®ï¼Œå¯èƒ½è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®ï¼Œä¹Ÿå¯èƒ½æ”¾åˆ°æ–°çš„ä½ç½®ã€‚è€Œä¸”ï¼Œåœ¨æ‰©å®¹å®Œæˆä¹‹åï¼Œå¦‚æœä¹‹å‰æŸä¸ªèŠ‚ç‚¹æ˜¯æ ‘ï¼Œä½†æ˜¯ç°åœ¨è¯¥èŠ‚ç‚¹çš„â€œKey-Valueå¯¹â€æ•°åˆå°äºç­‰äº6ä¸ªï¼Œå°±ä¼šå°†è¯¥æ ‘è½¬ä¸ºé“¾è¡¨ã€‚ put() JDK1.8åœ¨ä½¿ç”¨CASè‡ªæ—‹å®Œæˆæ¡¶çš„è®¾ç½®æ—¶ï¼Œä½¿ç”¨synchronizedå†…ç½®é”ä¿è¯æ¡¶å†…å¹¶å‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡å¯¹åŒä¸€ä¸ªMapæ“ä½œçš„çº¿ç¨‹äº‰ç”¨ä¼šéå¸¸æ¿€çƒˆï¼Œä½†æ˜¯åœ¨åŒä¸€ä¸ªæ¡¶å†…çš„çº¿ç¨‹äº‰ç”¨é€šå¸¸ä¸ä¼šå¾ˆæ¿€çƒˆï¼Œæ‰€ä»¥ä½¿ç”¨CASè‡ªæ—‹ã€synchronizedä¸ä¼šé™ä½ConcurrentHashMapçš„æ€§èƒ½ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ReentrantLockæ˜¾å¼é”å‘¢?å¦‚æœä¸ºæ¯ ä¸ªæ¡¶éƒ½åˆ›å»ºä¸€ä¸ªReentrantLockå® ä¾‹ï¼Œå°±ä¼šå¸¦æ¥å¤§é‡çš„å†…å­˜æ¶ˆè€—ï¼Œåè¿‡æ¥ï¼Œä½¿ç”¨CASè‡ªæ—‹ã€synchronizedï¼Œå†…å­˜æ¶ˆè€—çš„å¢åŠ æ›´å°ã€‚ get() get()é€šè¿‡UnSafeçš„getObjectVolatile()æ¥è¯»å–æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åš?è™½ç„¶HashEntryæ•°ç»„çš„å¼•ç”¨æ˜¯volatileç±»å‹ï¼Œä½†æ˜¯æ•°ç»„å†…å…ƒç´ çš„ ç”¨ä¸æ˜¯volatileç±»å‹ï¼Œå› æ­¤å¤šçº¿ç¨‹å¯¹ æ•°ç»„å…ƒç´ çš„ä¿®æ”¹æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šåœ¨æ•°ç»„ä¸­è¯»å–åˆ°å°šæœªæ„é€ å®Œæˆçš„å…ƒç´ å¯¹è±¡ã€‚get()æ–¹æ³•é€šè¿‡UnSafeçš„getObjectVolatileæ–¹æ³•æ¥ä¿è¯å…ƒç´ çš„è¯»å–å®‰å…¨ï¼Œè°ƒç”¨getObjectVolatile()å»è¯»å–æ•°ç»„å…ƒç´ éœ€è¦å…ˆè·å¾—å…ƒç´ åœ¨æ•°ç»„ä¸­çš„åç§»é‡ï¼Œåœ¨è¿™é‡Œï¼Œget()æ–¹æ³•æ ¹æ®å“ˆå¸Œç è®¡ç®—å‡ºåç§»é‡ä¸ºuï¼Œç„¶åé€šè¿‡åç§»é‡uæ¥å°è¯•è¯»å–æ•°å€¼ã€‚","categories":[{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://zhangxin66666.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://zhangxin66666.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]},{"title":"mysqlæ‰§è¡Œæµç¨‹","slug":"7.mysql/mysqlæ‰§è¡Œæµç¨‹","date":"2022-04-01T16:00:00.000Z","updated":"2024-08-22T03:23:14.706Z","comments":true,"path":"2022/04/02/7.mysql/mysqlæ‰§è¡Œæµç¨‹/","link":"","permalink":"https://zhangxin66666.github.io/2022/04/02/7.mysql/mysql%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/","excerpt":"","text":"ä¸€ã€MySQLçš„å†…éƒ¨ç»„ä»¶ç»“æ„ å¤§ä½“æ¥è¯´ï¼ŒMySQL å¯ä»¥åˆ†ä¸º Server å±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¸¤éƒ¨åˆ†ã€‚ Serverå±‚ ä¸»è¦åŒ…æ‹¬è¿æ¥å™¨ã€æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ¶µç›– MySQL çš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ‰€æœ‰çš„å†…ç½®å‡½æ•° ï¼ˆå¦‚æ—¥æœŸã€æ—¶é—´ã€æ•°å­¦å’ŒåŠ å¯†å‡½æ•°ç­‰ï¼‰ï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½éƒ½åœ¨è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚ Storeå±‚ å­˜å‚¨å¼•æ“å±‚è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œæå–ã€‚å…¶æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼çš„ï¼Œæ”¯æŒ InnoDBã€MyISAMã€Memory ç­‰å¤šä¸ªå­˜å‚¨å¼•æ“ã€‚ç°åœ¨ æœ€å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯ InnoDBï¼Œå®ƒä» MySQL 5.5.5 ç‰ˆæœ¬å¼€å§‹æˆä¸ºäº†é»˜è®¤å­˜å‚¨å¼•æ“ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬åœ¨create tableæ—¶ä¸æŒ‡å®š è¡¨çš„å­˜å‚¨å¼•æ“ç±»å‹,é»˜è®¤ä¼šç»™ä½ è®¾ç½®å­˜å‚¨å¼•æ“ä¸ºInnoDBã€‚ æœ¬èŠ‚è¯¾æ¼”ç¤ºè¡¨çš„DDLï¼š 123456789CREATE TABLE `test` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8; ä¸‹é¢æˆ‘ä»¬é‡ç‚¹æ¥åˆ†æè¿æ¥å™¨ã€æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨åˆ†åˆ«ä¸»è¦å¹²äº†å“ªäº›äº‹æƒ…ã€‚ äºŒã€è¿æ¥å™¨æˆ‘ä»¬çŸ¥é“ç”±äºMySQLæ˜¯å¼€æºçš„ï¼Œä»–æœ‰éå¸¸å¤šç§ç±»çš„å®¢æˆ·ç«¯ï¼šnavicat,mysql front,jdbc,SQLyogç­‰éå¸¸ä¸°å¯Œçš„å®¢æˆ·ç«¯,è¿™äº› å®¢æˆ·ç«¯è¦å‘mysqlå‘èµ·é€šä¿¡éƒ½å¿…é¡»å…ˆè·ŸServerç«¯å»ºç«‹é€šä¿¡è¿æ¥ï¼Œè€Œå»ºç«‹è¿æ¥çš„å·¥ä½œå°±æ˜¯æœ‰è¿æ¥å™¨å®Œæˆçš„ã€‚ ç¬¬ä¸€æ­¥ï¼Œä½ ä¼šå…ˆè¿æ¥åˆ°è¿™ä¸ªæ•°æ®åº“ä¸Šï¼Œè¿™æ—¶å€™æ¥å¾…ä½ çš„å°±æ˜¯è¿æ¥å™¨ã€‚è¿æ¥å™¨è´Ÿè´£è·Ÿå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€è·å–æƒé™ã€ç»´æŒå’Œç®¡ ç†è¿æ¥ã€‚è¿æ¥å‘½ä»¤ä¸€èˆ¬æ˜¯è¿™ä¹ˆå†™çš„ï¼š 1[root@192 ~]# mysql â€h host[æ•°æ®åº“åœ°å€] â€u root[ç”¨æˆ·] â€p root[å¯†ç ] â€P 3306 è¿æ¥å‘½ä»¤ä¸­çš„ mysql æ˜¯å®¢æˆ·ç«¯å·¥å…·ï¼Œç”¨æ¥è·ŸæœåŠ¡ç«¯å»ºç«‹è¿æ¥ã€‚åœ¨å®Œæˆç»å…¸çš„ TCP æ¡æ‰‹åï¼Œè¿æ¥å™¨å°±è¦å¼€å§‹è®¤è¯ä½ çš„èº«ä»½ï¼Œ è¿™ä¸ªæ—¶å€™ç”¨çš„å°±æ˜¯ä½ è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ã€‚ 1ã€å¦‚æœç”¨æˆ·åæˆ–å¯†ç ä¸å¯¹ï¼Œä½ å°±ä¼šæ”¶åˆ°ä¸€ä¸ªâ€Access denied for userâ€çš„é”™è¯¯ï¼Œç„¶åå®¢æˆ·ç«¯ç¨‹åºç»“æŸæ‰§è¡Œã€‚ 2ã€å¦‚æœç”¨æˆ·åå¯†ç è®¤è¯é€šè¿‡ï¼Œè¿æ¥å™¨ä¼šåˆ°æƒé™è¡¨é‡Œé¢æŸ¥å‡ºä½ æ‹¥æœ‰çš„æƒé™ã€‚ä¹‹åï¼Œè¿™ä¸ªè¿æ¥é‡Œé¢çš„æƒé™åˆ¤æ–­é€»è¾‘ï¼Œéƒ½å°†ä¾èµ–äºæ­¤æ—¶è¯»åˆ°çš„æƒ é™ã€‚ è¿™å°±æ„å‘³ç€ï¼Œä¸€ä¸ªç”¨æˆ·æˆåŠŸå»ºç«‹è¿æ¥åï¼Œå³ä½¿ä½ ç”¨ç®¡ç†å‘˜è´¦å·å¯¹è¿™ä¸ªç”¨æˆ·çš„æƒé™åšäº†ä¿®æ”¹ï¼Œä¹Ÿä¸ä¼šå½±å“å·²ç»å­˜åœ¨è¿æ¥çš„æƒ é™ã€‚ä¿®æ”¹å®Œæˆåï¼Œåªæœ‰å†æ–°å»ºçš„è¿æ¥æ‰ä¼šä½¿ç”¨æ–°çš„æƒé™è®¾ç½®ã€‚ç”¨æˆ·çš„æƒé™è¡¨åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„mysqlçš„userè¡¨ä¸­ã€‚ ä¿®æ”¹userå¯†ç  123456789mysql&gt; CREATE USER &#x27;username&#x27;@&#x27;host&#x27; IDENTIFIED BY &#x27;password&#x27;; //åˆ›å»ºæ–°ç”¨æˆ· mysql&gt; grant all privileges on *.* to &#x27;username&#x27;@&#x27;%&#x27;; //èµ‹æƒé™,%è¡¨ç¤ºæ‰€æœ‰(host) mysql&gt; flush privileges //åˆ·æ–°æ•°æ®åº“ mysql&gt; update user set password=password(â€123456â€³) where user=â€™rootâ€™;(è®¾ç½®ç”¨æˆ·åå¯†ç ) mysql&gt; show grants for root@&quot;%&quot;; æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æƒé™ è¿æ¥å®Œæˆåï¼Œå¦‚æœä½ æ²¡æœ‰åç»­çš„åŠ¨ä½œï¼Œè¿™ä¸ªè¿æ¥å°±å¤„äºç©ºé—²çŠ¶æ€ï¼Œä½ å¯ä»¥åœ¨ show processlist å‘½ä»¤ä¸­çœ‹åˆ°å®ƒã€‚æ–‡æœ¬ä¸­è¿™ä¸ª å›¾æ˜¯ show processlist çš„ç»“æœï¼Œå…¶ä¸­çš„ Command åˆ—æ˜¾ç¤ºä¸ºâ€œSleepâ€çš„è¿™ä¸€è¡Œï¼Œå°±è¡¨ç¤ºç°åœ¨ç³»ç»Ÿé‡Œé¢æœ‰ä¸€ä¸ªç©ºé—²è¿æ¥ã€‚ å®¢æˆ·ç«¯å¦‚æœé•¿æ—¶é—´ä¸å‘é€commandåˆ°Serverç«¯ï¼Œè¿æ¥å™¨å°±ä¼šè‡ªåŠ¨å°†å®ƒæ–­å¼€ã€‚è¿™ä¸ªæ—¶é—´æ˜¯ç”±å‚æ•° wait_timeout æ§åˆ¶çš„ï¼Œé»˜è®¤å€¼ æ˜¯ 8 å°æ—¶ã€‚ æŸ¥çœ‹wait_timeout 123mysql&gt; show global variables like &quot;wait_timeout&quot;; mysql&gt;set global wait_timeout=28800; è®¾ç½®å…¨å±€æœåŠ¡å™¨å…³é—­éäº¤äº’è¿æ¥ä¹‹å‰ç­‰å¾…æ´»åŠ¨çš„ç§’æ•° å¦‚æœåœ¨è¿æ¥è¢«æ–­å¼€ä¹‹åï¼Œå®¢æˆ·ç«¯å†æ¬¡å‘é€è¯·æ±‚çš„è¯ï¼Œå°±ä¼šæ”¶åˆ°ä¸€ä¸ªé”™è¯¯æé†’ï¼š Lost connection to MySQL server during queryã€‚è¿™æ—¶å€™å¦‚æœä½ è¦ç»§ç»­ï¼Œå°±éœ€è¦é‡è¿ï¼Œç„¶åå†æ‰§è¡Œè¯·æ±‚äº†ã€‚æ•°æ®åº“é‡Œé¢ï¼Œé•¿è¿æ¥æ˜¯æŒ‡è¿æ¥æˆåŠŸåï¼Œå¦‚æœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚çŸ­è¿æ¥åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡ æŸ¥è¯¢å°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ªã€‚ å¼€å‘å½“ä¸­æˆ‘ä»¬å¤§å¤šæ•°æ—¶å€™ç”¨çš„éƒ½æ˜¯é•¿è¿æ¥,æŠŠè¿æ¥æ”¾åœ¨Poolå†…è¿›è¡Œç®¡ç†ï¼Œä½†æ˜¯é•¿è¿æ¥æœ‰äº›æ—¶å€™ä¼šå¯¼è‡´ MySQL å ç”¨å†…å­˜æ¶¨å¾—ç‰¹åˆ« å¿«ï¼Œè¿™æ˜¯å› ä¸º MySQL åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸´æ—¶ä½¿ç”¨çš„å†…å­˜æ˜¯ç®¡ç†åœ¨è¿æ¥å¯¹è±¡é‡Œé¢çš„ã€‚è¿™äº›èµ„æºä¼šåœ¨è¿æ¥æ–­å¼€çš„æ—¶å€™æ‰é‡Šæ”¾ã€‚æ‰€ä»¥å¦‚ æœé•¿è¿æ¥ç´¯ç§¯ä¸‹æ¥ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜å ç”¨å¤ªå¤§ï¼Œè¢«ç³»ç»Ÿå¼ºè¡Œæ€æ‰ï¼ˆOOMï¼‰ï¼Œä»ç°è±¡çœ‹å°±æ˜¯ MySQL å¼‚å¸¸é‡å¯äº†ã€‚ æ€ä¹ˆè§£å†³è¿™ç±»é—®é¢˜å‘¢ï¼Ÿ 1ã€å®šæœŸæ–­å¼€é•¿è¿æ¥ã€‚ä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç¨‹åºé‡Œé¢åˆ¤æ–­æ‰§è¡Œè¿‡ä¸€ä¸ªå ç”¨å†…å­˜çš„å¤§æŸ¥è¯¢åï¼Œæ–­å¼€è¿æ¥ï¼Œä¹‹åè¦æŸ¥è¯¢å†é‡è¿ã€‚ 2ã€å¦‚æœä½ ç”¨çš„æ˜¯ MySQL 5.7 æˆ–æ›´æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ“ä½œåï¼Œé€šè¿‡æ‰§è¡Œ mysql_reset_connection æ¥é‡æ–°åˆå§‹åŒ–è¿æ¥èµ„ æºã€‚è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡è¿å’Œé‡æ–°åšæƒé™éªŒè¯ï¼Œä½†æ˜¯ä¼šå°†è¿æ¥æ¢å¤åˆ°åˆšåˆšåˆ›å»ºå®Œæ—¶çš„çŠ¶æ€ã€‚ ä¸‰ã€æŸ¥è¯¢ç¼“å­˜å¸¸ç”¨çš„ä¸€äº›æ“ä½œ 1234567mysql&gt;show databases; æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“ mysql&gt;use dbnameï¼› æ‰“å¼€æ•°æ®åº“ï¼š mysql&gt;show tables; æ˜¾ç¤ºæ•°æ®åº“mysqlä¸­æ‰€æœ‰çš„è¡¨ï¼› mysql&gt;describe user; æ˜¾ç¤ºè¡¨mysqlæ•°æ®åº“ä¸­userè¡¨çš„åˆ—ä¿¡æ¯ï¼‰ï¼› è¿æ¥å»ºç«‹å®Œæˆåï¼Œä½ å°±å¯ä»¥æ‰§è¡Œ select è¯­å¥äº†ã€‚æ‰§è¡Œé€»è¾‘å°±ä¼šæ¥åˆ°ç¬¬äºŒæ­¥ï¼šæŸ¥è¯¢ç¼“å­˜ã€‚ MySQL æ‹¿åˆ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚åï¼Œä¼šå…ˆåˆ°æŸ¥è¯¢ç¼“å­˜çœ‹çœ‹ï¼Œä¹‹å‰æ˜¯ä¸æ˜¯æ‰§è¡Œè¿‡è¿™æ¡è¯­å¥ã€‚ä¹‹å‰æ‰§è¡Œè¿‡çš„è¯­å¥åŠå…¶ç»“æœå¯èƒ½ä¼šä»¥ key-value å¯¹çš„å½¢å¼ï¼Œè¢«ç›´æ¥ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚key æ˜¯æŸ¥è¯¢çš„è¯­å¥ï¼Œvalue æ˜¯æŸ¥è¯¢çš„ç»“æœã€‚å¦‚æœä½ çš„æŸ¥è¯¢èƒ½å¤Ÿç›´æ¥åœ¨è¿™ä¸ªç¼“å­˜ä¸­æ‰¾ åˆ° keyï¼Œé‚£ä¹ˆè¿™ä¸ª value å°±ä¼šè¢«ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å¦‚æœè¯­å¥ä¸åœ¨æŸ¥è¯¢ç¼“å­˜ä¸­ï¼Œå°±ä¼šç»§ç»­åé¢çš„æ‰§è¡Œé˜¶æ®µã€‚æ‰§è¡Œå®Œæˆåï¼Œæ‰§è¡Œç»“æœä¼šè¢«å­˜å…¥æŸ¥è¯¢ç¼“å­˜ä¸­ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæŸ¥ è¯¢å‘½ä¸­ç¼“å­˜ï¼ŒMySQL ä¸éœ€è¦æ‰§è¡Œåé¢çš„å¤æ‚æ“ä½œï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ç»“æœï¼Œè¿™ä¸ªæ•ˆç‡ä¼šå¾ˆé«˜ã€‚ å¤§å¤šæ•°æƒ…å†µæŸ¥è¯¢ç¼“å­˜å°±æ˜¯ä¸ªé¸¡è‚‹ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ å› ä¸ºæŸ¥è¯¢ç¼“å­˜å¾€å¾€å¼Šå¤§äºåˆ©ã€‚æŸ¥è¯¢ç¼“å­˜çš„å¤±æ•ˆéå¸¸é¢‘ç¹ï¼Œåªè¦æœ‰å¯¹ä¸€ä¸ªè¡¨çš„æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚ å› æ­¤å¾ˆå¯èƒ½ä½ è´¹åŠ²åœ°æŠŠç»“æœå­˜èµ·æ¥ï¼Œè¿˜æ²¡ä½¿ç”¨å‘¢ï¼Œå°±è¢«ä¸€ä¸ªæ›´æ–°å…¨æ¸…ç©ºäº†ã€‚å¯¹äºæ›´æ–°å‹åŠ›å¤§çš„æ•°æ®åº“æ¥è¯´ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ ä¼šéå¸¸ä½ã€‚ ä¸€èˆ¬å»ºè®®å¤§å®¶åœ¨é™æ€è¡¨é‡Œä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œä»€ä¹ˆå«é™æ€è¡¨å‘¢ï¼Ÿå°±æ˜¯ä¸€èˆ¬æˆ‘ä»¬æå°‘æ›´æ–°çš„è¡¨ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿé…ç½®è¡¨ã€å­—å…¸ è¡¨ï¼Œé‚£è¿™å¼ è¡¨ä¸Šçš„æŸ¥è¯¢æ‰é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚å¥½åœ¨ MySQL ä¹Ÿæä¾›äº†è¿™ç§â€œæŒ‰éœ€ä½¿ç”¨â€çš„æ–¹å¼ã€‚ä½ å¯ä»¥å°†my.cnfå‚æ•° query_cache_type è®¾ç½®æˆ DEMANDã€‚ 1234567 my.cnf #query_cache_typeæœ‰3ä¸ªå€¼ 0ä»£è¡¨å…³é—­æŸ¥è¯¢ç¼“å­˜OFFï¼Œ1ä»£è¡¨å¼€å¯ONï¼Œ2ï¼ˆDEMANDï¼‰ä»£è¡¨å½“sqlè¯­å¥ä¸­æœ‰SQL_CACHE å…³é”®è¯æ—¶æ‰ç¼“å­˜ query_cache_type=2 è¿™æ ·å¯¹äºé»˜è®¤çš„ SQL è¯­å¥éƒ½ä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚è€Œå¯¹äºä½ ç¡®å®šè¦ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜çš„è¯­å¥ï¼Œå¯ä»¥ç”¨ SQL_CACHE æ˜¾å¼æŒ‡å®šï¼Œåƒä¸‹ é¢è¿™ä¸ªè¯­å¥ä¸€æ ·ï¼š 1mysql&gt; select SQL_CACHE * from test where ID=5; æŸ¥çœ‹å½“å‰mysqlå®ä¾‹æ˜¯å¦å¼€å¯ç¼“å­˜æœºåˆ¶ 1mysql&gt; show global variables like &quot;%query_cache_type%&quot;; ç›‘æ§æŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡: 1mysql&gt; show status like&#x27;%Qcache%&#x27;; //æŸ¥çœ‹è¿è¡Œçš„ç¼“å­˜ä¿¡æ¯ Qcache_free_blocks:è¡¨ç¤ºæŸ¥è¯¢ç¼“å­˜ä¸­ç›®å‰è¿˜æœ‰å¤šå°‘å‰©ä½™çš„blocksï¼Œå¦‚æœè¯¥å€¼æ˜¾ç¤ºè¾ƒå¤§ï¼Œåˆ™è¯´æ˜æŸ¥è¯¢ç¼“å­˜ä¸­çš„å†…å­˜ç¢ç‰‡ è¿‡å¤šäº†ï¼Œå¯èƒ½åœ¨ä¸€å®šçš„æ—¶é—´è¿›è¡Œæ•´ç†ã€‚ Qcache_free_memory:æŸ¥è¯¢ç¼“å­˜çš„å†…å­˜å¤§å°ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°å¯ä»¥å¾ˆæ¸…æ™°çš„çŸ¥é“å½“å‰ç³»ç»Ÿçš„æŸ¥è¯¢å†…å­˜æ˜¯å¦å¤Ÿç”¨ï¼Œæ˜¯å¤š äº†ï¼Œè¿˜æ˜¯ä¸å¤Ÿç”¨ï¼ŒDBAå¯ä»¥æ ¹æ®å®é™…æƒ…å†µåšå‡ºè°ƒæ•´ã€‚ Qcache_hits:è¡¨ç¤ºæœ‰å¤šå°‘æ¬¡å‘½ä¸­ç¼“å­˜ã€‚æˆ‘ä»¬ä¸»è¦å¯ä»¥é€šè¿‡è¯¥å€¼æ¥éªŒè¯æˆ‘ä»¬çš„æŸ¥è¯¢ç¼“å­˜çš„æ•ˆæœã€‚æ•°å­—è¶Šå¤§ï¼Œç¼“å­˜æ•ˆæœè¶Š ç†æƒ³ã€‚ Qcache_inserts: è¡¨ç¤ºå¤šå°‘æ¬¡æœªå‘½ä¸­ç„¶åæ’å…¥ï¼Œæ„æ€æ˜¯æ–°æ¥çš„SQLè¯·æ±‚åœ¨ç¼“å­˜ä¸­æœªæ‰¾åˆ°ï¼Œä¸å¾—ä¸æ‰§è¡ŒæŸ¥è¯¢å¤„ç†ï¼Œæ‰§è¡Œ æŸ¥è¯¢å¤„ç†åæŠŠç»“æœinsertåˆ°æŸ¥è¯¢ç¼“å­˜ä¸­ã€‚è¿™æ ·çš„æƒ…å†µçš„æ¬¡æ•°ï¼Œæ¬¡æ•°è¶Šå¤šï¼Œè¡¨ç¤ºæŸ¥è¯¢ç¼“å­˜åº”ç”¨åˆ°çš„æ¯”è¾ƒå°‘ï¼Œæ•ˆæœä¹Ÿå°±ä¸ç† æƒ³ã€‚å½“ç„¶ç³»ç»Ÿåˆšå¯åŠ¨åï¼ŒæŸ¥è¯¢ç¼“å­˜æ˜¯ç©ºçš„ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚ Qcache_lowmem_prunes:è¯¥å‚æ•°è®°å½•æœ‰å¤šå°‘æ¡æŸ¥è¯¢å› ä¸ºå†…å­˜ä¸è¶³è€Œè¢«ç§»é™¤å‡ºæŸ¥è¯¢ç¼“å­˜ã€‚é€šè¿‡è¿™ä¸ªå€¼ï¼Œç”¨æˆ·å¯ä»¥é€‚å½“çš„ è°ƒæ•´ç¼“å­˜å¤§å°ã€‚ Qcache_not_cached: è¡¨ç¤ºå› ä¸ºquery_cache_typeçš„è®¾ç½®è€Œæ²¡æœ‰è¢«ç¼“å­˜çš„æŸ¥è¯¢æ•°é‡ã€‚ Qcache_queries_in_cache:å½“å‰ç¼“å­˜ä¸­ç¼“å­˜çš„æŸ¥è¯¢æ•°é‡ã€‚ Qcache_total_blocks:å½“å‰ç¼“å­˜çš„blockæ•°é‡ã€‚ mysql8.0å·²ç»ç§»é™¤äº†æŸ¥è¯¢ç¼“å­˜åŠŸèƒ½ å››ã€åˆ†æå™¨å¦‚æœæ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œå°±è¦å¼€å§‹çœŸæ­£æ‰§è¡Œè¯­å¥äº†ã€‚é¦–å…ˆï¼ŒMySQL éœ€è¦çŸ¥é“ä½ è¦åšä»€ä¹ˆï¼Œå› æ­¤éœ€è¦å¯¹ SQL è¯­å¥åšè§£æã€‚ åˆ†æå™¨å…ˆä¼šåšâ€œè¯æ³•åˆ†æâ€ã€‚ä½ è¾“å…¥çš„æ˜¯ç”±å¤šä¸ªå­—ç¬¦ä¸²å’Œç©ºæ ¼ç»„æˆçš„ä¸€æ¡ SQL è¯­å¥ï¼ŒMySQL éœ€è¦è¯†åˆ«å‡ºé‡Œé¢çš„å­—ç¬¦ä¸²åˆ†åˆ«æ˜¯ ä»€ä¹ˆï¼Œä»£è¡¨ä»€ä¹ˆã€‚ MySQL ä»ä½ è¾“å…¥çš„â€selectâ€è¿™ä¸ªå…³é”®å­—è¯†åˆ«å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ã€‚å®ƒä¹Ÿè¦æŠŠå­—ç¬¦ä¸²â€œTâ€è¯†åˆ«æˆâ€œè¡¨å Tâ€ï¼ŒæŠŠå­—ç¬¦ ä¸²â€œIDâ€è¯†åˆ«æˆâ€œåˆ— IDâ€ã€‚ åšå®Œäº†è¿™äº›è¯†åˆ«ä»¥åï¼Œå°±è¦åšâ€œè¯­æ³•åˆ†æâ€ã€‚æ ¹æ®è¯æ³•åˆ†æçš„ç»“æœï¼Œè¯­æ³•åˆ†æå™¨ä¼šæ ¹æ®è¯­æ³•è§„åˆ™ï¼Œåˆ¤æ–­ä½ è¾“å…¥çš„è¿™ä¸ª SQL è¯­å¥ æ˜¯å¦æ»¡è¶³ MySQL è¯­æ³•ã€‚ å¦‚æœä½ çš„è¯­å¥ä¸å¯¹ï¼Œå°±ä¼šæ”¶åˆ°â€œYou have an error in your SQL syntaxâ€çš„é”™è¯¯æé†’ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªè¯­å¥ from å†™æˆäº† â€œromâ€ã€‚ 12345 mysql&gt; select * fro test where id=1; ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds t o your MySQL server version for the right syntax to use near &#x27;fro test where id=1&#x27; at line 1 è¯æ³•åˆ†æå™¨åŸç† è¯æ³•åˆ†æå™¨åˆ†æˆ6ä¸ªä¸»è¦æ­¥éª¤å®Œæˆå¯¹sqlè¯­å¥çš„åˆ†æ 1ã€è¯æ³•åˆ†æ 2ã€è¯­æ³•åˆ†æ 3ã€è¯­ä¹‰åˆ†æ 4ã€æ„é€ æ‰§è¡Œæ ‘ 5ã€ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ 6ã€è®¡åˆ’çš„æ‰§è¡Œ ä¸‹å›¾æ˜¯SQLè¯æ³•åˆ†æçš„è¿‡ç¨‹æ­¥éª¤ï¼š SQLè¯­å¥çš„åˆ†æåˆ†ä¸ºè¯æ³•åˆ†æä¸è¯­æ³•åˆ†æï¼Œmysqlçš„è¯æ³•åˆ†æç”±MySQLLex[MySQLè‡ªå·±å®ç°çš„]å®Œæˆï¼Œè¯­æ³•åˆ†æç”±Bisonç”Ÿ æˆã€‚å…³äºè¯­æ³•æ ‘å¤§å®¶å¦‚æœæƒ³è¦æ·±å…¥ç ”ç©¶å¯ä»¥å‚è€ƒè¿™ç¯‡wikiæ–‡ç« ï¼šhttps://en.wikipedia.org/wiki/LR_parserã€‚é‚£ä¹ˆé™¤äº†Bison å¤–ï¼ŒJavaå½“ä¸­ä¹Ÿæœ‰å¼€æºçš„è¯æ³•ç»“æ„åˆ†æå·¥å…·ä¾‹å¦‚Antlr4ï¼ŒANTLRä»è¯­æ³•ç”Ÿæˆä¸€ä¸ªè§£æå™¨ï¼Œå¯ä»¥æ„å»ºå’Œéå†è§£ææ ‘ï¼Œå¯ä»¥åœ¨IDEA å·¥å…·å½“ä¸­å®‰è£…æ’ä»¶ï¼šantlr v4 grammar pluginã€‚æ’ä»¶ä½¿ç”¨è¯¦è§è¯¾ç¨‹ ç»è¿‡bisonè¯­æ³•åˆ†æä¹‹åï¼Œä¼šç”Ÿæˆä¸€ä¸ªè¿™æ ·çš„è¯­æ³•æ ‘ è‡³æ­¤æˆ‘ä»¬åˆ†æå™¨çš„å·¥ä½œä»»åŠ¡ä¹ŸåŸºæœ¬åœ†æ»¡äº†ã€‚æ¥ä¸‹æ¥è¿›å…¥åˆ°ä¼˜åŒ–å™¨ äº”ã€ä¼˜åŒ–å™¨ç»è¿‡äº†åˆ†æå™¨ï¼ŒMySQL å°±çŸ¥é“ä½ è¦åšä»€ä¹ˆäº†ã€‚åœ¨å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œè¿˜è¦å…ˆç»è¿‡ä¼˜åŒ–å™¨çš„å¤„ç†ã€‚ ä¼˜åŒ–å™¨æ˜¯åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼›æˆ–è€…åœ¨ä¸€ä¸ªè¯­å¥æœ‰å¤šè¡¨å…³è”ï¼ˆjoinï¼‰çš„æ—¶å€™ï¼Œå†³å®šå„ä¸ªè¡¨çš„è¿æ¥ é¡ºåºã€‚æ¯”å¦‚ä½ æ‰§è¡Œä¸‹é¢è¿™æ ·çš„è¯­å¥ï¼Œè¿™ä¸ªè¯­å¥æ˜¯æ‰§è¡Œä¸¤ä¸ªè¡¨çš„ joinï¼š 123 mysql&gt; select * from test1 join test2 using(ID) where test1.name=yangguo and test2.name=xiaol ongnv; æ—¢å¯ä»¥å…ˆä»è¡¨ test1 é‡Œé¢å–å‡º name=yangguoçš„è®°å½•çš„ ID å€¼ï¼Œå†æ ¹æ® ID å€¼å…³è”åˆ°è¡¨ test2ï¼Œå†åˆ¤æ–­ test2 é‡Œé¢ nameçš„ å€¼æ˜¯å¦ç­‰äº yangguoã€‚ ä¹Ÿå¯ä»¥å…ˆä»è¡¨ test2 é‡Œé¢å–å‡º name=xiaolongnv çš„è®°å½•çš„ ID å€¼ï¼Œå†æ ¹æ® ID å€¼å…³è”åˆ° test1ï¼Œå†åˆ¤æ–­ test1 é‡Œé¢ name çš„å€¼æ˜¯å¦ç­‰äº yangguoã€‚ è¿™ä¸¤ç§æ‰§è¡Œæ–¹æ³•çš„é€»è¾‘ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡ä¼šæœ‰ä¸åŒï¼Œè€Œä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯å†³å®šé€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªæ–¹æ¡ˆã€‚ä¼˜åŒ–å™¨é˜¶æ®µ å®Œæˆåï¼Œè¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæ–¹æ¡ˆå°±ç¡®å®šä¸‹æ¥äº†ï¼Œç„¶åè¿›å…¥æ‰§è¡Œå™¨é˜¶æ®µã€‚å¦‚æœä½ è¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œæ¯”å¦‚ä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆé€‰æ‹©ç´¢å¼•çš„ï¼Œæœ‰ æ²¡æœ‰å¯èƒ½é€‰æ‹©é”™ç­‰ç­‰ã€‚ å…­ã€æ‰§è¡Œå™¨å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦å…ˆåˆ¤æ–­ä¸€ä¸‹ä½ å¯¹è¿™ä¸ªè¡¨ T æœ‰æ²¡æœ‰æ‰§è¡ŒæŸ¥è¯¢çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šè¿”å›æ²¡æœ‰æƒé™çš„é”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤º (åœ¨ å·¥ç¨‹å®ç°ä¸Šï¼Œå¦‚æœå‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œä¼šåœ¨æŸ¥è¯¢ç¼“å­˜è¿”å›ç»“æœçš„æ—¶å€™ï¼Œåšæƒé™éªŒè¯ã€‚æŸ¥è¯¢ä¹Ÿä¼šåœ¨ä¼˜åŒ–å™¨ä¹‹å‰è°ƒç”¨ precheck éªŒè¯æƒ é™)ã€‚ 1mysql&gt; select * from test where id=1; å¦‚æœæœ‰æƒé™ï¼Œå°±æ‰“å¼€è¡¨ç»§ç»­æ‰§è¡Œã€‚æ‰“å¼€è¡¨çš„æ—¶å€™ï¼Œæ‰§è¡Œå™¨å°±ä¼šæ ¹æ®è¡¨çš„å¼•æ“å®šä¹‰ï¼Œå»ä½¿ç”¨è¿™ä¸ªå¼•æ“æä¾›çš„æ¥å£ã€‚ æ¯”å¦‚æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­çš„è¡¨ test ä¸­ï¼ŒID å­—æ®µæ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆæ‰§è¡Œå™¨çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š \\1. è°ƒç”¨ InnoDB å¼•æ“æ¥å£å–è¿™ä¸ªè¡¨çš„ç¬¬ä¸€è¡Œï¼Œåˆ¤æ–­ ID å€¼æ˜¯ä¸æ˜¯ 10ï¼Œå¦‚æœä¸æ˜¯åˆ™è·³è¿‡ï¼Œå¦‚æœæ˜¯åˆ™å°†è¿™è¡Œå­˜åœ¨ç»“æœé›†ä¸­ï¼› \\2. è°ƒç”¨å¼•æ“æ¥å£å–â€œä¸‹ä¸€è¡Œâ€ï¼Œé‡å¤ç›¸åŒçš„åˆ¤æ–­é€»è¾‘ï¼Œç›´åˆ°å–åˆ°è¿™ä¸ªè¡¨çš„æœ€åä¸€è¡Œã€‚ \\3. æ‰§è¡Œå™¨å°†ä¸Šè¿°éå†è¿‡ç¨‹ä¸­æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œç»„æˆçš„è®°å½•é›†ä½œä¸ºç»“æœé›†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ è‡³æ­¤ï¼Œè¿™ä¸ªè¯­å¥å°±æ‰§è¡Œå®Œæˆäº†ã€‚å¯¹äºæœ‰ç´¢å¼•çš„è¡¨ï¼Œæ‰§è¡Œçš„é€»è¾‘ä¹Ÿå·®ä¸å¤šã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ˜¯â€œå–æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€è¡Œâ€è¿™ä¸ªæ¥ å£ï¼Œä¹‹åå¾ªç¯å–â€œæ»¡è¶³æ¡ä»¶çš„ä¸‹ä¸€è¡Œâ€è¿™ä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£éƒ½æ˜¯å¼•æ“ä¸­å·²ç»å®šä¹‰å¥½çš„ã€‚ä½ ä¼šåœ¨æ•°æ®åº“çš„æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­çœ‹åˆ°ä¸€ä¸ª rows_examined çš„å­—æ®µï¼Œè¡¨ç¤ºè¿™ä¸ªè¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰«æäº†å¤šå°‘è¡Œã€‚è¿™ä¸ªå€¼å°±æ˜¯åœ¨æ‰§è¡Œå™¨æ¯æ¬¡è°ƒç”¨å¼•æ“è·å–æ•°æ®è¡Œçš„æ—¶å€™ç´¯åŠ  çš„ã€‚åœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œæ‰§è¡Œå™¨è°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨å¼•æ“å†…éƒ¨åˆ™æ‰«æäº†å¤šè¡Œï¼Œå› æ­¤å¼•æ“æ‰«æè¡Œæ•°è·Ÿ rows_examined å¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"æ•°æ®ç»“æ„å’Œç®—æ³•","slug":"2.ç®—æ³•/é¢è¯•-æ•°æ®ç»“æ„å’Œç®—æ³•","date":"2022-03-30T16:00:00.000Z","updated":"2024-08-22T03:23:14.706Z","comments":true,"path":"2022/03/31/2.ç®—æ³•/é¢è¯•-æ•°æ®ç»“æ„å’Œç®—æ³•/","link":"","permalink":"https://zhangxin66666.github.io/2022/03/31/2.%E7%AE%97%E6%B3%95/%E9%9D%A2%E8%AF%95-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/","excerpt":"","text":"æ’åºç®—æ³•é«˜æ•ˆäº¤æ¢ç®—æ³•(å¼‚æˆ–^)æ¦‚å¿µ 0^N = N ; N^N = 0 ç›¸åŒä¸º0ï¼Œä¸åŒä¸º1ï¼Œä¹Ÿå¯ä»¥å«åšæ— è¿›ä½ç›¸åŠ ï¼Œè¿™ä¹ˆåšçš„å‰æï¼šéœ€è¦äº¤æ¢çš„ä¸¤ä¸ªæ•°æŒ‡å‘çš„å†…å­˜æ˜¯ä¸¤ä½ä½ç½® å¼‚æˆ–è¿ç®—æ»¡è¶³äº¤æ¢å¾‹å’Œç»“åˆå¾‹ ä¸ç”¨é¢å¤–å˜é‡äº¤æ¢ä¸¤ä¸ªæ•° 123456// äº¤æ¢arrçš„iå’Œjä½ç½®ä¸Šçš„å€¼public static void swap(int[] arr, int i, int j) &#123; arr[i] = arr[i] ^ arr[j]; arr[j] = arr[i] ^ arr[j]; arr[i] = arr[i] ^ arr[j];&#125; ä¸€ç§æ•°å‡ºç°å¥‡æ•°æ¬¡ä¸€ä¸ªæ•°ç»„ä¸­æœ‰ä¸€ä¸ªæ•°å‡ºç°å¥‡æ•°æ¬¡ï¼Œå…¶ä»–æ•°éƒ½å‡ºç°å¶æ•°æ¬¡ï¼Œæ€ä¹ˆæ‰¾åˆ°è¿™ä¸€ä¸ªæ•°ï¼Ÿ 1234567public static void printOddTimesNum1(int[] arr) &#123; int eor = 0; for (int i = 0; i &lt; arr.length; i++) &#123; eor ^= arr[i]; &#125; System.out.println(eor);&#125; ä¸¤ç§æ•°å‡ºç°å¥‡æ•°æ¬¡ä¸€ä¸ªæ•°ç»„ä¸­æœ‰ä¸¤ä¸ªæ•°å‡ºç°å¥‡æ•°æ¬¡ï¼Œå…¶ä»–æ•°éƒ½å‡ºç°äº†å¶æ•°æ¬¡ï¼Œæ€ä¹ˆæ‰¾åˆ°è¿™ä¸¤ä¸ªæ•°ï¼Ÿ 123456789101112131415161718192021public static void printOddTimesNum2(int[] arr) &#123; int eor = 0; for (int i = 0; i &lt; arr.length; i++) &#123; eor ^= arr[i]; &#125; // a å’Œ bæ˜¯ä¸¤ç§æ•° // eor != 0 // eoræœ€å³ä¾§çš„1ï¼Œæå–å‡ºæ¥ // eor : 00110010110111000 // rightOne :00000000000001000 int rightOne = eor &amp; (-eor); // æå–å‡ºæœ€å³çš„1 int onlyOne = 0; // eor&#x27; for (int i = 0 ; i &lt; arr.length;i++) &#123; // arr[1] = 111100011110000 // rightOne= 000000000010000 if ((arr[i] &amp; rightOne) != 0) &#123; onlyOne ^= arr[i]; &#125; &#125; System.out.println(onlyOne + &quot; &quot; + (eor ^ onlyOne));&#125; å†’æ³¡æ’åº åŸºæœ¬å†’æ³¡æ’åºç®—æ³• 123456789101112131415public static void bubbleSort(int[] arr) &#123; if (arr == null || arr.length &lt; 2) &#123; return; &#125; // 0 ~ N-1 // 0 ~ N-2 // 0 ~ N-3 for (int e = arr.length - 1; e &gt; 0; e--) &#123; // 0 ~ e for (int i = 0; i &lt; e; i++) &#123; if (arr[i] &gt; arr[i + 1]) &#123; swap(arr, i, i + 1); &#125; &#125; &#125; &#125; å†’æ³¡æ’åºç®—æ³•ä¼˜åŒ– åœ¨ä¸€è¶Ÿæ’åºè¿‡ç¨‹ä¸­å¦‚æœä¸€æ¬¡éƒ½æ²¡æœ‰äº¤æ¢è¿‡ï¼Œé‚£è¯´æ˜åç»­çš„æ•°éƒ½æ˜¯æœ‰åºçš„ï¼Œä¸éœ€è¦åœ¨è¿›è¡Œåç»­çš„æ’åºäº†ï¼Œå¦‚æœå…ƒç´ æœ¬æ¥å°±æ˜¯æœ‰åºçš„ï¼Œå°±åªæ¯”è¾ƒä¸€æ¬¡å°±ç»“æŸäº†ã€‚ 12345678910111213141516171819202122232425public static void bubbleSort(int[] arr) &#123; if (arr == null || arr.length &lt; 2) &#123; return; &#125; // æ ‡è¯†å˜é‡ï¼Œè¡¨ç¤ºæ˜¯å¦è¿›è¡Œè¿‡äº¤æ¢ boolean flag = false; for (int i = 0; i &lt; arr.length - 1; i++) &#123; for (int j = 0; j &lt; arr.length - 1 - i; j++) &#123; // å¦‚æœå‰é¢çš„æ•°æ¯”åé¢çš„æ•°å¤§ï¼Œåˆ™äº¤æ¢ if (arr[j] &gt; arr[j + 1]) &#123; flag = true; int temp = arr[j]; arr[j] = arr[j + 1]; arr[j + 1] = temp; &#125; &#125; // åœ¨ä¸€è¶Ÿæ’åºä¸­ï¼Œä¸€æ¬¡äº¤æ¢éƒ½æ²¡æœ‰å‘ç”Ÿè¿‡ if (!flag) &#123; break; &#125; else &#123; // é‡ç½®flag!!!, è¿›è¡Œä¸‹æ¬¡åˆ¤æ–­ flag = false; &#125; &#125;&#125; é€‰æ‹©æ’åº 0 ~ N-1 æ‰¾åˆ°æœ€å°å€¼ï¼Œåœ¨å“ªï¼Œæ”¾åˆ°0ä½ç½®ä¸Š 1 ~ n-1 æ‰¾åˆ°æœ€å°å€¼ï¼Œåœ¨å“ªï¼Œæ”¾åˆ°1 ä½ç½®ä¸Š 2 ~ n-1 æ‰¾åˆ°æœ€å°å€¼ï¼Œåœ¨å“ªï¼Œæ”¾åˆ°2 ä½ç½®ä¸Š 123456789101112public static void selectionSort(int[] arr) &#123; if (arr == null || arr.length &lt; 2) &#123; return; &#125; for (int i = 0; i &lt; arr.length - 1; i++) &#123; int minIndex = i; for (int j = i + 1; j &lt; arr.length; j++) &#123; // i ~ N-1 ä¸Šæ‰¾æœ€å°å€¼çš„ä¸‹æ ‡ minIndex = arr[j] &lt; arr[minIndex] ? j : minIndex; &#125; swap(arr, i, minIndex); &#125;&#125; æ’å…¥æ’åº 0~1å•èŒƒå›´æœ‰åº 0~2èŒƒå›´æœ‰åº 0~3èŒƒå›´æœ‰åº 0~NèŒƒå›´æœ‰åº 1234567891011public static void insertionSort(int[] arr) &#123; if (arr == null || arr.length &lt; 2) &#123; return; &#125; // ä¸åª1ä¸ªæ•° for (int i = 1; i &lt; arr.length; i++) &#123; // 0 ~ i åšåˆ°æœ‰åº for (int j = i - 1; j &gt;= 0 &amp;&amp; arr[j] &gt; arr[j + 1]; j--) &#123; swap(arr, j, j + 1); &#125; &#125;&#125; æŸ¥æ‰¾ç®—æ³•äºŒåˆ†æŸ¥æ‰¾äºŒåˆ†æ³•çš„è¯¦è§£ä¸æ‰©å±• åœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ä¸­ï¼ŒæŸ¥æ‰¾æŸä¸ªæ•°æ˜¯å¦å­˜åœ¨ åœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ä¸­ï¼Œæ‰¾&gt;=æŸä¸ªæ•°æœ€å·¦ä¾§çš„ä½ç½® å±€éƒ¨æœ€å°å€¼é—®é¢˜ 1234567891011121314151617181920public static boolean exist(int[] sortedArr, int num) &#123; if (sortedArr == null || sortedArr.length == 0) &#123; return false; &#125; int L = 0; int R = sortedArr.length - 1; int mid = 0; // L..R while (L &lt; R) &#123; // L..R è‡³å°‘ä¸¤ä¸ªæ•°çš„æ—¶å€™ mid = L + ((R - L) &gt;&gt; 1); if (sortedArr[mid] == num) &#123; return true; &#125; else if (sortedArr[mid] &gt; num) &#123; R = mid - 1; &#125; else &#123; L = mid + 1; &#125; &#125; return sortedArr[L] == num;&#125; æ•°ç»„èŒƒå›´ä¸Šæ±‚æœ€å¤§å€¼é€’å½’è§£æ³• 123456789101112public static int process(int[] arr, int L, int R) &#123; // arr[L..R]èŒƒå›´ä¸Šåªæœ‰ä¸€ä¸ªæ•°ï¼Œç›´æ¥è¿”å›ï¼Œbase case if (L == R) &#123; return arr[L]; &#125; // L...R ä¸åªä¸€ä¸ªæ•° // mid = (L + R) / 2 int mid = L + ((R - L) &gt;&gt; 1); // ä¸­ç‚¹ int leftMax = process(arr, L, mid); int rightMax = process(arr, mid + 1, R); return Math.max(leftMax, rightMax);&#125; å¯¹æ•°å™¨çš„æ¦‚å¿µ æœ‰ä¸€ä¸ªä½ æƒ³è¦æµ‹è¯•çš„æ–¹æ³•a å®ç°å¤æ‚åº¦ä¸å¥½ä½†æ˜¯å®¹æ˜“å®ç°çš„æ–¹æ³•b å®ç°ä¸€ä¸ªéšæœºæ ·æœ¬äº§ç”Ÿå™¨ æŠŠæ–¹æ³•aå’Œæ–¹æ³•bè·‘ç›¸åŒçš„éšæœºæ ·æœ¬ï¼Œçœ‹çœ‹å¾—åˆ°çš„ç»“æœæ˜¯å¦ä¸€æ · å¦‚æœæœ‰ä¸€ä¸ªéšæœºæ ·æœ¬æ—¶çš„æ¯”å¯¹ç»“æœä¸ä¸€è‡´ï¼Œæ‰“å°æ ·æœ¬è¿›è¡Œäººå·¥å¹²é¢„ï¼Œæ”¹å¯¹æ–¹æ³•aæˆ–è€…æ–¹æ³•b å½“æ ·æœ¬æ•°é‡å¾ˆå¤šæ—¶æ¯”å¯¹æµ‹è¯•ä¾ç„¶æ­£ç¡®ï¼Œå¯ä»¥ç¡®å®šæ–¹æ³•aå·²ç»æ­£ç¡® æ•°ç»„abæ•°ç»„åˆå¹¶åˆ°a é¢˜ç›®ï¼šç»™å‡ºä¸¤ä¸ªæœ‰åºçš„æ•´æ•°æ•°ç»„Aå’ŒBï¼Œè¯·å°†æ•°ç»„Båˆå¹¶åˆ°æ•°ç»„Aä¸­ï¼Œå˜æˆä¸€ä¸ªæœ‰åºçš„æ•°ç»„ã€‚æ³¨æ„ï¼šå¯ä»¥å‡è®¾Aæ•°ç»„æœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜æ”¾Bæ•°ç»„çš„å…ƒç´ ï¼ŒAå’ŒBä¸­åˆå§‹çš„å…ƒç´ æ•°ç›®åˆ†åˆ«ä¸ºmå’Œnã€‚ é¢˜è§£ï¼šæœ€ä¼˜è§£ï¼šä»åå¾€å‰å¤„ç†,ä¸éœ€è¦å¼€è¾Ÿé¢å¤–ç©ºé—´ã€‚ä»åå¾€å‰ï¼Œè¿™æ ·ä¸éœ€è¦è¿›è¡Œå†—ä½™å¤„ç†ã€‚ 12345678910111213141516171819202122/** * @param a æ•°ç»„aï¼Œæœ‰è¶³å¤Ÿçš„ç©ºé—´åˆå¹¶æ•°ç»„b * @param m æ•°ç»„aé‡Œé¢çš„å…ƒç´ ä¸ªæ•° * @param b æ•°ç»„b * @param n æ•°ç»„bé‡Œé¢çš„å…ƒç´ ä¸ªæ•° */public static void merge(int[] a, int m, int[] b, int n) &#123; int i = m - 1; int j = n - 1; int index = m + n - 1; while (i &gt;= 0 &amp;&amp; j &gt;= 0) &#123; if(a[i] &gt; b[j] )&#123; a[index--] = a[i--]; &#125; else &#123; a[index--] = b[j--]; &#125; &#125; //å¦‚æœAçš„æ•°å­—æ¯”Bå¤šï¼Œåˆ™ä¸ä¼šè¿›å…¥åç»­å¤„ç†ï¼›å¦‚æœBçš„æ•°å­—æ¯”Aå¤šï¼Œåˆ™è¿›å…¥åç»­å¤„ç†ï¼Œå°†Bå‰©ä½™æ•°å­—æ·»åŠ åˆ°æ•°ç»„Aä¸­ã€‚ while (j &gt;= 0) &#123; a[index--] = b[j--]; &#125;&#125; abæ•°ç»„åˆå¹¶åˆ°c é¢˜ç›®ï¼š åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•´å‹æ•°æ®ï¼ˆå…¥å‚ä¸¤ä¸ªéœ€è¦åˆå¹¶çš„æ•°ç»„ï¼Œè¿”å›å€¼åˆå¹¶å¥½çš„æ–°æ•°ç»„ï¼‰ 123456789101112131415161718192021222324252627private static int[] margeArr(int[] a, int[] b) &#123; int[] c = new int[a.length + b.length]; int i = 0, j = 0; int index = 0; //æ¯”è¾ƒæŒ‡é’ˆi,jæŒ‡å‘çš„å€¼ï¼Œå°çš„å€¼å­˜å…¥æŒ‡é’ˆindexæŒ‡å‘çš„ç»“æœæ•°ç»„ä¸­ï¼Œå½“æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ˆiæˆ–jï¼‰å…ˆåˆ°è¾¾æ•°ç»„æœ«å°¾æ—¶ï¼Œæ¯”è¾ƒç»“æŸï¼› while (i &lt; a.length &amp;&amp; j &lt; b.length) &#123; if (a[i] &lt; b[j]) &#123; c[index++] = a[i++]; &#125; else &#123; c[index++] = b[j++]; &#125; &#125; int l; //å°†æŒ‡é’ˆï¼ˆiæˆ–jï¼‰æ²¡æœ‰åˆ°è¾¾æ•°ç»„æœ«å°¾çš„æ•°ç»„å¤åˆ¶åˆ°æŒ‡é’ˆindexæŒ‡å‘çš„ç»“æœæ•°ç»„ä¸­ if (i &lt; a.length) &#123; for (l = i; l &lt; a.length; l++) &#123; c[index++] = a[l]; &#125; &#125; //å°†æŒ‡é’ˆï¼ˆiæˆ–jï¼‰æ²¡æœ‰åˆ°è¾¾æ•°ç»„æœ«å°¾çš„æ•°ç»„å¤åˆ¶åˆ°æŒ‡é’ˆindexæŒ‡å‘çš„ç»“æœæ•°ç»„ä¸­ if (j &lt; b.length) &#123; for (l = j; l &lt; b.length; l++) &#123; c[index++] = b[l]; &#125; &#125; return c;&#125; æŸ¥æ‰¾ä¸¤æ•°ä¹‹å’Œç­‰äºç›®æ ‡æ•° é¢˜ç›®ï¼šç»™å®šä¸€ä¸ªæ•°ç»„å’Œä¸€ä¸ªç›®æ ‡æ•°ï¼Œä»æ•°ç»„ä¸­æ‰¾åˆ°ä¸¤ä¸ªæ•°ï¼Œæ˜¯è¿™ä¸¤ä¸ªæ•°ä¹‹å’Œç­‰äºç›®æ ‡æ•°ã€‚è¿”å›å…¶åœ¨æ•°ç»„ä¸­çš„ç¼–å· 12345678910public static int[] twoSum(int[] nums, int target) &#123; Map&lt;Integer, Integer&gt; map = new HashMap&lt;&gt;(); for (int i = 0; i &lt; nums.length; i++) &#123; if (map.containsKey(target - nums[i])) &#123; return new int[]&#123;map.get(target - nums[i]), i&#125;; &#125; map.put(nums[i], i); &#125; return null;&#125; èºæ—‹æ‰“å°äºŒç»´æ•°ç»„1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public static void printEdge(int[][] m, int tR, int tC, int dR, int dC) &#123; if (tR == dR) &#123; for (int i = tC; i &lt;= dC; i++) &#123; System.out.print(m[tR][i] + &quot; &quot;); &#125; &#125; else if (tC == dC) &#123; for (int i = tR; i &lt;= dR; i++) &#123; System.out.print(m[i][tC] + &quot; &quot;); &#125; &#125; else &#123; int curC = tC; int curR = tR; while (curC != dC) &#123; System.out.print(m[tR][curC] + &quot; &quot;); curC++; &#125; while (curR != dR) &#123; System.out.print(m[curR][dC] + &quot; &quot;); curR++; &#125; while (curC != tC) &#123; System.out.print(m[dR][curC] + &quot; &quot;); curC--; &#125; while (curR != tR) &#123; System.out.print(m[curR][tC] + &quot; &quot;); curR--; &#125; &#125;&#125;public static void spiralOrderPrint(int[][] matrix) &#123; int tR = 0; int tC = 0; int dR = matrix.length - 1; int dC = matrix[0].length - 1; while (tR &lt;= dR &amp;&amp; tC &lt;= dC) &#123; printEdge(matrix, tR++, tC++, dR--, dC--); &#125;&#125;public static void main(String[] args) &#123; int[][] matrix = &#123; &#123; 1, 2, 3, 4 &#125;, &#123; 5, 6, 7, 8 &#125;, &#123; 9, 10, 11, 12 &#125;, &#123; 13, 14, 15, 16 &#125; &#125;; spiralOrderPrint(matrix);&#125; é“¾è¡¨ å¯¹äºç¬”è¯•ï¼Œä¸ç”¨å¤ªåœ¨ä¹ç©ºé—´å¤æ‚åº¦ï¼Œä¸€åˆ‡ä¸ºäº†æ—¶é—´å¤æ‚åº¦ å¯¹äºé¢è¯•ï¼Œæ—¶é—´å¤æ‚åº¦ä¾ç„¶æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œä½†æ˜¯ä¸€å®šè¦æ‰¾åˆ°ç©ºé—´æœ€çœçš„æ–¹æ³• é‡è¦æŠ€å·§ é¢å¤–æ•°æ®ç»“æ„è®°å½•ï¼ˆå“ˆå¸Œè¡¨ç­‰ï¼‰ å¿«æ…¢æŒ‡é’ˆ é“¾è¡¨åè½¬å•å‘é“¾è¡¨åè½¬123456789// å•å‘é“¾è¡¨èŠ‚ç‚¹public static class Node &#123; public int value; public Node next; public Node(int data) &#123; value = data; &#125;&#125; 1234567891011121314// head å•å‘é“¾è¡¨åè½¬ç®—æ³•// a -&gt; b -&gt; c -&gt; null// c -&gt; b -&gt; a -&gt; nullpublic static Node reverseLinkedList(Node head) &#123; Node pre = null; Node next = null; while (head != null) &#123; next = head.next; head.next = pre; pre = head; head = next; &#125; return pre;&#125; 123456789101112/** * é€’å½’åè½¬æ–¹å¼ */private Node reverseLinkedList(Node head) &#123; if (head == null || head.next == null) &#123; return head; &#125; Node newHead = reverseLinkedList(head.next); head.next.next = head; head.next = null; return newHead;&#125; åŒå‘é“¾è¡¨åè½¬12345678910// åŒå‘é“¾è¡¨èŠ‚ç‚¹public static class DoubleNode &#123; public int value; public DoubleNode last; public DoubleNode next; public DoubleNode(int data) &#123; value = data; &#125;&#125; 12345678910111213// åŒå‘é“¾è¡¨åè½¬ç®—æ³•public static DoubleNode reverseDoubleList(DoubleNode head) &#123; DoubleNode pre = null; DoubleNode next = null; while (head != null) &#123; next = head.next; head.next = pre; head.last = next; pre = head; head = next; &#125; return pre;&#125; æŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹å¿«æ…¢æŒ‡é’ˆåº”ç”¨ æŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹æˆ–ä¸­ç‚¹ä¸Šä¸€ä¸ª1234567891011121314// head å¤´ è§£ï¼šæŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹æˆ–è€…ä¸­ç‚¹å‰ä¸€ä¸ªèŠ‚ç‚¹public static Node midOrUpMidNode(Node head) &#123; if (head == null || head.next == null || head.next.next == null) &#123; return head; &#125; // é“¾è¡¨æœ‰3ä¸ªç‚¹æˆ–ä»¥ä¸Š Node slow = head.next; Node fast = head.next.next; while (fast.next != null &amp;&amp; fast.next.next != null) &#123; slow = slow.next; fast = fast.next.next; &#125; return slow;&#125; æŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹æˆ–ä¸­ç‚¹ä¸‹ä¸€ä¸ª12345678910111213// æŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹æˆ–è€…ä¸­ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹public static Node midOrDownMidNode(Node head) &#123; if (head == null || head.next == null) &#123; return head; &#125; Node slow = head.next; Node fast = head.next; while (fast.next != null &amp;&amp; fast.next.next != null) &#123; slow = slow.next; fast = fast.next.next; &#125; return slow;&#125; åˆ¤æ–­ä¸€ä¸ªé“¾è¡¨æ˜¯å¦æ˜¯å›æ–‡ç»“æ„ã€é¢˜ç›®ã€‘ç»™å®šä¸€ä¸ªå•å‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹headï¼Œè¯·åˆ¤æ–­è¯¥é“¾è¡¨æ˜¯å¦ä¸ºå›æ–‡ç»“æ„ã€‚ã€ä¾‹å­ã€‘1-&gt;2-&gt;1,è¿”å›true;1-&gt;2-&gt;2-&gt;1,è¿”å›trueï¼›15-&gt;6-&gt;15ï¼Œè¿”å›trueï¼›1-&gt;2-&gt;3ï¼Œè¿”å›falseã€‚å¦‚æœé“¾è¡¨é•¿åº¦ä¸ºNï¼Œæ—¶é—´å¤æ‚åº¦è¾¾åˆ°O(N)ï¼Œé¢å¤–ç©ºé—´å¤æ‚åº¦è¾¾åˆ°O(1)ã€‚ è§£é¢˜æ€è·¯1ï¼š 1ï¼šéå†é“¾è¡¨ï¼ŒæŠŠæ¯ä¸ªå…ƒç´ æ”¾åˆ°æ ˆé‡Œé¢ï¼›2ï¼šä»æ ˆé‡Œé¢ä¾æ¬¡å¼¹å‡ºå…ƒç´ å’ŒåŸæ¥é“¾è¡¨æŒ¨ä¸ªå…ƒç´ æ¯”å¯¹ã€‚ è§£é¢˜æ€è·¯2ï¼š 1ï¼šé€šè¿‡å¿«æ…¢æŒ‡é’ˆæ‰¾åˆ°ä¸­ç‚¹å’Œç»“æŸç‚¹ï¼ŒåªæŠŠå³ä¾§éƒ¨åˆ†æ”¾åˆ°æ ˆé‡Œé¢å»ï¼›2ï¼šä»æ ˆé‡Œé¢ä¾æ¬¡å¼¹å‡ºå…ƒç´ å’ŒåŸæ¥é“¾è¡¨æŒ¨ä¸ªå…ƒç´ æ¯”å¯¹ã€‚ 12345678910111213141516// 1ï¼šéå†é“¾è¡¨ï¼ŒæŠŠæ¯ä¸ªå…ƒç´ æ”¾åˆ°æ ˆé‡Œé¢ï¼›2ï¼šä»æ ˆé‡Œé¢ä¾æ¬¡å¼¹å‡ºå…ƒç´ å’ŒåŸæ¥é“¾è¡¨æŒ¨ä¸ªå…ƒç´ æ¯”å¯¹public static boolean isPalindrome1(Node head) &#123; Stack&lt;Node&gt; stack = new Stack&lt;Node&gt;(); Node cur = head; while (cur != null) &#123; stack.push(cur); cur = cur.next; &#125; while (head != null) &#123; if (head.value != stack.pop().value) &#123; return false; &#125; head = head.next; &#125; return true;&#125; 123456789101112131415161718192021222324// 1ï¼šé€šè¿‡å¿«æ…¢æŒ‡é’ˆæ‰¾åˆ°ä¸­ç‚¹å’Œç»“æŸç‚¹ï¼ŒåªæŠŠå³ä¾§éƒ¨åˆ†æ”¾åˆ°æ ˆé‡Œé¢å»ï¼›2ï¼šä»æ ˆé‡Œé¢ä¾æ¬¡å¼¹å‡ºå…ƒç´ å’ŒåŸæ¥é“¾è¡¨æŒ¨ä¸ªå…ƒç´ æ¯”å¯¹public static boolean isPalindrome2(Node head) &#123; if (head == null || head.next == null) &#123; return true; &#125; Node right = head.next; Node cur = head; while (cur.next != null &amp;&amp; cur.next.next != null) &#123; right = right.next; cur = cur.next.next; &#125; Stack&lt;Node&gt; stack = new Stack&lt;Node&gt;(); while (right != null) &#123; stack.push(right); right = right.next; &#125; while (!stack.isEmpty()) &#123; if (head.value != stack.pop().value) &#123; return false; &#125; head = head.next; &#125; return true;&#125; é“¾è¡¨æ’åºå•å‘é“¾è¡¨åˆ†å·¦ä¸­å³ã€é¢˜ç›®ã€‘ å°†å•å‘é“¾è¡¨æŒ‰ç…§æŸå€¼åˆ’åˆ†æˆå·¦è¾¹å°ï¼Œä¸­é—´ç›¸ç­‰ï¼Œå³è¾¹å¤§çš„å½¢å¼ï¼šç»™å®šä¸€ä¸ªå•é“¾è¡¨å¤´èŠ‚ç‚¹headï¼ŒèŠ‚ç‚¹çš„å€¼ç±»å‹æ˜¯æ•´å‹ï¼Œå†ç»™å®šä¸€ä¸ªæ•´æ•°pivotã€‚å®ç°ä¸€ä¸ªè°ƒæ•´é“¾è¡¨çš„å‡½æ•°ï¼Œå°†é“¾è¡¨è°ƒæ•´ä¸ºåšéƒ¨åˆ†éƒ½æ˜¯å€¼å°äºpivotçš„èŠ‚ç‚¹ï¼Œä¸­é—´éƒ¨åˆ†éƒ½æ˜¯å€¼ç­‰äºpiovtçš„èŠ‚ç‚¹ï¼Œæœ‰éƒ¨åˆ†éƒ½æ˜¯å€¼å¤§äºpiovtçš„èŠ‚ç‚¹ã€‚ã€è¿›é˜¶ã€‘åœ¨å®ç°åŸé—®é¢˜åŠŸèƒ½çš„åŸºç¡€ä¸Šå¢åŠ è¦æ±‚ï¼šå°äºï¼Œç­‰äºï¼Œå¤§äºpivotèŠ‚ç‚¹ä¹‹é—´é¡ºåºå’Œä¹‹å‰ä¸€æ ·ï¼Œæ—¶é—´å¤æ‚åº¦O(N)ï¼Œé¢å¤–ç©ºé—´å¤æ‚åº¦O(1)ã€‚ è§£é¢˜æ€è·¯1ï¼š å°†é“¾è¡¨æ”¾å…¥æ•°ç»„ï¼Œæ’åºï¼Œå†è½¬æˆé“¾è¡¨ è§£é¢˜æ€è·¯2ï¼š å·¦ä¸­å³åˆ†åˆ«å‡†å¤‡ä¸¤ä¸ªæŒ‡é’ˆ(å…±6ä¸ªå˜é‡)ï¼Œç„¶åéå†åŸé“¾è¡¨ï¼Œæ’åºä¹‹ååˆ†åˆ«æ’å…¥ç›¸åº”ä½ç½®(è€ƒè™‘è¾¹ç•Œé—®é¢˜) 12345678910111213141516171819202122232425262728293031323334353637383940414243444546// å°†é“¾è¡¨æ”¾å…¥æ•°ç»„ï¼Œæ’åºï¼Œå†è½¬æˆé“¾è¡¨public static Node listPartition1(Node head, int pivot) &#123; if (head == null) &#123; return head; &#125; Node cur = head; int i = 0; while (cur != null) &#123; i++; cur = cur.next; &#125; Node[] nodeArr = new Node[i]; i = 0; cur = head; for (i = 0; i != nodeArr.length; i++) &#123; nodeArr[i] = cur; cur = cur.next; &#125; arrPartition(nodeArr, pivot); for (i = 1; i != nodeArr.length; i++) &#123; nodeArr[i - 1].next = nodeArr[i]; &#125; nodeArr[i - 1].next = null; return nodeArr[0];&#125;public static void arrPartition(Node[] nodeArr, int pivot) &#123; int small = -1; int big = nodeArr.length; int index = 0; while (index != big) &#123; if (nodeArr[index].value &lt; pivot) &#123; swap(nodeArr, ++small, index++); &#125; else if (nodeArr[index].value == pivot) &#123; index++; &#125; else &#123; swap(nodeArr, --big, index); &#125; &#125;&#125;public static void swap(Node[] nodeArr, int a, int b) &#123; Node tmp = nodeArr[a]; nodeArr[a] = nodeArr[b]; nodeArr[b] = tmp;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354// å·¦ä¸­å³åˆ†åˆ«å‡†å¤‡ä¸¤ä¸ªæŒ‡é’ˆ(å…±6ä¸ªå˜é‡)ï¼Œç„¶åéå†åŸé“¾è¡¨ï¼Œæ’åºä¹‹ååˆ†åˆ«æ’å…¥ç›¸åº”ä½ç½®(è€ƒè™‘è¾¹ç•Œé—®é¢˜)public static Node listPartition2(Node head, int pivot) &#123; Node sH = null; // small head Node sT = null; // small tail Node eH = null; // equal head Node eT = null; // equal tail Node mH = null; // big head Node mT = null; // big tail Node next = null; // save next node // every node distributed to three lists while (head != null) &#123; next = head.next; head.next = null; if (head.value &lt; pivot) &#123; if (sH == null) &#123; sH = head; sT = head; &#125; else &#123; sT.next = head; sT = head; &#125; &#125; else if (head.value == pivot) &#123; if (eH == null) &#123; eH = head; eT = head; &#125; else &#123; eT.next = head; eT = head; &#125; &#125; else &#123; if (mH == null) &#123; mH = head; mT = head; &#125; else &#123; mT.next = head; mT = head; &#125; &#125; head = next; &#125; // å°äºåŒºåŸŸçš„å°¾å·´ï¼Œè¿ç­‰äºåŒºåŸŸçš„å¤´ï¼Œç­‰äºåŒºåŸŸçš„å°¾å·´è¿å¤§äºåŒºåŸŸçš„å¤´ if (sT != null) &#123; // å¦‚æœæœ‰å°äºåŒºåŸŸ sT.next = eH; eT = eT == null ? sT : eT; // ä¸‹ä¸€æ­¥ï¼Œè°å»è¿å¤§äºåŒºåŸŸçš„å¤´ï¼Œè°å°±å˜æˆeT &#125; // ä¸‹ä¸€æ­¥ï¼Œä¸€å®šæ˜¯éœ€è¦ç”¨eT å»æ¥ å¤§äºåŒºåŸŸçš„å¤´ // æœ‰ç­‰äºåŒºåŸŸï¼ŒeT -&gt; ç­‰äºåŒºåŸŸçš„å°¾ç»“ç‚¹ // æ— ç­‰äºåŒºåŸŸï¼ŒeT -&gt; å°äºåŒºåŸŸçš„å°¾ç»“ç‚¹ // eT å°½é‡ä¸ä¸ºç©ºçš„å°¾å·´èŠ‚ç‚¹ if (eT != null) &#123; // å¦‚æœå°äºåŒºåŸŸå’Œç­‰äºåŒºåŸŸï¼Œä¸æ˜¯éƒ½æ²¡æœ‰ eT.next = mH; &#125; return sH != null ? sH : (eH != null ? eH : mH);&#125; é“¾è¡¨é—­ç¯åŠç›¸äº¤é—®é¢˜å•é“¾è¡¨æŸ¥æ‰¾é—­ç¯ä½ç½®æ³¨ï¼šå•é“¾è¡¨é—­ç¯åªèƒ½æœ‰ä¸€ä¸ªç¯ï¼Œå¦‚æœäº§ç”Ÿç¯ï¼Œå¿…ç„¶ä¼šå‡ºç°é—­ç¯ è§£æ³•1ï¼šé¢å¤–ç©ºé—´è§£å†³ ç”³è¯·ä¸€ä¸ªseté›†åˆï¼Œä»å¤´èŠ‚ç‚¹éå†é“¾è¡¨ï¼Œæ¯éå†ä¸€ä¸ªå…ƒç´ å°±æŸ¥è¯¢è¯¥èŠ‚ç‚¹æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœæ²¡æœ‰å°±æŠŠè¯¥èŠ‚ç‚¹æ”¾è¿›å»ï¼Œå¦‚æœæœ‰ï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯ç¯ä½ç½® 1.... è§£æ³•2ï¼šæœ‰é™å‡ ä¸ªå˜é‡è§£å†³ å¿«æ…¢æŒ‡é’ˆä»å•é“¾è¡¨å¤´èŠ‚ç‚¹å¼€å§‹èµ°ï¼Œç›´è‡³ä¸¤ä¸ªèŠ‚ç‚¹ç›¸é‡ï¼Œè¯´æ˜æœ‰ç¯ï¼Œæœ€åæŒ‡å‘nullï¼Œè¯´æ˜æ— ç¯ ç›¸é‡ä¹‹åå¿«æŒ‡é’ˆå›åˆ°å¤´èŠ‚ç‚¹ï¼Œä¹‹åä¸€æ¬¡èµ°ä¸€æ­¥ï¼Œæ…¢æŒ‡é’ˆåœåœ¨åŸåœ°ï¼Œå†æ¬¡ç›¸é‡çš„ä½ç½®å³æ˜¯ç¯èŠ‚ç‚¹ä½ç½®(è®°ä½ç»“è®ºï¼Œä¸è¦é—®ä¸ºä»€ä¹ˆ) 123456789101112131415161718192021222324252627282930public static class Node &#123; public int value; public Node next; public Node(int data) &#123; this.value = data; &#125;&#125;// æ‰¾åˆ°é“¾è¡¨ç¬¬ä¸€ä¸ªå…¥ç¯èŠ‚ç‚¹ï¼Œå¦‚æœæ— ç¯ï¼Œè¿”å›nullpublic static Node getLoopNode(Node head) &#123; if (head == null || head.next == null || head.next.next == null) &#123; return null; &#125; // n1 æ…¢ n2 å¿« Node slow = head.next; // n1 -&gt; slow Node fast = head.next.next; // n2 -&gt; fast while (slow != fast) &#123; if (fast.next == null || fast.next.next == null) &#123; return null; &#125; fast = fast.next.next; slow = slow.next; &#125; // slow fast ç›¸é‡ fast = head; // n2 -&gt; walk again from head while (slow != fast) &#123; slow = slow.next; fast = fast.next; &#125; return slow;&#125; ä¸¤ä¸ªæ— ç¯é“¾è¡¨äº¤ç‚¹ä½ç½®æ³¨ï¼š å¦‚æœä¸¤ä¸ªå•å‘é“¾è¡¨ç›¸äº¤ï¼Œç›¸äº¤åé¢çš„éƒ¨åˆ†å¿…ç„¶æ˜¯å…±æœ‰çš„ï¼Œé‚£ä¹ˆä¸¤ä¸ªé“¾è¡¨æœ€åçš„é‚£ä¸ªèŠ‚ç‚¹å¿…ç„¶æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ é•¿é“¾è¡¨å…ˆèµ°ä¸¤ä¸ªé“¾è¡¨å·®å€¼çš„æ­¥æ•°ï¼Œç„¶åçŸ­é“¾è¡¨åœ¨å¼€å§‹èµ°ï¼Œä»–ä¿©ä¸€å®šä¼šåœ¨ç¬¬ä¸€ä¸ªç›¸äº¤çš„ä½ç½®ç›¸é‡ 123456789101112131415161718192021222324252627282930313233// å¦‚æœä¸¤ä¸ªé“¾è¡¨éƒ½æ— ç¯ï¼Œè¿”å›ç¬¬ä¸€ä¸ªç›¸äº¤èŠ‚ç‚¹ï¼Œå¦‚æœä¸æƒ³äº¤ï¼Œè¿”å›nullpublic static Node noLoop(Node head1, Node head2) &#123; if (head1 == null || head2 == null) &#123; return null; &#125; Node cur1 = head1; Node cur2 = head2; int n = 0; while (cur1.next != null) &#123; n++; cur1 = cur1.next; &#125; while (cur2.next != null) &#123; n--; cur2 = cur2.next; &#125; if (cur1 != cur2) &#123; return null; &#125; // n : é“¾è¡¨1é•¿åº¦å‡å»é“¾è¡¨2é•¿åº¦çš„å€¼ cur1 = n &gt; 0 ? head1 : head2; // è°é•¿ï¼Œè°çš„å¤´å˜æˆcur1 cur2 = cur1 == head1 ? head2 : head1; // è°çŸ­ï¼Œè°çš„å¤´å˜æˆcur2 n = Math.abs(n); while (n != 0) &#123; n--; cur1 = cur1.next; &#125; while (cur1 != cur2) &#123; cur1 = cur1.next; cur2 = cur2.next; &#125; return cur1;&#125; ä¸¤æ¡æœ‰ç¯é“¾è¡¨æŸ¥æ‰¾äº¤ç‚¹åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šå…¥ç¯èŠ‚ç‚¹å¯èƒ½æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚å›¾ æƒ…å†µ1ï¼šå…¥ç¯èŠ‚ç‚¹å¯èƒ½æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯æ±‚å•é“¾è¡¨çš„ç¬¬ä¸€ä¸ªç¯èŠ‚ç‚¹é—®é¢˜ï¼Œåªä¸è¿‡ä»ç›¸äº¤ä½ç½®å¼€å§‹èµ° æƒ…å†µ2ï¼šå¦‚æœé“¾è¡¨1åœ¨è½¬å›åˆ°è‡ªå·±çš„è¿‡ç¨‹ä¸­æ²¡æœ‰é‡åˆ°é“¾è¡¨2ï¼Œå°±è¯´æ˜æ˜¯å„è‡ªæˆç¯çš„ï¼Œç›¸äº¤èŠ‚ç‚¹è¿”å›ç©ºå°±é†’æ¥ï¼Œå¦‚æœé‡åˆ°ï¼Œå°±æ˜¯æƒ…å†µ2ï¼Œè¿”å›ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œéƒ½å¯¹ï¼Œéƒ½å±äºç¬¬ä¸€ä¸ªç›¸äº¤çš„èŠ‚ç‚¹ 123456789101112131415161718192021222324252627282930313233343536373839// ä¸¤ä¸ªæœ‰ç¯é“¾è¡¨ï¼Œè¿”å›ç¬¬ä¸€ä¸ªç›¸äº¤èŠ‚ç‚¹ï¼Œå¦‚æœä¸æƒ³äº¤è¿”å›nullpublic static Node bothLoop(Node head1, Node loop1, Node head2, Node loop2) &#123; Node cur1 = null; Node cur2 = null; if (loop1 == loop2) &#123; cur1 = head1; cur2 = head2; int n = 0; while (cur1 != loop1) &#123; n++; cur1 = cur1.next; &#125; while (cur2 != loop2) &#123; n--; cur2 = cur2.next; &#125; cur1 = n &gt; 0 ? head1 : head2; cur2 = cur1 == head1 ? head2 : head1; n = Math.abs(n); while (n != 0) &#123; n--; cur1 = cur1.next; &#125; while (cur1 != cur2) &#123; cur1 = cur1.next; cur2 = cur2.next; &#125; return cur1; &#125; else &#123; cur1 = loop1.next; while (cur1 != loop1) &#123; if (cur1 == loop2) &#123; return loop1; &#125; cur1 = cur1.next; &#125; return null; &#125;&#125; æŸ¥æ‰¾ä¸¤ä¸ªé“¾è¡¨ç›¸äº¤èŠ‚ç‚¹æ³¨ï¼šéš¾ç‚¹ä¸ºè€ƒè™‘æ˜¯å¦æœ‰ç¯ï¼Œæœ‰ç¯é“¾è¡¨ç›¸äº¤ä»¥åŠæ— ç¯é“¾è¡¨ç›¸äº¤é—®é¢˜ï¼Œæ²¡æœ‰ç”¨åˆ°é¢å¤–æ•°æ®ç»“æ„ï¼Œåªç”¨åˆ°æœ‰é™å‡ ä¸ªå˜é‡ 1234567891011121314151617public static Node getIntersectNode(Node head1, Node head2) &#123; if (head1 == null || head2 == null) &#123; return null; &#125; // åˆ†åˆ«æ‰¾åˆ°ä¸¤ä¸ªé“¾è¡¨çš„ç¯ä½ç½® Node loop1 = getLoopNode(head1); Node loop2 = getLoopNode(head2); if (loop1 == null &amp;&amp; loop2 == null) &#123; // æ— ç¯é“¾è¡¨ç›¸äº¤é—®é¢˜ return noLoop(head1, head2); &#125; if (loop1 != null &amp;&amp; loop2 != null) &#123; // ä¸¤æ¡æœ‰ç¯é“¾è¡¨ç›¸äº¤é—®é¢˜ return bothLoop(head1, loop1, head2, loop2); &#125; return null;&#125; äºŒå‰æ ‘æ•°æ®ç»“æ„ 12345678public static class Node &#123; public int value; public Node left; public Node right; public Node(int v) &#123; value = v; &#125;&#125; äºŒå‰æ ‘éå† å…ˆåºéå†ï¼šå¤´-&gt;å·¦-&gt;å³ ä¸­åºéå†ï¼šå·¦-&gt;å¤´-&gt;å³ ååºéå†ï¼šå·¦-&gt;å³-&gt;å¤´ é€’å½’éå†äºŒå‰æ ‘éå†è¯´æ˜ é€’å½’é€šè¿‡æ‰“å°æ—¶æœºä¸åŒï¼Œå®ç°å…ˆï¼Œä¸­ï¼Œååºéå† 12345678910public static void f(Node head) &#123; if (head == null) &#123; return; &#125; // 1 å‰åº f(head.left); // 2 ä¸­åº f(head.right); // 3 ååº&#125; éé€’å½’éå†äºŒå‰æ ‘ å…ˆåºéå†(æ·±åº¦æ€§éå†) å‡†å¤‡ä¸€ä¸ªæ ˆï¼Œæ ¹èŠ‚ç‚¹å…¥æ ˆå¼¹å‡ºï¼Œæ‰“å°ï¼Œç„¶åå…ˆå‹å³ï¼Œå†å‹å·¦ å¼¹å‡ºæ‰“å°ï¼Œå…ˆå‹å³å†å‹å·¦ï¼Œå‘¨è€Œå¤å§‹ 123456789101112131415161718public static void pre(Node head) &#123; System.out.print(&quot;pre-order: &quot;); if (head != null) &#123; Stack&lt;Node&gt; stack = new Stack&lt;Node&gt;(); stack.add(head); while (!stack.isEmpty()) &#123; head = stack.pop(); System.out.print(head.value + &quot; &quot;); if (head.right != null) &#123; stack.push(head.right); &#125; if (head.left != null) &#123; stack.push(head.left); &#125; &#125; &#125; System.out.println();&#125; ååºéå† åœ¨å…ˆåºéå†çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¢åŠ ä¸€ä¸ªæ”¶é›†æ ˆï¼Œå¼¹å‡ºæ¥å°±æ”¾åˆ°æ”¶é›†æ ˆä¸­(ä¸æ‰“å°)ï¼Œç„¶åå…ˆå‹å·¦ï¼Œå†å‹å³ æŠŠæ”¶é›†æ ˆä¸­çš„å…ƒç´ ä¾æ¬¡å‡ºæ ˆï¼Œæ‰“å° 1234567891011121314151617181920212223public static void pos1(Node head) &#123; System.out.print(&quot;pos-order: &quot;); if (head != null) &#123; Stack&lt;Node&gt; s1 = new Stack&lt;Node&gt;(); Stack&lt;Node&gt; s2 = new Stack&lt;Node&gt;(); s1.push(head); while (!s1.isEmpty()) &#123; head = s1.pop(); // å¤´ å³ å·¦ s2.push(head); if (head.left != null) &#123; s1.push(head.left); &#125; if (head.right != null) &#123; s1.push(head.right); &#125; &#125; // å·¦ å³ å¤´ while (!s2.isEmpty()) &#123; System.out.print(s2.pop().value + &quot; &quot;); &#125; &#125; System.out.println();&#125; ä¸­åºéå† æ•´æ£µæ ‘å·¦è¾¹ç•Œè¿›æ ˆï¼Œä¾æ¬¡å¼¹å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œæ‰“å°ï¼Œå¯¹å¼¹å‡ºèŠ‚ç‚¹çš„å³æ ‘å‘¨è€Œå¤å§‹ ä¸ºä»€ä¹ˆï¼Ÿ å› ä¸ºæ•´ä¸ªæ ‘éƒ½ä¼šè¢«ä»–çš„å·¦è¾¹ç•Œåˆ†è§£æ‰ï¼Œæˆ‘ä»¬æŠŠå¤´å’Œå·¦è¾¹ç•Œå‹æ ˆï¼Œç„¶åå†å³ï¼Œå‡ºæ ˆçš„æ—¶å€™å°±æ˜¯å·¦ï¼Œå¤´ï¼Œå³ 1234567891011121314151617public static void in(Node cur) &#123; System.out.print(&quot;in-order: &quot;); if (cur != null) &#123; Stack&lt;Node&gt; stack = new Stack&lt;Node&gt;(); while (!stack.isEmpty() || cur != null) &#123; if (cur != null) &#123; stack.push(cur); cur = cur.left; &#125; else &#123; cur = stack.pop(); System.out.print(cur.value + &quot; &quot;); cur = cur.right; &#125; &#125; &#125; System.out.println();&#125; å®½åº¦éå†å®½åº¦éå†å°±æ˜¯æ¨ªç€éå†ï¼Œä¹Ÿæ˜¯å±‚æ¬¡éå† ç”¨é˜Ÿåˆ—ï¼Œå¤´èŠ‚ç‚¹æ”¾é˜Ÿåˆ—ï¼Œæ¯ä¸€æ¬¡å¼¹å‡ºå°±æ‰“å°ï¼Œç„¶åå…ˆæ”¾å·¦å†æ”¾å³ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å‡ºé˜Ÿåˆ—éƒ½æ˜¯å…ˆæ”¾å·¦å†æ”¾å³ 123456789101112131415161718// ä»nodeå‡ºå‘ï¼Œè¿›è¡Œå®½åº¦ä¼˜å…ˆéå†public static void width(Node head) &#123; if (head == null) &#123; return; &#125; Queue&lt;Node&gt; queue = new LinkedList&lt;&gt;(); queue.add(head); while (!queue.isEmpty()) &#123; Node cur = queue.poll(); System.out.println(cur.value); if (cur.left != null) &#123; queue.add(cur.left); &#125; if (cur.right != null) &#123; queue.add(cur.right); &#125; &#125;&#125; æ±‚äºŒå‰æ ‘çš„æœ€å¤§å®½åº¦(éš¾)åˆ†æï¼šå®½åº¦æ€§éå†çš„æ—¶å€™è¦çŸ¥é“æ¯ä¸€å±‚çš„èŠ‚ç‚¹ä¸ªæ•° è§£ï¼šéå†æ¯ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼ŒçŸ¥é“ä»–åœ¨ç¬¬å‡ å±‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667// ç”¨hashè¡¨çš„è§£æ³•public static int maxWidthUseMap(Node head) &#123; if (head == null) &#123; return 0; &#125; Queue&lt;Node&gt; queue = new LinkedList&lt;&gt;(); queue.add(head); // key åœ¨ å“ªä¸€å±‚ï¼Œvalue HashMap&lt;Node, Integer&gt; levelMap = new HashMap&lt;&gt;(); levelMap.put(head, 1); int curLevel = 1; // å½“å‰ä½ æ­£åœ¨ç»Ÿè®¡å“ªä¸€å±‚çš„å®½åº¦ int curLevelNodes = 0; // å½“å‰å±‚curLevelå±‚ï¼Œå®½åº¦ç›®å‰æ˜¯å¤šå°‘ int max = 0; while (!queue.isEmpty()) &#123; Node cur = queue.poll(); int curNodeLevel = levelMap.get(cur); if (cur.left != null) &#123; levelMap.put(cur.left, curNodeLevel + 1); queue.add(cur.left); &#125; if (cur.right != null) &#123; levelMap.put(cur.right, curNodeLevel + 1); queue.add(cur.right); &#125; if (curNodeLevel == curLevel) &#123; curLevelNodes++; &#125; else &#123; max = Math.max(max, curLevelNodes); curLevel++; curLevelNodes = 1; &#125; &#125; max = Math.max(max, curLevelNodes); return max;&#125;// ä¸ç”¨hashè¡¨çš„æ–¹æ³• (éš¾åº¦é«˜)public static int maxWidthNoMap(Node head) &#123; if (head == null) &#123; return 0; &#125; Queue&lt;Node&gt; queue = new LinkedList&lt;&gt;(); queue.add(head); Node curEnd = head; // å½“å‰å±‚ï¼Œæœ€å³èŠ‚ç‚¹æ˜¯è° Node nextEnd = null; // ä¸‹ä¸€å±‚ï¼Œæœ€å³èŠ‚ç‚¹æ˜¯è° int max = 0; int curLevelNodes = 0; // å½“å‰å±‚çš„èŠ‚ç‚¹æ•° while (!queue.isEmpty()) &#123; Node cur = queue.poll(); if (cur.left != null) &#123; queue.add(cur.left); nextEnd = cur.left; &#125; if (cur.right != null) &#123; queue.add(cur.right); nextEnd = cur.right; &#125; curLevelNodes++; if (cur == curEnd) &#123; max = Math.max(max, curLevelNodes); curLevelNodes = 0; curEnd = nextEnd; &#125; &#125; return max;&#125; æŠ˜çº¸é—®é¢˜ ç»“æœå¯çœ‹åšå¤´èŠ‚ç‚¹æ˜¯å‡¹ï¼Œæ‰€æœ‰çš„å·¦å­æ ‘å¤´èŠ‚ç‚¹éƒ½æ˜¯å‡¹ï¼Œæ‰€æœ‰å³å­æ ‘å¤´è‚©ç‚¹éƒ½æ˜¯å‡¸çš„äºŒå‰æ ‘ ä¸­åºéå†å³å¯æ‰“å°å‡ºä»ä¸Šåˆ°ä¸‹çš„æ‰€æœ‰ç»“æ„ 12345678910111213141516public static void main(String[] args) &#123; int N = 4; process(1, N, true);&#125;// è¿™ä¸ªèŠ‚ç‚¹åœ¨ç¬¬iå±‚ï¼Œä¸€å…±æœ‰Nå±‚ï¼ŒNå›ºå®šä¸å˜çš„// è¿™ä¸ªèŠ‚ç‚¹å¦‚æœæ˜¯å‡¹çš„è¯ï¼Œdown = T// è¿™ä¸ªèŠ‚ç‚¹å¦‚æœæ˜¯å‡¸çš„è¯ï¼Œdown = F// å‡½æ•°çš„åŠŸèƒ½ï¼šä¸­åºæ‰“å°ä»¥ä½ æƒ³è±¡çš„èŠ‚ç‚¹ä¸ºå¤´çš„æ•´æ£µæ ‘ï¼public static void process(int i, int N, boolean down) &#123; if (i &gt; N) &#123; return; &#125; process(i + 1, N, true); System.out.print(down ? &quot;å‡¹ &quot; : &quot;å‡¸ &quot;); process(i + 1, N, false);&#125; æœç´¢äºŒå‰æ ‘(é€’å½’å¥—è·¯) é¢˜ç›®ï¼šå¦‚ä½•åˆ¤æ–­ä¸€é¢—äºŒå‰æ ‘æ˜¯æœç´¢äºŒå‰æ ‘ï¼Ÿ æœç´¢äºŒå‰æ ‘çš„ç‰¹ç‚¹ï¼šä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå·¦å­æ ‘çš„èŠ‚ç‚¹ä¸€å®šæ¯”å®ƒå°ï¼Œå³å­æ ‘çš„èŠ‚ç‚¹ä¸€å®šæ¯”å®ƒå¤§ è§£é¢˜ï¼š ä¸­åºéå†ä¸€å®šæ˜¯å‡åºï¼Œå¦‚æœæŸä¸ªä½ç½®æœ‰é™åºï¼Œä¸€å®šä¸æ˜¯æœç´¢äºŒå‰æ ‘ é€’å½’å¥—è·¯é¢˜è§£ :å‘æˆ‘å·¦æ ‘è¦ä¿¡æ¯ï¼Œå³æ ‘è¦ä¿¡æ¯ï¼Œå·¦æ ‘å¿…é¡»æ˜¯æœç´¢äºŒå‰æ ‘ä¸”å·¦æ ‘æœ€å¤§å€¼å°äºæˆ‘ï¼Œå³æ ‘æ˜¯æœç´¢äºŒå‰æ ‘å¹¶ä¸”æœ€å°å€¼å¤§äºæˆ‘ï¼›å·¦æ ‘ä¿¡æ¯ï¼š1.æ˜¯å¦æ˜¯æœç´¢äºŒå‰æ ‘ï¼Œ2.æœ€å¤§å€¼ï¼Œ3.æœ€å°å€¼ï¼›å³æ ‘ä¹Ÿæ˜¯ æ³¨æ„ï¼šé€’å½’å¥—è·¯ï¼Œå¯ä»¥è§£å†³ä¸€åˆ‡æ ‘å½¢DP é—®é¢˜ï¼Œæ— éæ˜¯å¯èƒ½æ€§çš„ç½—åˆ—æœ‰éš¾åº¦ 12345678910111213141516171819202122232425262728293031323334// è§£æ³•1ï¼š é¢å¤–å¼•å…¥æ•°ç»„// èŠ‚ç‚¹public static class Node &#123; public int value; public Node left; public Node right; public Node(int data) &#123; this.value = data; &#125;&#125;// ä¸­åºéå†åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç„¶ååˆ¤æ–­æ•°ç»„æ˜¯ä¸æ˜¯å‡åºpublic static boolean isBST1(Node head) &#123; if (head == null) &#123; return true; &#125; ArrayList&lt;Node&gt; arr = new ArrayList&lt;&gt;(); in(head, arr); for (int i = 1; i &lt; arr.size(); i++) &#123; if (arr.get(i).value &lt;= arr.get(i - 1).value) &#123; return false; &#125; &#125; return true;&#125;// ä¸­åºéå†public static void in(Node head, ArrayList&lt;Node&gt; arr) &#123; if (head == null) &#123; return; &#125; in(head.left, arr); arr.add(head); in(head.right, arr);&#125; 12345678910111213141516171819// è§£æ³•2ï¼šé€’å½’æ–¹å¼public static int preValue = Integer.MIN_VALUE;public static boolean checkBST(Node head) &#123; if (head == null) &#123; return true; &#125; boolean checkLeft = checkBST(head.left); if (!checkLeft) &#123; return false; &#125; // ä¸­åºæ‰“å°çš„æ—¶æœºï¼Œæ¢æˆäº†ä¸­åºæ¯”è¾ƒçš„æ—¶æœº if (head.value &lt;= preValue) &#123; return false; &#125; else &#123; preValue = head.value; &#125; return checkBST(head.right);&#125; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253// è§£æ³•3ï¼šé€’å½’å¥—è·¯/** * é€’å½’è¿”å›å€¼ */public static class Info &#123; public boolean isBST; // æ˜¯å¦æ˜¯æœç´¢äºŒå‰æ ‘ public int max; // æœ€å¤§å€¼ public int min; // æœ€å°å€¼ public Info(boolean i, int ma, int mi) &#123; isBST = i; max = ma; min = mi; &#125;&#125;public static Info process(Node x) &#123; if (x == null) &#123; return null; &#125; Info leftInfo = process(x.left); Info rightInfo = process(x.right); int min = x.value; int max = x.value; // æœ€å°å€¼å’Œæœ€å¤§å€¼å°±æ˜¯æˆ‘å½“å‰èŠ‚ç‚¹çš„å€¼å’Œå®ƒæ¯”è¾ƒå¾—å‡ºçš„æœ€å°å€¼å’Œæœ€å¤§å€¼ if (leftInfo != null) &#123; min = Math.min(min, leftInfo.min); max = Math.max(max, leftInfo.max); &#125; if (rightInfo != null) &#123; min = Math.min(min, rightInfo.min); max = Math.max(max, rightInfo.max); &#125; // æ˜¯å¦æ˜¯æœç´¢äºŒå‰æ ‘ boolean isBST = true; // å·¦è¾¹æœ‰ä¿¡æ¯å¹¶ä¸”å·¦è¾¹ä¸æ˜¯æœç´¢äºŒå‰æ ‘ if (leftInfo != null &amp;&amp; !leftInfo.isBST) &#123; isBST = false; &#125; if (rightInfo != null &amp;&amp; !rightInfo.isBST) &#123; isBST = false; &#125; // å·¦è¾¹æœ‰ä¿¡æ¯ï¼Œä½†æ˜¯å·¦è¾¹çš„æœ€å¤§å€¼å¤§äºç­‰äºæˆ‘çš„å€¼ if (leftInfo != null &amp;&amp; leftInfo.max &gt;= x.value) &#123; isBST = false; &#125; // å³è¾¹æœ‰ä¿¡æ¯ï¼Œå³è¾¹çš„æœ€å°å€¼å°äºç­‰äºæˆ‘å½“å‰å€¼ if (rightInfo != null &amp;&amp; rightInfo.min &lt;= x.value) &#123; isBST = false; &#125; return new Info(isBST, max, min);&#125; å®Œå…¨äºŒå‰æ ‘ å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªäºŒå‰æ ‘æ˜¯å®Œå…¨äºŒå‰æ ‘ å®Œå…¨äºŒå‰æ ‘ï¼šä¸€é¢—äºŒå‰æ ‘ä»å·¦åˆ°å³æ˜¯ä¾æ¬¡å˜æ»¡çš„ï¼Œå³ä½¿ä¸æ»¡ï¼Œä¹Ÿæ˜¯å˜æ»¡çš„æ ·å­ è§£é¢˜ï¼šäºŒå‰æ ‘å®½åº¦éå†ï¼Œ1.ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹å¦‚æœæœ‰æœ‰èŠ‚ç‚¹ï¼Œæ²¡å·¦èŠ‚ç‚¹ï¼Œfalseï¼›2.åœ¨ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸è¿è§„æƒ…å†µï¼Œå¦‚æœé‡åˆ°ç¬¬ä¸€ä¸ªå·¦å³ä¸¤ä¸ªèŠ‚ç‚¹ä¸åŒå…¨æƒ…å†µï¼Œæ¥ä¸‹æ¥é‡åˆ°çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¿…é¡»æ˜¯å¶å­èŠ‚ç‚¹ 1234567891011121314151617181920212223242526272829303132public static boolean isCBT(Node head) &#123; if (head == null) &#123; return true; &#125; LinkedList&lt;Node&gt; queue = new LinkedList&lt;&gt;(); // æ˜¯å¦é‡åˆ°è¿‡å·¦å³ä¸¤ä¸ªå­©å­ä¸åŒå…¨çš„èŠ‚ç‚¹ boolean leaf = false; Node l = null; Node r = null; queue.add(head); while (!queue.isEmpty()) &#123; head = queue.poll(); l = head.left; r = head.right; // å¦‚æœé‡åˆ°äº†ä¸åŒå…¨çš„èŠ‚ç‚¹ä¹‹åï¼Œåˆå‘ç°å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¶èŠ‚ç‚¹ if ((leaf &amp;&amp; (l != null || r != null)) || (l == null &amp;&amp; r != null)) &#123; return false; &#125; if (l != null) &#123; queue.add(l); &#125; if (r != null) &#123; queue.add(r); &#125; // é‡åˆ°å·¦å³ä¸¤ä¸ªèŠ‚ç‚¹ä¸åŒå…¨çš„æƒ…å†µï¼Œä¿®æ”¹æ ‡è®° if (l == null || r == null) &#123; leaf = true; &#125; &#125; return true;&#125; å¹³è¡¡äºŒå‰æ ‘ å¦‚ä½•åˆ¤æ–­ä¸€æ£µæ ‘æ˜¯å¹³è¡¡äºŒå‰æ ‘ å¹³è¡¡äºŒå‰æ ‘ç‰¹æ€§ï¼šå¯¹äºä»»ä½•ä¸€ä¸ªå­æ ‘æ¥è¯´ï¼Œå·¦æ ‘çš„é«˜åº¦å’Œå³æ ‘çš„é«˜åº¦å·®ï¼Œéƒ½ä¸è¶…è¿‡1 è§£å†³æ€è·¯ï¼šå‡è®¾æˆ‘å¯ä»¥å‘æˆ‘çš„å·¦æ ‘è¦ä¿¡æ¯ï¼Œå¯ä»¥å‘å³æ ‘è¦ä¿¡æ¯ï¼Œå¦‚æœæˆ‘æ•´æ£µæ ‘æ˜¯å¹³è¡¡äºŒå‰æ ‘ï¼Œæˆ‘å·¦æ ‘å¾—æ˜¯å¹³çš„ï¼Œå³æ ‘å¾—æ˜¯å¹³çš„ï¼Œå¯¹äºXèŠ‚ç‚¹æ¥è¯´ï¼Œå·¦æ ‘-å³æ ‘é«˜åº¦å·®&lt;=1ï¼›æˆ‘å‘å·¦æ ‘è¦ä¿¡æ¯ï¼š1.æ˜¯å¦æ˜¯å¹³çš„ï¼›2.é«˜åº¦æ˜¯å¤šå°‘ï¼Œå³æ ‘è¦ä¿¡æ¯ï¼š1.æ˜¯å¦æ˜¯å¹³çš„ï¼›2.é«˜åº¦æ˜¯å¤šå°‘ 12345678910111213141516171819202122232425262728293031323334/** * è¿”å›å€¼ä¿¡æ¯ */public static class Info &#123; public boolean isBalanced; public int height; public Info(boolean i, int h) &#123; isBalanced = i; height = h; &#125;&#125;public static Info process(Node x) &#123; if (x == null) &#123; return new Info(true, 0); &#125; Info leftInfo = process(x.left); Info rightInfo = process(x.right); // xä¸ºå¤´çš„èŠ‚ç‚¹çš„é«˜åº¦ï¼šå·¦æ ‘å’Œå³æ ‘è¾ƒå¤§çš„é‚£ä¸ªé«˜åº¦å†åŠ ä¸Šæˆ‘è‡ªå·±(+1) int height = Math.max(leftInfo.height, rightInfo.height) + 1; // æ˜¯å¦æ˜¯å¹³è¡¡æ ‘ï¼šæˆ‘å·¦æ ‘å¾—æ˜¯å¹³è¡¡ï¼Œå³æ ‘å¾—æ˜¯å¹³è¡¡æ ‘ï¼Œå¹¶ä¸”æˆ‘å·¦æ ‘å’Œå³æ ‘çš„é«˜åº¦å·®çš„ç»å¯¹å€¼å¾—å°äº2 boolean isBalanced = true; if (!leftInfo.isBalanced) &#123; isBalanced = false; &#125; if (!rightInfo.isBalanced) &#123; isBalanced = false; &#125; if (Math.abs(leftInfo.height - rightInfo.height) &gt; 1) &#123; isBalanced = false; &#125; return new Info(isBalanced, height);&#125; æ»¡äºŒå‰æ ‘ å¦‚ä½•åˆ¤æ–­ä¸€æ£µæ ‘æ˜¯æ»¡äºŒå‰æ ‘ æ ‘æœ€å¤§æ·±åº¦Lï¼ŒèŠ‚ç‚¹ä¸ªæ•°Nï¼Œæ»¡è¶³N=2(Læ¬¡æ–¹)-1 è§£æ³•(é€’å½’å¥—è·¯)ï¼šå…ˆæ±‚äºŒå‰æ ‘æœ€å¤§æ·±åº¦Lï¼Œå†æ±‚èŠ‚ç‚¹ä¸ªæ•°Nï¼Œæ»¡è¶³N=2(Læ¬¡æ–¹)-1 12345678910111213141516171819202122232425262728293031323334// æ»¡äºŒå‰æ ‘è§£æ³•ï¼šé€’å½’å¥—è·¯/** * è¿”å›å€¼ä¿¡æ¯ */public static class Info &#123; public int height; public int nodes; public Info(int h, int n) &#123; height = h; nodes = n; &#125;&#125;public static boolean isFull(Node head) &#123; if (head == null) &#123; return true; &#125; Info all = process(head); // N=2(Læ¬¡æ–¹)-1 return (1 &lt;&lt; all.height) - 1 == all.nodes;&#125;public static Info process(Node head) &#123; if (head == null) &#123; return new Info(0, 0); &#125; Info leftInfo = process(head.left); Info rightInfo = process(head.right); // é«˜åº¦ç­‰äºå·¦æ ‘å’Œå³æ ‘æœ€é«˜çš„é«˜åº¦+1 int height = Math.max(leftInfo.height, rightInfo.height) + 1; // æ€»ä¸ªæ•°ç­‰äºå·¦è¾¹çš„ä¸ªæ•°åŠ ä¸Šå³è¾¹çš„ä¸ªæ•°åŠ 1 int nodes = leftInfo.nodes + rightInfo.nodes + 1; return new Info(height, nodes);&#125; äºŒå‰æ ‘æœ€ä½å…¬å…±ç¥–å…ˆ ç»™å®šä¸¤ä¸ªäºŒå‰æ ‘èŠ‚ç‚¹node1å’Œnode2ï¼Œæ‰¾åˆ°ä»–ä»¬çš„æœ€ä½å…¬å…±ç¥–å…ˆèŠ‚ç‚¹ è§£æ³•1ï¼šéå†æ•´æ£µæ ‘ï¼ŒæŠŠæ‰€æœ‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹éƒ½ç»´æŠ¤åˆ°ä¸€ä¸ªMapä¸­ï¼Œç„¶åæ‰¾åˆ°node1çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹ç»´æŠ¤åˆ°setä¸­ï¼Œå†éå†node2çš„æ‰€æœ‰çš„çˆ¶ï¼Œç¬¬ä¸€ä¸ªåœ¨setä¸­é‡åˆ°çš„èŠ‚ç‚¹å°±æ˜¯æœ€ä½å…¬å…±ç¥–å…ˆ 1234567891011121314151617181920212223242526272829303132333435// è§£æ³•1public static Node lca(Node head, Node o1, Node o2) &#123; if (head == null) &#123; return null; &#125; HashMap&lt;Node, Node&gt; parentMap = new HashMap&lt;&gt;(); parentMap.put(head, null); fillParentMap(head, parentMap); HashSet&lt;Node&gt; set = new HashSet&lt;&gt;(); Node cur = o1; set.add(cur); // åªæœ‰å¤´èŠ‚ç‚¹æ‰ç­‰äºè‡ªå·±çš„çˆ¶ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹ä¸ç­‰äºè‡ªå·±çš„çˆ¶ï¼Œå°±å¯ä»¥å¾€ä¸Šèµ° while (null != parentMap.get(cur)) &#123; cur = parentMap.get(cur); set.add(cur); &#125; // o1å¾€ä¸Šæ‰€æœ‰èŠ‚ç‚¹éƒ½åœ¨è¿™ä¸ªseté‡Œé¢ï¼Œåªæœ‰æœ€åˆçš„headä¸åœ¨é‡Œé¢ cur = o2; while (!set.contains(cur)) &#123; cur = parentMap.get(cur); &#125; return cur;&#125;// ç»´æŠ¤æ•´æ£µæ ‘çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹åˆ°Mapä¸­private static void fillParentMap(Node head, HashMap&lt;Node, Node&gt; fatherMap) &#123; if (head.left != null) &#123; fatherMap.put(head.left, head); fillParentMap(head.left, fatherMap); &#125; if (head.right != null) &#123; fatherMap.put(head.right, head); fillParentMap(head.right, fatherMap); &#125;&#125; è§£æ³•2(éå¸¸æŠ½è±¡)ï¼šå¯èƒ½çš„æƒ…å†µæœ‰1ï¼šnode1å’Œnode2äº’ä¸ºå…¬å…±ç¥–å…ˆï¼›2ï¼šnode1å’Œnode2ä¸äº’ä¸ºå…¬å…±ç¥–å…ˆï¼› 1234567891011121314/** * è§£æ³•2ï¼šå¯èƒ½çš„æƒ…å†µæœ‰1ï¼šnode1å’Œnode2äº’ä¸ºå…¬å…±ç¥–å…ˆï¼›2ï¼šnode1å’Œnode2ä¸äº’ä¸ºå…¬å…±ç¥–å…ˆï¼› */public static Node lowestCommonAncestor(Node head, Node o1, Node o2) &#123; if (head == null || head == o1 || head == o2) &#123; return head; &#125; Node left = lowestCommonAncestor(head.left, o1, o2); Node right = lowestCommonAncestor(head.right, o1, o2); if (left != null &amp;&amp; right != null) &#123; return head; &#125; return left != null ? left : right;&#125; å›¾ å¸¸è§çš„è¡¨ç¤ºå›¾çš„æ–¹æ³•ï¼šä¸´æ¥è¡¨æ³•ï¼Œå’Œä¸´æ¥çŸ©é˜µæ³•ï¼Œæ•°ç»„ç­‰ åšæ¨¡æ¿ï¼Œç„¶åæŠŠæ‰€æœ‰çš„å›¾çš„é—®é¢˜è½¬åŒ–ä¸ºè‡ªå·±ç†Ÿæ‚‰çš„æ•°æ®ç»“æ„ï¼Œå¸¦ç€æ¨¡æ¿ä¸Šè€ƒåœº å›¾çš„å®½åº¦ä¼˜å…ˆéå†çº¦ç‘Ÿå¤«åœ†ç¯é—®é¢˜é€†æ³¢å…°è®¡ç®—å™¨ å®ç°ä¸€ä¸ªè®¡ç®—å™¨ï¼Œåªæœ‰åŠ å‡ä¹˜é™¤æ³•ï¼Œæ²¡æœ‰æ‹¬å·ï¼Œè¾“å…¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¦‚10+2+3*5 è§£é¢˜ï¼šè¡¨è¾¾å¼è½¬åŒ–ä¸ºåç¼€è¡¨è¾¾å¼ï¼ˆé€†æ³¢å…°è¡¨è¾¾å¼ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125// è§£é¢˜public static void main(String[] args) &#123; String str = &quot;10+2+3*5&quot;; // è¡¨è¾¾å¼è½¬æ¢ä¸ºæ“ä½œæ•°å’Œæ“ä½œç¬¦çš„ä¸­ç¼€è¡¨è¾¾å¼æ•°ç»„ String[] strArr = changeStrArr(str); // ä¸­ç¼€è¡¨è¾¾å¼è½¬åŒ–ä¸ºåç¼€è¡¨è¾¾å¼ List&lt;String&gt; polandList = polandNotation(strArr); System.out.println(polandList); // åç¼€è¡¨è¾¾å¼è®¡ç®— System.out.println(calculate(polandList));&#125;/** * å­—ç¬¦ä¸²è½¬æˆä¸­ç¼€çš„æ•°ç»„ * åªæœ‰åŠ å‡ä¹˜é™¤ï¼Œæ²¡æœ‰æ‰©å· */private static String[] changeStrArr(String str) &#123; StringBuilder stringBuilder = new StringBuilder(); for (char c : str.toCharArray()) &#123; if (&quot;+-*/&quot;.contains(String.valueOf(c))) &#123; stringBuilder.append(&quot;;&quot;); stringBuilder.append(c); stringBuilder.append(&quot;;&quot;); &#125; else &#123; stringBuilder.append(c); &#125; &#125; return stringBuilder.toString().split(&quot;;&quot;);&#125;/** * ä¸­ç¼€è¡¨è¾¾å¼è½¬åŒ–ä¸ºåç¼€è¡¨è¾¾å¼ * 1.åˆå§‹åŒ–ä¸¤ä¸ªæ ˆï¼Œè¿ç®—ç¬¦æ ˆs1å’Œå‚¨å­˜ä¸­é—´ç»“æœçš„æ ˆs2 * 2.ä»å·¦åˆ°å³æ‰«æä¸­ç¼€è¡¨è¾¾å¼ * 3.é‡åˆ°æ“ä½œæ•°ï¼Œå…¥æ ˆs2 * 4.é‡åˆ°è¿ç®—ç¬¦ï¼Œæ¯”è¾ƒå…¶ä¸s1æ ˆé¡¶è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§ï¼š * (1).å¦‚æœs1ä¸ºç©ºï¼Œæˆ–è€…æ ˆé¡¶è¿ç®—ç¬¦ä¸ºå·¦æ‹¬å·&quot;(&quot;,ç›´æ¥å°†è¿ç®—ç¬¦å…¥æ ˆï¼› * (2).å¦åˆ™ï¼Œè‹¥ä¼˜å…ˆçº§æ¯”æ ˆé¡¶è¿ç®—ç¬¦é«˜ï¼Œä¹Ÿå°†è¿ç®—ç¬¦å…¥æ ˆs1; * (3).å¦åˆ™ï¼Œå°†s1æ ˆé¡¶è¿ç®—ç¬¦å¼¹å‡ºå…¥æ ˆs2ä¸­ï¼Œå†æ¬¡è½¬åˆ°(4-1) ä¸s1ä¸­æ–°çš„æ ˆé¡¶è¿ç®—ç¬¦æ¯”è¾ƒï¼› * æœ¬æ–¹æ³•åªè€ƒè™‘åˆ°åŠ å‡ä¹˜é™¤æ“ä½œï¼Œä¸è€ƒè™‘æ‰©å· */private static List&lt;String&gt; polandNotation(String[] str) &#123; List&lt;String&gt; s2 = new ArrayList&lt;&gt;(); Stack&lt;String&gt; s1 = new Stack&lt;&gt;(); for (String itm : str) &#123; // é‡åˆ°æ“ä½œæ•°ï¼Œç›´æ¥å…¥æ ˆs2 if (itm.matches(&quot;\\\\d+&quot;)) &#123; s2.add(itm); &#125; else &#123; // å¦‚æœæ ˆä¸ä¸ºç©ºï¼Œå¹¶ä¸”æ ˆé¡¶ä¼˜å…ˆçº§æ¯”æˆ‘ç›®å‰è¿ç®—ç¬¦ä¼˜å…ˆçº§é«˜ï¼Œå°±æŠŠæ ˆé¡¶è¿ç®—ç¬¦å¦‚s2ï¼Œç„¶åå§å½“å‰è¿ç®—ç¬¦å¦‚s1 while (!s1.isEmpty() &amp;&amp; Operation.getValue(s1.peek()) &gt;= Operation.getValue(itm)) &#123; s2.add(s1.pop()); &#125; s1.push(itm); &#125; &#125; while (!s1.isEmpty()) &#123; s2.add(s1.pop()); &#125; return s2;&#125;/** * è¿ç®—ç¬¦æ¯”è¾ƒ */private static class Operation &#123; private static int ADD = 1; private static int SUB = 1; private static int MUL = 2; private static int DIV = 2; public static int getValue(String operation) &#123; int result = 0; switch (operation) &#123; case &quot;+&quot;: result = ADD; break; case &quot;-&quot;: result = SUB; break; case &quot;*&quot;: result = MUL; break; case &quot;/&quot;: result = DIV; break; default: break; &#125; return result; &#125;&#125;/** * é€†æ³¢å…°è¡¨è¾¾å¼è®¡ç®— * 1.å®šä¹‰ä¸€ä¸ªæ ˆï¼ŒåŒ¹é…åˆ°éè¿ç®—ç¬¦å°±å…¥æ ˆ * 2.é‡åˆ°è¿ç®—ç¬¦å°±æŠŠæ ˆé¡¶ä¸¤ä¸ªæ•°å­—å‡ºæ ˆï¼Œç”¨åå‡ºæ ˆçš„æ•°å’Œå…ˆå‡ºæ ˆçš„æ•°åšè¿ç®—ï¼ŒæŠŠè¿ç®—ç»“æœå†å…¥æ ˆ * 3.ç›´åˆ°æœ€åï¼Œæ ˆé¡¶ç»“æœå³ä¸ºè®¡ç®—ç»“æœ */private static int calculate(List&lt;String&gt; polandList) &#123; Stack&lt;String&gt; stack = new Stack&lt;&gt;(); for (String itm : polandList) &#123; // åŒ¹é…çš„æ˜¯å¤šä½æ•° if (itm.matches(&quot;\\\\d+&quot;)) &#123; stack.push(itm); &#125; else &#123; // å¼¹å‡ºä¸¤ä¸ªæ•°ï¼Œå¹¶è¿ç®—ï¼Œå†å…¥æ ˆ int num2 = Integer.parseInt(stack.pop()); int num1 = Integer.parseInt(stack.pop()); int res = 0; if (itm.equals(&quot;+&quot;)) &#123; res = num1 + num2; &#125; else if (itm.equals(&quot;-&quot;)) &#123; res = num1 - num2; &#125; else if (itm.equals(&quot;*&quot;)) &#123; res = num1 * num2; &#125; else if (itm.equals(&quot;/&quot;)) &#123; res = num1 / num2; &#125; else &#123; throw new RuntimeException(&quot;è¿ç®—ç¬¦æœ‰è¯¯&quot;); &#125; stack.push(String.valueOf(res)); &#125; &#125; return Integer.parseInt(stack.pop());&#125; å‰ç¼€æ ‘1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495// å‰ç¼€æ ‘æ•°æ®ç»“æ„public static class Node1 &#123; public int pass; public int end; public Node1[] nexts; // char tmp = &#x27;b&#x27; (tmp - &#x27;a&#x27;) public Node1() &#123; pass = 0; end = 0; // 0 a // 1 b // 2 c // .. .. // 25 z // nexts[i] == null iæ–¹å‘çš„è·¯ä¸å­˜åœ¨ // nexts[i] != null iæ–¹å‘çš„è·¯å­˜åœ¨ nexts = new Node1[26]; &#125;&#125;// æ·»åŠ å…ƒç´ public void insert(String word) &#123; if (word == null) &#123; return; &#125; char[] str = word.toCharArray(); Node1 node = root; node.pass++; int path = 0; for (int i = 0; i &lt; str.length; i++) &#123; // ä»å·¦å¾€å³éå†å­—ç¬¦ path = str[i] - &#x27;a&#x27;; // ç”±å­—ç¬¦ï¼Œå¯¹åº”æˆèµ°å‘å“ªæ¡è·¯ if (node.nexts[path] == null) &#123; node.nexts[path] = new Node1(); &#125; node = node.nexts[path]; node.pass++; &#125; node.end++;&#125;// wordè¿™ä¸ªå•è¯ä¹‹å‰åŠ å…¥è¿‡å‡ æ¬¡public int search(String word) &#123; if (word == null) &#123; return 0; &#125; char[] chs = word.toCharArray(); Node1 node = root; int index = 0; for (int i = 0; i &lt; chs.length; i++) &#123; index = chs[i] - &#x27;a&#x27;; if (node.nexts[index] == null) &#123; return 0; &#125; node = node.nexts[index]; &#125; return node.end;&#125;// æ‰€æœ‰åŠ å…¥çš„å­—ç¬¦ä¸²ä¸­ï¼Œæœ‰å‡ ä¸ªæ˜¯ä»¥preè¿™ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‰ç¼€çš„public int prefixNumber(String pre) &#123; if (pre == null) &#123; return 0; &#125; char[] chs = pre.toCharArray(); Node1 node = root; int index = 0; for (int i = 0; i &lt; chs.length; i++) &#123; index = chs[i] - &#x27;a&#x27;; if (node.nexts[index] == null) &#123; return 0; &#125; node = node.nexts[index]; &#125; return node.pass;&#125;// åˆ é™¤public void delete(String word) &#123; if (search(word) != 0) &#123; char[] chs = word.toCharArray(); Node1 node = root; node.pass--; int path = 0; for (int i = 0; i &lt; chs.length; i++) &#123; path = chs[i] - &#x27;a&#x27;; if (--node.nexts[path].pass == 0) &#123; node.nexts[path] = null; return; &#125; node = node.nexts[path]; &#125; node.end--; &#125;&#125; è´ªå¿ƒç®—æ³•åœ¨æŸä¸€ä¸ªæ ‡å‡†ä¸‹ï¼Œä¼˜å…ˆè€ƒè™‘æœ€æ»¡è¶³æ ‡å‡†çš„æ ·æœ¬ï¼Œæœ€åè€ƒè™‘æœ€ä¸æ»¡è¶³æ ‡å‡†çš„æ ·æœ¬ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªç­”æ¡ˆçš„ç®—æ³•ï¼Œå«åšè´ªå¿ƒç®—æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä»æ•´ä½“æœ€ä¼˜ä¸ŠåŠ ä»¥è€ƒè™‘ï¼Œæ‰€åšå‡ºçš„æ˜¯æŸç§æ„ä¹‰ä¸Šçš„å±€éƒ¨æœ€ä¼˜è§£ã€‚ ä¼šè®®å®¤å ç”¨é—®é¢˜é—®é¢˜ï¼šåªæœ‰ä¸€ä¸ªä¼šè®®å®¤ï¼Œå¤šä¸ªä¼šè®®å ç”¨ä¼šè®®å®¤çš„æ—¶é—´æœ‰å†²çªï¼Œå¦‚ä½•è®©ä¼šè®®å®¤è¿›è¡Œçš„ä¼šè®®æœ€å¤šï¼Œè¿”å›æœ€å¤šçš„ä¼šè®®åœºæ¬¡ è§£ï¼šå“ªä¸ªä¼šè®®ç»“æŸæ—¶é—´æ—©ï¼Œå°±ä¼˜å…ˆå®‰æ’ï¼Œç„¶åæ¥ä¸‹æ¥ç»§ç»­æ‰¾ä¸‹ä¸€ä¸ªä¼šè®®ç»“æŸæ—¶é—´æ—©çš„ä¼šè®® 1234567891011121314151617181920212223242526272829303132// ä¼šè®®å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´public static class Program &#123; public int start; public int end; public Program(int start, int end) &#123; this.start = start; this.end = end; &#125;&#125;// æ¯”è¾ƒå™¨public static class ProgramComparator implements Comparator&lt;Program&gt; &#123; @Override public int compare(Program o1, Program o2) &#123; return o1.end - o2.end; &#125;&#125;// ä¼šè®®çš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼Œéƒ½æ˜¯æ•°å€¼ï¼Œä¸ä¼š &lt; 0public static int bestArrange2(Program[] programs) &#123; Arrays.sort(programs, new ProgramComparator()); int timeLine = 0; int result = 0; // ä¾æ¬¡éå†æ¯ä¸€ä¸ªä¼šè®®ï¼Œç»“æŸæ—¶é—´æ—©çš„ä¼šè®®å…ˆéå† for (int i = 0; i &lt; programs.length; i++) &#123; if (timeLine &lt;= programs[i].start) &#123; result++; timeLine = programs[i].end; &#125; &#125; return result;&#125; å…«çš‡åé—®é¢˜å¤šçº¿ç¨‹ç›¸å…³ä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å° ä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°ï¼Œ1çº¿ç¨‹æ‰“å°1ï¼›2çº¿ç¨‹æ‰“å°2ï¼›3çº¿ç¨‹æ‰“å°3ï¼›1çº¿ç¨‹æ‰“å°4â€¦â€¦ä¸€ç›´æ‰“å°åˆ°100 è§£é¢˜æ–¹å¼ç”±å¾ˆå¤šï¼Œæ— éå°±æ˜¯æ¶‰åŠåˆ°çº¿ç¨‹é€šä¿¡é—®é¢˜ä»¥åŠä¿®æ”¹å…±äº«å˜é‡é—®é¢˜ é¢˜è§£1ï¼šä¸åŠ é”ï¼Œåˆ©ç”¨çº¿ç¨‹å¯è§æ€§ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public class ThreadPrint &#123; private static volatile int i = 0; private static volatile int flag = 0; public static void main(String[] args) &#123; Thread thread1 = new Thread(new Thread1()); Thread thread2 = new Thread(new Thread2()); Thread thread3 = new Thread(new Thread3()); thread1.start(); thread2.start(); thread3.start(); &#125; public static class Thread1 implements Runnable &#123; public void run() &#123; while (i &lt;= 100) &#123; if (flag == 0) &#123; System.out.println(&quot;t1=&quot; + i); i++; flag = 1; &#125; &#125; &#125; &#125; public static class Thread2 implements Runnable &#123; public void run() &#123; while (i &lt;= 100) &#123; if (flag == 1) &#123; System.out.println(&quot;t2=&quot; + i); i++; flag = 2; &#125; &#125; &#125; &#125; public static class Thread3 implements Runnable &#123; public void run() &#123; while (i &lt;= 100) &#123; if (flag == 2) &#123; System.out.println(&quot;t3=&quot; + i); i++; flag = 0; &#125; &#125; &#125; &#125;&#125; é¢˜è§£2ï¼šLockSupport å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142public class ThreadPrint2 &#123; private static int number = 1; private static Thread thread1, thread2,thread3; public static void main(String[] args) &#123; thread1 = new Thread(ThreadPrint2::thread1, &quot;thread1&quot;); thread2 = new Thread(ThreadPrint2::thread2, &quot;thread2&quot;); thread3 = new Thread(ThreadPrint2::thread3, &quot;thread3&quot;); thread1.start(); thread2.start(); thread3.start(); &#125; public static void thread1() &#123; while (ThreadPrint2.number &lt;= 100) &#123; System.out.println(&quot;thread1:&quot; + ThreadPrint2.number); ThreadPrint2.number++; LockSupport.unpark(thread2); LockSupport.park(); &#125; &#125; public static void thread2() &#123; while (ThreadPrint2.number &lt;= 100) &#123; LockSupport.park(); System.out.println(&quot;thread2:&quot; + ThreadPrint2.number); ThreadPrint2.number++; LockSupport.unpark(thread3); &#125; &#125; public static void thread3() &#123; while (ThreadPrint2.number &lt;= 100) &#123; LockSupport.park(); System.out.println(&quot;thread3:&quot; + ThreadPrint2.number); ThreadPrint2.number++; LockSupport.unpark(thread1); &#125; &#125;&#125; é¢˜è§£3ï¼šç»å…¸å®ç° å®ç°wait-&gt;notifyAll 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public class ThreadPrint3 &#123; private static int count = 1; public static void main(String[] args) &#123; Object lock = new Object(); new Thread(() -&gt; &#123; try &#123; synchronized (lock) &#123; while (count &lt;= 100) &#123; if (count % 3 == 1) &#123; System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + count); count++; &#125; lock.notifyAll(); lock.wait(); &#125; lock.notifyAll(); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;, &quot;T1&quot;).start(); new Thread(() -&gt; &#123; try &#123; synchronized (lock) &#123; while (count &lt;= 100) &#123; if (count % 3 == 2) &#123; System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + count); count++; &#125; lock.notifyAll(); lock.wait(); &#125; lock.notifyAll(); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;, &quot;T2&quot;).start(); new Thread(() -&gt; &#123; try &#123; synchronized (lock) &#123; while (count &lt;= 100) &#123; if (count % 3 == 0) &#123; System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + count); count++; &#125; lock.notifyAll(); lock.wait(); &#125; lock.notifyAll(); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;, &quot;T3&quot;).start(); &#125;&#125; é¢˜è§£4ï¼šLockå®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public class ThreadPrint4 &#123; private static int cnt = 0; public static void main(String[] args) &#123; Lock lock = new ReentrantLock(); Condition c1 = lock.newCondition(); Condition c2 = lock.newCondition(); Condition c3 = lock.newCondition(); new Thread(() -&gt; &#123; lock.lock(); try &#123; while (cnt &lt;= 100 &amp;&amp; cnt % 3 == 0) &#123; System.out.println(Thread.currentThread().getName() + &quot;----&gt;&quot; + cnt); cnt++; c2.signal(); c1.await(); &#125; c3.signal(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;, &quot;T1&quot;).start(); new Thread(() -&gt; &#123; lock.lock(); try &#123; while (cnt &lt;= 100 &amp;&amp; cnt % 3 == 1) &#123; System.out.println(Thread.currentThread().getName() + &quot;----&gt;&quot; + cnt); cnt++; c3.signal(); c2.await(); &#125; c1.signal(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;, &quot;T2&quot;).start(); new Thread(() -&gt; &#123; lock.lock(); try &#123; while (cnt &lt;= 100 &amp;&amp; cnt % 3 == 2) &#123; System.out.println(Thread.currentThread().getName() + &quot;----&gt;&quot; + cnt); cnt++; c1.signal(); c3.await(); &#125; c2.signal(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;, &quot;T3&quot;).start(); &#125;&#125; å…¶ä»–ç®—æ³•é¢˜","categories":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://zhangxin66666.github.io/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"é¢è¯•çŸ¥è¯†ç‚¹æ€»ç»“","slug":"12.é¢è¯•/å¸¸è§é¢è¯•é¢˜","date":"2022-03-30T16:00:00.000Z","updated":"2024-12-24T12:17:43.392Z","comments":true,"path":"2022/03/31/12.é¢è¯•/å¸¸è§é¢è¯•é¢˜/","link":"","permalink":"https://zhangxin66666.github.io/2022/03/31/12.%E9%9D%A2%E8%AF%95/%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/","excerpt":"","text":"ä¸€ã€åŸºç¡€çŸ¥è¯†1.ConcurrentHashMapConcurrentHashMap 2.Set,List,Mapæœ‰ä»€ä¹ˆåŒºåˆ« ç»“æ„ç‰¹ç‚¹ List å’Œ Set æ˜¯å­˜å‚¨å•åˆ—æ•°æ®çš„é›†åˆï¼Œ Map æ˜¯å­˜å‚¨é”®å’Œå€¼è¿™æ ·çš„åŒåˆ—æ•°æ®çš„é›†åˆ; Listä¸­å­˜å‚¨çš„æ•°æ®æ˜¯æœ‰é¡ºåºï¼Œå¹¶ä¸”å…è®¸é‡å¤; Map ä¸­å­˜å‚¨çš„æ•°æ®æ˜¯æ²¡æœ‰é¡ºåºçš„ï¼Œå…¶é”®æ˜¯ä¸èƒ½é‡å¤çš„ï¼Œå®ƒçš„å€¼æ˜¯å¯ä»¥æœ‰é‡å¤çš„ï¼Œ Set ä¸­å­˜å‚¨çš„æ•°æ®æ˜¯æ— åºçš„ï¼Œä¸”ä¸å…è®¸æœ‰é‡å¤ï¼Œä½†å…ƒç´ åœ¨é›†åˆä¸­çš„ä½ç½®ç”±å…ƒç´ çš„hashcodeå†³å®šï¼Œä½ç½®æ˜¯å›ºå®šçš„(Seté›†åˆæ ¹æ® hashcode æ¥è¿›è¡Œæ•°æ®çš„å­˜å‚¨ï¼Œæ‰€ä»¥ä½ç½®æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯ä½ç½®ä¸æ˜¯ç”¨æˆ·å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥å¯¹äºç”¨æˆ·æ¥è¯´ set ä¸­çš„å…ƒç´ è¿˜æ˜¯æ— åºçš„); 3.HashMapå’ŒHashTableæœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸåŒºåˆ«ï¼š HashMapæ–¹æ³•æ²¡æœ‰synchronizedä¿®é¥°ï¼Œçº¿ç¨‹éå®‰å…¨ï¼ŒHashTableçº¿ç¨‹å®‰å…¨ï¼› HashMapå…è®¸keyå’Œvalueä¸ºnullï¼Œè€ŒHashTableä¸å…è®¸ 4.HashMapåº•å±‚å®ç° jdk1.7åº•å±‚é‡‡ç”¨çš„æ˜¯æ•°ç»„+é“¾è¡¨å®ç°ï¼›jdk1.8åº•å±‚é‡‡ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘å®ç°ï¼Œç›¸å¯¹äº1.7æå‡äº†æŸ¥è¯¢çš„æ€§èƒ½ é“¾è¡¨è¿‡åº¦åˆ°çº¢é»‘æ ‘çš„é˜ˆå€¼ä¸º8ï¼Œçº¢é»‘æ ‘é€€åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼æ˜¯6ï¼ŒåŸå› åœ¨æºç ä¸­332è¡Œç»™äº†æ˜ç¡®è§£é‡Š(Poisson distribution)æ³Šæ¾åˆ†å¸ƒï¼Œè¿™æ˜¯æ•°å­¦é‡Œé¢ç±»ä¼¼äºæ­£æ€åˆ†å¸ƒçš„ä¸€ä¸ªé—®é¢˜ï¼Œè¿™æ˜¯ç»Ÿè®¡å­¦é‡Œé¢çš„ä¸€äº›ä¸œè¥¿ HashMapåˆå§‹åŒ–çš„æ•°ç»„é•¿åº¦ä¸º16(ç®—æ³•å¯¼è®ºä¸­çš„é™¤æ³•æ•£åˆ—æ³•è®²åˆ° Kå–æ¨¡må¾—åˆ°ä¸€ä¸ªå¯¹åº”çš„ä½ç½®ï¼Œæ ¹æ®å…·ä½“ä½ç½®æ’å…¥ä¸€ä¸ªæ•°æ®å€¼ï¼Œå‡å¦‚é•¿åº¦æ˜¯16ï¼Œé•¿åº¦èŒƒå›´å°±æ˜¯015ï¼Œå–æ¨¡ä¹‹åæˆ‘çš„ä½™æ•°ä¸º015ä¹‹é—´ï¼Œè€Œç®—æ³•å¯¼è®ºä¸­æŒ‡å‡ºï¼Œä¸€ä¸ªä¸å¤ªæ¥è¿‘2çš„æ•´æ•°å¹‚çš„ç´ æ•°ï¼ˆè´¨æ•°ï¼šåªèƒ½è¢«1å’Œå®ƒæœ¬èº«æ•´å‡ºçš„æ•°ï¼‰ï¼Œå¸¸å¸¸æ˜¯mçš„æœ€å¥½é€‰æ‹©ã€‚ä½†æ˜¯hashMapä¸­æœªé‡‡ç”¨ç´ æ•°ï¼Œè€Œæ˜¯é‡‡ç”¨2çš„næ¬¡æ–¹(åˆæ•°)ä½œä¸ºæ•°ç»„é•¿åº¦)ï¼ŒåŸå› ä¸ºï¼š1ã€æ›´ä¾¿äºä½ç½®è®¡ç®—ï¼›2ã€æ–¹ä¾¿åšæ•°æ®è¿ç§»ã€‚ ä¸ºäº†ä¿è¯å­˜å…¥çš„æ•°æ®å‡åŒ€çš„æ•£åˆ—åˆ†å¸ƒåœ¨æ•°ç»„ä¸­ï¼Œéœ€è¦è®¾è®¡è‰¯å¥½çš„hashæ•£åˆ—ç®—æ³•(hashMapä¸­é‡‡ç”¨æ‰°åŠ¨å‡½æ•°æ¥åšçš„ï¼šç§»ä½å’Œå¼‚æˆ–ç›¸å…³æ“ä½œConcurrentHashMapæºç ä¸­684è¡Œspreadæ–¹æ³•ï¼Œå³ï¼šè®©intçš„é«˜16ä½å¼‚æˆ–å®ƒæœ¬èº«)ï¼Œå°½å¯èƒ½çš„é¿å…hashå†²çª(æ¦‚ç‡é—®é¢˜)ï¼Œå…·ä½“è½åˆ°æ•°ç»„å“ªä¸ªèŠ‚ç‚¹å¹¶éæ˜¯é€šè¿‡å–æ¨¡è¿ç®—å¾—å‡ºï¼Œè€Œæ˜¯é€šè¿‡ä¸ä¸Šæ•°ç»„é•¿åº¦-1å³å¯(åªéœ€è¦intç±»å‹æ•°32ä½çš„åå››ä½å‚ä¸è¿ç®—)ï¼Œå³å¯å¾—åˆ°0~15ä¹‹é—´çš„æ•°ï¼Œå› ä¸ºå–æ¨¡è¿ç®—æ•ˆç‡è¿œä½äºä½è¿ç®—ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯hashMapè¦æ±‚åº•å±‚æ•°ç»„é•¿åº¦å¿…é¡»ä¸º2çš„næ¬¡æ–¹çš„åŸå› ä¹‹ä¸€ï¼ˆConcurrentHashMapæºç ä¸­514è¡Œè§„å®šï¼‰ã€‚ 5.HashMap putæµç¨‹ HashMap/ConcurrentHashMap å¹¶ä¸æ˜¯é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºé»˜è®¤ç©ºé—´çš„ï¼Œè€Œæ˜¯é€šè¿‡putæ•°æ®çš„æ—¶å€™è·å–åˆ°å¯¹åº”çš„æ•°æ®ç©ºé—´çš„ï¼Œå¦‚æœæ•°ç»„é•¿åº¦æ˜¯0ï¼Œåˆ™é€šè¿‡CASæ“ä½œååˆå§‹åŒ–æ•°ç»„ï¼Œå¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨åšåˆå§‹åŒ–æ•°ç»„æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹åˆ™è®©å‡ºæ—¶é—´ç‰‡ 6.HashMapæ‰©å®¹æµç¨‹ hashMapè§„å®šäº†å½“æˆ‘çš„æ•°ç»„å¿«æ”¾æ»¡çš„æ—¶å€™å°±è¦å¼€å§‹æ‰©å®¹äº†ï¼Œä»€ä¹ˆæ—¶å€™ç®—æ˜¯å¿«æ”¾æ»¡ï¼ŸHashMapæ˜¯é€šè¿‡æ‰©å®¹å› å­æ¥è§„å®šçš„ HashMapè§„å®šæ‰©å®¹å› å­æ˜¯0.75ï¼Œå¦‚æœé»˜è®¤é•¿åº¦æ˜¯16ï¼Œä¹Ÿå°±æ˜¯è¯´å½“HashMapåº•å±‚æ•°ç»„çš„å®¹é‡è¾¾åˆ°12çš„æ—¶å€™è¿›è¡Œæ‰©å®¹æ“ä½œã€‚0.75åˆ™æ˜¯æ ¹æ®ç»Ÿè®¡å­¦å¾—æ¥çš„ã€‚private static final float LOAD_FACTOR = 0.75f; æ‰©å®¹é¦–å…ˆè¦åˆ›å»ºæ–°çš„æ•°ç»„ï¼ˆåŸæ¥å¤§å°å·¦ç§»1ä½ï¼‰ConcurrentHaspMapæºç 2367è¡Œå¼€å§‹æ‰©å®¹æ“ä½œ è½¬ç§»æ—§æ•°æ®åˆ°æ–°çš„æ•°ç»„ä¸­å»ï¼ˆæ€ä¹ˆè®¡ç®—æ‰©å®¹åæ•°æ®ä¸‹æ ‡ä½ç½®ï¼Ÿï¼‰åŸæ¥ï¼šh&amp;(n-1)è®¡ç®—ä¸‹æ ‡ä½ç½®ï¼Œæ‰©å®¹å h$(31)ï¼ŒåŸæ¥å ç”¨4ä¸ªäºŒè¿›åˆ¶ä½ï¼Œæ‰©å®¹åå ç”¨5ä¸ªäºŒè¿›åˆ¶ä½ï¼Œæ‰€ä»¥åªéœ€è¦çœ‹ç¬¬äº”ä½å³å¯ï¼Œå¦‚æœç¬¬äº”ä½æ˜¯0ï¼Œæ‰©å®¹åçš„çš„ä¸‹æ ‡è·ŸåŸä½ç½®ä¸€æ ·ï¼Œå¦‚æœæ˜¯1ï¼Œæ–°ä¸‹æ ‡ä½ç½®åœ¨åŸæ•°ç»„çš„ä½ç½®çš„åŸºç¡€ä¸ŠåŠ ä¸ŠåŸæ¥æ•°ç»„é•¿åº¦å³å¯ï¼Œè¿™ä¹Ÿæ˜¯æ•°ç»„é•¿åº¦é‡‡ç”¨2çš„Næ¬¡æ–¹æ‰©å®¹çš„ç¬¬äºŒä¸ªåŸå›  å‡è®¾åŸæ¥é•¿åº¦æ˜¯128ï¼Œæ‰©å®¹åæ˜¯256ï¼Œæ•´ä½“æ‰©å®¹æ–¹å¼æ˜¯é€šè¿‡å¤šçº¿ç¨‹æ–¹å¼è¿è¡Œçš„ï¼Œä½†æ˜¯è¦ä¿è¯æ•°æ®ä¸èƒ½ä¹±ï¼Œå°†åŸæ¥æ•°ç»„åˆ†æ®µï¼Œè§„å®šæ¯ä¸ªçº¿ç¨‹æœ€å°‘è´Ÿè´£16ä¸ªæ¡¶çš„è¿ç§»å·¥ä½œï¼Œ8ä¸ªçº¿ç¨‹å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œå¦‚æœå°äº16ä¸ªæ¡¶ï¼Œç›´æ¥å•çº¿ç¨‹æ‰§è¡Œ 7.ä¸ºä»€ä¹ˆé€‰æ‹©ç”¨çº¢é»‘æ ‘äºŒå‰æ ‘åœ¨æç«¯æƒ…å†µä¸‹ä¼šé€€åŒ–ä¸ºé“¾è¡¨ï¼ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦è·Ÿé“¾è¡¨ç›¸ä¼¼ï¼Œè€ŒAVLæ ‘ï¼ŒSBæ ‘ï¼Œçº¢é»‘æ ‘ï¼Œéƒ½å±äºå¹³è¡¡äºŒå‰æ ‘ï¼Œå°½é‡ä¿æŒå·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦å·®ä¸è¦ç›¸å·®å¤ªå¤§ï¼Œè€Œè¿™ä¸‰ç§æ ‘çš„å·®åˆ«å°±åœ¨äºå·¦æ ‘å’Œå³æ ‘çš„é«˜åº¦è§„åˆ™ä¸åŒã€‚ AVLæ ‘ï¼šä¸¥æ ¼æ„ä¹‰å¹³è¡¡æ ‘ï¼Œçš„è¦æ±‚å·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦å·®ä¸èƒ½è¶…è¿‡1ï¼ŒæŸå¤±äº†éƒ¨åˆ†æ’å…¥æ€§èƒ½ï¼Œå¸¦æ¥äº†é«˜æ•ˆçš„æŸ¥è¯¢ SBæ ‘ï¼š çº¢é»‘æ ‘ï¼šè¦æ±‚æœ€é•¿å­æ ‘ä¸èƒ½è¶…è¿‡æœ€çŸ­å­æ ‘çš„2å€å³å¯ï¼ŒæŸå¤±äº†éƒ¨åˆ†æŸ¥è¯¢æ€§èƒ½ï¼Œä½¿å¾—æŸ¥è¯¢æ•ˆç‡é«˜äºé“¾è¡¨çš„åŒæ—¶ï¼Œç›¸æ¯”äºå…¶ä»–æ ‘æå‡äº†æ’å…¥æ€§èƒ½ï¼Œå°½é‡åšåˆ°äº†æ’å…¥å’ŒæŸ¥è¯¢çš„ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œè€ŒHashMapåˆ™æ˜¯æŸ¥å¤šï¼Œæ’å…¥å°‘(è¿™é‡Œçš„æ’å…¥æŒ‡çš„æ˜¯äº§ç”ŸHashå†²çªä¸‹çš„æ’å…¥)ï¼Œæ‰€ä»¥çº¢é»‘æ ‘æ›´é€‚åˆHashMapæ¥åšåº•å±‚çš„å­˜å‚¨ç»“æ„ã€‚ 8.é¢å‘å¯¹è±¡çš„ç‰¹å¾?é¢å‘å¯¹è±¡çš„ç‰¹å¾:å°è£…ã€ç»§æ‰¿ã€å¤šæ€ã€æŠ½è±¡ã€‚ å°è£…:å°±æ˜¯æŠŠå¯¹è±¡çš„å±æ€§å’Œè¡Œä¸º(æ•°æ®)ç»“åˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ•´ä½“ï¼Œå¹¶å°½å¯èƒ½éšè—å¯¹è±¡çš„å†… éƒ¨å®ç°ç»†èŠ‚ï¼Œå°±æ˜¯æŠŠä¸æƒ³å‘Šè¯‰æˆ–è€…ä¸è¯¥å‘Šè¯‰åˆ«äººçš„ä¸œè¥¿éšè—èµ·æ¥ï¼ŒæŠŠå¯ä»¥å‘Šè¯‰åˆ«äººçš„å…¬å¼€ï¼Œåˆ«äººåªèƒ½ç”¨æˆ‘æä¾›çš„åŠŸèƒ½å®ç°éœ€æ±‚ï¼Œè€Œä¸çŸ¥é“æ˜¯å¦‚ä½•å®ç°çš„ã€‚å¢åŠ å®‰å…¨æ€§ã€‚ ç»§æ‰¿:å­ç±»ç»§æ‰¿çˆ¶ç±»çš„æ•°æ®å±æ€§å’Œè¡Œä¸ºï¼Œå¹¶èƒ½æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ‰©å±•å‡ºæ–°çš„è¡Œä¸ºï¼Œæé«˜äº†ä»£ ç çš„å¤ç”¨æ€§ã€‚ å¤šæ€:æŒ‡å…è®¸ä¸åŒçš„å¯¹è±¡å¯¹åŒä¸€æ¶ˆæ¯åšå‡ºç›¸åº”ã€‚å³åŒä¸€æ¶ˆæ¯å¯ä»¥æ ¹æ®å‘é€å¯¹è±¡çš„ä¸åŒè€Œé‡‡ ç”¨å¤šç§ä¸åŒçš„è¡Œä¸ºæ–¹å¼(å‘é€æ¶ˆæ¯å°±æ˜¯å‡½æ•°è°ƒç”¨)ã€‚å°è£…å’Œç»§æ‰¿å‡ ä¹éƒ½æ˜¯ä¸ºå¤šæ€è€Œå‡†å¤‡ çš„ï¼Œåœ¨æ‰§è¡ŒæœŸé—´åˆ¤æ–­å¼•ç”¨å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œæ ¹æ®å…¶å®é™…çš„ç±»å‹è°ƒç”¨å…¶ç›¸åº”çš„æ–¹æ³•ã€‚ æŠ½è±¡:è¡¨ç¤ºå¯¹é—®é¢˜é¢†åŸŸè¿›è¡Œåˆ†æã€è®¾è®¡ä¸­å¾—å‡ºçš„æŠ½è±¡çš„æ¦‚å¿µï¼Œæ˜¯å¯¹ä¸€ç³»åˆ—çœ‹ä¸Šå»ä¸åŒï¼Œä½†æ˜¯æœ¬è´¨ä¸Šç›¸åŒçš„å…·ä½“æ¦‚å¿µçš„æŠ½è±¡ã€‚åœ¨ Java ä¸­æŠ½è±¡ç”¨ abstract å…³é”®å­—æ¥ä¿®é¥°ï¼Œç”¨abstractä¿®é¥°ç±»æ—¶ï¼Œæ­¤ç±»å°±ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼ŒæŠ½è±¡ç±»(æ¥å£)å°±æ˜¯ä¸ºäº†ç»§æ‰¿è€Œå­˜åœ¨çš„ã€‚ 9.å¸¸è§çš„RuntimeException java.lang.NullPointerException ç©ºæŒ‡é’ˆå¼‚å¸¸;å‡ºç°åŸå› :è°ƒç”¨äº†æœªç»åˆå§‹åŒ–çš„å¯¹è±¡æˆ–è€…æ˜¯ä¸å­˜åœ¨ çš„å¯¹è±¡ã€‚ java.lang.ClassNotFoundException æŒ‡å®šçš„ç±»æ‰¾ä¸åˆ°;å‡ºç°åŸå› :ç±»çš„åç§°å’Œè·¯å¾„åŠ è½½é”™è¯¯;é€šå¸¸ éƒ½æ˜¯ç¨‹åºè¯•å›¾é€šè¿‡å­—ç¬¦ä¸²æ¥åŠ è½½æŸä¸ªç±»æ—¶å¯èƒ½å¼•å‘å¼‚å¸¸ã€‚ java.lang.NumberFormatException å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—å¼‚å¸¸;å‡ºç°åŸå› :å­—ç¬¦å‹æ•°æ®ä¸­åŒ…å«éæ•° å­—å‹å­—ç¬¦ã€‚ java.lang.IndexOutOfBoundsException æ•°ç»„è§’æ ‡è¶Šç•Œå¼‚å¸¸ï¼Œå¸¸è§äºæ“ä½œæ•°ç»„å¯¹è±¡æ—¶å‘ç”Ÿã€‚ java.lang.IllegalArgumentException æ–¹æ³•ä¼ é€’å‚æ•°é”™è¯¯ã€‚ java.lang.ClassCastException æ•°æ®ç±»å‹è½¬æ¢å¼‚å¸¸ã€‚ java.lang.NoClassDefFoundException æœªæ‰¾åˆ°ç±»å®šä¹‰é”™è¯¯ã€‚ SQLException SQL å¼‚å¸¸ï¼Œå¸¸è§äºæ“ä½œæ•°æ®åº“æ—¶çš„ SQL è¯­å¥é”™è¯¯ã€‚ java.lang.InstantiationExceptionå®ä¾‹åŒ–å¼‚å¸¸ã€‚ java.lang.NoSuchMethodExceptionæ–¹æ³•ä¸å­˜åœ¨å¼‚å¸¸ã€‚ 10.å¸¸è§çš„å¼•ç”¨ç±»å‹javaçš„å¼•ç”¨ç±»å‹ä¸€èˆ¬åˆ†ä¸ºå››ç§ï¼šå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨ å¼ºå¼•ç”¨ï¼šæ™®é€šçš„å˜é‡å¼•ç”¨ è½¯å¼•ç”¨ï¼šå°†å¯¹è±¡ç”¨SoftReferenceè½¯å¼•ç”¨ç±»å‹çš„å¯¹è±¡åŒ…è£¹ï¼Œæ­£å¸¸æƒ…å†µä¸ä¼šè¢«å›æ”¶ï¼Œä½†æ˜¯GCåšå®Œåå‘ç°é‡Šæ”¾ä¸å‡ºç©ºé—´å­˜æ”¾æ–°çš„å¯¹è±¡ï¼Œåˆ™ä¼šæŠŠè¿™äº›è½¯å¼•ç”¨çš„å¯¹è±¡å›æ”¶æ‰ã€‚è½¯å¼•ç”¨å¯ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜ã€‚ å¼±å¼•ç”¨ï¼šå°†å¯¹è±¡ç”¨WeakReferenceè½¯å¼•ç”¨ç±»å‹çš„å¯¹è±¡åŒ…è£¹ï¼Œå¼±å¼•ç”¨è·Ÿæ²¡å¼•ç”¨å·®ä¸å¤šï¼ŒGCä¼šç›´æ¥å›æ”¶æ‰ï¼Œå¾ˆå°‘ç”¨ è™šå¼•ç”¨ï¼šè™šå¼•ç”¨ä¹Ÿç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ï¼Œå‡ ä¹ä¸ç”¨ å››ã€ç¼“å­˜:Redisäº”ã€MQæ¶ˆæ¯é˜Ÿåˆ— Rabbitmqç”Ÿäº§é«˜å¯ç”¨æ€ä¹ˆå®ç°çš„ ç”Ÿäº§éƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼šé¿å…å•æœºæ¨¡å¼ä¸‹MQæœåŠ¡å™¨æŒ‚äº†å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œè¿˜å¯ä»¥æ‰¿è½½æ›´é«˜çš„å¹¶å‘é‡ï¼Œä½†æ˜¯é›†ç¾¤æ¨¡å¼æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºé˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—åªä¼šå­˜åœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼Œå…¶ä»–é›†ç¾¤èŠ‚ç‚¹ä¸ä¼šå¤‡ä»½è¯¥é˜Ÿåˆ—ï¼Œä¸€æ—¦è¯¥èŠ‚ç‚¹å®•æœºï¼Œè¯¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å°±ä¼šä¸¢å¤±(äº²æµ‹è®¾ç½®æŒä¹…åŒ–ä¹Ÿä¸¢å¤±) ä½¿ç”¨é•œåƒé˜Ÿåˆ—ï¼šå¯ä»¥è§£å†³é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªæœºå™¨ä¸Šåªæœ‰ä¸€ä¸ªé˜Ÿåˆ—çš„é—®é¢˜ï¼Œè®©æ¶ˆæ¯åœ¨å…¶ä»–èŠ‚ç‚¹å†å¤‡ä»½ä¸€ä»½ã€‚å¼€å¯æ–¹å¼ï¼šä»»ä½•èŠ‚ç‚¹æ·»åŠ policyç­–ç•¥å³å¯ï¼Œè¯¥é›†ç¾¤å°±å…·æœ‰é•œåƒé˜Ÿåˆ—èƒ½åŠ›ï¼Œå¯è®¾ç½®å¤‡ä»½çš„ä»½æ•°å’Œå¤‡ä»½é˜Ÿåˆ—è§„åˆ™ï¼Œå³ä½¿å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å®•æœºï¼Œä¹Ÿä¼šä¿è¯æ•´ä¸ªé›†ç¾¤ä¸­ä¿å­˜2ä»½ é«˜å¯ç”¨è´Ÿè½½å‡è¡¡ï¼šhaproxy+keepaliveï¼Œnginxï¼Œlvsç­‰å®ç°é«˜å¯ç”¨è´Ÿè½½å‡è¡¡ å…¶ä»–ï¼šFederation Exchangeè”é‚¦äº¤æ¢æœºæ’ä»¶è§£å†³ä¸¤åœ°æ¥å—æ¶ˆæ¯ç¡®è®¤æ¶ˆæ¯å»¶è¿Ÿé—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç”¨Shovelæ¥åšæ•°æ®åŒæ­¥ï¼Œéœ€è¦å®‰è£…æ’ä»¶ å…­ã€å¤šçº¿ç¨‹æ­»é” æ­»é”ï¼šæ˜¯æŒ‡ä¸€ç»„äº’ç›¸ç«äº‰èµ„æºçš„çº¿ç¨‹ï¼Œå› ä¸ºäº’ç›¸ç­‰å¾…ï¼Œå¯¼è‡´æ°¸ä¹…é˜»å¡çš„ç°è±¡ã€‚ åŸå› ï¼šå¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶ å…±äº«äº’æ–¥æ¡ä»¶ï¼šå…±äº«èµ„æºxå’Œyåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ å æœ‰ä¸”ç­‰å¾…ï¼šçº¿ç¨‹t1å·²ç»å æœ‰å…±äº«èµ„æºxï¼Œåœ¨ç­‰å¾…å…±äº«èµ„æºyçš„æ—¶å€™ä¸é‡Šæ”¾å…±äº«èµ„æºx ä¸å¯æŠ¢å ï¼šå…¶ä»–çº¿ç¨‹ä¸èƒ½å¼ºè¡ŒæŠ¢å çº¿ç¨‹t1å æœ‰çš„èµ„æº å¾ªç¯ç­‰å¾…ï¼šçº¿ç¨‹t1ç­‰å¾…çº¿ç¨‹t2å æœ‰çš„èµ„æºï¼Œçº¿ç¨‹t2ç­‰å¾…çº¿ç¨‹t1å æœ‰çš„èµ„æº å¦‚ä½•é¿å…æ­»é”ï¼š æ—¢ç„¶äº§ç”Ÿæ­»é”å¿…ç„¶æ»¡è¶³å››ä¸ªæ¡ä»¶ï¼Œé‚£æˆ‘ä»¬åªè¦æ‰“ç ´å››ä¸ªæ¡ä»¶ä¸­çš„ä¸€ä¸ªå°±å¯ä»¥é¿å…ï¼Œç¬¬ä¸€ä¸ªäº’æ–¥æ¡ä»¶æ˜¯æ— æ³•è¢«ç ´åçš„ï¼Œå› ä¸ºé”æœ¬èº«å°±æ˜¯é€šè¿‡äº’æ–¥æ¥è§£å†³çº¿ç¨‹å®‰å…¨çš„ é’ˆå¯¹åä¸‰ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬é€ä¸€åˆ†æï¼Œå æœ‰ä¸”ç­‰å¾…è¿™ä¸ªæ¡ä»¶æˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æºï¼Œä¸å­˜åœ¨ç­‰å¾…ï¼› ä¸å¯æŠ¢å è¿™ä¸ªæ¡ä»¶ï¼šå æœ‰éƒ¨åˆ†èµ„æºçš„çº¿ç¨‹è¿›ä¸€æ­¥ç”³è¯·å…¶ä»–èµ„æºçš„æ—¶å€™å¦‚æœç”³è¯·ä¸åˆ°ï¼Œå¯ä»¥ä¸»åŠ¨é‡Šæ”¾å·²å æœ‰çš„èµ„æºï¼Œè¿™æ ·ä¸å¯æŠ¢å è¿™æ¡ä»¶å°±ç ´åäº†ï¼› å¾ªç¯ç­‰å¾…è¿™ä¸ªæ¡ä»¶ï¼šå¯ä»¥æŒ‰ç…§é¡ºåºå»ç”³è¯·èµ„æºè¿›è¡Œé¢„é˜²ï¼Œå°±æ˜¯è¯´èµ„æºæ˜¯æœ‰çº¿æ€§é¡ºåºçš„ï¼Œç”³è¯·çš„æ—¶å€™å¯ä»¥å…ˆç”³è¯·èµ„æºåºå·å°çš„ï¼Œå†ç”³è¯·èµ„æºåºå·å¤§çš„ï¼Œçº¿æ€§åŒ–ä¹‹åï¼Œå°±ä¸å­˜åœ¨å¾ªç¯ç­‰å¾…äº† sleepå’ŒwaitåŒºåˆ« sleep æ˜¯ Thread ç±»çš„é™æ€æœ¬åœ°æ–¹æ³•ï¼Œwait åˆ™æ˜¯ Object ç±»çš„æœ¬åœ°æ–¹æ³• sleepæ–¹æ³•ä¸ä¼šé‡Šæ”¾é”ï¼Œä½†æ˜¯waitä¼šé‡Šæ”¾ï¼Œè€Œä¸”ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ sleepæ–¹æ³•ä¸ä¾èµ–äºåŒæ­¥å™¨synchronizedï¼Œä½†æ˜¯waitéœ€è¦ä¾èµ–synchronizedå…³é”®å­— sleepä¸éœ€è¦è¢«å”¤é†’ï¼ˆä¼‘çœ ä¹‹åæ¨å‡ºé˜»å¡ï¼‰ï¼Œä½†æ˜¯waitéœ€è¦ï¼ˆä¸æŒ‡å®šæ—¶é—´éœ€è¦è¢«åˆ«äººä¸­æ–­ï¼‰ sleep ä¸€èˆ¬ç”¨äºå½“å‰çº¿ç¨‹ä¼‘çœ ï¼Œæˆ–è€…è½®å¾ªæš‚åœæ“ä½œï¼Œwait åˆ™å¤šç”¨äºå¤šçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ sleep ä¼šè®©å‡º CPU æ‰§è¡Œæ—¶é—´ä¸”å¼ºåˆ¶ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œ wait åˆ™ä¸ä¸€å®šï¼Œwait åå¯èƒ½è¿˜æ˜¯æœ‰æœºä¼šé‡æ–°ç«äº‰åˆ°é”ç»§ç»­æ‰§è¡Œçš„ã€‚ sleepå°±æ˜¯æŠŠcpuçš„æ‰§è¡Œèµ„æ ¼å’Œæ‰§è¡Œæƒé‡Šæ”¾å‡ºå»ï¼Œä¸å†è¿è¡Œæ­¤çº¿ç¨‹ï¼Œå½“å®šæ—¶æ—¶é—´ç»“æŸå†å–å›cpuèµ„æºï¼Œå‚ä¸cpuçš„è°ƒåº¦ï¼Œè·å–åˆ°cpuèµ„æºåå°±å¯ä»¥ç»§ç»­è¿è¡Œäº†ã€‚è€Œå¦‚æœsleepæ—¶è¯¥çº¿ç¨‹æœ‰é”ï¼Œé‚£ä¹ˆsleepä¸ä¼šé‡Šæ”¾è¿™ä¸ªé”ï¼Œè€Œæ˜¯æŠŠé”å¸¦ç€è¿›å…¥äº†å†»ç»“çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶ä»–éœ€è¦è¿™ä¸ªé”çš„çº¿ç¨‹æ ¹æœ¬ä¸å¯èƒ½è·å–åˆ°è¿™ä¸ªé”ã€‚ä¹Ÿå°±æ˜¯è¯´æ— æ³•æ‰§è¡Œç¨‹åºã€‚å¦‚æœåœ¨ç¡çœ æœŸé—´å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†è¿™ä¸ªçº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ä¹Ÿä¼šæŠ›å‡ºinterruptexceptionå¼‚å¸¸è¿”å›ï¼Œè¿™ç‚¹å’Œwaitæ˜¯ä¸€æ ·çš„ã€‚ å½“æˆ‘ä»¬è°ƒç”¨waitï¼ˆï¼‰æ–¹æ³•åï¼Œçº¿ç¨‹ä¼šæ”¾åˆ°ç­‰å¾…æ± å½“ä¸­ï¼Œç­‰å¾…æ± çš„çº¿ç¨‹æ˜¯ä¸ä¼šå»ç«äº‰åŒæ­¥é”ã€‚åªæœ‰è°ƒç”¨äº†notifyï¼ˆï¼‰æˆ–notifyAll()åç­‰å¾…æ± çš„çº¿ç¨‹æ‰ä¼šå¼€å§‹å»ç«äº‰é”ï¼Œnotifyï¼ˆï¼‰æ˜¯éšæœºä»ç­‰å¾…æ± é€‰å‡ºä¸€ä¸ªçº¿ç¨‹æ”¾åˆ°é”æ± ï¼Œè€ŒnotifyAll()æ˜¯å°†ç­‰å¾…æ± çš„æ‰€æœ‰çº¿ç¨‹æ”¾åˆ°é”æ± å½“ä¸­ Volitileä½œç”¨ å¯è§æ€§ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ã€‚å†…å­˜å±éšœ-&gt;æ±‡ç¼–Lockå…³é”®å­—-&gt;ç¼“å­˜ä¸€è‡´æ€§åè®® åŸå­æ€§ï¼šå¯¹ä»»æ„å•ä¸ªvolatileå˜é‡çš„è¯»/å†™å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äºvolatile++è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ æœ‰åºæ€§ï¼šå¯¹volatileä¿®é¥°çš„å˜é‡çš„è¯»å†™æ“ä½œå‰ååŠ ä¸Šå„ç§ç‰¹å®šçš„å†…å­˜å±éšœæ¥ç¦æ­¢æŒ‡ä»¤é‡æ’åºæ¥ä¿éšœæœ‰åºæ€§ Volitileå¦‚ä½•ä¿è¯å¯è§æ€§ ç¼“å­˜ä¸€è‡´æ€§ï¼šåœ¨å…±äº«å†…å­˜å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ç¼“å­˜å†…å­˜ï¼Œå…±äº«æ•°æ®åœ¨ä¸»å†…å­˜å’Œå„å¤„ç†å™¨ç§æœ‰ç¼“å­˜åŒæ—¶å­˜åœ¨ã€‚å½“æ•°æ®çš„ä¸€ä¸ªå‰¯æœ¬å‘ç”Ÿæ›´æ”¹ï¼Œå…¶ä»–å‰¯æœ¬éœ€è¦æ„ŸçŸ¥åˆ°æœ€æ–°ä¿®æ”¹æ•°æ®ã€‚ç¼“å­˜ä¸€è‡´æ€§çš„æ‰‹æ®µä¸»è¦æœ‰ï¼š æ€»çº¿é”å®šï¼šæ€»çº¿é”å®šå°±æ˜¯ä½¿ç”¨å¤„ç†å™¨æä¾›çš„ä¸€ä¸ª LOCKï¼ƒä¿¡å·ï¼Œå½“å…¶ä¸­ä¸€ä¸ªå¤„ç†å™¨åœ¨æ€»çº¿ä¸Šè¾“å‡ºæ­¤ä¿¡å·æ—¶ï¼Œå…¶å®ƒå¤„ç†å™¨çš„è¯·æ±‚å°†è¢«é˜»å¡ï¼Œé‚£ä¹ˆè¯¥å¤„ç†å™¨å¯ä»¥ç‹¬å å…±äº«å†…å­˜ã€‚ æ€»çº¿çª¥æ¢(Bus snooping)ï¼šæ˜¯ç¼“å­˜ä¸­çš„ä¸€è‡´æ€§æ§åˆ¶å™¨çª¥æ¢æ€»çº¿äº‹åŠ¡çš„ä¸€ç§æ–¹æ¡ˆï¼ˆè¯¥æ–¹æ¡ˆç”±Ravishankarå’ŒGoodmanäº1983å¹´æå‡ºï¼‰å½“æ•°æ®è¢«å¤šä¸ªç¼“å­˜å…±äº«æ—¶ï¼Œä¸€ä¸ªå¤„ç†å™¨ä¿®æ”¹äº†å…±äº«æ•°æ®çš„å€¼ï¼Œå¯ä»¥æ˜¯åˆ·æ–°ç¼“å­˜å—æˆ–ä½¿ç¼“å­˜å—å¤±æ•ˆè¿˜å¯ä»¥é€šè¿‡ç¼“å­˜å—çŠ¶æ€çš„æ”¹å˜ï¼Œæ¥è¾¾åˆ°ç¼“å­˜ä¸€è‡´æ€§çš„ç›®çš„ï¼Œä¸»è¦å–å†³äºçª¥æ¢åè®®ç±»å‹ï¼š å†™å¤±æ•ˆï¼ˆWrite-invalidateï¼‰ ï¼šå½“ä¸€ä¸ªå¤„ç†å™¨å†™å…¥å…±äº«ç¼“å­˜æ—¶ï¼Œå…¶ä»–ç¼“å­˜ä¸­çš„æ‰€æœ‰å…±äº«å‰¯æœ¬éƒ½ä¼šé€šè¿‡æ€»çº¿çª¥æ¢å¤±æ•ˆã€‚ç¡®ä¿å¤„ç†å™¨åªèƒ½è¯»å†™ä¸€ä¸ªæ•°æ®å‰¯æœ¬ï¼Œå…¶ä»–ç¼“å­˜ä¸­çš„æ‰€æœ‰å…¶ä»–å‰¯æœ¬éƒ½æ— æ•ˆã€‚è¿™æ˜¯æœ€å¸¸ç”¨çš„çª¥æ¢åè®®ã€‚MSIã€MESIã€MOSIã€MOESIå’ŒMESIFåè®®å±äºè¯¥ç±»å‹ã€‚ å†™æ›´æ–°ï¼ˆWrite-updateï¼‰ï¼šå½“å¤„ç†å™¨å†™å…¥ä¸€ä¸ªå…±äº«ç¼“å­˜å—æ—¶ï¼Œå…¶ä»–ç¼“å­˜çš„æ‰€æœ‰å…±äº«å‰¯æœ¬éƒ½ä¼šé€šè¿‡æ€»çº¿çª¥æ¢æ›´æ–°ã€‚è¿™ä¸ªæ–¹æ³•å°†å†™æ•°æ®å¹¿æ’­åˆ°æ€»çº¿ä¸Šçš„æ‰€æœ‰ç¼“å­˜ä¸­ã€‚å®ƒæ¯”å†™å¤±æ•ˆåè®®å¼•èµ·æ›´å¤§çš„æ€»çº¿æµé‡ï¼Œå› æ­¤è¿™ç§æ–¹æ³•ä¸å¸¸è§ã€‚Dragonå’Œfireflyåè®®å±äºæ­¤ç±»åˆ«ã€‚ æŒ‡ä»¤é‡æ’åºJavaè¯­è¨€è§„èŒƒè§„å®šJVMçº¿ç¨‹å†…éƒ¨ç»´æŒé¡ºåºåŒ–è¯­ä¹‰ï¼Œå³åªè¦ç¨‹åºçš„æœ€ç»ˆç»“æœä¸å®ƒé¡ºåºåŒ–æƒ…å†µçš„ç»“æœç›¸ç­‰ï¼Œé‚£ä¹ˆæŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºå¯ä»¥ä¸ä»£ç é¡ºåºä¸ä¸€è‡´ï¼Œæ­¤è¿‡ç¨‹å«æŒ‡ä»¤çš„é‡æ’åºã€‚æŒ‡ä»¤é‡æ’åºçš„æ„ä¹‰ï¼šï¼šJVMèƒ½æ ¹æ®å¤„ç†å™¨ç‰¹æ€§ï¼ˆCPUå¤šçº§ç¼“å­˜ç³»ç»Ÿã€å¤šæ ¸å¤„ç†å™¨ç­‰ï¼‰é€‚å½“çš„å¯¹æœºå™¨æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä½¿æœºå™¨æŒ‡ä»¤èƒ½æ›´ç¬¦åˆCPUçš„æ‰§è¡Œç‰¹æ€§ï¼Œæœ€å¤§é™åº¦çš„å‘æŒ¥æœºå™¨æ€§èƒ½ã€‚ Javaçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ NEWï¼ˆåˆå§‹åŒ–çŠ¶æ€ï¼‰ RUNNABLEï¼ˆå¯è¿è¡ŒçŠ¶æ€+è¿è¡ŒçŠ¶æ€ï¼‰ BLOCKEDï¼ˆé˜»å¡çŠ¶æ€ï¼‰ WAITINGï¼ˆæ— æ—¶é™ç­‰å¾…ï¼‰ TIMED_WAITINGï¼ˆæœ‰æ—¶é™ç­‰å¾…ï¼‰ TERMINATEDï¼ˆç»ˆæ­¢çŠ¶æ€ï¼‰ åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œæœ‰äº”ç§çŠ¶æ€ï¼ŒJava çº¿ç¨‹ä¸­çš„ BLOCKEDã€WAITINGã€TIMED_WAITING æ˜¯ä¸€ç§çŠ¶æ€ï¼Œå³å‰é¢æˆ‘ä»¬æåˆ°çš„ä¼‘çœ çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´åªè¦ Java çº¿ç¨‹å¤„äºè¿™ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ°¸è¿œæ²¡æœ‰ CPU çš„ä½¿ç”¨æƒã€‚ linuxæŸ¥çœ‹çº¿ç¨‹å‘½ä»¤ ps - fe æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹ ps - fT - p æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆ PID ï¼‰çš„æ‰€æœ‰çº¿ç¨‹ kill æ€æ­»è¿›ç¨‹ top æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹ top - H - p æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆ PID ï¼‰çš„æ‰€æœ‰çº¿ç¨‹ jps å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹ jstack æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆ PID ï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€ jconsole æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰ Javaçº¿ç¨‹çš„å®ç°æ–¹å¼ æ–¹å¼1ï¼šä½¿ç”¨ Threadç±»æˆ–ç»§æ‰¿Threadç±» å®ç° Runnable æ¥å£é…åˆThread ä½¿ç”¨æœ‰è¿”å›å€¼çš„ Callableï¼Œå€ŸåŠ©çº¿ç¨‹æ± ä½¿ç”¨ ä½¿ç”¨ lambda æœ¬è´¨ä¸ŠJavaä¸­å®ç°çº¿ç¨‹åªæœ‰ä¸€ç§æ–¹å¼ï¼Œéƒ½æ˜¯é€šè¿‡new Thread()åˆ›å»ºçº¿ç¨‹ï¼Œè°ƒç”¨Thread#startå¯åŠ¨çº¿ç¨‹æœ€ç»ˆéƒ½ä¼šè°ƒç”¨Thread#runæ–¹æ³• Threadå¸¸ç”¨æ–¹æ³•sleepæ–¹æ³• è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» Running è¿›å…¥TIMED_WAITINGçŠ¶æ€ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é” å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡ºInterruptedExceptionï¼Œå¹¶ä¸”ä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿— ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ sleepå½“ä¼ å…¥å‚æ•°ä¸º0æ—¶ï¼Œå’Œyieldç›¸åŒ yieldæ–¹æ³• yieldä¼šé‡Šæ”¾CPUèµ„æºï¼Œè®©å½“å‰çº¿ç¨‹ä» Running è¿›å…¥ RunnableçŠ¶æ€ï¼Œè®©ä¼˜å…ˆçº§æ›´é«˜ï¼ˆè‡³å°‘æ˜¯ç›¸åŒï¼‰çš„çº¿ç¨‹è·å¾—æ‰§è¡Œæœºä¼šï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼› å‡è®¾å½“å‰è¿›ç¨‹åªæœ‰mainçº¿ç¨‹ï¼Œå½“è°ƒç”¨yieldä¹‹åï¼Œmainçº¿ç¨‹ä¼šç»§ç»­è¿è¡Œï¼Œå› ä¸ºæ²¡æœ‰æ¯”å®ƒä¼˜å…ˆçº§æ›´é«˜çš„çº¿ç¨‹ï¼› å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ ThreadLocalçš„å®ç°åŸç†ThreadLocalçš„å®ç°åŸç†ï¼Œæ¯ä¸€ä¸ªThreadç»´æŠ¤ä¸€ä¸ªThreadLocalMapï¼Œkeyä¸ºä½¿ç”¨å¼±å¼•ç”¨çš„ThreadLocalå®ä¾‹ï¼Œvalueä¸ºçº¿ç¨‹å˜é‡çš„å‰¯æœ¬ ThreadLocalåº”ç”¨åœºæ™¯ åœ¨è¿›è¡Œå¯¹è±¡è·¨å±‚ä¼ é€’çš„æ—¶å€™ï¼Œä½¿ç”¨ThreadLocalå¯ä»¥é¿å…å¤šæ¬¡ä¼ é€’ï¼Œæ‰“ç ´å±‚æ¬¡é—´çš„çº¦æŸã€‚ çº¿ç¨‹é—´æ•°æ®éš”ç¦» è¿›è¡Œäº‹åŠ¡æ“ä½œï¼Œç”¨äºå­˜å‚¨çº¿ç¨‹äº‹åŠ¡ä¿¡æ¯ã€‚ æ•°æ®åº“è¿æ¥ï¼ŒSessionä¼šè¯ç®¡ç†ã€‚ Springæ¡†æ¶åœ¨äº‹åŠ¡å¼€å§‹æ—¶ä¼šç»™å½“å‰çº¿ç¨‹ç»‘å®šä¸€ä¸ªJdbc Connection,åœ¨æ•´ä¸ªäº‹åŠ¡è¿‡ç¨‹éƒ½æ˜¯ä½¿ç”¨è¯¥çº¿ç¨‹ç»‘å®šçš„connectionæ¥æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œå®ç°äº†äº‹åŠ¡çš„éš”ç¦»æ€§ã€‚Springæ¡†æ¶é‡Œé¢å°±æ˜¯ç”¨çš„ThreadLocalæ¥å®ç°è¿™ç§éš”ç¦» ThreadLocalå†…å­˜æ³„éœ²åŸå› ï¼Œå¦‚ä½•é¿å… å¼ºå¼•ç”¨ï¼šä½¿ç”¨æœ€æ™®éçš„å¼•ç”¨(new)ï¼Œä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨ï¼Œä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå®æ„¿æŠ›å‡ºOutOfMemoryErroré”™è¯¯ï¼Œä½¿ç¨‹åºå¼‚å¸¸ç»ˆæ­¢ï¼Œä¹Ÿä¸å›æ”¶è¿™ç§å¯¹è±¡ã€‚ å¼±å¼•ç”¨ï¼šJVMè¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚åœ¨javaä¸­ï¼Œç”¨java.lang.ref.WeakReferenceç±»æ¥è¡¨ç¤ºã€‚å¯ä»¥åœ¨ç¼“å­˜ä¸­ä½¿ç”¨å¼±å¼•ç”¨ã€‚ ThreadLocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³• æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocaléƒ½è°ƒç”¨å®ƒçš„remove()æ–¹æ³•æ¸…é™¤æ•°æ® å°†ThreadLocalå˜é‡å®šä¹‰æˆprivate staticï¼Œè¿™æ ·å°±ä¸€ç›´å­˜åœ¨ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œä¹Ÿå°±èƒ½ä¿è¯ä»»ä½•æ—¶å€™éƒ½èƒ½é€šè¿‡ThreadLocalçš„å¼±å¼•ç”¨è®¿é—®åˆ°Entryçš„valueå€¼ï¼Œè¿›è€Œæ¸…é™¤æ‰ ã€‚ synchronizedå’ŒReentranLockåŒºåˆ«ï¼Ÿsynchronizedæ˜¯jvmå±‚é¢çš„å…³é”®å­—ï¼Œåº•å±‚æ˜¯é€šè¿‡monitorå¯¹è±¡æ¥å®Œæˆï¼Œmonitorå¯¹è±¡åº•å±‚ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„Mutexäº’æ–¥é‡ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„Pthreadåº“ï¼Œæ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥ç»´æŠ¤çš„ï¼Œè€Œæ“ä½œç³»ç»Ÿåˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„ï¼ŒJVMè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œè°ƒç”¨åº•å±‚æ“ä½œç³»ç»Ÿcpuä¼šè¿›è¡Œä¸€è½®çŠ¶æ€åˆ‡æ¢ï¼Œè¿™ä¸ªçŠ¶æ€åˆ‡æ¢æ˜¯æ¯”è¾ƒé‡å‹æ“ä½œï¼Œwait/notifyç­‰æ–¹æ³•ä¹Ÿä¾èµ–monitorå¯¹è±¡åªæœ‰åœ¨åŒæ­¥å—æˆ–æ–¹æ³•ä¸­æ‰èƒ½è°ƒwait/notifyç­‰æ–¹æ³•ã€‚ Lockæ˜¯å…·ä½“ç±»ï¼ˆjava.util.concurrent.Locks.Lock)æ˜¯apiå±‚é¢çš„é”ï¼Œæ˜¯ä»jdk1.5å¼€å§‹å¼•å…¥çš„ï¼Œé‚£ä¸ªæ—¶å€™synchronizedæ€§èƒ½è¿˜æ¯”è¾ƒå·®ï¼ŒReentranLockçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å½“æ—¶æ€§èƒ½å·®çš„é—®é¢˜ ä½¿ç”¨æ–¹æ³•ï¼šsynchronizedä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾é”ï¼ŒReentranLockåˆ™éœ€è¦ç”¨æˆ·æ‰‹åŠ¨é‡Šæ”¾é”(éœ€è¦lock()å’Œunlock()é…åˆtry/finallyä½¿ç”¨) ç­‰å¾…æ˜¯å¦å¯ä¸­æ–­ï¼šsynchronizedä¸å¯ä¸­æ–­ï¼Œé™¤éæŠ›å‡ºå¼‚å¸¸æˆ–è€…æ‰§è¡Œå®Œæˆï¼ŒReentranLockå¯ä¸­æ–­ è®¾ç½®è¶…æ—¶æ–¹æ³•tryLock(long timeout, timeUnit unit) lockInterruptibly()æ”¾ä»£ç å—å¿ ï¼Œè°ƒç”¨interrupt()æ–¹æ³•å¯ä¸­æ–­ åŠ é”æ˜¯å¦å…¬å¹³ï¼šsynchronizedéå…¬å¹³é”ï¼›ReentranLock ä¸¤è€…éƒ½å¯ä»¥ï¼Œé»˜è®¤éå…¬å¹³é”ï¼Œæ„é€ æ–¹æ³•ä¼ å…¥trueä¸ºå…¬å¹³é”ï¼Œfalseä¸ºéå…¬å¹³é” é”ç»‘å®šå¤šä¸ªæ¡ä»¶Conditionï¼šsynchronized æ²¡æœ‰ï¼›ReentranLock ç”¨æ¥å®ç°åˆ†ç»„å”¤é†’éœ€è¦å”¤é†’çš„çº¿ç¨‹ï¼Œå¯ä»¥ç²¾ç¡®å”¤é†’ï¼Œä¸åƒsynchronizedè¦ä¹ˆéšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œè¦ä¹ˆå…¨éƒ¨å”¤é†’ çº¿ç¨‹æ± å‚æ•°æœ‰ï¼Œæ ¸å¿ƒçº¿ç¨‹é…ç½®ï¼ŒåŸå› ï¼Ÿ corePoolSizeï¼šçº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒçº¿ç¨‹æ•° maximumPoolSizeï¼šçº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœå½“å‰é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”ç»§ç»­æäº¤ä»»åŠ¡ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ keepAliveTimeï¼šæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹å­˜æ´»è¶…æ—¶æ—¶é—´ unitï¼šæ—¶é—´å•ä½ workQueueï¼šç”¨æ¥ä¿å­˜ç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¸”ä»»åŠ¡å¿…é¡»å®ç°Runableæ¥å£ threadFactoryï¼šç”¨æ¥åˆ›å»ºæ–°çº¿ç¨‹ çº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥ï¼š( AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ç­–ç•¥ï¼›CallerRunsPolicyï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›DiscardOldestPolicyï¼šä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼›DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡) CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰ CPUå¯†é›†å‹ä¹Ÿå«è®¡ç®—å¯†é›†å‹ï¼Œåœ¨å¤šé‡ç¨‹åºç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨ä»½æ—¶é—´ç”¨æ¥åšè®¡ç®—ã€é€»è¾‘åˆ¤æ–­ç­‰CPUåŠ¨ä½œçš„ç¨‹åºç§°ä¹‹CPU boundã€‚ä¾‹å¦‚ä¸€ä¸ªè®¡ç®—åœ†å‘¨ç‡è‡³å°æ•°ç‚¹ä¸€åƒä½ä»¥ä¸‹çš„ç¨‹åºï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹å½“ä¸­ç»å¤§éƒ¨ä»½æ—¶é—´ç”¨åœ¨ä¸‰è§’å‡½æ•°å’Œå¼€æ ¹å·çš„è®¡ç®—ï¼Œä¾¿æ˜¯å±äºCPU boundçš„ç¨‹åºã€‚ çº¿ç¨‹æ•° = CPUæ ¸æ•°+1 (ç°ä»£CPUæ”¯æŒè¶…çº¿ç¨‹) IOå¯†é›†å‹ï¼ˆI/O boundï¼‰ IOå¯†é›†å‹æŒ‡çš„æ˜¯ç³»ç»Ÿçš„CPUæ€§èƒ½ç›¸å¯¹ç¡¬ç›˜ã€å†…å­˜è¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œï¼Œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPUåœ¨ç­‰I/O (ç¡¬ç›˜/å†…å­˜) çš„è¯»/å†™æ“ä½œ çº¿ç¨‹æ•° = ï¼ˆï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´+çº¿ç¨‹CPUæ—¶é—´ï¼‰/çº¿ç¨‹CPUæ—¶é—´ ï¼‰* CPUæ•°ç›® ä¸ƒã€springspringæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªç”Ÿæ€ç¯å¢ƒï¼Œåœ¨æˆ‘ä»¬çš„å¼€å‘æµç¨‹ä¸­ï¼Œæ‰€æœ‰çš„æ¡†æ¶åŸºæœ¬ä¸Šéƒ½ä¾èµ–äºspringï¼Œspringèµ·åˆ°äº†ä¸€ä¸ªIOCå®¹å™¨çš„ä½œç”¨ï¼Œç”¨æ¥æ‰¿è½½æˆ‘ä»¬æ•´ä½“çš„beanå¯¹è±¡ï¼Œå®ƒå¸®æˆ‘ä»¬å¤„ç†äº†beanå¯¹è±¡ä»åˆ›å»ºåˆ°é”€æ¯çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨springçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£çš„æ–¹å¼è¿›è¡Œç›¸å…³å¼€å‘ã€‚springæ¡†æ¶çš„å·¥ä½œä¸»è¦æµç¨‹æ˜¯ï¼Œå½“æˆ‘ä»¬ç¨‹åºå¼€å§‹å¯åŠ¨ä¹‹åï¼ŒspringæŠŠæ³¨è§£æˆ–è€…é…ç½®æ–‡ä»¶å®šä¹‰å¥½çš„beanå¯¹è±¡è½¬åŒ–æˆä¸ºBeanDefinitionranï¼Œç„¶åé€šBeanFactoryPostProcessorå®Œæˆæ•´ä¸ªçš„BeanDefinitionrançš„è§£æå’ŒåŠ è½½è¿‡ç¨‹ï¼Œç„¶åæ ¹æ®BeanDefinitionrané€šè¿‡åå°„çš„æ–¹å¼åˆ›å»ºbeanå¯¹è±¡ï¼Œç„¶åè¿›è¡Œå¯¹è±¡åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬ï¼šawareæ¥å£ç›¸å…³æ“ä½œï¼ŒBeanPostProcessoræ“ä½œï¼ŒInit-methordæ“ä½œå®Œæˆæ•´ä¸ªbeançš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¹‹åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨äº†ã€‚ Beançš„åˆå§‹åŒ–è¿‡ç¨‹ Beançš„ç”Ÿå‘½å‘¨æœŸ å¾ªç¯ä¾èµ–AOPçš„é¡ºåº spring4å’Œspring5æ˜¯ä¸ä¸€æ ·çš„ springMVCå¤„ç†è¯·æ±‚æµç¨‹ springäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶ TransactionDefinition.PROPAGATION_REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ TransactionDefinition.PROPAGATION_SUPPORTSï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡çš„è¯ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ TransactionDefinition.PROPAGATION_MANDATORYï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡æŠ›å‡ºå¼‚å¸¸ TransactionDefinition.PROPAGATION_REQUIRES_NEWï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡å¹¶æŒ‚èµ·å½“å‰äº‹åŠ¡ TransactionDefinition.PROPAGATION_NOT_SUPPORTEDï¼šä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡åˆ™å°†å½“å‰äº‹åŠ¡æŒ‚èµ· TransactionDefinition.PROPAGATION_NEVERï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿›è¡Œï¼Œå¦‚æœå­˜åœ¨äº‹åŠ¡åˆ™æŠ›å‡ºå¼‚å¸¸ TransactionDefinition.PROPAGATION_NESTEDï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œã€‚å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è¿›è¡Œä¸PROPAGATION_REQUIREDç±»ä¼¼çš„æ“ä½œã€‚ å…«ã€ç½‘ç»œç½‘ç»œä¸ƒå±‚æ¨¡å‹ ç¬¬ä¸€å±‚ï¼šç‰©ç†å±‚ ç¬¬äºŒå±‚ï¼šæ•°æ®é“¾è·¯å±‚ 802.2ã€802.3ATMã€HDLCã€FRAME RELAY ç¬¬ä¸‰å±‚ï¼šç½‘ç»œå±‚ IPã€IPXã€ARPã€APPLETALKã€ICMP ç¬¬å››å±‚ï¼šä¼ è¾“å±‚ TCPã€UDPã€SPX ç¬¬äº”å±‚ï¼šä¼šè¯å±‚ RPCã€SQLã€NFS ã€X WINDOWSã€ASP ç¬¬å…­å±‚ï¼šè¡¨ç¤ºå±‚ ASCLLã€PICTã€TIFFã€JPEGã€ MIDIã€MPEG ç¬¬ä¸ƒå±‚ï¼šåº”ç”¨å±‚ HTTP,FTP,SNMPç­‰ ç‰©ç†å±‚ï¼šç‰©ç†å±‚è´Ÿè´£æœ€åå°†ä¿¡æ¯ç¼–ç æˆç”µæµè„‰å†²æˆ–å…¶å®ƒä¿¡å·ç”¨äºç½‘ä¸Šä¼ è¾“ï¼› æ•°æ®é“¾è·¯å±‚ï¼šæ•°æ®é“¾è·¯å±‚é€šè¿‡ç‰©ç†ç½‘ç»œé“¾è·¯ô°ä¾›æ•°æ®ä¼ è¾“ã€‚ä¸åŒçš„æ•°æ®é“¾è·¯å±‚å®šä¹‰äº†ä¸åŒçš„ç½‘ç»œå’Œå è®®ç‰¹å¾,å…¶ä¸­åŒ…æ‹¬ç‰©ç†ç¼–å€ã€ç½‘ç»œæ‹“æ‰‘ç»“æ„ã€é”™è¯¯æ ¡éªŒã€æ•°æ®å¸§åºåˆ—ä»¥åŠæµæ§ã€‚å¯ä»¥ç®€å•çš„ç†è§£ä¸ºï¼šè§„å®šäº†0å’Œ1çš„åˆ†åŒ…å½¢å¼ï¼Œç¡®å®šäº†ç½‘ç»œæ•°æ®åŒ…çš„å½¢å¼ï¼› ç½‘ç»œå±‚ï¼šç½‘ç»œå±‚è´Ÿè´£åœ¨æºå’Œç»ˆç‚¹ä¹‹é—´å»ºç«‹è¿æ¥ã€‚å¯ä»¥ç†è§£ä¸ºï¼Œæ­¤å¤„éœ€è¦ç¡®å®šè®¡ç®—æœºçš„ä½ç½®ï¼Œæ€ä¹ˆç¡®å®šï¼ŸIPv4ï¼ŒIPv6ï¼ ä¼ è¾“å±‚ï¼šä¼ è¾“å±‚å‘é«˜å±‚æä¾›å¯é çš„ç«¯åˆ°ç«¯çš„ç½‘ç»œæ•°æ®æµæœåŠ¡ã€‚å¯ä»¥ç†è§£ä¸ºï¼šæ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šåœ¨ç½‘å¡æ³¨å†Œä¸€ä¸ªç«¯å£å·ï¼Œè¯¥å±‚å°±æ˜¯ç«¯å£ä¸ç«¯å£çš„é€šä¿¡ï¼å¸¸ç”¨çš„ï¼ˆTCPï¼IPï¼‰åè®®ï¼› ä¼šè¯å±‚ï¼šä¼šè¯å±‚å»ºç«‹ã€ç®¡ç†å’Œç»ˆæ­¢è¡¨ç¤ºå±‚ä¸å®ä½“ä¹‹é—´çš„é€šä¿¡ä¼šè¯ï¼›å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼ˆè‡ªåŠ¨çš„æ‰‹æœºä¿¡æ¯ã€è‡ªåŠ¨çš„ç½‘ç»œå¯»å€ï¼‰; è¡¨ç¤ºå±‚ï¼šè¡¨ç¤ºå±‚æä¾›å¤šç§åŠŸèƒ½ç”¨äºåº”ç”¨å±‚æ•°æ®ç¼–ç å’Œè½¬åŒ–,ä»¥ç¡®ä¿ä»¥ä¸€ä¸ªç³»ç»Ÿåº”ç”¨å±‚å‘é€çš„ä¿¡æ¯ å¯ä»¥è¢«å¦ä¸€ä¸ªç³»ç»Ÿåº”ç”¨å±‚è¯†åˆ«;å¯ä»¥ç†è§£ä¸ºï¼šè§£å†³ä¸åŒç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ï¼Œegï¼šLinuxä¸‹çš„QQå’ŒWindowsä¸‹çš„QQå¯ä»¥é€šä¿¡ï¼› åº”ç”¨å±‚ï¼šOSI çš„åº”ç”¨å±‚åè®®åŒ…æ‹¬æ–‡ä»¶çš„ä¼ è¾“ã€è®¿é—®åŠç®¡ç†åè®®(FTAM) ,ä»¥åŠæ–‡ä»¶è™šæ‹Ÿç»ˆç«¯åè®®(VIP)å’Œå…¬ç”¨ç®¡ç†ç³»ç»Ÿä¿¡æ¯(CMIP)ç­‰; http1.0å’Œhttp1.1åŒºåˆ«HTTP1.0æœ€æ—©åœ¨ç½‘é¡µä¸­ä½¿ç”¨æ˜¯åœ¨1996å¹´ï¼Œé‚£ä¸ªæ—¶å€™åªæ˜¯ä½¿ç”¨ä¸€äº›è¾ƒä¸ºç®€å•çš„ç½‘é¡µä¸Šå’Œç½‘ç»œè¯·æ±‚ä¸Šï¼Œè€ŒHTTP1.1åˆ™åœ¨1999å¹´æ‰å¼€å§‹å¹¿æ³›åº”ç”¨äºç°åœ¨çš„å„å¤§æµè§ˆå™¨ç½‘ç»œè¯·æ±‚ä¸­ï¼ŒåŒæ—¶HTTP1.1ä¹Ÿæ˜¯å½“å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„HTTPåè®®ã€‚ ä¸»è¦åŒºåˆ«ä¸»è¦ä½“ç°åœ¨ï¼š ç¼“å­˜å¤„ç†ï¼Œåœ¨HTTP1.0ä¸­ä¸»è¦ä½¿ç”¨headeré‡Œçš„If-Modified-Since,Expiresæ¥åšä¸ºç¼“å­˜åˆ¤æ–­çš„æ ‡å‡†ï¼ŒHTTP1.1åˆ™å¼•å…¥äº†æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ä¾‹å¦‚Entity tagï¼ŒIf-Unmodified-Since, If-Match, If-None-Matchç­‰æ›´å¤šå¯ä¾›é€‰æ‹©çš„ç¼“å­˜å¤´æ¥æ§åˆ¶ç¼“å­˜ç­–ç•¥ã€‚ å¸¦å®½ä¼˜åŒ–åŠç½‘ç»œè¿æ¥çš„ä½¿ç”¨ï¼ŒHTTP1.0ä¸­ï¼Œå­˜åœ¨ä¸€äº›æµªè´¹å¸¦å®½çš„ç°è±¡ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯åªæ˜¯éœ€è¦æŸä¸ªå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œè€ŒæœåŠ¡å™¨å´å°†æ•´ä¸ªå¯¹è±¡é€è¿‡æ¥äº†ï¼Œå¹¶ä¸”ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼ŒHTTP1.1åˆ™åœ¨è¯·æ±‚å¤´å¼•å…¥äº†rangeå¤´åŸŸï¼Œå®ƒå…è®¸åªè¯·æ±‚èµ„æºçš„æŸä¸ªéƒ¨åˆ†ï¼Œå³è¿”å›ç æ˜¯206ï¼ˆPartial Contentï¼‰ï¼Œè¿™æ ·å°±æ–¹ä¾¿äº†å¼€å‘è€…è‡ªç”±çš„é€‰æ‹©ä»¥ä¾¿äºå……åˆ†åˆ©ç”¨å¸¦å®½å’Œè¿æ¥ã€‚ é”™è¯¯é€šçŸ¥çš„ç®¡ç†ï¼Œåœ¨HTTP1.1ä¸­æ–°å¢äº†24ä¸ªé”™è¯¯çŠ¶æ€å“åº”ç ï¼Œå¦‚409ï¼ˆConflictï¼‰è¡¨ç¤ºè¯·æ±‚çš„èµ„æºä¸èµ„æºçš„å½“å‰çŠ¶æ€å‘ç”Ÿå†²çªï¼›410ï¼ˆGoneï¼‰è¡¨ç¤ºæœåŠ¡å™¨ä¸Šçš„æŸä¸ªèµ„æºè¢«æ°¸ä¹…æ€§çš„åˆ é™¤ã€‚ Hostå¤´å¤„ç†ï¼Œåœ¨HTTP1.0ä¸­è®¤ä¸ºæ¯å°æœåŠ¡å™¨éƒ½ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ï¼Œå› æ­¤ï¼Œè¯·æ±‚æ¶ˆæ¯ä¸­çš„URLå¹¶æ²¡æœ‰ä¼ é€’ä¸»æœºåï¼ˆhostnameï¼‰ã€‚ä½†éšç€è™šæ‹Ÿä¸»æœºæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼ˆMulti-homed Web Serversï¼‰ï¼Œå¹¶ä¸”å®ƒä»¬å…±äº«ä¸€ä¸ªIPåœ°å€ã€‚HTTP1.1çš„è¯·æ±‚æ¶ˆæ¯å’Œå“åº”æ¶ˆæ¯éƒ½åº”æ”¯æŒHostå¤´åŸŸï¼Œä¸”è¯·æ±‚æ¶ˆæ¯ä¸­å¦‚æœæ²¡æœ‰Hostå¤´åŸŸä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼ˆ400 Bad Requestï¼‰ã€‚ é•¿è¿æ¥ï¼ŒHTTP 1.1æ”¯æŒé•¿è¿æ¥ï¼ˆPersistentConnectionï¼‰å’Œè¯·æ±‚çš„æµæ°´çº¿ï¼ˆPipeliningï¼‰å¤„ç†ï¼Œåœ¨ä¸€ä¸ªTCPè¿æ¥ä¸Šå¯ä»¥ä¼ é€å¤šä¸ªHTTPè¯·æ±‚å’Œå“åº”ï¼Œå‡å°‘äº†å»ºç«‹å’Œå…³é—­è¿æ¥çš„æ¶ˆè€—å’Œå»¶è¿Ÿï¼Œåœ¨HTTP1.1ä¸­é»˜è®¤å¼€å¯Connectionï¼š keep-aliveï¼Œä¸€å®šç¨‹åº¦ä¸Šå¼¥è¡¥äº†HTTP1.0æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ›å»ºè¿æ¥çš„ç¼ºç‚¹ã€‚ HTTPSä¸HTTPçš„ä¸€äº›åŒºåˆ« HTTPSåè®®éœ€è¦åˆ°CAç”³è¯·è¯ä¹¦ï¼Œä¸€èˆ¬å…è´¹è¯ä¹¦å¾ˆå°‘ï¼Œéœ€è¦äº¤è´¹ã€‚ HTTPåè®®è¿è¡Œåœ¨TCPä¹‹ä¸Šï¼Œæ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½æ˜¯æ˜æ–‡ï¼ŒHTTPSè¿è¡Œåœ¨SSL/TLSä¹‹ä¸Šï¼ŒSSL/TLSè¿è¡Œåœ¨TCPä¹‹ä¸Šï¼Œæ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½ç»è¿‡åŠ å¯†çš„ã€‚ HTTPå’ŒHTTPSä½¿ç”¨çš„æ˜¯å®Œå…¨ä¸åŒçš„è¿æ¥æ–¹å¼ï¼Œç”¨çš„ç«¯å£ä¹Ÿä¸ä¸€æ ·ï¼Œå‰è€…æ˜¯80ï¼Œåè€…æ˜¯443ã€‚ HTTPSå¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢è¿è¥å•†åŠ«æŒï¼Œè§£å†³äº†é˜²åŠ«æŒçš„ä¸€ä¸ªå¤§é—®é¢˜ã€‚ httpä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹å…¶å®è¿™ä¹ˆè¯´æ˜¯ä¸å¤ªå‡†ç¡®çš„ï¼Œåº”è¯¥è¯´æ˜¯tcpåè®®å»ºç«‹è¿æ¥è¦3æ¬¡æ¡æ‰‹ï¼Œæ–­å¼€è¿æ¥è¦4æ¬¡æŒ¥æ‰‹ï¼Œè€Œhttpæ˜¯åŸºäºtcpåè®®çš„ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬ä¹Ÿè¿™ä¹ˆè¯´ï¼Œtcpå¯ä»¥æä¾›å…¨åŒå·¥çš„æ•°æ®æµä¼ è¾“æœåŠ¡ ä¸‰æ¬¡æ¡æ‰‹ TCPæœåŠ¡å™¨è¿›ç¨‹å…ˆåˆ›å»ºä¼ è¾“æ§åˆ¶å—TCBï¼Œæ—¶åˆ»å‡†å¤‡æ¥å—å®¢æˆ·è¿›ç¨‹çš„è¿æ¥è¯·æ±‚ï¼Œæ­¤æ—¶æœåŠ¡å™¨å°±è¿›å…¥äº†LISTENï¼ˆç›‘å¬ï¼‰çŠ¶æ€ï¼› TCPå®¢æˆ·è¿›ç¨‹ä¹Ÿæ˜¯å…ˆåˆ›å»ºä¼ è¾“æ§åˆ¶å—TCBï¼Œç„¶åå‘æœåŠ¡å™¨å‘å‡ºè¿æ¥è¯·æ±‚æŠ¥æ–‡ï¼Œè¿™æ˜¯æŠ¥æ–‡é¦–éƒ¨ä¸­çš„åŒéƒ¨ä½SYN=1ï¼ŒåŒæ—¶é€‰æ‹©ä¸€ä¸ªåˆå§‹åºåˆ—å· seq=x ï¼Œæ­¤æ—¶ï¼ŒTCPå®¢æˆ·ç«¯è¿›ç¨‹è¿›å…¥äº† SYN-SENTï¼ˆåŒæ­¥å·²å‘é€çŠ¶æ€ï¼‰çŠ¶æ€ã€‚TCPè§„å®šï¼ŒSYNæŠ¥æ–‡æ®µï¼ˆSYN=1çš„æŠ¥æ–‡æ®µï¼‰ä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†éœ€è¦æ¶ˆè€—æ‰ä¸€ä¸ªåºå·ã€‚ TCPæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æŠ¥æ–‡åï¼Œå¦‚æœåŒæ„è¿æ¥ï¼Œåˆ™å‘å‡ºç¡®è®¤æŠ¥æ–‡ã€‚ç¡®è®¤æŠ¥æ–‡ä¸­åº”è¯¥ ACK=1ï¼ŒSYN=1ï¼Œç¡®è®¤å·æ˜¯ack=x+1ï¼ŒåŒæ—¶ä¹Ÿè¦ä¸ºè‡ªå·±åˆå§‹åŒ–ä¸€ä¸ªåºåˆ—å· seq=yï¼Œæ­¤æ—¶ï¼ŒTCPæœåŠ¡å™¨è¿›ç¨‹è¿›å…¥äº†SYN-RCVDï¼ˆåŒæ­¥æ”¶åˆ°ï¼‰çŠ¶æ€ã€‚è¿™ä¸ªæŠ¥æ–‡ä¹Ÿä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†æ˜¯åŒæ ·è¦æ¶ˆè€—ä¸€ä¸ªåºå·ã€‚ TCPå®¢æˆ·è¿›ç¨‹æ”¶åˆ°ç¡®è®¤åï¼Œè¿˜è¦å‘æœåŠ¡å™¨ç»™å‡ºç¡®è®¤ã€‚ç¡®è®¤æŠ¥æ–‡çš„ACK=1ï¼Œack=y+1ï¼Œè‡ªå·±çš„åºåˆ—å·seq=x+1ï¼Œæ­¤æ—¶ï¼ŒTCPè¿æ¥å»ºç«‹ï¼Œå®¢æˆ·ç«¯è¿›å…¥ESTABLISHEDï¼ˆå·²å»ºç«‹è¿æ¥ï¼‰çŠ¶æ€ã€‚TCPè§„å®šï¼ŒACKæŠ¥æ–‡æ®µå¯ä»¥æºå¸¦æ•°æ®ï¼Œä½†æ˜¯å¦‚æœä¸æºå¸¦æ•°æ®åˆ™ä¸æ¶ˆè€—åºå·ã€‚ å½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ç¡®è®¤åä¹Ÿè¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œæ­¤ååŒæ–¹å°±å¯ä»¥å¼€å§‹é€šä¿¡äº†ã€‚ å››æ¬¡æŒ¥æ‰‹ä¹ã€è®¾è®¡æ¨¡å¼åã€Dubboä½ çŸ¥é“çš„jsonåºåˆ—åŒ–æ–¹å¼ï¼Ÿ è°·æ­Œçš„Gson json-smartï¼šå·ç§°æ˜¯é€Ÿåº¦æœ€å¿«çš„JSONè§£æå™¨ Common Lang3(3.1)çš„SerializationUtils é˜¿é‡Œå·´å·´çš„ FastJsonã€ä»¥åŠ Jackson ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´æ€ä¹ˆäº¤äº’çš„ï¼Ÿ å¥—æ¥å­—ï¼ˆsocketï¼‰ï¼šè¿™æ˜¯ä¸€ç§æ›´ä¸ºä¸€èˆ¬å¾—è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå®ƒå¯ç”¨äºç½‘ç»œä¸­ä¸åŒæœºå™¨ä¹‹é—´çš„è¿›ç¨‹é—´é€šä¿¡ï¼Œåº”ç”¨éå¸¸å¹¿æ³›ã€‚ å¯ä»¥é€šè¿‡RPCæ¡†æ¶ï¼ˆdubboã€feignç­‰ï¼‰è¿›è¡Œè¿œç¨‹è°ƒç”¨ ä¹Ÿå¯ä»¥å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ç­‰æ¶ˆæ¯ä¸­é—´ä»¶ä½œä¸ºç³»ç»Ÿä¹‹é—´ä¿¡æ¯äº¤äº’çš„æ¡¥æ¢ å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰ï¼šå¯ä»¥è¯´è¿™æ˜¯æœ€æœ‰ç”¨çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ã€‚å®ƒä½¿å¾—å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹å¯ä»¥åŠæ—¶çœ‹åˆ°å¯¹æ–¹è¿›ç¨‹ä¸­å¯¹å…±äº«å†…å­˜ä¸­æ•°æ®å¾—æ›´ dubboçš„åºåˆ—åŒ–ï¼Ÿdubbo æ”¯æŒ hessionã€Java äºŒè¿›åˆ¶åºåˆ—åŒ–ã€jsonã€SOAP æ–‡æœ¬åºåˆ—åŒ–å¤šç§åºåˆ—åŒ–åè®®ã€‚ hessian æ˜¯å…¶é»˜è®¤çš„åºåˆ—åŒ–åè®® dubbo æä¾›è€…(Provider)å¯åŠ¨æ—¶ï¼Œä¼šå‘æ³¨å†Œä¸­å¿ƒå†™å…¥è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯(è°ƒç”¨æ–¹å¼)ã€‚ æ¶ˆè´¹è€…(Consumer)å¯åŠ¨æ—¶ï¼Œä¹Ÿä¼šåœ¨æ³¨å†Œä¸­å¿ƒå†™å…¥è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¹¶ä¸”è®¢é˜…æœåŠ¡æä¾›è€…ï¼Œè·¯ç”±å’Œé…ç½®å…ƒæ•°æ®çš„ä¿¡æ¯ã€‚ æœåŠ¡æ²»ç†ä¸­å¿ƒ(duubo-admin)å¯åŠ¨æ—¶ï¼Œä¼šåŒæ—¶è®¢é˜…æ‰€æœ‰æ¶ˆè´¹è€…ï¼Œæä¾›è€…ï¼Œè·¯ç”±å’Œé…ç½®å…ƒæ•°æ®çš„ä¿¡æ¯ã€‚ å½“æä¾›è€…ç¦»å¼€æˆ–è€…æ–°æä¾›è€…åŠ å…¥æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒå‘ç°å˜åŒ–ä¼šé€šçŸ¥æ¶ˆè´¹è€…å’ŒæœåŠ¡æ²»ç†ä¸­å¿ƒã€‚ åä¸€ã€NettyNIOä¸‰å¤§æ ¸å¿ƒç»„ä»¶ Channel(é€šé“)ï¼Œ Buffer(ç¼“å†²åŒº)ï¼ŒSelector(å¤šè·¯å¤ç”¨å™¨) channel ç±»ä¼¼äºæµï¼Œæ¯ä¸ª channel å¯¹åº”ä¸€ä¸ª bufferç¼“å†²åŒºï¼Œbuffer åº•å±‚å°±æ˜¯ä¸ªæ•°ç»„ channel ä¼šæ³¨å†Œåˆ° selector ä¸Šï¼Œç”± selector æ ¹æ® channel è¯»å†™äº‹ä»¶çš„å‘ç”Ÿå°†å…¶äº¤ç”±æŸä¸ªç©ºé—²çš„çº¿ç¨‹å¤„ç† NIO çš„ Buffer å’Œ channel éƒ½æ˜¯æ—¢å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ Nettyçº¿ç¨‹æ¨¡å‹Nettyé€šè¿‡Reactoræ¨¡å‹åŸºäºå¤šè·¯å¤ç”¨å™¨æ¥æ”¶å¹¶å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå†…éƒ¨å®ç°bosså’Œworkä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œå…¶ä¸­bossçš„çº¿ç¨‹è´Ÿè´£å¤„ç†è¯·æ±‚çš„acceptäº‹ä»¶ï¼Œå½“æ¥æ”¶åˆ°acceptäº‹ä»¶çš„è¯·æ±‚æ—¶ï¼ŒæŠŠå¯¹åº”çš„socketå°è£…åˆ°ä¸€ä¸ªNioSocketChannelä¸­ï¼Œå¹¶äº¤ç»™workçº¿ç¨‹æ± ï¼Œå…¶ä¸­workçº¿ç¨‹æ± è´Ÿè´£è¯·æ±‚çš„readå’Œwriteäº‹ä»¶ï¼Œäº¤ç”±å¯¹åº”çš„Handlerå¤„ç†ã€‚ Netty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± BossGroupå’ŒWorkerGroupï¼ŒBossGroupä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥, WorkerGroupä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™ BossGroupå’ŒWorkerGroupç±»å‹éƒ½æ˜¯NioEventLoopGroup NioEventLoopGroup ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹ç»„, è¿™ä¸ªç»„ä¸­å«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹ ï¼Œ æ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹æ˜¯NioEventLoop æ¯ä¸ªNioEventLoopéƒ½æœ‰ä¸€ä¸ªselector , ç”¨äºç›‘å¬æ³¨å†Œåœ¨å…¶ä¸Šçš„socketChannelçš„ç½‘ç»œé€šè®¯ æ¯ä¸ªBossNioEventLoopçº¿ç¨‹å†…éƒ¨å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤æœ‰ 3 æ­¥ å¤„ç†acceptäº‹ä»¶ , ä¸client å»ºç«‹è¿æ¥ , ç”Ÿæˆ NioSocketChannel å°†NioSocketChannelæ³¨å†Œåˆ°æŸä¸ªworker NIOEventLoopä¸Šçš„selector å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ ï¼Œ å³runAllTasks æ¯ä¸ªworkerNIOEventLoopçº¿ç¨‹å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ è½®è¯¢æ³¨å†Œåˆ°è‡ªå·±selectorä¸Šçš„æ‰€æœ‰NioSocketChannel çš„read, writeäº‹ä»¶ å¤„ç† I/O äº‹ä»¶ï¼Œ å³read , write äº‹ä»¶ï¼Œ åœ¨å¯¹åº”NioSocketChannel å¤„ç†ä¸šåŠ¡ runAllTaskså¤„ç†ä»»åŠ¡é˜Ÿåˆ—TaskQueueçš„ä»»åŠ¡ ï¼Œä¸€äº›è€—æ—¶çš„ä¸šåŠ¡å¤„ç†ä¸€èˆ¬å¯ä»¥æ”¾å…¥TaskQueueä¸­æ…¢æ…¢å¤„ç†ï¼Œè¿™æ ·ä¸å½±å“æ•°æ®åœ¨ pipeline ä¸­çš„æµåŠ¨å¤„ç† Nettyæ¨¡å—ç»„ä»¶ Bootstrapã€ServerBootstrapï¼šBootstrap æ„æ€æ˜¯å¼•å¯¼ï¼Œä¸€ä¸ª Netty åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª Bootstrap å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª Netty ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶ï¼ŒNetty ä¸­ Bootstrap ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼ŒServerBootstrap æ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»ã€‚ Futureã€ChannelFutureï¼šæ­£å¦‚å‰é¢ä»‹ç»ï¼Œåœ¨ Netty ä¸­æ‰€æœ‰çš„ IO æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡ Future å’Œ ChannelFuturesï¼Œä»–ä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶ã€‚ Channelï¼šNetty ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œ I/O æ“ä½œã€‚Channel ä¸ºç”¨æˆ·æä¾›ï¼š å½“å‰ç½‘ç»œè¿æ¥çš„é€šé“çš„çŠ¶æ€ï¼ˆä¾‹å¦‚æ˜¯å¦æ‰“å¼€ï¼Ÿæ˜¯å¦å·²è¿æ¥ï¼Ÿï¼‰ ç½‘ç»œè¿æ¥çš„é…ç½®å‚æ•° ï¼ˆä¾‹å¦‚æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼‰ æä¾›å¼‚æ­¥çš„ç½‘ç»œ I/O æ“ä½œ(å¦‚å»ºç«‹è¿æ¥ï¼Œè¯»å†™ï¼Œç»‘å®šç«¯å£)ï¼Œå¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½• I/O è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œå¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨ç»“æŸæ—¶æ‰€è¯·æ±‚çš„ I/O æ“ä½œå·²å®Œæˆã€‚ è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª ChannelFuture å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œç›‘å¬å™¨åˆ° ChannelFuture ä¸Šï¼Œå¯ä»¥ I/O æ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹ã€‚ æ”¯æŒå…³è” I/O æ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åºã€‚ ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„ Channel ç±»å‹ä¸ä¹‹å¯¹åº”ã€‚ NioSocketChannelï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ TCP Socket è¿æ¥ã€‚ NioServerSocketChannelï¼Œå¼‚æ­¥çš„æœåŠ¡å™¨ç«¯ TCP Socket è¿æ¥ã€‚ NioDatagramChannelï¼Œå¼‚æ­¥çš„ UDP è¿æ¥ã€‚ NioSctpChannelï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ Sctp è¿æ¥ã€‚ NioSctpServerChannelï¼Œå¼‚æ­¥çš„ Sctp æœåŠ¡å™¨ç«¯è¿æ¥ã€‚ è¿™äº›é€šé“æ¶µç›–äº† UDP å’Œ TCP ç½‘ç»œ IO ä»¥åŠæ–‡ä»¶ IOã€‚ Selectorï¼šNetty åŸºäº Selector å¯¹è±¡å®ç° I/O å¤šè·¯å¤ç”¨ï¼Œé€šè¿‡ Selector ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„ Channel äº‹ä»¶ã€‚å½“å‘ä¸€ä¸ª Selector ä¸­æ³¨å†Œ Channel åï¼ŒSelector å†…éƒ¨çš„æœºåˆ¶å°±å¯ä»¥è‡ªåŠ¨ä¸æ–­åœ°æŸ¥è¯¢(Select) è¿™äº›æ³¨å†Œçš„ Channel æ˜¯å¦æœ‰å·²å°±ç»ªçš„ I/O äº‹ä»¶ï¼ˆä¾‹å¦‚å¯è¯»ï¼Œå¯å†™ï¼Œç½‘ç»œè¿æ¥å®Œæˆç­‰ï¼‰ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª Channel ã€‚ NioEventLoopï¼šNioEventLoop ä¸­ç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒå¼‚æ­¥æäº¤æ‰§è¡Œä»»åŠ¡ï¼Œçº¿ç¨‹å¯åŠ¨æ—¶ä¼šè°ƒç”¨ NioEventLoop çš„ run æ–¹æ³•ï¼Œæ‰§è¡Œ I/O ä»»åŠ¡å’Œé I/O ä»»åŠ¡ï¼šI/O ä»»åŠ¡ï¼Œå³ selectionKey ä¸­ ready çš„äº‹ä»¶ï¼Œå¦‚ acceptã€connectã€readã€write ç­‰ï¼Œç”± processSelectedKeys æ–¹æ³•è§¦å‘ã€‚é IO ä»»åŠ¡ï¼Œæ·»åŠ åˆ° taskQueue ä¸­çš„ä»»åŠ¡ï¼Œå¦‚ register0ã€bind0 ç­‰ä»»åŠ¡ï¼Œç”± runAllTasks æ–¹æ³•è§¦å‘ã€‚ NioEventLoopGroupï¼šNioEventLoopGroupï¼Œä¸»è¦ç®¡ç† eventLoop çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ç»„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹(NioEventLoop)è´Ÿè´£å¤„ç†å¤šä¸ª Channel ä¸Šçš„äº‹ä»¶ï¼Œè€Œä¸€ä¸ª Channel åªå¯¹åº”äºä¸€ä¸ªçº¿ç¨‹ã€‚ ChannelHandlerï¼šChannelHandler æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¤„ç† I/O äº‹ä»¶æˆ–æ‹¦æˆª I/O æ“ä½œï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å…¶ ChannelPipeline(ä¸šåŠ¡å¤„ç†é“¾)ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚ ChannelHandlerContextï¼šä¿å­˜ Channel ç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒæ—¶å…³è”ä¸€ä¸ª ChannelHandler å¯¹è±¡ã€‚ ChannelPiplineï¼šä¿å­˜ ChannelHandler çš„ Listï¼Œç”¨äºå¤„ç†æˆ–æ‹¦æˆª Channel çš„å…¥ç«™äº‹ä»¶å’Œå‡ºç«™æ“ä½œã€‚ChannelPipeline å®ç°äº†ä¸€ç§é«˜çº§å½¢å¼çš„æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠ Channel ä¸­å„ä¸ªçš„ ChannelHandler å¦‚ä½•ç›¸äº’äº¤äº’ã€‚åœ¨ Netty ä¸­æ¯ä¸ª Channel éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ChannelPipeline ä¸ä¹‹å¯¹åº”ï¼Œå®ƒä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹ï¼š ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipelineï¼Œè€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­åˆå…³è”ç€ä¸€ä¸ª ChannelHandlerã€‚readäº‹ä»¶(å…¥ç«™äº‹ä»¶)å’Œwriteäº‹ä»¶(å‡ºç«™äº‹ä»¶)åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œå…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨ head å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„ handlerï¼Œå‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨ tail å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„ handlerï¼Œä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰°ã€‚ Nettyç²˜åŒ…æ‹†åŒ…TCPæ˜¯ä¸€ä¸ªæµåè®®ï¼Œå°±æ˜¯æ²¡æœ‰ç•Œé™çš„ä¸€é•¿ä¸²äºŒè¿›åˆ¶æ•°æ®ã€‚TCPä½œä¸ºä¼ è¾“å±‚åè®®å¹¶ä¸ä¸äº†è§£ä¸Šå±‚ä¸šåŠ¡æ•°æ®çš„å…·ä½“å«ä¹‰ï¼Œå®ƒä¼šæ ¹æ®TCPç¼“å†²åŒºçš„å®é™…æƒ…å†µè¿›è¡Œæ•°æ®åŒ…çš„åˆ’åˆ†ï¼Œæ‰€ä»¥åœ¨ä¸šåŠ¡ä¸Šè®¤ä¸ºæ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ…ï¼Œå¯èƒ½ä¼šè¢«TCPæ‹†åˆ†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ï¼Œä¹Ÿæœ‰å¯èƒ½æŠŠå¤šä¸ªå°çš„åŒ…å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„TCPç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜ã€‚é¢å‘æµçš„é€šä¿¡æ˜¯æ— æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œçš„ã€‚ è§£å†³æ–¹æ¡ˆ æ¶ˆæ¯å®šé•¿åº¦ï¼Œä¼ è¾“çš„æ•°æ®å¤§å°å›ºå®šé•¿åº¦ï¼Œä¾‹å¦‚æ¯æ®µçš„é•¿åº¦å›ºå®šä¸º100å­—èŠ‚ï¼Œå¦‚æœä¸å¤Ÿç©ºä½è¡¥ç©ºæ ¼ åœ¨æ•°æ®åŒ…å°¾éƒ¨æ·»åŠ ç‰¹æ®Šåˆ†éš”ç¬¦ï¼Œæ¯”å¦‚ä¸‹åˆ’çº¿ï¼Œä¸­åˆ’çº¿ç­‰ï¼Œè¿™ç§æ–¹æ³•ç®€å•æ˜“è¡Œï¼Œä½†é€‰æ‹©åˆ†éš”ç¬¦çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„æ¯æ¡æ•°æ®çš„å†…éƒ¨ä¸€å®šä¸èƒ½å‡ºç°åˆ†éš”ç¬¦ã€‚ å‘é€é•¿åº¦ï¼šå‘é€æ¯æ¡æ•°æ®çš„æ—¶å€™ï¼Œå°†æ•°æ®çš„é•¿åº¦ä¸€å¹¶å‘é€ï¼Œæ¯”å¦‚å¯ä»¥é€‰æ‹©æ¯æ¡æ•°æ®çš„å‰4ä½æ˜¯æ•°æ®çš„é•¿åº¦ï¼Œåº”ç”¨å±‚å¤„ç†æ—¶å¯ä»¥æ ¹æ®é•¿åº¦æ¥åˆ¤æ–­æ¯æ¡æ•°æ®çš„å¼€å§‹å’Œç»“æŸã€‚ Nettyæä¾›äº†å¤šä¸ªè§£ç å™¨ï¼Œå¯ä»¥è¿›è¡Œåˆ†åŒ…çš„æ“ä½œï¼Œå¦‚ä¸‹ï¼š LineBasedFrameDecoder ï¼ˆå›è½¦æ¢è¡Œåˆ†åŒ…ï¼‰ DelimiterBasedFrameDecoderï¼ˆç‰¹æ®Šåˆ†éš”ç¬¦åˆ†åŒ…ï¼‰ FixedLengthFrameDecoderï¼ˆå›ºå®šé•¿åº¦æŠ¥æ–‡æ¥åˆ†åŒ…ï¼‰ åäºŒã€zookeeperzookeeperçš„ç†è§£ é›†ç¾¤ç®¡ç†ï¼šæä¾›äº†CPæ¨¡å‹æ¥ä¿è¯é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ åˆ†å¸ƒå¼é” é›†ç¾¤é€‰ä¸¾ zookeeperé€‰ä¸¾æœºåˆ¶ LeaderElection AuthFastLeaderElection FastLeaderElection ï¼ˆæœ€æ–°é»˜è®¤ï¼‰ ç›®å‰æœ‰5å°æœåŠ¡å™¨ï¼Œæ¯å°æœåŠ¡å™¨å‡æ²¡æœ‰æ•°æ®ï¼Œå®ƒä»¬çš„ç¼–å·åˆ†åˆ«æ˜¯1,2,3,4,5,æŒ‰ç¼–å·ä¾æ¬¡å¯åŠ¨ï¼Œå®ƒä»¬çš„é€‰æ‹©ä¸¾è¿‡ç¨‹å¦‚ä¸‹ï¼š æœåŠ¡å™¨1å¯åŠ¨ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼Œç„¶åå‘æŠ•ç¥¨ä¿¡æ¯ï¼Œç”±äºå…¶å®ƒæœºå™¨è¿˜æ²¡æœ‰å¯åŠ¨æ‰€ä»¥å®ƒæ”¶ä¸åˆ°åé¦ˆä¿¡æ¯ï¼ŒæœåŠ¡å™¨1çš„çŠ¶æ€ä¸€ç›´å±äºLooking(é€‰ä¸¾çŠ¶æ€)ã€‚ æœåŠ¡å™¨2å¯åŠ¨ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼ŒåŒæ—¶ä¸ä¹‹å‰å¯åŠ¨çš„æœåŠ¡å™¨1äº¤æ¢ç»“æœï¼Œç”±äºæœåŠ¡å™¨2çš„ç¼–å·å¤§æ‰€ä»¥æœåŠ¡å™¨2èƒœå‡ºï¼Œä½†æ­¤æ—¶æŠ•ç¥¨æ•°æ²¡æœ‰å¤§äºåŠæ•°ï¼Œæ‰€ä»¥ä¸¤ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€ä¾ç„¶æ˜¯LOOKINGã€‚ æœåŠ¡å™¨3å¯åŠ¨ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼ŒåŒæ—¶ä¸ä¹‹å‰å¯åŠ¨çš„æœåŠ¡å™¨1,2äº¤æ¢ä¿¡æ¯ï¼Œç”±äºæœåŠ¡å™¨3çš„ç¼–å·æœ€å¤§æ‰€ä»¥æœåŠ¡å™¨3èƒœå‡ºï¼Œæ­¤æ—¶æŠ•ç¥¨æ•°æ­£å¥½å¤§äºåŠæ•°ï¼Œæ‰€ä»¥æœåŠ¡å™¨3æˆä¸ºé¢†å¯¼è€…ï¼ŒæœåŠ¡å™¨1,2æˆä¸ºå°å¼Ÿã€‚ æœåŠ¡å™¨4å¯åŠ¨ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼ŒåŒæ—¶ä¸ä¹‹å‰å¯åŠ¨çš„æœåŠ¡å™¨1,2,3äº¤æ¢ä¿¡æ¯ï¼Œå°½ç®¡æœåŠ¡å™¨4çš„ç¼–å·å¤§ï¼Œä½†ä¹‹å‰æœåŠ¡å™¨3å·²ç»èƒœå‡ºï¼Œæ‰€ä»¥æœåŠ¡å™¨4åªèƒ½æˆä¸ºå°å¼Ÿã€‚ æœåŠ¡å™¨5å¯åŠ¨ï¼Œåé¢çš„é€»è¾‘åŒæœåŠ¡å™¨4æˆä¸ºå°å¼Ÿã€‚ åä¸‰ã€ç†è®ºCAPç†è®ºâ€‹ CAP ç†è®ºåˆå« Brewer ç†è®ºï¼Œè¿™æ˜¯åŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„åŸƒé‡Œå…‹ Â· å¸ƒé²å°”ï¼ˆEric Brewerï¼‰æ•™æˆï¼Œåœ¨ 2000 å¹´ 7 æœˆâ€œACM åˆ†å¸ƒå¼è®¡ç®—åŸç†ç ”è®¨ä¼šï¼ˆPODCï¼‰â€ä¸Šæå‡ºçš„ä¸€ä¸ªçŒœæƒ³ã€‚CAPç†è®ºåŸç¨¿ï¼ˆé‚£æ—¶å€™è¿˜åªæ˜¯çŒœæƒ³ï¼‰ç„¶ååˆ°äº† 2002 å¹´ï¼Œéº»çœç†å·¥å­¦é™¢çš„èµ›æ–¯ Â· å‰å°”ä¼¯ç‰¹ï¼ˆSeth Gilbertï¼‰å’Œå—å¸Œ Â· æ—å¥‡ï¼ˆNancy Lynchï¼‰å°±ä»¥ä¸¥è°¨çš„æ•°å­¦æ¨ç†è¯æ˜äº†è¿™ä¸ª CAP çŒœæƒ³ã€‚åœ¨è¿™ä¹‹åï¼ŒCAP ç†è®ºå°±æ­£å¼æˆä¸ºäº†åˆ†å¸ƒå¼è®¡ç®—é¢†åŸŸå…¬è®¤çš„è‘—åå®šç†ã€‚è¿™ä¸ªå®šç†é‡Œï¼Œæè¿°äº†ä¸€ä¸ªåˆ†å¸ƒå¼çš„ç³»ç»Ÿä¸­ï¼Œå½“æ¶‰åŠåˆ°å…±äº«æ•°æ®é—®é¢˜æ—¶ï¼Œä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§æœ€å¤šåªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ªï¼š ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šä»£è¡¨åœ¨ä»»ä½•æ—¶åˆ»ã€ä»»ä½•åˆ†å¸ƒå¼èŠ‚ç‚¹ä¸­ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„æ•°æ®éƒ½æ˜¯æ²¡æœ‰çŸ›ç›¾çš„ã€‚è¿™ä¸ ACID ä¸­çš„ C æ˜¯ç›¸åŒçš„å•è¯ï¼Œä½†å®ƒä»¬åˆæœ‰ä¸åŒçš„å®šä¹‰ï¼ˆåˆ†åˆ«æŒ‡ Replication çš„ä¸€è‡´æ€§å’Œæ•°æ®åº“çŠ¶æ€çš„ä¸€è‡´æ€§ï¼‰ã€‚åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼ŒACID çš„ C è¦ä»¥æ»¡è¶³ CAP ä¸­çš„ C ä¸ºå‰æã€‚ å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ï¼šä»£è¡¨ç³»ç»Ÿä¸é—´æ–­åœ°æä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚ åˆ†åŒºå®¹å¿æ€§ï¼ˆPartition Toleranceï¼‰ï¼šä»£è¡¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå½“éƒ¨åˆ†èŠ‚ç‚¹å› ç½‘ç»œåŸå› è€Œå½¼æ­¤å¤±è”ï¼ˆå³ä¸å…¶ä»–èŠ‚ç‚¹å½¢æˆâ€œç½‘ç»œåˆ†åŒºâ€ï¼‰æ—¶ï¼Œç³»ç»Ÿä»èƒ½æ­£ç¡®åœ°æä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚ https://mp.weixin.qq.com/s?__biz=MzU3MTQwNDEyMg==&amp;mid=2247483680&amp;idx=1&amp;sn=a844dc83df3316ac0102ea11511b8b46&amp;chksm=fce1fb15cb9672032e98857a74f4e971a1ff833a6e353cafee655587c70a93e730a652daf5a2&amp;scene=21#wechat_redirect DDDdddä¸æ˜¯ä¸€ç§æ¶æ„é£æ ¼ï¼Œè€Œæ˜¯ä¸€ç§æ–¹æ³•è®ºï¼Œä»€ä¹ˆæ˜¯æ–¹æ³•è®ºï¼Œæ¯ä¸ªäººæŒ‰ç…§è‡ªå·±çš„æƒ³æ³•æ¥è®¾è®¡å°±æ˜¯ä¸€å¥—æ–¹æ³•è®ºï¼›dddæ˜¯ä¸€ç§ä¸šåŠ¡æ¯”è¾ƒè®¤å¯ï¼Œå¯¹äºå¾®æœåŠ¡æ‹†åˆ†çš„ä¸€ç§æ–¹æ³•è®ºã€‚ åå››ã€é¡¹ç›® æœ€è¿‘åšçš„æ¯”è¾ƒç†Ÿæ‚‰çš„é¡¹ç›®æ˜¯å“ªä¸ªï¼Ÿç”»ä¸€ä¸‹é¡¹ç›®æŠ€æœ¯æ¶æ„å›¾ å†™ä¸¤ä¸ªç±»ï¼Œèƒ½å¤Ÿå®ç°å †å†…å­˜æº¢å‡ºå’Œæ ˆå†…å­˜æº¢å‡º å†™ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å•ä¾‹ã€‚ ä¸¤ä¸ªå¯å˜æœ‰åºé“¾è¡¨æ”¾åˆ°æ–°æ•°ç»„ä¸­ï¼Œæœ‰åº ESç®€ä»‹ESä»–æ˜¯å»ºç«‹åœ¨å…¨æ–‡æœç´¢å¼•æ“åº“ApacheLuceneåŸºç¡€ä¸Šçš„ä¸€ä¸ªå¼€æºæœç´¢å’Œåˆ†æå¼•æ“ï¼ŒESæœ¬èº«å…·æœ‰ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ï¼Œæ£€ç´¢é€Ÿåº¦å¿«çš„ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸ç”¨å®ƒå»å®ç°å…¨æ–‡æ£€ç´¢è¿™ä¸€ç±»çš„åœºæ™¯ï¼Œæ¯”å¦‚åƒç½‘ç«™æœç´¢ï¼Œå…¬å¸å†…éƒ¨ç”¨ELKåšæ—¥å¿—èšé›†å’Œæ£€ç´¢ï¼Œæ¥å»å¿«é€ŸæŸ¥æ‰¾æœåŠ¡å™¨çš„æ—¥å¿—è®°å½•ï¼Œå»å®šä½é—®é¢˜ï¼ŒåŸºæœ¬ä¸Šæ¶‰åŠåˆ°TBçº§åˆ«çš„æ•°æ®åœºæ™¯ï¼Œç”¨ESæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹© ESæŸ¥è¯¢å¿«çš„åŸå›  ç¬¬ä¸€ã€Luceneæ˜¯æ“…é•¿ç®¡ç†å¤§é‡çš„ç´¢å¼•æ•°æ®çš„ï¼Œå¦ä¸€æ–¹é¢ä»–ä¼šå¯¹æ•°æ®è¿›è¡Œåˆ†è¯ä»¥ååœ¨ä¿å­˜ç´¢å¼•ï¼Œè¿™æ ·èƒ½ææå‡æ•°æ®çš„æ£€ç´¢æ•ˆç‡ ç¬¬äºŒã€ESé‡‡ç”¨å€’æ’ç´¢å¼•ï¼Œæ‰€è°“å€’æ’ç´¢å¼•ï¼Œå°±æ˜¯é€šè¿‡å±æ€§å€¼æ¥ç¡®å®šæ•°æ®è®°å½•çš„ä½ç½®çš„ç´¢å¼•ï¼Œæ¥é¿å…å…¨è¡¨æ‰«æè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œ ç¬¬ä¸‰ã€ESé‡‡ç”¨åˆ†ç‰‡å­˜å‚¨æœºåˆ¶ ç¬¬å››ã€ESæ‰©å±•æ€§å¥½ï¼Œæˆ‘ä»¬å¯ä»¥æ°´å¹³æ‰©å±•å¢åŠ æœåŠ¡å™¨ï¼Œæå‡ESå¤„ç†æ€§èƒ½ï¼Œå¯ä»¥è¾¾åˆ°ç™¾å°æœåŠ¡å™¨èŠ‚ç‚¹æ‰©å±• ç¬¬äº”ã€ESå†…éƒ¨æä¾›äº†æ•°æ®æ±‡æ€»å’Œç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ä¸€äº›åŠŸèƒ½ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æ›´åŠ é«˜æ•ˆçš„å­˜å‚¨å’Œæœç´¢æ•°æ® ä½¿ç”¨ESæ³¨æ„äº‹é¡¹ ESé‡Œé¢ä¸å»ºè®®ä½¿ç”¨å¤æ‚çš„å…³è”æŸ¥è¯¢ï¼Œä¼šå¯¹æ€§èƒ½å½±å“å¾ˆå¤§ é¿å…æ·±åº¦åˆ†é¡µæŸ¥è¯¢ï¼Œå› ä¸ºESåˆ†é¡µæ˜¯æ”¯æŒfrontå’Œsizeå‚æ•°ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ¯ä¸ªåˆ†ç‰‡å¿…é¡»æ„é€ ä¸€ä¸ªé•¿åº¦ä¸ºfrontåŠ sizeçš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œç„¶åå›ä¼ åˆ°ç½‘å…³èŠ‚ç‚¹ï¼Œç½‘å…³èŠ‚ç‚¹å†å¯¹è¿™äº›é˜Ÿåˆ—è¿›è¡Œæ’åºå†æ‰¾åˆ°æ­£ç¡®çš„sizeæ–‡æ¡£ã€‚è€Œå½“frontè¶³å¤Ÿå¤§çš„æ—¶å€™å®¹æ˜“é€ æˆOOMä»¥åŠç½‘ç»œä¼ è¾“æ€§èƒ½å·®çš„ä¸€äº›é—®é¢˜","categories":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"}],"tags":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/tags/%E9%9D%A2%E8%AF%95/"}]},{"title":"mysqlé¢è¯•","slug":"7.mysql/é¢è¯•-mysql","date":"2022-03-30T16:00:00.000Z","updated":"2024-08-22T03:23:14.704Z","comments":true,"path":"2022/03/31/7.mysql/é¢è¯•-mysql/","link":"","permalink":"https://zhangxin66666.github.io/2022/03/31/7.mysql/%E9%9D%A2%E8%AF%95-mysql/","excerpt":"","text":"1.ç´¢å¼•åº•å±‚ç»“æ„&amp;è¡Œæ ¼å¼&amp;é¡µæ ¼å¼æ–‡ç« å†…å®¹åŒ…å«ç´¢å¼•ç»“æ„ï¼Œè”åˆç´¢å¼•ç»“æ„ï¼Œèšç°‡ç´¢å¼•ã€éèšç°‡ç´¢å¼•åŒºåˆ«ï¼Œåœ¨é¡µä¸Šå¦‚ä½•æœç´¢å…·ä½“æ•°æ®è¿‡ç¨‹ï¼Œä¸€æ¬¡å®Œæˆçš„ç´¢å¼•æ£€ç´¢è¿‡ç¨‹ åœ°å€ï¼šè¡Œé¡µç´¢å¼•åº•å±‚ç»“æ„ 2.ä¸€æ¡ SQL çš„æ‰§è¡Œè¿‡ç¨‹è¯¦è§£ ä»å‡†å¤‡æ›´æ–°ä¸€æ¡æ•°æ®åˆ°äº‹åŠ¡çš„æäº¤çš„æµç¨‹æè¿° é¦–å…ˆæ‰§è¡Œå™¨æ ¹æ® MySQL çš„æ‰§è¡Œè®¡åˆ’æ¥æŸ¥è¯¢æ•°æ®ï¼Œå…ˆæ˜¯ä»ç¼“å­˜æ± ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šå»æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œå¦‚æœæŸ¥è¯¢åˆ°äº†å°±å°†å…¶æ”¾åˆ°ç¼“å­˜æ± ä¸­ åœ¨æ•°æ®è¢«ç¼“å­˜åˆ°ç¼“å­˜æ± çš„åŒæ—¶ï¼Œä¼šå†™å…¥ undo log æ—¥å¿—æ–‡ä»¶ æ›´æ–°çš„åŠ¨ä½œæ˜¯åœ¨ BufferPool ä¸­å®Œæˆçš„ï¼ŒåŒæ—¶ä¼šå°†æ›´æ–°åçš„æ•°æ®æ·»åŠ åˆ° redo log buffer ä¸­ å®Œæˆä»¥åå°±å¯ä»¥æäº¤äº‹åŠ¡ï¼Œåœ¨æäº¤çš„åŒæ—¶ä¼šåšä»¥ä¸‹ä¸‰ä»¶äº‹ å°†redo log bufferä¸­çš„æ•°æ®åˆ·å…¥åˆ° redo log æ–‡ä»¶ä¸­ å°†æœ¬æ¬¡æ“ä½œè®°å½•å†™å…¥åˆ° bin logæ–‡ä»¶ä¸­ å°† bin log æ–‡ä»¶åå­—å’Œæ›´æ–°å†…å®¹åœ¨ bin log ä¸­çš„ä½ç½®è®°å½•åˆ°redo logä¸­ï¼ŒåŒæ—¶åœ¨ redo log æœ€åæ·»åŠ  commit æ ‡è®° è‡³æ­¤è¡¨ç¤ºæ•´ä¸ªæ›´æ–°äº‹åŠ¡å·²ç»å®Œæˆ ä¸ºä»€ä¹ˆMysqlä¸èƒ½ç›´æ¥æ›´æ–°ç£ç›˜ä¸Šçš„æ•°æ®è€Œä¸”è®¾ç½®è¿™ä¹ˆä¸€å¥—å¤æ‚çš„æœºåˆ¶æ¥æ‰§è¡ŒSQLäº†ï¼Ÿ å› ä¸ºæ¥ä¸€ä¸ªè¯·æ±‚å°±ç›´æ¥å¯¹ç£ç›˜æ–‡ä»¶è¿›è¡Œéšæœºè¯»å†™ï¼Œç„¶åæ›´æ–°ç£ç›˜æ–‡ä»¶é‡Œçš„æ•°æ®æ€§èƒ½å¯èƒ½ç›¸å½“å·®ã€‚å› ä¸ºç£ç›˜éšæœºè¯»å†™çš„æ€§èƒ½æ˜¯éå¸¸å·®çš„ï¼Œæ‰€ä»¥ç›´æ¥æ›´æ–°ç£ç›˜æ–‡ä»¶æ˜¯ä¸èƒ½è®©æ•°æ®åº“æŠ—ä½å¾ˆé«˜å¹¶å‘çš„ã€‚ Mysqlè¿™å¥—æœºåˆ¶çœ‹èµ·æ¥å¤æ‚ï¼Œä½†å®ƒå¯ä»¥ä¿è¯æ¯ä¸ªæ›´æ–°è¯·æ±‚éƒ½æ˜¯æ›´æ–°å†…å­˜BufferPoolï¼Œç„¶åé¡ºåºå†™æ—¥å¿—æ–‡ä»¶ï¼ŒåŒæ—¶è¿˜èƒ½ ä¿è¯å„ç§å¼‚å¸¸æƒ…å†µä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚ æ›´æ–°å†…å­˜çš„æ€§èƒ½æ˜¯æé«˜çš„ï¼Œç„¶åé¡ºåºå†™ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶çš„æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ï¼Œè¦è¿œé«˜äºéšæœºè¯»å†™ç£ç›˜æ–‡ä»¶ã€‚ æ­£æ˜¯é€šè¿‡è¿™å¥—æœºåˆ¶ï¼Œæ‰èƒ½è®©æˆ‘ä»¬çš„MySQLæ•°æ®åº“åœ¨è¾ƒé«˜é…ç½®çš„æœºå™¨ä¸Šæ¯ç§’å¯ä»¥æŠ—ä¸‹å‡ å¹²çš„è¯»å†™è¯·æ±‚ã€‚ ç»†èŠ‚ä»‹ç»serverå±‚è¿æ¥å™¨ã€è¯æ³•åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ã€æŸ¥è¯¢ç¼“å­˜åŠŸèƒ½è§å•ç‹¬æ–‡ç«  åœ°å€ï¼šmysqlæ‰§è¡Œæµç¨‹ 3.ACIDåŠå®ç°åŸç† ï¼ˆAtomicityï¼‰åŸå­æ€§ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚è¦ä¹ˆå…¨éƒ½æ‰§è¡Œ,è¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œï¼›â€”â€”-&gt;åŸå­æ€§æ˜¯ç”±undologæ—¥å¿—æ¥ä¿è¯çš„ï¼Œå®ƒè®°å½•äº†éœ€è¦å›æ»šçš„æ—¥å¿—ä¿¡æ¯ï¼Œäº‹åŠ¡å›æ»šæ—¶ï¼Œæ’¤é”€å·²ç»æ‰§è¡ŒæˆåŠŸçš„sql ï¼ˆConsistencyï¼‰ä¸€è‡´æ€§ï¼š æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼›â€”â€”-&gt;åŸå­æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§å°±æ˜¯ä¸ºäº†æ¥ä¿è¯ä¸€è‡´æ€§ ï¼ˆIsolationï¼‰éš”ç¦»æ€§ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œæ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶,ä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„â€œç‹¬ç«‹â€ç¯å¢ƒæ‰§è¡Œï¼›â€”â€”-&gt;é”æœºåˆ¶å’ŒMVCCå…±åŒå®ç° ï¼ˆDurabilityï¼‰æŒä¹…æ€§: ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚â€”â€”-&gt;æŒä¹…æ€§ç”±redologæ¥ä¿è¯çš„ï¼Œmysqlä¿®æ”¹æ•°æ®çš„æ—¶å€™ä¼šåœ¨redologä¸­è®°å½•ä¸€ä»½æ—¥å¿—æ•°æ®ï¼Œå°±ç®—æ•°æ®æ²¡æœ‰ä¿å­˜æˆåŠŸï¼Œåªè¦æ—¥å¿—ä¿å­˜æˆåŠŸäº†ï¼Œæ•°æ®ä»ç„¶ä¸ä¼šä¸¢å¤±ã€‚ 4.MVCCMVCCå«åšå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œå®é™…ä¸Šå°±æ˜¯ä¿å­˜äº†æ•°æ®åœ¨æŸä¸ªæ—¶é—´èŠ‚ç‚¹çš„å¿«ç…§ã€‚ MVCCä¸»è¦è§£å†³ä¸‰ä¸ªé—®é¢˜ï¼š ç¬¬ä¸€ã€é€šè¿‡MVCCå¯ä»¥è§£å†³è¯»å†™å¹¶å‘é˜»å¡é—®é¢˜ï¼Œä»è€Œæé«˜æ•°æ®åº“çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼› ç¬¬äºŒã€MVCCé‡‡ç”¨çš„æ˜¯ä¹è§‚é”çš„æ–¹å¼å®ç°ï¼Œé™ä½äº†æ­»é”çš„æ¦‚ç‡ï¼› ç¬¬ä¸‰ã€è§£å†³äº†ä¸€è‡´æ€§è¯»çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œæ ¹æ®æŸä¸ªæ¡ä»¶å»è¯»å–åˆ°çš„æ•°æ®ï¼ŒçŸ¥é“äº‹åŠ¡ç»“æŸçš„æ—¶å€™å†å»æ‰§è¡Œç›¸åŒæ¡ä»¶ï¼Œè¿˜æ˜¯è¯»åˆ°åŒä¸€ä»½æ•°æ®ï¼Œä¸ä¼šå‘ç”Ÿå˜åŒ–å˜åŒ–ã€‚ MVCCç”¨äºè¯»å·²æäº¤ï¼ˆRCï¼‰å’Œå¯é‡å¤è¯»çº§åˆ«ï¼ˆRRï¼‰çš„æ§åˆ¶ï¼Œä¸»è¦é€šè¿‡undo logæ—¥å¿—ç‰ˆæœ¬é“¾å’Œread viewæ¥å®ç°ï¼Œ InnoDBä¸­MVCCçš„å®ç°ä¾èµ–å››ä¸ªæ¡ä»¶: éšè—å­—æ®µ, äº‹åŠ¡é“¾è¡¨ï¼Œread view, undo log æ•°æ®è¡¨é¢å¤–å­—æ®µ DB_TRX_ID(6å­—èŠ‚): åœ¨innoDBä¸­, ä¼šä¸ºæ¯ä¸ªäº‹ç‰©åˆ†é…ä¸€ä¸ªäº‹åŠ¡ID. è€Œè¯¥å­—æ®µè¡¨ç¤ºçš„å°±æ˜¯æ’å…¥æˆ–æ›´æ–°è¯¥è¡Œçš„æœ€åä¸€ä¸ªäº‹åŠ¡çš„äº‹åŠ¡æ ‡è¯†ç¬¦. DB_ROLL_PTR(7å­—èŠ‚): è¿™ä¸ªå­—æ®µç§°ä¸ºå›æ»šæŒ‡é’ˆ, æŒ‡å‘äº†å›æ»šæ®µçš„æ’¤é”€æ—¥å¿—. (undo log) DB_ROW_ID(6å­—èŠ‚): è¿™ä¸ªå­—æ®µåŒ…å«äº†ä¸€ä¸ªè¡ŒID. è¯¥IDåœ¨æ’å…¥æ–°è¡Œæ—¶ä¼šå•è°ƒå¢åŠ . è¿™ä¸ªå­—æ®µæ˜¯ä¸ºäº†åœ¨è¡¨é‡Œæ²¡æœ‰ä¸»é”®IDçš„æ—¶å€™, ç”Ÿæˆèšç°‡ç´¢å¼•ä½¿ç”¨çš„. rowidå­˜çš„æ˜¯ä»€ä¹ˆï¼Ÿ rowidé»˜è®¤æ˜¯ä¸»é”®ï¼Œå¦‚æœæ²¡æœ‰ä¸»é”®ï¼Œä¼šé€‰æ‹©å”¯ä¸€é”®ï¼Œå¦‚æœæ²¡æœ‰å”¯ä¸€é”®ï¼Œä¼šç”Ÿæˆ6å­—èŠ‚çš„rowid undoæ—¥å¿—ç‰ˆæœ¬é“¾æ˜¯æŒ‡ä¸€è¡Œæ•°æ®è¢«å¤šä¸ªäº‹åŠ¡ä¾æ¬¡ä¿®æ”¹è¿‡åï¼Œåœ¨æ¯ä¸ªäº‹åŠ¡ä¿®æ”¹å®Œåï¼ŒMysqlä¼šä¿ç•™ä¿®æ”¹å‰çš„æ•°æ®undoå›æ»š æ—¥å¿—ï¼Œå¹¶ä¸”ç”¨ä¸¤ä¸ªéšè—å­—æ®µtrx_idå’Œroll_pointeræŠŠè¿™äº›undoæ—¥å¿—ä¸²è”èµ·æ¥å½¢æˆä¸€ä¸ªå†å²è®°å½•ç‰ˆæœ¬é“¾ åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼ˆRRï¼‰ï¼Œå½“äº‹åŠ¡å¼€å¯ï¼Œæ‰§è¡Œä»»ä½•æŸ¥è¯¢sqlæ—¶ä¼šç”Ÿæˆå½“å‰äº‹åŠ¡çš„ä¸€è‡´æ€§è§†å›¾read-viewï¼Œè¯¥è§†å›¾åœ¨äº‹åŠ¡ç»“æŸ ä¹‹å‰éƒ½ä¸ä¼šå˜åŒ–(å¦‚æœæ˜¯è¯»å·²æäº¤éš”ç¦»çº§åˆ«åœ¨æ¯æ¬¡æ‰§è¡ŒæŸ¥è¯¢sqlæ—¶éƒ½ä¼šé‡æ–°ç”Ÿæˆ)ï¼Œè¿™ä¸ªè§†å›¾ç”±æ‰§è¡ŒæŸ¥è¯¢æ—¶æ‰€æœ‰æœªæäº¤äº‹ åŠ¡idæ•°ç»„ï¼ˆæ•°ç»„é‡Œæœ€å°çš„idä¸ºmin_idï¼‰å’Œå·²åˆ›å»ºçš„æœ€å¤§äº‹åŠ¡idï¼ˆmax_idï¼‰ç»„æˆï¼Œäº‹åŠ¡é‡Œçš„ä»»ä½•sqlæŸ¥è¯¢ç»“æœéœ€è¦ä»å¯¹åº” ç‰ˆæœ¬é“¾é‡Œçš„æœ€æ–°æ•°æ®å¼€å§‹é€æ¡è·Ÿread-viewåšæ¯”å¯¹ä»è€Œå¾—åˆ°æœ€ç»ˆçš„å¿«ç…§ç»“æœã€‚ ç‰ˆæœ¬é“¾æ¯”å¯¹è§„åˆ™ï¼š å¦‚æœ row çš„ trx_id è½åœ¨ç»¿è‰²éƒ¨åˆ†( trx_id&lt;min_id )ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²æäº¤çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œè¿™ä¸ªæ•°æ®æ˜¯å¯è§çš„ï¼› å¦‚æœ row çš„ trx_id è½åœ¨çº¢è‰²éƒ¨åˆ†( trx_id&gt;max_id )ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±å°†æ¥å¯åŠ¨çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ˜¯ä¸å¯è§çš„(è‹¥ row çš„ trx_id å°±æ˜¯å½“å‰è‡ªå·±çš„äº‹åŠ¡æ˜¯å¯è§çš„ï¼‰ï¼›3. å¦‚æœ row çš„ trx_id è½åœ¨é»„è‰²éƒ¨åˆ†(min_id &lt;=trx_id&lt;= max_id)ï¼Œé‚£å°±åŒ…æ‹¬ä¸¤ç§æƒ…å†µ â€‹ a. è‹¥ row çš„ trx_id åœ¨è§†å›¾æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±è¿˜æ²¡æäº¤çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œä¸å¯è§(è‹¥ row çš„ trx_id å°±æ˜¯å½“å‰è‡ª å·±çš„äº‹åŠ¡æ˜¯å¯è§çš„)ï¼› â€‹ b. è‹¥ row çš„ trx_id ä¸åœ¨è§†å›¾æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²ç»æäº¤äº†çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œå¯è§ã€‚ å¯¹äºåˆ é™¤çš„æƒ…å†µå¯ä»¥è®¤ä¸ºæ˜¯updateçš„ç‰¹æ®Šæƒ…å†µï¼Œä¼šå°†ç‰ˆæœ¬é“¾ä¸Šæœ€æ–°çš„æ•°æ®å¤åˆ¶ä¸€ä»½ï¼Œç„¶åå°†trx_idä¿®æ”¹æˆåˆ é™¤æ“ä½œçš„ trx_idï¼ŒåŒæ—¶åœ¨è¯¥æ¡è®°å½•çš„å¤´ä¿¡æ¯ï¼ˆrecord headerï¼‰é‡Œçš„ï¼ˆdeleted_flagï¼‰æ ‡è®°ä½å†™ä¸Štrueï¼Œæ¥è¡¨ç¤ºå½“å‰è®°å½•å·²ç»è¢« åˆ é™¤ï¼Œåœ¨æŸ¥è¯¢æ—¶æŒ‰ç…§ä¸Šé¢çš„è§„åˆ™æŸ¥åˆ°å¯¹åº”çš„è®°å½•å¦‚æœdelete_flagæ ‡è®°ä½ä¸ºtrueï¼Œæ„å‘³ç€è®°å½•å·²è¢«åˆ é™¤ï¼Œåˆ™ä¸è¿”å›æ•° æ®ã€‚ æ³¨æ„ï¼šbegin/start transaction å‘½ä»¤å¹¶ä¸æ˜¯ä¸€ä¸ªäº‹åŠ¡çš„èµ·ç‚¹ï¼Œåœ¨æ‰§è¡Œåˆ°å®ƒä»¬ä¹‹åçš„ç¬¬ä¸€ä¸ªä¿®æ”¹æ“ä½œInnoDBè¡¨çš„è¯­å¥ï¼Œ äº‹åŠ¡æ‰çœŸæ­£å¯åŠ¨ï¼Œæ‰ä¼šå‘mysqlç”³è¯·äº‹åŠ¡idï¼Œmysqlå†…éƒ¨æ˜¯ä¸¥æ ¼æŒ‰ç…§äº‹åŠ¡çš„å¯åŠ¨é¡ºåºæ¥åˆ†é…äº‹åŠ¡idçš„ã€‚ æ€»ç»“ï¼š MVCCæœºåˆ¶çš„å®ç°å°±æ˜¯é€šè¿‡read-viewæœºåˆ¶ä¸undoç‰ˆæœ¬é“¾æ¯”å¯¹æœºåˆ¶ï¼Œä½¿å¾—ä¸åŒçš„äº‹åŠ¡ä¼šæ ¹æ®æ•°æ®ç‰ˆæœ¬é“¾å¯¹æ¯”è§„åˆ™è¯»å– åŒä¸€æ¡æ•°æ®åœ¨ç‰ˆæœ¬é“¾ä¸Šçš„ä¸åŒç‰ˆæœ¬æ•°æ®ã€‚ 5.mysqlä¸‰å¤§æ—¥å¿—åœ°å€ï¼šmysqlä¸‰å¤§æ—¥å¿— 6.redoæ—¥å¿—åœ°å€ï¼šredoæ—¥å¿— 7.undoæ—¥å¿—åœ°å€ï¼šundoæ—¥å¿— 8.èƒ½è¯´ä¸‹myisam å’Œ innodbçš„åŒºåˆ«å— åŒºåˆ« InnoDB MyISAM äº‹åŠ¡ æ”¯æŒ ä¸æ”¯æŒ å¤–é”® æ”¯æŒ ä¸æ”¯æŒ ç´¢å¼• èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼• éèšç°‡ç´¢å¼• è¡Œé” æ”¯æŒ ä¸æ”¯æŒ è¡¨é” æ”¯æŒ æ”¯æŒ å­˜å‚¨æ–‡ä»¶ frm(è¡¨ç»“æ„)ï¼Œibd(æ•°æ®å’Œç´¢å¼•) frmï¼Œmyi(ç´¢å¼•æ–‡ä»¶)ï¼Œmyd(æ•°æ®æ–‡ä»¶) å…·ä½“è¡Œæ•° å…¨è¡¨æ‰«æç»Ÿè®¡è¡Œæ•° é€šè¿‡å˜é‡ä¿å­˜è¡Œæ•° MyISAMä¸æ”¯æŒäº‹åŠ¡ï¼Œåœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥SELECTå‰ï¼Œä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„æ‰€æœ‰è¡¨åŠ è¯»é”,åœ¨æ‰§è¡Œupdateã€insertã€deleteæ“ä½œä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„è¡¨åŠ å†™é”ã€‚ InnoDBåœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥SELECTæ—¶(éä¸²è¡Œéš”ç¦»çº§åˆ«)ï¼Œ(å› ä¸ºæœ‰mvccæœºåˆ¶)ä¸ä¼šåŠ é”ã€‚ä½†æ˜¯updateã€insertã€deleteæ“ä½œä¼šåŠ è¡Œé”ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯è¯»é”ä¼šé˜»å¡å†™ï¼Œä½†æ˜¯ä¸ä¼šé˜»å¡è¯»ã€‚è€Œå†™é”åˆ™ä¼šæŠŠè¯»å’Œå†™éƒ½é˜»å¡ã€‚ 9.è¯´ä¸‹mysqlçš„ç´¢å¼•æœ‰å“ªäº›å§ï¼Œèšç°‡å’Œéèšç°‡ç´¢å¼•åˆæ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«èšç°‡ç´¢å¼•ï¼šå°†æ•°æ®å­˜å‚¨ä¸ç´¢å¼•æ”¾åˆ°äº†ä¸€å—ï¼Œæ‰¾åˆ°ç´¢å¼•ä¹Ÿå°±æ‰¾åˆ°äº†æ•°æ®éèšç°‡ç´¢å¼•ï¼šå°†æ•°æ®å­˜å‚¨äºç´¢å¼•åˆ†å¼€ç»“æ„ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹æŒ‡å‘äº†æ•°æ®çš„å¯¹åº”è¡Œï¼Œmyisamé€šè¿‡key_bufferæŠŠç´¢å¼•å…ˆç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå½“éœ€è¦è®¿é—®æ•°æ®æ—¶ï¼ˆé€šè¿‡ç´¢å¼•è®¿é—®æ•°æ®ï¼‰ï¼Œåœ¨å†…å­˜ä¸­ç›´æ¥æœç´¢ç´¢å¼•ï¼Œç„¶åé€šè¿‡ç´¢å¼•æ‰¾åˆ°ç£ç›˜ç›¸åº”æ•°æ®ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç´¢å¼•ä¸åœ¨key bufferå‘½ä¸­æ—¶ï¼Œé€Ÿåº¦æ…¢çš„åŸå›  10.ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•å’Œå›è¡¨è¦†ç›–ç´¢å¼•æŒ‡çš„æ˜¯åœ¨ä¸€æ¬¡æŸ¥è¯¢ä¸­ï¼Œå¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«æˆ–è€…è¯´è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œæˆ‘ä»¬å°±ç§°ä¹‹ä¸ºè¦†ç›–ç´¢å¼•ï¼Œè€Œä¸å†éœ€è¦å›è¡¨æŸ¥è¯¢ã€‚ è¾…åŠ©ç´¢å¼•çš„å­˜åœ¨å¹¶ä¸å½±å“æ•°æ®åœ¨èšé›†ç´¢å¼•ä¸­çš„ç»„ç»‡ï¼Œå› æ­¤æ¯å¼ è¡¨ä¸Šå¯ä»¥æœ‰å¤šä¸ªè¾…åŠ© ç´¢å¼•ã€‚å½“é€šè¿‡è¾…åŠ©ç´¢å¼•æ¥å¯»æ‰¾æ•°æ®æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šéå†è¾…åŠ©ç´¢å¼•å¹¶é€šè¿‡å¶çº§åˆ«çš„æŒ‡é’ˆè·å¾—æŒ‡å‘ä¸»é”®ç´¢å¼•çš„ä¸»é”®ï¼Œç„¶åå†é€šè¿‡ä¸»é”®ç´¢å¼•ï¼ˆèšé›†ç´¢å¼•ï¼‰æ¥æ‰¾åˆ°ä¸€ä¸ªå®Œæ•´çš„è¡Œè®°å½•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿè¢«ç§°ä¸ºå›è¡¨ã€‚ä¹Ÿå°±æ˜¯æ ¹æ®è¾…åŠ©ç´¢å¼•çš„å€¼æŸ¥è¯¢ä¸€æ¡å®Œæ•´çš„ç”¨æˆ·è®°å½•éœ€è¦ä½¿ç”¨åˆ°2æ£µB+æ ‘â€”-ä¸€æ¬¡è¾…åŠ©ç´¢å¼•ï¼Œä¸€æ¬¡èšé›†ç´¢å¼•ã€‚ 11.mysqlçš„å„ç§é”ã€‚ é—´éš™é”é”åˆ†ç±»å›¾è§£ æŒ‰ç…§å…¼å®¹æ€§åˆ†ç±» InnoDBå®ç°äº†ä»¥ä¸‹ä¸¤ç§ç±»å‹çš„è¡Œé”ã€‚ ã€Œå…±äº«é”ï¼ˆS)ã€ï¼šåˆç§°è¯»é” (read lock)ï¼Œæ˜¯è¯»å–æ“ä½œåˆ›å»ºçš„é”ã€‚å…¶ä»–ç”¨æˆ·å¯ä»¥å¹¶å‘è¯»å–æ•°æ®ï¼Œ ä½†ä»»ä½•äº‹åŠ¡éƒ½ä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼ˆè·å–æ•°æ®ä¸Šçš„æ’ä»–é”ï¼‰ï¼Œç›´åˆ°å·²é‡Šæ”¾æ‰€æœ‰å…±äº«é”ã€‚å½“å¦‚æœäº‹åŠ¡å¯¹è¯»é”è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œå¾ˆå¯èƒ½ä¼šé€ æˆæ­»é”ã€‚ ã€Œæ’ä»–é”ï¼ˆX)ã€ï¼šexclusive lockï¼ˆä¹Ÿå«writer lockï¼‰åˆç§°å†™é”ã€‚ è‹¥æŸä¸ªäº‹ç‰©å¯¹æŸä¸€è¡ŒåŠ ä¸Šäº†æ’ä»–é”ï¼Œåªèƒ½è¿™ä¸ªäº‹åŠ¡å¯¹å…¶è¿›è¡Œè¯»å†™ï¼Œåœ¨æ­¤äº‹åŠ¡ç»“æŸä¹‹å‰ï¼Œ å…¶ä»–äº‹åŠ¡ä¸èƒ½å¯¹å…¶è¿›è¡ŒåŠ ä»»ä½•é”ï¼Œå…¶ä»–è¿›ç¨‹å¯ä»¥è¯»å–,ä¸èƒ½è¿›è¡Œå†™æ“ä½œï¼Œéœ€ç­‰å¾…å…¶é‡Šæ”¾ã€‚ ã€Œæ’å®ƒé”æ˜¯æ‚²è§‚é”çš„ä¸€ç§å®ç°ã€ã€‚ å¦å¤–ï¼Œä¸ºäº†å…è®¸è¡Œé”å’Œè¡¨é”å…±å­˜ï¼Œå®ç°å¤šç²’åº¦é”æœºåˆ¶ï¼ŒInnoDBè¿˜æœ‰ä¸¤ç§å†…éƒ¨ä½¿ç”¨çš„æ„å‘é”ï¼ˆIntention Locksï¼‰ï¼Œè¿™ä¸¤ç§æ„å‘é”éƒ½æ˜¯è¡¨é”ã€‚ ã€Œæ„å‘å…±äº«é”ï¼ˆISï¼‰ã€ï¼šäº‹åŠ¡æ‰“ç®—ç»™æ•°æ®è¡ŒåŠ è¡Œå…±äº«é”ï¼Œäº‹åŠ¡åœ¨ç»™ä¸€ä¸ªæ•°æ®è¡ŒåŠ å…±äº«é”å‰å¿…é¡»å…ˆå–å¾—è¯¥è¡¨çš„ISé”ã€‚ ã€Œæ„å‘æ’ä»–é”ï¼ˆIXï¼‰ã€ï¼šäº‹åŠ¡æ‰“ç®—ç»™æ•°æ®è¡ŒåŠ è¡Œæ’ä»–é”ï¼Œäº‹åŠ¡åœ¨ç»™ä¸€ä¸ªæ•°æ®è¡ŒåŠ æ’ä»–é”å‰å¿…é¡»å…ˆå–å¾—è¯¥è¡¨çš„IXé”ã€‚ æ„å‘é”æ˜¯æœ‰æ•°æ®å¼•æ“è‡ªå·±ç»´æŠ¤çš„ï¼Œç”¨æˆ·æ— æ³•æ‰‹åŠ¨æ“ä½œæ„å‘é”ï¼Œåœ¨ä¸ºæ•°æ®è¡ŒåŠ å…±äº« / æ’ä»–é”ä¹‹å‰ï¼ŒInooDB ä¼šå…ˆè·å–è¯¥æ•°æ®è¡Œæ‰€åœ¨åœ¨æ•°æ®è¡¨çš„å¯¹åº”æ„å‘é”ã€‚ ã€ŒInnoDBè¡Œé”æ¨¡å¼å…¼å®¹æ€§åˆ—è¡¨ã€ è¯·æ±‚é”æ¨¡å¼ æ˜¯å¦å…¼å®¹å½“å‰é”æ¨¡å¼ X IX S IS X å†²çª å†²çª å†²çª å†²çª IX å†²çª å…¼å®¹ å†²çª å…¼å®¹ S å†²çª å†²çª å…¼å®¹ å…¼å®¹ IS å†²çª å…¼å®¹ å…¼å®¹ å…¼å®¹ å¦‚æœä¸€ä¸ªäº‹åŠ¡è¯·æ±‚çš„é”æ¨¡å¼ä¸å½“å‰çš„é”å…¼å®¹ï¼ŒInnoDBå°±å°†è¯·æ±‚çš„é”æˆäºˆè¯¥äº‹åŠ¡ï¼›åä¹‹ï¼Œå¦‚æœä¸¤è€…ä¸å…¼å®¹ï¼Œè¯¥äº‹åŠ¡å°±è¦ç­‰å¾…é”é‡Šæ”¾ã€‚ æ„å‘é”æ˜¯InnoDBè‡ªåŠ¨åŠ çš„ï¼Œä¸éœ€ç”¨æˆ·å¹²é¢„ã€‚å¯¹äºUPDATEã€DELETEå’ŒINSERTå†™æ“ä½œï¼ŒInnoDBä¼šè‡ªåŠ¨ç»™æ¶‰åŠæ•°æ®é›†åŠ æ’ä»–é”ï¼ˆX)ï¼› å¯¹äºæ™®é€šSELECTè¯­å¥ï¼ŒInnoDBä¸ä¼šåŠ ä»»ä½•é”ï¼›äº‹åŠ¡å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥æ˜¾ç¤ºç»™è®°å½•é›†åŠ å…±äº«é”æˆ–æ’ä»–é”ã€‚ å…±äº«é”ï¼ˆSï¼‰ï¼šSELECT * FROM table_name WHERE â€¦ LOCK IN SHARE MODEã€‚ æ’ä»–é”ï¼ˆX)ï¼šSELECT * FROM table_name WHERE â€¦ FOR UPDATEã€‚ ç”¨SELECT â€¦ IN SHARE MODEè·å¾—å…±äº«é”ï¼Œä¸»è¦ç”¨åœ¨éœ€è¦æ•°æ®ä¾å­˜å…³ç³»æ—¶æ¥ç¡®è®¤æŸè¡Œè®°å½•æ˜¯å¦å­˜åœ¨ï¼Œ å¹¶ç¡®ä¿æ²¡æœ‰äººå¯¹è¿™ä¸ªè®°å½•è¿›è¡ŒUPDATEæˆ–è€…DELETEæ“ä½œã€‚ä½†æ˜¯å¦‚æœå½“å‰äº‹åŠ¡ä¹Ÿéœ€è¦å¯¹è¯¥è®°å½•è¿›è¡Œæ›´æ–°æ“ä½œï¼Œ åˆ™å¾ˆæœ‰å¯èƒ½é€ æˆæ­»é”ï¼Œå¯¹äºé”å®šè¡Œè®°å½•åéœ€è¦è¿›è¡Œæ›´æ–°æ“ä½œçš„åº”ç”¨ï¼Œåº”è¯¥ä½¿ç”¨SELECTâ€¦ FOR UPDATEæ–¹å¼è·å¾—æ’ä»–é”ã€‚ InnoDBåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ä¸¤é˜¶æ®µé”åè®®ï¼š éšæ—¶éƒ½å¯ä»¥æ‰§è¡Œé”å®šï¼ŒInnoDBä¼šæ ¹æ®éš”ç¦»çº§åˆ«åœ¨éœ€è¦çš„æ—¶å€™è‡ªåŠ¨åŠ é”ï¼› é”åªæœ‰åœ¨æ‰§è¡Œcommitæˆ–è€…rollbackçš„æ—¶å€™æ‰ä¼šé‡Šæ”¾ï¼Œå¹¶ä¸”æ‰€æœ‰çš„é”éƒ½æ˜¯åœ¨åŒä¸€æ—¶åˆ»è¢«é‡Šæ”¾ã€‚ æŒ‰ç®—æ³•åˆ†ç±» ã€ŒRecord Lockã€ï¼š å•ä¸ªè¡Œè®°å½•ä¸Šçš„é” é”æ€»ä¼šé”ä½ç´¢å¼•è®°å½•ï¼Œé”ä½çš„æ˜¯keyã€‚ å¦‚æœInnoDBå­˜å‚¨å¼•æ“è¡¨åœ¨å»ºç«‹çš„æ—¶å€™æ²¡æœ‰è®¾ç½®ä»»ä½•ä¸€ä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆè¿™æ—¶InnoDBä¼šä½¿ç”¨éšå¼çš„ä¸»é”®è¿›è¡Œé”å®šã€‚ å¦‚æœè¦é”çš„æ²¡æœ‰ç´¢å¼•ï¼Œåˆ™ä¼šè¿›è¡Œå…¨è¡¨è®°å½•åŠ é”ã€‚ ã€ŒGap Lockã€ ï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä½†ä¸åŒ…å«è®°å½•æœ¬èº« é”å®šç´¢å¼•è®°å½•é—´éš™ï¼Œç¡®ä¿ç´¢å¼•è®°å½•çš„é—´éš™ä¸å˜ é—´éš™é”æ—¶é’ˆå¯¹äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»æˆ–ä»¥ä¸Šçº§åˆ«è€Œé…çš„ 1Gap Lockåœ¨InnoDBçš„å”¯ä¸€ä½œç”¨å°±æ˜¯é˜²æ­¢å…¶ä»–äº‹åŠ¡çš„æ’å…¥æ“ä½œï¼Œä»¥æ­¤é˜²æ­¢å¹»è¯» ã€ŒNext-Key Lockã€ï¼šä¸´é”®é”ï¼ŒGap Lock + Record Lockï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”åŒ…å«è®°å½•æœ¬èº« å½“æŸ¥è¯¢çš„ç´¢å¼•å«æœ‰å”¯ä¸€å±æ€§æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šå¯¹Next-Key Lock è¿›è¡Œä¼˜åŒ–ï¼Œå°†å…¶é™çº§ä¸º Record Lockï¼Œå³ä»…é”ä½ç´¢å¼•æœ¬èº«ï¼Œè€Œä¸æ˜¯èŒƒå›´ã€‚ å½“æŸ¥è¯¢çš„ç´¢å¼•ä¸ºè¾…åŠ©ç´¢å¼•æ—¶ï¼Œé»˜è®¤ä½¿ç”¨Next-Key LockingæŠ€æœ¯è¿›è¡ŒåŠ é”ï¼Œé”å®šèŒƒå›´æ˜¯å‰ä¸€ä¸ªç´¢å¼•åˆ°åä¸€ä¸ªç´¢å¼•ä¹‹é—´èŒƒå›´ã€‚ 12.MRRæ¯æ¬¡ä»äºŒçº§ç´¢å¼•ä¸­è¯»å–åˆ°ä¸€æ¡è®°å½•åï¼Œå°±ä¼šæ ¹æ®è¯¥è®°å½•çš„ä¸»é”®å€¼ æ‰§è¡Œå›è¡¨æ“ä½œã€‚è€Œåœ¨æŸä¸ªæ‰«æåŒºé—´ä¸­çš„äºŒçº§ç´¢å¼•è®°å½•çš„ä¸»é”®å€¼æ˜¯æ— åºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº› äºŒçº§ç´¢å¼•è®°å½•å¯¹åº”çš„èšç°‡ç´¢å¼•è®°å½•æ‰€åœ¨çš„é¡µé¢çš„é¡µå·æ˜¯æ— åºçš„ã€‚ æ¯æ¬¡æ‰§è¡Œå›è¡¨æ“ä½œæ—¶éƒ½ç›¸å½“äºè¦éšæœºè¯»å–ä¸€ä¸ªèšç°‡ç´¢å¼•é¡µé¢ï¼Œè€Œè¿™äº›éšæœºIOå¸¦æ¥çš„ æ€§èƒ½å¼€é”€æ¯”è¾ƒå¤§ã€‚MySQLä¸­æå‡ºäº†ä¸€ä¸ªåä¸ºDisk-Sweep Multi-Range Read (MRRï¼Œå¤šèŒƒå›´ è¯»å–)çš„ä¼˜åŒ–æªæ–½ï¼Œå³å…ˆè¯»å–ä¸€éƒ¨åˆ†äºŒçº§ç´¢å¼•è®°å½•ï¼Œå°†å®ƒä»¬çš„ä¸»é”®å€¼æ’å¥½åºä¹‹åå†ç»Ÿä¸€æ‰§ è¡Œå›è¡¨æ“ä½œã€‚ ç›¸å¯¹äºæ¯è¯»å–ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•å°±ç«‹å³æ‰§è¡Œå›è¡¨æ“ä½œï¼Œè¿™æ ·ä¼šèŠ‚çœä¸€äº›IOå¼€é”€ã€‚ä½¿ç”¨è¿™ä¸ª MRRä¼˜åŒ–æªæ–½çš„æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è®¤ä¸ºæ¯è¯»å–ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•å°±ç«‹å³æ‰§è¡Œå›è¡¨æ“ä½œã€‚MRRçš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥è¯¢å®˜æ–¹æ–‡æ¡£ã€‚ 13.åˆ†åº“åˆ†è¡¨14.åˆ†å¸ƒå¼å”¯ä¸€id15.æ•°æ®åº“ä¸‰å¤§èŒƒå¼æ˜¯ä»€ä¹ˆç¬¬ä¸€èŒƒå¼ï¼šæ¯ä¸ªåˆ—éƒ½ä¸å¯ä»¥å†æ‹†åˆ†ã€‚ ç¬¬äºŒèŒƒå¼ï¼šåœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œéä¸»é”®åˆ—å®Œå…¨ä¾èµ–äºä¸»é”®ï¼Œè€Œä¸èƒ½æ˜¯ä¾èµ–äºä¸»é”®çš„ä¸€éƒ¨åˆ†ã€‚ ç¬¬ä¸‰èŒƒå¼ï¼šåœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œéä¸»é”®åˆ—åªä¾èµ–äºä¸»é”®ï¼Œä¸ä¾èµ–äºå…¶ä»–éä¸»é”®ã€‚ åœ¨è®¾è®¡æ•°æ®åº“ç»“æ„çš„æ—¶å€™ï¼Œè¦å°½é‡éµå®ˆä¸‰èŒƒå¼ï¼Œå¦‚æœä¸éµå®ˆï¼Œå¿…é¡»æœ‰è¶³å¤Ÿçš„ç†ç”±ã€‚æ¯”å¦‚æ€§èƒ½ã€‚äº‹å®ä¸Šæˆ‘ä»¬ç»å¸¸ä¼šä¸ºäº†æ€§èƒ½è€Œå¦¥åæ•°æ®åº“çš„è®¾è®¡ã€‚ 16.InnoDBå¼•æ“çš„4å¤§ç‰¹æ€§æ’å…¥ç¼“å†²ï¼ˆinsert buffer) äºŒæ¬¡å†™(double write) è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•(ahi) é¢„è¯»(read ahead) 17.ç´¢å¼•å¤±æ•ˆçš„æƒ…å†µè°ˆåˆ°ç´¢å¼•ä¸»è¦ä»ä¸¤æ–¹é¢æ¥åˆ†æï¼šIO å’Œæ•°æ®ç»“æ„ï¼šä¸ç®¡ç´¢å¼•æ•°æ®è¿˜æ˜¯è¡Œæ•°æ®ï¼Œéƒ½æ˜¯å­˜åœ¨ç£ç›˜é‡Œé¢çš„ï¼Œæˆ‘ä»¬å°½å¯èƒ½å°‘çš„å–å‡ºæ•°æ® IOâ€”â€“&gt;è¯»å–æ¬¡æ•°å°‘ã€é‡å°‘â€”â€”&gt;åˆ†å—è¯»å–â€”â€”&gt;å±€éƒ¨æ€§åŸç†ã€ç£ç›˜é¢„è¯» æ•°æ®ç»“æ„â€”â€”&gt;B+æ ‘â€”â€”&gt;äºŒå‰æ ‘ã€AVLæ ‘ã€çº¢é»‘æ ‘ã€Bæ ‘ ç»„åˆç´¢å¼•ä¸éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™ ç»„åˆç´¢å¼•å‰é¢ç´¢å¼•åˆ—ä½¿ç”¨èŒƒå›´æŸ¥è¯¢(&lt;,&gt;,like),ä¼šå¯¼è‡´åç»­ç´¢å¼•å¤±æ•ˆï¼› ä¸è¦åœ¨ç´¢å¼•ä¸Šåšä»»ä½•æ“ä½œï¼ˆè®¡ç®—ï¼Œå‡½æ•°ï¼Œç±»å‹è½¬æ¢ï¼‰ is nullå’Œis not null æ— æ³•ä½¿ç”¨ç´¢å¼• å°½é‡å°‘ä½¿ç”¨oræ“ä½œç¬¦ï¼Œå¦åˆ™è¿æ¥æ—¶ç´¢å¼•ä¼šå¤±æ•ˆ å­—ç¬¦ä¸²ä¸æ·»åŠ å¼•å·ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼ˆéšå¼ç±»å‹è½¬æ¢ï¼‰ ä¸¤è¡¨å…³è”ä½¿ç”¨çš„æ¡ä»¶å­—æ®µä¸­å­—æ®µçš„é•¿åº¦ï¼Œç¼–ç ä¸ä¸€è‡´ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ likeè¯­å¥ä¸­ï¼Œä»¥%å¼€å¤´çš„æ¨¡ç³ŠæŸ¥è¯¢ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ å¦‚æœmysqlä¸­ä½¿ç”¨å…¨è¡¨æ‰«ææ¯”ç´¢å¼•å¿«ï¼Œä¹Ÿä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ ï¼ˆforce index:å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼‰ 18.æœ€å·¦å‰ç¼€åŸåˆ™ã€‚ è”åˆç´¢å¼•ä½¿ç”¨åˆ†æå®æˆ˜é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æœ€å·¦ä¼˜å…ˆï¼Œåœ¨åˆ›å»ºå¤šåˆ—ç´¢å¼•æ—¶ï¼Œè¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œwhereå­å¥ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„ä¸€åˆ—æ”¾åœ¨æœ€å·¦è¾¹ã€‚æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œéå¸¸é‡è¦çš„åŸåˆ™ï¼Œmysqlä¼šä¸€ç›´å‘å³åŒ¹é…ç›´åˆ°é‡åˆ°èŒƒå›´æŸ¥è¯¢(&gt;ã€&lt;ã€betweenã€like)å°±åœæ­¢åŒ¹é…ï¼Œæ¯”å¦‚a = 1 and b = 2 and c &gt; 3 and d = 4 å¦‚æœå»ºç«‹(a,b,c,d)é¡ºåºçš„ç´¢å¼•ï¼Œdæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„ï¼Œå¦‚æœå»ºç«‹(a,b,d,c)çš„ç´¢å¼•åˆ™éƒ½å¯ä»¥ç”¨åˆ°ï¼Œa,b,dçš„é¡ºåºå¯ä»¥ä»»æ„è°ƒæ•´ã€‚=å’Œinå¯ä»¥ä¹±åºï¼Œæ¯”å¦‚a = 1 and b = 2 and c = 3 å»ºç«‹(a,b,c)ç´¢å¼•å¯ä»¥ä»»æ„é¡ºåºï¼Œmysqlçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šå¸®ä½ ä¼˜åŒ–æˆç´¢å¼•å¯ä»¥è¯†åˆ«çš„å½¢å¼ å®æˆ˜ï¼Ÿï¼Ÿ 19.sqlä¼˜åŒ–ä¹‹explain è¯¦è§£åœ¨ select è¯­å¥ä¹‹å‰å¢åŠ  explain å…³é”®å­—ï¼ŒMySQL ä¼šåœ¨æŸ¥è¯¢ä¸Šè®¾ç½®ä¸€ä¸ªæ ‡è®°ï¼Œæ‰§è¡ŒæŸ¥è¯¢ä¼šè¿”å›æ‰§è¡Œè®¡åˆ’çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯æ‰§è¡Œè¿™æ¡SQL æ¥ä¸‹æ¥æˆ‘ä»¬å°†å±•ç¤º explain ä¸­æ¯ä¸ªåˆ—çš„ä¿¡æ¯ 19.1. idåˆ— idåˆ—çš„ç¼–å·æ˜¯ select çš„åºåˆ—å·ï¼Œæœ‰å‡ ä¸ª select å°±æœ‰å‡ ä¸ªidï¼Œå¹¶ä¸”idçš„é¡ºåºæ˜¯æŒ‰ select å‡ºç°çš„é¡ºåºå¢é•¿çš„ã€‚ idåˆ—è¶Šå¤§æ‰§è¡Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œidç›¸åŒåˆ™ä»ä¸Šå¾€ä¸‹æ‰§è¡Œï¼Œidä¸ºNULLæœ€åæ‰§è¡Œã€‚ 19.2. select_typeåˆ— select_type è¡¨ç¤ºå¯¹åº”è¡Œæ˜¯ç®€å•è¿˜æ˜¯å¤æ‚çš„æŸ¥è¯¢ã€‚ 1ï¼‰simpleï¼š ç®€å•æŸ¥è¯¢ã€‚æŸ¥è¯¢ä¸åŒ…å«å­æŸ¥è¯¢å’Œunion 11 mysql&gt; explain select * from film where id = 2; 2ï¼‰primaryï¼š å¤æ‚æŸ¥è¯¢ä¸­æœ€å¤–å±‚çš„ select 3ï¼‰subqueryï¼š åŒ…å«åœ¨ select ä¸­çš„å­æŸ¥è¯¢ï¼ˆä¸åœ¨ from å­å¥ä¸­ï¼‰ 4ï¼‰derivedï¼š åŒ…å«åœ¨ from å­å¥ä¸­çš„å­æŸ¥è¯¢ã€‚MySQLä¼šå°†ç»“æœå­˜æ”¾åœ¨ä¸€ä¸ªä¸´æ—¶è¡¨ä¸­ï¼Œä¹Ÿç§°ä¸ºæ´¾ç”Ÿè¡¨ï¼ˆderivedçš„è‹±æ–‡å«ä¹‰ï¼‰ ç”¨è¿™ä¸ªä¾‹å­æ¥äº†è§£ primaryã€subquery å’Œ derived ç±»å‹ 1231 mysql&gt; set session optimizer_switch=&#x27;derived_merge=off&#x27;; #å…³é—­mysql5.7æ–°ç‰¹æ€§å¯¹è¡ç”Ÿè¡¨çš„åˆ å¹¶ä¼˜åŒ– 2 mysql&gt; explain select (select 1 from actor where id = 1) from (select * from film where id = 1) der; 11 mysql&gt; set session optimizer_switch=&#x27;derived_merge=on&#x27;; #è¿˜åŸé»˜è®¤é…ç½® 5ï¼‰unionï¼š åœ¨ union ä¸­çš„ç¬¬äºŒä¸ªå’Œéšåçš„ select 11 mysql&gt; explain select 1 union all select 1; 19.3. tableåˆ— è¿™ä¸€åˆ—è¡¨ç¤º explain çš„ä¸€è¡Œæ­£åœ¨è®¿é—®å“ªä¸ªè¡¨ã€‚ å½“ from å­å¥ä¸­æœ‰å­æŸ¥è¯¢æ—¶ï¼Œtableåˆ—æ˜¯ æ ¼å¼ï¼Œè¡¨ç¤ºå½“å‰æŸ¥è¯¢ä¾èµ– id=N çš„æŸ¥è¯¢ï¼Œäºæ˜¯å…ˆæ‰§è¡Œ id=N çš„æŸ¥ è¯¢ã€‚ å½“æœ‰ union æ—¶ï¼ŒUNION RESULT çš„ table åˆ—çš„å€¼ä¸º&lt;union1,2&gt;ï¼Œ1å’Œ2è¡¨ç¤ºå‚ä¸ union çš„ select è¡Œidã€‚ 19.4. typeåˆ— è¿™ä¸€åˆ—è¡¨ç¤ºå…³è”ç±»å‹æˆ–è®¿é—®ç±»å‹ï¼Œå³MySQLå†³å®šå¦‚ä½•æŸ¥æ‰¾è¡¨ä¸­çš„è¡Œï¼ŒæŸ¥æ‰¾æ•°æ®è¡Œè®°å½•çš„å¤§æ¦‚èŒƒå›´ã€‚ ä¾æ¬¡ä»æœ€ä¼˜åˆ°æœ€å·®åˆ†åˆ«ä¸ºï¼šsystem &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL ä¸€èˆ¬æ¥è¯´ï¼Œå¾—ä¿è¯æŸ¥è¯¢è¾¾åˆ°rangeçº§åˆ«ï¼Œæœ€å¥½è¾¾åˆ°ref NULLï¼š mysqlèƒ½å¤Ÿåœ¨ä¼˜åŒ–é˜¶æ®µåˆ†è§£æŸ¥è¯¢è¯­å¥ï¼Œåœ¨æ‰§è¡Œé˜¶æ®µç”¨ä¸ç€å†è®¿é—®è¡¨æˆ–ç´¢å¼•ã€‚ä¾‹å¦‚ï¼šåœ¨ç´¢å¼•åˆ—ä¸­é€‰å–æœ€å°å€¼ï¼Œå¯ ä»¥å•ç‹¬æŸ¥æ‰¾ç´¢å¼•æ¥å®Œæˆï¼Œä¸éœ€è¦åœ¨æ‰§è¡Œæ—¶è®¿é—®è¡¨ 1 mysql&gt; explain select min(id) from film; const, systemï¼š mysqlèƒ½å¯¹æŸ¥è¯¢çš„æŸéƒ¨åˆ†è¿›è¡Œä¼˜åŒ–å¹¶å°†å…¶è½¬åŒ–æˆä¸€ä¸ªå¸¸é‡ï¼ˆå¯ä»¥çœ‹show warnings çš„ç»“æœï¼‰ã€‚ç”¨äº primary key æˆ– unique key çš„æ‰€æœ‰åˆ—ä¸å¸¸æ•°æ¯”è¾ƒæ—¶ï¼Œæ‰€ä»¥è¡¨æœ€å¤šæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼Œè¯»å–1æ¬¡ï¼Œé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚systemæ˜¯ constçš„ç‰¹ä¾‹ï¼Œè¡¨é‡Œåªæœ‰ä¸€æ¡å…ƒç»„åŒ¹é…æ—¶ä¸ºsystem 1 mysql&gt; explain extended select * from (select * from film where id = 1) tmp; 1 mysql&gt; show warnings; eq_refï¼š primary key æˆ– unique key ç´¢å¼•çš„æ‰€æœ‰éƒ¨åˆ†è¢«è¿æ¥ä½¿ç”¨ ï¼Œæœ€å¤šåªä¼šè¿”å›ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚è¿™å¯èƒ½æ˜¯åœ¨ const ä¹‹å¤–æœ€å¥½çš„è”æ¥ç±»å‹äº†ï¼Œç®€å•çš„ select æŸ¥è¯¢ä¸ä¼šå‡ºç°è¿™ç§ typeã€‚ 1 mysql&gt; explain select * from film_actor left join film on film_actor.film_id = film.id; refï¼š ç›¸æ¯” eq_refï¼Œä¸ä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼Œè€Œæ˜¯ä½¿ç”¨æ™®é€šç´¢å¼•æˆ–è€…å”¯ä¸€æ€§ç´¢å¼•çš„éƒ¨åˆ†å‰ç¼€ï¼Œç´¢å¼•è¦å’ŒæŸä¸ªå€¼ç›¸æ¯”è¾ƒï¼Œå¯èƒ½ä¼š æ‰¾åˆ°å¤šä¸ªç¬¦åˆæ¡ä»¶çš„è¡Œã€‚ ç®€å• select æŸ¥è¯¢ï¼Œnameæ˜¯æ™®é€šç´¢å¼•ï¼ˆéå”¯ä¸€ç´¢å¼•ï¼‰ 1 mysql&gt; explain select * from film where name = â€˜film1â€™; 2.å…³è”è¡¨æŸ¥è¯¢ï¼Œidx_film_actor_idæ˜¯film_idå’Œactor_idçš„è”åˆç´¢å¼•ï¼Œè¿™é‡Œä½¿ç”¨åˆ°äº†film_actorçš„å·¦è¾¹å‰ç¼€film_idéƒ¨åˆ†ã€‚ 1 mysql&gt; explain select film_id from film left join film_actor on film.id = film_actor.fi lm_id; rangeï¼š èŒƒå›´æ‰«æé€šå¸¸å‡ºç°åœ¨ in(), between ,&gt; ,&lt;, &gt;= ç­‰æ“ä½œä¸­ã€‚ä½¿ç”¨ä¸€ä¸ªç´¢å¼•æ¥æ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œã€‚ 1 mysql&gt; explain select * from actor where id &gt; 1;indexï¼šæ‰«æå…¨ç´¢å¼•å°±èƒ½æ‹¿åˆ°ç»“æœï¼Œä¸€èˆ¬æ˜¯æ‰«ææŸä¸ªäºŒçº§ç´¢å¼•ï¼Œè¿™ç§æ‰«æä¸ä¼šä»ç´¢å¼•æ ‘æ ¹èŠ‚ç‚¹å¼€å§‹å¿«é€ŸæŸ¥æ‰¾ï¼Œè€Œæ˜¯ç›´æ¥ å¯¹äºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹éå†å’Œæ‰«æï¼Œé€Ÿåº¦è¿˜æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œè¿™ç§æŸ¥è¯¢ä¸€èˆ¬ä¸ºä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•ä¸€èˆ¬æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™ ç§é€šå¸¸æ¯”ALLå¿«ä¸€äº›ã€‚ 1 mysql&gt; explain select * from film; ALLï¼š å³å…¨è¡¨æ‰«æï¼Œæ‰«æä½ çš„èšç°‡ç´¢å¼•çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™éœ€è¦å¢åŠ ç´¢å¼•æ¥è¿›è¡Œä¼˜åŒ–äº†ã€‚ 1 mysql&gt; explain select * from actor; 19.5. possible_keysåˆ— è¿™ä¸€åˆ—æ˜¾ç¤ºæŸ¥è¯¢å¯èƒ½ä½¿ç”¨å“ªäº›ç´¢å¼•æ¥æŸ¥æ‰¾ã€‚ explain æ—¶å¯èƒ½å‡ºç° possible_keys æœ‰åˆ—ï¼Œè€Œ key æ˜¾ç¤º NULL çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µæ˜¯å› ä¸ºè¡¨ä¸­æ•°æ®ä¸å¤šï¼Œmysqlè®¤ä¸ºç´¢å¼• å¯¹æ­¤æŸ¥è¯¢å¸®åŠ©ä¸å¤§ï¼Œé€‰æ‹©äº†å…¨è¡¨æŸ¥è¯¢ã€‚ å¦‚æœè¯¥åˆ—æ˜¯NULLï¼Œåˆ™æ²¡æœ‰ç›¸å…³çš„ç´¢å¼•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ where å­å¥çœ‹æ˜¯å¦å¯ä»¥åˆ›é€ ä¸€ä¸ªé€‚å½“çš„ç´¢å¼•æ¥æ é«˜æŸ¥è¯¢æ€§èƒ½ï¼Œç„¶åç”¨ explain æŸ¥çœ‹æ•ˆæœã€‚ 19.6. keyåˆ— è¿™ä¸€åˆ—æ˜¾ç¤ºmysqlå®é™…é‡‡ç”¨å“ªä¸ªç´¢å¼•æ¥ä¼˜åŒ–å¯¹è¯¥è¡¨çš„è®¿é—®ã€‚ å¦‚æœæ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œåˆ™è¯¥åˆ—æ˜¯ NULLã€‚å¦‚æœæƒ³å¼ºåˆ¶mysqlä½¿ç”¨æˆ–å¿½è§†possible_keysåˆ—ä¸­çš„ç´¢å¼•ï¼Œåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ force indexã€ignore indexã€‚ 19.7. key_lenåˆ— è¿™ä¸€åˆ—æ˜¾ç¤ºäº†mysqlåœ¨ç´¢å¼•é‡Œä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªå€¼å¯ä»¥ç®—å‡ºå…·ä½“ä½¿ç”¨äº†ç´¢å¼•ä¸­çš„å“ªäº›åˆ—ã€‚ ä¸¾ä¾‹æ¥è¯´ï¼Œfilm_actorçš„è”åˆç´¢å¼• idx_film_actor_id ç”± film_id å’Œ actor_id ä¸¤ä¸ªintåˆ—ç»„æˆï¼Œå¹¶ä¸”æ¯ä¸ªintæ˜¯4å­—èŠ‚ã€‚é€š è¿‡ç»“æœä¸­çš„key_len=4å¯æ¨æ–­å‡ºæŸ¥è¯¢ä½¿ç”¨äº†ç¬¬ä¸€ä¸ªåˆ—ï¼šfilm_idåˆ—æ¥æ‰§è¡Œç´¢å¼•æŸ¥æ‰¾ã€‚ 11 mysql&gt; explain select * from film_actor where film_id = 2; key_lenè®¡ç®—è§„åˆ™å¦‚ä¸‹ï¼š å­—ç¬¦ä¸²ï¼Œchar(n)å’Œvarchar(n)ï¼Œ5.0.3ä»¥åç‰ˆæœ¬ä¸­ï¼Œnå‡ä»£è¡¨å­—ç¬¦æ•°ï¼Œè€Œä¸æ˜¯å­—èŠ‚æ•°ï¼Œå¦‚æœæ˜¯utf-8ï¼Œä¸€ä¸ªæ•°å­—æˆ–å­—æ¯å 1ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚ â€‹ char(n)ï¼šå¦‚æœå­˜æ±‰å­—é•¿åº¦å°±æ˜¯ 3n å­—èŠ‚ â€‹ varchar(n)ï¼šå¦‚æœå­˜æ±‰å­—åˆ™é•¿åº¦æ˜¯ 3n + 2 å­—èŠ‚ï¼ŒåŠ çš„2å­—èŠ‚ç”¨æ¥å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ï¼Œå› ä¸ºvarcharæ˜¯å˜é•¿å­—ç¬¦ä¸² æ•°å€¼ç±»å‹ â€‹ tinyintï¼š1å­—èŠ‚ â€‹ smallintï¼š2å­—èŠ‚ â€‹ intï¼š4å­—èŠ‚ â€‹ bigintï¼š8å­—èŠ‚ æ—¶é—´ç±»å‹ â€‹ dateï¼š3å­—èŠ‚timestampï¼š4å­—èŠ‚ â€‹ datetimeï¼š8å­—èŠ‚ å¦‚æœå­—æ®µå…è®¸ä¸º NULLï¼Œéœ€è¦1å­—èŠ‚è®°å½•æ˜¯å¦ä¸º NULL ç´¢å¼•æœ€å¤§é•¿åº¦æ˜¯768å­—èŠ‚ï¼Œå½“å­—ç¬¦ä¸²è¿‡é•¿æ—¶ï¼Œmysqlä¼šåšä¸€ä¸ªç±»ä¼¼å·¦å‰ç¼€ç´¢å¼•çš„å¤„ç†ï¼Œå°†å‰åŠéƒ¨åˆ†çš„å­—ç¬¦æå–å‡ºæ¥åšç´¢å¼•ã€‚ 19.8. refåˆ— è¿™ä¸€åˆ—æ˜¾ç¤ºäº†åœ¨keyåˆ—è®°å½•çš„ç´¢å¼•ä¸­ï¼Œè¡¨æŸ¥æ‰¾å€¼æ‰€ç”¨åˆ°çš„åˆ—æˆ–å¸¸é‡ï¼Œå¸¸è§çš„æœ‰ï¼šconstï¼ˆå¸¸é‡ï¼‰ï¼Œå­—æ®µåï¼ˆä¾‹ï¼šfilm.idï¼‰ 19.9. rowsåˆ— è¿™ä¸€åˆ—æ˜¯mysqlä¼°è®¡è¦è¯»å–å¹¶æ£€æµ‹çš„è¡Œæ•°ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯ç»“æœé›†é‡Œçš„è¡Œæ•°ã€‚ 19.10. Extraåˆ— è¿™ä¸€åˆ—å±•ç¤ºçš„æ˜¯é¢å¤–ä¿¡æ¯ã€‚å¸¸è§çš„é‡è¦å€¼å¦‚ä¸‹ï¼š 1ï¼‰Using indexï¼šä½¿ç”¨è¦†ç›–ç´¢å¼• è¦†ç›–ç´¢å¼•å®šä¹‰ï¼šmysqlæ‰§è¡Œè®¡åˆ’explainç»“æœé‡Œçš„keyæœ‰ä½¿ç”¨ç´¢å¼•ï¼Œå¦‚æœselectåé¢æŸ¥è¯¢çš„å­—æ®µéƒ½å¯ä»¥ä»è¿™ä¸ªç´¢å¼•çš„æ ‘ä¸­è·å–ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬å¯ä»¥è¯´æ˜¯ç”¨åˆ°äº†è¦†ç›–ç´¢å¼•ï¼Œextraé‡Œä¸€èˆ¬éƒ½æœ‰using indexï¼›è¦†ç›–ç´¢å¼•ä¸€èˆ¬é’ˆå¯¹çš„æ˜¯è¾…åŠ©ç´¢å¼•ï¼Œæ•´ä¸ªæŸ¥è¯¢ç»“æœåªé€šè¿‡è¾…åŠ©ç´¢å¼•å°±èƒ½æ‹¿åˆ°ç»“æœï¼Œä¸éœ€è¦é€šè¿‡è¾…åŠ©ç´¢å¼•æ ‘æ‰¾åˆ°ä¸»é”®ï¼Œå†é€šè¿‡ä¸»é”®å»ä¸»é”®ç´¢å¼•æ ‘é‡Œè·å–å…¶å®ƒå­—æ®µå€¼ 11 mysql&gt; explain select film_id from film_actor where film_id = 1; 2ï¼‰Using whereï¼šä½¿ç”¨ where è¯­å¥æ¥å¤„ç†ç»“æœï¼Œå¹¶ä¸”æŸ¥è¯¢çš„åˆ—æœªè¢«ç´¢å¼•è¦†ç›– 11 mysql&gt; explain select * from actor where name = &#x27;a&#x27;; 3ï¼‰Using index conditionï¼šæŸ¥è¯¢çš„åˆ—ä¸å®Œå…¨è¢«ç´¢å¼•è¦†ç›–ï¼Œwhereæ¡ä»¶ä¸­æ˜¯ä¸€ä¸ªå‰å¯¼åˆ—çš„èŒƒå›´ï¼› 11 mysql&gt; explain select * from film_actor where film_id &gt; 1; 4ï¼‰Using temporaryï¼šmysqléœ€è¦åˆ›å»ºä¸€å¼ ä¸´æ—¶è¡¨æ¥å¤„ç†æŸ¥è¯¢ã€‚å‡ºç°è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯è¦è¿›è¡Œä¼˜åŒ–çš„ï¼Œé¦–å…ˆæ˜¯æƒ³åˆ°ç”¨ç´¢ å¼•æ¥ä¼˜åŒ–ã€‚ actor.nameæ²¡æœ‰ç´¢å¼•ï¼Œæ­¤æ—¶åˆ›å»ºäº†å¼ ä¸´æ—¶è¡¨æ¥distinct 11 mysql&gt; explain select distinct name from actor; film.nameå»ºç«‹äº†idx_nameç´¢å¼•ï¼Œæ­¤æ—¶æŸ¥è¯¢æ—¶extraæ˜¯using index,æ²¡æœ‰ç”¨ä¸´æ—¶è¡¨ 11 mysql&gt; explain select distinct name from film; 5ï¼‰Using filesortï¼šå°†ç”¨å¤–éƒ¨æ’åºè€Œä¸æ˜¯ç´¢å¼•æ’åºï¼Œæ•°æ®è¾ƒå°æ—¶ä»å†…å­˜æ’åºï¼Œå¦åˆ™éœ€è¦åœ¨ç£ç›˜å®Œæˆæ’åºã€‚è¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬ä¹Ÿæ˜¯è¦è€ƒè™‘ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–çš„ã€‚ actor.nameæœªåˆ›å»ºç´¢å¼•ï¼Œä¼šæµè§ˆactoræ•´ä¸ªè¡¨ï¼Œä¿å­˜æ’åºå…³é”®å­—nameå’Œå¯¹åº”çš„idï¼Œç„¶åæ’åºnameå¹¶æ£€ç´¢è¡Œè®°å½• 11 mysql&gt; explain select * from actor order by name; film.nameå»ºç«‹äº†idx_nameç´¢å¼•,æ­¤æ—¶æŸ¥è¯¢æ—¶extraæ˜¯using index 11 mysql&gt; explain select * from film order by name; 6ï¼‰Select tables optimized awayï¼šä½¿ç”¨æŸäº›èšåˆå‡½æ•°ï¼ˆæ¯”å¦‚ maxã€minï¼‰æ¥è®¿é—®å­˜åœ¨ç´¢å¼•çš„æŸä¸ªå­—æ®µæ˜¯ 11 mysql&gt; explain select min(id) from film; 20.mysqlä¸»ä»å¤åˆ¶åŸç† masteræäº¤å®Œäº‹åŠ¡åï¼Œå†™å…¥binlog slaveè¿æ¥åˆ°masterï¼Œè·å–binlog masteråˆ›å»ºdumpçº¿ç¨‹ï¼Œæ¨é€binglogåˆ°slave slaveå¯åŠ¨ä¸€ä¸ªIOçº¿ç¨‹è¯»å–åŒæ­¥è¿‡æ¥çš„masterçš„binlogï¼Œè®°å½•åˆ°relay logä¸­ç»§æ—¥å¿—ä¸­ slaveå†å¼€å¯ä¸€ä¸ªsqlçº¿ç¨‹è¯»å–relay logäº‹ä»¶å¹¶åœ¨slaveæ‰§è¡Œï¼Œå®ŒæˆåŒæ­¥ slaveè®°å½•è‡ªå·±çš„binglog 21.ä¸»ä»åŒæ­¥å»¶æ—¶å¦‚ä½•è§£å†³22.éš”ç¦»çº§åˆ«é¦–å…ˆå›å¿†å››ç§mysqléš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ« è¯´æ˜ è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ° è¯»æäº¤ï¼ˆRead committedï¼‰ ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚å‡º äºæ€§èƒ½è€ƒè™‘äº’è”ç½‘å…¬å¸ä¼šä½¿ç”¨RC+ä¹è§‚é” å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰ ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¯¹åŒä¸€ä»½æ•°æ®çš„è¯»å–ç»“æœæ€»æ˜¯ç›¸åŒçš„ï¼Œæ— è®ºæ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡å¯¹è¿™ä»½æ•°æ®è¿›è¡Œæ“ä½œï¼Œä»¥åŠè¿™ä¸ªäº‹åŠ¡æ˜¯å¦æäº¤ã€‚InnoDBé»˜è®¤çº§åˆ«ã€‚ ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰ äº‹åŠ¡ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯æ¬¡è¯»éƒ½éœ€è¦è·å¾—è¡¨çº§å…±äº«é”ï¼Œè¯»å†™ç›¸äº’éƒ½ä¼šé˜»å¡ï¼Œéš”ç¦»çº§åˆ«æœ€é«˜ï¼Œç‰ºç‰²ç³»ç»Ÿå¹¶å‘æ€§ã€‚ æŸ¥çœ‹å½“å‰æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«:show variables like â€˜%tx_isolation%â€™; è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šset tx_isolation=â€™REPEATABLE-READâ€™; ä¸åŒçš„éš”ç¦»çº§åˆ«æ˜¯ä¸ºäº†è§£å†³ä¸åŒçš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è„è¯»ã€å¹»è¯»ã€ä¸å¯é‡å¤è¯»ã€‚ è„è¯»ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²ç»ä¿®æ”¹ä½†å°šæœªæäº¤çš„æ•°æ®ï¼Œã€‚ ä¸å¯é‡å¤è¯»ï¼šäº‹åŠ¡Aå†…éƒ¨çš„ç›¸åŒæŸ¥è¯¢è¯­å¥åœ¨ä¸åŒæ—¶åˆ»è¯»å‡ºçš„ç»“æœä¸ä¸€è‡´ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚ å¹»è¯»ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ ä¸å¯é‡å¤è¯»&amp;&amp;å¹»è¯»åŒºåˆ« ä¸å¯é‡å¤è¯»ï¼Œé‡ç‚¹æ˜¯ä¿®æ”¹ã€‚åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼ŒåŒæ ·çš„æ¡ä»¶ï¼Œç¬¬ä¸€æ¬¡è¯»çš„æ•°æ®å’Œç¬¬äºŒæ¬¡è¯»çš„æ•°æ®ä¸ä¸€æ ·ï¼Œæ•°æ®å˜åŒ– å¹»è¯»ï¼Œé‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤ã€‚åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼ŒåŒæ ·çš„æ¡ä»¶,ï¼Œç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è¯»å‡ºæ¥çš„è®°å½•æ•°ä¸ä¸€æ ·ï¼Œè¡Œæ•°å˜åŒ–ã€‚ éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» è¯»æœªæäº¤ å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° è¯»æäº¤ ä¸å…è®¸å‡ºç° å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° å¯é‡å¤è¯» ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° å¯ä»¥å‡ºç° åºåˆ—åŒ– ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œéš”ç¦»æ€§æ˜¯é é”æœºåˆ¶å’ŒMVCCå…±åŒå®ç°çš„ã€‚ 23.RCå’ŒRRçš„æœ¬è´¨åŒºåˆ«ã€‚readviewå±‚é¢RCçº§åˆ«ä¸‹æ¯æ¬¡éƒ½æ˜¯é‡æ–°ç”Ÿæˆread viewï¼Œè€Œåœ¨RRçº§åˆ«ä¸‹åˆ™æ˜¯ä¸€ç›´ä½¿ç”¨äº‹åŠ¡å†…ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶äº§ç”Ÿçš„read viewã€‚ 24.ä»€ä¹ˆæ˜¯readviewReadViewå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œåœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™ä¼šæ ¹æ®äº‹åŠ¡é“¾è¡¨æ„é€ ä¸€ä¸ªReadView,åˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹ï¼š 12345678910111213// readview åˆå§‹åŒ–// m_low_limit_id = trx_sys-&gt;max_trx_id; // m_up_limit_id = !m_ids.empty() ? m_ids.front() : m_low_limit_id;ReadView::ReadView() : m_low_limit_id(), m_up_limit_id(), m_creator_trx_id(), m_ids(), m_low_limit_no()&#123; ut_d(::memset(&amp;m_view_list, 0x0, sizeof(m_view_list)));&#125; trx_ids: è¡¨ç¤ºäº‹åŠ¡å¼€å¯çš„æ—¶å€™, å…¶å®ƒæœªæäº¤çš„æ´»è·ƒçš„äº‹åŠ¡ID. è¿™ä¸ªé›†åˆä¸­çš„äº‹åŠ¡å¯¹äºå½“å‰äº‹åŠ¡æ¥è¯´, ä¸€ç›´éƒ½æ˜¯ä¸å¯è§çš„. low_limit_id: è¡¨ç¤ºåœ¨ç”ŸæˆReadViewæ—¶å½“å‰ç³»ç»Ÿä¸­æœ€å¤§äº‹åŠ¡id. up_limit_id: è¡¨ç¤ºæœªæäº¤æ´»è·ƒäº‹åŠ¡Id(trx_ids)çš„æœ€å¤§å€¼. å¦‚æœtrx_idsä¸ºç©º, åˆ™up_limit_id=low_limit_id. é€šè¿‡è¯¥ReadViewï¼Œæ–°çš„äº‹åŠ¡å¯ä»¥æ ¹æ®æŸ¥è¯¢åˆ°çš„æ‰€æœ‰æ´»è·ƒäº‹åŠ¡è®°å½•çš„äº‹åŠ¡IDæ¥åŒ¹é…èƒ½å¤Ÿçœ‹è§è¯¥è®°å½•ï¼Œä»è€Œå®ç°æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»ï¼Œä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š é€šè¿‡èšç°‡ç´¢å¼•çš„è¡Œç»“æ„ä¸­DB_TRX_IDéšè—å­—æ®µå¯ä»¥çŸ¥é“æœ€è¿‘è¢«å“ªä¸ªäº‹åŠ¡IDä¿®æ”¹è¿‡ã€‚ä¸€ä¸ªæ–°çš„äº‹åŠ¡å¼€å§‹æ—¶ä¼šæ ¹æ®äº‹åŠ¡é“¾è¡¨æ„é€ ä¸€ä¸ªReadViewã€‚å½“å‰äº‹åŠ¡æ ¹æ®ReadViewä¸­çš„æ•°æ®å»è·Ÿæ£€ç´¢åˆ°çš„æ¯ä¸€æ¡æ•°æ®å»æ ¡éªŒ,çœ‹çœ‹å½“å‰äº‹åŠ¡æ˜¯ä¸æ˜¯èƒ½çœ‹åˆ°è¿™æ¡æ•°æ® 1234567891011121314151617181920212223242526// åˆ¤æ–­æ•°æ®å¯¹åº”çš„èšç°‡ç´¢å¼•ä¸­çš„äº‹åŠ¡idåœ¨è¿™ä¸ªreadviewä¸­æ˜¯å¦å¯è§bool changes_visible( trx_id_t id, // è®°å½•çš„id const table_name_t&amp; name) constMY_ATTRIBUTE((warn_unused_result))&#123; ut_ad(id &gt; 0); // å¦‚æœå½“å‰è®°å½•id &lt; äº‹åŠ¡é“¾è¡¨çš„æœ€å°å€¼æˆ–è€…ç­‰äºåˆ›å»ºè¯¥readviewçš„idå°±æ˜¯å®ƒè‡ªå·±,é‚£ä¹ˆæ˜¯å¯è§çš„ if (id &lt; m_up_limit_id || id == m_creator_trx_id) &#123; return(true); &#125; check_trx_id_sanity(id, name); // å¦‚æœè¯¥è®°å½•çš„äº‹åŠ¡idå¤§äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å¤§å€¼,é‚£ä¹ˆä¸å¯è§ if (id &gt;= m_low_limit_id) &#123; return(false); // å¦‚æœäº‹åŠ¡é“¾è¡¨æ˜¯ç©ºçš„,é‚£ä¹Ÿæ˜¯å¯è§çš„ &#125; else if (m_ids.empty()) &#123; return(true); &#125; const ids_t::value_type* p = m_ids.data(); //åˆ¤æ–­æ˜¯å¦åœ¨ReadViewä¸­ï¼Œå¦‚æœåœ¨è¯´æ˜åœ¨åˆ›å»ºReadViewæ—¶ æ­¤æ¡è®°å½•è¿˜å¤„äºæ´»è·ƒçŠ¶æ€åˆ™ä¸åº”è¯¥æŸ¥è¯¢åˆ°ï¼Œå¦åˆ™è¯´æ˜åˆ›å»ºReadViewæ˜¯æ­¤æ¡è®°å½•å·²ç»æ˜¯ä¸æ´»è·ƒçŠ¶æ€åˆ™å¯ä»¥æŸ¥è¯¢åˆ° return(!std::binary_search(p, p + m_ids.size(), id));&#125; å¯è§æ€§ç®—æ³•é€»è¾‘æ€»ç»“ï¼š å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDå°äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å°å€¼(æ•°æ®è¡Œçš„DB_TRX_ID &lt; m_up_limit_id)è¡¨ç¤ºè¿™ä¸ªæ•°æ®åœ¨å½“å‰äº‹åŠ¡å¼€å¯å‰å°±å·²ç»è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹è¿‡äº†,æ‰€ä»¥æ˜¯å¯è§çš„ã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDè¡¨ç¤ºçš„æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ä¿®æ”¹çš„æ•°æ®(æ•°æ®è¡Œçš„DB_TRX_ID = m_creator_trx_id) æ—¶ï¼Œæ•°æ®å¯è§ã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDå¤§äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å¤§å€¼(æ•°æ®è¡Œçš„DB_TRX_ID &gt;= m_low_limit_id) è¡¨ç¤ºè¿™ä¸ªæ•°æ®åœ¨å½“å‰äº‹åŠ¡å¼€å¯ååˆ°ä¸‹ä¸€æ¬¡æŸ¥è¯¢ä¹‹é—´åˆè¢«å…¶ä»–çš„äº‹åŠ¡ä¿®æ”¹è¿‡,é‚£ä¹ˆå°±æ˜¯ä¸å¯è§çš„ã€‚ å¦‚æœäº‹åŠ¡é“¾è¡¨ä¸ºç©º,é‚£ä¹ˆä¹Ÿæ˜¯å¯è§çš„,ä¹Ÿå°±æ˜¯å½“å‰äº‹åŠ¡å¼€å§‹çš„æ—¶å€™,æ²¡æœ‰å…¶ä»–ä»»æ„ä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDåœ¨äº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹é—´ï¼Œä»m_low_limit_idåˆ°m_up_limit_idè¿›è¡Œéå†ï¼Œå–å‡ºDB_ROLL_PTRæŒ‡é’ˆæ‰€æŒ‡å‘çš„å›æ»šæ®µçš„äº‹åŠ¡IDï¼ŒæŠŠå®ƒèµ‹å€¼ç»™ trx_id_current ï¼Œç„¶åä»æ­¥éª¤1é‡æ–°å¼€å§‹åˆ¤æ–­ï¼Œè¿™æ ·æ€»èƒ½æœ€åæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„è®°å½•ã€‚ 25.å¿«ç…§è¯»ä¸å½“å‰è¯»çš„åŒºåˆ«å¯¹äºè¿™ç§è¯»å–å†å²æ•°æ®çš„æ–¹å¼ï¼Œæˆ‘ä»¬å«å®ƒå¿«ç…§è¯» (snapshot read)ï¼Œè€Œè¯»å–æ•°æ®åº“å½“å‰ç‰ˆæœ¬æ•°æ®çš„æ–¹å¼ï¼Œå«å½“å‰è¯» (current read)ã€‚å¾ˆæ˜¾ç„¶ï¼Œåœ¨MVCCä¸­ï¼š å¿«ç…§è¯»ï¼šå°±æ˜¯select select * from table â€¦.; å½“å‰è¯»ï¼šç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œï¼Œå±äºå½“å‰è¯»ï¼Œå¤„ç†çš„éƒ½æ˜¯å½“å‰çš„æ•°æ®ï¼Œéœ€è¦åŠ é”ã€‚ select * from table where ? lock in share mode; select * from table where ? for update; insert; update ; delete; 26.å¹»è¯»å’Œä¸å¯é‡å¤è¯»åŒºåˆ«ä¸å¯é‡å¤è¯»ï¼Œé‡ç‚¹æ˜¯ä¿®æ”¹ã€‚åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼ŒåŒæ ·çš„æ¡ä»¶ï¼Œç¬¬ä¸€æ¬¡è¯»çš„æ•°æ®å’Œç¬¬äºŒæ¬¡è¯»çš„æ•°æ®ä¸ä¸€æ ·ï¼Œæ•°æ®å˜åŒ– å¹»è¯»ï¼Œé‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤ã€‚åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼ŒåŒæ ·çš„æ¡ä»¶,ï¼Œç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è¯»å‡ºæ¥çš„è®°å½•æ•°ä¸ä¸€æ ·ï¼Œè¡Œæ•°å˜åŒ–ã€‚ 27.MySQLåœ¨RRçº§åˆ«ä¸­å®Œå…¨è§£å†³äº†å¹»è¯»çš„é—®é¢˜ä¹ˆï¼Ÿ28.è„é¡µæ˜¯ä»€ä¹ˆï¼Œåˆ·è„é¡µæ—¶æœº29.bufferpool30.å‡ å¤§æ ¸å¿ƒçº¿ç¨‹purgeçº¿ç¨‹ å¯¹äºä¸€æ¡deleteè¯­å¥ delete from t where a = 1ï¼Œå¦‚æœåˆ—aæœ‰èšé›†ç´¢å¼•ï¼Œåˆ™ä¸ä¼šè¿›è¡ŒçœŸæ­£çš„åˆ é™¤ï¼Œè€Œåªæ˜¯åœ¨ä¸»é”®åˆ—ç­‰äº1çš„è®°å½•delete flagè®¾ç½®ä¸º1ï¼Œå³è®°å½•è¿˜æ˜¯å­˜åœ¨åœ¨B+æ ‘ä¸­ã€‚è€Œå¯¹äºupdateæ“ä½œï¼Œä¸æ˜¯ç›´æ¥å¯¹è®°å½•è¿›è¡Œæ›´æ–°ï¼Œè€Œæ˜¯æ ‡è¯†æ—§è®°å½•ä¸ºåˆ é™¤çŠ¶æ€ï¼Œç„¶åæ–°äº§ç”Ÿä¸€æ¡è®°å½•ã€‚é‚£è¿™äº›æ—§ç‰ˆæœ¬æ ‡è¯†ä½åˆ é™¤çš„è®°å½•ä½•æ—¶çœŸæ­£çš„åˆ é™¤ï¼Ÿæ€ä¹ˆåˆ é™¤ï¼Ÿ å…¶å®InnoDBæ˜¯é€šè¿‡undoæ—¥å¿—æ¥è¿›è¡Œæ—§ç‰ˆæœ¬çš„åˆ é™¤æ“ä½œçš„ï¼Œåœ¨InnoDBå†…éƒ¨ï¼Œè¿™ä¸ªæ“ä½œè¢«ç§°ä¹‹ä¸ºpurgeæ“ä½œï¼ŒåŸæ¥åœ¨srv_master_threadä¸»çº¿ç¨‹ä¸­å®Œæˆï¼Œåæ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¼€è¾Ÿäº†purgeçº¿ç¨‹è¿›è¡Œpurgeæ“ä½œï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®purgeçº¿ç¨‹çš„æ•°é‡ã€‚purgeæ“ä½œæ¯10sè¿›è¡Œä¸€æ¬¡ã€‚ ä¸ºäº†èŠ‚çœå­˜å‚¨ç©ºé—´ï¼ŒInnoDBå­˜å‚¨å¼•æ“çš„undo logè®¾è®¡æ˜¯è¿™æ ·çš„ï¼šä¸€ä¸ªé¡µä¸Šå…è®¸å¤šä¸ªäº‹åŠ¡çš„undo logå­˜åœ¨ã€‚è™½ç„¶è¿™ä¸ä»£è¡¨äº‹åŠ¡åœ¨å…¨å±€è¿‡ç¨‹ä¸­æäº¤çš„é¡ºåºï¼Œä½†æ˜¯åé¢çš„äº‹åŠ¡äº§ç”Ÿçš„undo logæ€»åœ¨æœ€åã€‚æ­¤å¤–ï¼ŒInnoDBå­˜å‚¨å¼•æ“è¿˜æœ‰ä¸€ä¸ªhistoryåˆ—è¡¨ï¼Œå®ƒæ ¹æ®äº‹åŠ¡æäº¤çš„é¡ºåºï¼Œå°†undo logè¿›è¡Œè¿æ¥ï¼Œå¦‚ä¸‹é¢çš„ä¸€ç§æƒ…å†µï¼š åœ¨æ‰§è¡Œpurgeè¿‡ç¨‹ä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“é¦–å…ˆä»history listä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªéœ€è¦è¢«æ¸…ç†çš„è®°å½•ï¼Œè¿™é‡Œä¸ºtrx1ï¼Œæ¸…ç†ä¹‹åInnoDBå­˜å‚¨å¼•æ“ä¼šåœ¨trx1æ‰€åœ¨çš„Undo pageä¸­ç»§ç»­å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¯ä»¥è¢«æ¸…ç†çš„è®°å½•ï¼Œè¿™é‡Œä¼šæ‰¾åˆ°äº‹åŠ¡trx3ï¼Œæ¥ç€æ‰¾åˆ°trx5ï¼Œä½†æ˜¯å‘ç°trx5è¢«å…¶ä»–äº‹åŠ¡æ‰€å¼•ç”¨è€Œä¸èƒ½æ¸…ç†ï¼Œæ•…å†å»history listä¸­å–æŸ¥æ‰¾ï¼Œå‘ç°æœ€å°¾ç«¯çš„è®°å½•æ—¶trx2ï¼Œæ¥ç€æ‰¾åˆ°trx2æ‰€åœ¨çš„Undo pageï¼Œä¾æ¬¡æŠŠtrx6ã€trx4æ¸…ç†ï¼Œç”±äºUndo page2ä¸­æ‰€æœ‰çš„è®°å½•éƒ½è¢«æ¸…ç†äº†ï¼Œå› æ­¤è¯¥Undo pageå¯ä»¥è¿›è¡Œé‡ç”¨ã€‚ InnoDBå­˜å‚¨å¼•æ“è¿™ç§å…ˆä»history listä¸­æ‰¾undo logï¼Œç„¶åå†ä»Undo pageä¸­æ‰¾undo logçš„è®¾è®¡æ¨¡å¼æ˜¯ä¸ºäº†é¿å…å¤§é‡éšæœºè¯»æ“ä½œï¼Œä»è€Œæé«˜purgeçš„æ•ˆç‡ã€‚ 31.äº‹åŠ¡ä¼ æ’­æœºåˆ¶32.åˆ†å¸ƒå¼äº‹åŠ¡é€šç”¨æ–¹æ¡ˆ33.æˆæœ¬åˆ†æ34.è¡¨ä¸­æ•°æ®é‡å¦‚ä½•è®¡ç®—æ€»é‡35.count(1) count(*) count(id) count(å­—æ®µ) æ€§èƒ½å¯¹æ¯”åˆ†æå››ä¸ªsqlçš„æ‰§è¡Œè®¡åˆ’ä¸€æ ·ï¼Œè¯´æ˜è¿™å››ä¸ªsqlæ‰§è¡Œæ•ˆç‡åº”è¯¥å·®ä¸å¤š å­—æ®µæœ‰ç´¢å¼•ï¼šcount(*)â‰ˆcount(1)&gt;count(å­—æ®µ)&gt;count(ä¸»é”® id) //å­—æ®µæœ‰ç´¢å¼•ï¼Œcount(å­—æ®µ)ç»Ÿè®¡èµ°äºŒçº§ç´¢å¼•ï¼ŒäºŒ çº§ç´¢å¼•å­˜å‚¨æ•°æ®æ¯”ä¸»é”®ç´¢å¼•å°‘ï¼Œæ‰€ä»¥count(å­—æ®µ)&gt;count(ä¸»é”® id) å­—æ®µæ— ç´¢å¼•ï¼šcount(*)â‰ˆcount(1)&gt;count(ä¸»é”® id)&gt;count(å­—æ®µ) //å­—æ®µæ²¡æœ‰ç´¢å¼•count(å­—æ®µ)ç»Ÿè®¡èµ°ä¸äº†ç´¢å¼•ï¼Œ count(ä¸»é”® id)è¿˜å¯ä»¥èµ°ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥count(ä¸»é”® id)&gt;count(å­—æ®µ) count(1)è·Ÿcount(å­—æ®µ)æ‰§è¡Œè¿‡ç¨‹ç±»ä¼¼ï¼Œä¸è¿‡count(1)ä¸éœ€è¦å–å‡ºå­—æ®µç»Ÿè®¡ï¼Œå°±ç”¨å¸¸é‡1åšç»Ÿè®¡ï¼Œcount(å­—æ®µ)è¿˜éœ€è¦å–å‡º å­—æ®µï¼Œæ‰€ä»¥ç†è®ºä¸Šcount(1)æ¯”count(å­—æ®µ)ä¼šå¿«ä¸€ç‚¹ã€‚ count(*) æ˜¯ä¾‹å¤–ï¼Œmysqlå¹¶ä¸ä¼šæŠŠå…¨éƒ¨å­—æ®µå–å‡ºæ¥ï¼Œè€Œæ˜¯ä¸“é—¨åšäº†ä¼˜åŒ–ï¼Œä¸å–å€¼ï¼ŒæŒ‰è¡Œç´¯åŠ ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”¨ count(åˆ—å)æˆ–count(å¸¸é‡)æ¥æ›¿ä»£ count(*)ã€‚ ä¸ºä»€ä¹ˆå¯¹äºcount(id)ï¼Œmysqlæœ€ç»ˆé€‰æ‹©è¾…åŠ©ç´¢å¼•è€Œä¸æ˜¯ä¸»é”®èšé›†ç´¢å¼•ï¼Ÿå› ä¸ºäºŒçº§ç´¢å¼•ç›¸å¯¹ä¸»é”®ç´¢å¼•å­˜å‚¨æ•°æ®æ›´å°‘ï¼Œæ£€ç´¢ æ€§èƒ½åº”è¯¥æ›´é«˜ï¼Œmysqlå†…éƒ¨åšäº†ç‚¹ä¼˜åŒ–(åº”è¯¥æ˜¯åœ¨5.7ç‰ˆæœ¬æ‰ä¼˜åŒ–)ã€‚ 36.mysqlä¸­in å’Œexists åŒºåˆ«37.joinæŸ¥è¯¢åŸç†38.ç´¢å¼•ä¸‹æ¨ç´¢å¼•ä¸‹æ¨ï¼ˆIndex Condition Pushdownï¼ŒICP), like KK%å…¶å®å°±æ˜¯ç”¨åˆ°äº†ç´¢å¼•ä¸‹æ¨ä¼˜åŒ– ä»€ä¹ˆæ˜¯ç´¢å¼•ä¸‹æ¨äº†ï¼Ÿ å¯¹äºè¾…åŠ©çš„è”åˆç´¢å¼•(name,age,position)ï¼Œæ­£å¸¸æƒ…å†µæŒ‰ç…§æœ€å·¦å‰ç¼€åŸåˆ™ï¼ŒSELECT * FROM employees WHERE name like â€˜LiLei%â€™ AND age = 22 AND position =â€™managerâ€™ è¿™ç§æƒ…å†µåªä¼šèµ°nameå­—æ®µç´¢å¼•ï¼Œå› ä¸ºæ ¹æ®nameå­—æ®µè¿‡æ»¤å®Œï¼Œå¾—åˆ°çš„ç´¢å¼•è¡Œé‡Œçš„ageå’Œ positionæ˜¯æ— åºçš„ï¼Œæ— æ³•å¾ˆå¥½çš„åˆ©ç”¨ç´¢å¼•ã€‚ åœ¨MySQL5.6ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªæŸ¥è¯¢åªèƒ½åœ¨è”åˆç´¢å¼•é‡ŒåŒ¹é…åˆ°åå­—æ˜¯ â€˜LiLeiâ€™ å¼€å¤´çš„ç´¢å¼•ï¼Œç„¶åæ‹¿è¿™äº›ç´¢å¼•å¯¹åº”çš„ä¸»é”®é€ä¸ªå›è¡¨ï¼Œåˆ°ä¸»é”®ç´¢ å¼•ä¸Šæ‰¾å‡ºç›¸åº”çš„è®°å½•ï¼Œå†æ¯”å¯¹ageå’Œpositionè¿™ä¸¤ä¸ªå­—æ®µçš„å€¼æ˜¯å¦ç¬¦åˆã€‚ MySQL 5.6å¼•å…¥äº†ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–ï¼Œå¯ä»¥åœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„æ‰€æœ‰å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„è®°å½•ä¹‹åå†å›è¡¨ï¼Œå¯ ä»¥æœ‰æ•ˆçš„å‡å°‘å›è¡¨æ¬¡æ•°ã€‚ä½¿ç”¨äº†ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–åï¼Œä¸Šé¢é‚£ä¸ªæŸ¥è¯¢åœ¨è”åˆç´¢å¼•é‡ŒåŒ¹é…åˆ°åå­—æ˜¯ â€˜LiLeiâ€™ å¼€å¤´çš„ç´¢å¼•ä¹‹åï¼ŒåŒæ—¶è¿˜ä¼šåœ¨ç´¢å¼•é‡Œè¿‡ æ»¤ageå’Œpositionè¿™ä¸¤ä¸ªå­—æ®µï¼Œæ‹¿ç€è¿‡æ»¤å®Œå‰©ä¸‹çš„ç´¢å¼•å¯¹åº”çš„ä¸»é”®idå†å›è¡¨æŸ¥æ•´è¡Œæ•°æ®ã€‚ ç´¢å¼•ä¸‹æ¨ä¼šå‡å°‘å›è¡¨æ¬¡æ•°ï¼Œå¯¹äºinnodbå¼•æ“çš„è¡¨ç´¢å¼•ä¸‹æ¨åªèƒ½ç”¨äºäºŒçº§ç´¢å¼•ï¼Œinnodbçš„ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰æ ‘å¶å­èŠ‚ç‚¹ä¸Šä¿å­˜çš„æ˜¯å…¨ è¡Œæ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ç´¢å¼•ä¸‹æ¨å¹¶ä¸ä¼šèµ·åˆ°å‡å°‘æŸ¥è¯¢å…¨è¡Œæ•°æ®çš„æ•ˆæœã€‚ ä¸ªäººç†è§£å‡åï¼š æˆ‘è§‰å¾—likeæ˜¯è¿™æ ·ï¼Œç”¨åˆ°ç´¢å¼•ä¸‹æ¨çš„åœºæ™¯ï¼Œç›´æ¥åˆ©ç”¨ä¸‰ä¸ªç´¢å¼•éƒ½è¿‡æ»¤ç©ï¼Œç„¶åå›è¡¨æŸ¥æ•°æ®; å…³é—­ç´¢å¼•ä¸‹æ¨ï¼Œåˆ©ç”¨çš„ç¬¬ä¸€ä¸ªç´¢å¼•å®Œæˆè¿‡æ»¤ï¼Œç›´æ¥å›è¡¨ï¼Œç„¶åç»§ç»­åœ¨serverå±‚å¯¹ç¬¬äºŒä¸‰å­—æ®µè¿‡æ»¤,éƒ½æ˜¯ç”¨åˆ°äº†ä¸‰ä¸ªå­—æ®µï¼Œä½†æ˜¯ç¬¬äºŒä¸‰ä¸ªå­—æ®µç”¨çš„åœ°æ–¹ä¸ä¸€æ · ä¸ºä»€ä¹ˆèŒƒå›´æŸ¥æ‰¾Mysqlæ²¡æœ‰ç”¨ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–ï¼Ÿ ç„¶åç†è®ºä¸Šlikeå’Œå¤§äºå°äºéƒ½æ˜¯rangeç±»å‹ï¼Œåªä¸è¿‡å¤§äºå°äºè¿™ç§æœ‰ç‚¹æ­£è´Ÿæ— ç©·çš„æ„Ÿè§‰ï¼Œæ‰€ä»¥mysqlæ²¡æœ‰ç‰¹æ®Šå¤„ç†ï¼Œlike â€˜xx%â€™ mysqlé»˜è®¤è®¤ä¸ºèŒƒå›´å¯æ§ï¼Œå°±ä½¿ç”¨åˆšæ‰çš„é€»è¾‘æ¥å¤„ç†ï¼Œå½“ç„¶è¿™ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œæœ‰æ—¶like KK% ä¹Ÿä¸ä¸€å®šå°±ä¼šèµ°ç´¢å¼•ä¸‹æ¨ã€‚ 39.ä¸¤ç§æ’åºæ–¹å¼1ã€MySQLæ”¯æŒä¸¤ç§æ–¹å¼çš„æ’åºfilesortå’Œindexï¼ŒUsing indexæ˜¯æŒ‡MySQLæ‰«æç´¢å¼•æœ¬èº«å®Œæˆæ’åºã€‚index æ•ˆç‡é«˜ï¼Œfilesortæ•ˆç‡ä½ã€‚ 40.filesortæ’åºåŸç†Using filesortæ–‡ä»¶æ’åºåŸç†è¯¦è§£ filesortæ–‡ä»¶æ’åºæ–¹å¼ å•è·¯æ’åºï¼šæ˜¯ä¸€æ¬¡æ€§å–å‡ºæ»¡è¶³æ¡ä»¶è¡Œçš„æ‰€æœ‰å­—æ®µï¼Œç„¶ååœ¨sort bufferä¸­è¿›è¡Œæ’åºï¼›ç”¨traceå·¥å…·å¯ ä»¥çœ‹åˆ°sort_modeä¿¡æ¯é‡Œæ˜¾ç¤º&lt; sort_key, additional_fields &gt;æˆ–è€…&lt; sort_key, packed_additional_fields &gt; åŒè·¯æ’åºï¼ˆåˆå«å›è¡¨æ’åºæ¨¡å¼ï¼‰ï¼šæ˜¯é¦–å…ˆæ ¹æ®ç›¸åº”çš„æ¡ä»¶å–å‡ºç›¸åº”çš„æ’åºå­—æ®µå’Œå¯ä»¥ç›´æ¥å®šä½è¡Œ æ•°æ®çš„è¡Œ IDï¼Œç„¶ååœ¨ sort buffer ä¸­è¿›è¡Œæ’åºï¼Œæ’åºå®Œåéœ€è¦å†æ¬¡å–å›å…¶å®ƒéœ€è¦çš„å­—æ®µï¼›ç”¨traceå·¥å…· å¯ä»¥çœ‹åˆ°sort_modeä¿¡æ¯é‡Œæ˜¾ç¤º&lt; sort_key, rowid &gt; MySQL é€šè¿‡æ¯”è¾ƒç³»ç»Ÿå˜é‡ max_length_for_sort_data(é»˜è®¤1024å­—èŠ‚) çš„å¤§å°å’Œéœ€è¦æŸ¥è¯¢çš„å­—æ®µæ€»å¤§å°æ¥ 41.filesortåˆ¤æ–­ä½¿ç”¨å“ªç§æ’åºæ¨¡å¼ã€‚ ï¼ˆå•è·¯oråŒè·¯ï¼‰å¦‚æœ å­—æ®µçš„æ€»é•¿åº¦å°äºmax_length_for_sort_data ï¼Œé‚£ä¹ˆä½¿ç”¨ å•è·¯æ’åºæ¨¡å¼ï¼› å¦‚æœ å­—æ®µçš„æ€»é•¿åº¦å¤§äºmax_length_for_sort_data ï¼Œé‚£ä¹ˆä½¿ç”¨ åŒè·¯æ’åºæ¨¡âˆ™å¼ã€‚ 40.å•è·¯æ’åºã€åŒè·¯æ’åºè¯¦ç»†è¿‡ç¨‹æˆ‘ä»¬å…ˆçœ‹å•è·¯æ’åºçš„è¯¦ç»†è¿‡ç¨‹ï¼š ä»ç´¢å¼•nameæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³ name = â€˜zhugeâ€™ æ¡ä»¶çš„ä¸»é”® id æ ¹æ®ä¸»é”® id å–å‡ºæ•´è¡Œï¼Œå–å‡ºæ‰€æœ‰å­—æ®µçš„å€¼ï¼Œå­˜å…¥ sort_buffer ä¸­ ä»ç´¢å¼•nameæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ»¡è¶³ name = â€˜zhugeâ€™ æ¡ä»¶çš„ä¸»é”® id é‡å¤æ­¥éª¤ 2ã€3 ç›´åˆ°ä¸æ»¡è¶³ name = â€˜zhugeâ€™ å¯¹ sort_buffer ä¸­çš„æ•°æ®æŒ‰ç…§å­—æ®µ position è¿›è¡Œæ’åº è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ æˆ‘ä»¬å†çœ‹ä¸‹åŒè·¯æ’åºçš„è¯¦ç»†è¿‡ç¨‹ï¼š ä»ç´¢å¼• name æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³ name = â€˜zhugeâ€™ çš„ä¸»é”®id æ ¹æ®ä¸»é”® id å–å‡ºæ•´è¡Œï¼ŒæŠŠæ’åºå­—æ®µ position å’Œä¸»é”® id è¿™ä¸¤ä¸ªå­—æ®µæ”¾åˆ° sort buffer ä¸­ ä»ç´¢å¼• name å–ä¸‹ä¸€ä¸ªæ»¡è¶³ name = â€˜zhugeâ€™ è®°å½•çš„ä¸»é”® id é‡å¤ 3ã€4 ç›´åˆ°ä¸æ»¡è¶³ name = â€˜zhugeâ€™ å¯¹ sort_buffer ä¸­çš„å­—æ®µ position å’Œä¸»é”® id æŒ‰ç…§å­—æ®µ position è¿›è¡Œæ’åº éå†æ’åºå¥½çš„ id å’Œå­—æ®µ positionï¼ŒæŒ‰ç…§ id çš„å€¼å›åˆ°åŸè¡¨ä¸­å–å‡º æ‰€æœ‰å­—æ®µçš„å€¼è¿”å›ç»™å®¢æˆ·ç«¯ å…¶å®å¯¹æ¯”ä¸¤ä¸ªæ’åºæ¨¡å¼ï¼Œå•è·¯æ’åºä¼šæŠŠæ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µéƒ½æ”¾åˆ° sort buffer ä¸­ï¼Œè€ŒåŒè·¯æ’åºåªä¼šæŠŠä¸»é”®å’Œéœ€è¦æ’åºçš„å­—æ®µæ”¾åˆ° sort buffer ä¸­è¿›è¡Œæ’åºï¼Œç„¶åå†é€šè¿‡ä¸»é”®å›åˆ°åŸè¡¨æŸ¥è¯¢éœ€è¦çš„å­—æ®µã€‚ 41.ä¸‰æ˜Ÿç´¢å¼•å¯¹äºä¸€ä¸ªæŸ¥è¯¢è€Œè¨€ï¼Œä¸€ä¸ªä¸‰æ˜Ÿç´¢å¼•ï¼Œå¯èƒ½æ˜¯å…¶æœ€å¥½çš„ç´¢å¼•ã€‚ ç´¢å¼•å°†ç›¸å…³çš„è®°å½•æ”¾åˆ°ä¸€èµ·åˆ™è·å¾—ä¸€æ˜Ÿï¼› å¦‚æœç´¢å¼•ä¸­çš„æ•°æ®é¡ºåºå’ŒæŸ¥æ‰¾ä¸­çš„æ’åˆ—é¡ºåºä¸€è‡´åˆ™è·å¾—äºŒæ˜Ÿï¼› å¦‚æœç´¢å¼•ä¸­çš„åˆ—åŒ…å«äº†æŸ¥è¯¢ä¸­éœ€è¦çš„å…¨éƒ¨åˆ—åˆ™è·å¾—ä¸‰æ˜Ÿã€‚ 42.åœºæ™¯é¢˜æ–°å»ºä¸€å¼ æ•°æ®è¡¨userï¼Œåç»­æ‰€æœ‰æ“ä½œéƒ½ä¾æ‰˜äºåˆå§‹åŒ–çš„è¿™ä¸‰æ¡æ•°æ®ã€‚ id name age 1 zhangsan 1 2 lisi 5 3 wangwu 10 æ“ä½œ1ï¼š æ—¶åˆ» t1 t2 1 begin begin 2 update user set name=â€™zhangsan2â€™ where age=1;commit; 3 select * from user where age=1; æ­¤æ—¶ä¸ç®¡æ˜¯RCè¿˜æ˜¯RRï¼Œt1çš„selectéƒ½èƒ½å¤Ÿè¯»å–åˆ°t2updateçš„å€¼ å› ä¸ºåœ¨t1selectçš„æ—¶åˆ»æ‰ä¼šå»ç”Ÿæˆread viewï¼Œæ ¹æ®å¯è§æ€§ç®—æ³•å¾—å‡ºèƒ½çœ‹åˆ°æœ€æ–°çš„t2æ•°æ® æ“ä½œ2: æ—¶åˆ» t1 t2 1 begin begin 2 select * from user where age=1; 3 update user set name=â€™zhangsan2â€™ where age=1;commit; 4 select * from user where age=1; æ­¤æ—¶RCçº§åˆ«ä¸‹ï¼Œt1çš„ ç¬¬äºŒæ¬¡selectèƒ½å¤ŸæŸ¥çœ‹åˆ°t2updateçš„å€¼ï¼Œå› ä¸ºRCçº§åˆ«ä¸‹æ¯æ¬¡selectéƒ½ä¼šç”Ÿæˆæ–°çš„read view åœ¨RRçº§åˆ«ä¸‹ï¼Œt1çš„ ç¬¬äºŒæ¬¡ä¸èƒ½æŸ¥è¯¢åˆ°t2updateçš„å€¼ï¼Œå› ä¸ºRRçº§åˆ«ä¸‹çš„åé¢æŸ¥è¯¢éƒ½æ˜¯ä½¿ç”¨çš„ç¬¬ä¸€æ¬¡selectç”Ÿæˆçš„read view åŒç†ï¼Œt2è¯­å¥ä¸ºinsertæ—¶ä¹Ÿæ˜¯ä¸€æ ·çš„æƒ…å†µã€‚ æ“ä½œ3: æ—¶åˆ» t1 t2 1 begin begin update user set name=â€™zhangsan2â€™ where age=1; 3 insert into user values (4,â€™hahaâ€™,3);waiting~~~ 5 commit; 6 æ’å…¥æˆåŠŸcommit; RRçº§åˆ«ä¸‹ï¼Œt1è¿›è¡Œå½“å‰è¯»æ—¶ï¼Œä¼šå¯¹æ•°æ®åŠ é”ï¼Œå…·ä½“æ˜¯é—´éš™é”ï½œè¡Œé”ï½œnext-keyï¼Œåé¢ç»†è¯´ï¼Œæ­¤æ—¶t2çš„æ’å…¥ä¼šwaitingï¼Œç›´åˆ°t1é‡Šæäº¤äº‹åŠ¡ï¼Œæ¥è§£å†³insertæƒ…å†µä¸‹çš„å¹»è¯»é—®é¢˜ é‚£ä¹ˆï¼Œæ„Ÿè§‰RRå°±å·²ç»è§£å†³äº†å¹»è¯»ï¼Œä¸ºå•¥è¿˜éœ€è¦ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰ï¼Ÿï¼Ÿï¼Ÿ æ“ä½œ4: æ—¶åˆ» t1 t2 1 begin begin select * from user where age=1; 3 insert into user values (4,â€™hahaâ€™,1);commit; 5 update user set name=â€™zhangsan2â€™ where age=1; 6 commit; RRçº§åˆ«ä¸‹ï¼Œæ­¤æ—¶æƒ³è±¡ä¸­çš„ç»“æœä¸ºä¸‹é¢ï¼Œå› ä¸ºå®é™…ä¸Šåœ¨ç¬¬äº”è¡Œå¦‚æœä¸æ˜¯updateè€Œæ˜¯selectï¼Œæ˜¯è‚¯å®šå·®ä¸åˆ°æ–°æ•°æ®çš„ id name age 1 zhangsan2 1 2 lisi 5 3 wangwu 10 4 haha 1 ä½†æ˜¯å®é™…çš„æ•°æ®åº“ä¸­ç»“æœä¸ºï¼š id name age 1 zhangsan2 1 2 lisi 5 3 wangwu 10 4 zhangsan2 1 å…¶å®åœ¨ MySQLåœ¨RRçº§åˆ«ä¸­å¹¶ä¸æ˜¯å®Œå…¨è§£å†³äº†å¹»è¯»çš„é—®é¢˜ï¼Œå¯¹ç…§æ“ä½œ2ä¸­t2ä½¿ç”¨insertã€æ“ä½œ3ã€ä»¥åŠæ“ä½œ4å¯ä»¥çœ‹å‡ºæŸäº›åœºæ™¯ä¸‹RRè§£å†³äº†å¹»è¯»ï¼Œä½†æ˜¯MVCC å¯¹äºå¹»è¯»çš„è§£å†³æ˜¯ä¸å½»åº•çš„ã€‚ï¼ˆå¿«ç…§è¯»å’Œå½“å‰è¯»çš„æ··åˆä½¿ç”¨ä¼šäº§ç”Ÿå¹»è¯»é—®é¢˜ï¼‰","categories":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"ä¸šåŠ¡æ¶æ„-ç¨³å®šæ€§å»ºè®¾æ–¹æ³•è®º","slug":"11.æ–¹æ³•è®º/ä¸šåŠ¡æ¶æ„-ç¨³å®šæ€§å»ºè®¾æ–¹æ³•è®º","date":"2022-01-16T16:00:00.000Z","updated":"2024-08-22T03:23:14.703Z","comments":true,"path":"2022/01/17/11.æ–¹æ³•è®º/ä¸šåŠ¡æ¶æ„-ç¨³å®šæ€§å»ºè®¾æ–¹æ³•è®º/","link":"","permalink":"https://zhangxin66666.github.io/2022/01/17/11.%E6%96%B9%E6%B3%95%E8%AE%BA/%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84-%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%BB%BA%E8%AE%BE%E6%96%B9%E6%B3%95%E8%AE%BA/","excerpt":"","text":"å…ˆä»‹ç»å‡ ä¸ªæ¦‚å¿µï¼ŒåŒæ­¥ä¸€ä¸‹è®¤çŸ¥ï¼š å®¹ç¾ï¼šæ˜¯æŒ‡ç³»ç»Ÿå†—ä½™éƒ¨ç½²ï¼Œå½“ä¸€å¤„ç”±äºæ„å¤–åœæ­¢å·¥ä½œï¼Œæ•´ä¸ªç³»ç»Ÿåº”ç”¨è¿˜å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ å®¹é”™ï¼šæ˜¯æŒ‡åœ¨è¿è¡Œä¸­å‡ºç°é”™è¯¯ï¼ˆå¦‚ä¸Šä¸‹æ¸¸æ•…éšœæˆ–æ¦‚ç‡æ€§å¤±è´¥ï¼‰ä»å¯æ­£å¸¸æä¾›æœåŠ¡ã€‚ å¯ç”¨æ€§ï¼šæè¿°çš„æ˜¯ç³»ç»Ÿå¯æä¾›æœåŠ¡çš„æ—¶é—´é•¿çŸ­ã€‚ç”¨å…¬å¼æ¥è¯´å°±æ˜¯æ­£å¸¸å·¥ä½œæ—¶é—´/(æ­£å¸¸å·¥ä½œæ—¶é—´+æ•…éšœæ—¶é—´)ã€‚ å¯é æ€§ï¼šæè¿°çš„æ˜¯ç³»ç»ŸæŒ‡å®šæ—¶é—´å•ä½å†…æ— æ•…éšœçš„æ¬¡æ•°ã€‚æ¯”å¦‚ï¼šä¸€å¹´365å¤©ï¼Œä»¥å¤©ä¸ºå•ä½æ¥è¡¡é‡ã€‚æœ‰å¤©å‘ç”Ÿäº†æ•…éšœï¼Œå“ªæ€•åªæœ‰1ç§’ï¼Œè¿™å¤©ç®—ä¸å¯é ã€‚å…¶ä»–æ²¡æœ‰æ•…éšœçš„æ˜¯å¯é çš„ã€‚ ç¨³å®šæ€§ï¼šè¿™ä¸ªä¸šç•Œæ²¡æœ‰æ˜ç¡®çš„å®šä¹‰ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼šåœ¨å—åˆ°å„ç§å¹²æ‰°æ—¶ä»ç„¶èƒ½å¤Ÿæä¾›ç¬¦åˆé¢„æœŸçš„æœåŠ¡çš„èƒ½åŠ›ã€‚ ä¸€ã€å®¹ç¾å»ºè®¾1.ä»£ç å®¹ç¾ ç°ä»£äº’è”ç½‘å…¬å¸æœ€å€¼é’±çš„å°±æ˜¯ç¨‹åºå‘˜å†™å‡ºæ¥çš„ä»£ç å•¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ä»£ç è¿›è¡Œå®¹ç¾å¤‡ä»½ï¼Œé˜²æ­¢æ”¾ä»£ç çš„æœåŠ¡å™¨å“ªå¤©ä¸€ä¸é«˜å…´å®•æœºå¼‚æˆ–çˆ†ç‚¸å•¦æ•°æ®éƒ½ä¸¢äº†å°±å®Œè›‹äº†ï¼Œç°åœ¨ä»£ç åŒæ­¥çš„æ–¹æ¡ˆæ¯”è¾ƒå¤šï¼Œæ˜¯åœ¨ä¸è¡Œè¿ç»´äººå‘˜å†™ä¸ªè„šæœ¬ï¼Œæ¯å¤©æˆ–è€…å‡ ä¸ªå°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€ä¸‹å…¨é‡ä»£ç åˆ°å¦ä¸€ä¸ªæœºæˆ¿è¿˜æ˜¯å¯ä»¥åšåˆ°æ»´ã€‚ 2.æœåŠ¡å®¹ç¾æœåŠ¡å®¹ç¾çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å†—ä½™ã€‚å¤šå‡ ä¸ªå¤‡ä»½æ¥åˆ‡æ¢ã€‚ 2.1åŒåŸå®¹ç¾åŒåŸ å®¹ç¾ æ˜¯åœ¨åŒåŸæˆ–ç›¸è¿‘åŒºåŸŸå†… ï¼ˆ â‰¤ 200K M ï¼‰å»ºç«‹ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒ : ä¸€ä¸ªä¸ºæ•°æ®ä¸­å¿ƒï¼Œè´Ÿè´£æ—¥å¸¸ç”Ÿäº§è¿è¡Œ ; å¦ä¸€ä¸ªä¸ºç¾éš¾å¤‡ä»½ä¸­å¿ƒï¼Œè´Ÿè´£åœ¨ç¾éš¾å‘ç”Ÿåçš„åº”ç”¨ç³»ç»Ÿè¿è¡Œã€‚åŒåŸç¾éš¾å¤‡ä»½çš„æ•°æ®ä¸­å¿ƒä¸ç¾éš¾å¤‡ä»½ä¸­å¿ƒçš„è·ç¦»æ¯”è¾ƒè¿‘ï¼Œé€šä¿¡çº¿è·¯è´¨é‡è¾ƒå¥½ï¼Œæ¯”è¾ƒå®¹æ˜“å®ç°æ•°æ®çš„åŒæ­¥ å¤åˆ¶ ï¼Œä¿è¯é«˜åº¦çš„æ•°æ®å®Œæ•´æ€§å’Œæ•°æ®é›¶ä¸¢å¤±ã€‚åŒåŸç¾éš¾å¤‡ä»½ä¸€èˆ¬ç”¨äºé˜²èŒƒç«ç¾ã€å»ºç­‘ç‰©ç ´åã€ä¾›ç”µæ•…éšœã€è®¡ç®—æœºç³»ç»ŸåŠäººä¸ºç ´åå¼•èµ·çš„ç¾éš¾ 2.2å¼‚åœ°/è·¨æ´‹å®¹ç¾å¼‚åœ° å®¹ç¾ ä¸»å¤‡ä¸­å¿ƒä¹‹é—´çš„è·ç¦»è¾ƒè¿œ ï¼ˆï¼ 200KM ) ï¼Œ å› æ­¤ä¸€èˆ¬é‡‡ç”¨å¼‚æ­¥é•œåƒï¼Œä¼šæœ‰å°‘é‡çš„æ•°æ®ä¸¢å¤±ã€‚å¼‚åœ°ç¾éš¾å¤‡ä»½ä¸ä»…å¯ä»¥é˜²èŒƒç«ç¾ã€å»ºç­‘ç‰©ç ´åç­‰å¯èƒ½é‡åˆ°çš„é£é™©éšæ‚£ï¼Œè¿˜èƒ½å¤Ÿé˜²èŒƒæˆ˜äº‰ã€åœ°éœ‡ã€æ°´ç¾ç­‰é£é™©ã€‚ç”±äºåŒåŸç¾éš¾å¤‡ä»½å’Œå¼‚åœ°ç¾éš¾å¤‡ä»½å„æœ‰æ‰€é•¿ï¼Œä¸ºè¾¾åˆ°æœ€ç†æƒ³çš„é˜²ç¾æ•ˆæœï¼Œæ•°æ®ä¸­å¿ƒåº”è€ƒè™‘é‡‡ç”¨åŒåŸå’Œå¼‚åœ°å„å»ºç«‹ä¸€ä¸ªç¾éš¾å¤‡ä»½ä¸­å¿ƒçš„æ–¹å¼è§£å†³ã€‚ 2.3ä¸¤åœ°ä¸‰ä¸­å¿ƒä¸¤åœ°ä¸‰ä¸­å¿ƒ ï¼š æ˜¯æŒ‡ åŒåŸåŒä¸­å¿ƒ åŠ  å¼‚åœ°ç¾å¤‡ ä¸€ç§å•†ç”¨å®¹ç¾å¤‡ä»½è§£å†³æ–¹æ¡ˆï¼› ä¸¤åœ° æ˜¯æŒ‡åŒåŸã€å¼‚åœ°ï¼› ä¸‰ä¸­å¿ƒ æ˜¯æŒ‡ç”Ÿäº§ä¸­å¿ƒã€åŒåŸå®¹ç¾ä¸­å¿ƒã€å¼‚åœ°å®¹ç¾ä¸­å¿ƒã€‚ï¼ˆ ç”Ÿäº§ä¸­å¿ƒã€åŒåŸç¾å¤‡ä¸­å¿ƒã€å¼‚åœ° ç¾å¤‡ ä¸­å¿ƒ ï¼‰ ç»“åˆè¿‘å¹´å›½å†…å‡ºç°çš„å¤§èŒƒå›´è‡ªç„¶ç¾å®³ï¼Œä»¥åŒåŸåŒä¸­å¿ƒåŠ å¼‚åœ°ç¾å¤‡ä¸­å¿ƒçš„ â€œä¸¤åœ°ä¸‰ä¸­å¿ƒâ€çš„ç¾å¤‡æ¨¡å¼ä¹Ÿéšä¹‹å‡ºç°ï¼Œè¿™ä¸€æ–¹æ¡ˆå…¼å…·é«˜å¯ç”¨æ€§å’Œç¾éš¾å¤‡ä»½çš„èƒ½åŠ›ã€‚ åŒåŸåŒä¸­å¿ƒ æ˜¯æŒ‡åœ¨åŒåŸæˆ–é‚»è¿‘åŸå¸‚å»ºç«‹ä¸¤ä¸ªå¯ç‹¬ç«‹æ‰¿æ‹…å…³é”®ç³»ç»Ÿè¿è¡Œçš„æ•°æ®ä¸­å¿ƒï¼ŒåŒä¸­å¿ƒå…·å¤‡åŸºæœ¬ç­‰åŒçš„ä¸šåŠ¡å¤„ç†èƒ½åŠ›å¹¶é€šè¿‡é«˜é€Ÿé“¾è·¯å®æ—¶åŒæ­¥æ•°æ®ï¼Œæ—¥å¸¸æƒ…å†µä¸‹å¯åŒæ—¶åˆ†æ‹…ä¸šåŠ¡åŠç®¡ç†ç³»ç»Ÿçš„è¿è¡Œï¼Œå¹¶å¯åˆ‡æ¢è¿è¡Œï¼›ç¾éš¾æƒ…å†µä¸‹å¯åœ¨åŸºæœ¬ä¸ä¸¢å¤±æ•°æ®çš„æƒ…å†µä¸‹è¿›è¡Œç¾å¤‡åº”æ€¥åˆ‡æ¢ï¼Œä¿æŒä¸šåŠ¡è¿ç»­è¿è¡Œã€‚ä¸å¼‚åœ°ç¾å¤‡æ¨¡å¼ç›¸æ¯”è¾ƒï¼ŒåŒåŸåŒä¸­å¿ƒå…·æœ‰æŠ•èµ„æˆæœ¬ä½ã€å»ºè®¾é€Ÿåº¦å¿«ã€è¿ç»´ç®¡ç†ç›¸å¯¹ç®€å•ã€å¯é æ€§æ›´é«˜ç­‰ä¼˜ç‚¹ã€‚ å¼‚åœ°ç¾å¤‡ä¸­å¿ƒ æ˜¯æŒ‡åœ¨å¼‚åœ°çš„åŸå¸‚å»ºç«‹ä¸€ä¸ªå¤‡ä»½çš„ç¾å¤‡ä¸­å¿ƒï¼Œç”¨äºåŒä¸­å¿ƒçš„æ•°æ®å¤‡ä»½ï¼Œå½“åŒä¸­å¿ƒå‡ºç°è‡ªç„¶ç¾å®³ç­‰åŸå› è€Œå‘ç”Ÿæ•…éšœæ—¶ï¼Œå¼‚åœ°ç¾å¤‡ä¸­å¿ƒå¯ä»¥ç”¨å¤‡ä»½æ•°æ®è¿›è¡Œä¸šåŠ¡çš„æ¢å¤ã€‚ äºŒã€æœåŠ¡æ²»ç†1.é“¾è·¯æ¢³ç†éœ€è¦æ¢³ç†æ ¸å¿ƒæ¥å£æœåŠ¡çš„è¡€ç¼˜ä¾èµ–å…³ç³»ã€ç›¸å…³å¹²ç³»äººåŠè”ç³»æ–¹å¼ï¼Œåšåˆ°å¿ƒä¸­æœ‰æ•°ï¼Œå…³é”®æ¥å£è°ƒç”¨é“¾è·¯æµç¨‹å°½é‡çŸ­ï¼Œä¸‹æ¸¸ä¾èµ–æ¥å£tp999å°½é‡è¶Šå¿«è¶Šå¥½ã€‚ 2.å¼ºå¼±ä¾èµ–åˆ†æå¼ºä¾èµ–ï¼šå‡å®šæœåŠ¡Aä¾èµ–äºæœåŠ¡Bï¼ŒæœåŠ¡Bå‡ºç°æ•…éšœä¸å¯ç”¨æ—¶ï¼ŒæœåŠ¡Aä¹Ÿä¸å¯ç”¨ï¼Œé€šå¸¸æœåŠ¡Aä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°è¿™ç§ä¾èµ–ä¸ºå¼ºä¾èµ–ã€‚ å¼±ä¾èµ–ï¼šå‡å®šæœåŠ¡Aä¾èµ–äºæœåŠ¡Bï¼ŒæœåŠ¡Bå‡ºç°æ•…éšœä¸å¯ç”¨æ—¶ï¼ŒæœåŠ¡Aä»ç„¶å¯ç”¨ï¼Œé€šå¸¸æœåŠ¡Aä¼šè¿”å›æ­£ç¡®ä¿¡æ¯ï¼Œåªæ˜¯ä¸æœåŠ¡Bç›¸å…³çš„ä¿¡æ¯ä¼šä¸è¿”å›æˆ–è€…åšé»˜è®¤å¤„ç†ï¼Œæˆ‘ä»¬ç§°è¿™ç§ä¾èµ–ä¸ºå¼±ä¾èµ–ã€‚ é€šè¿‡ä¸‹é¢çš„æµç¨‹å›¾ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å¼ºå¼±ä¾èµ–ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æœåŠ¡Aä¸­è°ƒç”¨äº†æœåŠ¡Bå’ŒæœåŠ¡Cï¼Œä½†æ˜¯ä»–ä»¬çš„å¤„ç†é€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ã€‚ 1ã€è°ƒç”¨æœåŠ¡Bï¼šå¦‚æœè°ƒç”¨æˆåŠŸï¼Œåˆ™æ¥ç€è°ƒç”¨æœåŠ¡Cï¼›å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œåˆ™æœåŠ¡Aç›´æ¥ç»“æŸã€‚è¿™ç§åœºæ™¯æˆ‘ä»¬ç§°ä¹‹ä¸ºæœåŠ¡Aå¼ºä¾èµ–äºæœåŠ¡Bã€‚ 2ã€è°ƒç”¨æœåŠ¡Cï¼šä¸ç®¡è°ƒç”¨æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒæœåŠ¡Aä¼šæ¥ç»­æ‰§è¡Œåç»­é€»è¾‘å¤„ç†ã€‚è¿™ç§åœºæ™¯æˆ‘ä»¬ç§°ä¹‹ä¸ºæœåŠ¡Aå¼±ä¾èµ–äºæœåŠ¡Cã€‚ 12345678910111213141516171819public void serviceA()&#123; try &#123; System.out.println(&quot;it`s serviceA&quot;); /// serviceA å¼ºä¾èµ–äº serviceB serviceB(); try &#123; /// serviceA å¼±ä¾èµ–äº serviceC serviceC(); &#125; catch (Exception e)&#123; e.printStackTrace(); &#125; System.out.println(&quot;xxxxxxx&quot;); &#125; catch (Exception e)&#123; e.printStackTrace(); &#125; &#125; åœ¨ä»£ç çš„å¤„ç†ä¸Šï¼Œå¯ä»¥åˆ†ä¸ºä¸€ä¸‹ä¸‰ç§æ¨¡å¼ï¼š1ã€å¼±ä¾èµ–ï¼šæœåŠ¡Açš„ä¸»æµç¨‹ä¸ä¾èµ–æœåŠ¡Bçš„è¿”å›ç»“æœã€‚è¯¥åœºæ™¯å¯ä»¥æœ‰ä¸¤ç§è§£å†³æ–¹å¼ï¼š1ï¼‰å¯ä»¥å¯åŠ¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡ŒæœåŠ¡Bè°ƒç”¨ã€‚2ï¼‰åœ¨å½“å‰çº¿ç¨‹ä¸­å‘æ¶ˆæ¯ï¼Œåœ¨æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹ä¸­è®¿é—®æœåŠ¡Bã€‚ 2ã€å¼±ä¾èµ–ï¼šæœåŠ¡Açš„ä¸»æµç¨‹ä¾èµ–æœåŠ¡Bçš„è¿”å›ç»“æœã€‚ä¸å¼ºä¾èµ–å¤„ç†æœ‰äº›ç±»ä¼¼ï¼Œä¸€èˆ¬å»ºè®®å¯¹æœåŠ¡Båšé™çº§å¤„ç†ï¼Œæ ¹æ®è¯·æ±‚è¶…æ—¶æ—¶é—´ã€å¹¶å‘è¯·æ±‚æ•°ã€è¯·æ±‚å¤±è´¥æ•°ã€è¯·æ±‚è¿”å›çš„é”™è¯¯ç åšé™çº§(æˆ–è€…ç†”æ–­)å¤„ç†ã€‚åŒæ—¶ä½¿ç”¨é»˜è®¤å€¼æ¥ä»£æ›¿æœåŠ¡Bçš„è¿”å›ç»“æœï¼Œé»˜è®¤å€¼çš„è®¾ç½®éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œåˆ†æã€‚ 3ã€å¼ºä¾èµ–ï¼šæœåŠ¡Açš„ä¸»æµç¨‹ä¾èµ–æœåŠ¡Bçš„è¿”å›ç»“æœã€‚ä¸€èˆ¬å»ºè®®å¯¹æœåŠ¡Aæ•´ä½“åšé™çº§å¤„ç†ï¼Œè¯·æ±‚è¿”å›çš„é”™è¯¯ç ã€‚ åœ¨ç³»ç»Ÿè®¾è®¡æ—¶ä¸€å®šè¦è€ƒè™‘ç³»ç»Ÿçš„å¼ºå¼±ä¾èµ–å…³ç³»ï¼Œæ ¹æ®éœ€è¦é‡‡ç”¨ä¸åŒçš„å¤„ç†æ–¹æ¡ˆã€‚ 3.å¼‚æ­¥åŒ–å»ºè®¾æ™®é€šæµé‡ä¸‹çš„æ¥å£æµç¨‹è®¾è®¡ä¸Šå¯ä»¥ä¸€ä¸ªæ¥å£ï¼Œåšäº†å¥½å¤šå¥½å¤šäº‹æƒ…ï¼Œä¹‹åæ¥å£åŒæ­¥å®æ—¶è¿”å›å¤„ç†æˆåŠŸæˆ–è€…å¤„ç†å¤±è´¥ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¯éå¸¸ç³Ÿç³•çš„è®¾è®¡ï¼Œæ¥å£ä¸€æ–¹é¢ä¸šåŠ¡é€»è¾‘éå¸¸çš„é‡ï¼Œå¦ä¸€æ–¹é¢ï¼ŒåŒæ­¥æ¥å£ä¾èµ–çš„å¾ˆå¤šçš„ä¸‰æ–¹æ¥å£ï¼Œä¹Ÿå¯èƒ½ä¼šå¤šæ¬¡çš„æ“ä½œæ•°æ®åº“ï¼Œä¸€ä¸ªç‚¹å‡ºé—®é¢˜éƒ½ä¼šé€ æˆæ•´ä¸ªä¸šåŠ¡çš„ç˜«ç—ªã€‚æ­¤æ—¶å¯ä»¥æŠŠæ•´ä¸ªæµç¨‹å¼‚æ­¥åŒ–ï¼ŒåŒæ­¥æ¥å£é‡Œé¢åªåšä¸€äº›æ ¡éªŒå·¥ä½œä»¥åŠæ•°æ®çš„ä¿å­˜ï¼Œä¹‹åå‘é€mqè§¦å‘åç»­æµç¨‹çš„æ‰§è¡Œï¼Œæ­¤æ—¶å®æ—¶æ¥å£è¿”å›å¤„ç†ä¸­ï¼Œå¼‚æ­¥æµç¨‹ä¸­å¤„ç†å®Œæ¯•åé€šè¿‡å›è°ƒçš„æ–¹å¼é€šçŸ¥è°ƒç”¨æ–¹ç»“æœï¼ŒåŒæ—¶æä¾›æŸ¥è¯¢æ¥å£ä¾›è°ƒç”¨æ–¹ä¸»åŠ¨è·å–ç»“æœã€‚ éœ€è¦æ³¨æ„çš„æ˜¯å› ä¸ºæ˜¯é€šè¿‡å‘mqçš„æ–¹å¼è§¦å‘åç»­æµç¨‹ï¼Œé‚£ä¹ˆå°±è¦ä¿è¯mqä¸€å®šå‘é€æˆåŠŸï¼Œæ­¤å¤„ç‰µæ‰¯åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ç›¸å…³çš„æ–¹æ¡ˆï¼Œä¸åŒçš„ä¸šåŠ¡é€»è¾‘å¯èƒ½ä¼šä½¿ç”¨ä¸åŒçš„è§£å†³åŠæ³•ã€‚ï¼ˆæœ¬åœ°äº‹åŠ¡è¡¨æˆ–è€…ä¾é çŠ¶æ€æ¥é©±åŠ¨éƒ½å¯ä»¥ï¼‰ 4.åˆ‡é‡/é™çº§/é™æµ/ç†”æ–­4.1åˆ‡é‡åˆ‡é‡æ˜¯æ–°ä¸šåŠ¡ä¸Šçº¿åˆæœŸï¼Œæˆ–è€…å¤§ç‰ˆæœ¬æ›´æ–°çš„æ—¶å€™ï¼Œä¼šå¯¹ç”¨æˆ·è¿›è¡Œåˆ‡é‡å¼€æ”¾xxåŠŸèƒ½ï¼Œç”¨å°‘é‡çš„ç”Ÿäº§æµé‡éªŒè¯æµç¨‹ï¼Œå¦‚æœæ²¡æœ‰é—®é¢˜æ…¢æ…¢åˆ‡é‡å‰©ä½™ç”¨æˆ·ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œä¹Ÿä¼šå°†é—®é¢˜å½±å“é¢é™åˆ°æœ€ä½ã€‚ 4.2é™çº§é™çº§æ˜¯é€šè¿‡å¼€å…³é…ç½®å°†æŸäº›ä¸é‡è¦çš„ä¸šåŠ¡åŠŸèƒ½å±è”½æ‰ï¼Œä»¥æé«˜æœåŠ¡å¤„ç†èƒ½åŠ›ã€‚ åœ¨å¤§ä¿ƒåœºæ™¯ä¸­ç»å¸¸ä¼šå¯¹æŸäº›æœåŠ¡è¿›è¡Œé™çº§å¤„ç†ï¼Œå¤§ä¿ƒç»“æŸä¹‹åå†è¿›è¡Œå¤åŸã€‚ æœ¬ç³»ç»Ÿæˆ–è€…ä¸‹æ¸¸ç³»ç»Ÿå‡ºç°é—®é¢˜æ—¶ï¼Œå½“å‰ç³»ç»Ÿå¯ä»¥æ‰‹åŠ¨å¯¹æœåŠ¡è¿›è¡Œé™çº§æ“ä½œï¼Œé—®é¢˜ä¿®å¤åå…³é—­é™çº§ã€‚ å¤§ä¿ƒåœºæ™¯æ—¶ä¼šå¯¹æ—¥å¿—æ‰“å°è¿›è¡Œé™çº§ï¼Œé˜²æ­¢ç£ç›˜ioå¯¹ç³»ç»Ÿé€ æˆå½±å“ï¼Œå¦å¤–ä¹Ÿä¼šé¿å…æ­£å¥½å¤§ä¿ƒæ—¶ç£ç›˜ç©ºé—´æ»¡äº†ï¼Œç³»ç»Ÿæ²¡æ¥å¾—åŠå›æ”¶æ—¥å¿—é€ æˆæœåŠ¡ä¸å¯ç”¨ã€‚ ä¸ºä»€ä¹ˆè¦é™çº§åœ¨ä¸å½±å“ä¸šåŠ¡æ ¸å¿ƒé“¾è·¯çš„æƒ…å†µä¸‹ï¼Œå±è”½æŸäº›ä¸é‡è¦çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œå¯ä»¥èŠ‚çœç³»ç»Ÿçš„å¤„ç†æ—¶é—´ï¼Œæä¾›ç³»ç»Ÿçš„å“åº”èƒ½åŠ›ï¼Œåœ¨æœåŠ¡å™¨èµ„æºå›ºå®šçš„å‰æä¸‹å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚ 4.3é™æµé™æµæ˜¯é’ˆå¯¹æœåŠ¡è¯·æ±‚æ•°é‡çš„ä¸€ç§è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œå½“è¯·æ±‚æ•°é‡è¶…å‡ºæœåŠ¡çš„å¤„ç†èƒ½åŠ›æ—¶ï¼Œä¼šè‡ªåŠ¨ä¸¢å¼ƒæ–°æ¥çš„è¯·æ±‚ã€‚ ä¸ºä»€ä¹ˆè¦é™æµä»»ä½•ä¸€ä¸ªç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›éƒ½æ˜¯æœ‰æé™çš„ï¼Œå‡å®šæœåŠ¡Açš„å¤„ç†èƒ½åŠ›ä¸ºTPS=100ï¼Œå½“TPS&lt;100æ—¶æœåŠ¡Aå¯ä»¥æä¾›æ­£å¸¸çš„æœåŠ¡ã€‚å½“TPS&gt;100æ—¶ï¼Œç”±äºè¯·æ±‚é‡å¢å¤§ï¼Œä¼šå‡ºç°äº‰æŠ¢æœåŠ¡èµ„æºçš„æƒ…å†µï¼ˆæ•°æ®åº“è¿æ¥ã€CPUã€å†…å­˜ç­‰ï¼‰ï¼Œå¯¼è‡´æœåŠ¡Aå¤„ç†ç¼“æ…¢ï¼›å½“TPSç»§ç»­å¢å¤§æ—¶ï¼Œå¯èƒ½ä¼šé€ æˆæœåŠ¡Aå“åº”æ›´åŠ ç¼“æ…¢ç”šè‡³å¥”æºƒã€‚å¦‚æœä¸è¿›è¡Œé™æµæ§åˆ¶ï¼ŒæœåŠ¡Aå§‹ç»ˆä¼šé¢ä¸´ç€è¢«å¤§æµé‡å†²å‡»çš„é£é™©ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšå¥½ç³»ç»Ÿè¯·æ±‚æµé‡çš„è¯„ä¼°ï¼Œåˆ¶å®šåˆç†çš„é™æµç­–ç•¥ã€‚ 4.4ç†”æ–­åœ¨æœåŠ¡çš„ä¾èµ–è°ƒç”¨ä¸­ï¼Œè¢«è°ƒç”¨æ–¹å‡ºç°æ•…éšœæ—¶ï¼Œå‡ºäºè‡ªæˆ‘ä¿æŠ¤çš„ç›®çš„ï¼Œè°ƒç”¨æ–¹ä¼šä¸»åŠ¨åœæ­¢è°ƒç”¨ï¼Œå¹¶æ ¹æ®ä¸šåŠ¡éœ€è¦è¿›è¡Œç›¸åº”å¤„ç†ã€‚è°ƒç”¨æ–¹è¿™ç§ä¸»åŠ¨åœæ­¢è°ƒç”¨çš„è¡Œä¸ºæˆ‘ä»¬ç§°ä¹‹ä¸ºç†”æ–­ã€‚ ä¸ºä»€ä¹ˆè¦ç†”æ–­å‡å®šæœåŠ¡Aä¾èµ–æœåŠ¡Bï¼Œå½“æœåŠ¡Bå¤„äºæ­£å¸¸çŠ¶æ€ï¼Œæ•´ä¸ªè°ƒç”¨æ˜¯å¥åº·çš„ï¼ŒæœåŠ¡Aå¯ä»¥å¾—åˆ°æœåŠ¡Bçš„æ­£å¸¸å“åº”ã€‚å½“æœåŠ¡Bå‡ºç°æ•…éšœæ—¶ï¼Œæ¯”å¦‚å“åº”ç¼“æ…¢æˆ–è€…å“åº”è¶…æ—¶ï¼Œå¦‚æœæœåŠ¡Aç»§ç»­è¯·æ±‚æœåŠ¡Bï¼Œé‚£ä¹ˆæœåŠ¡Açš„å“åº”æ—¶é—´ä¹Ÿä¼šå¢åŠ ï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡Aå“åº”ç¼“æ…¢ã€‚å¦‚æœæœåŠ¡Aä¸è¿›è¡Œç†”æ–­å¤„ç†ï¼ŒæœåŠ¡Bçš„æ•…éšœä¼šä¼ å¯¼è‡³æœåŠ¡Aï¼Œæœ€ç»ˆå¯¼è‡´æœåŠ¡Aä¹Ÿä¸å¯ç”¨ã€‚ 5.traceidæ—¥å¿—ä¸­ä¸²ä¸€æ¬¡è¯·æ±‚çš„idï¼Œç³»ç»Ÿå¹¶å‘çš„æ—¶å€™ï¼Œå¤šæ¬¡è¯·æ±‚çš„æ—¥å¿—ä¼šäº¤å‰æ‰“å°ï¼Œæ’æŸ¥é—®é¢˜ä¼šæ¯”è¾ƒéš¾å—ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­åŠ å…¥traceidï¼Œå¯ä»¥ä¸²èµ·æ¥ä¸€æ¬¡å®Œæ•´è¯·æ±‚ï¼Œæœ‰æ¡ä»¶çš„å¯ä»¥æŠŠtraceidè¿›è¡Œä¼ é€’ï¼Œè¿™æ ·å°±èƒ½ç”¨traceidæŠŠä¸€èµ·å®Œæ•´çš„è¯·æ±‚åœ¨å„åº”ç”¨ç³»ç»Ÿä¸­ä¸€èµ·ä¸²èµ·æ¥ï¼Œä¹Ÿå°±å®ç°äº†é“¾è·¯è¿½è¸ªåŠŸèƒ½ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172//Constantä¸­çš„TRACE_IDå®šä¹‰//æ—¥å¿—ä¸­çš„traceidpublic static final String TRACE_ID = &quot;traceId&quot;;//traceidInterceptorimport org.slf4j.MDC;import org.springframework.util.StringUtils;import org.springframework.web.servlet.HandlerInterceptor;import javax.servlet.annotation.WebServlet;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.util.UUID;@WebServletpublic class TraceIDInterceptor implements HandlerInterceptor &#123; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) &#123; String traceID = request.getHeader(Constant.TRACE_ID); if (StringUtils.isEmpty(traceID)) &#123; traceID = UUID.randomUUID().toString(); &#125; MDC.put(Constant.TRACE_ID, traceID); return true; &#125;&#125;import org.springframework.context.annotation.Configuration;import org.springframework.web.servlet.config.annotation.InterceptorRegistry;import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;@Configurationpublic class InterceptorConfig implements WebMvcConfigurer &#123; @Override public void addInterceptors(InterceptorRegistry interceptorRegistry) &#123; // å¤šä¸ªæ‹¦æˆªå™¨ç»„æˆä¸€ä¸ªæ‹¦æˆªå™¨é“¾ // addPathPatterns ç”¨äºæ·»åŠ æ‹¦æˆªè§„åˆ™ // excludePathPatterns ç”¨æˆ·æ’é™¤æ‹¦æˆª interceptorRegistry.addInterceptor(new TraceIDInterceptor()).addPathPatterns(&quot;/**&quot;); &#125;&#125;//å¦‚æœfeignæ–¹å¼è°ƒç”¨å¾€ä¸‹æ¸¸ä¼ é€’çš„å¯ä»¥åŠ ä¸Šä¸‹é¢çš„Interceptorimport feign.RequestInterceptor;import feign.RequestTemplate;import org.slf4j.MDC;import org.springframework.context.annotation.Configuration;import org.springframework.util.StringUtils;import java.util.UUID;@Configurationpublic class FeignInterceptor implements RequestInterceptor &#123; @Override public void apply(RequestTemplate requestTemplate) &#123; String traceID = MDC.get(Constant.TRACE_ID); if (StringUtils.isEmpty(traceID)) &#123; traceID = UUID.randomUUID().toString(); &#125; requestTemplate.header(Constant.HEADER_TRACE_ID, traceID); &#125;&#125;//æ—¥å¿—é…ç½®æ–‡ä»¶ä¸­åŠ å…¥[%X&#123;traceId&#125;]//æ­¤æ—¶æ¥å£è°ƒç”¨çš„traceidåŠ å®Œäº†ï¼Œä½†æ˜¯ä¾‹å¦‚mqã€è°ƒåº¦ä¹‹ç±»çš„å¯èƒ½ä¸è¡Œï¼Œéœ€è¦åœ¨æ­¤ç±»ä»£ç å…¥å£æ‰‹åŠ¨è®¾ç½®traceidMDC.put(Constant.TRACE_ID, UUID.randomUUID().toString()); 6.æ–¹æ³•æ‰§è¡Œæ—¶é—´æ³¨è§£ä¸€ä¸ªæ¥å£è°ƒç”¨äº†ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼Œä¸€æ¬¡æ•°æ®åº“ä¿å­˜ï¼Œä¸¤æ¬¡rpcã€‚æŸä¸€å¤©ä¸Šæ¸¸åé¦ˆæ¥å£æ…¢ï¼Œè¯¥å¦‚ä½•è¿›è¡Œæ’æŸ¥å‘¢ï¼Ÿ ä¼˜åŒ–æ¥å£æ…¢ï¼Œé‚£å°±å¾—æ‰¾åˆ°å½±å“æ¥å£è€—æ—¶çš„å…³é”®ç‚¹ï¼Œæˆ‘ä»¬å¦‚æœçŸ¥é“äº†æ•°æ®åº“æŸ¥è¯¢è€—æ—¶ï¼Œæ•°æ®åº“ä¿å­˜è€—æ—¶ï¼Œä¸¤æ¬¡rpcçš„åˆ†åˆ«è€—æ—¶ï¼Œæ˜¯å¦é—®é¢˜å°±è¿åˆƒè€Œè§£äº†å‘¢ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051//è‡ªå®šä¹‰Timeræ³¨è§£import java.lang.annotation.ElementType;import java.lang.annotation.Retention;import java.lang.annotation.RetentionPolicy;import java.lang.annotation.Target;/** * æ ‡æ³¨éœ€è¦è®°å½•æ—¶é—´æ¶ˆè€—çš„æ–¹æ³• */@Target(ElementType.METHOD)@Retention(RetentionPolicy.RUNTIME)public @interface Timer &#123;&#125;//aopç¯ç»•è·å–æ–¹æ³•æ‰§è¡Œè€—æ—¶import lombok.extern.slf4j.Slf4j;import org.aspectj.lang.ProceedingJoinPoint;import org.aspectj.lang.annotation.Around;import org.aspectj.lang.annotation.Aspect;import org.springframework.stereotype.Component;/** * æ—¶é—´è®°å½•åˆ‡é¢ï¼Œæ”¶é›†æ¥å£çš„è¿è¡Œæ—¶é—´ */@Slf4j@Aspect@Componentpublic class TimeAspect &#123; // ä¿®æ­£Timeræ³¨è§£çš„å…¨å±€å”¯ä¸€é™å®šç¬¦ @Around(&quot;@annotation(com.renrenche.pricing.process.annotation.Timer)&quot;) public Object around(ProceedingJoinPoint joinPoint) throws Throwable &#123; // è·å–ç›®æ ‡ç±»åç§° String clazzName = joinPoint.getTarget().getClass().getName(); // è·å–ç›®æ ‡ç±»æ–¹æ³•åç§° String methodName = joinPoint.getSignature().getName(); long start = System.currentTimeMillis();// log.info(&quot;================================&#123;&#125;: &#123;&#125;: start...&quot;, clazzName, methodName); // è°ƒç”¨ç›®æ ‡æ–¹æ³• Object result = joinPoint.proceed(); long time = System.currentTimeMillis() - start; log.info(&quot;è€—æ—¶ç»Ÿè®¡:clazzName:&#123;&#125;,methodName:&#123;&#125;,time:&#123;&#125; ms&quot;, clazzName, methodName, time); return result; &#125;&#125;//ç”¨æ³•ï¼Œåœ¨éœ€è¦ç›‘æ§è€—æ—¶çš„æ–¹æ³•ä¸Šæ·»åŠ @Timeræ³¨è§£å³å¯è€—æ—¶ç»Ÿè®¡:clazzName:com.xx.xx.XX,methodName:queryXX,time:10 msè€—æ—¶ç»Ÿè®¡:clazzName:com.xx.xx.XX,methodName:saveXX,time:20 msè€—æ—¶ç»Ÿè®¡:clazzName:com.xx.xx.YY,methodName:queryYY,time:50 msè€—æ—¶ç»Ÿè®¡:clazzName:com.xx.xx.ZZ,methodName:queryZZ,time:500 msæˆ‘ä»¬åªéœ€è¦å»æ‰¾ä¸‹æ¸¸zzç³»ç»Ÿè´Ÿè´£äººæ²Ÿé€šæ¥å£è€—æ—¶é—®é¢˜å³å¯ 7.ä¸šåŠ¡è‡ªå®šä¹‰å¼‚å¸¸ä¼˜åŒ–å…³äºç³»ç»Ÿå†…éƒ¨è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ï¼Œå•ç³»ç»Ÿå†…éƒ¨å®šä¹‰ä¸€ä¸ªå³å¯ï¼Œå¦å¤–éœ€è¦é‡å†™Throwableä¸­fillInStackTraceæ–¹æ³•ï¼ŒåŸå› æœ‰äºŒï¼Œä¸€æ–¹é¢åŸfillInStackTraceæ–¹æ³•è¢«synchronizedä¿®é¥°ï¼Œå¦ä¸€æ–¹é¢fillInStackTraceæ–¹æ³•ä¸­è®¾ç½®äº†å¾ˆå¤šå †æ ˆä¿¡æ¯ï¼Œå¯¹äºè‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸æ¥è¯´æ˜¯ä¸å¤ªéœ€è¦çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344/** * è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ */public class BizException extends RuntimeException &#123; private static final long serialVersionUID = 1L; private String errorCode; private String errorMessage; public BizException(String errorCode, String errorMessage) &#123; this.errorMessage = errorMessage; this.errorCode = errorCode; &#125; public String getErrorCode() &#123; return this.errorCode; &#125; public void setErrorCode(String errorCode) &#123; this.errorCode = errorCode; &#125; public String getErrorMessage() &#123; return this.errorMessage; &#125; public void setErrorMessage(String errorMessage) &#123; this.errorMessage = errorMessage; &#125; //é‡å†™ä»¥æé«˜æ€§èƒ½ @Override public Throwable fillInStackTrace() &#123; return this; &#125; @Override public String toString() &#123; return &quot;AppRuntimeException&#123;&quot; + &quot;errorCode=&#x27;&quot; + errorCode + &#x27;\\&#x27;&#x27; + &quot;, errorMessage=&#x27;&quot; + errorMessage + &#x27;\\&#x27;&#x27; + &#x27;&#125;&#x27;; &#125;&#125; 8.é”™è¯¯æ–‡æ¡ˆè½¬æ¢å™¨æä¾›ç»™appå‰ç«¯æˆ–è€…webç®¡ç†åå°ç›¸å…³çš„å†™æ¥å£ï¼Œæ¥å£è¿”å›é”™è¯¯ç çš„æ—¶å€™ï¼Œå‰ç«¯åŒå­¦ä¸€èˆ¬ä¼štostæç¤ºç”¨æˆ·é”™è¯¯ä¿¡æ¯ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å‰ç«¯åŒå­¦è¦ä¹ˆå…¨éƒ¨æç¤ºç³»ç»Ÿå¤ªç«çˆ†äº†ï¼Œè¦ä¹ˆä¼šè·Ÿåç«¯åŒå­¦è¦æ¥å£çš„é”™è¯¯ç åˆ—è¡¨ï¼Œç„¶åè·Ÿäº§å“ä¸€èµ·ç¡®è®¤æ¯ä¸ªé”™è¯¯ç è¯¥tostä»€ä¹ˆä¿¡æ¯ï¼Œä¹‹åif else é”™è¯¯ç å’Œtostæ–‡æ¡ˆä¸€ä¸€æ˜ å°„ï¼Œå¦‚æœåç«¯æ–°åŠ äº†é”™è¯¯ç ï¼Œéœ€è¦å‰ç«¯ä¸€èµ·æ›´æ”¹ï¼Œæ²¡æœ‰åŠæ—¶é€šçŸ¥ï¼Œå¯èƒ½å‰ç«¯é¡µé¢ä¼šå¼¹å‡ºæŠ€æœ¯æ€§æ–‡æ¡ˆã€‚ å¦‚æœæ‰€æœ‰çš„å‹å¥½æ€§æç¤ºç»Ÿä¸€æ˜¯åç«¯ä¸‹å‘å‘¢ï¼Ÿæ˜¯ä¸æ˜¯å°±å¯ä»¥è§„é¿ç±»ä¼¼çš„é—®é¢˜ï¼Œå‰ç«¯åŒå­¦åªéœ€å…³å¿ƒå¦‚æœæ­£å¸¸è¿”å›ï¼Œæç¤ºæˆåŠŸï¼Œæ¥å£æ²¡æœ‰æˆåŠŸï¼Œç›´æ¥toståç«¯è¿”å›çš„é”™è¯¯msgæç¤ºå³å¯ï¼Œä½ å¥½æˆ‘å¥½å¤§å®¶å¥½ï½ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475###############ymlæ–‡ä»¶é…ç½®################é”™è¯¯ä¿¡æ¯è½¬æ¢ï¼Œç»™å‰ç«¯ä»¥å‹å¥½æç¤ºerrormsgconfig: errorMsgConvertMap: #keyä»¥controller_methodå‘½å PricingController_setPricing: default: ç³»ç»Ÿå¤ªç«çˆ†äº†ï¼Œè¯·æ‚¨ç¨åå†è¯•~ 0: å®šä»·æˆåŠŸ 1: ç³»ç»Ÿå¤ªç«çˆ†äº†ï¼Œè¯·æ‚¨ç¨åå†è¯•~ 5: è¯·åˆ·æ–°åé‡è¯• PricingController_getPricingOrderDetail: default: ç³»ç»Ÿå¤ªç«çˆ†äº†ï¼Œè¯·æ‚¨ç¨åå†è¯•~ -42: æ²¡æœ‰æƒé™ï¼###############configæ–‡ä»¶###############@Slf4j@ConfigurationProperties(prefix = &quot;errormsgconfig&quot;)@Component@Setter@Getterpublic class ErrorMsgConvertConf &#123; private Map&lt;String, Map&lt;String,String&gt;&gt; errorMsgConvertMap;&#125;###############é”™è¯¯æ–‡æ¡ˆè½¬æ¢Adapter###############/** * é”™è¯¯ä¿¡æ¯è½¬æ¢ï¼Œç»™å‰ç«¯ä»¥å‹å¥½æç¤º */@Slf4j@Servicepublic class ErrorMsgAdapter &#123; @Autowired private ErrorMsgConvertConf errorMsgConvertConf; /** * é”™è¯¯ä¿¡æ¯è½¬æ¢ï¼Œç»™å‰ç«¯ä»¥å‹å¥½æç¤º */ @Timer public void handlerErrorMsg(String convertKey, Response res) &#123; Map&lt;String, Map&lt;String, String&gt;&gt; errorMsgConvertMap = errorMsgConvertConf.getErrorMsgConvertMap(); Map&lt;String, String&gt; convertMap = errorMsgConvertMap.get(convertKey); if (StringUtils.isBlank(convertKey) || Objects.isNull(res)) &#123; log.info(&quot;ErrorMsgAdapter.handlerErrorMsg,å‚æ•°ä¸ºç©ºï¼Œç›´æ¥è¿”å›&quot;); return; &#125; log.info(&quot;å‡ºå‚è¿”å›ä¿¡æ¯è½¬æ¢å¼€å§‹ï¼ŒconvertKey:&#123;&#125;,oldRes:&#123;&#125;&quot;, convertKey, JSONObject.toJSONString(res)); if (ErrorCode.OK.getCode() == res.getStatus() &amp;&amp; !CollectionUtils.isEmpty(convertMap)) &#123; String codeMsg = convertMap.get(Integer.toString(ErrorCode.OK.getCode())); if (StringUtils.isNotBlank(codeMsg)) &#123; res.setErrMsg(codeMsg); &#125; &#125; else if (ErrorCode.OK.getCode() != res.getStatus() &amp;&amp; !CollectionUtils.isEmpty(convertMap)) &#123; String defaultMsg = convertMap.get(&quot;default&quot;); if (StringUtils.isBlank(defaultMsg)) &#123; defaultMsg = &quot;ç³»ç»Ÿå¤ªç«çˆ†äº†ï¼Œè¯·æ‚¨ç¨åå†è¯•~&quot;; &#125; String codeMsg = convertMap.get(Integer.toString(res.getStatus())); if (StringUtils.isNotBlank(codeMsg)) &#123; res.setErrMsg(codeMsg); &#125; else &#123; res.setErrMsg(defaultMsg); &#125; &#125; log.info(&quot;å‡ºå‚è¿”å›ä¿¡æ¯è½¬æ¢ç»“æŸï¼ŒconvertKey:&#123;&#125;,oldRes:&#123;&#125;&quot;, convertKey, JSONObject.toJSONString(res)); &#125;&#125;###############ä½¿ç”¨æ–¹æ³•#################controllerå‡ºå‚å‰è°ƒç”¨å³å¯ï¼ŒconvertKeyå»ºè®®ä½¿ç”¨controllerName_methodName//é”™è¯¯ç è½¬æ¢errorMsgAdapter.handlerErrorMsg(&quot;PricingController_setPricing&quot;, ret); 9.validationutilå¾ˆå¤šäººå–œæ¬¢åœ¨controllerå±‚çš„reqå‰é¢å¢åŠ  @Validatedï¼Œç›´æ¥å¯¹å…¥å‚è¿›è¡Œæ ¼å¼æ ¡éªŒï¼Œä½†æ˜¯è¿™æ ·åšå¦‚æœå­—æ®µæ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼Œä¸ä¼šè¿›è¡Œå…¥å‚æ‰“å°ï¼Œä¸åˆ©äºé—®é¢˜æ’æŸ¥ï¼Œå¦ä¸€æ–¹é¢æŠ›å‡ºçš„å¼‚å¸¸ä¹Ÿä¸æ˜¯æˆ‘ä»¬æŒ‡å®šçš„ã€‚ 12345678910111213141516171819202122232425262728293031import com.renrenche.pricing.process.exception.BizException;import com.renrenche.rest.protocol.ErrorCode;import lombok.extern.slf4j.Slf4j;import org.springframework.util.CollectionUtils;import javax.validation.ConstraintViolation;import javax.validation.Validation;import javax.validation.Validator;import javax.validation.ValidatorFactory;import java.util.Set;@Slf4jpublic class ValidationUtil &#123; private static ValidatorFactory factory = Validation.buildDefaultValidatorFactory(); public static &lt;T&gt; void validate(T t) &#123; Validator validator = factory.getValidator(); Set&lt;ConstraintViolation&lt;T&gt;&gt; constraintViolations = validator.validate(t); if(!CollectionUtils.isEmpty(constraintViolations))&#123; StringBuilder errMsg=new StringBuilder(&quot;å‚æ•°æ ¡éªŒå¤±è´¥&quot;); for (ConstraintViolation&lt;T&gt; constraintViolation : constraintViolations) &#123; errMsg.append(&quot;,&quot;).append(constraintViolation.getMessage()); &#125; log.info(&quot;ValidationUtilæ ¡éªŒå‚æ•°å¤±è´¥&quot;); throw new BizException(ErrorCode.PARAM_INVALID, errMsg.toString()); //æ­¤å¤„å¯ä»¥å®šä¹‰ä¸€ä¸ªä¸“é—¨çš„ä¸šåŠ¡å¼‚å¸¸ç å€¼æ¥ä»£è¡¨å‚æ•°å¼‚å¸¸ï¼Œmsgæ”¾çš„æ˜¯å…¨é‡ä¿¡æ¯ï¼Œå¯ä»¥forå¾ªç¯è¿”å›å…¨é‡æœªé€šè¿‡åŸå› ï¼Œä¹Ÿå¯ä»¥åªè¿”å›å•æ¡ï¼Œä¸è¿‡å¤šæ¬¡è¯·æ±‚è¿”å›çš„ä¿¡æ¯ä¼šæœ‰ä¸åŒã€‚ &#125; &#125;&#125;//ç”¨æ³• ä»£ç æ˜¾ç¤ºè°ƒç”¨ValidationUtil.validate(xxx); 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import com.renrenche.pricing.process.validation.ValidationUtil;import lombok.Getter;import lombok.NoArgsConstructor;import lombok.Setter;import org.hibernate.validator.constraints.Length;import javax.validation.constraints.*;import java.io.Serializable;import java.math.BigDecimal;import java.util.List;@Setter@Getter@NoArgsConstructorpublic class DemoReq implements Serializable &#123; @NotBlank(message = &quot;nameä¸èƒ½ä¸ºç©º&quot;) @Length(min = 6, max = 30, message = &quot;nameåº”è¯¥åœ¨6-30å­—ç¬¦ä¹‹é—´&quot;) private String name; @NotNull(message = &quot;å¹´é¾„ä¸èƒ½ä¸ºç©º&quot;) @Min(value = 18, message = &quot;å¹´é¾„å¿…é¡»å¤§äºç­‰äº18&quot;) @Max(value = 20, message = &quot;å¹´é¾„å¿…é¡»å°äºç­‰äº20&quot;) private Integer age; @NotEmpty(message = &quot;nameListä¸èƒ½ä¸ºç©º&quot;) private List&lt;String&gt; nameList; @Pattern(regexp = &quot;^(.+)@(.+)$&quot;, message = &quot;é‚®ç®±çš„æ ¼å¼ä¸åˆæ³•&quot;) private String email; private Byte type; private Integer type2; @Pattern(regexp = &quot;aaaaa|bbbbb|ccccc&quot;, message = &quot;type3ä¸åœ¨æšä¸¾èŒƒå›´å†…&quot;) private String type3; @DecimalMin(value = &quot;150&quot;, message = &quot;å¿…é¡»å¤§äºç­‰äº150&quot;) @DecimalMax(value = &quot;300&quot;, message = &quot;å¿…é¡»å°äºç­‰äº300&quot;) @Digits(integer=3,fraction = 2,message = &quot;æ•´æ•°ä½ä¸Šé™ä¸º3ä½ï¼Œå°æ•°ä½ä¸Šé™ä¸º2ä½&quot;) private BigDecimal money; public static void main(String[] args) &#123; DemoReq demoReq=new DemoReq(); demoReq.setName(&quot;1111111&quot;);// demoReq.setType3(&quot;222&quot;); ValidationUtil.validate(demoReq); &#125; //å¦‚æœæœ‰å¯¹è±¡å®ä½“ï¼Œéœ€è¦æ·±å…¥æ ¡éªŒå¯¹è±¡å†…éƒ¨å­—æ®µæ ¼å¼çš„ï¼Œéœ€è¦åœ¨å®ä½“ä¸Šå¢åŠ @validæ³¨è§£&#125; 10.ç»Ÿä¸€æ—¥å¿—æ‰“å°å„å…¬å¸å†…éƒ¨åº”è¯¥é’ˆå¯¹äºæ—¥å¿—æ‰“å°æ ¼å¼å½¢æˆä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒï¼Œæ–¹ä¾¿æ—¥å¿—é‡‡é›†ï¼Œä¸ç®¡æ˜¯æœ€ç»ˆæ”¶é›†åˆ°å…¬å¸å†…éƒ¨è‡ªå»ºæ—¥å¿—å¹³å°ï¼Œè¿˜æ˜¯elkï¼Œæ ¼å¼è¿˜æ˜¯å¾—ç»Ÿä¸€çš„ã€‚ æŠ›ç –å¼•ç‰ï¼š log4j2 é…ç½®ï¼š 1Pattern: &quot;[%X&#123;trace_id&#125;] %-d&#123;yyyy-MM-dd HH:mm:ss&#125; - [%p] [%C&#123;1&#125; %M] %m%n&quot; logbacké…ç½® 1&lt;pattern&gt;[%X&#123;trace_id&#125;] %d&#123;yyyy-MM-dd HH:mm:ss&#125; - [%level] [%class&#123;0&#125; %method] %msg%n&lt;/pattern&gt; æ—¥å¿—ç¤ºä¾‹ï¼š [ed02f4ae5f18415b8a0143100b585f0e] 2019-03-14 18:32:08 - [INFO] [LogController test] this is my log!!! å¦å¤–å¾ˆå…³é”®çš„æ—¥å¿—æ‰“å°å¿…ä¸å¯å°‘ï¼ŒåŒ…æ‹¬è‡ªå·±æ¥å£çš„å…¥å‚&amp;è¿”å›ï¼Œä»¥åŠè°ƒç”¨ä¸‰æ–¹rpcæ¥å£çš„å…¥å‚&amp;è¿”å›ï¼Œç”¨äºæŸ¥è¯¢çº¿ä¸Šé—®é¢˜ï¼Œè·Ÿä¸‰æ–¹æ‰¯çš® ï¼Œå±¡è¯•ä¸çˆ½ã€‚ 11.æ¥å…¥ç»Ÿä¸€æ—¥å¿—å¹³å°ä¹‹å‰æœåŠ¡æ˜¯å•ä½“æ¶æ„ï¼Œä¸€ä¸ªæœåŠ¡å°±å¯¹åº”ä¸€å°æœåŠ¡å™¨ï¼Œæ’æ’ç”Ÿäº§é—®é¢˜æ—¶ï¼Œç™»é™†æœåŠ¡å™¨å³å¯ã€‚ ç°åœ¨éƒ½æ˜¯å¾®æœåŠ¡æ¶æ„ï¼Œä¸€ä¸ªæœåŠ¡ä¸€èˆ¬å¯¹åº”å¤šå°æœåŠ¡å™¨ï¼Œjdã€é˜¿é‡Œä¹‹ç±»çš„æ ¸å¿ƒç³»ç»ŸæœåŠ¡å™¨ä¸€ä¸ªé¡¹ç›®éƒ½æ˜¯ä¸Šåƒä¸Šä¸‡å°ï¼Œæ­¤æ—¶æ’æŸ¥é—®é¢˜å¦‚æœä¸€å°ä¸€å°ç™»é™†å»æŸ¥æ‰¾å°±æ ¹æœ¬æ²¡æ³•å¤„ç†äº†ã€‚ æ‰€ä»¥ä¸€èˆ¬å…¬å¸å†…éƒ¨éƒ½ä¼šæœ‰è‡ªå»ºæ—¥å¿—å¹³å°æˆ–è€…elkæ¥æ”¯æŒç”Ÿäº§æ—¥å¿—çš„å­˜å‚¨åŠæŸ¥è¯¢ã€‚ ä¸€èˆ¬çš„ä¸€ä¸ªæŸ¥è¯¢æµç¨‹ï¼šæ ¹æ®å…³é”®è¯æŸ¥è¯¢åˆ°å•æ¡æ—¥å¿—ï¼Œè·å–åˆ°traceidï¼Œç„¶åç»§ç»­æ ¹æ®traceidæŸ¥è¯¢å‡ºæ¥æœ¬æ¬¡è¯·æ±‚çš„å…¨é‡æ—¥å¿—è¿›è¡Œæ’æŸ¥ã€‚ 12.æ—¥å¿—çº§åˆ«åŠ¨æ€å˜æ›´ä¸€èˆ¬æœ‰ä¸‰ä¸ªå¾ˆå®é™…çš„åœºæ™¯ä¼šä½¿ç”¨ï¼Œä¸€ä¸ªæ˜¯å¤§ä¿ƒï¼ˆåŒåä¸€ã€618ï¼‰ï¼Œä¸€ä¸ªæ˜¯ç§’æ€ï¼Œå¦ä¸€ä¸ªæ˜¯çº¿ä¸Šå‡ºé—®é¢˜ä½†æ˜¯è¿˜æœªå®šä½åˆ°é—®é¢˜æ—¶ã€‚ å‰ä¸¤ç§æ˜¯å› ä¸ºç”¨æˆ·åˆæ³•è¯·æ±‚éå¸¸å¤šï¼Œæ‰“å°çš„æ—¥å¿—éå¸¸å¤šï¼Œæœ€åä¸€ç§æ˜¯ç”¨æˆ·ä¼šé¢‘ç¹ç‚¹å‡»ï¼Œæµé‡æ¿€å¢ä¸”é”™è¯¯æ—¥å¿—æ‰“å°éå¸¸å¤šã€‚æ­¤æ—¶éƒ½ä¼šé€ æˆæœºå™¨ioå‹åŠ›éå¸¸å¤§ã€‚å†ä»‹ç»ä¸€ä¸‹ä¸€èˆ¬æƒ…å†µä¸‹è¿ç»´æ¸…ç†æœåŠ¡å™¨æ—¥å¿—çš„æµç¨‹ï¼Œä¸€èˆ¬æ˜¯å®šæ—¶æ¯éš”xxæ—¶é—´å»æ‰«ææœåŠ¡å™¨ç£ç›˜ç©ºé—´å‰©ä½™ç™¾åˆ†æ¯”ï¼Œåˆ°è¾¾é˜ˆå€¼ä¼šè¿›è¡Œæ—¥å¿—å¤‡ä»½ï¼Œä¹‹ååˆ é™¤æœåŠ¡å™¨ä¸Šæ—¥å¿—ã€‚ä½†æ˜¯ä¸Šé¢ä¸‰ç§æƒ…å†µä¸‹ï¼Œä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œé¦–å…ˆæ˜¯ç£ç›˜ioä¼šéå¸¸é«˜ï¼Œä¼šå½±å“æ¥å£æ€§èƒ½ï¼Œå¦å¤–åœ¨è¿ç»´åŒå­¦è„šæœ¬æ‰«æçš„é—´éš™ï¼Œç£ç›˜æ»¡äº†ï¼Œæ­¤æ—¶æœåŠ¡å°±åºŸäº†ï¼Œè¿™ç§å…³é”®æ—¶é—´ç‚¹å‡ºäº‹æƒ…ï¼ŒP0å°‘ä¸äº†ï¼Œè½»åˆ™ä¸ªäººæ‹œæ‹œï¼Œé‡åˆ™éƒ¨é—¨è§£æ•£ï¼Œåæœå¾ˆä¸¥é‡ã€‚ ä¸€èˆ¬ä¼šå¯¹æ—¥å¿—è¿›è¡Œçº§åˆ«çš„åŠ¨æ€è°ƒæ•´ï¼Œå¹³æ—¶çº¿ä¸Šä¸ºinfoï¼Œå¤§ä¿ƒæ—¶é™åˆ°errorï¼Œçº¿ä¸Šå¤§æµé‡æœåŠ¡å‡ºé—®é¢˜æ—¶ï¼Œå¯ä»¥å…³é—­erroræ—¥å¿—ã€‚æ›´ä¼˜åŒ–çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ—¶ä¸æŒ‰ç…§é¡¹ç›®çº§åˆ«ç»Ÿä¸€å¯¹æ—¥å¿—çº§åˆ«è¿›è¡Œè°ƒæ•´ï¼Œè¿˜æ˜¯é’ˆå¯¹å•ä¸ªçš„loggerç±»æ¥è¿›è¡Œè°ƒæ•´ï¼Œè¿™æ ·ä¼šæ›´æœ‰é’ˆå¯¹æ€§ä¸€äº›ï¼Œå› ä¸ºæ—¥å¿—é™çº§æ˜¯ä¸ªåŒåˆƒå‰‘ï¼Œä¼šæå‡ç³»ç»Ÿæ€§èƒ½ï¼Œä½†æ˜¯åŒæ ·ä¼šä¸¢å¤±æ—¥å¿—ã€‚ 13.ä¸æ»‘ä¸Šçº¿ä¸‰ä¸ªæ–¹é¢ã€‚ æŠ€æœ¯å±‚é¢ã€‚ ä¸šåŠ¡å±‚é¢ã€‚å‘ç‰ˆç»éªŒ ã€‚ æŠ€æœ¯å±‚é¢ï¼š ä»¥Nacosæ³¨å†Œä¸­å¿ƒä¸ºä¾‹ï¼ŒæœåŠ¡aæœ‰ä¸¤å°æœåŠ¡å™¨ï¼Œä¸€èˆ¬ä¸Šçº¿çš„æ—¶å€™å¤§å®¶å°±ç›´æ¥å…ˆéƒ¨ç½²æœåŠ¡å™¨1ï¼Œå¯åŠ¨æˆåŠŸåå†éƒ¨ç½²æœåŠ¡å™¨2ï¼Œæ­¤æ—¶ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Œç›´æ¥é‡å¯æœåŠ¡å™¨1çš„æ—¶å€™ï¼ŒNacosæ˜¯ä¸çŸ¥é“æœåŠ¡å™¨1ä¸‹çº¿äº†ï¼Œè¿˜ä¼šæŠŠè¯·æ±‚è½¬å‘åˆ°æœåŠ¡å™¨1ä¸Šé¢ï¼Œè¿‡ä¸€æ®µæ—¶é—´Nacoså¿ƒè·³æ£€æµ‹å‘ç°æœåŠ¡å™¨1å®•æœºäº†ï¼Œæ­¤æ—¶æ‰ä¼šåœæ­¢è½¬å‘è¯·æ±‚åˆ°æœåŠ¡å™¨1ï¼Œä½†æ˜¯ä¸Šæ¸¸æ¥çœ‹å·²ç»æœ‰è¶…æ—¶å¤±è´¥çš„è¯·æ±‚äº†ã€‚ ä¸€ä¸ªåˆç†çš„ä¸Šçº¿æµç¨‹æ˜¯å…ˆåœ¨Nacosä¸Šå¯¹æœåŠ¡å™¨1çš„æœºå™¨è¿›è¡Œä¸‹çº¿ï¼Œè§‚å¯ŸæœåŠ¡å™¨1æ—¥å¿—ï¼Œç¡®è®¤æ— è¯·æ±‚è¿›å…¥åï¼Œé‡å¯æœåŠ¡å™¨1ï¼Œæ­¤æ—¶Nacosä¼šè‡ªåŠ¨é‡æ–°ä¸Šçº¿æœåŠ¡å™¨1ï¼Œä¹‹åè§‚å¯ŸæœåŠ¡å™¨1æœ‰æ­£å¸¸è¯·æ±‚è¿›å…¥åï¼Œåœ¨Nacosä¸Šå¯¹æœåŠ¡å™¨2çš„æœºå™¨è¿›è¡Œä¸‹çº¿ï¼Œè§‚å¯ŸæœåŠ¡å™¨2çš„æ—¥å¿—ï¼Œç¡®è®¤æ— è¯·æ±‚è¿›å…¥åï¼Œé‡å¯æœåŠ¡å™¨2ï¼Œç¡®ä¿æœåŠ¡å™¨2è¯·æ±‚æ­£å¸¸è¿›å…¥ï¼Œæœ¬æ¬¡å‘ç‰ˆç»“æŸã€‚ ä¸ºå•¥éœ€è¦Nacosä¸Šå¯¹æœåŠ¡å™¨ä¸‹çº¿ä»¥åè¿˜è¦ç»§ç»­è§‚å¯Ÿæ—¥å¿—å‘¢ï¼Œå› ä¸ºåœ¨Nacosä¸‹çº¿ä¸€å°æœåŠ¡å™¨åï¼Œå®é™…ç”Ÿæ•ˆä¼šæœ‰ä¸€ä¸ªçŸ­æš‚çš„é—´éš”ã€‚ ä¸Šé¢è¿™æ ·åšå¯¹äºä¸€ä¸ªæœåŠ¡å°±ä¸‰äº”å°æœåŠ¡å™¨çš„æœºå™¨æ¥è¯´ï¼Œè¿˜ç®—æœ‰å¯æ“ä½œæ€§ï¼Œå¤§å‚é‡Œé¢æœåŠ¡å™¨éƒ½æ˜¯å‡ åå°èµ·æ­¥ï¼Œæœ‰çš„ä¸Šåƒå°ï¼Œè¿™æ ·ææ•ˆç‡å¾ˆä½ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¯ä¸ªå…¬å¸éƒ½ä¼šæœ‰è‡ªå»ºçš„å‘ç‰ˆå¹³å°ï¼ˆegï¼šdevopsï¼‰ï¼Œåœ¨å¯¹æœºå™¨å‘ç‰ˆçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è¿›è¡ŒæœåŠ¡æµé‡ä¸‹çº¿ã€å‘ç‰ˆã€ä¸Šçº¿è¿™æ ·çš„æ“ä½œï¼Œå¯¹ç”¨æˆ·æ¥è®²å°±æ˜¯é€‰æ‹©å‡ å°æœºå™¨ï¼Œç„¶åå‘ç‰ˆå°±okäº†ã€‚ ä¸šåŠ¡å±‚é¢ï¼š ç»å¸¸ä¼šæœ‰çš„ä¸€ä¸ªéœ€æ±‚æ˜¯å¯¹æŸä¸ªæ¥å£çš„æµç¨‹è¿›è¡Œå‡çº§ï¼Œè€Œä¸”è¿˜æœ‰å¯èƒ½æ˜¯é¢ è¦†æ€§çš„ï¼Œæ­¤æ—¶å¦‚æœç›´æ¥ä¸Šçº¿ï¼Œå‡ºç‚¹é—®é¢˜ï¼Œæ•´ä¸ªæµç¨‹éƒ½åºŸäº†ï¼ŒP0æ€•æ˜¯è·‘ä¸äº†ã€‚ ä¸€èˆ¬è¿™ç§é¢ è¦†æ€§æˆ–è€…é‡æ„æ€§è´¨çš„å‡çº§ä¼šä¿ç•™è€æµç¨‹çš„é€»è¾‘ï¼Œè¿™å°±ä¿è¯äº†æœ‰é—®é¢˜çš„å¿«é€Ÿæµç¨‹åˆ‡æ¢ï¼Œå¦å¤–ä¸€æ–¹é¢ä¼šå¯¹æ–°è€æµç¨‹è¿›è¡Œåˆ‡é‡ï¼Œä¸Šçº¿åéƒ½æ˜¯100%è€æµç¨‹ï¼Œä¹‹å1%æ–°æµé‡ï¼Œè§‚å¯Ÿï¼Œçœ‹è¯·æ±‚æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œæœ‰é—®é¢˜ï¼Œç«‹é©¬100%åˆ‡è€æµç¨‹ï¼Œæ²¡é—®é¢˜ï¼Œæ¥å£é€»è¾‘æ­£å¸¸ï¼Œç¬¦åˆé¢„æœŸï¼Œç»§ç»­5%ï¼Œ10%ï¼Œç›´åˆ°100%æ–°æµç¨‹ã€‚ å‘ç‰ˆç»éªŒï¼š å‘ç‰ˆçš„æ—¶å€™ä¸€å®šè¦å…ˆåªå‘ä¸€å°ï¼Œå®Œäº†ä»¥åè§‚å¯Ÿæœ¬æ¬¡ä»£ç ä¿®æ”¹éƒ¨åˆ†æ˜¯å¦æ­£å¸¸ï¼Œç„¶åä¹Ÿè¦è§‚å¯Ÿerroræ—¥å¿—ï¼Œçœ‹æ˜¯å¦æœ‰å½±å“å…¶ä»–æµç¨‹ï¼Œè§‚å¯Ÿä¸€æ®µæ—¶é—´æ— é—®é¢˜ï¼Œåœ¨æ‰¹é‡å¯¹å…¶ä»–æœåŠ¡å™¨è¿›è¡Œå‘ç‰ˆã€‚ æœ‰äº›å…¬å¸æœåŠ¡å™¨ä¼šåˆ†ç»„ï¼Œæœ‰çš„æŒ‰æœºæˆ¿åˆ†ç»„ï¼Œæœ‰çš„æŒ‰è°ƒç”¨æ–¹åˆ†ç»„ï¼Œæ­¤æ—¶ä¸åŒåˆ†ç»„çš„é…ç½®æ–‡ä»¶å¯èƒ½æ˜¯ä¼šæœ‰äº›ä¸åŒçš„ï¼Œæ‰€ä»¥æ­¤æ—¶å‘ç‰ˆéœ€è¦æ¯ä¸ªåˆ†ç»„çš„æœºå™¨å„è‡ªå‘ç‰ˆä¸€å°ï¼ŒæŒ‰ä¸Šè¿°æµç¨‹è¿›è¡Œè§‚å¯Ÿï¼Œæ— é—®é¢˜åï¼Œå¯¹å…¶ä»–æœºå™¨è¿›è¡Œæ‰¹é‡å‘ç‰ˆã€‚é…ç½®æ–‡ä»¶çš„å°‘é…ï¼Œé…é”™ç»å¸¸å‘ç”Ÿï¼Œå¯¹çº¿ä¸Šæ“ä½œä¸€å®šè¦ä¿æŒæ•¬ç•ä¹‹å¿ƒã€‚ 14.æœåŠ¡éš”ç¦»æ ¸å¿ƒæœåŠ¡éœ€è¦åˆ†ç»„éƒ¨ç½²æä¾›æœåŠ¡ï¼Œä¸¤ç§åœºæ™¯å¯ä»¥ä½¿ç”¨ï¼ŒæœåŠ¡æ˜¯å…¬å…±æœåŠ¡ï¼Œå…¶ä¸­ä¸€ä¸ªä¸šåŠ¡æ–¹ç‰¹åˆ«å…³é”®ï¼Œå…¬å¸é»„é‡‘é“¾è·¯ç§çš„ä¸€ç¯ï¼Œå¦ä¸€ä¸ªæ˜¯å¤šä¸ªä¸šåŠ¡æ–¹ï¼Œå…¶ä¸­ä¸€ä¸ªé‡çº§ç‰¹åˆ«å¤§ï¼Œå…¶ä»–çš„åŠ èµ·æ¥ä¹Ÿå°±ä¸€ä¸¢ä¸¢ï¼Œæ­¤æ—¶å¯ä»¥è¿›è¡ŒæœåŠ¡éš”ç¦»ã€‚ ç±»ä¼¼äºdubboç±»å‹çš„æœåŠ¡å¯ä»¥åˆ†ä¸åŒåˆ«åæ¥ä¾›ä¸åŒä¸šåŠ¡æ–¹ä½¿ç”¨æ¥åšåˆ°æœåŠ¡éš”ç¦» httpç±»å‹çš„æœåŠ¡å¯ä»¥æ ¹æ®ä¸šåŠ¡æƒ…å†µéƒ¨ç½²å¤šå¥—ï¼Œä¸¾ä¸ªä¾‹å­ï¼šnginx Aè½¬å‘åˆ°æœåŠ¡å™¨1å’Œ2ï¼Œnginx Bè½¬å‘åˆ°æœåŠ¡å™¨3å’Œ4ï¼Œä¸ç”¨ä¸šåŠ¡æ–¹è°ƒç”¨ä¸åŒçš„è¯·æ±‚é“¾æ¥æ¥è¿›è¡ŒæœåŠ¡éš”ç¦» 15.è¿œç¨‹rpcè°ƒç”¨è¶…æ—¶æ—¶é—´åŠé‡è¯•æ§åˆ¶ä¸ºä»€ä¹ˆè¦è¿›è¡Œè¶…æ—¶è®¾ç½®å‘¢ï¼Ÿ ç”±äºä¸‹æ¸¸æœåŠ¡å“åº”è¿‡æ…¢ã€çº¿ç¨‹æ­»é”ã€çº¿ä¸ŠBUGç­‰ä¸€ç³»åˆ—åŸå› å¯¼è‡´æˆ‘ä»¬ä½œä¸ºè°ƒç”¨æ–¹è°ƒç”¨ä¹‹åä¸€ç›´æ²¡æœ‰å“åº”ã€‚ä»è€Œæœ€ç»ˆå¯¼è‡´ç”¨æˆ·è¯·æ±‚é•¿æ—¶é—´å¾—ä¸åˆ°å“åº”ï¼ŒåŒæ—¶é•¿æ—¶é—´å æœ‰çº¿ç¨‹èµ„æºç”šè‡³ä¼šæ‹–å®æ•´ä¸ªæœåŠ¡å½±å“å…¶ä»–æ­£å¸¸è¯·æ±‚ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥è¿›è¡Œè¶…æ—¶è®¾ç½®ï¼Œè¿™æ˜¯å¾®æœåŠ¡ä¸­å¿«é€Ÿå¤±è´¥çš„ä¸€ä¸ªåŸºæœ¬æ‰‹æ®µã€‚ ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è®¾ç½®å‘¢ï¼Ÿ é€šå¸¸æœ‰ä¸¤ä¸ªå±‚é¢çš„è¶…æ—¶ï¼šæœåŠ¡çº§è¶…æ—¶ã€æ¥å£çº§åˆ«çš„è¶…æ—¶ã€‚æœåŠ¡çº§åˆ«çš„è¶…æ—¶æ—¶é—´ä¸€èˆ¬ä»¥æœ€æ…¢æ¥å£çš„è€—æ—¶æ—¶é—´ä¸ºåŸºå‡†ã€‚è€Œä¸”å¤§éƒ¨åˆ†æ¡†æ¶éƒ½åªä¼šæœ‰æœåŠ¡çº§çš„è¶…æ—¶è®¾ç½®ï¼Œå¾ˆå°‘æœ‰æ¥å£çº§çš„è¶…æ—¶è®¾ç½®ã€‚æ¥å£çº§çš„è¶…æ—¶è®¾ç½®ï¼Œæ²¡æœ‰å¿…è¦æ‰€æœ‰æ¥å£éƒ½è®¾ç½®ï¼Œä»…é’ˆå¯¹æµé‡æå¤§ã€æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„æ¥å£è¿›è¡Œå•ç‹¬è®¾ç½®å°±è¡Œã€‚ ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼ŒæœåŠ¡è¶…æ—¶æ—¶æˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ åŸºäºè¿™ä¸ªè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸Šä¸‹æ¸¸ã€æµé‡ã€ä¸šåŠ¡åœºæ™¯è¿™ä¸‰ä¸ªç»´åº¦è¿›è¡Œè€ƒé‡ã€‚ è¶…æ—¶çš„å¤„ç†æ‰‹æ®µä¸€èˆ¬æœ‰ä¸¤ç§ï¼šé‡è¯•ã€å¼‚å¸¸å¿«é€Ÿè¿”å›ã€‚å†™åœºæ™¯é€šå¸¸ä¸è¦é‡è¯•ï¼ˆä¼šæœ‰å¹‚ç­‰ç›¸å…³é—®é¢˜ï¼Œä¸åŒæ¥å£å¹‚ç­‰å®ç°æ–¹å¼ä¸åŒï¼‰ã€‚æµé‡è¾ƒå¤§çš„æ¥å£ä¸€èˆ¬ä¸é€‚åˆé‡è¯•ï¼Œç›´æ¥è¿”å›å¼‚å¸¸å°±å¥½ï¼Œæœ€æç«¯çš„åœºæ™¯ä¸‹å®¹æ˜“å¯¼è‡´æµé‡ç¿»nå€ï¼Œå¯¼è‡´åé¢çš„é“¾è·¯å¥”æºƒã€‚ å…·ä½“è¶…æ—¶æ—¶é—´å’Œé‡è¯•æ¬¡æ•°å»ºè®®æ ¹æ®ä¸‹æ¸¸æ¥å£çš„å‹æµ‹TP999æ¥è¿›è¡Œè®¾ç½®ã€‚ egï¼šaæœåŠ¡ä¾èµ–bï¼ˆè¯»ï¼‰ã€cï¼ˆè¯»ï¼‰ã€dï¼ˆå†™ï¼‰æœåŠ¡ï¼ŒbæœåŠ¡tp999ä¸º15msï¼ŒcæœåŠ¡tp999ä¸º100msï¼ŒdæœåŠ¡tp999ä¸º20msï¼ŒaæœåŠ¡è¦æ±‚tp999å¿…é¡»åœ¨200msä»¥å†…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¾ç½®ï¼š bæœåŠ¡ï¼ˆè¶…æ—¶æ—¶é—´20msï¼Œé‡è¯•ä¸€æ¬¡ï¼‰ CæœåŠ¡ï¼ˆè¶…æ—¶æ—¶é—´120msï¼Œä¸é‡è¯•ï¼‰ dæœåŠ¡ï¼ˆè¶…æ—¶æ—¶é—´30msï¼Œä¸é‡è¯•ï¼‰ bæç«¯æƒ…å†µ20*2+cæç«¯120+dæç«¯30=190ms&lt;200ms 16.å¹‚ç­‰å¤„ç†æ¥å£çš„å¹‚ç­‰ä¸€èˆ¬é‡‡ç”¨ä¸¤å±‚é˜²æŠ¤æªæ–½è¿›è¡Œé˜²é‡è®¾è®¡ã€‚ é¦–å…ˆä¸€èˆ¬æ¥å£ä¼šåŠ ä¸Šè°ƒç”¨è¯·æ±‚æµæ°´å·å­—æ®µ 1.Redisçš„åˆ†å¸ƒå¼é”æ¥è§£å†³åŒç±»å‹è¯·æ±‚çš„å¹¶å‘ï¼ˆç›¸åŒç”¨æˆ·å¹¶å‘è¯·æ±‚ï¼Œçœ‹æƒ…å†µï¼Œæœ‰çš„ä¸šåŠ¡ä¹Ÿå¯ä»¥ä¸éœ€è¦ï¼Œå› ä¸ºæ¯•ç«Ÿæœ‰æ•°æ®çœ‹å…œåº•ï¼‰ 2.1åˆ†å¸ƒå¼é”ä¸­æŒ‰ç…§è¯·æ±‚æµæ°´å·æŸ¥è¯¢æ•°æ®ï¼Œæœ‰è®°å½•åˆ™ç›´æ¥è¿”å›ç°æœ‰æ•°æ®çŠ¶æ€åŠæ•°æ®ï¼Œæ— è®°å½•ç»§ç»­å¾€ä¸‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 2.2åˆ†å¸ƒå¼é”ä¸­æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åä¿å­˜ä¸šåŠ¡æ•°æ®ï¼Œé€šè¿‡æŠ“å–ä¿å­˜æ—¶æ•°æ®åº“æŠ¥å”¯ä¸€é”®å€¼å†²çªé”™æ¥è¾¾åˆ°å¹‚ç­‰å¤„ç†ï¼Œè¿”å›æ•°æ®ç°æœ‰æƒ…å†µ 3.DBå±‚ï¼Œè¯·æ±‚å”¯ä¸€æµæ°´å·è®¾ç½®å”¯ä¸€ç´¢å¼•ï¼Œä¿è¯DBåº•å±‚åªæœ‰ä¸€æ¡æ•°æ®å…¥åº“ã€‚ é€šå¸¸æƒ…å†µå¹‚ç­‰æ“ä½œä¼šæŒ‰ç…§ä¸Šè¿°é€»è¾‘è¿›è¡Œï¼Œç›¸åŒæµæ°´å·æ€ä¹ˆè¯·æ±‚ï¼Œè¿”å›çš„éƒ½æ˜¯å½“å‰æ—¶é—´ç‚¹è¯¥æ¡æ•°æ®çš„çœŸå®æƒ…å†µï¼Œä½†æ˜¯ä¹Ÿæœ‰åšçš„ç®€å•çš„æƒ…å†µï¼ŒæŒ‰ç…§æµæ°´å·æŸ¥è¯¢ï¼Œæœ‰æ•°æ®ï¼ŒæŠ›å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ä¸Šæ¸¸é”™è¯¯ç ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„å¦‚æœç”¨è¿™ç§æ–¹å¼ï¼Œä¸€æ–¹é¢éœ€è¦ä¿è¯è¯¥æ¥å£å¹‚ç­‰é”™è¯¯ç å”¯ä¸€ï¼Œä¸è¦å…¶ä»–æ ¡éªŒå¤±è´¥ä¹Ÿè¿”å›è¿™ä¸ªé”™è¯¯ç ï¼Œå¦ä¸€æ–¹é¢è¦æš´éœ²æŸ¥è¯¢æ¥å£ï¼Œè®©ä¸Šæ¸¸æ”¶åˆ°è¯¥é”™è¯¯ç åå¯ä»¥ç»§ç»­è¿›è¡ŒæŸ¥è¯¢æ¥å¾—åˆ°æœ€æ–°çš„çŠ¶æ€ç­‰ä¿¡æ¯ï¼Œä¸€èˆ¬å»ºè®®ç”¨ä¸Šé¢çš„æ–¹æ¡ˆï¼Œä½ å¥½æˆ‘å¥½å¤§å®¶å¥½ï¼Œå¤§å®¶å†™ä»£ç éƒ½æŒºèˆ’æœå¯¹å§ã€‚ ä¸‰ã€æ•°æ®æ²»ç†1.æ…¢æŸ¥è¯¢æ²»ç†å…¬å¸å†…éƒ¨æœ‰æ…¢sqlç›¸å…³è‡ªåŠ¨æŠ¥è­¦æœ€å¥½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°½é‡æ¯éš”ä¸€æ®µæ—¶é—´ä¸»åŠ¨æ‰¾dbaçœ‹çœ‹è‡ªå·±è´Ÿè´£ç³»ç»Ÿç›¸å…³åº“è¡¨ä¸­æ˜¯å¦æœ‰æ…¢sqlï¼Œç„¶ååœ¨æ ¹æ®ä¸åŒåœºæ™¯æ¥å†³å®šä¼˜åŒ–ä¸šåŠ¡æµç¨‹æˆ–è€…ä¿®æ”¹å¢åŠ ç´¢å¼•ã€‚ 2.æ•°æ®å¤‡ä»½ä¸æ¢å¤æ ¸å¿ƒæœåŠ¡æ•°æ®åº“ä¸»ä»åŒæ­¥è¿˜æ˜¯éœ€è¦æœ‰çš„ï¼Œä¸»åº“å‡ºé—®é¢˜çš„æ—¶å€™å¯ä»¥å¾ˆå¿«çš„è¿›è¡Œä¸»ä»åˆ‡æ¢ï¼Œå¦ä¸€æ–¹é¢å˜ç›¸çš„åšäº†æ•°æ®å¤‡ä»½ï¼Œå¦‚æœä¸€äº›éå®æ—¶æŸ¥è¯¢é€»è¾‘ä¹Ÿå¯ä»¥èµ°ä»åº“ã€‚ 3.å†·çƒ­æ•°æ®åˆ†ç¦»å†·çƒ­æ•°æ®åˆ†ç¦»å¯ä»¥æœ‰ä¸¤ä¸ªå±‚é¢çš„åˆ†ç¦»ï¼Œä¸€ä¸ªæ˜¯æŠŠéå¸¸çƒ­ç‚¹çš„æ•°æ®æ”¾åˆ°ç¼“å­˜ä¸­ï¼ŒæŸ¥è¯¢çš„æ—¶å€™çƒ­ç‚¹æ•°æ®ä»ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œéçƒ­ç‚¹æ•°æ®æŸ¥è¯¢æ•°æ®åº“ï¼›å¦ä¸€ä¸ªå±‚é¢å†·çƒ­å¯ä»¥æŒ‡æ¯”å¦‚è¿‘ä¸€å¹´çš„æ•°æ®ç›¸å¯¹ç»å¸¸æŸ¥è¯¢ï¼Œæ”¾åˆ°ä¸€å¼ ä¸šåŠ¡è¡¨ä¸­ï¼Œä¸€å¹´å‰çš„æ•°æ®åœ¨å¦ä¸€å¼ è¡¨ä¸­ï¼Œè¿™æ ·åœ¨æŸ¥è¯¢æ­£å¸¸ä¸šåŠ¡çš„æ—¶å€™è¡¨ä¸­æ•°æ®å°½å¯èƒ½çš„å°‘ï¼Œæ€§èƒ½ç›¸å¯¹å°±æé«˜äº†ï¼Œéœ€è¦æŸ¥è¯¢å†å²æ•°æ®æ—¶æŸ¥è¯¢å¦å¤–çš„è¡¨æˆ–è€…åº“ã€‚ 4.å†å²æ•°æ®å½’æ¡£è·Ÿå†·çƒ­æ•°æ®åˆ†ç¦»æœ‰äº›å¼‚æ›²åŒå·¥ä¹‹å¤„ï¼Œæ¯”å¦‚é“¶è¡Œæµæ°´æŸ¥è¯¢ï¼Œå¯ä»¥åœ¨Appå†…æŸ¥è¯¢è¿‘ä¸€ä¸¤å¹´çš„æ•°æ®ï¼ŒæŸ¥è¯¢å†å²æ•°æ®éœ€è¦å»è¥ä¸šå…æŸ¥è¯¢ï¼Œç›¸å½“äºä¸šåŠ¡åº“ä¸­åªä¿ç•™è¿‘ä¸€ä¸¤å¹´çš„æ•°æ®ï¼Œå†å¾€å‰ä¹‹å‰çš„æ•°æ®ä¼šåšå½’æ¡£ï¼Œæ”¾åˆ°æ¯”å¦‚ESæˆ–è€…hbaseç­‰å¤§æ•°æ®å­˜å‚¨ä»‹è´¨ä¸­ å››ã€å˜æ›´ç®¡æ§1.å‘å¸ƒã€èµ„æºå˜æ›´æ¯æ¬¡ä¸Šçº¿å‰ï¼Œå‡†å¤‡æœ¬æ¬¡ä¸Šçº¿checklistï¼ŒåŒ…å«æ•°æ®åº“å˜æ›´ï¼Œæ•°æ®åº“åˆå§‹åŒ–æ•°æ®ï¼Œé…ç½®æ–‡ä»¶ï¼Œå‘ç‰ˆå…ˆåé¡ºåºï¼Œç›¸å…³æ•°æ®åº“ã€redisã€mqç­‰èµ„æºç”³è¯·ç­‰ 2.æ•°æ®å˜æ›´æ•°æ®åº“å˜æ›´è¡¨ç»“æ„ï¼Œäººå·¥æ’å…¥ã€ä¿®æ”¹ã€å˜æ›´çº¿ä¸Šæ•°æ®ï¼Œéœ€è¦ç»è¿‡è¯„ä¼°ã€‚ egï¼šä¿®æ”¹æ•°æ®æ˜¯å¦ä¼šå¯¹çº¿ä¸Šæµç¨‹é€ æˆå½±å“ï¼Œå¢åŠ ç´¢å¼•æ—¶åº“ä¸­å¤šå°‘æ•°æ®ï¼Œå¤§ä½“éœ€è¦å¤šé•¿æ—¶é—´ç­‰ç­‰ 3.æµé‡ç°åº¦çº¿ä¸Šæœ‰10å°æœåŠ¡æ­£åœ¨æä¾›æœåŠ¡ï¼Œå‘ç‰ˆçš„æ—¶å€™ç›´æ¥ä¸€è‚¡è„‘å…¨éƒ½å‘ç‰ˆä¹ˆï¼Œå¦‚æœä»£ç æ¯”å¦‚æœ‰äº›é…ç½®æœ‰é—®é¢˜ï¼Œçº¿ä¸Šæœºå™¨å°±å…¨éƒ¨å®Œè›‹äº†ã€‚ å¯ä»¥ä¸¤ä¸ªæ–¹é¢å¤„ç†ï¼Œä¸€ä¸ªæ˜¯åœ¨å¯åŠ¨10å°æœåŠ¡ï¼Œæµé‡0ï¼Œä¿è¯æ–°çš„é¡¹ç›®èµ·æ¥åï¼Œé€æ­¥10%ã€20%ã€‚ã€‚ã€‚100%æŠŠæµé‡åˆ‡è¿‡æ¥ï¼Œäº¦æˆ–æ˜¯10å°é‡Œé¢æ‰¾ä¸€å°å…ˆå‘å¸ƒï¼Œå¹¶åœ¨å¯åŠ¨åè¿›è¡Œè§‚å¯Ÿï¼Œæ˜¯å¦æœ‰é—®é¢˜ï¼Œåœ¨é€æ­¥å¯åŠ¨å…¶ä»–æœºå™¨ã€‚ 4.A/B Testingä½¿ç”¨è€ç‰ˆæœ¬ï¼Œä¸€éƒ¨åˆ†ç”¨æˆ·å¼€å§‹ç”¨æ–°ç‰ˆæœ¬ï¼Œå¦‚æœç”¨æˆ·å¯¹æ–°ç‰ˆæœ¬æ²¡æœ‰ä»€ä¹ˆæ„è§ï¼Œé‚£ä¹ˆé€æ­¥æ‰©å¤§èŒƒå›´ï¼ŒæŠŠæ‰€æœ‰ç”¨æˆ·éƒ½è¿ç§»åˆ°æ–°ç‰ˆæœ¬ä¸Šé¢æ¥ æŸäº›åŠŸèƒ½ä¸Šçº¿å‰ååŒºåˆ«å¾ˆå¤§ï¼Œæ­¤æ—¶å¯ä»¥åç«¯ä¸¤å¥—é€»è¾‘ï¼ŒåŸºäºç”¨æˆ·å”¯ä¸€idå–æ¨¡ï¼Œä¿è¯ç›¸åŒçš„ç”¨æˆ·æ¯æ¬¡è¿›æ¥çœ‹åˆ°çš„éƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸è¦æ¯æ¬¡è¿›æ¥ä¸€ä¼šæ–°ç‰ˆï¼Œä¸€ä¼šè€ç‰ˆã€‚ ABå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯åŸºäºç”¨æˆ·ç»´åº¦åšä¸€äº›äº‹æƒ…ï¼Œè€Œæµé‡ç°åº¦åˆ™ä¸careè¿™äº›ï¼Œæ•´ä½“æµé‡ç™¾åˆ†æ¯”æ¥çš„ï¼Œå¯èƒ½ç”¨æˆ·ä¸€ä¼šèµ°åˆ°æ–°ä»£ç é‡Œï¼Œä¸€ä¼šè€ä»£ç é‡Œ äº”ã€å®¹é‡è¯„ä¼°1.å…¨é“¾è·¯å‹æµ‹å‹æµ‹æŒ‡çš„åŸºäºå½“å‰è´Ÿè´£çš„ç³»ç»Ÿä¸ºå…¥å£ï¼Œè€Œå…¨é“¾è·¯æŒ‡çš„æ˜¯åŸºäºé¡µé¢è®¿é—®çš„æ¥å£ä½œä¸ºå…¥å£ã€‚ ç±»ä¼¼äº618ï¼Œä¸šåŠ¡ä¼šæ ¹æ®å¾€å¹´æµé‡æ¥é¢„ä¼°æœ¬æ¬¡çš„æµé‡ï¼ŒæŠ€æœ¯ä¾§ä¹ŸåŒæ ·ä¼šåŸºäºå¾€å¹´æ¯æ¬¡çš„å¢é‡æ¥è¿›è¡Œé¢„ä¼°ï¼Œçœ‹æ˜¯å¦å¯ä»¥åŒ…ä½ä¸šåŠ¡çš„é¢„ä¼°æ•°æ®ï¼Œæ¯ä¸ªæ¥å£éƒ½ä¼šæ¢³ç†è¿›4-5æ¬¡å¤§ä¿ƒçš„æµé‡å³°å€¼æ•°æ®ï¼Œä»¥æ¬¡è¿›è¡Œæ¨ç®—ï¼Œæœ€ç»ˆå†³å®šå‡ºæ¥æœ¬å¹´åº¦å…¨é“¾è·¯å‹æµ‹é‡çº§ã€æ¯ä¸ªæ¥å£çš„å‹æµ‹é‡çº§ã€‚ä¹‹åå‹æµ‹é‡çº§åŒæ­¥ä¸‹æ¸¸ï¼Œæœ€å¤–å±‚å‹æµ‹æ¥å£æ¯”å¦‚è¦æ±‚tps10w/sï¼Œä¸‹æ¸¸å„æ¥å£æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œæ•°å€¼è°ƒæ•´ï¼Œæ²¡æœ‰å¾ªç¯è°ƒç”¨çš„å¯ä»¥å®šä½11-12w/sï¼Œæœ‰å¾ªç¯è°ƒç”¨çš„ä¸‹æ¸¸éœ€è¦è¿›è¡Œç›¸åº”çš„ç¿»å€æ“ä½œï¼Œä½œä¸ºåº•å±‚æœåŠ¡çš„éœ€è¦æ²Ÿé€šå„ä¸Šæ¸¸è°ƒç”¨æ–¹ï¼Œæ±‡æ€»å¾—å‡ºç³»ç»Ÿæœ¬æ¬¡éœ€è¦æ”¯æŒçš„tpsé‡çº§ã€‚ æ¥ä¸‹æ¥å°±æ˜¯å„ä¸šåŠ¡ç³»ç»Ÿå‹æµ‹å„è‡ªæ¥å£ï¼Œéƒ½è¾¾æ ‡åï¼Œè¿›è¡Œå¤šè½®å…¨é“¾è·¯å‹æµ‹ï¼ˆå†›æ¼”ï¼‰ï¼Œè¿˜ä¼šåœ¨çº¿ä¸Šè¿›è¡Œç ´åæ€§å‹æµ‹ï¼Œé‡çº§è¾¾åˆ°ç›®æ ‡åç»§ç»­å¾€ä¸Šèµ°ï¼Œç›´åˆ°ä¸‹æ¸¸æœ‰æœåŠ¡æ‰›ä¸ä½ä¸ºæ­¢ï¼Œå¯¹ç³»ç»Ÿè®¾è®¡ã€ä»£ç ç¼–å†™éƒ½æœ‰éå¸¸å¤§çš„è€ƒéªŒï¼Œä¸‹æ¸¸ç³»ç»ŸæŒ‚äº†ï¼Œå¦‚ä½•å°½å¯èƒ½çš„ä¸å½±å“è‡ªèº«ä¸šåŠ¡ï¼Œå¹¶ä¸”ç­‰å¾…ä¸‹æ¸¸æ¢å¤åå¦‚ä½•é‡è¯•è¿™æ®µæ—¶é—´å†…çš„è¯·æ±‚ç­‰ç­‰ï½ 2.å®¹é‡è§„åˆ’æœåŠ¡ä¸Šçº¿ç”³è¯·å¤šå°‘å°æœåŠ¡å™¨ï¼Ÿå¤šå°‘å°æœåŠ¡å™¨å¯ä»¥åº”å¯¹æœ¬æ¬¡å¤§ä¿ƒæµé‡å³°å€¼ï¼Ÿ egï¼šæ¯”å¦‚ä¸€ä¸ªé¡¹ç›®ä¸­åªæœ‰ä¸€ä¸ªæ™®é€šçš„æ²¡æœ‰ä½¿ç”¨å¤šçº¿ç¨‹çš„æ¥å£ï¼Œæ¥å£tp999åœ¨200msï¼Œå¯ä»¥é¢„ä¼°ä¸€ç§’ä¸€ä¸ªçº¿ç¨‹å¤„ç†5ä¸ªè¯·æ±‚ï¼Œå®¹å™¨ï¼ˆå¦‚tomcatï¼‰é…ç½®200çº¿ç¨‹ï¼Œé‚£ä¹ˆå•æœºå¯ä»¥æ”¯æ’‘1000tpsï¼Œè¦æ±‚1w tpsï¼Œæœ€å°‘éœ€è¦10å°æœºå™¨ï¼Œä¸ºäº†ä¸€äº›æç«¯æƒ…å†µå¯ä»¥å…ˆç”³è¯·12-15å°è¿›è¡Œå‹æµ‹ï¼Œçœ‹æœåŠ¡å™¨å„é¡¹æŒ‡æ ‡æƒ…å†µï¼Œåœ¨è¾¾æ ‡çš„æ—¶å€™cpu60-80%ä¸ºå®œï¼Œè¿™æ ·å¤©ç„¶çš„å¾®å³°å€¼ç•™æœ‰ä¸€äº›ä½™åœ°ã€‚ ä½¿ç”¨å¤šçº¿ç¨‹çš„æ¥å£ï¼Œéœ€è¦å¯¹çº¿ç¨‹è¿›è¡Œç¼–æ’ï¼Œè°ƒæ•´çº¿ç¨‹æ± çš„å„é¡¹å‚æ•°ä½¿æ€§èƒ½è¾¾åˆ°æœ€ä¼˜ï¼Œå•æœåŠ¡å™¨èƒ½å¤Ÿæ”¯æŒçš„å¹¶å‘è‚¯å®šæ˜¯ä½äºä¸Šé¢è¿™ç§æƒ…å†µï¼Œå…·ä½“èƒ½å¤Ÿæ”¯æŒå¤šå°‘ï¼Œéœ€è¦å‹æµ‹æ¥è¿›è¡Œç»Ÿè®¡ã€‚ ä½†æ˜¯ç°å®æƒ…å†µå¾€å¾€ä¸€ä¸ªé¡¹ç›®ä¸­æœ‰è‹¥å¹²ä¸ªæ¥å£ï¼Œæ­¤æ—¶æµé‡ç‰¹åˆ«å°çš„æ¥å£å¯ä»¥å¿½ç•¥ï¼Œæ¯”å¦‚tpsä½äº5çš„ï¼Œä¹‹åç»Ÿè®¡å„æ¥å£éœ€è¦å„è‡ªè¾¾åˆ°ä»€ä¹ˆé‡çº§çš„ç›®æ ‡ï¼Œä¹‹åè¿›è¡Œæ··å‹ï¼Œè¦æ±‚å„æ¥å£éƒ½è¦è¾¾æ ‡çš„æƒ…å†µä¸‹çœ‹éœ€è¦å¤šå°‘æœºå™¨ã€‚ 3.å¼¹æ€§èƒ½åŠ›å»ºè®¾æ­¤å¤„æ˜¯ç±»ä¼¼äºdevopså…¬å¸å‘ç‰ˆå¹³å°éœ€è¦è€ƒè™‘çš„ä¸€äº›é—®é¢˜ï¼Œé…åˆæµé‡é¢„æµ‹å’Œæ„ŸçŸ¥ï¼Œå‘ç°ç›®å‰æœåŠ¡æ‰¿è½½ä¸äº†è¯·æ±‚äº†ï¼ŒåŠ¨æ€å¯¹æœåŠ¡è¿›è¡Œæ‰©å®¹ å…­ã€é£é™©æ„ŸçŸ¥1.èµ„æºç›‘æ§ç›‘æ§æœåŠ¡å™¨ï¼Œå®¹å™¨jvmï¼Œmysqlï¼Œredisç­‰ç›¸å…³èµ„æºçš„ç›‘æ§ä¿¡æ¯ eg æœåŠ¡å™¨å†…å­˜ã€ç½‘ç»œã€ioï¼Œmysqlè¯»/å†™tpsã€æ…¢sqlã€å†…å­˜ã€å®¹é‡ã€è¿æ¥æ•°ã€ç½‘ç»œæµé‡ç­‰ï½ é…ä¸Šç›¸å…³é˜ˆå€¼æŠ¥è­¦ï¼Œå¼€å‘ã€è¿ç»´èƒ½å¤ŸåŠæ—¶çŸ¥é“ç›¸å…³èµ„æºé—®é¢˜ 2.ä¸šåŠ¡ç›‘æ§é’ˆå¯¹ä¸šåŠ¡æ•°æ®åˆ¶ä½œå®æ—¶æ•°æ®æŠ¥è¡¨ã€T+1æ•°æ®æŠ¥è¡¨ï¼Œæ¯æ—¥å…³æ³¨æ ¸å¿ƒä¸šåŠ¡æŠ¥è¡¨ï¼ˆç»Ÿè®¡å›¾ã€ç»Ÿè®¡è¡¨ï¼‰ï¼Œè§‚å¯ŸåŒç¯æ¯”ï¼Œæ˜¯å¦æœ‰å¼‚å¸¸ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ 3.å®‰å…¨ç›‘æ§è¿ç»´å›¢é˜Ÿé’ˆå¯¹ç½‘ç»œæ”»å‡»ï¼ˆegï¼šDDoSæ”»å‡»ï¼‰è¿›è¡Œç›‘æ§å¹¶è¿›è¡Œé˜²å¾¡åŠæŠ¥è­¦ 4.æ‹¨æµ‹é¡¹ç›®ä¸­æä¾›ç±»ä¼¼äº/healthçš„æ¥å£ï¼Œæ¥å£å†…æ— ä»»ä½•é€»è¾‘å³å¯ï¼Œæ‹¨æµ‹å¹³å°å®šæ—¶ï¼ˆegï¼šæ¯åˆ†é’Ÿï¼‰è°ƒç”¨ååªéœ€åˆ¤å®šhttpçŠ¶æ€ç 200å³å¯åŸºæœ¬æ–­å®šæœåŠ¡è¿˜æ´»ç€ï¼Œæ²¡æœ‰hangä½å¹¶ä¸”æœ‰èŠ‚ç‚¹åœ¨æä¾›æœåŠ¡ã€‚ 5.ç³»ç»Ÿå·¡æ£€èµ„æºç±»çš„æœ‰é—®é¢˜åŸºæœ¬éƒ½ä¼šæœ‰ç›¸å…³æŠ¥è­¦ï¼Œæœ‰äº›ä»£ç æŠ¥é”™ç­‰ç­‰ä¹‹ç±»çš„ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰æŠ¥è­¦å®ç°ï¼Œç›¸å¯¹äºæ¥è¯´æ¯”è¾ƒä¸å®¹æ˜“å‘ç°çš„æ˜¯ä¸šåŠ¡æ•°æ®ç±»çš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿå·¡æ£€æœºåˆ¶ä¿è¯ã€‚ æ­¤å¤„å°½é‡æ˜¯å»ºç«‹åœ¨ä¸šåŠ¡ç›‘æ§æŠ¥è¡¨å·²ç»å®Œæ¯•çš„åŸºç¡€ä¸Šï¼Œæ¯æ—¥å®‰æ’å€¼ç­åŒå­¦æŸ¥çœ‹ä¸šåŠ¡ç›‘æ§æŠ¥è¡¨ï¼ŒæŸ¥çœ‹ä¸šåŠ¡æ•°æ®é‡æ˜¯å¦å¤„äºä¸åˆç†çš„åŒºé—´æˆ–è€…æ˜¯æµé‡æ¿€å¢ä»¥åŠæµé‡æå…·å‡å°‘ï¼ŒåŠæ—¶å‘ç°å¹¶åˆ†æåŸå› ï¼ŒåŒæ­¥ä¸šåŠ¡åŒå­¦ã€‚ 6.é’‰é’‰ä¸šåŠ¡æŠ¥è­¦ä»£ç ä¸­å…³é”®çš„èŠ‚ç‚¹ï¼Œéœ€è¦å¢åŠ æŠ¥è­¦æœºåˆ¶ï¼Œå¯ä»¥ä½¿ç”¨å…¬å¸å†…éƒ¨çš„æŠ¥è­¦æ§ä»¶äº¦æˆ–é’‰é’‰æŠ¥è­¦ï¼Œåœ¨çº¿ä¸Šå‡ºç°ä¸€äº›é—®é¢˜çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å‘å‡ºæŠ¥è­¦æ¥é€šçŸ¥å¼€å‘ã€è¿ç»´åŒå­¦æ¥åŠæ—¶è§£å†³é—®é¢˜ã€‚ 7.tps/tp999/maxç›‘æ§ç›‘æ§å¹³å°ç›‘æ§æ¯ä¸€ä¸ªæ¥å£çš„tpsï¼Œtp99ï¼Œtp999ï¼Œmaxï¼Œæ ¹æ®tp999å¯ä»¥è¿›è¡Œæ¥å£ä¼˜åŒ–ï¼ŒmaxæŠ–åŠ¨å¯ä»¥è¿›ä¸€è¿›è¡Œè°ƒä¼˜ï¼Œçœ‹æ˜¯æœºå™¨é—®é¢˜ï¼ŒæŠ‘æˆ–æ˜¯gcçš„stwé—®é¢˜ã€ç½‘ç»œé—®é¢˜ã€è·¨æœºæˆ¿é—®é¢˜ç­‰ç­‰ã€‚ TP90å°±æ˜¯æ»¡è¶³90%çš„ç½‘ç»œè¯·æ±‚æ‰€éœ€è¦çš„æœ€ä½è€—æ—¶(90%çš„è¯·æ±‚è€—æ—¶æƒ…å†µ)ã€‚ TP99å°±æ˜¯æ»¡è¶³99%çš„ç½‘ç»œè¯·æ±‚æ‰€éœ€è¦çš„æœ€ä½è€—æ—¶ã€‚TP99=10msï¼Œæ ‡è¯†è¿™æ®µæ—¶é—´99%çš„è¯·æ±‚éƒ½åœ¨10æ¯«ç§’ä»¥å†…ã€‚ TP999å°±æ˜¯æ»¡è¶³999â€°çš„ç½‘ç»œè¯·æ±‚æ‰€éœ€è¦çš„æœ€ä½è€—æ—¶ã€‚ MAXå°±æ˜¯è¿™æ®µæ—¶é—´å†…è€—æ—¶æœ€å¤§çš„ï¼Œæ¯”å¦‚MAX=1000msï¼Œè¡¨ç¤ºè¿™æ®µæ—¶é—´æœ€è€—æ—¶çš„ä¸€æ¬¡è¯·æ±‚æ˜¯1sï¼Œmaxé«˜è¡¨ç¤ºå¶æœ‰ä¸€æ¬¡è¯·æ±‚ï¼Œè€—æ—¶å¾ˆå¤§ã€‚","categories":[{"name":"11.æ–¹æ³•è®º","slug":"11-æ–¹æ³•è®º","permalink":"https://zhangxin66666.github.io/categories/11-%E6%96%B9%E6%B3%95%E8%AE%BA/"}],"tags":[{"name":"æ–¹æ³•è®º","slug":"æ–¹æ³•è®º","permalink":"https://zhangxin66666.github.io/tags/%E6%96%B9%E6%B3%95%E8%AE%BA/"}]},{"title":"è¡Œé¡µç´¢å¼•åº•å±‚ç»“æ„","slug":"7.mysql/è¡Œé¡µç´¢å¼•åº•å±‚ç»“æ„","date":"2022-01-04T16:00:00.000Z","updated":"2024-08-22T03:23:14.709Z","comments":true,"path":"2022/01/05/7.mysql/è¡Œé¡µç´¢å¼•åº•å±‚ç»“æ„/","link":"","permalink":"https://zhangxin66666.github.io/2022/01/05/7.mysql/%E8%A1%8C%E9%A1%B5%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84/","excerpt":"","text":"å‰è¨€é¦–å…ˆæ˜ç¡®ä¸‹ä»€ä¹ˆæ˜¯ç´¢å¼•å‘¢ï¼Ÿå‡è®¾æˆ‘ä¸€å¼ æ•°æ®åº“çš„è¡¨å­˜äº†10äº¿æ¡æ•°æ®ï¼Œå¦‚æœè¦æŸ¥æ‰¾å‡ºå…¶ä¸­çš„10æ¡æ•°æ®ï¼Œå¦‚æœé€æ¡éå†åŒ¹é…çš„è¯ï¼Œæ•ˆç‡ä¸Šè‚¯å®šæ˜¯æ— æ³•å®¹å¿çš„ã€‚æ‰€ä»¥ä¸ºäº†æé«˜æ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå°±éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¸€äº›æ ¼å¼åŒ–çš„å­˜å‚¨ï¼Œæ¥æ–¹ä¾¿æˆ‘ä»¬æ›´å¿«çš„æŸ¥æ‰¾ï¼Œè¿™å°±æ˜¯ç´¢å¼•ã€‚ ç´¢å¼•å…¶å®æ˜¯å¯¹æ•°æ®æŒ‰ç…§æŸç§æ ¼å¼è¿›è¡Œå­˜å‚¨çš„æ–‡ä»¶ã€‚å°±InnoDBæ¥è®²ï¼Œç´¢å¼•æ–‡ä»¶é‡Œé¢ä¼šæœ‰å¾ˆå¤šçš„åŸºæœ¬å•å…ƒã€é¡µã€‘ï¼Œä¸ºä»€ä¹ˆè¦æœ‰é¡µå‘¢ï¼Ÿ å¦‚æœæˆ‘ä»¬åœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ç›´æ¥äº¤äº’ç£ç›˜ï¼Œæ•ˆç‡æ˜¾ç„¶åˆä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥çœŸæ­£å¤„ç†æ•°æ®çš„è¿‡ç¨‹å…¶å®æ˜¯åœ¨å†…å­˜ä¸­ï¼Œè¿™æ ·å°±éœ€è¦æŠŠç£ç›˜çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œå¦‚æœæ˜¯å†™æ“ä½œï¼Œå¯èƒ½è¿˜è¦å°†å†…å­˜çš„æ•°æ®å†æ¬¡åˆ·æ–°åˆ°ç£ç›˜ã€‚å¦‚æœå†…å­˜ä¸ç£ç›˜çš„æ•°æ®äº¤äº’è¿‡ç¨‹æ˜¯åŸºäºä¸€æ¡æ¡è®°å½•æ¥è¿›è¡Œçš„ï¼Œæ˜¾ç„¶åˆä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥InnoDBé‡‡å–çš„æ–¹å¼æ˜¯å°†æ•°æ®åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªé¡µï¼Œä»¥é¡µæ¥ä½œä¸ºå†…å­˜å’Œç£ç›˜äº¤äº’çš„åŸºæœ¬å•ä½ï¼Œé»˜è®¤å¤§å°ä¸º16KBã€‚ æ¢å¥è¯è®²ï¼Œå…¶å®å°±æ˜¯å†…å­˜ä¸€æ¬¡æ‹‰åˆ°ç£ç›˜çš„æ•°æ®æœ€å°‘æ˜¯16KBï¼Œå†…å­˜å†™å…¥ç£ç›˜çš„æ•°æ®ä¸€æ¬¡æœ€å°‘ä¹Ÿæ˜¯16KBã€‚ ä¸Šé¢è§£é‡Šæ¸…æ¥šäº†ç´¢å¼•å’Œé¡µï¼ŒMySQLçš„InnoDBå­˜å‚¨å¼•æ“æ˜¯åŸºäºé¡µæ¥è¿›è¡Œå†…å­˜å’Œç£ç›˜çš„æ•°æ®äº¤äº’çš„ã€‚æ‰€ä»¥æˆ‘ä»¬çš„æ•°æ®æˆ–è€…å«è®°å½•ï¼Œå…¶å®æ˜¯ä»¥ã€è¡Œã€‘çš„æ ¼å¼å­˜å‚¨åœ¨é¡µé‡Œé¢çš„ï¼Œå¯ä»¥ç®€å•çš„ç†è§£æˆé¡µé‡Œé¢çš„ä¸€è¡Œå¯¹åº”ä¸€æ¡è®°å½•ã€‚ å½“ç„¶ç´¢å¼•æ–‡ä»¶é‡Œé¢è‚¯å®šä¸å…‰åªæœ‰é¡µï¼Œè¿˜ä¼šæœ‰å…¶ä½™çš„ä¸œè¥¿ï¼Œé¡µé‡Œé¢ä¹Ÿä¸å…‰åªæœ‰è¡Œæ ¼å¼ï¼Œä¹Ÿä¼šæœ‰é¢å¤–çš„ä¿¡æ¯ï¼Œè¿™ä¸ªä¸‹é¢æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†æï¼Œè‡³æ­¤æˆ‘ä»¬ä»…ä»…éœ€è¦æ˜ç¡®ä¸€ä¸‹ç´¢å¼•çš„æ¦‚å¿µå’Œå±‚çº§å…³ç³»ã€‚ æ˜ç¡®äº†è¿™ä¸ªå±‚çº§å…³ç³»ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»æœ€åŸºç¡€çš„è¡Œæ ¼å¼æ¥è¿›è¡Œåˆ†æã€‚ ä¸€ã€è¡Œæˆ‘ä»¬å¹³æ—¶éƒ½æ˜¯ä»¥è®°å½•ä¸ºå•ä½å‘è¡¨ä¸­æ’å…¥æ•°æ®çš„ï¼Œè¿™äº›è®°å½•åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨å½¢å¼è¢«ç§°ä¸ºè¡Œæ ¼å¼æˆ–è€…è®°å½•æ ¼å¼ï¼Œæˆªè‡³ç›®å‰ï¼Œä¸€å…±æœ‰4ç§è¡Œæ ¼å¼ã€‚åˆ†åˆ«æ˜¯ compact redundant dynamic compressedï¼ŒMySQL5.7é»˜è®¤çš„è¡Œæ ¼å¼ä¸ºdynamicã€‚ 1. å¦‚ä½•æŒ‡å®šè¡Œæ ¼å¼é¦–å…ˆæ¥çœ‹ä¸‹ï¼Œæˆ‘ä»¬å¦‚ä½•æ¥æŒ‡å®šè¡Œæ ¼å¼å‘¢ï¼Ÿ 123CREATE TABLE è¡¨å (åˆ—çš„ä¿¡æ¯) ROW_FORMAT=è¡Œæ ¼å¼åç§° ALTER TABLE è¡¨å ROW_FORMAT=è¡Œæ ¼å¼åç§° æ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€å¼ è¡¨æ¥æŒ‡å®šè¡Œæ ¼å¼ï¼š 123456create table record_format( c1 varchar(10), c2 varchar(10) not null, c3 char(10), c4 varchar(10))charset=ascii row_format=compact; 2.compact è¡Œæ ¼å¼ä¸€æ¡å®Œæ•´çš„è¡Œæ ¼å¼å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šè®°å½•é¢å¤–ä¿¡æ¯çš„éƒ¨åˆ†&amp;è®°å½•çœŸå®æ•°æ®çš„éƒ¨åˆ†ã€‚ 2.1 é¢å¤–çš„ä¿¡æ¯å…ˆæ¥çœ‹é¢å¤–çš„ä¿¡æ¯ï¼Œå…¶å®åŒ…å«ä¸‰éƒ¨åˆ†ï¼šå˜é•¿å­—æ®µçš„é•¿åº¦åˆ—è¡¨ï¼ŒNULLå€¼åˆ—è¡¨å’Œè®°å½•å¤´ä¿¡æ¯ã€‚ 2.1.1 å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨MySQLæ”¯æŒå¾ˆå¤šçš„å˜é•¿å­—æ®µï¼Œæˆ‘ä»¬å°±ä»¥æœ€ç»å…¸çš„varcharæ¥è¿›è¡Œä¸¾ä¾‹ï¼Œå˜é•¿å­—æ®µçš„æ•°æ®å­˜å‚¨å¤šå°‘å­—èŠ‚å…¶å®æ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨å­˜å‚¨çœŸå®çš„æ•°æ®çš„æ—¶å€™ï¼Œè¦è®°å½•ä¸€ä¸‹çœŸå®æ•°æ®çš„å­—èŠ‚æ•°ï¼Œè¿™æ ·çš„è¯ï¼Œä¸€ä¸ªå˜é•¿å­—æ®µåˆ—å®é™…ä¸Šå°±å ç”¨äº†ä¸¤éƒ¨åˆ†çš„ç©ºé—´æ¥å­˜å‚¨ï¼šã€çœŸå®æ•°æ®ã€‘&amp;ã€çœŸå®æ•°æ®å ç”¨å­—èŠ‚æ•°ã€‘ æ³¨æ„ï¼šå¯¹äºä¸€ä¸ªåˆ—varchar(100)ï¼Œæˆ‘ä»¬å®é™…ä¸Šå­˜å‚¨ä¸€ä¸ª10å­—èŠ‚çš„æ•°æ®ï¼Œå½“åœ¨å†…å­˜ä¸­ä¸ºè¿™ä¸ªåˆ—çš„æ•°æ®åˆ†é…å†…å­˜ç©ºé—´çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šåˆ†é…100å­—èŠ‚ï¼Œä½†æ˜¯è¿™ä¸ªåˆ—çš„æ•°æ®åœ¨ç£ç›˜ä¸Šï¼Œå®é™…ä¸Šåªä¼šåˆ†é…10å­—èŠ‚ã€‚ åœ¨Compactè¡Œæ ¼å¼ä¸­ï¼Œä¼šæŠŠæ‰€æœ‰çš„å˜é•¿å­—æ®µå ç”¨çš„çœŸå®é•¿åº¦å…¨éƒ¨é€†åºå­˜å‚¨åœ¨è®°å½•çš„å¼€å¤´ä½ç½®ï¼Œå½¢æˆä¸€ä¸ªå˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ã€‚ æ¯”å¦‚æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„é‚£å¼ è¡¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š c1,c2,c4ä¸‰ä¸ªåˆ—éƒ½æ˜¯å˜é•¿å­—æ®µï¼Œæ‰€ä»¥è¿™ä¸‰ä¸ªåˆ—çš„å€¼çš„é•¿åº¦å…¶å®éƒ½éœ€è¦ä¿å­˜åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œå› ä¸ºè¿™å¼ è¡¨çš„å­—ç¬¦é›†çš„ASCIIï¼Œæ‰€ä»¥æ¯ä¸ªå­—ç¬¦å®é™…åªå ç”¨1å­—èŠ‚æ¥è¿›è¡Œç¼–ç ï¼š åˆ—å å‚¨å­˜å†…å®¹ å†…å®¹é•¿åº¦(åè¿›åˆ¶è¡¨ç¤º) å†…å®¹é•¿åº¦(åå…­è¿›åˆ¶è¡¨ç¤º) C1 â€˜aaaaâ€™ 4 0x04 C2 â€˜bbbâ€™ 3 0x03 C4 â€˜dâ€™ 1 0x01 å› ä¸ºè¿™äº›é•¿åº¦æ˜¯æŒ‰ç…§é€†åºæ¥å­˜æ”¾çš„ï¼Œæ‰€ä»¥æœ€ç»ˆå˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨çš„å­—èŠ‚ä¸²ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºçš„æ•ˆæœå°±æ˜¯ã€010304ã€‘ã€‚ å› ä¸ºæˆ‘ä»¬æ¼”ç¤ºçš„è¿™æ¡è®°å½•ä¸­ï¼Œc1,c2,c4åˆ—ä¸­çš„å­—ç¬¦ä¸²éƒ½æ¯”è¾ƒçŸ­ï¼Œæ‰€ä»¥çœŸå®çš„æ•°æ®å ç”¨çš„å­—èŠ‚æ•°å°±æ¯”è¾ƒå°ï¼ŒçœŸå®æ•°æ®çš„é•¿åº¦ç”¨ä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºï¼Œä½†æ˜¯å¦‚æœå˜é•¿åˆ—çš„å†…å®¹å ç”¨å­—èŠ‚æ•°æ¯”è¾ƒå¤šï¼Œå¯èƒ½å°±éœ€è¦ç”¨2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚å¯¹æ­¤InnoDBçš„è§„å®šæ˜¯ï¼š ã€Wã€‘ï¼šæŸä¸ªå­—ç¬¦é›†ä¸­è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦ä½¿ç”¨çš„å­—èŠ‚æ•° ã€Mã€‘ï¼šå½“å‰åˆ—ç±»å‹æœ€å¤šèƒ½å­˜å‚¨çš„å­—ç¬¦æ•°(æ¯”å¦‚varchar(100),M=100),å¦‚æœæ¢ç®—æˆå­—èŠ‚æ•°å°±æ˜¯W*M ã€Lã€‘ï¼šçœŸå®å ç”¨çš„å­—èŠ‚æ•° å¦‚æœM*W&lt;=255,é‚£ä¹ˆä½¿ç”¨1å­—èŠ‚æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å®é™…ç”¨åˆ°çš„å­—èŠ‚æ•°ã€‚ InnoDBåœ¨è¯»è®°å½•çš„å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨çš„æ—¶å€™ä¼šå…ˆå»æŸ¥çœ‹è¡¨ç»“æ„ï¼Œåˆ¤æ–­ç”¨å‡ ä¸ªå­—èŠ‚å»å­˜å‚¨çš„ã€‚ å¦‚æœM*W&gt;=255,è¿™ä¸ªæ—¶å€™å†æ¬¡åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š å¦‚æœL&lt;=127ï¼Œé‚£å°±ç”¨1ä¸ªå­—èŠ‚è¡¨ç¤º å¦åˆ™å°±ç”¨2ä¸ªå­—èŠ‚è¡¨ç¤º å¦‚æœæŸä¸ªå˜é•¿å­—æ®µå…è®¸å­˜å‚¨çš„æœ€å¤§å­—èŠ‚æ•°å¤§äº255çš„æ—¶å€™ï¼Œæ€ä¹ˆåŒºåˆ†ä»–æ­£åœ¨è¯»å–çš„å­—èŠ‚æ˜¯ä¸€ä¸ªå•ç‹¬çš„å­—æ®µé•¿åº¦è¿˜æ˜¯åŠä¸ªå­—æ®µé•¿åº¦å‘¢ï¼Ÿ InnoDBç”¨è¯¥å­—èŠ‚çš„ç¬¬ä¸€ä¸ªäºŒè¿›åˆ¶ä¸ºä½œä¸ºæ ‡å¿—ä½ï¼Œ0ï¼šå•ç‹¬çš„å­—æ®µé•¿åº¦ï¼Œ1ï¼šåŠä¸ªå­—æ®µé•¿åº¦ã€‚ å¯¹äºä¸€äº›å ç”¨å­—èŠ‚æ•°ç‰¹åˆ«å¤šçš„å­—æ®µï¼Œå•ä¸ªé¡µéƒ½æ— æ³•å­˜å‚¨çš„æ—¶å€™ï¼ŒInnoDBä¼šæŠŠä¸€éƒ¨åˆ†æ•°æ®æ”¾åˆ°æ‰€è°“çš„æº¢å‡ºé¡µï¼Œåœ¨å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ä¸­åªä¼šè®°å½•å½“å‰é¡µçš„å­—æ®µé•¿åº¦ï¼Œæ‰€ä»¥ç”¨ä¸¤ä¸ªå­—èŠ‚ä¹Ÿå¯ä»¥å­˜çš„ä¸‹ã€‚ æ­¤å¤–ï¼Œå˜é•¿å­—æ®µçš„é•¿åº¦åˆ—è¡¨ä¸­åªå­˜å‚¨çœŸå®æ•°æ®å€¼ä¸ºéNULLçš„åˆ—å ç”¨çš„é•¿åº¦ï¼ŒçœŸå®æ•°æ®ä¸ºNULLçš„åˆ—çš„é•¿åº¦æ˜¯ä¸å­˜å‚¨çš„ã€‚ ä¹Ÿå¹¶ä¸æ˜¯æ‰€æœ‰çš„è®°å½•éƒ½ä¼šæœ‰å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œå‡å¦‚è¡¨ä¸­çš„åˆ—è¦æ˜¯æ²¡æœ‰å˜é•¿å­—æ®µï¼Œæˆ–è€…è®°å½•ä¸­çš„å˜é•¿å­—æ®µå€¼éƒ½æ˜¯NULLï¼Œé‚£å°±æ²¡æœ‰å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨äº†ã€‚ 2.1.2 NULLå€¼åˆ—è¡¨å¦‚æœä¸€æ¡è®°å½•æœ‰å¤šä¸ªå­—æ®µçš„çœŸå®å€¼ä¸ºNULLï¼Œä¸ç»Ÿä¸€ç®¡ç†çš„è¯å°±ä¼šæ¯”è¾ƒå ç”¨ç©ºé—´ï¼Œæ‰€ä»¥æŠ½å–å‡ºæ¥äº†NULLå€¼åˆ—è¡¨ã€‚ å½“ç„¶å¦‚æœè¿™ä¸ªè¡¨çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯NOT NULLçº¦æŸçš„ï¼Œå°±ä¸ä¼šæœ‰NULLå€¼åˆ—è¡¨ã€‚ çœ‹ä¸€ä¸‹å¤„ç†è¿‡ç¨‹ï¼š é¦–å…ˆç»Ÿè®¡å‡ºè¡¨ä¸­å…è®¸å­˜å‚¨NULLçš„å­—æ®µ å¦‚æœè¡¨ä¸­æ²¡æœ‰NULLå­—æ®µçš„åˆ—ï¼Œé‚£å°±æ²¡å¿…è¦å†å¾€ä¸‹äº†ï¼Œå¦åˆ™å°†æ¯ä¸ªå…è®¸å­˜å‚¨NULLçš„åˆ—å¯¹åº”çš„ä¸€ä¸ªäºŒè¿›åˆ¶ä½æŒ‰ç…§åˆ—çš„é¡ºåºé€†åºæ’åˆ—ã€‚1ï¼šNULLï¼Œ0ï¼šä¸æ˜¯NULLã€‚ MySQLè§„å®šNULLå€¼å¿…é¡»ç”¨æ•´æ•°ä¸ªå­—èŠ‚çš„ä½è¡¨ç¤ºï¼Œå¦‚æœä½¿ç”¨çš„äºŒè¿›åˆ¶ä½ä¸ªæ•°ä¸æ˜¯æ•´æ•°ä¸ªå­—èŠ‚ï¼Œåˆ™åœ¨å­—èŠ‚çš„é«˜ä½è¡¥0ã€‚ ä»¥æ­¤ç±»æ¨ï¼Œå¦‚æœä¸€ä¸ªè¡¨ä¸­æœ‰9ä¸ªå­—æ®µå…è®¸ä¸ºNULLï¼Œé‚£ä¹ˆè¿™ä¸ªè®°å½•çš„NULLå€¼åˆ—è¡¨éƒ¨åˆ†å°±éœ€è¦2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ è¿™ä¸ªæ—¶å€™å†æ¥çœ‹æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„è¡¨ä¸­çš„è®°å½•ã€‚ 2.1.3 è®°å½•å¤´ä¿¡æ¯ç”±äº”ä¸ªå›ºå®šçš„å­—èŠ‚ç»„æˆï¼Œæ¢ç®—æˆäºŒè¿›åˆ¶å°±æ˜¯40ä½ï¼Œæ¯ä¸€éƒ¨åˆ†ä»£è¡¨ä¸åŒçš„ä¿¡æ¯ã€‚ åç§° å¤§å°(bit) æè¿° é¢„ç•™ä½1 1 æ²¡æœ‰ä½¿ç”¨ é¢„ç•™ä½2 1 æ²¡æœ‰ä½¿ç”¨ delete_mask 1 æ ‡è®°è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤ min_rec_mask 1 B+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®° n_owned 4 è¡¨ç¤ºå½“å‰è®°å½•æ‹¥æœ‰çš„è®°å½•æ•° heap_no 13 è¡¨ç¤ºå½“å‰è®°å½•åœ¨è®°å½•å †çš„ä½ç½®ä¿¡æ¯ record_type 3 è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ 0 ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éé¡µèŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½• next_record 16 ä¸‹ä¸€æ¡è®°å½•çš„ç›¸å¯¹ä½ç½® é™¤äº†è¡¨ä¸­æ˜¾å¼å®šä¹‰çš„åˆ—ï¼ŒMySQLä¼šå¾€æˆ‘ä»¬çš„è¡¨ä¸­æ”¾ä¸€äº›éšè—åˆ—ã€‚ åˆ—å æ˜¯å¦å¿…é¡» å ç”¨ç©ºé—´ æè¿° row_id å¦ 6å­—èŠ‚ è¡ŒIDï¼Œå”¯ä¸€æ ‡è¯†ä¸€æ¡è®°å½• transaction_id æ˜¯ 6å­—èŠ‚ äº‹åŠ¡ID roll_pointer æ˜¯ 7å­—èŠ‚ å›æ»šæŒ‡é’ˆ ã€row_idã€‘ï¼šè¿™ä¸ªç©æ„ï¼Œè·Ÿä¸»é”®çš„é€‰æ‹©æœ‰å…³ï¼Œå¦‚æœæˆ‘ä»¬æ˜¾å¼å®šä¹‰äº†è¡¨çš„ä¸»é”®ï¼Œå°±ä¸ä¼šæœ‰å®ƒï¼Œå¦‚æœæˆ‘ä»¬æ²¡æ˜¾å¼å®šä¹‰ä¸»é”®ï¼Œé‚£ä¹ˆä¼šå»é€‰æ‹©ä¸€ä¸ªuniqueçš„åˆ—ä½œä¸ºä¸»é”®ï¼Œå¦‚æœuniqueçš„åˆ—ä¹Ÿæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±ä¼šç”Ÿæˆä¸€ä¸ªrow_idåˆ—ä½œä¸ºéšè—çš„ä¸»é”®ã€‚ ã€transaction_idã€‘&amp;ã€roll_pointerã€‘å’Œä¸€è‡´æ€§éé”è¯»(MVCC)æœ‰å…³,åé¢é‡åˆ°çš„æ—¶å€™æˆ‘ä¼šåœ¨åˆ†æä»‹ç»ã€‚ åœ¨å®Œå–„ä¸‹æˆ‘ä»¬å¼€å¤´åˆ›å»ºçš„é‚£å¼ è¡¨çš„è®°å½•å½¢è±¡ã€‚ è‡³æ­¤ï¼Œå…¶å®å°±å‰©ä¸‹æˆ‘ä»¬æ˜¾å¼æ’å…¥æ•°æ®åº“çš„çœŸå®è®°å½•äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç±»å‹éœ€è¦è¯´æ˜ä¸€ä¸‹ã€‚ 2.2.1 CHAR ä¹Ÿæ˜¯å˜é•¿çš„ï¼Ÿåœ¨Compactè¡Œæ ¼å¼ä¸‹åªä¼šæŠŠå˜é•¿ç±»å‹çš„åˆ—çš„é•¿åº¦é€†åºè®°å½•åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œä½†æ˜¯è¿™å…¶å®å’Œæˆ‘ä»¬çš„å­—ç¬¦é›†æœ‰å…³ç³»ï¼Œä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„è¡¨æ˜¾å¼æŒ‡å®šä¸ºASCIIå­—ç¬¦é›†ï¼Œè¿™ä¸ªæ—¶å€™ä¸€ä¸ªå­—ç¬¦åªä¼šç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œä½†æ˜¯å‡å¦‚æˆ‘ä»¬æŒ‡å®šçš„æ˜¯å…¶å®ƒå­—ç¬¦é›†ï¼Œæ¯”å¦‚utf8ï¼Œè¿™ä¸ªæ—¶å€™ä¸€ä¸ªå­—ç¬¦ç”¨å‡ ä¸ªå­—èŠ‚è¡¨ç¤ºå°±ä¸ç¡®å®šäº†ï¼Œæ‰€ä»¥CHARåˆ—çš„çœŸå®å­—èŠ‚é•¿åº¦ä¹Ÿä¼šè¢«è®°å½•åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ã€‚ å¦å¤–ï¼Œå˜é•¿å­—ç¬¦é›†çš„CHAR(M)ç±»å‹çš„åˆ—è¦æ±‚è‡³å°‘å ç”¨Mä¸ªå­—èŠ‚ï¼Œè€ŒVARCHAR(M)å°±æ²¡æœ‰è¿™ä¸ªè¦æ±‚ã€‚ å¯¹äºä½¿ç”¨utf8å­—ç¬¦é›†çš„CHAR(10)çš„åˆ—æ¥è¯´ï¼Œè¯¥åˆ—å­˜å‚¨çš„æ•°æ®å­—èŠ‚é•¿åº¦çš„èŒƒå›´æ˜¯10ï½30ä¸ªå­—èŠ‚ã€‚å³ä½¿æˆ‘ä»¬å‘è¯¥åˆ—ä¸­å­˜å‚¨ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ä¹Ÿä¼šå ç”¨10ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯æ€•å°†æ¥æ›´æ–°è¯¥åˆ—çš„å€¼çš„å­—èŠ‚é•¿åº¦å¤§äºåŸæœ‰å€¼çš„å­—èŠ‚é•¿åº¦è€Œå°äº10ä¸ªå­—èŠ‚æ—¶ï¼Œå¯ä»¥åœ¨è¯¥è®°å½•å¤„ç›´æ¥æ›´æ–°ï¼Œè€Œä¸æ˜¯åœ¨å­˜å‚¨ç©ºé—´ä¸­é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„è®°å½•ç©ºé—´ï¼Œå¯¼è‡´åŸæœ‰çš„è®°å½•ç©ºé—´æˆä¸ºæ‰€è°“çš„ç¢ç‰‡ã€‚ 3. è¡Œæº¢å‡ºä¸Šé¢æåˆ°äº†ï¼Œå¦‚æœä¸€æ¡è®°å½•çš„çœŸå®å­—èŠ‚æ•°å¤ªå¤§ï¼Œå°±ä¼šå¯¼è‡´è¡Œæº¢å‡ºï¼ŒæŠŠè¶…å‡ºçš„ä¸€éƒ¨åˆ†æ•°æ®å­˜å‚¨åˆ°å…¶ä»–è¡Œæˆ–è€…é¡µã€‚ 3.1 varchar(M)æœ€å¤šèƒ½å­˜å‚¨çš„æ•°æ®varchar(M)çš„åˆ—æœ€å¤šå¯ä»¥å ç”¨65535ä¸ªå­—èŠ‚ã€‚å…¶ä¸­Mä»£è¡¨è¯¥ç±»å‹æœ€å¤šå­˜å‚¨çš„å­—ç¬¦æ•°é‡ã€‚ å®é™…ä¸Šï¼ŒMySQLå¯¹ä¸€æ¡è®°å½•å ç”¨çš„æœ€å¤§å­˜å‚¨ç©ºé—´æ˜¯æœ‰é™åˆ¶çš„ï¼Œé™¤äº†BLOBï¼ŒTEXTç±»å‹çš„åˆ—ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„åˆ—(ä¸åŒ…å«éšè—åˆ—å’Œè®°å½•å¤´ä¿¡æ¯)å ç”¨çš„å­—èŠ‚é•¿åº¦åŠ èµ·æ¥ä¸èƒ½è¶…è¿‡65535ä¸ªå­—èŠ‚ã€‚è¿™ä¸ª65535ä¸ªå­—èŠ‚é™¤äº†åˆ—æœ¬èº«çš„æ•°æ®ä¹‹å¤–ï¼Œè¿˜åŒ…æ‹¬ä¸€äº›å…¶ä»–çš„æ•°æ®ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ä¸ºäº†å­˜å‚¨ä¸€ä¸ªvarcharåˆ—ï¼Œå…¶å®è¿˜éœ€è¦å ç”¨3éƒ¨åˆ†ç©ºé—´ã€‚ çœŸå®æ•°æ® çœŸå®æ•°æ®å ç”¨çš„å­—èŠ‚é•¿åº¦ NULLå€¼æ ‡è¯†ï¼Œå¦‚æœè¯¥åˆ—æœ‰NOT_NULLå±æ€§åˆ™å¯ä»¥æ²¡æœ‰è¿™éƒ¨åˆ†å­˜å‚¨ç©ºé—´ å¦‚æœè¯¥varcharç±»å‹çš„åˆ—æ²¡æœ‰NOT NULLå±æ€§é‚£æœ€å¤šåªèƒ½å­˜å‚¨65532ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå› ä¸ºçœŸå®æ•°æ®çš„é•¿åº¦å¯èƒ½å ç”¨2ä¸ªå­—èŠ‚ï¼ŒNULLå€¼æ ‡è¯†éœ€è¦å ç”¨1ä¸ªå­—èŠ‚ã€‚ å¦‚æœVARCHARç±»å‹çš„åˆ—æœ‰NOT NULLå±æ€§ï¼Œé‚£æœ€å¤šåªèƒ½å­˜å‚¨65533ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå› ä¸ºçœŸå®æ•°æ®çš„é•¿åº¦å¯èƒ½å ç”¨2ä¸ªå­—èŠ‚ï¼Œä¸éœ€è¦NULLå€¼æ ‡è¯†ã€‚ å¦‚æœVARCHAR(M)ç±»å‹çš„åˆ—ä½¿ç”¨çš„ä¸æ˜¯asciiå­—ç¬¦é›†ï¼Œé‚£ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ å¦‚æœVARCHAR(M)ç±»å‹çš„åˆ—ä½¿ç”¨çš„ä¸æ˜¯asciiå­—ç¬¦é›†ï¼Œé‚£Mçš„æœ€å¤§å–å€¼å–å†³äºè¯¥å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦çš„å­—èŠ‚æ•°ã€‚åœ¨åˆ—çš„å€¼å…è®¸ä¸ºNULLçš„æƒ…å†µä¸‹ï¼Œgbkå­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦2ä¸ªå­—èŠ‚ï¼Œé‚£åœ¨è¯¥å­—ç¬¦é›†ä¸‹ï¼ŒMçš„æœ€å¤§å–å€¼å°±æ˜¯32766ï¼ˆä¹Ÿå°±æ˜¯ï¼š65532/2ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å¤šèƒ½å­˜å‚¨32766ä¸ªå­—ç¬¦ï¼›utf8å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦3ä¸ªå­—èŠ‚ï¼Œé‚£åœ¨è¯¥å­—ç¬¦é›†ä¸‹ï¼ŒMçš„æœ€å¤§å–å€¼å°±æ˜¯21844ï¼Œå°±æ˜¯è¯´æœ€å¤šèƒ½å­˜å‚¨21844ï¼ˆä¹Ÿå°±æ˜¯ï¼š65532/3ï¼‰ä¸ªå­—ç¬¦ã€‚ ä¸Šè¿°æ‰€è¨€åœ¨åˆ—çš„å€¼å…è®¸ä¸ºNULLçš„æƒ…å†µä¸‹ï¼Œgbkå­—ç¬¦é›†ä¸‹Mçš„æœ€å¤§å–å€¼å°±æ˜¯32766ï¼Œutf8å­—ç¬¦é›†ä¸‹Mçš„æœ€å¤§å–å€¼å°±æ˜¯21844ï¼Œè¿™éƒ½æ˜¯åœ¨è¡¨ä¸­åªæœ‰ä¸€ä¸ªå­—æ®µçš„æƒ…å†µä¸‹è¯´çš„ï¼Œä¸€å®šè¦è®°ä½ä¸€ä¸ªè¡Œä¸­çš„æ‰€æœ‰åˆ—ï¼ˆä¸åŒ…æ‹¬éšè—åˆ—å’Œè®°å½•å¤´ä¿¡æ¯ï¼‰å ç”¨çš„å­—èŠ‚é•¿åº¦åŠ èµ·æ¥ä¸èƒ½è¶…è¿‡65535ä¸ªå­—èŠ‚ï¼ 3.2 è®°å½•ä¸­çš„æ•°æ®å¤ªå¤šäº§ç”Ÿæº¢å‡ºMySQLä¸­ç£ç›˜å’Œå†…å­˜äº¤äº’çš„åŸºæœ¬å•ä½æ˜¯é¡µï¼Œä¹Ÿå°±æ˜¯è¯´MySQLæ˜¯ä»¥é¡µä¸ºåŸºæœ¬å•ä½æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œæˆ‘ä»¬çš„è®°å½•éƒ½ä¼šè¢«åˆ†é…åˆ°æŸä¸ªé¡µä¸­å­˜å‚¨ã€‚è€Œä¸€ä¸ªé¡µçš„å¤§å°ä¸€èˆ¬æ˜¯16KBï¼Œä¹Ÿå°±æ˜¯16384å­—èŠ‚ï¼Œè€Œä¸€ä¸ªVARCHAR(M)ç±»å‹çš„åˆ—å°±æœ€å¤šå¯ä»¥å­˜å‚¨65532ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±å¯èƒ½é€ æˆä¸€ä¸ªé¡µå­˜æ”¾ä¸äº†ä¸€æ¡è®°å½•çš„å°´å°¬æƒ…å†µã€‚ åœ¨Compactå’ŒRedundantè¡Œæ ¼å¼ä¸­ï¼Œå¯¹äºå ç”¨å­˜å‚¨ç©ºé—´éå¸¸å¤§çš„åˆ—ï¼Œåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„åªä¼šå­˜å‚¨è¯¥åˆ—çš„ä¸€éƒ¨åˆ†æ•°æ®ï¼ŒæŠŠå‰©ä½™çš„æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å‡ ä¸ªå…¶ä»–çš„é¡µä¸­ï¼Œç„¶åè®°å½•çš„çœŸå®æ•°æ®å¤„ç”¨20ä¸ªå­—èŠ‚å­˜å‚¨æŒ‡å‘è¿™äº›é¡µçš„åœ°å€ï¼ˆå½“ç„¶è¿™20ä¸ªå­—èŠ‚ä¸­è¿˜åŒ…æ‹¬è¿™äº›åˆ†æ•£åœ¨å…¶ä»–é¡µé¢ä¸­çš„æ•°æ®çš„å ç”¨çš„å­—èŠ‚æ•°ï¼‰ï¼Œä»è€Œå¯ä»¥æ‰¾åˆ°å‰©ä½™æ•°æ®æ‰€åœ¨çš„é¡µã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¯¹äºCompactå’ŒRedundantè¡Œæ ¼å¼æ¥è¯´ï¼Œå¦‚æœæŸä¸€åˆ—ä¸­çš„æ•°æ®éå¸¸å¤šçš„è¯ï¼Œåœ¨æœ¬è®°å½•çš„çœŸå®æ•°æ®å¤„åªä¼šå­˜å‚¨è¯¥åˆ—çš„å‰768ä¸ªå­—èŠ‚çš„æ•°æ®å’Œä¸€ä¸ªæŒ‡å‘å…¶ä»–é¡µçš„åœ°å€ï¼Œç„¶åæŠŠå‰©ä¸‹çš„æ•°æ®å­˜æ”¾åˆ°å…¶ä»–é¡µä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå«åšè¡Œæº¢å‡ºï¼Œå­˜å‚¨è¶…å‡º768å­—èŠ‚çš„é‚£äº›é¡µé¢ä¹Ÿè¢«ç§°ä¸ºæº¢å‡ºé¡µã€‚ç”»ä¸€ä¸ªç®€å›¾å°±æ˜¯è¿™æ ·ï¼š ä¸åªæ˜¯ VARCHAR(M)ç±»å‹çš„åˆ—ï¼Œå…¶ä»–çš„ TEXTã€BLOB ç±»å‹çš„åˆ—åœ¨å­˜å‚¨æ•°æ®éå¸¸å¤šçš„æ—¶å€™ä¹Ÿä¼šå‘ç”Ÿè¡Œæº¢å‡ºã€‚ 3.3 è¡Œæº¢å‡ºçš„ä¸´ç•Œç‚¹å‘ç”Ÿè¡Œæº¢å‡ºçš„ä¸´ç•Œç‚¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´åœ¨åˆ—å­˜å‚¨å¤šå°‘å­—èŠ‚çš„æ•°æ®æ—¶å°±ä¼šå‘ç”Ÿè¡Œæº¢å‡ºï¼Ÿ MySQLä¸­è§„å®šä¸€ä¸ªé¡µä¸­è‡³å°‘å­˜æ”¾ä¸¤è¡Œè®°å½•ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™ä¹ˆè§„å®šæˆ‘ä»¬ä¹‹åå†è¯´ï¼Œç°åœ¨çœ‹ä¸€ä¸‹è¿™ä¸ªè§„å®šé€ æˆçš„å½±å“ã€‚æˆ‘ä»¬å¾€è¡¨ä¸­æ’å…¥äº®æ¡è®°å½•ï¼Œæ¯æ¡è®°å½•æœ€å°‘æ’å…¥å¤šå°‘å­—èŠ‚çš„æ•°æ®æ‰ä¼šè¡Œæº¢å‡ºå‘¢ï¼Ÿ åˆ†æä¸€ä¸‹é¡µç©ºé—´æ˜¯å¦‚ä½•åˆ©ç”¨çš„ æ¯ä¸ªé¡µé™¤äº†å­˜æ”¾æˆ‘ä»¬çš„è®°å½•ä»¥å¤–ï¼Œä¹Ÿéœ€è¦å­˜å‚¨ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œä¹±ä¸ƒå…«ç³Ÿçš„é¢å¤–ä¿¡æ¯åŠ èµ·æ¥éœ€è¦132ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼ˆç°åœ¨åªè¦çŸ¥é“è¿™ä¸ªæ•°å­—å°±å¥½äº†ï¼‰ï¼Œå…¶ä»–çš„ç©ºé—´éƒ½å¯ä»¥è¢«ç”¨æ¥å­˜å‚¨è®°å½•ã€‚ æ¯ä¸ªè®°å½•éœ€è¦çš„é¢å¤–ä¿¡æ¯æ˜¯27å­—èŠ‚ã€‚è¿™27ä¸ªå­—èŠ‚åŒ…æ‹¬ä¸‹è¾¹è¿™äº›éƒ¨åˆ†ï¼š å†…å®¹ å¤§å°(å­—èŠ‚) çœŸå®æ•°æ®çš„é•¿åº¦ 2 åˆ—æ˜¯å¦æ˜¯NULLå€¼ 1 å¤´ä¿¡æ¯ 5 row_id 6 transaction_id 6 roll_pointer 7 å› ä¸ºè¡¨ä¸­å…·ä½“æœ‰å¤šå°‘åˆ—ä¸ç¡®å®šï¼Œæ‰€ä»¥æ²¡æ³•ç¡®å®šå…·ä½“çš„ä¸´ç•Œç‚¹ï¼Œåªéœ€è¦çŸ¥é“æ’å…¥çš„å­—æ®µæ•°æ®é•¿åº¦å¾ˆå¤§å°±ä¼šå¯¼è‡´è¡Œæº¢å‡ºçš„ç°è±¡ã€‚ 4.Dynamic &amp; Compressed è¡Œæ ¼å¼è¿™ä¿©è¡Œæ ¼å¼å’ŒCompactè¡Œæ ¼å¼æŒºåƒï¼Œåªä¸è¿‡åœ¨å¤„ç†è¡Œæº¢å‡ºæ•°æ®æ—¶æœ‰ç‚¹å„¿åˆ†æ­§ï¼Œå®ƒä»¬ä¸ä¼šåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„å­˜å‚¨å­—æ®µçœŸå®æ•°æ®çš„å‰768ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯æŠŠæ‰€æœ‰çš„å­—èŠ‚éƒ½å­˜å‚¨åˆ°å…¶ä»–é¡µé¢ä¸­ï¼Œåªåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„å­˜å‚¨å…¶ä»–é¡µé¢çš„åœ°å€ï¼Œå°±åƒè¿™æ ·ï¼š Compressedè¡Œæ ¼å¼å’ŒDynamicä¸åŒçš„ä¸€ç‚¹æ˜¯ï¼ŒCompressedè¡Œæ ¼å¼ä¼šé‡‡ç”¨å‹ç¼©ç®—æ³•å¯¹é¡µé¢è¿›è¡Œå‹ç¼©ï¼Œä»¥èŠ‚çœç©ºé—´ã€‚ è‡³æ­¤ï¼Œè¡Œæ ¼å¼å°±åˆ†æçš„å·®ä¸å¤šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹é¡µçš„å­˜å‚¨ç»“æ„ã€‚ äºŒã€é¡µInnoDBä¸ºäº†ä¸åŒçš„ç›®çš„è®¾è®¡äº†è®¸å¤šç§é¡µï¼Œæ¯”å¦‚å­˜æ”¾è¡¨ç©ºé—´å¤´éƒ¨ä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾ Insert Bufferä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾Innodeä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾undoæ—¥å¿—ä¿¡æ¯çš„é¡µç­‰ç­‰ã€‚ æœ¬èŠ‚åˆ†æå­˜æ”¾è¡¨ä¸­è®°å½•çš„é¡µï¼Œå®˜æ–¹ç§°ä¸ºç´¢å¼•é¡µï¼Œä¸ºäº†åˆ†ææ–¹ä¾¿ï¼Œæˆ‘ä»¬æš‚ä¸”å«åšæ•°æ®é¡µã€‚ ç³»ç»Ÿå˜é‡innodb_page_sizeè¡¨æ˜äº†InnoDBå­˜å‚¨å¼•æ“ä¸­çš„é¡µå¤§å°ï¼Œé»˜è®¤å€¼æ˜¯16384å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯16kbã€‚ è¯¥å˜é‡åªèƒ½åœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–MySQLæ•°æ®ç›®å½•æ—¶æŒ‡å®šï¼Œä¹‹åå°±å†ä¹Ÿä¸èƒ½æ›´æ”¹äº†ã€‚ æ•°æ®é¡µä»£è¡¨çš„è¿™å—16kbçš„å­˜å‚¨ç©ºé—´è¢«åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†ï¼Œä¸åŒéƒ¨åˆ†æœ‰ä¸åŒçš„åŠŸèƒ½ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªInnoDBæ•°æ®é¡µçš„å­˜å‚¨ç©ºé—´å¤§è‡´è¢«åˆ’åˆ†ä¸ºäº†7ä¸ªéƒ¨åˆ†ï¼Œæœ‰çš„éƒ¨åˆ†å ç”¨çš„å­—èŠ‚æ•°æ˜¯ç¡®å®šçš„ï¼Œæœ‰çš„å ç”¨çš„å­—èŠ‚æ•°ä¸æ˜¯ç¡®å®šçš„ã€‚ åç§° ä¸­æ–‡å å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ ç®€å•æè¿° File Header æ–‡ä»¶å¤´éƒ¨ 38 é¡µçš„ä¸€äº›é€šç”¨ä¿¡æ¯ Page Header é¡µé¢å¤´éƒ¨ 56 æ•°æ®é¡µä¸“æœ‰çš„ä¸€äº›ä¿¡æ¯ Infifmum + Supremum æœ€å°è®°å½•å’Œæœ€å¤§è®°å½• 26 ä¸¤ä¸ªè™šæ‹Ÿçš„è¡Œè®°å½• User Records ç”¨æˆ·è®°å½• ä¸ç¡®å®š å®é™…å­˜å‚¨çš„è¡Œè®°å½•å†…å®¹ Free Space ç©ºé—²ç©ºé—´ ä¸ç¡®å®š é¡µä¸­å°šæœªä½¿ç”¨çš„ç©ºé—´ Page Directory é¡µé¢ç›®å½• ä¸ç¡®å®š é¡µä¸­æŸäº›è®°å½•çš„ç›¸å¯¹ä½ç½® File Trailer æ–‡ä»¶å°¾éƒ¨ 8 æ ¡éªŒé¡µæ˜¯å¦å®Œæ•´ 1. è®°å½•åœ¨é¡µä¸­çš„å­˜å‚¨æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€å¼ è¡¨ 1234567mysql&gt; create table page_demo( -&gt; c1 int , -&gt; c2 int , -&gt; c3 varchar(10000), -&gt; primary key(c1) -&gt; ) charset=ascii row_format=Compact;Query OK, 0 rows affected (0.03 sec) å› ä¸ºæˆ‘ä»¬æŒ‡å®šäº†ä¸»é”®ï¼Œæ‰€ä»¥å­˜å‚¨å®é™…æ•°æ®çš„åˆ—é‡Œé¢ä¸ä¼šæœ‰éšè—çš„row_id,æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–çš„è¡Œæ ¼å¼ã€‚ å†æ¬¡å›é¡¾ä¸‹è®°å½•å¤´ä¸­5ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ•°æ®ã€‚ åç§° å¤§å°(bit) æè¿° é¢„ç•™ä½1 1 æ²¡æœ‰ä½¿ç”¨ é¢„ç•™ä½2 1 æ²¡æœ‰ä½¿ç”¨ delete_mask 1 æ ‡è®°è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤ min_rec_mask 1 B+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®° n_owned 4 è¡¨ç¤ºå½“å‰è®°å½•æ‹¥æœ‰çš„è®°å½•æ•° heap_no 13 è¡¨ç¤ºå½“å‰è®°å½•åœ¨è®°å½•å †çš„ä½ç½®ä¿¡æ¯ record_type 3 è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ 0 ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éé¡µèŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½• next_record 16 ä¸‹ä¸€æ¡è®°å½•çš„ç›¸å¯¹ä½ç½® é’ˆå¯¹å½“å‰è¿™ä¸ªè¡¨çš„è¡Œæ ¼å¼ç®€åŒ–å›¾ï¼š æ¥ä¸‹æ¥æˆ‘ä»¬å¾€è¡¨ä¸­æ’å…¥å‡ æ¡æ•°æ®ï¼š 1INSERT INTO page_demo VALUES(1, 100, &#x27;aaaa&#x27;), (2, 200, &#x27;bbbb&#x27;), (3, 300, &#x27;cccc&#x27;), (4, 400, &#x27;dddd&#x27;); ä¸ºäº†åˆ†æè¿™äº›è®°å½•åœ¨é¡µçš„User Records éƒ¨åˆ†ä¸­æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„ï¼ŒæŠŠè®°å½•å¤´ä¿¡æ¯å’Œå®é™…çš„åˆ—æ•°æ®éƒ½ç”¨åè¿›åˆ¶è¡¨ç¤ºå‡ºæ¥äº†ï¼ˆå…¶å®æ˜¯ä¸€å †äºŒè¿›åˆ¶ä½ï¼‰ï¼Œæ‰€ä»¥è¿™äº›è®°å½•çš„ç¤ºæ„å›¾å°±æ˜¯ï¼š åˆ†æä¸€ä¸‹å¤´ä¿¡æ¯ä¸­çš„æ¯ä¸ªå±æ€§æ˜¯ä»€ä¹ˆæ„æ€ã€‚ 1.1 delete_maskæ ‡è®°å½“å‰è®°å½•æ˜¯å¦è¢«åˆ é™¤ï¼Œå ç”¨1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œ0ï¼šæœªåˆ é™¤ï¼Œ1ï¼šåˆ é™¤ã€‚ è¢«åˆ é™¤çš„è®°å½•ä¸ä¼šç«‹å³ä»ç£ç›˜ä¸Šåˆ é™¤ï¼Œå› ä¸ºåˆ é™¤ä»–ä»¬ä¹‹åå§å…¶ä»–çš„è®°å½•åœ¨ç£ç›˜ä¸Šé‡æ–°æ’åˆ—éœ€è¦æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥åªæ˜¯æ‰“ä¸€ä¸ªåˆ é™¤æ ‡è®°ï¼Œæ‰€æœ‰è¢«åˆ æ‰çš„æ•°æ®ä¼šç»„æˆä¸€ä¸ªåƒåœ¾é“¾è¡¨ï¼Œåœ¨è¿™ä¸ªé“¾è¡¨ä¸­çš„è®°å½•å ç”¨çš„ç©ºé—´æˆä¸ºå¯é‡ç”¨ç©ºé—´ï¼Œä¹‹åå¦‚æœæœ‰æ–°çš„è®°å½•æ’å…¥åˆ°è¡¨ä¸­ï¼Œå¯èƒ½ä¼šæŠŠè¿™äº›åˆ é™¤çš„è®°å½•è¦†ç›–æ‰ã€‚ å°†delete_mask è®¾ç½®ä¸º1 å’Œ å°†è¢«åˆ é™¤çš„è®°å½•åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­å…¶å®æ˜¯ä¸¤ä¸ªé˜¶æ®µã€‚ 1.2 min_rec_maskB+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®°ï¼Œå¦‚æœè¿™ä¸ªå­—æ®µçš„å€¼æ˜¯0ï¼Œæ„å‘³ç€ä¸æ˜¯B+æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•ã€‚ 1.3 n_owned1.4 heap_noè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰è®°å½•åœ¨æœ¬é¡µä¸­çš„ä½ç½®ï¼Œæˆ‘ä»¬æ’å…¥çš„å››æ¡è®°å½•åœ¨æœ¬é¡µä¸­çš„ä½ç½®åˆ†åˆ«æ˜¯ 2ï¼Œ3ï¼Œ4 ï¼Œ5 ã€‚ä¸ºä»€ä¹ˆä¸è§ 0 å’Œ 1 çš„è®°å½•å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºInnoDBè‡ªåŠ¨ç»™æ¯ä¸ªé¡µé‡Œè¾¹åŠ äº†ä¸¤ä¸ªè®°å½•ï¼Œç”±äºè¿™ä¸¤ä¸ªè®°å½•å¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±æ’å…¥çš„ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿç§°ä¸ºè™šæ‹Ÿè®°å½•ã€‚è¿™ä¸¤ä¸ªä¼ªè®°å½•ä¸€ä¸ªä»£è¡¨æœ€å°è®°å½•ï¼Œä¸€ä¸ªä»£è¡¨æœ€å¤§è®°å½•ã€‚ è®°å½•æ˜¯å¦‚ä½•æ¯”è¾ƒå¤§å°çš„ï¼Ÿå¯¹äºä¸€æ¡å®Œæ•´çš„è®°å½•æ¥è¯´ï¼Œæ¯”è¾ƒè®°å½•å¤§å°å°±æ˜¯æ¯”è¾ƒä¸»é”®çš„å¤§å°ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æ’å…¥çš„4è¡Œè®°å½•çš„ä¸»é”®å€¼åˆ†åˆ«ä¸º1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€è¿™å››æ¡è®°å½•çš„å¤§å°ä»å¤§åˆ°å°é€’å¢ã€‚ ä½†æ˜¯ä¸ç®¡æˆ‘ä»¬å¾€é¡µä¸­æ’å…¥äº†å¤šå°‘è‡ªå·±çš„è®°å½•ï¼ŒInnoDBéƒ½è§„å®šä»–ä»¬å®šä¹‰çš„ä¸¤æ¡ä¼ªè®°å½•åˆ†åˆ«ä¸ºæœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ã€‚è¿™ä¸¤æ¡è®°å½•çš„æ„é€ ååˆ†ç®€å•ï¼Œéƒ½æ˜¯ç”±5å­—èŠ‚å¤§å°çš„è®°å½•å¤´ä¿¡æ¯å’Œ8å­—èŠ‚å¤§å°çš„ä¸€ä¸ªå›ºå®šçš„éƒ¨åˆ†ç»„æˆçš„ã€‚ ç”±äºè¿™ä¸¤æ¡è®°å½•ä¸æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„è®°å½•ï¼Œæ‰€ä»¥ä»–ä»¬å¹¶ä¸å­˜æ”¾åœ¨é¡µçš„User Recordséƒ¨åˆ†ï¼Œä»–ä»¬è¢«å•ç‹¬æ”¾åœ¨ä¸€ä¸ªç§°ä¸ºInfimum+Supremumçš„éƒ¨åˆ†ã€‚ ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œæœ€å°è®°å½•å’Œæœ€å¤§è®°å½•çš„heap_noå€¼åˆ†åˆ«æ˜¯0 å’Œ 1 ï¼Œ ä¹Ÿå°±æ˜¯è¯´ä»–ä»¬çš„ä½ç½®æœ€é å‰ã€‚ 1.5 record_typeè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ã€‚0ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éå¶å­èŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½•ã€‚ æˆ‘ä»¬è‡ªå·±æ’å…¥çš„è®°å½•æ˜¯æ™®é€šè®°å½• 0 ï¼Œ è€Œæœ€å¤§è®°å½•å’Œæœ€å°è®°å½•record_type åˆ†åˆ«ä¸º 2 å’Œ 3ã€‚ 1.6 next_recordè¡¨ç¤ºä»å½“å‰è®°å½•çš„çœŸå®æ•°æ®åˆ°ä¸‹ä¸€æ¡è®°å½•çš„çœŸå®æ•°æ®çš„åœ°å€åç§»é‡ã€‚è¿™å…¶å®æ˜¯ä¸€æ¡é“¾è¡¨ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¡è®°å½•æ‰¾åˆ°ä»–çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯ä¸‹ä¸€æ¡è®°å½•æŒ‡çš„å¹¶ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æ’å…¥é¡ºåºçš„ä¸‹ä¸€æ¡è®°å½•ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§çš„é¡ºåºçš„ä¸‹ä¸€æ¡è®°å½•ã€‚è€Œä¸”è§„å®š infimumè®°å½• çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æœ¬é¡µä¸»é”®å€¼æœ€å°çš„ç”¨æˆ·è®°å½•ï¼Œè€Œæœ¬é¡µä¸­ä¸»é”®æœ€å¤§çš„ç”¨æˆ·è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯supremumè®°å½•ã€‚ å¦‚æœä»ä¸­åˆ é™¤ä¸€æ¡è®°å½•ï¼Œè¿™ä¸ªé“¾è¡¨ä¹Ÿæ˜¯ä¼šè·Ÿç€å˜åŒ–çš„ï¼Œå‡å¦‚ç°åœ¨åˆ é™¤ç¬¬äºŒæ¡è®°å½• 1delete from page_demo where c1 =2 ; åˆ é™¤ç¬¬äºŒæ¡è®°å½•ä»¥åï¼š å‘ç”Ÿçš„å˜åŒ–ï¼š ç¬¬äºŒæ¡è®°å½•å¹¶æ²¡æœ‰ä»å­˜å‚¨ç©ºé—´ä¸­ç§»é™¤ï¼Œè€Œæ˜¯æŠŠè¯¥è®°å½•çš„delete_maskè®¾ç½®ä¸º1 ç¬¬äºŒæ¡è®°å½•çš„next_recordså€¼å˜æˆäº†0ï¼Œæ„å‘³ç€è¯¥è®°å½•æ²¡æœ‰ä¸‹ä¸€æ¡è®°å½•äº† ç¬¬ä¸€æ¡è®°å½•çš„next recordæŒ‡å‘äº†ç¬¬ä¸‰æ¡è®°å½• æœ€å¤§è®°å½•çš„ n_owned å€¼ä»5 å˜æˆäº†4 æ‰€ä»¥ï¼Œä¸è®ºæˆ‘ä»¬æ€ä¹ˆå¯¹é¡µä¸­çš„è®°å½•åšå¢åˆ æ”¹æŸ¥æ“ä½œï¼ŒInnoDBå§‹ç»ˆä¼šç»´æŠ¤ä¸€æ¡è®°å½•çš„å•é“¾è¡¨ï¼Œé“¾è¡¨ä¸­å„ä¸ªèŠ‚ç‚¹æ˜¯æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§çš„é¡ºåºè¿æ¥èµ·æ¥çš„ã€‚ next_records ä¸ºå•¥è¦æŒ‡å‘è®°å½•å¤´ä¿¡æ¯å’ŒçœŸå®æ•°æ®ä¹‹é—´çš„ä½ç½®å‘¢ï¼Ÿä¸ºå•¥ä¸å¹²è„†æŒ‡å‘æ•´æ¡è®°å½•çš„å¼€å¤´ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è®°å½•çš„é¢å¤–ä¿¡æ¯å¼€å¤´çš„ä½ç½®å‘¢ï¼Ÿ å› ä¸ºè¿™ä¸ªä½ç½®åˆšåˆšå¥½ï¼Œå‘å·¦è¯»å–å°±æ˜¯è®°å½•å¤´ä¿¡æ¯ï¼Œå‘å³è¯»å–å°±æ˜¯çœŸå®æ•°æ®ã€‚æˆ‘ä»¬å‰è¾¹è¿˜è¯´è¿‡å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œnullå€¼åˆ—è¡¨ä¸­çš„ä¿¡æ¯éƒ½æ˜¯é€†åºå­˜æ”¾çš„ï¼Œè¿™æ ·å¯ä»¥ä½¿è®°å½•ä¸­ä½ç½®é å‰çš„å­—æ®µå’Œä»–ä»¬å¯¹åº”çš„å­—æ®µé•¿åº¦ä¿¡æ¯åœ¨å†…å­˜ä¸­çš„è·ç¦»æ›´è¿‘ï¼Œå¯èƒ½ä¼šæé«˜é«˜é€Ÿç¼“å­˜çš„å‘½ä¸­ç‡ã€‚ å› ä¸ºä¸»é”®å€¼ä¸º2çš„è®°å½•å·²ç»è¢«æˆ‘ä»¬åˆ é™¤äº†ï¼Œä½†æ˜¯å­˜å‚¨ç©ºé—´å¹¶æ²¡æœ‰å›æ”¶ï¼Œå¦‚æœå†æ¬¡æŠŠè¿™æ¡è®°å½•æ’å…¥åˆ°è¡¨ä¸­ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ 1INSERT INTO page_demo VALUES(2, 200, &#x27;bbbb&#x27;); ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒInnoDBå¹¶æ²¡æœ‰å› ä¸ºæ–°è®°å½•çš„æ’å…¥è€Œä¸ºä»–ç”³è¯·æ–°çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œæ˜¯ç›´æ¥å¤ç”¨äº†åŸæ¥åˆ é™¤çš„è®°å½•çš„å­˜å‚¨ç©ºé—´ã€‚ 2. Page Directoryï¼ˆé¡µç›®å½•ï¼‰å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸»é”®å€¼æŸ¥æ‰¾é¡µä¸­æŸæ¡è®°å½•è¯¥å’‹åŠï¼Ÿ 1select * from page_demo where c1 = 3; å°†æ‰€æœ‰æ­£å¸¸çš„è®°å½•(åŒ…æ‹¬ä¸¤æ¡éšè—è®°å½•ä½†æ˜¯ä¸åŒ…æ‹¬å·²ç»æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•)åˆ’åˆ†ä¸ºå‡ ç»„ æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•ï¼ˆä¹Ÿå°±æ˜¯ç»„å†…æœ€å¤§çš„é‚£æ¡è®°å½•ï¼‰çš„å¤´ä¿¡æ¯ä¸­çš„n_ownedå±æ€§è¡¨ç¤ºè¯¥ç»„æ‹¥æœ‰å¤šå°‘æ¡è®°å½• å°†æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•çš„åœ°å€åç§»é‡å•ç‹¬æå–å‡ºæ¥æŒ‰ç…§é¡ºåºå­˜å‚¨åˆ°é è¿‘é¡µçš„å°¾éƒ¨çš„åœ°æ–¹ï¼Œè¿™ä¸ªåœ°æ–¹å°±æ˜¯æ‰€è°“çš„ã€Page Directoryã€‘,ä¹Ÿå°±æ˜¯é¡µç›®å½•ã€‚é¡µç›®å½•ä¸­çš„è¿™äº›åœ°å€åç§»é‡è¢«ç§°ä¸ºæ§½ï¼Œæ‰€ä»¥é¡µç›®å½•å°±æ˜¯ç”±æ§½ç»„æˆçš„ æ¯”æ–¹è¯´åˆšæ‰åˆ›å»ºçš„è¡¨ä¸­æ­£å¸¸çš„è®°å½•ç”±6æ¡ï¼ŒInnoDBä¼šæŠŠä»–ä»¬åˆ†æˆä¸¤ç»„ï¼Œç¬¬ä¸€ç»„ä¸­åªæœ‰ä¸€æ¡æœ€å°è®°å½•ï¼Œç¬¬äºŒç»„ä¸­æ˜¯å‰©ä½™çš„5æ¡è®°å½•ã€‚ ç°åœ¨é¡µç›®å½•éƒ¨åˆ†ä¸­æœ‰ä¸¤ä¸ªæ§½ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬çš„è®°å½•è¢«åˆ†æˆäº†ä¸¤ä¸ªç»„ï¼Œæ§½1ä¸­çš„å€¼ä¸º112ï¼Œä»£è¡¨æœ€å¤§è®°å½•çš„åœ°å€åç§»é‡ï¼›æ§½0çš„å€¼ä¸º99ï¼Œä»£è¡¨æœ€å°è®°å½•çš„åœ°å€åç§»é‡ã€‚ æ³¨æ„æœ€å¤§å’Œæœ€å°è®°å½•çš„å¤´ä¿¡æ¯çš„n_ownedå±æ€§ï¼š æœ€å°è®°å½•ä¸­çš„n_ownedå€¼ä¸º1ï¼Œè¿™å°±ä»£è¡¨ç€ä»¥æœ€å°è®°å½•ç»“å°¾çš„è¿™ä¸ªåˆ†ç»„ä¸­åªæœ‰1æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯æœ€å°è®°å½•æœ¬èº« æœ€å¤§è®°å½•ä¸­çš„n_ownedå€¼ä¸º5ï¼Œè¿™å°±ä»£è¡¨ç€ä»¥æœ€å¤§è®°å½•ç»“å°¾çš„è¿™ä¸ªåˆ†ç»„ä¸­åªæœ‰5æ¡è®°å½•ï¼ŒåŒ…æ‹¬æœ€å¤§è®°å½•æœ¬èº«è¿˜æœ‰æˆ‘ä»¬è‡ªå·±æ’å…¥çš„4æ¡è®°å½• ã€99ã€‘&amp;ã€112ã€‘è¿™æ ·çš„åœ°å€åç§»é‡å¾ˆä¸ç›´è§‚ï¼Œæˆ‘ä»¬ç”¨ç®­å¤´æŒ‡å‘çš„æ–¹å¼æ›¿ä»£æ•°å­—ã€‚ InnoDBå¯¹æ¯ä¸ªåˆ†ç»„ä¸­çš„è®°å½•æ¡æ•°æ˜¯æœ‰è§„å®šçš„ï¼šå¯¹äºæœ€å°è®°å½•æ‰€åœ¨çš„åˆ†ç»„åªèƒ½æœ‰ 1 æ¡è®°å½•ï¼Œæœ€å¤§è®°å½•æ‰€åœ¨çš„åˆ†ç»„æ‹¥æœ‰çš„è®°å½•æ¡æ•°åªèƒ½åœ¨ 1~8 æ¡ä¹‹é—´ï¼Œå‰©ä¸‹çš„åˆ†ç»„ä¸­è®°å½•çš„æ¡æ•°èŒƒå›´åªèƒ½åœ¨æ˜¯ 4~8 æ¡ä¹‹é—´ã€‚æ‰€ä»¥åˆ†ç»„æ˜¯æŒ‰ç…§ä¸‹è¾¹çš„æ­¥éª¤è¿›è¡Œçš„ï¼š åˆå§‹æƒ…å†µä¸‹ä¸€ä¸ªæ•°æ®é¡µé‡Œåªæœ‰æœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ä¸¤æ¡è®°å½•ï¼Œå®ƒä»¬åˆ†å±äºä¸¤ä¸ªåˆ†ç»„ã€‚ ä¹‹åæ¯æ’å…¥ä¸€æ¡è®°å½•ï¼Œéƒ½ä¼šä»é¡µç›®å½•ä¸­æ‰¾åˆ°ä¸»é”®å€¼æ¯”æœ¬è®°å½•çš„ä¸»é”®å€¼å¤§å¹¶ä¸”å·®å€¼æœ€å°çš„æ§½ï¼Œç„¶åæŠŠè¯¥æ§½å¯¹åº”çš„è®°å½•çš„n_ownedå€¼åŠ 1ï¼Œè¡¨ç¤ºæœ¬ç»„å†…åˆæ·»åŠ äº†ä¸€æ¡è®°å½•ï¼Œç›´åˆ°è¯¥ç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªã€‚ åœ¨ä¸€ä¸ªç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªåå†æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œä¼šå°†ç»„ä¸­çš„è®°å½•æ‹†åˆ†æˆä¸¤ä¸ªç»„ï¼Œä¸€ä¸ªç»„ä¸­4æ¡è®°å½•ï¼Œå¦ä¸€ä¸ª5æ¡è®°å½•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šåœ¨é¡µç›®å½•ä¸­æ–°å¢ä¸€ä¸ªæ§½æ¥è®°å½•è¿™ä¸ªæ–°å¢åˆ†ç»„ä¸­æœ€å¤§çš„é‚£æ¡è®°å½•çš„åç§»é‡ã€‚ ç”±äºç°åœ¨page_demoè¡¨ä¸­çš„è®°å½•å¤ªå°‘ï¼Œæ— æ³•æ¼”ç¤ºæ·»åŠ äº†é¡µç›®å½•ä¹‹ååŠ å¿«æŸ¥æ‰¾é€Ÿåº¦çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥å†å¾€page_demoè¡¨ä¸­æ·»åŠ ä¸€äº›è®°å½•ï¼š 1INSERT INTO page_demo VALUES(5, 500, &#x27;eeee&#x27;), (6, 600, &#x27;ffff&#x27;), (7, 700, &#x27;gggg&#x27;), (8, 800, &#x27;hhhh&#x27;), (9, 900, &#x27;iiii&#x27;), (10, 1000, &#x27;jjjj&#x27;), (11, 1100, &#x27;kkkk&#x27;), (12, 1200, &#x27;llll&#x27;), (13, 1300, &#x27;mmmm&#x27;), (14, 1400, &#x27;nnnn&#x27;), (15, 1500, &#x27;oooo&#x27;), (16, 1600, &#x27;pppp&#x27;); ç°åœ¨çœ‹æ€ä¹ˆä»è¿™ä¸ªé¡µç›®å½•ä¸­æŸ¥æ‰¾è®°å½•ã€‚å› ä¸ºå„ä¸ªæ§½ä»£è¡¨çš„è®°å½•çš„ä¸»é”®å€¼éƒ½æ˜¯ä»å°åˆ°å¤§æ’åºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‰€è°“çš„äºŒåˆ†æ³•æ¥è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾ã€‚5ä¸ªæ§½çš„ç¼–å·åˆ†åˆ«æ˜¯ï¼š0ã€1ã€2ã€3ã€4ï¼Œæ‰€ä»¥åˆå§‹æƒ…å†µä¸‹æœ€ä½çš„æ§½å°±æ˜¯low=0ï¼Œæœ€é«˜çš„æ§½å°±æ˜¯high=4ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æƒ³æ‰¾ä¸»é”®å€¼ä¸º6çš„è®°å½•ï¼Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+4)/2=2ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½2å¯¹åº”è®°å½•çš„ä¸»é”®å€¼ä¸º8ï¼Œåˆå› ä¸º8 &gt; 6ï¼Œæ‰€ä»¥è®¾ç½®high=2ï¼Œlowä¿æŒä¸å˜ã€‚ é‡æ–°è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+2)/2=1ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½1å¯¹åº”çš„ä¸»é”®å€¼ä¸º4ï¼Œåˆå› ä¸º4 &lt; 6ï¼Œæ‰€ä»¥è®¾ç½®low=1ï¼Œhighä¿æŒä¸å˜ã€‚ å› ä¸ºhigh - lowçš„å€¼ä¸º1ï¼Œæ‰€ä»¥ç¡®å®šä¸»é”®å€¼ä¸º6çš„è®°å½•åœ¨æ§½2å¯¹åº”çš„ç»„ä¸­ã€‚æ­¤åˆ»æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„é‚£æ¡è®°å½•ï¼Œç„¶åæ²¿ç€å•å‘é“¾è¡¨éå†æ§½2ä¸­çš„è®°å½•ã€‚ä½†æ˜¯æˆ‘ä»¬å‰è¾¹åˆè¯´è¿‡ï¼Œæ¯ä¸ªæ§½å¯¹åº”çš„è®°å½•éƒ½æ˜¯è¯¥ç»„ä¸­ä¸»é”®å€¼æœ€å¤§çš„è®°å½•ï¼Œè¿™é‡Œæ§½2å¯¹åº”çš„è®°å½•æ˜¯ä¸»é”®å€¼ä¸º8çš„è®°å½•ï¼Œæ€ä¹ˆå®šä½ä¸€ä¸ªç»„ä¸­æœ€å°çš„è®°å½•å‘¢ï¼Ÿåˆ«å¿˜äº†å„ä¸ªæ§½éƒ½æ˜¯æŒ¨ç€çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„æ‹¿åˆ°æ§½1å¯¹åº”çš„è®°å½•ï¼ˆä¸»é”®å€¼ä¸º4ï¼‰ï¼Œè¯¥æ¡è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„è®°å½•ï¼Œè¯¥è®°å½•çš„ä¸»é”®å€¼ä¸º5ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™æ¡ä¸»é”®å€¼ä¸º5çš„è®°å½•å‡ºå‘ï¼Œéå†æ§½2ä¸­çš„å„æ¡è®°å½•ï¼Œç›´åˆ°æ‰¾åˆ°ä¸»é”®å€¼ä¸º6çš„é‚£æ¡è®°å½•å³å¯ã€‚ç”±äºä¸€ä¸ªç»„ä¸­åŒ…å«çš„è®°å½•æ¡æ•°åªèƒ½æ˜¯1~8æ¡ï¼Œæ‰€ä»¥éå†ä¸€ä¸ªç»„ä¸­çš„è®°å½•çš„ä»£ä»·æ˜¯å¾ˆå°çš„ã€‚ æ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®é¡µä¸­æŸ¥æ‰¾æŒ‡å®šä¸»é”®å€¼çš„è®°å½•çš„è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š é€šè¿‡äºŒåˆ†æ³•ç¡®å®šè¯¥è®°å½•æ‰€åœ¨çš„æ§½ï¼Œå¹¶æ‰¾åˆ°è¯¥æ§½æ‰€åœ¨åˆ†ç»„ä¸­ä¸»é”®å€¼æœ€å°çš„é‚£æ¡è®°å½•ã€‚ é€šè¿‡è®°å½•çš„next_recordå±æ€§éå†è¯¥æ§½æ‰€åœ¨çš„ç»„ä¸­çš„å„ä¸ªè®°å½•ã€‚ 3.Page Headerï¼ˆé¡µé¢å¤´éƒ¨ï¼‰ä¸ºäº†èƒ½å¾—åˆ°ä¸€ä¸ªæ•°æ®é¡µä¸­å­˜å‚¨çš„è®°å½•çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ¯”å¦‚æœ¬é¡µä¸­å·²ç»å­˜å‚¨äº†å¤šå°‘æ¡è®°å½•ï¼Œç¬¬ä¸€æ¡è®°å½•çš„åœ°å€æ˜¯ä»€ä¹ˆï¼Œé¡µç›®å½•ä¸­å­˜å‚¨äº†å¤šå°‘ä¸ªæ§½ç­‰ç­‰ï¼Œç‰¹æ„åœ¨é¡µä¸­å®šä¹‰äº†ä¸€ä¸ªå«Page Headerçš„éƒ¨åˆ†ï¼Œå®ƒæ˜¯é¡µç»“æ„çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†å ç”¨å›ºå®šçš„56ä¸ªå­—èŠ‚ï¼Œä¸“é—¨å­˜å‚¨å„ç§çŠ¶æ€ä¿¡æ¯ã€‚ åç§° å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ æè¿° PAGE_N_DIR_SLOTS 2 åœ¨é¡µç›®å½•ä¸­çš„æ§½æ•°é‡ PAGE_HEAP_TOP 2 è¿˜æœªä½¿ç”¨çš„ç©ºé—´æœ€å°åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ä»è¯¥åœ°å€ä¹‹åå°±æ˜¯Free Space PAGE_N_HEAP 2 æœ¬é¡µä¸­çš„è®°å½•çš„æ•°é‡ï¼ˆåŒ…æ‹¬æœ€å°å’Œæœ€å¤§è®°å½•ä»¥åŠæ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•ï¼‰ PAGE_FREE 2 ç¬¬ä¸€ä¸ªå·²ç»æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•åœ°å€ï¼ˆå„ä¸ªå·²åˆ é™¤çš„è®°å½•é€šè¿‡next_recordä¹Ÿä¼šç»„æˆä¸€ä¸ªå•é“¾è¡¨ï¼Œè¿™ä¸ªå•é“¾è¡¨ä¸­çš„è®°å½•å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ï¼‰ PAGE_GARBAGE 2 å·²åˆ é™¤è®°å½•å ç”¨çš„å­—èŠ‚æ•° PAGE_LAST_INSERT 2 æœ€åæ’å…¥è®°å½•çš„ä½ç½® PAGE_DIRECTION 2 è®°å½•æ’å…¥çš„æ–¹å‘ PAGE_N_DIRECTION 2 ä¸€ä¸ªæ–¹å‘è¿ç»­æ’å…¥çš„è®°å½•æ•°é‡ PAGE_N_RECS 2 è¯¥é¡µä¸­è®°å½•çš„æ•°é‡ï¼ˆä¸åŒ…æ‹¬æœ€å°å’Œæœ€å¤§è®°å½•ä»¥åŠè¢«æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•ï¼‰ PAGE_MAX_TRX_ID 8 ä¿®æ”¹å½“å‰é¡µçš„æœ€å¤§äº‹åŠ¡IDï¼Œè¯¥å€¼ä»…åœ¨äºŒçº§ç´¢å¼•ä¸­å®šä¹‰ PAGE_LEVEL 2 å½“å‰é¡µåœ¨B+æ ‘ä¸­æ‰€å¤„çš„å±‚çº§ PAGE_INDEX_ID 8 ç´¢å¼•IDï¼Œè¡¨ç¤ºå½“å‰é¡µå±äºå“ªä¸ªç´¢å¼• PAGE_BTR_SEG_LEAF 10 B+æ ‘å¶å­æ®µçš„å¤´éƒ¨ä¿¡æ¯ï¼Œä»…åœ¨B+æ ‘çš„Rooté¡µå®šä¹‰ PAGE_BTR_SEG_TOP 10 B+æ ‘éå¶å­æ®µçš„å¤´éƒ¨ä¿¡æ¯ï¼Œä»…åœ¨B+æ ‘çš„Rooté¡µå®šä¹‰ 4.File Headerï¼ˆæ–‡ä»¶å¤´éƒ¨ï¼‰File Headeré’ˆå¯¹å„ç§ç±»å‹çš„é¡µéƒ½é€šç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒç±»å‹çš„é¡µéƒ½ä¼šä»¥File Headerä½œä¸ºç¬¬ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå®ƒæè¿°äº†ä¸€äº›é’ˆå¯¹å„ç§é¡µéƒ½é€šç”¨çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªé¡µçš„ç¼–å·æ˜¯å¤šå°‘ï¼Œå®ƒçš„ä¸Šä¸€ä¸ªé¡µã€ä¸‹ä¸€ä¸ªé¡µæ˜¯è°ï¼Œè¿™ä¸ªéƒ¨åˆ†å ç”¨å›ºå®šçš„38ä¸ªå­—èŠ‚ã€‚ åç§° å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ æè¿° FIL_PAGE_SPACE_OR_CHKSUM 4 é¡µçš„æ ¡éªŒå’Œï¼ˆchecksumå€¼ï¼‰ FIL_PAGE_OFFSET 4 é¡µå· FIL_PAGE_PREV 4 ä¸Šä¸€ä¸ªé¡µçš„é¡µå· FIL_PAGE_NEXT 4 ä¸‹ä¸€ä¸ªé¡µçš„é¡µå· FIL_PAGE_LSN 8 é¡µé¢è¢«æœ€åä¿®æ”¹æ—¶å¯¹åº”çš„æ—¥å¿—åºåˆ—ä½ç½®ï¼ˆè‹±æ–‡åæ˜¯ï¼šLog Sequence Numberï¼‰ FIL_PAGE_TYPE 2 è¯¥é¡µçš„ç±»å‹ FIL_PAGE_FILE_FLUSH_LSN 8 ä»…åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ä¸€ä¸ªé¡µä¸­å®šä¹‰ï¼Œä»£è¡¨æ–‡ä»¶è‡³å°‘è¢«åˆ·æ–°åˆ°äº†å¯¹åº”çš„LSNå€¼ FIL_PAGE_ARCH_LOG_NO_OR_SPACE_ID 4 é¡µå±äºå“ªä¸ªè¡¨ç©ºé—´ InnoDBä¸ºäº†ä¸åŒçš„ç›®çš„è€ŒæŠŠé¡µåˆ†ä¸ºä¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬ä¸Šè¾¹ä»‹ç»çš„å…¶å®éƒ½æ˜¯å­˜å‚¨è®°å½•çš„æ•°æ®é¡µï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šåˆ«çš„ç±»å‹çš„é¡µï¼Œå…·ä½“å¦‚ä¸‹è¡¨ï¼š ç±»å‹åç§° åå…­è¿›åˆ¶ æè¿° FIL_PAGE_TYPE_ALLOCATED 0x0000 æœ€æ–°åˆ†é…ï¼Œè¿˜æ²¡ä½¿ç”¨ FIL_PAGE_UNDO_LOG 0x0002 Undoæ—¥å¿—é¡µ FIL_PAGE_INODE 0x0003 æ®µä¿¡æ¯èŠ‚ç‚¹ FIL_PAGE_IBUF_FREE_LIST 0x0004 Insert Bufferç©ºé—²åˆ—è¡¨ FIL_PAGE_IBUF_BITMAP 0x0005 Insert Bufferä½å›¾ FIL_PAGE_TYPE_SYS 0x0006 ç³»ç»Ÿé¡µ FIL_PAGE_TYPE_TRX_SYS 0x0007 äº‹åŠ¡ç³»ç»Ÿæ•°æ® FIL_PAGE_TYPE_FSP_HDR 0x0008 è¡¨ç©ºé—´å¤´éƒ¨ä¿¡æ¯ FIL_PAGE_TYPE_XDES 0x0009 æ‰©å±•æè¿°é¡µ FIL_PAGE_TYPE_BLOB 0x000A æº¢å‡ºé¡µ FIL_PAGE_INDEX 0x45BF ç´¢å¼•é¡µï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æ•°æ®é¡µ æˆ‘ä»¬å­˜æ”¾è®°å½•çš„æ•°æ®é¡µçš„ç±»å‹å…¶å®æ˜¯FIL_PAGE_INDEXï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ç´¢å¼•é¡µã€‚ æœ‰æ—¶å€™æˆ‘ä»¬å­˜æ”¾æŸç§ç±»å‹çš„æ•°æ®å ç”¨çš„ç©ºé—´éå¸¸å¤§ï¼ˆæ¯”æ–¹è¯´ä¸€å¼ è¡¨ä¸­å¯ä»¥æœ‰æˆåƒä¸Šä¸‡æ¡è®°å½•ï¼‰ï¼ŒInnoDBå¯èƒ½ä¸å¯ä»¥ä¸€æ¬¡æ€§ä¸ºè¿™ä¹ˆå¤šæ•°æ®åˆ†é…ä¸€ä¸ªéå¸¸å¤§çš„å­˜å‚¨ç©ºé—´ï¼Œå¦‚æœåˆ†æ•£åˆ°å¤šä¸ªä¸è¿ç»­çš„é¡µä¸­å­˜å‚¨çš„è¯éœ€è¦æŠŠè¿™äº›é¡µå…³è”èµ·æ¥ï¼ŒFIL_PAGE_PREVå’ŒFIL_PAGE_NEXTå°±åˆ†åˆ«ä»£è¡¨æœ¬é¡µçš„ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ªé¡µçš„é¡µå·ã€‚è¿™æ ·é€šè¿‡å»ºç«‹ä¸€ä¸ªåŒå‘é“¾è¡¨æŠŠè®¸è®¸å¤šå¤šçš„é¡µå°±éƒ½ä¸²è”èµ·æ¥äº†ï¼Œè€Œæ— éœ€è¿™äº›é¡µåœ¨ç‰©ç†ä¸ŠçœŸæ­£è¿ç€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ç±»å‹çš„é¡µéƒ½æœ‰ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ªé¡µçš„å±æ€§ï¼Œä¸è¿‡æˆ‘ä»¬ç°åœ¨åˆ†æçš„æ•°æ®é¡µï¼ˆä¹Ÿå°±æ˜¯ç±»å‹ä¸ºFIL_PAGE_INDEXçš„é¡µï¼‰æ˜¯æœ‰è¿™ä¸¤ä¸ªå±æ€§çš„ï¼Œæ‰€ä»¥æ‰€æœ‰çš„æ•°æ®é¡µå…¶å®æ˜¯ä¸€ä¸ªåŒé“¾è¡¨ã€‚ 5.File Trailer(æ–‡ä»¶å°¾éƒ¨)å¦‚æœé¡µä¸­çš„æ•°æ®åœ¨å†…å­˜ä¸­è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆåœ¨ä¿®æ”¹åçš„æŸä¸ªæ—¶é—´éœ€è¦æŠŠæ•°æ®åŒæ­¥åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯åœ¨åŒæ­¥äº†ä¸€åŠçš„æ—¶å€™ä¸­æ–­ç”µäº†å’‹åŠï¼Ÿ ä¸ºäº†æ£€æµ‹ä¸€ä¸ªé¡µæ˜¯å¦å®Œæ•´ï¼Œåœ¨æ¯ä¸ªé¡µçš„å°¾éƒ¨éƒ½åŠ äº†ä¸€ä¸ªFile Traileréƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†ç”±8ä¸ªå­—èŠ‚ç»„æˆï¼Œå¯ä»¥åˆ†æˆ2ä¸ªå°éƒ¨åˆ†ï¼š å‰å››ä¸ªå­—èŠ‚ä»£è¡¨æ ¡éªŒå’Œ åå››ä¸ªå­—èŠ‚ä»£è¡¨é¡µé¢è¢«æœ€åä¿®æ”¹æ—¶å¯¹åº”çš„æ—¥å¿—åºåˆ—ä½ç½® è¿™ä¸ªFile Trailer &amp; File Header ç±»ä¼¼ï¼Œéƒ½æ˜¯æ‰€æœ‰ç±»å‹çš„é¡µé€šç”¨çš„ã€‚ è‡³æ­¤ï¼Œæ•´ä¸ªæ•°æ®é¡µçš„ç»“æ„æˆ‘ä»¬ä¹ŸåŸºæœ¬ä¸Šåˆ†æå®Œäº†ï¼Œç°åœ¨åœ¨å›å¤´çœ‹ä¸€ä¸‹å¼€å¤´æˆ‘ä»¬é‚£å¼ ææ€–çš„å›¾ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰æ¸…æ™°å¾ˆå¤šäº†å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ†æç´¢å¼•çš„ç»“æ„ã€‚ ä¸‰ã€ç´¢å¼•1.ç´¢å¼•ç»“æ„1.1 èšç°‡ç´¢å¼•ä¸Šè¾¹ä»‹ç»çš„B+æ ‘æœ¬èº«å°±æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæˆ–è€…è¯´æœ¬èº«å°±æ˜¯ä¸€ä¸ªç´¢å¼•ã€‚å®ƒæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š ä½¿ç”¨è®°å½•ä¸»é”®å€¼çš„å¤§å°è¿›è¡Œè®°å½•å’Œé¡µçš„æ’åºï¼Œè¿™åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢çš„å«ä¹‰ï¼š é¡µå†…çš„è®°å½•æ˜¯æŒ‰ç…§ä¸»é”®çš„å¤§å°é¡ºåºæ’æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚ å„ä¸ªå­˜æ”¾ç”¨æˆ·è®°å½•çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ å­˜æ”¾ç›®å½•é¡¹è®°å½•çš„é¡µåˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œåœ¨åŒä¸€å±‚æ¬¡ä¸­çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç›®å½•é¡¹è®°å½•çš„ä¸»é”®å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ B+æ ‘çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯å®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ æ‰€è°“å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œå°±æ˜¯æŒ‡è¿™ä¸ªè®°å½•ä¸­å­˜å‚¨äº†æ‰€æœ‰åˆ—çš„å€¼ï¼ˆåŒ…æ‹¬éšè—åˆ—ï¼‰ã€‚ æˆ‘ä»¬æŠŠå…·æœ‰è¿™ä¸¤ç§ç‰¹æ€§çš„B+æ ‘ç§°ä¸ºèšç°‡ç´¢å¼•ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨è¿™ä¸ªèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å¤„ã€‚è¿™ç§èšç°‡ç´¢å¼•å¹¶ä¸éœ€è¦æˆ‘ä»¬åœ¨MySQLè¯­å¥ä¸­æ˜¾å¼çš„ä½¿ç”¨INDEXè¯­å¥å»åˆ›å»ºï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šè‡ªåŠ¨çš„ä¸ºæˆ‘ä»¬åˆ›å»ºèšç°‡ç´¢å¼•ã€‚å¦å¤–ï¼Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œèšç°‡ç´¢å¼•å°±æ˜¯æ•°æ®çš„å­˜å‚¨æ–¹å¼ï¼ˆæ‰€æœ‰çš„ç”¨æˆ·è®°å½•éƒ½å­˜å‚¨åœ¨äº†å¶å­èŠ‚ç‚¹ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ç´¢å¼•å³æ•°æ®ï¼Œæ•°æ®å³ç´¢å¼•ã€‚ 1.2 äºŒçº§ç´¢å¼•èšç°‡ç´¢å¼•åªèƒ½åœ¨æœç´¢æ¡ä»¶æ˜¯ä¸»é”®å€¼æ—¶æ‰èƒ½å‘æŒ¥ä½œç”¨ï¼Œå› ä¸ºB+æ ‘ä¸­çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§ä¸»é”®è¿›è¡Œæ’åºçš„ã€‚é‚£å¦‚æœæˆ‘ä»¬æƒ³ä»¥åˆ«çš„åˆ—ä½œä¸ºæœç´¢æ¡ä»¶æ€ä¹ˆåŠï¼Ÿ æˆ‘ä»¬å¯ä»¥å¤šå»ºå‡ æ£µB+æ ‘ï¼Œä¸åŒçš„B+æ ‘ä¸­çš„æ•°æ®é‡‡ç”¨ä¸åŒçš„æ’åºè§„åˆ™ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬ç”¨c2åˆ—çš„å¤§å°ä½œä¸ºæ•°æ®é¡µã€é¡µä¸­è®°å½•çš„æ’åºè§„åˆ™ï¼Œå†å»ºä¸€æ£µB+æ ‘ï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™ä¸ªB+æ ‘ä¸ä¸Šè¾¹ä»‹ç»çš„èšç°‡ç´¢å¼•æœ‰å‡ å¤„ä¸åŒï¼š ä½¿ç”¨è®°å½•c2åˆ—çš„å¤§å°è¿›è¡Œè®°å½•å’Œé¡µçš„æ’åºï¼Œè¿™åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢çš„å«ä¹‰ï¼š aé¡µå†…çš„è®°å½•æ˜¯æŒ‰ç…§c2åˆ—çš„å¤§å°é¡ºåºæ’æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚ bå„ä¸ªå­˜æ”¾ç”¨æˆ·è®°å½•çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­è®°å½•çš„c2åˆ—å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ cå­˜æ”¾ç›®å½•é¡¹è®°å½•çš„é¡µåˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œåœ¨åŒä¸€å±‚æ¬¡ä¸­çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç›®å½•é¡¹è®°å½•çš„c2åˆ—å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ B+æ ‘çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„å¹¶ä¸æ˜¯å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œè€Œåªæ˜¯c2åˆ—+ä¸»é”®è¿™ä¸¤ä¸ªåˆ—çš„å€¼ã€‚ ç›®å½•é¡¹è®°å½•ä¸­ä¸å†æ˜¯ä¸»é”®+é¡µå·çš„æ­é…ï¼Œè€Œå˜æˆäº†c2åˆ—+é¡µå·çš„æ­é…ã€‚ æ‰€ä»¥å¦‚æœæˆ‘ä»¬ç°åœ¨æƒ³é€šè¿‡c2åˆ—çš„å€¼æŸ¥æ‰¾æŸäº›è®°å½•çš„è¯å°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬åˆšåˆšå»ºå¥½çš„è¿™ä¸ªB+æ ‘äº†ã€‚ä»¥æŸ¥æ‰¾c2åˆ—çš„å€¼ä¸º4çš„è®°å½•ä¸ºä¾‹ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š 1ç¡®å®šç›®å½•é¡¹è®°å½•é¡µ æ ¹æ®æ ¹é¡µé¢ï¼Œä¹Ÿå°±æ˜¯é¡µ44ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°ç›®å½•é¡¹è®°å½•æ‰€åœ¨çš„é¡µä¸ºé¡µ42ï¼ˆå› ä¸º2 &lt; 4 &lt; 9ï¼‰ã€‚ 2é€šè¿‡ç›®å½•é¡¹è®°å½•é¡µç¡®å®šç”¨æˆ·è®°å½•çœŸå®æ‰€åœ¨çš„é¡µã€‚ åœ¨é¡µ42ä¸­å¯ä»¥å¿«é€Ÿå®šä½åˆ°å®é™…å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µï¼Œä½†æ˜¯ç”±äºc2åˆ—å¹¶æ²¡æœ‰å”¯ä¸€æ€§çº¦æŸï¼Œæ‰€ä»¥c2åˆ—å€¼ä¸º4çš„è®°å½•å¯èƒ½åˆ†å¸ƒåœ¨å¤šä¸ªæ•°æ®é¡µä¸­ï¼Œåˆå› ä¸º2 &lt; 4 â‰¤ 4ï¼Œæ‰€ä»¥ç¡®å®šå®é™…å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µåœ¨é¡µ34å’Œé¡µ35ä¸­ã€‚ 3åœ¨çœŸå®å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µä¸­å®šä½åˆ°å…·ä½“çš„è®°å½•. åˆ°é¡µ34å’Œé¡µ35ä¸­å®šä½åˆ°å…·ä½“çš„è®°å½•ã€‚ 4ä½†æ˜¯è¿™ä¸ªB+æ ‘çš„å¶å­èŠ‚ç‚¹ä¸­çš„è®°å½•åªå­˜å‚¨äº†c2å’Œc1ï¼ˆä¹Ÿå°±æ˜¯ä¸»é”®ï¼‰ä¸¤ä¸ªåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å†æ ¹æ®ä¸»é”®å€¼å»èšç°‡ç´¢å¼•ä¸­å†æŸ¥æ‰¾ä¸€éå®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ æˆ‘ä»¬æ ¹æ®è¿™ä¸ªä»¥c2åˆ—å¤§å°æ’åºçš„B+æ ‘åªèƒ½ç¡®å®šæˆ‘ä»¬è¦æŸ¥æ‰¾è®°å½•çš„ä¸»é”®å€¼ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®c2åˆ—çš„å€¼æŸ¥æ‰¾åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•çš„è¯ï¼Œä»ç„¶éœ€è¦åˆ°èšç°‡ç´¢å¼•ä¸­å†æŸ¥ä¸€éï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿè¢«ç§°ä¸ºå›è¡¨ã€‚ä¹Ÿå°±æ˜¯æ ¹æ®c2åˆ—çš„å€¼æŸ¥è¯¢ä¸€æ¡å®Œæ•´çš„ç”¨æˆ·è®°å½•éœ€è¦ä½¿ç”¨åˆ°2æ£µB+æ ‘ï¼ï¼ï¼ ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ä¸€æ¬¡å›è¡¨æ“ä½œå‘¢ï¼Ÿç›´æ¥æŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•æ”¾åˆ°å¶å­èŠ‚ç‚¹ä¸å°±å¥½äº†ä¹ˆï¼Ÿ å¦‚æœæŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•æ”¾åˆ°å¶å­èŠ‚ç‚¹æ˜¯å¯ä»¥ä¸ç”¨å›è¡¨ï¼Œç›¸å½“äºæ¯å»ºç«‹ä¸€æ£µB+æ ‘éƒ½éœ€è¦æŠŠæ‰€æœ‰çš„ç”¨æˆ·è®°å½•å†éƒ½æ‹·è´ä¸€éï¼Œè¿™å°±æœ‰ç‚¹å¤ªæµªè´¹å­˜å‚¨ç©ºé—´äº†ã€‚å› ä¸ºè¿™ç§æŒ‰ç…§éä¸»é”®åˆ—å»ºç«‹çš„B+æ ‘éœ€è¦ä¸€æ¬¡å›è¡¨æ“ä½œæ‰å¯ä»¥å®šä½åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œæ‰€ä»¥è¿™ç§B+æ ‘ä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•ï¼ˆè‹±æ–‡åsecondary indexï¼‰ï¼Œæˆ–è€…è¾…åŠ©ç´¢å¼•ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯c2åˆ—çš„å¤§å°ä½œä¸ºB+æ ‘çš„æ’åºè§„åˆ™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç§°è¿™ä¸ªB+æ ‘ä¸ºä¸ºc2åˆ—å»ºç«‹çš„ç´¢å¼•ã€‚ å‡è®¾æˆ‘ä»¬çš„æŸ¥è¯¢ç»“æœæ˜¯åæ¡ï¼Œé‚£å°±æ˜¯è¦è¿›è¡Œ10æ¬¡å›è¡¨ï¼Œé‚£è¿™æ ·çš„è¯ï¼Œæ•ˆç‡ä¸æ˜¯åˆæ…¢äº†ï¼Ÿ åœ¨MySQL5.6å¯¹è¿™ç§æƒ…å†µè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¦‚æœå‘ç°æŸ¥è¯¢ç»“æœä¼šå¯¼è‡´å¤šæ¬¡å›è¡¨ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡ŒIOåˆå¹¶ï¼Œæ‹¿åˆ°æ‰€æœ‰çš„ä¸»é”®å†å»è¿›è¡Œå›è¡¨ã€‚ 1.3 è”åˆç´¢å¼•æˆ‘ä»¬ä¹Ÿå¯ä»¥åŒæ—¶ä»¥å¤šä¸ªåˆ—çš„å¤§å°ä½œä¸ºæ’åºè§„åˆ™ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶ä¸ºå¤šä¸ªåˆ—å»ºç«‹ç´¢å¼•ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬æƒ³è®©B+æ ‘æŒ‰ç…§c2å’Œc3åˆ—çš„å¤§å°è¿›è¡Œæ’åºï¼Œè¿™ä¸ªåŒ…å«ä¸¤å±‚å«ä¹‰ï¼š â—å…ˆæŠŠå„ä¸ªè®°å½•å’Œé¡µæŒ‰ç…§c2åˆ—è¿›è¡Œæ’åºã€‚ â—åœ¨è®°å½•çš„c2åˆ—ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨c3åˆ—è¿›è¡Œæ’åº ä¸ºc2å’Œc3åˆ—å»ºç«‹çš„ç´¢å¼•çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š å››ã€æ€»ç»“ï¼šä¸€æ¬¡é€šè¿‡èšç°‡ç´¢å¼•å®šä½æ•°æ®çš„è¿‡ç¨‹å¤§å®¶ç†Ÿæ‚‰çš„ä¸‰ä¸ªç‰ˆæœ¬ç´¢å¼•ç»“æ„å›¾å¦‚ä¸‹ æ™®é€šç´¢å¼• äºŒçº§ç´¢å¼• ç»„åˆç´¢å¼•ç´¢å¼• ç›¸å¯¹å®Œæ•´äº›çš„ä¸‰ç§ç´¢å¼•ç»“æ„è§ï¼ˆä¸‰ã€ç´¢å¼•ï¼‰ ä¸‹å›¾ä¸ºèšç°‡ç´¢å¼•å®Œæ•´ç‰ˆç»“æ„ ä¸€æ¬¡æŒ‰ç…§ä¸»é”®idæŸ¥è¯¢id=5çš„æ•°æ®çš„å…¨æµç¨‹ 1.ç¡®å®šç›®å½•é¡¹è®°å½•é¡µï¼Œæ‰¾åˆ°é¡µ50 2.äºŒåˆ†æŸ¥æ‰¾ç¡®å®šæ‰€å±æ§½ä½1ï¼Œç„¶åéå†æ§½ä½1é‡Œçš„é“¾è¡¨å¾—çŸ¥ä¸‹æ¬¡è¯¥ç»§ç»­æŸ¥è¯¢é¡µ55 3.äºŒåˆ†æŸ¥æ‰¾ç¡®å®šæ‰€å±æ§½ä½1ï¼Œç„¶åéå†æ§½ä½1é‡Œçš„é“¾è¡¨å¾—çŸ¥ä¸‹æ¬¡è¯¥ç»§ç»­æŸ¥è¯¢é¡µ61 4.äºŒåˆ†æŸ¥æ‰¾ç¡®å®šæ‰€å±æ§½ä½2ï¼Œç„¶åéå†æ§½ä½2é‡Œçš„é“¾è¡¨å¾—åˆ°idä¸º4çš„æ•°æ®","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"mysqlä¸‰å¤§æ—¥å¿—","slug":"7.mysql/mysqlä¸‰å¤§æ—¥å¿—","date":"2021-12-26T16:00:00.000Z","updated":"2024-08-22T03:23:14.706Z","comments":true,"path":"2021/12/27/7.mysql/mysqlä¸‰å¤§æ—¥å¿—/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/27/7.mysql/mysql%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97/","excerpt":"","text":"æ—¥å¿—æ˜¯ mysql æ•°æ®åº“çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè®°å½•ç€æ•°æ®åº“è¿è¡ŒæœŸé—´å„ç§çŠ¶æ€ä¿¡æ¯ã€‚mysqlæ—¥å¿—ä¸»è¦åŒ…æ‹¬é”™è¯¯æ—¥å¿—ã€æŸ¥è¯¢æ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—ã€äº‹åŠ¡æ—¥å¿—ã€äºŒè¿›åˆ¶æ—¥å¿—å‡ å¤§ç±»ã€‚ ä½œä¸ºå¼€å‘ï¼Œæˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯äºŒè¿›åˆ¶æ—¥å¿—( binlog )å’Œäº‹åŠ¡æ—¥å¿—(åŒ…æ‹¬redo log å’Œ undo log )ï¼Œæœ¬æ–‡æ¥ä¸‹æ¥ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸‰ç§æ—¥å¿—ã€‚ binlogbinlog ç”¨äºè®°å½•æ•°æ®åº“æ‰§è¡Œçš„å†™å…¥æ€§æ“ä½œ(ä¸åŒ…æ‹¬æŸ¥è¯¢)ä¿¡æ¯ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼ä¿å­˜åœ¨ç£ç›˜ä¸­ã€‚binlog æ˜¯ mysqlçš„é€»è¾‘æ—¥å¿—ï¼Œå¹¶ä¸”ç”± Server å±‚è¿›è¡Œè®°å½•ï¼Œä½¿ç”¨ä»»ä½•å­˜å‚¨å¼•æ“çš„ mysql æ•°æ®åº“éƒ½ä¼šè®°å½• binlog æ—¥å¿—ã€‚ é€»è¾‘æ—¥å¿—ï¼šå¯ä»¥ç®€å•ç†è§£ä¸ºè®°å½•çš„å°±æ˜¯sqlè¯­å¥ ã€‚ ç‰©ç†æ—¥å¿—ï¼šmysql æ•°æ®æœ€ç»ˆæ˜¯ä¿å­˜åœ¨æ•°æ®é¡µä¸­çš„ï¼Œç‰©ç†æ—¥å¿—è®°å½•çš„å°±æ˜¯æ•°æ®é¡µå˜æ›´ ã€‚ binlog æ˜¯é€šè¿‡è¿½åŠ çš„æ–¹å¼è¿›è¡Œå†™å…¥çš„ï¼Œå¯ä»¥é€šè¿‡max_binlog_size å‚æ•°è®¾ç½®æ¯ä¸ª binlogæ–‡ä»¶çš„å¤§å°ï¼Œå½“æ–‡ä»¶å¤§å°è¾¾åˆ°ç»™å®šå€¼ä¹‹åï¼Œä¼šç”Ÿæˆæ–°çš„æ–‡ä»¶æ¥ä¿å­˜æ—¥å¿—ã€‚ binlogä½¿ç”¨åœºæ™¯åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ binlog çš„ä¸»è¦ä½¿ç”¨åœºæ™¯æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ ä¸»ä»å¤åˆ¶ å’Œ æ•°æ®æ¢å¤ ã€‚ ä¸»ä»å¤åˆ¶ ï¼šåœ¨ Master ç«¯å¼€å¯ binlog ï¼Œç„¶åå°† binlogå‘é€åˆ°å„ä¸ª Slave ç«¯ï¼Œ Slave ç«¯é‡æ”¾ binlog ä»è€Œè¾¾åˆ°ä¸»ä»æ•°æ®ä¸€è‡´ã€‚ æ•°æ®æ¢å¤ ï¼šé€šè¿‡ä½¿ç”¨ mysqlbinlog å·¥å…·æ¥æ¢å¤æ•°æ®ã€‚ binlogåˆ·ç›˜æ—¶æœºå¯¹äº InnoDB å­˜å‚¨å¼•æ“è€Œè¨€ï¼Œåªæœ‰åœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šè®°å½•biglog ï¼Œæ­¤æ—¶è®°å½•è¿˜åœ¨å†…å­˜ä¸­ï¼Œé‚£ä¹ˆ biglogæ˜¯ä»€ä¹ˆæ—¶å€™åˆ·åˆ°ç£ç›˜ä¸­çš„å‘¢ï¼Ÿ mysql é€šè¿‡ sync_binlog å‚æ•°æ§åˆ¶ biglog çš„åˆ·ç›˜æ—¶æœºï¼Œå–å€¼èŒƒå›´æ˜¯ 0-Nï¼š 0ï¼šä¸å»å¼ºåˆ¶è¦æ±‚ï¼Œç”±ç³»ç»Ÿè‡ªè¡Œåˆ¤æ–­ä½•æ—¶å†™å…¥ç£ç›˜ï¼› 1ï¼šæ¯æ¬¡ commit çš„æ—¶å€™éƒ½è¦å°† binlog å†™å…¥ç£ç›˜ï¼› Nï¼šæ¯Nä¸ªäº‹åŠ¡ï¼Œæ‰ä¼šå°† binlog å†™å…¥ç£ç›˜ã€‚ ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ sync_binlog æœ€å®‰å…¨çš„æ˜¯è®¾ç½®æ˜¯ 1 ï¼Œè¿™ä¹Ÿæ˜¯MySQL 5.7.7ä¹‹åç‰ˆæœ¬çš„é»˜è®¤å€¼ã€‚ä½†æ˜¯è®¾ç½®ä¸€ä¸ªå¤§ä¸€äº›çš„å€¼å¯ä»¥æå‡æ•°æ®åº“æ€§èƒ½ï¼Œå› æ­¤å®é™…æƒ…å†µä¸‹ä¹Ÿå¯ä»¥å°†å€¼é€‚å½“è°ƒå¤§ï¼Œç‰ºç‰²ä¸€å®šçš„ä¸€è‡´æ€§æ¥è·å–æ›´å¥½çš„æ€§èƒ½ã€‚ binlogæ—¥å¿—æ ¼å¼binlog æ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œåˆ†åˆ«ä¸º STATMENT ã€ ROW å’Œ MIXEDã€‚ åœ¨ MySQL 5.7.7 ä¹‹å‰ï¼Œé»˜è®¤çš„æ ¼å¼æ˜¯ STATEMENT ï¼Œ MySQL 5.7.7 ä¹‹åï¼Œé»˜è®¤å€¼æ˜¯ ROWã€‚æ—¥å¿—æ ¼å¼é€šè¿‡ binlog-format æŒ‡å®šã€‚ STATMENTï¼šåŸºäºSQL è¯­å¥çš„å¤åˆ¶( statement-based replication, SBR )ï¼Œæ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqlè¯­å¥ä¼šè®°å½•åˆ°binlog ä¸­ ã€‚ ä¼˜ç‚¹ï¼šä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº† binlog æ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº† IO , ä»è€Œæé«˜äº†æ€§èƒ½ï¼› ç¼ºç‚¹ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ¯”å¦‚æ‰§è¡Œsysdate() ã€ slepp() ç­‰ ã€‚ ROWï¼šåŸºäºè¡Œçš„å¤åˆ¶(row-based replication, RBR )ï¼Œä¸è®°å½•æ¯æ¡sqlè¯­å¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»…éœ€è®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº† ã€‚ ä¼˜ç‚¹ï¼šä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹çš„å­˜å‚¨è¿‡ç¨‹ã€æˆ–functionã€æˆ–triggerçš„è°ƒç”¨å’Œè§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ ï¼› ç¼ºç‚¹ï¼šä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—ï¼Œå°¤å…¶æ˜¯alter table çš„æ—¶å€™ä¼šè®©æ—¥å¿—æš´æ¶¨ MIXEDï¼šåŸºäºSTATMENT å’Œ ROW ä¸¤ç§æ¨¡å¼çš„æ··åˆå¤åˆ¶(mixed-based replication, MBR )ï¼Œä¸€èˆ¬çš„å¤åˆ¶ä½¿ç”¨STATEMENT æ¨¡å¼ä¿å­˜ binlog ï¼Œå¯¹äº STATEMENT æ¨¡å¼æ— æ³•å¤åˆ¶çš„æ“ä½œä½¿ç”¨ ROW æ¨¡å¼ä¿å­˜ binlog redo logä¸ºä»€ä¹ˆéœ€è¦redo logæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œäº‹åŠ¡çš„å››å¤§ç‰¹æ€§é‡Œé¢æœ‰ä¸€ä¸ªæ˜¯ æŒä¹…æ€§ ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯åªè¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“åšçš„ä¿®æ”¹å°±è¢«æ°¸ä¹…ä¿å­˜ä¸‹æ¥äº†ï¼Œä¸å¯èƒ½å› ä¸ºä»»ä½•åŸå› å†å›åˆ°åŸæ¥çš„çŠ¶æ€ ã€‚ é‚£ä¹ˆ mysqlæ˜¯å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„å‘¢ï¼Ÿ æœ€ç®€å•çš„åšæ³•æ˜¯åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°†è¯¥äº‹åŠ¡æ¶‰åŠä¿®æ”¹çš„æ•°æ®é¡µå…¨éƒ¨åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯è¿™ä¹ˆåšä¼šæœ‰ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š å› ä¸º Innodb æ˜¯ä»¥ é¡µ ä¸ºå•ä½è¿›è¡Œç£ç›˜äº¤äº’çš„ï¼Œè€Œä¸€ä¸ªäº‹åŠ¡å¾ˆå¯èƒ½åªä¿®æ”¹ä¸€ä¸ªæ•°æ®é¡µé‡Œé¢çš„å‡ ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™å°†å®Œæ•´çš„æ•°æ®é¡µåˆ·åˆ°ç£ç›˜çš„è¯ï¼Œå¤ªæµªè´¹èµ„æºäº†ï¼ ä¸€ä¸ªäº‹åŠ¡å¯èƒ½æ¶‰åŠä¿®æ”¹å¤šä¸ªæ•°æ®é¡µï¼Œå¹¶ä¸”è¿™äº›æ•°æ®é¡µåœ¨ç‰©ç†ä¸Šå¹¶ä¸è¿ç»­ï¼Œä½¿ç”¨éšæœºIOå†™å…¥æ€§èƒ½å¤ªå·®ï¼ å› æ­¤ mysql è®¾è®¡äº† redo log ï¼Œ å…·ä½“æ¥è¯´å°±æ˜¯åªè®°å½•äº‹åŠ¡å¯¹æ•°æ®é¡µåšäº†å“ªäº›****ä¿®æ”¹ï¼Œè¿™æ ·å°±èƒ½å®Œç¾åœ°è§£å†³æ€§èƒ½é—®é¢˜äº†(ç›¸å¯¹è€Œè¨€æ–‡ä»¶æ›´å°å¹¶ä¸”æ˜¯é¡ºåºIO)ã€‚ redo logåŸºæœ¬æ¦‚å¿µredo log åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªæ˜¯å†…å­˜ä¸­çš„æ—¥å¿—ç¼“å†²( redo log buffer )ï¼Œå¦ä¸€ä¸ªæ˜¯ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶( redo logfile)ã€‚ mysql æ¯æ‰§è¡Œä¸€æ¡ DML è¯­å¥ï¼Œå…ˆå°†è®°å½•å†™å…¥ redo log bufferï¼Œåç»­æŸä¸ªæ—¶é—´ç‚¹å†ä¸€æ¬¡æ€§å°†å¤šä¸ªæ“ä½œè®°å½•å†™åˆ° redo log fileã€‚è¿™ç§ å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ çš„æŠ€æœ¯å°±æ˜¯ MySQLé‡Œç»å¸¸è¯´åˆ°çš„ WAL(Write-Ahead Logging) æŠ€æœ¯ã€‚ åœ¨è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´( user space )ä¸‹çš„ç¼“å†²åŒºæ•°æ®ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ— æ³•ç›´æ¥å†™å…¥ç£ç›˜çš„ï¼Œä¸­é—´å¿…é¡»ç»è¿‡æ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´( kernel space )ç¼“å†²åŒº( OS Buffer )ã€‚ å› æ­¤ï¼Œ redo log buffer å†™å…¥ redo logfile å®é™…ä¸Šæ˜¯å…ˆå†™å…¥ OS Buffer ï¼Œç„¶åå†é€šè¿‡ç³»ç»Ÿè°ƒç”¨ fsync() å°†å…¶åˆ·åˆ° redo log fileä¸­ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š mysql æ”¯æŒä¸‰ç§å°† redo log buffer å†™å…¥ redo log file çš„æ—¶æœºï¼Œå¯ä»¥é€šè¿‡ innodb_flush_log_at_trx_commit å‚æ•°é…ç½®ï¼Œå„å‚æ•°å€¼å«ä¹‰å¦‚ä¸‹ï¼š redo logè®°å½•å½¢å¼å‰é¢è¯´è¿‡ï¼Œ redo log å®é™…ä¸Šè®°å½•æ•°æ®é¡µçš„å˜æ›´ï¼Œè€Œè¿™ç§å˜æ›´è®°å½•æ˜¯æ²¡å¿…è¦å…¨éƒ¨ä¿å­˜ï¼Œå› æ­¤ redo logå®ç°ä¸Šé‡‡ç”¨äº†å¤§å°å›ºå®šï¼Œå¾ªç¯å†™å…¥çš„æ–¹å¼ï¼Œå½“å†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›åˆ°å¼€å¤´å¾ªç¯å†™æ—¥å¿—ã€‚ å¦‚ä¸‹å›¾ï¼š åŒæ—¶æˆ‘ä»¬å¾ˆå®¹æ˜“å¾—çŸ¥ï¼Œ åœ¨innodbä¸­ï¼Œæ—¢æœ‰redo log éœ€è¦åˆ·ç›˜ï¼Œè¿˜æœ‰ æ•°æ®é¡µ ä¹Ÿéœ€è¦åˆ·ç›˜ï¼Œ redo logå­˜åœ¨çš„æ„ä¹‰ä¸»è¦å°±æ˜¯é™ä½å¯¹ æ•°æ®é¡µ åˆ·ç›˜çš„è¦æ±‚ã€‚ åœ¨ä¸Šå›¾ä¸­ï¼Œ write pos è¡¨ç¤º redo log å½“å‰è®°å½•çš„ LSN (é€»è¾‘åºåˆ—å·)ä½ç½®ï¼Œ check point è¡¨ç¤º æ•°æ®é¡µæ›´æ”¹è®°å½• åˆ·ç›˜åå¯¹åº” redo log æ‰€å¤„çš„ LSN(é€»è¾‘åºåˆ—å·)ä½ç½®ã€‚ write pos åˆ° check point ä¹‹é—´çš„éƒ¨åˆ†æ˜¯ redo log ç©ºç€çš„éƒ¨åˆ†ï¼Œç”¨äºè®°å½•æ–°çš„è®°å½•ï¼›check point åˆ° write pos ä¹‹é—´æ˜¯ redo log å¾…è½ç›˜çš„æ•°æ®é¡µæ›´æ”¹è®°å½•ã€‚å½“ write posè¿½ä¸Šcheck point æ—¶ï¼Œä¼šå…ˆæ¨åŠ¨ check point å‘å‰ç§»åŠ¨ï¼Œç©ºå‡ºä½ç½®å†è®°å½•æ–°çš„æ—¥å¿—ã€‚ å¯åŠ¨ innodb çš„æ—¶å€™ï¼Œä¸ç®¡ä¸Šæ¬¡æ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯å¼‚å¸¸å…³é—­ï¼Œæ€»æ˜¯ä¼šè¿›è¡Œæ¢å¤æ“ä½œã€‚å› ä¸º redo logè®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼Œå› æ­¤æ¢å¤çš„æ—¶å€™é€Ÿåº¦æ¯”é€»è¾‘æ—¥å¿—(å¦‚ binlog )è¦å¿«å¾ˆå¤šã€‚ é‡å¯innodb æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ç£ç›˜ä¸­æ•°æ®é¡µçš„ LSN ï¼Œå¦‚æœæ•°æ®é¡µçš„LSN å°äºæ—¥å¿—ä¸­çš„ LSN ï¼Œåˆ™ä¼šä» checkpoint å¼€å§‹æ¢å¤ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œåœ¨å®•æœºå‰æ­£å¤„äºcheckpoint çš„åˆ·ç›˜è¿‡ç¨‹ï¼Œä¸”æ•°æ®é¡µçš„åˆ·ç›˜è¿›åº¦è¶…è¿‡äº†æ—¥å¿—é¡µçš„åˆ·ç›˜è¿›åº¦ï¼Œæ­¤æ—¶ä¼šå‡ºç°æ•°æ®é¡µä¸­è®°å½•çš„ LSN å¤§äºæ—¥å¿—ä¸­çš„ LSNï¼Œè¿™æ—¶è¶…å‡ºæ—¥å¿—è¿›åº¦çš„éƒ¨åˆ†å°†ä¸ä¼šé‡åšï¼Œå› ä¸ºè¿™æœ¬èº«å°±è¡¨ç¤ºå·²ç»åšè¿‡çš„äº‹æƒ…ï¼Œæ— éœ€å†é‡åšã€‚ redo logä¸binlogåŒºåˆ« ç”± binlog å’Œ redo log çš„åŒºåˆ«å¯çŸ¥ï¼šbinlog æ—¥å¿—åªç”¨äºå½’æ¡£ï¼Œåªä¾é  binlog æ˜¯æ²¡æœ‰ crash-safe èƒ½åŠ›çš„ã€‚ ä½†åªæœ‰ redo log ä¹Ÿä¸è¡Œï¼Œå› ä¸º redo log æ˜¯ InnoDBç‰¹æœ‰çš„ï¼Œä¸”æ—¥å¿—ä¸Šçš„è®°å½•è½ç›˜åä¼šè¢«è¦†ç›–æ‰ã€‚å› æ­¤éœ€è¦ binlogå’Œ redo logäºŒè€…åŒæ—¶è®°å½•ï¼Œæ‰èƒ½ä¿è¯å½“æ•°æ®åº“å‘ç”Ÿå®•æœºé‡å¯æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚ undo logæ•°æ®åº“äº‹åŠ¡å››å¤§ç‰¹æ€§ä¸­æœ‰ä¸€ä¸ªæ˜¯ åŸå­æ€§ ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ åŸå­æ€§æ˜¯æŒ‡å¯¹æ•°æ®åº“çš„ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å¯èƒ½å‡ºç°éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µã€‚ å®é™…ä¸Šï¼Œ åŸå­æ€§ åº•å±‚å°±æ˜¯é€šè¿‡ undo log å®ç°çš„ã€‚undo logä¸»è¦è®°å½•äº†æ•°æ®çš„é€»è¾‘å˜åŒ–ï¼Œæ¯”å¦‚ä¸€æ¡ INSERT è¯­å¥ï¼Œå¯¹åº”ä¸€æ¡DELETE çš„ undo log ï¼Œå¯¹äºæ¯ä¸ª UPDATE è¯­å¥ï¼Œå¯¹åº”ä¸€æ¡ç›¸åçš„ UPDATE çš„ undo log ï¼Œè¿™æ ·åœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå°±èƒ½å›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®çŠ¶æ€ã€‚ åŒæ—¶ï¼Œ undo log ä¹Ÿæ˜¯ MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)å®ç°çš„å…³é”®ã€‚ Undo logæ˜¯InnoDB MVCCäº‹åŠ¡ç‰¹æ€§çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚å½“æˆ‘ä»¬å¯¹è®°å½•åšäº†å˜æ›´æ“ä½œæ—¶å°±ä¼šäº§ç”ŸUndoè®°å½•ï¼ŒUndoè®°å½•é»˜è®¤è¢«è®°å½•åˆ°ç³»ç»Ÿè¡¨ç©ºé—´(ibdata)ä¸­ï¼Œä½†ä»5.6å¼€å§‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç‹¬ç«‹çš„Undo è¡¨ç©ºé—´ã€‚ Undoè®°å½•ä¸­å­˜å‚¨çš„æ˜¯è€ç‰ˆæœ¬æ•°æ®ï¼Œå½“ä¸€ä¸ªæ—§çš„äº‹åŠ¡éœ€è¦è¯»å–æ•°æ®æ—¶ï¼Œä¸ºäº†èƒ½è¯»å–åˆ°è€ç‰ˆæœ¬çš„æ•°æ®ï¼Œéœ€è¦é¡ºç€undoé“¾æ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•ã€‚å½“ç‰ˆæœ¬é“¾å¾ˆé•¿æ—¶ï¼Œé€šå¸¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œã€‚ Undo Log æ ¼å¼ åœ¨InnoDBå¼•æ“ä¸­ï¼Œundo logåˆ†ä¸ºï¼š insert undo logï¼š insert undo logæ˜¯æŒ‡åœ¨insertæ“ä½œä¸­äº§ç”Ÿçš„undo logï¼Œå› ä¸ºinsertæ“ä½œçš„è®°å½•ï¼Œåªå¯¹äº‹åŠ¡æœ¬èº«å¯è§ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ï¼ˆè¿™æ˜¯äº‹åŠ¡éš”ç¦»æ€§çš„è¦æ±‚ï¼‰ï¼Œæ•…è¯¥undo logå¯ä»¥åœ¨äº‹åŠ¡æäº¤åç›´æ¥åˆ é™¤ï¼Œä¸éœ€è¦è¿›è¡Œpurgeæ“ä½œã€‚ update undo logï¼š update undo logè®°å½•çš„æ˜¯deleteå’Œupdateæ“ä½œäº§ç”Ÿçš„undo logã€‚è¯¥undo logå¯èƒ½éœ€è¦æä¾›MVCCæœºåˆ¶ï¼Œå› æ­¤ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶å°±è¿›è¡Œåˆ é™¤ï¼Œæäº¤æ—¶æ”¾å…¥undo logé“¾è¡¨ï¼Œç­‰å¾…purgeçº¿ç¨‹è¿›è¡Œæœ€åçš„åˆ é™¤ã€‚ä¸‹é¢æ˜¯ä¸¤ç§undo logçš„ç»“æ„å›¾ã€‚","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"undolog","slug":"7.mysql/undoæ—¥å¿—","date":"2021-12-26T16:00:00.000Z","updated":"2024-08-22T03:23:14.708Z","comments":true,"path":"2021/12/27/7.mysql/undoæ—¥å¿—/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/27/7.mysql/undo%E6%97%A5%E5%BF%97/","excerpt":"","text":"1.äº‹åŠ¡å›æ»šçš„éœ€æ±‚æˆ‘ä»¬è¯´è¿‡äº‹åŠ¡éœ€è¦ä¿è¯åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆä»€ä¹ˆä¹Ÿä¸åšã€‚ä½†æ˜¯ååæœ‰æ—¶å€™äº‹åŠ¡æ‰§è¡Œåˆ°ä¸€åŠä¼šå‡ºç°ä¸€äº›æƒ…å†µï¼Œæ¯”å¦‚ï¼š æƒ…å†µä¸€ï¼šäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°å„ç§é”™è¯¯ï¼Œæ¯”å¦‚æœåŠ¡å™¨æœ¬èº«çš„é”™è¯¯ï¼Œæ“ä½œç³»ç»Ÿé”™è¯¯ï¼Œç”šè‡³æ˜¯çªç„¶æ–­ç”µå¯¼è‡´çš„é”™è¯¯ã€‚ æƒ…å†µäºŒï¼šç¨‹åºå‘˜å¯ä»¥åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰‹åŠ¨è¾“å…¥ROLLBACKè¯­å¥ç»“æŸå½“å‰çš„äº‹åŠ¡çš„æ‰§è¡Œã€‚ è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šå¯¼è‡´äº‹åŠ¡æ‰§è¡Œåˆ°ä¸€åŠå°±ç»“æŸï¼Œä½†æ˜¯äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å·²ç»ä¿®æ”¹äº†å¾ˆå¤šä¸œè¥¿ï¼Œä¸ºäº†ä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä¸œè¥¿æ”¹å›åŸå…ˆçš„æ ·å­ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç§°ä¹‹ä¸ºå›æ»šï¼ˆè‹±æ–‡åï¼šrollbackï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥é€ æˆä¸€ä¸ªå‡è±¡ï¼šè¿™ä¸ªäº‹åŠ¡çœ‹èµ·æ¥ä»€ä¹ˆéƒ½æ²¡åšï¼Œæ‰€ä»¥ç¬¦åˆåŸå­æ€§è¦æ±‚ã€‚ æ¯å½“æˆ‘ä»¬è¦å¯¹ä¸€æ¡è®°å½•åšæ”¹åŠ¨æ—¶ï¼ˆè¿™é‡Œçš„æ”¹åŠ¨å¯ä»¥æŒ‡INSERTã€DELETEã€UPDATEï¼‰ï¼Œéƒ½éœ€è¦ç•™ä¸€æ‰‹ â€”â€” æŠŠå›æ»šæ—¶æ‰€éœ€çš„ä¸œè¥¿éƒ½ç»™è®°ä¸‹æ¥ã€‚æ¯”æ–¹è¯´ï¼š ä½ æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œè‡³å°‘è¦æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®å€¼è®°ä¸‹æ¥ï¼Œä¹‹åå›æ»šçš„æ—¶å€™åªéœ€è¦æŠŠè¿™ä¸ªä¸»é”®å€¼å¯¹åº”çš„è®°å½•åˆ æ‰å°±å¥½äº†ã€‚ ä½ åˆ é™¤äº†ä¸€æ¡è®°å½•ï¼Œè‡³å°‘è¦æŠŠè¿™æ¡è®°å½•ä¸­çš„å†…å®¹éƒ½è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠç”±è¿™äº›å†…å®¹ç»„æˆçš„è®°å½•æ’å…¥åˆ°è¡¨ä¸­å°±å¥½äº†ã€‚ ä½ ä¿®æ”¹äº†ä¸€æ¡è®°å½•ï¼Œè‡³å°‘è¦æŠŠä¿®æ”¹è¿™æ¡è®°å½•å‰çš„æ—§å€¼éƒ½è®°å½•ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠè¿™æ¡è®°å½•æ›´æ–°ä¸ºæ—§å€¼å°±å¥½äº†ã€‚ æ•°æ®åº“æŠŠè¿™äº›ä¸ºäº†å›æ»šè€Œè®°å½•çš„è¿™äº›ä¸œè¥¿ç§°ä¹‹ä¸ºæ’¤é”€æ—¥å¿—ï¼Œè‹±æ–‡åä¸ºundo logï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœŸæ´‹ç»“åˆï¼Œç§°ä¹‹ä¸ºundoæ—¥å¿—ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äºæŸ¥è¯¢æ“ä½œï¼ˆSELECTï¼‰å¹¶ä¸ä¼šä¿®æ”¹ä»»ä½•ç”¨æˆ·è®°å½•ï¼Œæ‰€ä»¥åœ¨æŸ¥è¯¢æ“ä½œæ‰§è¡Œæ—¶ï¼Œå¹¶ä¸éœ€è¦è®°å½•ç›¸åº”çš„undoæ—¥å¿—ã€‚åœ¨çœŸå®çš„InnoDBä¸­ï¼Œundoæ—¥å¿—å…¶å®å¹¶ä¸åƒæˆ‘ä»¬ä¸Šè¾¹æ‰€è¯´çš„é‚£ä¹ˆç®€å•ï¼Œä¸åŒç±»å‹çš„æ“ä½œäº§ç”Ÿçš„undoæ—¥å¿—çš„æ ¼å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œä¸è¿‡å…ˆæš‚æ—¶æŠŠè¿™äº›å…·ä½“ç»†èŠ‚æ”¾ä¸€æ”¾ï¼Œæˆ‘ä»¬å…ˆå›è¿‡å¤´æ¥çœ‹çœ‹äº‹åŠ¡idã€‚ 2.äº‹åŠ¡id2.1ç»™äº‹åŠ¡åˆ†é…idçš„æ—¶æœºä¸€ä¸ªäº‹åŠ¡å¯ä»¥æ˜¯ä¸€ä¸ªåªè¯»äº‹åŠ¡ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼š æˆ‘ä»¬å¯ä»¥é€šè¿‡START TRANSACTION READ ONLYè¯­å¥å¼€å¯ä¸€ä¸ªåªè¯»äº‹åŠ¡ã€‚åœ¨åªè¯»äº‹åŠ¡ä¸­ä¸å¯ä»¥å¯¹æ™®é€šçš„è¡¨ï¼ˆå…¶ä»–äº‹åŠ¡ä¹Ÿèƒ½è®¿é—®åˆ°çš„è¡¨ï¼‰è¿›è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œï¼Œä½†å¯ä»¥å¯¹ä¸´æ—¶è¡¨åšå¢ã€åˆ ã€æ”¹æ“ä½œã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡START TRANSACTION READ WRITEè¯­å¥å¼€å¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼Œæˆ–è€…ä½¿ç”¨BEGINã€START TRANSACTIONè¯­å¥å¼€å¯çš„äº‹åŠ¡é»˜è®¤ä¹Ÿç®—æ˜¯è¯»å†™äº‹åŠ¡ã€‚åœ¨è¯»å†™äº‹åŠ¡ä¸­å¯ä»¥å¯¹è¡¨æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œã€‚ å¦‚æœæŸä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æŸä¸ªè¡¨æ‰§è¡Œäº†å¢ã€åˆ ã€æ”¹æ“ä½œï¼Œé‚£ä¹ˆInnoDBå­˜å‚¨å¼•æ“å°±ä¼šç»™å®ƒåˆ†é…ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„äº‹åŠ¡idï¼Œåˆ†é…æ–¹å¼å¦‚ä¸‹ï¼š å¯¹äºåªè¯»äº‹åŠ¡æ¥è¯´ï¼Œåªæœ‰åœ¨å®ƒç¬¬ä¸€æ¬¡å¯¹æŸä¸ªç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨æ‰§è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œæ—¶æ‰ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªäº‹åŠ¡idï¼Œå¦åˆ™çš„è¯æ˜¯ä¸åˆ†é…äº‹åŠ¡idçš„ã€‚ å¯¹æŸä¸ªæŸ¥è¯¢è¯­å¥æ‰§è¡ŒEXPLAINåˆ†æå®ƒçš„æŸ¥è¯¢è®¡åˆ’æ—¶ï¼Œæœ‰æ—¶å€™åœ¨Extraåˆ—ä¼šçœ‹åˆ°Using temporaryçš„æç¤ºï¼Œè¿™ä¸ªè¡¨æ˜åœ¨æ‰§è¡Œè¯¥æŸ¥è¯¢è¯­å¥æ—¶ä¼šç”¨åˆ°å†…éƒ¨ä¸´æ—¶è¡¨ã€‚è¿™ä¸ªæ‰€è°“çš„å†…éƒ¨ä¸´æ—¶è¡¨å’Œæˆ‘ä»¬æ‰‹åŠ¨ç”¨CREATE TEMPORARY TABLEåˆ›å»ºçš„ç”¨æˆ·ä¸´æ—¶è¡¨å¹¶ä¸ä¸€æ ·ï¼Œåœ¨äº‹åŠ¡å›æ»šæ—¶å¹¶ä¸éœ€è¦æŠŠæ‰§è¡ŒSELECTè¯­å¥è¿‡ç¨‹ä¸­ç”¨åˆ°çš„å†…éƒ¨ä¸´æ—¶è¡¨ä¹Ÿå›æ»šï¼Œåœ¨æ‰§è¡ŒSELECTè¯­å¥ç”¨åˆ°å†…éƒ¨ä¸´æ—¶è¡¨æ—¶å¹¶ä¸ä¼šä¸ºå®ƒåˆ†é…äº‹åŠ¡idã€‚ å¯¹äºè¯»å†™äº‹åŠ¡æ¥è¯´ï¼Œåªæœ‰åœ¨å®ƒç¬¬ä¸€æ¬¡å¯¹æŸä¸ªè¡¨ï¼ˆåŒ…æ‹¬ç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨ï¼‰æ‰§è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œæ—¶æ‰ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªäº‹åŠ¡idï¼Œå¦åˆ™çš„è¯ä¹Ÿæ˜¯ä¸åˆ†é…äº‹åŠ¡idçš„ã€‚æœ‰çš„æ—¶å€™è™½ç„¶æˆ‘ä»¬å¼€å¯äº†ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªäº‹åŠ¡ä¸­å…¨æ˜¯æŸ¥è¯¢è¯­å¥ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œå¢ã€åˆ ã€æ”¹çš„è¯­å¥ï¼Œé‚£ä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªäº‹åŠ¡å¹¶ä¸ä¼šè¢«åˆ†é…ä¸€ä¸ªäº‹åŠ¡idã€‚ åªæœ‰åœ¨äº‹åŠ¡å¯¹è¡¨ä¸­çš„è®°å½•åšæ”¹åŠ¨æ—¶æ‰ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„**äº‹åŠ¡id**ã€‚ ä¸Šè¾¹æè¿°çš„äº‹åŠ¡idåˆ†é…ç­–ç•¥æ˜¯é’ˆå¯¹MySQL 5.7æ¥è¯´çš„ï¼Œå‰è¾¹çš„ç‰ˆæœ¬çš„åˆ†é…æ–¹å¼å¯èƒ½ä¸åŒã€‚ 2.2äº‹åŠ¡idæ˜¯æ€ä¹ˆç”Ÿæˆçš„è¿™ä¸ªäº‹åŠ¡idæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå®ƒçš„åˆ†é…ç­–ç•¥å’Œå¯¹éšè—åˆ—row_idï¼ˆå½“ç”¨æˆ·æ²¡æœ‰ä¸ºè¡¨åˆ›å»ºä¸»é”®å’ŒUNIQUEé”®æ—¶InnoDBè‡ªåŠ¨åˆ›å»ºçš„åˆ—ï¼‰çš„åˆ†é…ç­–ç•¥å¤§æŠµç›¸åŒï¼Œå…·ä½“ç­–ç•¥å¦‚ä¸‹ï¼š æœåŠ¡å™¨ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ¯å½“éœ€è¦ä¸ºæŸä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªäº‹åŠ¡idæ—¶ï¼Œå°±ä¼šæŠŠè¯¥å˜é‡çš„å€¼å½“ä½œäº‹åŠ¡idåˆ†é…ç»™è¯¥äº‹åŠ¡ï¼Œå¹¶ä¸”æŠŠè¯¥å˜é‡è‡ªå¢1ã€‚ æ¯å½“è¿™ä¸ªå˜é‡çš„å€¼ä¸º256çš„å€æ•°æ—¶ï¼Œå°±ä¼šå°†è¯¥å˜é‡çš„å€¼åˆ·æ–°åˆ°ç³»ç»Ÿè¡¨ç©ºé—´çš„é¡µå·ä¸º5çš„é¡µé¢ä¸­ä¸€ä¸ªç§°ä¹‹ä¸ºMax Trx IDçš„å±æ€§å¤„ï¼Œè¿™ä¸ªå±æ€§å ç”¨8ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚ å½“ç³»ç»Ÿä¸‹ä¸€æ¬¡é‡æ–°å¯åŠ¨æ—¶ï¼Œä¼šå°†ä¸Šè¾¹æåˆ°çš„Max Trx IDå±æ€§åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå°†è¯¥å€¼åŠ ä¸Š256ä¹‹åèµ‹å€¼ç»™æˆ‘ä»¬å‰è¾¹æåˆ°çš„å…¨å±€å˜é‡ï¼ˆå› ä¸ºåœ¨ä¸Šæ¬¡å…³æœºæ—¶è¯¥å…¨å±€å˜é‡çš„å€¼å¯èƒ½å¤§äºMax Trx IDå±æ€§å€¼ï¼‰ã€‚ è¿™æ ·å°±å¯ä»¥ä¿è¯æ•´ä¸ªç³»ç»Ÿä¸­åˆ†é…çš„äº‹åŠ¡idå€¼æ˜¯ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚å…ˆè¢«åˆ†é…idçš„äº‹åŠ¡å¾—åˆ°çš„æ˜¯è¾ƒå°çš„äº‹åŠ¡idï¼Œåè¢«åˆ†é…idçš„äº‹åŠ¡å¾—åˆ°çš„æ˜¯è¾ƒå¤§çš„äº‹åŠ¡idã€‚ 2.3trx_idéšè—åˆ—èšç°‡ç´¢å¼•çš„è®°å½•é™¤äº†ä¼šä¿å­˜å®Œæ•´çš„ç”¨æˆ·æ•°æ®ä»¥å¤–ï¼Œè€Œä¸”è¿˜ä¼šè‡ªåŠ¨æ·»åŠ åä¸ºtrx_idã€roll_pointerçš„éšè—åˆ—ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰åœ¨è¡¨ä¸­å®šä¹‰ä¸»é”®ä»¥åŠUNIQUEé”®ï¼Œè¿˜ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªåä¸ºrow_idçš„éšè—åˆ—ã€‚æ‰€ä»¥ä¸€æ¡è®°å½•åœ¨é¡µé¢ä¸­çš„çœŸå®ç»“æ„çœ‹èµ·æ¥å°±æ˜¯è¿™æ ·çš„ï¼š å…¶ä¸­çš„trx_idåˆ—å…¶å®è¿˜è›®å¥½ç†è§£çš„ï¼Œå°±æ˜¯æŸä¸ªå¯¹è¿™ä¸ªèšç°‡ç´¢å¼•è®°å½•åšæ”¹åŠ¨çš„è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡å¯¹åº”çš„äº‹åŠ¡idè€Œå·²ï¼ˆæ­¤å¤„çš„æ”¹åŠ¨å¯ä»¥æ˜¯INSERTã€DELETEã€UPDATEæ“ä½œï¼‰ã€‚è‡³äºroll_pointeréšè—åˆ—æˆ‘ä»¬åè¾¹åˆ†æã€‚ 3.undoæ—¥å¿—çš„æ ¼å¼ä¸ºäº†å®ç°äº‹åŠ¡çš„åŸå­æ€§ï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨å®é™…è¿›è¡Œå¢ã€åˆ ã€æ”¹ä¸€æ¡è®°å½•æ—¶ï¼Œéƒ½éœ€è¦å…ˆæŠŠå¯¹åº”çš„undoæ—¥å¿—è®°ä¸‹æ¥ã€‚ä¸€èˆ¬æ¯å¯¹ä¸€æ¡è®°å½•åšä¸€æ¬¡æ”¹åŠ¨ï¼Œå°±å¯¹åº”ç€ä¸€æ¡undoæ—¥å¿—ï¼Œä½†åœ¨æŸäº›æ›´æ–°è®°å½•çš„æ“ä½œä¸­ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¹åº”ç€2æ¡undoæ—¥å¿—ã€‚ä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½æ–°å¢ã€åˆ é™¤ã€æ›´æ–°è‹¥å¹²æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦è®°å½•å¾ˆå¤šæ¡å¯¹åº”çš„undoæ—¥å¿—ï¼Œè¿™äº›undoæ—¥å¿—ä¼šè¢«ä»0å¼€å§‹ç¼–å·ï¼Œä¹Ÿå°±æ˜¯è¯´æ ¹æ®ç”Ÿæˆçš„é¡ºåºåˆ†åˆ«è¢«ç§°ä¸ºç¬¬0å·undoæ—¥å¿—ã€ç¬¬1å·undoæ—¥å¿—ã€â€¦ã€ç¬¬nå·undoæ—¥å¿—ç­‰ï¼Œè¿™ä¸ªç¼–å·ä¹Ÿè¢«ç§°ä¹‹ä¸ºundo noã€‚ è¿™äº›undoæ—¥å¿—æ˜¯è¢«è®°å½•åˆ°ç±»å‹ä¸ºFIL_PAGE_UNDO_LOGçš„é¡µé¢ä¸­ã€‚è¿™äº›é¡µé¢å¯ä»¥ä»ç³»ç»Ÿè¡¨ç©ºé—´ä¸­åˆ†é…ï¼Œä¹Ÿå¯ä»¥ä»ä¸€ç§ä¸“é—¨å­˜æ”¾undoæ—¥å¿—çš„è¡¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„undo tablespaceä¸­åˆ†é…ã€‚å…ˆæ¥çœ‹çœ‹ä¸åŒæ“ä½œéƒ½ä¼šäº§ç”Ÿä»€ä¹ˆæ ·å­çš„undoæ—¥å¿—å§ï½æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€ä¸ªåä¸ºundo_demoçš„è¡¨ï¼š 1234567CREATE TABLE undo_demo ( id INT NOT NULL, key1 VARCHAR(100), col VARCHAR(100), PRIMARY KEY (id), KEY idx_key1 (key1))Engine=InnoDB CHARSET=utf8; è¿™ä¸ªè¡¨ä¸­æœ‰3ä¸ªåˆ—ï¼Œå…¶ä¸­idåˆ—æ˜¯ä¸»é”®ï¼Œæˆ‘ä»¬ä¸ºkey1åˆ—å»ºç«‹äº†ä¸€ä¸ªäºŒçº§ç´¢å¼•ï¼Œcolåˆ—æ˜¯ä¸€ä¸ªæ™®é€šçš„åˆ—ã€‚æ¯ä¸ªè¡¨éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„table idï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç³»ç»Ÿæ•°æ®åº“information_schemaä¸­çš„innodb_sys_tablesè¡¨æ¥æŸ¥çœ‹æŸä¸ªè¡¨å¯¹åº”çš„table idæ˜¯ä»€ä¹ˆï¼Œç°åœ¨æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹undo_demoå¯¹åº”çš„table idæ˜¯å¤šå°‘ï¼š 1234567mysql&gt; SELECT * FROM information_schema.innodb_sys_tables WHERE name = &#x27;yhd/undo_demo&#x27;;+----------+---------------------+------+--------+-------+-------------+------------+---------------+------------+| TABLE_ID | NAME | FLAG | N_COLS | SPACE | FILE_FORMAT | ROW_FORMAT | ZIP_PAGE_SIZE | SPACE_TYPE |+----------+---------------------+------+--------+-------+-------------+------------+---------------+------------+| 138 | yhd/undo_demo | 33 | 6 | 482 | Barracuda | Dynamic | 0 | Single |+----------+---------------------+------+--------+-------+-------------+------------+---------------+------------+1 row in set (0.01 sec) ä»æŸ¥è¯¢ç»“æœå¯ä»¥çœ‹å‡ºï¼Œundo_demoè¡¨å¯¹åº”çš„table idä¸º138ã€‚ 3.1INSERTæ“ä½œå¯¹åº”çš„undoæ—¥å¿—å½“æˆ‘ä»¬å‘è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶ä¼šæœ‰ä¹è§‚æ’å…¥å’Œæ‚²è§‚æ’å…¥çš„åŒºåˆ†ï¼Œä½†æ˜¯ä¸ç®¡æ€ä¹ˆæ’å…¥ï¼Œæœ€ç»ˆå¯¼è‡´çš„ç»“æœå°±æ˜¯è¿™æ¡è®°å½•è¢«æ”¾åˆ°äº†ä¸€ä¸ªæ•°æ®é¡µä¸­ã€‚å¦‚æœå¸Œæœ›å›æ»šè¿™ä¸ªæ’å…¥æ“ä½œï¼Œé‚£ä¹ˆæŠŠè¿™æ¡è®°å½•åˆ é™¤å°±å¥½äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å†™å¯¹åº”çš„undoæ—¥å¿—æ—¶ï¼Œä¸»è¦æ˜¯æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®ä¿¡æ¯è®°ä¸Šã€‚æ‰€ä»¥InnoDBè®¾è®¡äº†ä¸€ä¸ªç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œå®ƒçš„å®Œæ•´ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ ¹æ®ç¤ºæ„å›¾æˆ‘ä»¬å¼ºè°ƒå‡ ç‚¹ï¼š undo noåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ˜¯ä»0å¼€å§‹é€’å¢çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦äº‹åŠ¡æ²¡æäº¤ï¼Œæ¯ç”Ÿæˆä¸€æ¡undoæ—¥å¿—ï¼Œé‚£ä¹ˆè¯¥æ¡æ—¥å¿—çš„undo noå°±å¢1ã€‚ å¦‚æœè®°å½•ä¸­çš„ä¸»é”®åªåŒ…å«ä¸€ä¸ªåˆ—ï¼Œé‚£ä¹ˆåœ¨ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ä¸­åªéœ€è¦æŠŠè¯¥åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°å’ŒçœŸå®å€¼è®°å½•ä¸‹æ¥ï¼Œå¦‚æœè®°å½•ä¸­çš„ä¸»é”®åŒ…å«å¤šä¸ªåˆ—ï¼Œé‚£ä¹ˆæ¯ä¸ªåˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°å’Œå¯¹åº”çš„çœŸå®å€¼éƒ½éœ€è¦è®°å½•ä¸‹æ¥ï¼ˆå›¾ä¸­çš„lenå°±ä»£è¡¨åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œvalueå°±ä»£è¡¨åˆ—çš„çœŸå®å€¼ï¼‰ã€‚ å½“æˆ‘ä»¬å‘æŸä¸ªè¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œå®é™…ä¸Šéœ€è¦å‘èšç°‡ç´¢å¼•å’Œæ‰€æœ‰çš„äºŒçº§ç´¢å¼•éƒ½æ’å…¥ä¸€æ¡è®°å½•ã€‚ä¸è¿‡è®°å½•undoæ—¥å¿—æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦è€ƒè™‘å‘èšç°‡ç´¢å¼•æ’å…¥è®°å½•æ—¶çš„æƒ…å†µå°±å¥½äº†ï¼Œå› ä¸ºå…¶å®èšç°‡ç´¢å¼•è®°å½•å’ŒäºŒçº§ç´¢å¼•è®°å½•æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæˆ‘ä»¬åœ¨å›æ»šæ’å…¥æ“ä½œæ—¶ï¼Œåªéœ€è¦çŸ¥é“è¿™æ¡è®°å½•çš„ä¸»é”®ä¿¡æ¯ï¼Œç„¶åæ ¹æ®ä¸»é”®ä¿¡æ¯åšå¯¹åº”çš„åˆ é™¤æ“ä½œï¼Œåšåˆ é™¤æ“ä½œæ—¶å°±ä¼šé¡ºå¸¦ç€æŠŠæ‰€æœ‰äºŒçº§ç´¢å¼•ä¸­ç›¸åº”çš„è®°å½•ä¹Ÿåˆ é™¤æ‰ã€‚åè¾¹è¯´åˆ°çš„DELETEæ“ä½œå’ŒUPDATEæ“ä½œå¯¹åº”çš„undoæ—¥å¿—ä¹Ÿéƒ½æ˜¯é’ˆå¯¹èšç°‡ç´¢å¼•è®°å½•è€Œè¨€çš„ã€‚ ç°åœ¨æˆ‘ä»¬å‘undo_demoä¸­æ’å…¥ä¸¤æ¡è®°å½•ï¼š 12345BEGIN; # æ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå‡è®¾è¯¥äº‹åŠ¡çš„idä¸º100# æ’å…¥ä¸¤æ¡è®°å½•INSERT INTO undo_demo(id, key1, col) VALUES (1, &#x27;AWM&#x27;, &#x27;ç‹™å‡»æª&#x27;), (2, &#x27;M416&#x27;, &#x27;æ­¥æª&#x27;); å› ä¸ºè®°å½•çš„ä¸»é”®åªåŒ…å«ä¸€ä¸ªidåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¯¹åº”çš„undoæ—¥å¿—ä¸­åªéœ€è¦å°†å¾…æ’å…¥è®°å½•çš„idåˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´é•¿åº¦ï¼ˆidåˆ—çš„ç±»å‹ä¸ºINTï¼ŒINTç±»å‹å ç”¨çš„å­˜å‚¨ç©ºé—´é•¿åº¦ä¸º4ä¸ªå­—èŠ‚ï¼‰å’ŒçœŸå®å€¼è®°å½•ä¸‹æ¥ã€‚æœ¬ä¾‹ä¸­æ’å…¥äº†ä¸¤æ¡è®°å½•ï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿä¸¤æ¡ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—: ç¬¬ä¸€æ¡undoæ—¥å¿—çš„undo noä¸º0ï¼Œè®°å½•ä¸»é”®å ç”¨çš„å­˜å‚¨ç©ºé—´é•¿åº¦ä¸º4ï¼ŒçœŸå®å€¼ä¸º1ã€‚ç”»ä¸€ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š ç¬¬äºŒæ¡undoæ—¥å¿—çš„undo noä¸º1ï¼Œè®°å½•ä¸»é”®å ç”¨çš„å­˜å‚¨ç©ºé—´é•¿åº¦ä¸º4ï¼ŒçœŸå®å€¼ä¸º2ã€‚ç”»ä¸€ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼ˆä¸ç¬¬ä¸€æ¡undoæ—¥å¿—å¯¹æ¯”ï¼Œundo noå’Œä¸»é”®å„åˆ—ä¿¡æ¯æœ‰ä¸åŒï¼‰ï¼š ä¸ºäº†æœ€å¤§é™åº¦çš„èŠ‚çœundoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´ï¼Œå’Œæˆ‘ä»¬å‰è¾¹è¯´è¿‡çš„redoæ—¥å¿—ç±»ä¼¼ï¼ŒInnoDBä¼šç»™undoæ—¥å¿—ä¸­çš„æŸäº›å±æ€§è¿›è¡Œå‹ç¼©å¤„ç†ã€‚ â‘ roll_pointeréšè—åˆ—çš„å«ä¹‰roll_pointeræœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæŒ‡å‘è®°å½•å¯¹åº”çš„undoæ—¥å¿—çš„ä¸€ä¸ªæŒ‡é’ˆã€‚æ¯”æ–¹è¯´æˆ‘ä»¬ä¸Šè¾¹å‘undo_demoè¡¨é‡Œæ’å…¥äº†2æ¡è®°å½•ï¼Œæ¯æ¡è®°å½•éƒ½æœ‰ä¸å…¶å¯¹åº”çš„ä¸€æ¡undoæ—¥å¿—ã€‚è®°å½•è¢«å­˜å‚¨åˆ°äº†ç±»å‹ä¸ºFIL_PAGE_INDEXçš„é¡µé¢ä¸­ï¼ˆå°±æ˜¯æˆ‘ä»¬å‰è¾¹ä¸€ç›´æ‰€è¯´çš„æ•°æ®é¡µï¼‰ï¼Œundoæ—¥å¿—è¢«å­˜æ”¾åˆ°äº†ç±»å‹ä¸ºFIL_PAGE_UNDO_LOGçš„é¡µé¢ä¸­ã€‚æ•ˆæœå¦‚å›¾æ‰€ç¤ºï¼š **roll_pointer**æœ¬è´¨å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è®°å½•å¯¹åº”çš„undoæ—¥å¿—ã€‚ 3.2 DELETEæ“ä½œå¯¹åº”çš„undoæ—¥å¿—æ’å…¥åˆ°é¡µé¢ä¸­çš„è®°å½•ä¼šæ ¹æ®è®°å½•å¤´ä¿¡æ¯ä¸­çš„next_recordå±æ€§ç»„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªé“¾è¡¨ç§°ä¹‹ä¸ºæ­£å¸¸è®°å½•é“¾è¡¨ï¼›è¢«åˆ é™¤çš„è®°å½•å…¶å®ä¹Ÿä¼šæ ¹æ®è®°å½•å¤´ä¿¡æ¯ä¸­çš„next_recordå±æ€§ç»„æˆä¸€ä¸ªé“¾è¡¨ï¼Œåªä¸è¿‡è¿™ä¸ªé“¾è¡¨ä¸­çš„è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ï¼Œæ‰€ä»¥ä¹Ÿç§°è¿™ä¸ªé“¾è¡¨ä¸ºåƒåœ¾é“¾è¡¨ã€‚Page Headeréƒ¨åˆ†æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºPAGE_FREEçš„å±æ€§ï¼Œå®ƒæŒ‡å‘ç”±è¢«åˆ é™¤è®°å½•ç»„æˆçš„åƒåœ¾é“¾è¡¨ä¸­çš„å¤´èŠ‚ç‚¹ã€‚æˆ‘ä»¬å…ˆç”»ä¸€ä¸ªå›¾ï¼Œå‡è®¾æ­¤åˆ»æŸä¸ªé¡µé¢ä¸­çš„è®°å½•åˆ†å¸ƒæƒ…å†µæ˜¯è¿™æ ·çš„ï¼ˆè¿™ä¸ªä¸æ˜¯undo_demoè¡¨ä¸­çš„è®°å½•ï¼Œåªæ˜¯æˆ‘ä»¬éšä¾¿ä¸¾çš„ä¸€ä¸ªä¾‹å­ï¼‰ï¼š ä¸ºäº†çªå‡ºä¸»é¢˜ï¼Œåœ¨è¿™ä¸ªç®€åŒ–ç‰ˆçš„ç¤ºæ„å›¾ä¸­ï¼Œæˆ‘ä»¬åªæŠŠè®°å½•çš„delete_maskæ ‡å¿—ä½å±•ç¤ºäº†å‡ºæ¥ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ­£å¸¸è®°å½•é“¾è¡¨ä¸­åŒ…å«äº†3æ¡æ­£å¸¸è®°å½•ï¼Œåƒåœ¾é“¾è¡¨é‡ŒåŒ…å«äº†2æ¡å·²åˆ é™¤è®°å½•ï¼Œåœ¨åƒåœ¾é“¾è¡¨ä¸­çš„è¿™äº›è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ã€‚é¡µé¢çš„Page Headeréƒ¨åˆ†çš„PAGE_FREEå±æ€§çš„å€¼ä»£è¡¨æŒ‡å‘åƒåœ¾é“¾è¡¨å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚å‡è®¾ç°åœ¨æˆ‘ä»¬å‡†å¤‡ä½¿ç”¨DELETEè¯­å¥æŠŠæ­£å¸¸è®°å½•é“¾è¡¨ä¸­çš„æœ€åä¸€æ¡è®°å½•ç»™åˆ é™¤æ‰ï¼Œå…¶å®è¿™ä¸ªåˆ é™¤çš„è¿‡ç¨‹éœ€è¦ç»å†ä¸¤ä¸ªé˜¶æ®µï¼š é˜¶æ®µä¸€ï¼šä»…ä»…å°†è®°å½•çš„delete_maskæ ‡è¯†ä½è®¾ç½®ä¸º1ï¼Œå…¶ä»–çš„ä¸åšä¿®æ”¹ï¼ˆå…¶å®ä¼šä¿®æ”¹è®°å½•çš„trx_idã€roll_pointerè¿™äº›éšè—åˆ—çš„å€¼ï¼‰ã€‚è®¾è®¡InnoDBçš„å¤§å”æŠŠè¿™ä¸ªé˜¶æ®µç§°ä¹‹ä¸ºdelete markã€‚æŠŠè¿™ä¸ªè¿‡ç¨‹ç”»ä¸‹æ¥å°±æ˜¯è¿™æ ·ï¼šå¯ä»¥çœ‹åˆ°ï¼Œæ­£å¸¸è®°å½•é“¾è¡¨ä¸­çš„æœ€åä¸€æ¡è®°å½•çš„delete_maskå€¼è¢«è®¾ç½®ä¸º1ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¢«åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ã€‚ä¹Ÿå°±æ˜¯æ­¤æ—¶è®°å½•å¤„äºä¸€ä¸ªä¸­é—´çŠ¶æ€ã€‚åœ¨åˆ é™¤è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œè¢«åˆ é™¤çš„è®°å½•ä¸€ç›´éƒ½å¤„äºè¿™ç§æ‰€è°“çš„ä¸­é—´çŠ¶æ€ã€‚ ä¸ºå•¥ä¼šæœ‰è¿™ç§å¥‡æ€ªçš„ä¸­é—´çŠ¶æ€å‘¢ï¼Ÿå…¶å®ä¸»è¦æ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªç§°ä¹‹ä¸ºMVCCçš„åŠŸèƒ½ã€‚ é˜¶æ®µäºŒï¼šå½“è¯¥åˆ é™¤è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡æäº¤ä¹‹åï¼Œä¼šæœ‰ä¸“é—¨çš„çº¿ç¨‹åæ¥çœŸæ­£çš„æŠŠè®°å½•åˆ é™¤æ‰ã€‚æ‰€è°“çœŸæ­£çš„åˆ é™¤å°±æ˜¯æŠŠè¯¥è®°å½•ä»æ­£å¸¸è®°å½•é“¾è¡¨ä¸­ç§»é™¤ï¼Œå¹¶ä¸”åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­ï¼Œç„¶åè¿˜è¦è°ƒæ•´ä¸€äº›é¡µé¢çš„å…¶ä»–ä¿¡æ¯ï¼Œæ¯”å¦‚é¡µé¢ä¸­çš„ç”¨æˆ·è®°å½•æ•°é‡PAGE_N_RECSã€ä¸Šæ¬¡æ’å…¥è®°å½•çš„ä½ç½®PAGE_LAST_INSERTã€åƒåœ¾é“¾è¡¨å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆPAGE_FREEã€é¡µé¢ä¸­å¯é‡ç”¨çš„å­—èŠ‚æ•°é‡PAGE_GARBAGEã€è¿˜æœ‰é¡µç›®å½•çš„ä¸€äº›ä¿¡æ¯ç­‰ç­‰ã€‚InnoDBæŠŠè¿™ä¸ªé˜¶æ®µç§°ä¹‹ä¸ºpurgeã€‚æŠŠé˜¶æ®µäºŒæ‰§è¡Œå®Œäº†ï¼Œè¿™æ¡è®°å½•å°±ç®—æ˜¯çœŸæ­£çš„è¢«åˆ é™¤æ‰äº†ã€‚è¿™æ¡å·²åˆ é™¤è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´ä¹Ÿå¯ä»¥è¢«é‡æ–°åˆ©ç”¨äº†ã€‚ç”»ä¸‹æ¥å°±æ˜¯è¿™æ ·ï¼šå°†è¢«åˆ é™¤è®°å½•åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨æ—¶ï¼Œå®é™…ä¸ŠåŠ å…¥åˆ°é“¾è¡¨çš„å¤´èŠ‚ç‚¹å¤„ï¼Œä¼šè·Ÿç€ä¿®æ”¹PAGE_FREEå±æ€§çš„å€¼ã€‚ é¡µé¢çš„Page Headeréƒ¨åˆ†æœ‰ä¸€ä¸ªPAGE_GARBAGEå±æ€§ï¼Œè¯¥å±æ€§è®°å½•ç€å½“å‰é¡µé¢ä¸­å¯é‡ç”¨å­˜å‚¨ç©ºé—´å ç”¨çš„æ€»å­—èŠ‚æ•°ã€‚æ¯å½“æœ‰å·²åˆ é™¤è®°å½•è¢«åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨åï¼Œéƒ½ä¼šæŠŠè¿™ä¸ªPAGE_GARBAGEå±æ€§çš„å€¼åŠ ä¸Šè¯¥å·²åˆ é™¤è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ã€‚PAGE_FREEæŒ‡å‘åƒåœ¾é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œä¹‹åæ¯å½“æ–°æ’å…¥è®°å½•æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­PAGE_FREEæŒ‡å‘çš„å¤´èŠ‚ç‚¹ä»£è¡¨çš„å·²åˆ é™¤è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´æ˜¯å¦è¶³å¤Ÿå®¹çº³è¿™æ¡æ–°æ’å…¥çš„è®°å½•ï¼Œå¦‚æœä¸å¯ä»¥å®¹çº³ï¼Œå°±ç›´æ¥å‘é¡µé¢ä¸­ç”³è¯·æ–°çš„ç©ºé—´æ¥å­˜å‚¨è¿™æ¡è®°å½•ï¼ˆå¹¶ä¸ä¼šå°è¯•éå†æ•´ä¸ªåƒåœ¾é“¾è¡¨ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å®¹çº³æ–°è®°å½•çš„èŠ‚ç‚¹ï¼‰ã€‚å¦‚æœå¯ä»¥å®¹çº³ï¼Œé‚£ä¹ˆç›´æ¥é‡ç”¨è¿™æ¡å·²åˆ é™¤è®°å½•çš„å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”æŠŠPAGE_FREEæŒ‡å‘åƒåœ¾é“¾è¡¨ä¸­çš„ä¸‹ä¸€æ¡å·²åˆ é™¤è®°å½•ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ–°æ’å…¥çš„é‚£æ¡è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°å°äºåƒåœ¾é“¾è¡¨çš„å¤´èŠ‚ç‚¹å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œé‚£å°±æ„å‘³å¤´èŠ‚ç‚¹å¯¹åº”çš„è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´é‡Œæœ‰ä¸€éƒ¨åˆ†ç©ºé—´ç”¨ä¸åˆ°ï¼Œè¿™éƒ¨åˆ†ç©ºé—´å°±è¢«ç§°ä¹‹ä¸ºç¢ç‰‡ç©ºé—´ã€‚é‚£è¿™äº›ç¢ç‰‡ç©ºé—´å²‚ä¸æ˜¯æ°¸è¿œéƒ½ç”¨ä¸åˆ°äº†ä¹ˆï¼Ÿå…¶å®ä¹Ÿä¸æ˜¯ï¼Œè¿™äº›ç¢ç‰‡ç©ºé—´å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¼šè¢«ç»Ÿè®¡åˆ°PAGE_GARBAGEå±æ€§ä¸­ï¼Œè¿™äº›ç¢ç‰‡ç©ºé—´åœ¨æ•´ä¸ªé¡µé¢å¿«ä½¿ç”¨å®Œå‰å¹¶ä¸ä¼šè¢«é‡æ–°åˆ©ç”¨ï¼Œä¸è¿‡å½“é¡µé¢å¿«æ»¡æ—¶ï¼Œå¦‚æœå†æ’å…¥ä¸€æ¡è®°å½•ï¼Œæ­¤æ—¶é¡µé¢ä¸­å¹¶ä¸èƒ½åˆ†é…ä¸€æ¡å®Œæ•´è®°å½•çš„ç©ºé—´ï¼Œè¿™æ—¶å€™ä¼šé¦–å…ˆçœ‹ä¸€çœ‹PAGE_GARBAGEçš„ç©ºé—´å’Œå‰©ä½™å¯åˆ©ç”¨çš„ç©ºé—´åŠ èµ·æ¥æ˜¯ä¸æ˜¯å¯ä»¥å®¹çº³ä¸‹è¿™æ¡è®°å½•ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼ŒInnoDBä¼šå°è¯•é‡æ–°ç»„ç»‡é¡µå†…çš„è®°å½•ï¼Œé‡æ–°ç»„ç»‡çš„è¿‡ç¨‹å°±æ˜¯å…ˆå¼€è¾Ÿä¸€ä¸ªä¸´æ—¶é¡µé¢ï¼ŒæŠŠé¡µé¢å†…çš„è®°å½•ä¾æ¬¡æ’å…¥ä¸€éï¼Œå› ä¸ºä¾æ¬¡æ’å…¥æ—¶å¹¶ä¸ä¼šäº§ç”Ÿç¢ç‰‡ï¼Œä¹‹åå†æŠŠä¸´æ—¶é¡µé¢çš„å†…å®¹å¤åˆ¶åˆ°æœ¬é¡µé¢ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠé‚£äº›ç¢ç‰‡ç©ºé—´éƒ½è§£æ”¾å‡ºæ¥ï¼ˆå¾ˆæ˜¾ç„¶é‡æ–°ç»„ç»‡é¡µé¢å†…çš„è®°å½•æ¯”è¾ƒè€—è´¹æ€§èƒ½ï¼‰ã€‚ ä»ä¸Šè¾¹çš„æè¿°ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨åˆ é™¤è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œåªä¼šç»å†é˜¶æ®µä¸€ï¼Œä¹Ÿå°±æ˜¯delete marké˜¶æ®µï¼ˆæäº¤ä¹‹åæˆ‘ä»¬å°±ä¸ç”¨å›æ»šäº†ï¼Œæ‰€ä»¥åªéœ€è€ƒè™‘å¯¹åˆ é™¤æ“ä½œçš„é˜¶æ®µä¸€åšçš„å½±å“è¿›è¡Œå›æ»šï¼‰ã€‚InnoDBä¸ºæ­¤è®¾è®¡äº†ä¸€ç§ç§°ä¹‹ä¸ºTRX_UNDO_DEL_MARK_RECç±»å‹çš„undoæ—¥å¿—ï¼Œå®ƒçš„å®Œæ•´ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åœ¨å¯¹ä¸€æ¡è®°å½•è¿›è¡Œdelete markæ“ä½œå‰ï¼Œéœ€è¦æŠŠè¯¥è®°å½•çš„æ—§çš„trx_idå’Œroll_pointeréšè—åˆ—çš„å€¼éƒ½ç»™è®°åˆ°å¯¹åº”çš„undoæ—¥å¿—ä¸­æ¥ï¼Œå°±æ˜¯æˆ‘ä»¬å›¾ä¸­æ˜¾ç¤ºçš„old trx_idå’Œold roll_pointerå±æ€§ã€‚è¿™æ ·æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œé‚£å°±æ˜¯å¯ä»¥é€šè¿‡undoæ—¥å¿—çš„old roll_pointeræ‰¾åˆ°è®°å½•åœ¨ä¿®æ”¹ä¹‹å‰å¯¹åº”çš„undoæ—¥å¿—ã€‚æ¯”æ–¹è¯´åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæˆ‘ä»¬å…ˆæ’å…¥äº†ä¸€æ¡è®°å½•ï¼Œç„¶ååˆæ‰§è¡Œå¯¹è¯¥è®°å½•çš„åˆ é™¤æ“ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼šä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰§è¡Œå®Œdelete markæ“ä½œåï¼Œå®ƒå¯¹åº”çš„undoæ—¥å¿—å’ŒINSERTæ“ä½œå¯¹åº”çš„undoæ—¥å¿—å°±ä¸²æˆäº†ä¸€ä¸ªé“¾è¡¨ã€‚è¿™ä¸ªé“¾è¡¨å°±ç§°ä¹‹ä¸ºç‰ˆæœ¬é“¾ã€‚ ä¸ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ä¸åŒï¼Œç±»å‹ä¸ºTRX_UNDO_DEL_MARK_RECçš„undoæ—¥å¿—è¿˜å¤šäº†ä¸€ä¸ªç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæŸä¸ªåˆ—è¢«åŒ…å«åœ¨æŸä¸ªç´¢å¼•ä¸­ï¼Œé‚£ä¹ˆå®ƒçš„ç›¸å…³ä¿¡æ¯å°±åº”è¯¥è¢«è®°å½•åˆ°è¿™ä¸ªç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯éƒ¨åˆ†ï¼Œæ‰€è°“çš„ç›¸å…³ä¿¡æ¯åŒ…æ‹¬è¯¥åˆ—åœ¨è®°å½•ä¸­çš„ä½ç½®ï¼ˆç”¨posè¡¨ç¤ºï¼‰ï¼Œè¯¥åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼ˆç”¨lenè¡¨ç¤ºï¼‰ï¼Œè¯¥åˆ—å®é™…å€¼ï¼ˆç”¨valueè¡¨ç¤ºï¼‰ã€‚æ‰€ä»¥ç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯å­˜å‚¨çš„å†…å®¹å®è´¨ä¸Šå°±æ˜¯&lt;pos, len, value&gt;çš„ä¸€ä¸ªåˆ—è¡¨ã€‚è¿™éƒ¨åˆ†ä¿¡æ¯ä¸»è¦æ˜¯ç”¨åœ¨äº‹åŠ¡æäº¤åï¼Œå¯¹è¯¥ä¸­é—´çŠ¶æ€è®°å½•åšçœŸæ­£åˆ é™¤çš„é˜¶æ®µäºŒï¼Œä¹Ÿå°±æ˜¯purgeé˜¶æ®µä¸­ä½¿ç”¨çš„ã€‚ ç°åœ¨ç»§ç»­åœ¨ä¸Šè¾¹é‚£ä¸ªäº‹åŠ¡idä¸º100çš„äº‹åŠ¡ä¸­åˆ é™¤ä¸€æ¡è®°å½•ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠidä¸º1çš„é‚£æ¡è®°å½•åˆ é™¤æ‰ï¼š 12345678BEGIN; # æ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå‡è®¾è¯¥äº‹åŠ¡çš„idä¸º100# æ’å…¥ä¸¤æ¡è®°å½•INSERT INTO undo_demo(id, key1, col) VALUES (1, &#x27;AWM&#x27;, &#x27;ç‹™å‡»æª&#x27;), (2, &#x27;M416&#x27;, &#x27;æ­¥æª&#x27;); # åˆ é™¤ä¸€æ¡è®°å½• DELETE FROM undo_demo WHERE id = 1; è¿™ä¸ªdelete markæ“ä½œå¯¹åº”çš„undoæ—¥å¿—çš„ç»“æ„å°±æ˜¯è¿™æ ·ï¼š å¯¹ç…§ç€è¿™ä¸ªå›¾ï¼Œæˆ‘ä»¬å¾—æ³¨æ„ä¸‹è¾¹å‡ ç‚¹ï¼š å› ä¸ºè¿™æ¡undoæ—¥å¿—æ˜¯idä¸º100çš„äº‹åŠ¡ä¸­äº§ç”Ÿçš„ç¬¬3æ¡undoæ—¥å¿—ï¼Œæ‰€ä»¥å®ƒå¯¹åº”çš„undo noå°±æ˜¯2ã€‚ åœ¨å¯¹è®°å½•åšdelete markæ“ä½œæ—¶ï¼Œè®°å½•çš„trx_idéšè—åˆ—çš„å€¼æ˜¯100ï¼ˆä¹Ÿå°±æ˜¯è¯´å¯¹è¯¥è®°å½•æœ€è¿‘çš„ä¸€æ¬¡ä¿®æ”¹å°±å‘ç”Ÿåœ¨æœ¬äº‹åŠ¡ä¸­ï¼‰ï¼Œæ‰€ä»¥æŠŠ100å¡«å…¥old trx_idå±æ€§ä¸­ã€‚ç„¶åæŠŠè®°å½•çš„roll_pointeréšè—åˆ—çš„å€¼å–å‡ºæ¥ï¼Œå¡«å…¥old roll_pointerå±æ€§ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡old roll_pointerå±æ€§å€¼æ‰¾åˆ°æœ€è¿‘ä¸€æ¬¡å¯¹è¯¥è®°å½•åšæ”¹åŠ¨æ—¶äº§ç”Ÿçš„undoæ—¥å¿—ã€‚ ç”±äºundo_demoè¡¨ä¸­æœ‰2ä¸ªç´¢å¼•ï¼šä¸€ä¸ªæ˜¯èšç°‡ç´¢å¼•ï¼Œä¸€ä¸ªæ˜¯äºŒçº§ç´¢å¼•idx_key1ã€‚åªè¦æ˜¯åŒ…å«åœ¨ç´¢å¼•ä¸­çš„åˆ—ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ—åœ¨è®°å½•ä¸­çš„ä½ç½®ï¼ˆposï¼‰ï¼Œå ç”¨å­˜å‚¨ç©ºé—´å¤§å°ï¼ˆlenï¼‰å’Œå®é™…å€¼ï¼ˆvalueï¼‰å°±éœ€è¦å­˜å‚¨åˆ°undoæ—¥å¿—ä¸­ã€‚ å¯¹äºä¸»é”®æ¥è¯´ï¼ŒåªåŒ…å«ä¸€ä¸ªidåˆ—ï¼Œå­˜å‚¨åˆ°undoæ—¥å¿—ä¸­çš„ç›¸å…³ä¿¡æ¯åˆ†åˆ«æ˜¯ï¼š posï¼šidåˆ—æ˜¯ä¸»é”®ï¼Œä¹Ÿå°±æ˜¯åœ¨è®°å½•çš„ç¬¬ä¸€ä¸ªåˆ—ï¼Œå®ƒå¯¹åº”çš„poså€¼ä¸º0ã€‚poså ç”¨1ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ lenï¼šidåˆ—çš„ç±»å‹ä¸ºINTï¼Œå ç”¨4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥lençš„å€¼ä¸º4ã€‚lenå ç”¨1ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ valueï¼šåœ¨è¢«åˆ é™¤çš„è®°å½•ä¸­idåˆ—çš„å€¼ä¸º1ï¼Œä¹Ÿå°±æ˜¯valueçš„å€¼ä¸º1ã€‚valueå ç”¨4ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ ç”»ä¸€ä¸ªå›¾æ¼”ç¤ºä¸€ä¸‹å°±æ˜¯è¿™æ ·ï¼š æ‰€ä»¥å¯¹äºidåˆ—æ¥è¯´ï¼Œæœ€ç»ˆå­˜å‚¨çš„ç»“æœå°±æ˜¯&lt;0, 4, 1&gt;ï¼Œå­˜å‚¨è¿™äº›ä¿¡æ¯å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¸º1 + 1 + 4 = 6ä¸ªå­—èŠ‚ã€‚ å¯¹äºidx_key1æ¥è¯´ï¼ŒåªåŒ…å«ä¸€ä¸ªkey1åˆ—ï¼Œå­˜å‚¨åˆ°undoæ—¥å¿—ä¸­çš„ç›¸å…³ä¿¡æ¯åˆ†åˆ«æ˜¯ï¼š posï¼škey1åˆ—æ˜¯æ’åœ¨idåˆ—ã€trx_idåˆ—ã€roll_pointeråˆ—ä¹‹åçš„ï¼Œå®ƒå¯¹åº”çš„poså€¼ä¸º3ã€‚poså ç”¨1ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ lenï¼škey1åˆ—çš„ç±»å‹ä¸ºVARCHAR(100)ï¼Œä½¿ç”¨utf8å­—ç¬¦é›†ï¼Œè¢«åˆ é™¤çš„è®°å½•å®é™…å­˜å‚¨çš„å†…å®¹æ˜¯AWMï¼Œæ‰€ä»¥ä¸€å…±å ç”¨3ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æ‰€ä»¥lençš„å€¼ä¸º3ã€‚lenå ç”¨1ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ valueï¼šåœ¨è¢«åˆ é™¤çš„è®°å½•ä¸­key1åˆ—çš„å€¼ä¸ºAWMï¼Œä¹Ÿå°±æ˜¯valueçš„å€¼ä¸ºAWMã€‚valueå ç”¨3ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ ç”»ä¸€ä¸ªå›¾æ¼”ç¤ºä¸€ä¸‹å°±æ˜¯è¿™æ ·ï¼š æ‰€ä»¥å¯¹äºkey1åˆ—æ¥è¯´ï¼Œæœ€ç»ˆå­˜å‚¨çš„ç»“æœå°±æ˜¯&lt;3, 3, &#39;AWM&#39;&gt;ï¼Œå­˜å‚¨è¿™äº›ä¿¡æ¯å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¸º1 + 1 + 3 = 5ä¸ªå­—èŠ‚ã€‚ä»ä¸Šè¾¹çš„å™è¿°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ&lt;0, 4, 1&gt;å’Œ&lt;3, 3, &#39;AWM&#39;&gt;å…±å ç”¨11ä¸ªå­—èŠ‚ã€‚ç„¶åindex_col_info lenæœ¬èº«å ç”¨2ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åŠ èµ·æ¥ä¸€å…±å ç”¨13ä¸ªå­—èŠ‚ï¼ŒæŠŠæ•°å­—13å°±å¡«åˆ°äº†index_col_info lençš„å±æ€§ä¸­ã€‚ 3.3 UPDATEæ“ä½œå¯¹åº”çš„undoæ—¥å¿—åœ¨æ‰§è¡ŒUPDATEè¯­å¥æ—¶ï¼ŒInnoDBå¯¹æ›´æ–°ä¸»é”®å’Œä¸æ›´æ–°ä¸»é”®è¿™ä¸¤ç§æƒ…å†µæœ‰æˆªç„¶ä¸åŒçš„å¤„ç†æ–¹æ¡ˆã€‚ â‘ ä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µåœ¨ä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µä¸‹ï¼Œåˆå¯ä»¥ç»†åˆ†ä¸ºè¢«æ›´æ–°çš„åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´ä¸å‘ç”Ÿå˜åŒ–å’Œå‘ç”Ÿå˜åŒ–çš„æƒ…å†µã€‚ å°±åœ°æ›´æ–°ï¼ˆin-place updateï¼‰æ›´æ–°è®°å½•æ—¶ï¼Œå¯¹äºè¢«æ›´æ–°çš„æ¯ä¸ªåˆ—æ¥è¯´ï¼Œå¦‚æœæ›´æ–°åçš„åˆ—å’Œæ›´æ–°å‰çš„åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´éƒ½ä¸€æ ·å¤§ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›è¡Œå°±åœ°æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨åŸè®°å½•çš„åŸºç¡€ä¸Šä¿®æ”¹å¯¹åº”åˆ—çš„å€¼ã€‚ å…ˆåˆ é™¤æ‰æ—§è®°å½•ï¼Œå†æ’å…¥æ–°è®°å½•åœ¨ä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªè¢«æ›´æ–°çš„åˆ—æ›´æ–°å‰å’Œæ›´æ–°åå ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±éœ€è¦å…ˆæŠŠè¿™æ¡æ—§çš„è®°å½•ä»èšç°‡ç´¢å¼•é¡µé¢ä¸­åˆ é™¤æ‰ï¼Œç„¶åå†æ ¹æ®æ›´æ–°ååˆ—çš„å€¼åˆ›å»ºä¸€æ¡æ–°çš„è®°å½•æ’å…¥åˆ°é¡µé¢ä¸­ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ‰€è¯´çš„åˆ é™¤å¹¶ä¸æ˜¯delete markæ“ä½œï¼Œè€Œæ˜¯çœŸæ­£çš„åˆ é™¤æ‰ï¼Œä¹Ÿå°±æ˜¯æŠŠè¿™æ¡è®°å½•ä»æ­£å¸¸è®°å½•é“¾è¡¨ä¸­ç§»é™¤å¹¶åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­ï¼Œå¹¶ä¸”ä¿®æ”¹é¡µé¢ä¸­ç›¸åº”çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¯”å¦‚PAGE_FREEã€PAGE_GARBAGEç­‰è¿™äº›ä¿¡æ¯ï¼‰ã€‚ä¸è¿‡è¿™é‡ŒåšçœŸæ­£åˆ é™¤æ“ä½œçš„çº¿ç¨‹å¹¶ä¸æ˜¯åœ¨DELETEè¯­å¥ä¸­åšpurgeæ“ä½œæ—¶ä½¿ç”¨çš„å¦å¤–ä¸“é—¨çš„çº¿ç¨‹ï¼Œè€Œæ˜¯ç”±ç”¨æˆ·çº¿ç¨‹åŒæ­¥æ‰§è¡ŒçœŸæ­£çš„åˆ é™¤æ“ä½œï¼ŒçœŸæ­£åˆ é™¤ä¹‹åç´§æ¥ç€å°±è¦æ ¹æ®å„ä¸ªåˆ—æ›´æ–°åçš„å€¼åˆ›å»ºçš„æ–°è®°å½•æ’å…¥ã€‚è¿™é‡Œå¦‚æœæ–°åˆ›å»ºçš„è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¸è¶…è¿‡æ—§è®°å½•å ç”¨çš„ç©ºé—´ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥é‡ç”¨è¢«åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­çš„æ—§è®°å½•æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´ï¼Œå¦åˆ™çš„è¯éœ€è¦åœ¨é¡µé¢ä¸­æ–°ç”³è¯·ä¸€æ®µç©ºé—´ä»¥ä¾›æ–°è®°å½•ä½¿ç”¨ï¼Œå¦‚æœæœ¬é¡µé¢å†…å·²ç»æ²¡æœ‰å¯ç”¨çš„ç©ºé—´çš„è¯ï¼Œé‚£å°±éœ€è¦è¿›è¡Œé¡µé¢åˆ†è£‚æ“ä½œï¼Œç„¶åå†æ’å…¥æ–°è®°å½•ã€‚ é’ˆå¯¹UPDATEä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µï¼ˆåŒ…æ‹¬ä¸Šè¾¹æ‰€è¯´çš„å°±åœ°æ›´æ–°å’Œå…ˆåˆ é™¤æ—§è®°å½•å†æ’å…¥æ–°è®°å½•ï¼‰ï¼ŒInnoDBè®¾è®¡äº†ä¸€ç§ç±»å‹ä¸ºTRX_UNDO_UPD_EXIST_RECçš„undoæ—¥å¿—`ï¼Œå®ƒçš„å®Œæ•´ç»“æ„å¦‚ä¸‹ï¼š å…¶å®å¤§éƒ¨åˆ†å±æ€§å’Œæˆ‘ä»¬ä»‹ç»è¿‡çš„TRX_UNDO_DEL_MARK_RECç±»å‹çš„undoæ—¥å¿—æ˜¯ç±»ä¼¼çš„ï¼Œä¸è¿‡è¿˜æ˜¯è¦æ³¨æ„è¿™ä¹ˆå‡ ç‚¹ï¼š n_updatedå±æ€§è¡¨ç¤ºæœ¬æ¡UPDATEè¯­å¥æ‰§è¡Œåå°†æœ‰å‡ ä¸ªåˆ—è¢«æ›´æ–°ï¼Œåè¾¹è·Ÿç€çš„&lt;pos, old_len, old_value&gt;åˆ†åˆ«è¡¨ç¤ºè¢«æ›´æ–°åˆ—åœ¨è®°å½•ä¸­çš„ä½ç½®ã€æ›´æ–°å‰è¯¥åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ã€æ›´æ–°å‰è¯¥åˆ—çš„çœŸå®å€¼ã€‚ å¦‚æœåœ¨UPDATEè¯­å¥ä¸­æ›´æ–°çš„åˆ—åŒ…å«ç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆä¹Ÿä¼šæ·»åŠ ç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯è¿™ä¸ªéƒ¨åˆ†ï¼Œå¦åˆ™çš„è¯æ˜¯ä¸ä¼šæ·»åŠ è¿™ä¸ªéƒ¨åˆ†çš„ã€‚ ç°åœ¨ç»§ç»­åœ¨ä¸Šè¾¹é‚£ä¸ªäº‹åŠ¡idä¸º100çš„äº‹åŠ¡ä¸­æ›´æ–°ä¸€æ¡è®°å½•ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠidä¸º2çš„é‚£æ¡è®°å½•æ›´æ–°ä¸€ä¸‹ï¼š 12345678910111213BEGIN; # æ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå‡è®¾è¯¥äº‹åŠ¡çš„idä¸º100# æ’å…¥ä¸¤æ¡è®°å½•INSERT INTO undo_demo(id, key1, col) VALUES (1, &#x27;AWM&#x27;, &#x27;ç‹™å‡»æª&#x27;), (2, &#x27;M416&#x27;, &#x27;æ­¥æª&#x27;); # åˆ é™¤ä¸€æ¡è®°å½• DELETE FROM undo_demo WHERE id = 1; # æ›´æ–°ä¸€æ¡è®°å½•UPDATE undo_demo SET key1 = &#x27;M249&#x27;, col = &#x27;æœºæª&#x27; WHERE id = 2; è¿™ä¸ªUPDATEè¯­å¥æ›´æ–°çš„åˆ—å¤§å°éƒ½æ²¡æœ‰æ”¹åŠ¨ï¼Œæ‰€ä»¥å¯ä»¥é‡‡ç”¨å°±åœ°æ›´æ–°çš„æ–¹å¼æ¥æ‰§è¡Œï¼Œåœ¨çœŸæ­£æ”¹åŠ¨é¡µé¢è®°å½•æ—¶ï¼Œä¼šå…ˆè®°å½•ä¸€æ¡ç±»å‹ä¸ºTRX_UNDO_UPD_EXIST_RECçš„undoæ—¥å¿—ï¼Œé•¿è¿™æ ·ï¼š å¯¹ç…§ç€è¿™ä¸ªå›¾æˆ‘ä»¬æ³¨æ„ä¸€ä¸‹è¿™å‡ ä¸ªåœ°æ–¹ï¼š å› ä¸ºè¿™æ¡undoæ—¥å¿—æ˜¯idä¸º100çš„äº‹åŠ¡ä¸­äº§ç”Ÿçš„ç¬¬4æ¡undoæ—¥å¿—ï¼Œæ‰€ä»¥å®ƒå¯¹åº”çš„undo noå°±æ˜¯3ã€‚ è¿™æ¡æ—¥å¿—çš„roll_pointeræŒ‡å‘undo noä¸º1çš„é‚£æ¡æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯æ’å…¥ä¸»é”®å€¼ä¸º2çš„è®°å½•æ—¶äº§ç”Ÿçš„é‚£æ¡undoæ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯æœ€è¿‘ä¸€æ¬¡å¯¹è¯¥è®°å½•åšæ”¹åŠ¨æ—¶äº§ç”Ÿçš„undoæ—¥å¿—ã€‚ ç”±äºæœ¬æ¡UPDATEè¯­å¥ä¸­æ›´æ–°äº†ç´¢å¼•åˆ—key1çš„å€¼ï¼Œæ‰€ä»¥éœ€è¦è®°å½•ä¸€ä¸‹ç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸»é”®å’Œkey1åˆ—æ›´æ–°å‰çš„ä¿¡æ¯å¡«å…¥ã€‚ â‘¡æ›´æ–°ä¸»é”®çš„æƒ…å†µåœ¨èšç°‡ç´¢å¼•ä¸­ï¼Œè®°å½•æ˜¯æŒ‰ç…§ä¸»é”®å€¼çš„å¤§å°è¿æˆäº†ä¸€ä¸ªå•å‘é“¾è¡¨çš„ï¼Œå¦‚æœæˆ‘ä»¬æ›´æ–°äº†æŸæ¡è®°å½•çš„ä¸»é”®å€¼ï¼Œæ„å‘³ç€è¿™æ¡è®°å½•åœ¨èšç°‡ç´¢å¼•ä¸­çš„ä½ç½®å°†ä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ¯”å¦‚ä½ å°†è®°å½•çš„ä¸»é”®å€¼ä»1æ›´æ–°ä¸º10000ï¼Œå¦‚æœè¿˜æœ‰éå¸¸å¤šçš„è®°å½•çš„ä¸»é”®å€¼åˆ†å¸ƒåœ¨1 ~ 10000ä¹‹é—´çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸¤æ¡è®°å½•åœ¨èšç°‡ç´¢å¼•ä¸­å°±æœ‰å¯èƒ½ç¦»å¾—éå¸¸è¿œï¼Œç”šè‡³ä¸­é—´éš”äº†å¥½å¤šä¸ªé¡µé¢ã€‚é’ˆå¯¹UPDATEè¯­å¥ä¸­æ›´æ–°äº†è®°å½•ä¸»é”®å€¼çš„è¿™ç§æƒ…å†µï¼ŒInnoDBåœ¨èšç°‡ç´¢å¼•ä¸­åˆ†äº†ä¸¤æ­¥å¤„ç†ï¼š å°†æ—§è®°å½•è¿›è¡Œdelete markæ“ä½œé«˜èƒ½æ³¨æ„ï¼šè¿™é‡Œæ˜¯delete markæ“ä½œï¼è¿™é‡Œæ˜¯delete markæ“ä½œï¼è¿™é‡Œæ˜¯delete markæ“ä½œï¼ä¹Ÿå°±æ˜¯è¯´åœ¨UPDATEè¯­å¥æ‰€åœ¨çš„äº‹åŠ¡æäº¤å‰ï¼Œå¯¹æ—§è®°å½•åªåšä¸€ä¸ªdelete markæ“ä½œï¼Œåœ¨äº‹åŠ¡æäº¤åæ‰ç”±ä¸“é—¨çš„çº¿ç¨‹åšpurgeæ“ä½œï¼ŒæŠŠå®ƒåŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­ã€‚ ä¹‹æ‰€ä»¥åªå¯¹æ—§è®°å½•åšdelete markæ“ä½œï¼Œæ˜¯å› ä¸ºåˆ«çš„äº‹åŠ¡åŒæ—¶ä¹Ÿå¯èƒ½è®¿é—®è¿™æ¡è®°å½•ï¼Œå¦‚æœæŠŠå®ƒçœŸæ­£çš„åˆ é™¤åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨åï¼Œåˆ«çš„äº‹åŠ¡å°±è®¿é—®ä¸åˆ°äº†ã€‚è¿™ä¸ªåŠŸèƒ½å°±æ˜¯æ‰€è°“çš„MVCCã€‚ æ ¹æ®æ›´æ–°åå„åˆ—çš„å€¼åˆ›å»ºä¸€æ¡æ–°è®°å½•ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°èšç°‡ç´¢å¼•ä¸­ï¼ˆéœ€é‡æ–°å®šä½æ’å…¥çš„ä½ç½®ï¼‰ã€‚ç”±äºæ›´æ–°åçš„è®°å½•ä¸»é”®å€¼å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ä»èšç°‡ç´¢å¼•ä¸­å®šä½è¿™æ¡è®°å½•æ‰€åœ¨çš„ä½ç½®ï¼Œç„¶åæŠŠå®ƒæ’è¿›å»ã€‚ é’ˆå¯¹UPDATEè¯­å¥æ›´æ–°è®°å½•ä¸»é”®å€¼çš„è¿™ç§æƒ…å†µï¼Œåœ¨å¯¹è¯¥è®°å½•è¿›è¡Œdelete markæ“ä½œå‰ï¼Œä¼šè®°å½•ä¸€æ¡ç±»å‹ä¸ºTRX_UNDO_DEL_MARK_RECçš„undoæ—¥å¿—ï¼›ä¹‹åæ’å…¥æ–°è®°å½•æ—¶ï¼Œä¼šè®°å½•ä¸€æ¡ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯å¯¹ä¸€æ¡è®°å½•çš„ä¸»é”®å€¼åšæ”¹åŠ¨æ—¶ï¼Œä¼šè®°å½•2æ¡undoæ—¥å¿—ã€‚ 4.é€šç”¨é“¾è¡¨ç»“æ„åœ¨å†™å…¥undoæ—¥å¿—çš„è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨åˆ°å¤šä¸ªé“¾è¡¨ï¼Œå¾ˆå¤šé“¾è¡¨éƒ½æœ‰åŒæ ·çš„èŠ‚ç‚¹ç»“æ„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š åœ¨æŸä¸ªè¡¨ç©ºé—´å†…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªé¡µçš„é¡µå·å’Œåœ¨é¡µå†…çš„åç§»é‡æ¥å”¯ä¸€å®šä½ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ï¼Œè¿™ä¸¤ä¸ªä¿¡æ¯ä¹Ÿå°±ç›¸å½“äºæŒ‡å‘è¿™ä¸ªèŠ‚ç‚¹çš„ä¸€ä¸ªæŒ‡é’ˆã€‚æ‰€ä»¥ï¼š Pre Node Page Numberå’ŒPre Node Offsetçš„ç»„åˆå°±æ˜¯æŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ Next Node Page Numberå’ŒNext Node Offsetçš„ç»„åˆå°±æ˜¯æŒ‡å‘åä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚ æ•´ä¸ªList Nodeå ç”¨12ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚ ä¸ºäº†æ›´å¥½çš„ç®¡ç†é“¾è¡¨ï¼ŒInnoDBè¿˜æå‡ºäº†ä¸€ä¸ªåŸºèŠ‚ç‚¹çš„ç»“æ„ï¼Œé‡Œè¾¹å­˜å‚¨äº†è¿™ä¸ªé“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€å°¾èŠ‚ç‚¹ä»¥åŠé“¾è¡¨é•¿åº¦ä¿¡æ¯ï¼ŒåŸºèŠ‚ç‚¹çš„ç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š å…¶ä¸­ï¼š List Lengthè¡¨æ˜è¯¥é“¾è¡¨ä¸€å…±æœ‰å¤šå°‘èŠ‚ç‚¹ã€‚ First Node Page Numberå’ŒFirst Node Offsetçš„ç»„åˆå°±æ˜¯æŒ‡å‘é“¾è¡¨å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚ Last Node Page Numberå’ŒLast Node Offsetçš„ç»„åˆå°±æ˜¯æŒ‡å‘é“¾è¡¨å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚ æ•´ä¸ªList Base Nodeå ç”¨16ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚ æ‰€ä»¥ä½¿ç”¨List Base Nodeå’ŒList Nodeè¿™ä¸¤ä¸ªç»“æ„ç»„æˆçš„é“¾è¡¨çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š 5.FIL_PAGE_UNDO_LOGé¡µé¢è¡¨ç©ºé—´å…¶å®æ˜¯ç”±è®¸è®¸å¤šå¤šçš„é¡µé¢æ„æˆçš„ï¼Œé¡µé¢é»˜è®¤å¤§å°ä¸º16KBã€‚è¿™äº›é¡µé¢æœ‰ä¸åŒçš„ç±»å‹ï¼Œæ¯”å¦‚ç±»å‹ä¸ºFIL_PAGE_INDEXçš„é¡µé¢ç”¨äºå­˜å‚¨èšç°‡ç´¢å¼•ä»¥åŠäºŒçº§ç´¢å¼•ï¼Œç±»å‹ä¸ºFIL_PAGE_TYPE_FSP_HDRçš„é¡µé¢ç”¨äºå­˜å‚¨è¡¨ç©ºé—´å¤´éƒ¨ä¿¡æ¯çš„ï¼Œè¿˜æœ‰å…¶ä»–å„ç§ç±»å‹çš„é¡µé¢ï¼Œå…¶ä¸­æœ‰ä¸€ç§ç§°ä¹‹ä¸ºFIL_PAGE_UNDO_LOGç±»å‹çš„é¡µé¢æ˜¯ä¸“é—¨ç”¨æ¥å­˜å‚¨undoæ—¥å¿—çš„ï¼Œè¿™ç§ç±»å‹çš„é¡µé¢çš„é€šç”¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆä»¥é»˜è®¤çš„16KBå¤§å°ä¸ºä¾‹ï¼‰ï¼š æˆ‘ä»¬å°±ç®€ç§°ä¸ºUndoé¡µé¢ï¼Œä¸Šå›¾ä¸­çš„File Headerå’ŒFile Traileræ˜¯å„ç§é¡µé¢éƒ½æœ‰çš„é€šç”¨ç»“æ„ã€‚Undo Page Headeræ˜¯Undoé¡µé¢æ‰€ç‰¹æœ‰çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼š å…¶ä¸­å„ä¸ªå±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š TRX_UNDO_PAGE_TYPEï¼šæœ¬é¡µé¢å‡†å¤‡å­˜å‚¨ä»€ä¹ˆç§ç±»çš„undoæ—¥å¿—ã€‚å‰è¾¹ä»‹ç»äº†å¥½å‡ ç§ç±»å‹çš„undoæ—¥å¿—ï¼Œå®ƒä»¬å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼š TRX_UNDO_INSERTï¼ˆä½¿ç”¨åè¿›åˆ¶1è¡¨ç¤ºï¼‰ï¼šç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—å±äºæ­¤å¤§ç±»ï¼Œä¸€èˆ¬ç”±INSERTè¯­å¥äº§ç”Ÿï¼Œæˆ–è€…åœ¨UPDATEè¯­å¥ä¸­æœ‰æ›´æ–°ä¸»é”®çš„æƒ…å†µä¹Ÿä¼šäº§ç”Ÿæ­¤ç±»å‹çš„undoæ—¥å¿—ã€‚ TRX_UNDO_UPDATEï¼ˆä½¿ç”¨åè¿›åˆ¶2è¡¨ç¤ºï¼‰ï¼Œé™¤äº†ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œå…¶ä»–ç±»å‹çš„undoæ—¥å¿—éƒ½å±äºè¿™ä¸ªå¤§ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬å‰è¾¹è¯´çš„TRX_UNDO_DEL_MARK_RECã€TRX_UNDO_UPD_EXIST_RECå•¥çš„ï¼Œä¸€èˆ¬ç”±DELETEã€UPDATEè¯­å¥äº§ç”Ÿçš„undoæ—¥å¿—å±äºè¿™ä¸ªå¤§ç±»ã€‚ è¿™ä¸ªTRX_UNDO_PAGE_TYPEå±æ€§å¯é€‰çš„å€¼å°±æ˜¯ä¸Šè¾¹çš„ä¸¤ä¸ªï¼Œç”¨æ¥æ ‡è®°æœ¬é¡µé¢ç”¨äºå­˜å‚¨å“ªä¸ªå¤§ç±»çš„undoæ—¥å¿—ï¼Œä¸åŒå¤§ç±»çš„undoæ—¥å¿—ä¸èƒ½æ··ç€å­˜å‚¨ï¼Œæ¯”å¦‚ä¸€ä¸ªUndoé¡µé¢çš„TRX_UNDO_PAGE_TYPEå±æ€§å€¼ä¸ºTRX_UNDO_INSERTï¼Œé‚£ä¹ˆè¿™ä¸ªé¡µé¢å°±åªèƒ½å­˜å‚¨ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œå…¶ä»–ç±»å‹çš„undoæ—¥å¿—å°±ä¸èƒ½æ”¾åˆ°è¿™ä¸ªé¡µé¢ä¸­äº†ã€‚ ä¹‹æ‰€ä»¥æŠŠundoæ—¥å¿—åˆ†æˆä¸¤ä¸ªå¤§ç±»ï¼Œæ˜¯å› ä¸ºç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—åœ¨äº‹åŠ¡æäº¤åå¯ä»¥ç›´æ¥åˆ é™¤æ‰ï¼Œè€Œå…¶ä»–ç±»å‹çš„undoæ—¥å¿—è¿˜éœ€è¦ä¸ºæ‰€è°“çš„MVCCæœåŠ¡ï¼Œä¸èƒ½ç›´æ¥åˆ é™¤æ‰ï¼Œå¯¹å®ƒä»¬çš„å¤„ç†éœ€è¦åŒºåˆ«å¯¹å¾…ã€‚ TRX_UNDO_PAGE_STARTï¼šè¡¨ç¤ºåœ¨å½“å‰é¡µé¢ä¸­æ˜¯ä»ä»€ä¹ˆä½ç½®å¼€å§‹å­˜å‚¨undoæ—¥å¿—çš„ï¼Œæˆ–è€…è¯´è¡¨ç¤ºç¬¬ä¸€æ¡undoæ—¥å¿—åœ¨æœ¬é¡µé¢ä¸­çš„èµ·å§‹åç§»é‡ã€‚ TRX_UNDO_PAGE_FREEï¼šä¸ä¸Šè¾¹çš„TRX_UNDO_PAGE_STARTå¯¹åº”ï¼Œè¡¨ç¤ºå½“å‰é¡µé¢ä¸­å­˜å‚¨çš„æœ€åä¸€æ¡undoæ—¥å¿—ç»“æŸæ—¶çš„åç§»é‡ï¼Œæˆ–è€…è¯´ä»è¿™ä¸ªä½ç½®å¼€å§‹ï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ–°çš„undoæ—¥å¿—ã€‚å‡è®¾ç°åœ¨å‘é¡µé¢ä¸­å†™å…¥äº†3æ¡undoæ—¥å¿—ï¼Œé‚£ä¹ˆTRX_UNDO_PAGE_STARTå’ŒTRX_UNDO_PAGE_FREEçš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼šå½“ç„¶ï¼Œåœ¨æœ€åˆä¸€æ¡undoæ—¥å¿—ä¹Ÿæ²¡å†™å…¥çš„æƒ…å†µä¸‹ï¼ŒTRX_UNDO_PAGE_STARTå’ŒTRX_UNDO_PAGE_FREEçš„å€¼æ˜¯ç›¸åŒçš„ã€‚ TRX_UNDO_PAGE_NODEï¼šä»£è¡¨ä¸€ä¸ªList Nodeç»“æ„ï¼ˆé“¾è¡¨çš„æ™®é€šèŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä¸Šè¾¹åˆšè¯´çš„ï¼‰ã€‚ 6.Undoé¡µé¢é“¾è¡¨6.1å•ä¸ªäº‹åŠ¡ä¸­çš„Undoé¡µé¢é“¾è¡¨å› ä¸ºä¸€ä¸ªäº‹åŠ¡å¯èƒ½åŒ…å«å¤šä¸ªè¯­å¥ï¼Œè€Œä¸”ä¸€ä¸ªè¯­å¥å¯èƒ½å¯¹è‹¥å¹²æ¡è®°å½•è¿›è¡Œæ”¹åŠ¨ï¼Œè€Œå¯¹æ¯æ¡è®°å½•è¿›è¡Œæ”¹åŠ¨å‰ï¼Œéƒ½éœ€è¦è®°å½•1æ¡æˆ–2æ¡çš„undoæ—¥å¿—ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿå¾ˆå¤šundoæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—å¯èƒ½ä¸€ä¸ªé¡µé¢æ”¾ä¸ä¸‹ï¼Œéœ€è¦æ”¾åˆ°å¤šä¸ªé¡µé¢ä¸­ï¼Œè¿™äº›é¡µé¢å°±é€šè¿‡æˆ‘ä»¬ä¸Šè¾¹ä»‹ç»çš„TRX_UNDO_PAGE_NODEå±æ€§è¿æˆäº†é“¾è¡¨ï¼š æˆ‘ç‰¹æ„æŠŠé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªUndoé¡µé¢ç»™æ ‡äº†å‡ºæ¥ï¼Œç§°å®ƒä¸ºfirst undo pageï¼Œå…¶ä½™çš„Undoé¡µé¢ç§°ä¹‹ä¸ºnormal undo pageï¼Œè¿™æ˜¯å› ä¸ºåœ¨first undo pageä¸­é™¤äº†è®°å½•Undo Page Headerä¹‹å¤–ï¼Œè¿˜ä¼šè®°å½•å…¶ä»–çš„ä¸€äº›ç®¡ç†ä¿¡æ¯ã€‚ åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ··ç€æ‰§è¡ŒINSERTã€DELETEã€UPDATEè¯­å¥ï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šäº§ç”Ÿä¸åŒç±»å‹çš„undoæ—¥å¿—ã€‚ä½†æ˜¯ï¼ŒåŒä¸€ä¸ªUndoé¡µé¢è¦ä¹ˆåªå­˜å‚¨TRX_UNDO_INSERTå¤§ç±»çš„undoæ—¥å¿—ï¼Œè¦ä¹ˆåªå­˜å‚¨TRX_UNDO_UPDATEå¤§ç±»çš„undoæ—¥å¿—ï¼Œåæ­£ä¸èƒ½æ··ç€å­˜ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å°±å¯èƒ½éœ€è¦2ä¸ªUndoé¡µé¢çš„é“¾è¡¨ï¼Œä¸€ä¸ªç§°ä¹‹ä¸ºinsert undoé“¾è¡¨ï¼Œå¦ä¸€ä¸ªç§°ä¹‹ä¸ºupdate undoé“¾è¡¨ï¼Œç”»ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š å¦å¤–ï¼ŒInnoDBè§„å®šå¯¹æ™®é€šè¡¨å’Œä¸´æ—¶è¡¨çš„è®°å½•æ”¹åŠ¨æ—¶äº§ç”Ÿçš„undoæ—¥å¿—è¦åˆ†åˆ«è®°å½•ï¼ˆæˆ‘ä»¬ç¨åé˜é‡Šä¸ºå•¥è¿™ä¹ˆåšï¼‰ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æœ€å¤šæœ‰4ä¸ªä»¥Undoé¡µé¢ä¸ºèŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ï¼š å½“ç„¶ï¼Œå¹¶ä¸æ˜¯åœ¨äº‹åŠ¡ä¸€å¼€å§‹å°±ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…è¿™4ä¸ªé“¾è¡¨ï¼Œå…·ä½“åˆ†é…ç­–ç•¥å¦‚ä¸‹ï¼š åˆšåˆšå¼€å¯äº‹åŠ¡æ—¶ï¼Œä¸€ä¸ªUndoé¡µé¢é“¾è¡¨ä¹Ÿä¸åˆ†é…ã€‚ å½“äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘æ™®é€šè¡¨ä¸­æ’å…¥è®°å½•æˆ–è€…æ‰§è¡Œæ›´æ–°è®°å½•ä¸»é”®çš„æ“ä½œä¹‹åï¼Œå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªæ™®é€šè¡¨çš„insert undoé“¾è¡¨ã€‚ å½“äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ é™¤æˆ–è€…æ›´æ–°äº†æ™®é€šè¡¨ä¸­çš„è®°å½•ä¹‹åï¼Œå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªæ™®é€šè¡¨çš„update undoé“¾è¡¨ã€‚ å½“äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ä¸´æ—¶è¡¨ä¸­æ’å…¥è®°å½•æˆ–è€…æ‰§è¡Œæ›´æ–°è®°å½•ä¸»é”®çš„æ“ä½œä¹‹åï¼Œå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªä¸´æ—¶è¡¨çš„insert undoé“¾è¡¨ã€‚ å½“äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ é™¤æˆ–è€…æ›´æ–°äº†ä¸´æ—¶è¡¨ä¸­çš„è®°å½•ä¹‹åï¼Œå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªä¸´æ—¶è¡¨çš„update undoé“¾è¡¨ã€‚ æ€»ç»“ä¸€å¥å°±æ˜¯ï¼šæŒ‰éœ€åˆ†é…ï¼Œå•¥æ—¶å€™éœ€è¦å•¥æ—¶å€™å†åˆ†é…ï¼Œä¸éœ€è¦å°±ä¸åˆ†é…ã€‚ 6.2å¤šä¸ªäº‹åŠ¡ä¸­çš„Undoé¡µé¢é“¾è¡¨ä¸ºäº†å°½å¯èƒ½æé«˜undoæ—¥å¿—çš„å†™å…¥æ•ˆç‡ï¼Œä¸åŒäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„undoæ—¥å¿—éœ€è¦è¢«å†™å…¥åˆ°ä¸åŒçš„Undoé¡µé¢é“¾è¡¨ä¸­ã€‚æ¯”æ–¹è¯´ç°åœ¨æœ‰äº‹åŠ¡idåˆ†åˆ«ä¸º1ã€2çš„ä¸¤ä¸ªäº‹åŠ¡ï¼Œæˆ‘ä»¬åˆ†åˆ«ç§°ä¹‹ä¸ºtrx 1å’Œtrx 2ï¼Œå‡è®¾åœ¨è¿™ä¸¤ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼š trx 1å¯¹æ™®é€šè¡¨åšäº†DELETEæ“ä½œï¼Œå¯¹ä¸´æ—¶è¡¨åšäº†INSERTå’ŒUPDATEæ“ä½œã€‚InnoDBä¼šä¸ºtrx 1åˆ†é…3ä¸ªé“¾è¡¨ï¼Œåˆ†åˆ«æ˜¯ï¼š é’ˆå¯¹æ™®é€šè¡¨çš„update undoé“¾è¡¨ é’ˆå¯¹ä¸´æ—¶è¡¨çš„insert undoé“¾è¡¨ é’ˆå¯¹ä¸´æ—¶è¡¨çš„update undoé“¾è¡¨ã€‚ trx 2å¯¹æ™®é€šè¡¨åšäº†INSERTã€UPDATEå’ŒDELETEæ“ä½œï¼Œæ²¡æœ‰å¯¹ä¸´æ—¶è¡¨åšæ”¹åŠ¨ã€‚InnoDBä¼šä¸ºtrx 2åˆ†é…2ä¸ªé“¾è¡¨ï¼Œåˆ†åˆ«æ˜¯ï¼š é’ˆå¯¹æ™®é€šè¡¨çš„insert undoé“¾è¡¨ é’ˆå¯¹æ™®é€šè¡¨çš„update undoé“¾è¡¨ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨trx 1å’Œtrx 2æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒInnoDBå…±éœ€ä¸ºè¿™ä¸¤ä¸ªäº‹åŠ¡åˆ†é…5ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œç”»ä¸ªå›¾å°±æ˜¯è¿™æ ·ï¼š å¦‚æœæœ‰æ›´å¤šçš„äº‹åŠ¡ï¼Œé‚£å°±æ„å‘³ç€å¯èƒ½ä¼šäº§ç”Ÿæ›´å¤šçš„Undoé¡µé¢é“¾è¡¨ã€‚ 7.undoæ—¥å¿—å…·ä½“å†™å…¥è¿‡ç¨‹7.1æ®µï¼ˆSegmentï¼‰çš„æ¦‚å¿µæ®µæ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œæœ¬è´¨ä¸Šæ˜¯ç”±è‹¥å¹²ä¸ªé›¶æ•£é¡µé¢å’Œè‹¥å¹²ä¸ªå®Œæ•´çš„åŒºç»„æˆçš„ã€‚æ¯”å¦‚ä¸€ä¸ªB+æ ‘ç´¢å¼•è¢«åˆ’åˆ†æˆä¸¤ä¸ªæ®µï¼Œä¸€ä¸ªå¶å­èŠ‚ç‚¹æ®µï¼Œä¸€ä¸ªéå¶å­èŠ‚ç‚¹æ®µï¼Œè¿™æ ·å¶å­èŠ‚ç‚¹å°±å¯ä»¥è¢«å°½å¯èƒ½çš„å­˜åˆ°ä¸€èµ·ï¼Œéå¶å­èŠ‚ç‚¹è¢«å°½å¯èƒ½çš„å­˜åˆ°ä¸€èµ·ã€‚æ¯ä¸€ä¸ªæ®µå¯¹åº”ä¸€ä¸ªINODE Entryç»“æ„ï¼Œè¿™ä¸ªINODE Entryç»“æ„æè¿°äº†è¿™ä¸ªæ®µçš„å„ç§ä¿¡æ¯ï¼Œæ¯”å¦‚æ®µçš„IDï¼Œæ®µå†…çš„å„ç§é“¾è¡¨åŸºèŠ‚ç‚¹ï¼Œé›¶æ•£é¡µé¢çš„é¡µå·æœ‰å“ªäº›ç­‰ä¿¡æ¯ã€‚æˆ‘ä¸ºäº†å®šä½ä¸€ä¸ªINODE Entryï¼ŒInnoDBè®¾è®¡äº†ä¸€ä¸ªSegment Headerçš„ç»“æ„ï¼š æ•´ä¸ªSegment Headerå ç”¨10ä¸ªå­—èŠ‚å¤§å°ï¼Œå„ä¸ªå±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š Space ID of the INODE Entryï¼šINODE Entryç»“æ„æ‰€åœ¨çš„è¡¨ç©ºé—´IDã€‚ Page Number of the INODE Entryï¼šINODE Entryç»“æ„æ‰€åœ¨çš„é¡µé¢é¡µå·ã€‚ Byte Offset of the INODE Entï¼šINODE Entryç»“æ„åœ¨è¯¥é¡µé¢ä¸­çš„åç§»é‡ çŸ¥é“äº†è¡¨ç©ºé—´IDã€é¡µå·ã€é¡µå†…åç§»é‡ï¼Œå°±å¯ä»¥å”¯ä¸€å®šä½ä¸€ä¸ªINODE Entryçš„åœ°å€ã€‚ 7.2Undo Log Segment HeaderInnoDBè§„å®šï¼Œæ¯ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨éƒ½å¯¹åº”ç€ä¸€ä¸ªæ®µï¼Œç§°ä¹‹ä¸ºUndo Log Segmentã€‚ä¹Ÿå°±æ˜¯è¯´é“¾è¡¨ä¸­çš„é¡µé¢éƒ½æ˜¯ä»è¿™ä¸ªæ®µé‡Œè¾¹ç”³è¯·çš„ï¼Œæ‰€ä»¥ä»–ä»¬åœ¨Undoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¾¹æåˆ°çš„first undo pageä¸­è®¾è®¡äº†ä¸€ä¸ªç§°ä¹‹ä¸ºUndo Log Segment Headerçš„éƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†ä¸­åŒ…å«äº†è¯¥é“¾è¡¨å¯¹åº”çš„æ®µçš„segment headerä¿¡æ¯ä»¥åŠå…¶ä»–çš„ä¸€äº›å…³äºè¿™ä¸ªæ®µçš„ä¿¡æ¯ï¼Œæ‰€ä»¥Undoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢å…¶å®é•¿è¿™æ ·ï¼š å¯ä»¥çœ‹åˆ°è¿™ä¸ªUndoé“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢æ¯”æ™®é€šé¡µé¢å¤šäº†ä¸ªUndo Log Segment Headerï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼š å…¶ä¸­å„ä¸ªå±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š TRX_UNDO_STATEï¼šæœ¬Undoé¡µé¢é“¾è¡¨å¤„åœ¨ä»€ä¹ˆçŠ¶æ€ã€‚ä¸€ä¸ªUndo Log Segmentå¯èƒ½å¤„åœ¨çš„çŠ¶æ€åŒ…æ‹¬ï¼š TRX_UNDO_ACTIVEï¼šæ´»è·ƒçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ´»è·ƒçš„äº‹åŠ¡æ­£åœ¨å¾€è¿™ä¸ªæ®µé‡Œè¾¹å†™å…¥undoæ—¥å¿—ã€‚ TRX_UNDO_CACHEDï¼šè¢«ç¼“å­˜çš„çŠ¶æ€ã€‚å¤„åœ¨è¯¥çŠ¶æ€çš„Undoé¡µé¢é“¾è¡¨ç­‰å¾…ç€ä¹‹åè¢«å…¶ä»–äº‹åŠ¡é‡ç”¨ã€‚ TRX_UNDO_TO_FREEï¼šå¯¹äºinsert undoé“¾è¡¨æ¥è¯´ï¼Œå¦‚æœåœ¨å®ƒå¯¹åº”çš„äº‹åŠ¡æäº¤ä¹‹åï¼Œè¯¥é“¾è¡¨ä¸èƒ½è¢«é‡ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå¤„äºè¿™ç§çŠ¶æ€ã€‚ TRX_UNDO_TO_PURGEï¼šå¯¹äºupdate undoé“¾è¡¨æ¥è¯´ï¼Œå¦‚æœåœ¨å®ƒå¯¹åº”çš„äº‹åŠ¡æäº¤ä¹‹åï¼Œè¯¥é“¾è¡¨ä¸èƒ½è¢«é‡ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå¤„äºè¿™ç§çŠ¶æ€ã€‚ TRX_UNDO_PREPAREDï¼šåŒ…å«å¤„äºPREPAREé˜¶æ®µçš„äº‹åŠ¡äº§ç”Ÿçš„undoæ—¥å¿—ã€‚ TRX_UNDO_LAST_LOGï¼šæœ¬Undoé¡µé¢é“¾è¡¨ä¸­æœ€åä¸€ä¸ªUndo Log Headerçš„ä½ç½®ã€‚ TRX_UNDO_FSEG_HEADERï¼šæœ¬Undoé¡µé¢é“¾è¡¨å¯¹åº”çš„æ®µçš„Segment Headerä¿¡æ¯ã€‚ TRX_UNDO_PAGE_LISTï¼šUndoé¡µé¢é“¾è¡¨çš„åŸºèŠ‚ç‚¹ã€‚ Undoé¡µé¢çš„Undo Page Headeréƒ¨åˆ†æœ‰ä¸€ä¸ª12å­—èŠ‚å¤§å°çš„TRX_UNDO_PAGE_NODEå±æ€§ï¼Œè¿™ä¸ªå±æ€§ä»£è¡¨ä¸€ä¸ªList Nodeç»“æ„ã€‚æ¯ä¸€ä¸ªUndoé¡µé¢éƒ½åŒ…å«Undo Page Headerç»“æ„ï¼Œè¿™äº›é¡µé¢å°±å¯ä»¥é€šè¿‡è¿™ä¸ªå±æ€§è¿æˆä¸€ä¸ªé“¾è¡¨ã€‚è¿™ä¸ªTRX_UNDO_PAGE_LISTå±æ€§ä»£è¡¨ç€è¿™ä¸ªé“¾è¡¨çš„åŸºèŠ‚ç‚¹ï¼Œå½“ç„¶è¿™ä¸ªåŸºèŠ‚ç‚¹åªå­˜åœ¨äºUndoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯first undo pageä¸­ã€‚ 7.3Undo Log Headerä¸€ä¸ªäº‹åŠ¡åœ¨å‘Undoé¡µé¢ä¸­å†™å…¥undoæ—¥å¿—æ—¶çš„æ–¹å¼æ˜¯ååˆ†ç®€å•æš´åŠ›çš„ï¼Œå°±æ˜¯ç›´æ¥å¾€é‡Œæ€¼ï¼Œå†™å®Œä¸€æ¡ç´§æ¥ç€å†™å¦ä¸€æ¡ï¼Œå„æ¡undoæ—¥å¿—ä¹‹é—´æ˜¯äº²å¯†æ— é—´çš„ã€‚å†™å®Œä¸€ä¸ªUndoé¡µé¢åï¼Œå†ä»æ®µé‡Œç”³è¯·ä¸€ä¸ªæ–°é¡µé¢ï¼Œç„¶åæŠŠè¿™ä¸ªé¡µé¢æ’å…¥åˆ°Undoé¡µé¢é“¾è¡¨ä¸­ï¼Œç»§ç»­å¾€è¿™ä¸ªæ–°ç”³è¯·çš„é¡µé¢ä¸­å†™ã€‚InnoDBè®¤ä¸ºåŒä¸€ä¸ªäº‹åŠ¡å‘ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨ä¸­å†™å…¥çš„undoæ—¥å¿—ç®—æ˜¯ä¸€ä¸ªç»„ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬ä¸Šè¾¹ä»‹ç»çš„trx 1ç”±äºä¼šåˆ†é…3ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œä¹Ÿå°±ä¼šå†™å…¥3ä¸ªç»„çš„undoæ—¥å¿—ï¼›trx 2ç”±äºä¼šåˆ†é…2ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œä¹Ÿå°±ä¼šå†™å…¥2ä¸ªç»„çš„undoæ—¥å¿—ã€‚åœ¨æ¯å†™å…¥ä¸€ç»„undoæ—¥å¿—æ—¶ï¼Œéƒ½ä¼šåœ¨è¿™ç»„undoæ—¥å¿—å‰å…ˆè®°å½•ä¸€ä¸‹å…³äºè¿™ä¸ªç»„çš„ä¸€äº›å±æ€§ï¼ŒInnoDBæŠŠå­˜å‚¨è¿™äº›å±æ€§çš„åœ°æ–¹ç§°ä¹‹ä¸ºUndo Log Headerã€‚æ‰€ä»¥Undoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢åœ¨çœŸæ­£å†™å…¥undoæ—¥å¿—å‰ï¼Œå…¶å®éƒ½ä¼šè¢«å¡«å……Undo Page Headerã€Undo Log Segment Headerã€Undo Log Headerè¿™3ä¸ªéƒ¨åˆ†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š è¿™ä¸ªUndo Log Headerå…·ä½“çš„ç»“æ„å¦‚ä¸‹ï¼š æˆ‘ä»¬å…ˆå¤§è‡´çœ‹ä¸€ä¸‹å®ƒä»¬éƒ½æ˜¯å•¥æ„æ€ï¼š TRX_UNDO_TRX_IDï¼šç”Ÿæˆæœ¬ç»„undoæ—¥å¿—çš„äº‹åŠ¡idã€‚ TRX_UNDO_TRX_NOï¼šäº‹åŠ¡æäº¤åç”Ÿæˆçš„ä¸€ä¸ªéœ€è¦åºå·ï¼Œä½¿ç”¨æ­¤åºå·æ¥æ ‡è®°äº‹åŠ¡çš„æäº¤é¡ºåºï¼ˆå…ˆæäº¤çš„æ­¤åºå·å°ï¼Œåæäº¤çš„æ­¤åºå·å¤§ï¼‰ã€‚ TRX_UNDO_DEL_MARKSï¼šæ ‡è®°æœ¬ç»„undoæ—¥å¿—ä¸­æ˜¯å¦åŒ…å«ç”±äºDelete markæ“ä½œäº§ç”Ÿçš„undoæ—¥å¿—ã€‚ TRX_UNDO_LOG_STARTï¼šè¡¨ç¤ºæœ¬ç»„undoæ—¥å¿—ä¸­ç¬¬ä¸€æ¡undoæ—¥å¿—çš„åœ¨é¡µé¢ä¸­çš„åç§»é‡ã€‚ TRX_UNDO_XID_EXISTSï¼šæœ¬ç»„undoæ—¥å¿—æ˜¯å¦åŒ…å«XIDä¿¡æ¯ã€‚ TRX_UNDO_DICT_TRANSï¼šæ ‡è®°æœ¬ç»„undoæ—¥å¿—æ˜¯ä¸æ˜¯ç”±DDLè¯­å¥äº§ç”Ÿçš„ã€‚ TRX_UNDO_TABLE_IDï¼šå¦‚æœTRX_UNDO_DICT_TRANSä¸ºçœŸï¼Œé‚£ä¹ˆæœ¬å±æ€§è¡¨ç¤ºDDLè¯­å¥æ“ä½œçš„è¡¨çš„table idã€‚ TRX_UNDO_NEXT_LOGï¼šä¸‹ä¸€ç»„çš„undoæ—¥å¿—åœ¨é¡µé¢ä¸­å¼€å§‹çš„åç§»é‡ã€‚ TRX_UNDO_PREV_LOGï¼šä¸Šä¸€ç»„çš„undoæ—¥å¿—åœ¨é¡µé¢ä¸­å¼€å§‹çš„åç§»é‡ã€‚ ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨åªå­˜å‚¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç»„undoæ—¥å¿—ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šåœ¨ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œä¹‹åå¼€å¯çš„äº‹åŠ¡é‡å¤åˆ©ç”¨è¿™ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªUndoé¡µé¢ä¸­å¯èƒ½å­˜æ”¾å¤šç»„Undoæ—¥å¿—ï¼ŒTRX_UNDO_NEXT_LOGå’ŒTRX_UNDO_PREV_LOGå°±æ˜¯ç”¨æ¥æ ‡è®°ä¸‹ä¸€ç»„å’Œä¸Šä¸€ç»„undoæ—¥å¿—åœ¨é¡µé¢ä¸­çš„åç§»é‡çš„ã€‚ TRX_UNDO_HISTORY_NODEï¼šä¸€ä¸ª12å­—èŠ‚çš„List Nodeç»“æ„ï¼Œä»£è¡¨ä¸€ä¸ªç§°ä¹‹ä¸ºHistoryé“¾è¡¨çš„èŠ‚ç‚¹ã€‚ 7.4å°ç»“å¯¹äºæ²¡æœ‰è¢«é‡ç”¨çš„Undoé¡µé¢é“¾è¡¨æ¥è¯´ï¼Œé“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯first undo pageåœ¨çœŸæ­£å†™å…¥undoæ—¥å¿—å‰ï¼Œä¼šå¡«å……Undo Page Headerã€Undo Log Segment Headerã€Undo Log Headerè¿™3ä¸ªéƒ¨åˆ†ï¼Œä¹‹åæ‰å¼€å§‹æ­£å¼å†™å…¥undoæ—¥å¿—ã€‚å¯¹äºå…¶ä»–çš„é¡µé¢æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯normal undo pageåœ¨çœŸæ­£å†™å…¥undoæ—¥å¿—å‰ï¼Œåªä¼šå¡«å……Undo Page Headerã€‚é“¾è¡¨çš„List Base Nodeå­˜æ”¾åˆ°first undo pageçš„Undo Log Segment Headeréƒ¨åˆ†ï¼ŒList Nodeä¿¡æ¯å­˜æ”¾åˆ°æ¯ä¸€ä¸ªUndoé¡µé¢çš„undo Page Headeréƒ¨åˆ†ï¼Œæ‰€ä»¥ç”»ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š 8.é‡ç”¨Undoé¡µé¢ä¸ºäº†èƒ½æé«˜å¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡å†™å…¥undoæ—¥å¿—çš„æ€§èƒ½ï¼ŒInnoDBå†³å®šä¸ºæ¯ä¸ªäº‹åŠ¡å•ç‹¬åˆ†é…ç›¸åº”çš„Undoé¡µé¢é“¾è¡¨ï¼ˆæœ€å¤šå¯èƒ½å•ç‹¬åˆ†é…4ä¸ªé“¾è¡¨ï¼‰ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿé€ æˆäº†ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚å…¶å®å¤§éƒ¨åˆ†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½åªä¿®æ”¹äº†ä¸€æ¡æˆ–å‡ æ¡è®°å½•ï¼Œé’ˆå¯¹æŸä¸ªUndoé¡µé¢é“¾è¡¨åªäº§ç”Ÿäº†éå¸¸å°‘çš„undoæ—¥å¿—ï¼Œè¿™äº›undoæ—¥å¿—å¯èƒ½åªå ç”¨ä¸€ç‚¹å­˜å‚¨ç©ºé—´ï¼Œæ¯å¼€å¯ä¸€ä¸ªäº‹åŠ¡å°±æ–°åˆ›å»ºä¸€ä¸ªUndoé¡µé¢é“¾è¡¨ï¼ˆè™½ç„¶è¿™ä¸ªé“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªé¡µé¢ï¼‰æ¥å­˜å‚¨è¿™ä¹ˆä¸€ç‚¹undoæ—¥å¿—å²‚ä¸æ˜¯å¤ªæµªè´¹äº†ä¹ˆï¼Ÿçš„ç¡®æ˜¯æŒºæµªè´¹ï¼Œäºæ˜¯InnoDBå†³å®šåœ¨äº‹åŠ¡æäº¤ååœ¨æŸäº›æƒ…å†µä¸‹é‡ç”¨è¯¥äº‹åŠ¡çš„Undoé¡µé¢é“¾è¡¨ã€‚ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨æ˜¯å¦å¯ä»¥è¢«é‡ç”¨çš„æ¡ä»¶å¾ˆç®€å•ï¼š è¯¥é“¾è¡¨ä¸­åªåŒ…å«ä¸€ä¸ªUndoé¡µé¢ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†éå¸¸å¤šçš„undoæ—¥å¿—ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ç”³è¯·éå¸¸å¤šçš„é¡µé¢åŠ å…¥åˆ°Undoé¡µé¢é“¾è¡¨ä¸­ã€‚åœ¨è¯¥äº‹ç‰©æäº¤åï¼Œå¦‚æœå°†æ•´ä¸ªé“¾è¡¨ä¸­çš„é¡µé¢éƒ½é‡ç”¨ï¼Œé‚£å°±æ„å‘³ç€å³ä½¿æ–°çš„äº‹åŠ¡å¹¶æ²¡æœ‰å‘è¯¥Undoé¡µé¢é“¾è¡¨ä¸­å†™å…¥å¾ˆå¤šundoæ—¥å¿—ï¼Œé‚£è¯¥é“¾è¡¨ä¸­ä¹Ÿå¾—ç»´æŠ¤éå¸¸å¤šçš„é¡µé¢ï¼Œé‚£äº›ç”¨ä¸åˆ°çš„é¡µé¢ä¹Ÿä¸èƒ½è¢«åˆ«çš„äº‹åŠ¡æ‰€ä½¿ç”¨ï¼Œè¿™æ ·å°±é€ æˆäº†å¦ä¸€ç§æµªè´¹ã€‚æ‰€ä»¥InnoDBè§„å®šï¼Œåªæœ‰åœ¨Undoé¡µé¢é“¾è¡¨ä¸­åªåŒ…å«ä¸€ä¸ªUndoé¡µé¢æ—¶ï¼Œè¯¥é“¾è¡¨æ‰å¯ä»¥è¢«ä¸‹ä¸€ä¸ªäº‹åŠ¡æ‰€é‡ç”¨ã€‚ è¯¥Undoé¡µé¢å·²ç»ä½¿ç”¨çš„ç©ºé—´å°äºæ•´ä¸ªé¡µé¢ç©ºé—´çš„3/4ã€‚ Undoé¡µé¢é“¾è¡¨æŒ‰ç…§å­˜å‚¨çš„undoæ—¥å¿—æ‰€å±çš„å¤§ç±»å¯ä»¥è¢«åˆ†ä¸ºinsert undoé“¾è¡¨å’Œupdate undoé“¾è¡¨ä¸¤ç§ï¼Œè¿™ä¸¤ç§é“¾è¡¨åœ¨è¢«é‡ç”¨æ—¶çš„ç­–ç•¥ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹ä¸€ä¸‹ï¼š insert undoé“¾è¡¨insert undoé“¾è¡¨ä¸­åªå­˜å‚¨ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œè¿™ç§ç±»å‹çš„undoæ—¥å¿—åœ¨äº‹åŠ¡æäº¤ä¹‹åå°±æ²¡ç”¨äº†ï¼Œå°±å¯ä»¥è¢«æ¸…é™¤æ‰ã€‚æ‰€ä»¥åœ¨æŸä¸ªäº‹åŠ¡æäº¤åï¼Œé‡ç”¨è¿™ä¸ªäº‹åŠ¡çš„insert undoé“¾è¡¨ï¼ˆè¿™ä¸ªé“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªé¡µé¢ï¼‰æ—¶ï¼Œå¯ä»¥ç›´æ¥æŠŠä¹‹å‰äº‹åŠ¡å†™å…¥çš„ä¸€ç»„undoæ—¥å¿—è¦†ç›–æ‰ï¼Œä»å¤´å¼€å§‹å†™å…¥æ–°äº‹åŠ¡çš„ä¸€ç»„undoæ—¥å¿—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šå¦‚å›¾æ‰€ç¤ºï¼Œå‡è®¾æœ‰ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨çš„insert undoé“¾è¡¨ï¼Œåˆ°äº‹åŠ¡æäº¤æ—¶ï¼Œåªå‘insert undoé“¾è¡¨ä¸­æ’å…¥äº†3æ¡undoæ—¥å¿—ï¼Œè¿™ä¸ªinsert undoé“¾è¡¨åªç”³è¯·äº†ä¸€ä¸ªUndoé¡µé¢ã€‚å‡è®¾æ­¤åˆ»è¯¥é¡µé¢å·²ä½¿ç”¨çš„ç©ºé—´å°äºæ•´ä¸ªé¡µé¢å¤§å°çš„3/4ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªäº‹åŠ¡å°±å¯ä»¥é‡ç”¨è¿™ä¸ªinsert undoé“¾è¡¨ï¼ˆé“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªé¡µé¢)ã€‚å‡è®¾æ­¤æ—¶æœ‰ä¸€ä¸ªæ–°äº‹åŠ¡é‡ç”¨äº†è¯¥insert undoé“¾è¡¨ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æŠŠæ—§çš„ä¸€ç»„undoæ—¥å¿—è¦†ç›–æ‰ï¼Œå†™å…¥ä¸€ç»„æ–°çš„undoæ—¥å¿—ã€‚ åœ¨é‡ç”¨Undoé¡µé¢é“¾è¡¨å†™å…¥æ–°çš„ä¸€ç»„undoæ—¥å¿—æ—¶ï¼Œä¸ä»…ä¼šå†™å…¥æ–°çš„Undo Log Headerï¼Œè¿˜ä¼šé€‚å½“è°ƒæ•´Undo Page Headerã€Undo Log Segment Headerã€Undo Log Headerä¸­çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚TRX_UNDO_PAGE_STARTã€TRX_UNDO_PAGE_FREEç­‰ç­‰ã€‚ update undoé“¾è¡¨åœ¨ä¸€ä¸ªäº‹åŠ¡æäº¤åï¼Œå®ƒçš„update undoé“¾è¡¨ä¸­çš„undoæ—¥å¿—ä¹Ÿä¸èƒ½ç«‹å³åˆ é™¤æ‰ï¼ˆè¿™äº›æ—¥å¿—ç”¨äºMVCCï¼‰ã€‚æ‰€ä»¥å¦‚æœä¹‹åçš„äº‹åŠ¡æƒ³é‡ç”¨update undoé“¾è¡¨æ—¶ï¼Œå°±ä¸èƒ½è¦†ç›–ä¹‹å‰äº‹åŠ¡å†™å…¥çš„undoæ—¥å¿—ã€‚è¿™æ ·å°±ç›¸å½“äºåœ¨åŒä¸€ä¸ªUndoé¡µé¢ä¸­å†™å…¥äº†å¤šç»„çš„undoæ—¥å¿—ï¼Œæ•ˆæœçœ‹èµ·æ¥å°±æ˜¯è¿™æ ·ï¼š 9.å›æ»šæ®µ9.1å›æ»šæ®µçš„æ¦‚å¿µä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æœ€å¤šå¯ä»¥åˆ†é…4ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œåœ¨åŒä¸€æ—¶åˆ»ä¸åŒäº‹åŠ¡æ‹¥æœ‰çš„Undoé¡µé¢é“¾è¡¨æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥åœ¨åŒä¸€æ—¶åˆ»ç³»ç»Ÿé‡Œå…¶å®å¯ä»¥æœ‰è®¸è®¸å¤šå¤šä¸ªUndoé¡µé¢é“¾è¡¨å­˜åœ¨ã€‚ä¸ºäº†æ›´å¥½çš„ç®¡ç†è¿™äº›é“¾è¡¨ï¼ŒInnoDBåˆè®¾è®¡äº†ä¸€ä¸ªç§°ä¹‹ä¸ºRollback Segment Headerçš„é¡µé¢ï¼Œåœ¨è¿™ä¸ªé¡µé¢ä¸­å­˜æ”¾äº†å„ä¸ªUndoé¡µé¢é“¾è¡¨çš„frist undo pageçš„é¡µå·ï¼Œè¿™äº›é¡µå·ç§°ä¹‹ä¸ºundo slotã€‚å¯ä»¥è¿™æ ·ç†è§£ï¼Œæ¯ä¸ªUndoé¡µé¢é“¾è¡¨éƒ½ç›¸å½“äºæ˜¯ä¸€ä¸ªç­ï¼Œè¿™ä¸ªé“¾è¡¨çš„first undo pageå°±ç›¸å½“äºè¿™ä¸ªç­çš„ç­é•¿ï¼Œæ‰¾åˆ°äº†è¿™ä¸ªç­çš„ç­é•¿ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç­é‡Œçš„å…¶ä»–åŒå­¦ï¼ˆå…¶ä»–åŒå­¦ç›¸å½“äºnormal undo pageï¼‰ã€‚æœ‰æ—¶å€™å­¦æ ¡éœ€è¦å‘è¿™äº›ç­çº§ä¼ è¾¾ä¸€ä¸‹ç²¾ç¥ï¼Œå°±éœ€è¦æŠŠç­é•¿éƒ½å¬é›†åœ¨ä¼šè®®å®¤ï¼Œè¿™ä¸ªRollback Segment Headerå°±ç›¸å½“äºæ˜¯ä¸€ä¸ªä¼šè®®å®¤ã€‚ æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªç§°ä¹‹ä¸ºRollback Segment Headerçš„é¡µé¢é•¿å•¥æ ·ï¼ˆä»¥é»˜è®¤çš„16KBä¸ºä¾‹ï¼‰ï¼š InnoDBè§„å®šï¼Œæ¯ä¸€ä¸ªRollback Segment Headeré¡µé¢éƒ½å¯¹åº”ç€ä¸€ä¸ªæ®µï¼Œè¿™ä¸ªæ®µå°±ç§°ä¸ºRollback Segmentï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯å›æ»šæ®µã€‚ä¸ä¹‹å‰ä»‹ç»çš„å„ç§æ®µä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªRollback Segmenté‡Œå…¶å®åªæœ‰ä¸€ä¸ªé¡µé¢ã€‚ äº†è§£äº†Rollback Segmentçš„å«ä¹‰ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªç§°ä¹‹ä¸ºRollback Segment Headerçš„é¡µé¢çš„å„ä¸ªéƒ¨åˆ†çš„å«ä¹‰éƒ½æ˜¯å•¥æ„æ€ï¼š TRX_RSEG_MAX_SIZEï¼šæœ¬Rollback Segmentä¸­ç®¡ç†çš„æ‰€æœ‰Undoé¡µé¢é“¾è¡¨ä¸­çš„Undoé¡µé¢æ•°é‡ä¹‹å’Œçš„æœ€å¤§å€¼ã€‚æ¢å¥è¯è¯´ï¼Œæœ¬Rollback Segmentä¸­æ‰€æœ‰Undoé¡µé¢é“¾è¡¨ä¸­çš„Undoé¡µé¢æ•°é‡ä¹‹å’Œä¸èƒ½è¶…è¿‡TRX_RSEG_MAX_SIZEä»£è¡¨çš„å€¼ã€‚è¯¥å±æ€§çš„å€¼é»˜è®¤ä¸ºæ— é™å¤§ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æƒ³å†™å¤šå°‘Undoé¡µé¢éƒ½å¯ä»¥ã€‚ æ— é™å¤§å…¶å®ä¹Ÿåªæ˜¯ä¸ªå¤¸å¼ çš„è¯´æ³•ï¼Œ4ä¸ªå­—èŠ‚èƒ½è¡¨ç¤ºæœ€å¤§çš„æ•°ä¹Ÿå°±æ˜¯0xFFFFFFFFï¼Œä½†æ˜¯0xFFFFFFFFè¿™ä¸ªæ•°æœ‰ç‰¹æ®Šç”¨é€”ï¼Œæ‰€ä»¥å®é™…ä¸ŠTRX_RSEG_MAX_SIZEçš„å€¼ä¸º0xFFFFFFFEã€‚ TRX_RSEG_HISTORY_SIZEï¼šHistoryé“¾è¡¨å ç”¨çš„é¡µé¢æ•°é‡ã€‚ TRX_RSEG_HISTORYï¼šHistoryé“¾è¡¨çš„åŸºèŠ‚ç‚¹ã€‚ TRX_RSEG_FSEG_HEADERï¼šæœ¬Rollback Segmentå¯¹åº”çš„10å­—èŠ‚å¤§å°çš„Segment Headerç»“æ„ï¼Œé€šè¿‡å®ƒå¯ä»¥æ‰¾åˆ°æœ¬æ®µå¯¹åº”çš„INODE Entryã€‚ TRX_RSEG_UNDO_SLOTSï¼šå„ä¸ªUndoé¡µé¢é“¾è¡¨çš„first undo pageçš„é¡µå·é›†åˆï¼Œä¹Ÿå°±æ˜¯undo sloté›†åˆã€‚ä¸€ä¸ªé¡µå·å ç”¨4ä¸ªå­—èŠ‚ï¼Œå¯¹äº16KBå¤§å°çš„é¡µé¢æ¥è¯´ï¼Œè¿™ä¸ªTRX_RSEG_UNDO_SLOTSéƒ¨åˆ†å…±å­˜å‚¨äº†1024ä¸ªundo slotï¼Œæ‰€ä»¥å…±éœ€1024 Ã— 4 = 4096ä¸ªå­—èŠ‚ã€‚ 9.2 ä»å›æ»šæ®µä¸­ç”³è¯·Undoé¡µé¢é“¾è¡¨åˆå§‹æƒ…å†µä¸‹ï¼Œç”±äºæœªå‘ä»»ä½•äº‹åŠ¡åˆ†é…ä»»ä½•Undoé¡µé¢é“¾è¡¨ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ªRollback Segment Headeré¡µé¢æ¥è¯´ï¼Œå®ƒçš„å„ä¸ªundo slotéƒ½è¢«è®¾ç½®æˆäº†ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼šFIL_NULLï¼ˆå¯¹åº”çš„åå…­è¿›åˆ¶å°±æ˜¯0xFFFFFFFFï¼‰ï¼Œè¡¨ç¤ºè¯¥undo slotä¸æŒ‡å‘ä»»ä½•é¡µé¢ã€‚ éšç€æ—¶é—´çš„æµé€ï¼Œå¼€å§‹æœ‰äº‹åŠ¡éœ€è¦åˆ†é…Undoé¡µé¢é“¾è¡¨äº†ï¼Œå°±ä»å›æ»šæ®µçš„ç¬¬ä¸€ä¸ªundo slotå¼€å§‹ï¼Œçœ‹çœ‹è¯¥undo slotçš„å€¼æ˜¯ä¸æ˜¯FIL_NULLï¼š å¦‚æœæ˜¯FIL_NULLï¼Œé‚£ä¹ˆåœ¨è¡¨ç©ºé—´ä¸­æ–°åˆ›å»ºä¸€ä¸ªæ®µï¼ˆä¹Ÿå°±æ˜¯Undo Log Segmentï¼‰ï¼Œç„¶åä»æ®µé‡Œç”³è¯·ä¸€ä¸ªé¡µé¢ä½œä¸ºUndoé¡µé¢é“¾è¡¨çš„first undo pageï¼Œç„¶åæŠŠè¯¥undo slotçš„å€¼è®¾ç½®ä¸ºåˆšåˆšç”³è¯·çš„è¿™ä¸ªé¡µé¢çš„é¡µå·ï¼Œè¿™æ ·ä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªundo slotè¢«åˆ†é…ç»™äº†è¿™ä¸ªäº‹åŠ¡ã€‚ å¦‚æœä¸æ˜¯FIL_NULLï¼Œè¯´æ˜è¯¥undo slotå·²ç»æŒ‡å‘äº†ä¸€ä¸ªundoé“¾è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªundo slotå·²ç»è¢«åˆ«çš„äº‹åŠ¡å ç”¨äº†ï¼Œé‚£å°±è·³åˆ°ä¸‹ä¸€ä¸ªundo slotï¼Œåˆ¤æ–­è¯¥undo slotçš„å€¼æ˜¯ä¸æ˜¯FIL_NULLï¼Œé‡å¤ä¸Šè¾¹çš„æ­¥éª¤ã€‚ ä¸€ä¸ªRollback Segment Headeré¡µé¢ä¸­åŒ…å«1024ä¸ªundo slotï¼Œå¦‚æœè¿™1024ä¸ªundo slotçš„å€¼éƒ½ä¸ä¸ºFIL_NULLï¼Œè¿™å°±æ„å‘³ç€è¿™1024ä¸ªundo slotéƒ½å·²ç»è¢«åˆ†é…ç»™äº†æŸä¸ªäº‹åŠ¡ï¼Œæ­¤æ—¶ç”±äºæ–°äº‹åŠ¡æ— æ³•å†è·å¾—æ–°çš„Undoé¡µé¢é“¾è¡¨ï¼Œå°±ä¼šå›æ»šè¿™ä¸ªäº‹åŠ¡å¹¶ä¸”ç»™ç”¨æˆ·æŠ¥é”™ï¼š 1Too many active concurrent transactions ç”¨æˆ·çœ‹åˆ°è¿™ä¸ªé”™è¯¯ï¼Œå¯ä»¥é€‰æ‹©é‡æ–°æ‰§è¡Œè¿™ä¸ªäº‹åŠ¡ï¼ˆå¯èƒ½é‡æ–°æ‰§è¡Œæ—¶æœ‰åˆ«çš„äº‹åŠ¡æäº¤äº†ï¼Œè¯¥äº‹åŠ¡å°±å¯ä»¥è¢«åˆ†é…Undoé¡µé¢é“¾è¡¨äº†ï¼‰ã€‚ å½“ä¸€ä¸ªäº‹åŠ¡æäº¤æ—¶ï¼Œå®ƒæ‰€å ç”¨çš„undo slotæœ‰ä¸¤ç§å‘½è¿ï¼š å¦‚æœè¯¥undo slotæŒ‡å‘çš„Undoé¡µé¢é“¾è¡¨ç¬¦åˆè¢«é‡ç”¨çš„æ¡ä»¶ï¼ˆå°±æ˜¯æˆ‘ä»¬ä¸Šè¾¹è¯´çš„Undoé¡µé¢é“¾è¡¨åªå ç”¨ä¸€ä¸ªé¡µé¢å¹¶ä¸”å·²ä½¿ç”¨ç©ºé—´å°äºæ•´ä¸ªé¡µé¢çš„3/4ï¼‰ã€‚è¯¥undo slotå°±å¤„äºè¢«ç¼“å­˜çš„çŠ¶æ€ï¼ŒInnoDBè§„å®šè¿™æ—¶è¯¥Undoé¡µé¢é“¾è¡¨çš„TRX_UNDO_STATEå±æ€§ï¼ˆè¯¥å±æ€§åœ¨first undo pageçš„Undo Log Segment Headeréƒ¨åˆ†ï¼‰ä¼šè¢«è®¾ç½®ä¸ºTRX_UNDO_CACHEDã€‚ è¢«ç¼“å­˜çš„undo slotéƒ½ä¼šè¢«åŠ å…¥åˆ°ä¸€ä¸ªé“¾è¡¨ï¼Œæ ¹æ®å¯¹åº”çš„Undoé¡µé¢`é“¾è¡¨çš„ç±»å‹ä¸åŒï¼Œä¹Ÿä¼šè¢«åŠ å…¥åˆ°ä¸åŒçš„é“¾è¡¨ï¼š å¦‚æœå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨æ˜¯insert undoé“¾è¡¨ï¼Œåˆ™è¯¥undo slotä¼šè¢«åŠ å…¥insert undo cachedé“¾è¡¨ã€‚ å¦‚æœå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨æ˜¯update undoé“¾è¡¨ï¼Œåˆ™è¯¥undo slotä¼šè¢«åŠ å…¥update undo cachedé“¾è¡¨ã€‚ ä¸€ä¸ªå›æ»šæ®µå°±å¯¹åº”ç€ä¸Šè¿°ä¸¤ä¸ªcachedé“¾è¡¨ï¼Œå¦‚æœæœ‰æ–°äº‹åŠ¡è¦åˆ†é…undo slotæ—¶ï¼Œå…ˆä»å¯¹åº”çš„cachedé“¾è¡¨ä¸­æ‰¾ã€‚å¦‚æœæ²¡æœ‰è¢«ç¼“å­˜çš„undo slotï¼Œæ‰ä¼šåˆ°å›æ»šæ®µçš„Rollback Segment Headeré¡µé¢ä¸­å†å»æ‰¾ã€‚ å¦‚æœè¯¥undo slotæŒ‡å‘çš„Undoé¡µé¢é“¾è¡¨ä¸ç¬¦åˆè¢«é‡ç”¨çš„æ¡ä»¶ï¼Œé‚£ä¹ˆé’ˆå¯¹è¯¥undo slotå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨ç±»å‹ä¸åŒï¼Œä¹Ÿä¼šæœ‰ä¸åŒçš„å¤„ç†ï¼š å¦‚æœå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨æ˜¯insert undoé“¾è¡¨ï¼Œåˆ™è¯¥Undoé¡µé¢é“¾è¡¨çš„TRX_UNDO_STATEå±æ€§ä¼šè¢«è®¾ç½®ä¸ºTRX_UNDO_TO_FREEï¼Œä¹‹åè¯¥Undoé¡µé¢é“¾è¡¨å¯¹åº”çš„æ®µä¼šè¢«é‡Šæ”¾æ‰ï¼ˆä¹Ÿå°±æ„å‘³ç€æ®µä¸­çš„é¡µé¢å¯ä»¥è¢«æŒªä½œä»–ç”¨ï¼‰ï¼Œç„¶åæŠŠè¯¥undo slotçš„å€¼è®¾ç½®ä¸ºFIL_NULLã€‚ å¦‚æœå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨æ˜¯update undoé“¾è¡¨ï¼Œåˆ™è¯¥Undoé¡µé¢é“¾è¡¨çš„TRX_UNDO_STATEå±æ€§ä¼šè¢«è®¾ç½®ä¸ºTRX_UNDO_TO_PRUGEï¼Œåˆ™ä¼šå°†è¯¥undo slotçš„å€¼è®¾ç½®ä¸ºFIL_NULLï¼Œç„¶åå°†æœ¬æ¬¡äº‹åŠ¡å†™å…¥çš„ä¸€ç»„undoæ—¥å¿—æ”¾åˆ°æ‰€è°“çš„Historyé“¾è¡¨ä¸­ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¹¶ä¸ä¼šå°†Undoé¡µé¢é“¾è¡¨å¯¹åº”çš„æ®µç»™é‡Šæ”¾æ‰ï¼Œå› ä¸ºè¿™äº›undoæ—¥å¿—è¿˜æœ‰ç”¨å‘¢ï½ï¼‰ã€‚ 9.3å¤šä¸ªå›æ»šæ®µä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æœ€å¤šåˆ†é…4ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œè€Œä¸€ä¸ªå›æ»šæ®µé‡Œåªæœ‰1024ä¸ªundo slotï¼Œå¾ˆæ˜¾ç„¶undo slotçš„æ•°é‡æœ‰ç‚¹å°‘ã€‚å³ä½¿å‡è®¾ä¸€ä¸ªè¯»å†™äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åªåˆ†é…1ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œé‚£1024ä¸ªundo slotä¹Ÿåªèƒ½æ”¯æŒ1024ä¸ªè¯»å†™äº‹åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå†å¤šäº†å°±å´©æºƒäº† åœ¨InnoDBçš„æ—©æœŸå‘å±•é˜¶æ®µçš„ç¡®åªæœ‰ä¸€ä¸ªå›æ»šæ®µï¼Œä½†æ˜¯InnoDBåæ¥æ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥InnoDBä¸€å£æ°”å®šä¹‰äº†128ä¸ªå›æ»šæ®µï¼Œä¹Ÿå°±ç›¸å½“äºæœ‰äº†128 Ã— 1024 = 131072ä¸ªundo slotã€‚å‡è®¾ä¸€ä¸ªè¯»å†™äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åªåˆ†é…1ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŒæ—¶æ”¯æŒ131072ä¸ªè¯»å†™äº‹åŠ¡å¹¶å‘æ‰§è¡Œã€‚ åªè¯»äº‹åŠ¡å¹¶ä¸éœ€è¦åˆ†é…Undoé¡µé¢é“¾è¡¨ï¼ŒMySQL 5.7ä¸­æ‰€æœ‰åˆšå¼€å¯çš„äº‹åŠ¡é»˜è®¤éƒ½æ˜¯åªè¯»äº‹åŠ¡ï¼Œåªæœ‰åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹è®°å½•åšäº†æŸäº›æ”¹åŠ¨æ—¶æ‰ä¼šè¢«å‡çº§ä¸ºè¯»å†™äº‹åŠ¡ã€‚ æ¯ä¸ªå›æ»šæ®µéƒ½å¯¹åº”ç€ä¸€ä¸ªRollback Segment Headeré¡µé¢ï¼Œæœ‰128ä¸ªå›æ»šæ®µï¼Œè‡ªç„¶å°±è¦æœ‰128ä¸ªRollback Segment Headeré¡µé¢ï¼Œè¿™äº›é¡µé¢çš„åœ°å€éœ€è¦æ‰¾ä¸ªåœ°æ–¹å­˜ä¸€ä¸‹ï¼äºæ˜¯InnoDBåœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ç¬¬5å·é¡µé¢çš„æŸä¸ªåŒºåŸŸåŒ…å«äº†128ä¸ª8å­—èŠ‚å¤§å°çš„æ ¼å­ï¼š æ¯ä¸ª8å­—èŠ‚çš„æ ¼å­çš„æ„é€ å°±åƒè¿™æ ·ï¼š å¦‚æœæ‰€ç¤ºï¼Œæ¯ä¸ª8å­—èŠ‚çš„æ ¼å­å…¶å®ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š 4å­—èŠ‚å¤§å°çš„Space IDï¼Œä»£è¡¨ä¸€ä¸ªè¡¨ç©ºé—´çš„IDã€‚ 4å­—èŠ‚å¤§å°çš„Page numberï¼Œä»£è¡¨ä¸€ä¸ªé¡µå·ã€‚ ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª8å­—èŠ‚å¤§å°çš„æ ¼å­ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸ªè¡¨ç©ºé—´ä¸­çš„æŸä¸ªé¡µé¢ï¼Œè¿™äº›é¡µé¢å°±æ˜¯Rollback Segment Headerã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹äº‹ï¼Œè¦å®šä½ä¸€ä¸ªRollback Segment Headerè¿˜éœ€è¦çŸ¥é“å¯¹åº”çš„è¡¨ç©ºé—´IDï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä¸åŒçš„å›æ»šæ®µå¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„è¡¨ç©ºé—´ä¸­ã€‚ æ‰€ä»¥é€šè¿‡ä¸Šè¾¹çš„å™è¿°æˆ‘ä»¬å¯ä»¥å¤§è‡´æ¸…æ¥šï¼Œåœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ç¬¬5å·é¡µé¢ä¸­å­˜å‚¨äº†128ä¸ªRollback Segment Headeré¡µé¢åœ°å€ï¼Œæ¯ä¸ªRollback Segment Headerå°±ç›¸å½“äºä¸€ä¸ªå›æ»šæ®µã€‚åœ¨Rollback Segment Headeré¡µé¢ä¸­ï¼ŒåˆåŒ…å«1024ä¸ªundo slotï¼Œæ¯ä¸ªundo slotéƒ½å¯¹åº”ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨ã€‚æˆ‘ä»¬ç”»ä¸ªç¤ºæ„å›¾ï¼š 9.4å›æ»šæ®µçš„åˆ†ç±»æˆ‘ä»¬æŠŠè¿™128ä¸ªå›æ»šæ®µç»™ç¼–ä¸€ä¸‹å·ï¼Œæœ€å¼€å§‹çš„å›æ»šæ®µç§°ä¹‹ä¸ºç¬¬0å·å›æ»šæ®µï¼Œä¹‹åä¾æ¬¡é€’å¢ï¼Œæœ€åä¸€ä¸ªå›æ»šæ®µå°±ç§°ä¹‹ä¸ºç¬¬127å·å›æ»šæ®µã€‚è¿™128ä¸ªå›æ»šæ®µå¯ä»¥è¢«åˆ†æˆä¸¤å¤§ç±»ï¼š ç¬¬0å·ã€ç¬¬33ï½127å·å›æ»šæ®µå±äºä¸€ç±»ã€‚å…¶ä¸­ç¬¬0å·å›æ»šæ®µå¿…é¡»åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ï¼ˆå°±æ˜¯è¯´ç¬¬0å·å›æ»šæ®µå¯¹åº”çš„Rollback Segment Headeré¡µé¢å¿…é¡»åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ï¼‰ï¼Œç¬¬33ï½127å·å›æ»šæ®µæ—¢å¯ä»¥åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨è‡ªå·±é…ç½®çš„undoè¡¨ç©ºé—´ä¸­ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç”±äºå¯¹æ™®é€šè¡¨çš„è®°å½•åšäº†æ”¹åŠ¨éœ€è¦åˆ†é…Undoé¡µé¢é“¾è¡¨æ—¶ï¼Œå¿…é¡»ä»è¿™ä¸€ç±»çš„æ®µä¸­åˆ†é…ç›¸åº”çš„undo slotã€‚ ç¬¬1ï½32å·å›æ»šæ®µå±äºä¸€ç±»ã€‚è¿™äº›å›æ»šæ®µå¿…é¡»åœ¨ä¸´æ—¶è¡¨ç©ºé—´ï¼ˆå¯¹åº”ç€æ•°æ®ç›®å½•ä¸­çš„ibtmp1æ–‡ä»¶ï¼‰ä¸­ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç”±äºå¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšäº†æ”¹åŠ¨éœ€è¦åˆ†é…Undoé¡µé¢é“¾è¡¨æ—¶ï¼Œå¿…é¡»ä»è¿™ä¸€ç±»çš„æ®µä¸­åˆ†é…ç›¸åº”çš„undo slotã€‚ ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢å¯¹æ™®é€šè¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œåˆå¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œé‚£ä¹ˆéœ€è¦ä¸ºè¿™ä¸ªè®°å½•åˆ†é…2ä¸ªå›æ»šæ®µï¼Œå†åˆ†åˆ«åˆ°è¿™ä¸¤ä¸ªå›æ»šæ®µä¸­åˆ†é…å¯¹åº”çš„undo slotã€‚ ä¸ºå•¥è¦æŠŠé’ˆå¯¹æ™®é€šè¡¨å’Œä¸´æ—¶è¡¨æ¥åˆ’åˆ†ä¸åŒç§ç±»çš„å›æ»šæ®µå‘¢ï¼Ÿè¿™ä¸ªè¿˜å¾—ä»Undoé¡µé¢æœ¬èº«è¯´èµ·ï¼Œæˆ‘ä»¬è¯´Undoé¡µé¢å…¶å®æ˜¯ç±»å‹ä¸ºFIL_PAGE_UNDO_LOGçš„é¡µé¢çš„ç®€ç§°ï¼Œè¯´åˆ°åº•å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ™®é€šçš„é¡µé¢ã€‚æˆ‘ä»¬å‰è¾¹è¯´è¿‡ï¼Œåœ¨ä¿®æ”¹é¡µé¢ä¹‹å‰ä¸€å®šè¦å…ˆæŠŠå¯¹åº”çš„redoæ—¥å¿—å†™ä¸Šï¼Œè¿™æ ·åœ¨ç³»ç»Ÿå¥”æºƒé‡å¯æ—¶æ‰èƒ½æ¢å¤åˆ°å¥”æºƒå‰çš„çŠ¶æ€ã€‚æˆ‘ä»¬å‘Undoé¡µé¢å†™å…¥undoæ—¥å¿—æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå†™é¡µé¢çš„è¿‡ç¨‹ï¼ŒInnoDBä¸ºæ­¤è¿˜è®¾è®¡äº†è®¸å¤šç§redoæ—¥å¿—çš„ç±»å‹ï¼Œæ¯”æ–¹è¯´MLOG_UNDO_HDR_CREATEã€MLOG_UNDO_INSERTã€MLOG_UNDO_INITç­‰ç­‰ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯¹Undoé¡µé¢åšçš„ä»»ä½•æ”¹åŠ¨éƒ½ä¼šè®°å½•ç›¸åº”ç±»å‹çš„redoæ—¥å¿—ã€‚ä½†æ˜¯å¯¹äºä¸´æ—¶è¡¨æ¥è¯´ï¼Œå› ä¸ºä¿®æ”¹ä¸´æ—¶è¡¨è€Œäº§ç”Ÿçš„undoæ—¥å¿—åªéœ€è¦åœ¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­æœ‰æ•ˆï¼Œå¦‚æœç³»ç»Ÿå¥”æºƒäº†ï¼Œé‚£ä¹ˆåœ¨é‡å¯æ—¶ä¹Ÿä¸éœ€è¦æ¢å¤è¿™äº›undoæ—¥å¿—æ‰€åœ¨çš„é¡µé¢ï¼Œæ‰€ä»¥åœ¨å†™é’ˆå¯¹ä¸´æ—¶è¡¨çš„Undoé¡µé¢æ—¶ï¼Œå¹¶ä¸éœ€è¦è®°å½•ç›¸åº”çš„redoæ—¥å¿—ã€‚æ€»ç»“ä¸€ä¸‹é’ˆå¯¹æ™®é€šè¡¨å’Œä¸´æ—¶è¡¨åˆ’åˆ†ä¸åŒç§ç±»çš„å›æ»šæ®µçš„åŸå› ï¼šåœ¨ä¿®æ”¹é’ˆå¯¹æ™®é€šè¡¨çš„å›æ»šæ®µä¸­çš„Undoé¡µé¢æ—¶ï¼Œéœ€è¦è®°å½•å¯¹åº”çš„redoæ—¥å¿—ï¼Œè€Œä¿®æ”¹é’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µä¸­çš„Undoé¡µé¢æ—¶ï¼Œä¸éœ€è¦è®°å½•å¯¹åº”çš„redoæ—¥å¿—ã€‚ å®é™…ä¸Šåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä»…ä»…å¯¹æ™®é€šè¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œé‚£ä¹ˆåªä¼šä¸ºè¯¥äº‹åŠ¡åˆ†é…é’ˆå¯¹æ™®é€šè¡¨çš„å›æ»šæ®µï¼Œä¸åˆ†é…é’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä»…ä»…å¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œé‚£ä¹ˆæ—¢ä¼šä¸ºè¯¥äº‹åŠ¡åˆ†é…é’ˆå¯¹æ™®é€šè¡¨çš„å›æ»šæ®µï¼Œåˆä¼šä¸ºå…¶åˆ†é…é’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µï¼ˆä¸è¿‡åˆ†é…äº†å›æ»šæ®µå¹¶ä¸ä¼šç«‹å³åˆ†é…undo slotï¼Œåªæœ‰åœ¨çœŸæ­£éœ€è¦Undoé¡µé¢é“¾è¡¨æ—¶æ‰ä¼šå»åˆ†é…å›æ»šæ®µä¸­çš„undo slotï¼‰ã€‚ 9.5ä¸ºäº‹åŠ¡åˆ†é…Undoé¡µé¢é“¾è¡¨è¯¦ç»†è¿‡ç¨‹æ¥ä¸‹æ¥ä»¥äº‹åŠ¡å¯¹æ™®é€šè¡¨çš„è®°å½•åšæ”¹åŠ¨ä¸ºä¾‹ï¼Œæ¢³ç†ä¸€ä¸‹äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ†é…Undoé¡µé¢é“¾è¡¨æ—¶çš„å®Œæ•´è¿‡ç¨‹ï¼š äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æ™®é€šè¡¨çš„è®°å½•é¦–æ¬¡åšæ”¹åŠ¨ä¹‹å‰ï¼Œé¦–å…ˆä¼šåˆ°ç³»ç»Ÿè¡¨ç©ºé—´çš„ç¬¬5å·é¡µé¢ä¸­åˆ†é…ä¸€ä¸ªå›æ»šæ®µï¼ˆå…¶å®å°±æ˜¯è·å–ä¸€ä¸ªRollback Segment Headeré¡µé¢çš„åœ°å€ï¼‰ã€‚ä¸€æ—¦æŸä¸ªå›æ»šæ®µè¢«åˆ†é…ç»™äº†è¿™ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆä¹‹åè¯¥äº‹åŠ¡ä¸­å†å¯¹æ™®é€šè¡¨çš„è®°å½•åšæ”¹åŠ¨æ—¶ï¼Œå°±ä¸ä¼šé‡å¤åˆ†é…äº†ã€‚ä½¿ç”¨round-robinï¼ˆå¾ªç¯ä½¿ç”¨ï¼‰æ–¹å¼æ¥åˆ†é…å›æ»šæ®µã€‚æ¯”å¦‚å½“å‰äº‹åŠ¡åˆ†é…äº†ç¬¬0å·å›æ»šæ®µï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªäº‹åŠ¡å°±è¦åˆ†é…ç¬¬33å·å›æ»šæ®µï¼Œä¸‹ä¸‹ä¸ªäº‹åŠ¡å°±è¦åˆ†é…ç¬¬34å·å›æ»šæ®µï¼Œç®€å•ä¸€ç‚¹çš„è¯´å°±æ˜¯è¿™äº›å›æ»šæ®µè¢«è½®ç€åˆ†é…ç»™ä¸åŒçš„äº‹åŠ¡ã€‚ åœ¨åˆ†é…åˆ°å›æ»šæ®µåï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªå›æ»šæ®µçš„ä¸¤ä¸ªcachedé“¾è¡¨æœ‰æ²¡æœ‰å·²ç»ç¼“å­˜äº†çš„undo slotï¼Œæ¯”å¦‚å¦‚æœäº‹åŠ¡åšçš„æ˜¯INSERTæ“ä½œï¼Œå°±å»å›æ»šæ®µå¯¹åº”çš„insert undo cachedé“¾è¡¨ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ç¼“å­˜çš„undo slotï¼›å¦‚æœäº‹åŠ¡åšçš„æ˜¯DELETEæ“ä½œï¼Œå°±å»å›æ»šæ®µå¯¹åº”çš„update undo cachedé“¾è¡¨ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ç¼“å­˜çš„undo slotã€‚å¦‚æœæœ‰ç¼“å­˜çš„undo slotï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªç¼“å­˜çš„undo slotåˆ†é…ç»™è¯¥äº‹åŠ¡ã€‚ å¦‚æœæ²¡æœ‰ç¼“å­˜çš„undo slotå¯ä¾›åˆ†é…ï¼Œé‚£ä¹ˆå°±è¦åˆ°Rollback Segment Headeré¡µé¢ä¸­æ‰¾ä¸€ä¸ªå¯ç”¨çš„undo slotåˆ†é…ç»™å½“å‰äº‹åŠ¡ã€‚ä»Rollback Segment Headeré¡µé¢ä¸­åˆ†é…å¯ç”¨çš„undo slotçš„æ–¹å¼æˆ‘ä»¬ä¸Šè¾¹ä¹Ÿè¯´è¿‡äº†ï¼Œå°±æ˜¯ä»ç¬¬0ä¸ªundo slotå¼€å§‹ï¼Œå¦‚æœè¯¥undo slotçš„å€¼ä¸ºFIL_NULLï¼Œæ„å‘³ç€è¿™ä¸ªundo slotæ˜¯ç©ºé—²çš„ï¼Œå°±æŠŠè¿™ä¸ªundo slotåˆ†é…ç»™å½“å‰äº‹åŠ¡ï¼Œå¦åˆ™æŸ¥çœ‹ç¬¬1ä¸ªundo slotæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ªundo slotã€‚å¦‚æœè¿™1024ä¸ªundo slotéƒ½æ²¡æœ‰å€¼ä¸ºFIL_NULLçš„æƒ…å†µï¼Œå°±ç›´æ¥æŠ¥é”™ï¼ˆä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼‰ã€‚ æ‰¾åˆ°å¯ç”¨çš„undo slotåï¼Œå¦‚æœè¯¥undo slotæ˜¯ä»cachedé“¾è¡¨ä¸­è·å–çš„ï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„Undo Log Segmentå·²ç»åˆ†é…äº†ï¼Œå¦åˆ™çš„è¯éœ€è¦é‡æ–°åˆ†é…ä¸€ä¸ªUndo Log Segmentï¼Œç„¶åä»è¯¥Undo Log Segmentä¸­ç”³è¯·ä¸€ä¸ªé¡µé¢ä½œä¸ºUndoé¡µé¢é“¾è¡¨çš„first undo pageã€‚ ç„¶åäº‹åŠ¡å°±å¯ä»¥æŠŠundoæ—¥å¿—å†™å…¥åˆ°ä¸Šè¾¹ç”³è¯·çš„Undoé¡µé¢é“¾è¡¨äº†ï¼ å¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšæ”¹åŠ¨çš„æ­¥éª¤å’Œä¸Šè¿°çš„ä¸€æ ·ã€‚ä¸è¿‡éœ€è¦å†æ¬¡å¼ºè°ƒä¸€æ¬¡ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢å¯¹æ™®é€šè¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œåˆå¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œé‚£ä¹ˆéœ€è¦ä¸ºè¿™ä¸ªè®°å½•åˆ†é…2ä¸ªå›æ»šæ®µã€‚å¹¶å‘æ‰§è¡Œçš„ä¸åŒäº‹åŠ¡å…¶å®ä¹Ÿå¯ä»¥è¢«åˆ†é…ç›¸åŒçš„å›æ»šæ®µï¼Œåªè¦åˆ†é…ä¸åŒçš„undo slotå°±å¯ä»¥äº†ã€‚ 10.å›æ»šæ®µç›¸å…³é…ç½®10.1é…ç½®å›æ»šæ®µæ•°é‡ç³»ç»Ÿä¸­ä¸€å…±æœ‰128ä¸ªå›æ»šæ®µï¼Œå…¶å®è¿™åªæ˜¯é»˜è®¤å€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°innodb_rollback_segmentsæ¥é…ç½®å›æ»šæ®µçš„æ•°é‡ï¼Œå¯é…ç½®çš„èŒƒå›´æ˜¯1~128ã€‚ä½†æ˜¯è¿™ä¸ªå‚æ•°å¹¶ä¸ä¼šå½±å“é’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µæ•°é‡ï¼Œé’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µæ•°é‡ä¸€ç›´æ˜¯32ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š å¦‚æœæˆ‘ä»¬æŠŠinnodb_rollback_segmentsçš„å€¼è®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆåªä¼šæœ‰1ä¸ªé’ˆå¯¹æ™®é€šè¡¨çš„å¯ç”¨å›æ»šæ®µï¼Œä½†æ˜¯ä»ç„¶æœ‰32ä¸ªé’ˆå¯¹ä¸´æ—¶è¡¨çš„å¯ç”¨å›æ»šæ®µã€‚ å¦‚æœæˆ‘ä»¬æŠŠinnodb_rollback_segmentsçš„å€¼è®¾ç½®ä¸º2ï½33ä¹‹é—´çš„æ•°ï¼Œæ•ˆæœå’Œå°†å…¶è®¾ç½®ä¸º1æ˜¯ä¸€æ ·çš„ã€‚ å¦‚æœæˆ‘ä»¬æŠŠinnodb_rollback_segmentsè®¾ç½®ä¸ºå¤§äº33çš„æ•°ï¼Œé‚£ä¹ˆé’ˆå¯¹æ™®é€šè¡¨çš„å¯ç”¨å›æ»šæ®µæ•°é‡å°±æ˜¯è¯¥å€¼å‡å»32ã€‚ 10.2 é…ç½®undoè¡¨ç©ºé—´é»˜è®¤æƒ…å†µä¸‹ï¼Œé’ˆå¯¹æ™®é€šè¡¨è®¾ç«‹çš„å›æ»šæ®µï¼ˆç¬¬0å·ä»¥åŠç¬¬33~127å·å›æ»šæ®µï¼‰éƒ½æ˜¯è¢«åˆ†é…åˆ°ç³»ç»Ÿè¡¨ç©ºé—´çš„ã€‚å…¶ä¸­çš„ç¬¬0å·å›æ»šæ®µæ˜¯ä¸€ç›´åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ï¼Œä½†æ˜¯ç¬¬33~127å·å›æ»šæ®µå¯ä»¥é€šè¿‡é…ç½®æ”¾åˆ°è‡ªå®šä¹‰çš„undoè¡¨ç©ºé—´ä¸­ã€‚ä½†æ˜¯è¿™ç§é…ç½®åªèƒ½åœ¨ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆåˆ›å»ºæ•°æ®ç›®å½•æ—¶ï¼‰çš„æ—¶å€™ä½¿ç”¨ï¼Œä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œä¹‹åå°±ä¸èƒ½å†æ¬¡æ›´æ”¹äº†ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ç›¸å…³å¯åŠ¨å‚æ•°ï¼š é€šè¿‡innodb_undo_directoryæŒ‡å®šundoè¡¨ç©ºé—´æ‰€åœ¨çš„ç›®å½•ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šè¯¥å‚æ•°ï¼Œåˆ™é»˜è®¤undoè¡¨ç©ºé—´æ‰€åœ¨çš„ç›®å½•å°±æ˜¯æ•°æ®ç›®å½•ã€‚ é€šè¿‡innodb_undo_tablespaceså®šä¹‰undoè¡¨ç©ºé—´çš„æ•°é‡ã€‚è¯¥å‚æ•°çš„é»˜è®¤å€¼ä¸º0ï¼Œè¡¨æ˜ä¸åˆ›å»ºä»»ä½•undoè¡¨ç©ºé—´ã€‚ç¬¬33~127å·å›æ»šæ®µå¯ä»¥å¹³å‡åˆ†å¸ƒåˆ°ä¸åŒçš„undoè¡¨ç©ºé—´ä¸­ã€‚ å¦‚æœæˆ‘ä»¬åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™æŒ‡å®šäº†åˆ›å»ºäº†undoè¡¨ç©ºé—´ï¼Œé‚£ä¹ˆç³»ç»Ÿè¡¨ç©ºé—´ä¸­çš„ç¬¬0å·å›æ»šæ®µå°†å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚ æ¯”å¦‚æˆ‘ä»¬åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶æŒ‡å®šçš„innodb_rollback_segmentsä¸º35ï¼Œinnodb_undo_tablespacesä¸º2ï¼Œè¿™æ ·å°±ä¼šå°†ç¬¬33ã€34å·å›æ»šæ®µåˆ†åˆ«åˆ†å¸ƒåˆ°ä¸€ä¸ªundoè¡¨ç©ºé—´ä¸­ã€‚ è®¾ç«‹undoè¡¨ç©ºé—´çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯åœ¨undoè¡¨ç©ºé—´ä¸­çš„æ–‡ä»¶å¤§åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨çš„å°†è¯¥undoè¡¨ç©ºé—´æˆªæ–­ï¼ˆtruncateï¼‰æˆä¸€ä¸ªå°æ–‡ä»¶ã€‚è€Œç³»ç»Ÿè¡¨ç©ºé—´çš„å¤§å°åªèƒ½ä¸æ–­çš„å¢å¤§ï¼Œå´ä¸èƒ½æˆªæ–­ã€‚ 11.æ€»ç»“ä¸ºäº†ä¿è¯äº‹åŠ¡çš„åŸå­æ€§è®¾è®¡ï¼ŒInnoDBå¼•å…¥äº†undoæ—¥å¿—ã€‚undoæ—¥å¿—è®°è½½äº†å›æ»šä¸€ä¸ªæ®µæ‰€éœ€çš„å¿…è¦å†…å®¹ã€‚ åœ¨äº‹åŠ¡å¯¹è¡¨ä¸­çš„è®°å½•è¿›è¡Œæ”¹åŠ¨çš„æ—¶å€™ï¼Œæ‰ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„IDã€‚äº‹åŠ¡IDå€¼æ˜¯ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚å…ˆè¢«åˆ†é…IDçš„äº‹åŠ¡å¾—åˆ°çš„æ˜¯è¾ƒå°çš„äº‹åŠ¡IDï¼Œåè¢«åˆ†é…IDçš„äº‹åŠ¡å¾—åˆ°çš„æ˜¯è¾ƒå¤§çš„äº‹åŠ¡IDã€‚æœªè¢«åˆ†é…äº‹åŠ¡IDçš„äº‹åŠ¡IDé»˜è®¤æ˜¯0ã€‚èšç°‡ç´¢å¼•è®°å½•ä¸­æœ‰ä¸€ä¸ªtrx_idéšè—åˆ—ï¼Œä»–ä»£è¡¨å¯¹è¿™ä¸ªèšç°‡ç´¢å¼•éšè—è®°å½•è¿›è¡Œæ”¹åŠ¨çš„è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡å¯¹åº”çš„äº‹åŠ¡IDã€‚ InnoDBé’ˆå¯¹ä¸åŒçš„åœºæ™¯è®¾è®¡äº†ä¸åŒç±»å‹çš„undoæ—¥å¿—ã€‚ ç±»å‹ä¸ºFIL_PAGE_UNDO_LOGçš„é¡µé¢æ˜¯ä¸“é—¨ç”¨æ¥å­˜å‚¨undoæ—¥å¿—çš„ï¼Œç®€ç§°ä¸ºundoé¡µé¢ã€‚ åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ€å¤šåˆ†é…å››ä¸ªundoé¡µé¢é“¾è¡¨ï¼š é’ˆå¯¹æ™®é€šè¡¨çš„insert undoé“¾è¡¨ é’ˆå¯¹æ™®é€šè¡¨çš„update undoé“¾è¡¨ é’ˆå¯¹ä¸´æ—¶è¡¨çš„insert undoé“¾è¡¨ é’ˆå¯¹ä¸´æ—¶è¡¨çš„update undoé“¾è¡¨ åªæœ‰åœ¨çœŸæ­£ç”¨åˆ°è¿™äº›é“¾è¡¨çš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºä»–ä»¬ã€‚ æ¯ä¸ªundoé¡µé¢é“¾è¡¨éƒ½å¯¹åº”ä¸€ä¸ªundo log segmentã€‚undoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢ä¸­æœ‰ä¸€ä¸ªåä¸ºundo log segment header çš„éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨å…³äºè¿™ä¸ªæ®µçš„ä¸€äº›ä¿¡æ¯ã€‚ åŒä¸€ä¸ªäº‹åŠ¡å‘ä¸€ä¸ªundoé¡µé¢é“¾è¡¨ä¸­å†™å…¥çš„undoæ—¥å¿—ç®—æ˜¯ä¸€ä¸ªç»„ï¼Œæ¯ä¸ªç»„éƒ½ä»¥ä¸€ä¸ªundo log headeréƒ¨åˆ†å¼€å¤´ã€‚ ä¸€ä¸ªundoé¡µé¢é“¾è¡¨å¦‚æœå¯ä»¥è¢«é‡ç”¨ï¼Œéœ€è¦ç¬¦åˆä¸¤ä¸ªæ¡ä»¶ï¼š è¯¥é“¾è¡¨åªåŒ…å«ä¸€ä¸ªundoé¡µé¢ è¯¥undoé¡µé¢å·²ç»ä½¿ç”¨çš„ç©ºé—´å°äºæ•´ä¸ªé¡µé¢ç©ºé—´çš„3/4 æ¯ä¸€ä¸ªRollback segmrnt header é¡µé¢éƒ½å¯¹åº”ä¸€ä¸ªå›æ»šæ®µï¼Œæ¯ä¸ªå›æ»šæ®µåŒ…å«1024ä¸ªundo slotï¼Œä¸€ä¸ªundo slotä»£è¡¨ä¸€ä¸ªundoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢çš„é¡µå·ã€‚ç›®å‰ï¼ŒInnoDBæœ€å¤šæ”¯æŒ128ä¸ªå›æ»šæ®µï¼Œå…¶ä¸­ç¬¬0å·ï¼Œç¬¬33127å·å›æ»šæ®µæ˜¯é’ˆå¯¹æ™®é€šè¡¨è®¾è®¡çš„ï¼Œç¬¬132å·å›æ»šæ®µæ˜¯é’ˆå¯¹ä¸´æ—¶è¡¨è®¾è®¡çš„ã€‚ æˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†undoæ—¥å¿—è®°å½•åˆ°ä¸“é—¨çš„undoè¡¨ç©ºé—´ä¸­ï¼Œåœ¨undoè¡¨ç©ºé—´ä¸­çš„æ–‡ä»¶å¤§åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨å°†è¯¥undoè¡¨ç©ºé—´æˆªæ–­ä¸ºå°æ–‡ä»¶ã€‚","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"redolog","slug":"7.mysql/redoæ—¥å¿—","date":"2021-12-26T16:00:00.000Z","updated":"2024-08-22T03:23:14.707Z","comments":true,"path":"2021/12/27/7.mysql/redoæ—¥å¿—/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/27/7.mysql/redo%E6%97%A5%E5%BF%97/","excerpt":"","text":"ä¸€ï¼Œä»€ä¹ˆæ˜¯redoæ—¥å¿—InnoDBå­˜å‚¨å¼•æ“æ˜¯ä»¥é¡µä¸ºå•ä½æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œæˆ‘ä»¬çš„CRUDæ“ä½œå…¶å®éƒ½æ˜¯åœ¨è®¿é—®é¡µé¢ã€‚åœ¨çœŸæ­£è®¿é—®é¡µé¢ä¹‹å‰ï¼Œéœ€è¦æŠŠç£ç›˜ä¸­çš„é¡µåŠ è½½åˆ°å†…å­˜çš„BufferPoolï¼Œä¹‹åæ‰èƒ½è®¿é—®ï¼Œä½†æ˜¯å› ä¸ºäº‹åŠ¡è¦ä¿æŒæŒä¹…æ€§ï¼Œå¦‚æœæˆ‘ä»¬ä»…ä»…åœ¨å†…å­˜çš„ç¼“å†²æ± ä¿®æ”¹äº†é¡µé¢ï¼Œå‡è®¾äº‹åŠ¡æäº¤åçªç„¶å‘ç”Ÿæ•…éšœï¼Œå¯¼è‡´å†…å­˜çš„æ•°æ®éƒ½æ¶ˆå¤±äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå·²ç»æäº¤çš„äº‹åŠ¡åœ¨æ•°æ®åº“åšçš„æ›´æ”¹å°±ä¸¢å¤±äº†ã€‚ å¦‚ä½•ä¿è¯æŒä¹…æ€§å‘¢ï¼Ÿå¯ä»¥åœ¨äº‹åŠ¡æäº¤å®Œæˆä¹‹å‰ï¼ŒæŠŠäº‹åŠ¡ä¿®æ”¹çš„æ‰€æœ‰é¡µé¢éƒ½åˆ·æ–°åˆ°ç£ç›˜ã€‚ä¸è¿‡è¿™æ ·åšå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š åˆ·æ–°ä¸€ä¸ªå®Œæ•´çš„æ•°æ®é¡µè¿‡äºæµªè´¹ éšæœºIOæ•ˆç‡æ¯”è¾ƒä½ äº‹å®ä¸Šä»…ä»…æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œæ²¡æœ‰å¿…è¦æ¯æ¬¡æäº¤äº‹åŠ¡çš„æ—¶å€™å°±æŠŠè¯¥äº‹åŠ¡åœ¨å†…å­˜ä¿®æ”¹è¿‡çš„å…¨éƒ¨é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œåªéœ€è¦æŠŠä¿®æ”¹çš„å†…å®¹è®°å½•ä¸€ä¸‹å°±å¥½ï¼Œè¿™æ ·åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªè®°å½•åˆ·æ–°åˆ°ç£ç›˜ã€‚å³ä½¿ç³»ç»Ÿå› ä¸ºå´©æºƒè€Œé‡å¯åªéœ€è¦æŒ‰ç…§è®°å½•çš„å†…å®¹é‡æ–°æ›´æ–°æ•°æ®é¡µå³å¯æ¢å¤æ•°æ®ï¼Œä¸Šè¿°è®°å½•ä¿®æ”¹çš„å†…å®¹å°±å«åšé‡åšæ—¥å¿—ï¼ˆredo logï¼‰ã€‚ ç›¸æ¯”äºåœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„å†…å­˜ä¸­çš„é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‡åšæ—¥å¿—æœ‰ä»¥ä¸‹å¥½å¤„ï¼š redoæ—¥å¿—å ç”¨ç©ºé—´å°ï¼šåœ¨å­˜å‚¨è¡¨ç©ºé—´IDï¼Œé¡µå·ï¼Œåç§»é‡ä»¥åŠéœ€è¦æ›´æ–°çš„å€¼æ—¶ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´å¾ˆå°ã€‚ redoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„ï¼šåœ¨æ‰§è¡Œäº‹åŠ¡è¿‡ç¨‹ä¸­ï¼Œæ¯æ‰§è¡Œä¸€æ¡è¯­å¥ï¼Œå°±å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—æ˜¯æŒ‰ç…§äº§ç”Ÿçš„é¡ºåºå†™å…¥ç£ç›˜çš„ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é¡ºåºIOã€‚ äºŒï¼Œredoæ—¥å¿—æ ¼å¼é‡åšæ—¥å¿—æœ¬è´¨ä¸Šä»…ä»…æ˜¯è®°å½•äº†ä¸€ä¸‹äº‹åŠ¡å¯¹æ•°æ®åº“è¿›è¡Œäº†å“ªäº›ä¿®æ”¹ã€‚é’ˆå¯¹äº‹åŠ¡å¯¹æ•°æ®åº“çš„ä¸åŒä¿®æ”¹åœºæ™¯MySQLå®šä¹‰äº†å¾ˆå¤šç§é‡åšæ—¥å¿—ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†ç±»å‹çš„é‡åšæ—¥å¿—éƒ½æœ‰ä»¥ä¸‹çš„é€šç”¨ç»“æ„ã€‚ type é‡åšæ—¥å¿—çš„ç±»å‹ space ID è¡¨ç©ºé—´ID page number é¡µå· Data æ—¥å¿—çš„å…·ä½“å†…å®¹ 1. ç®€å•çš„redoæ—¥å¿—ç±»å‹è¡Œæ ¼å¼é‡Œé¢æœ‰ä¸€ä¸ªéšè—åˆ—å«åšrow_idã€‚ä¸ºrow_idè¿›è¡Œèµ‹å€¼çš„æ–¹å¼å¦‚ä¸‹ï¼š æœåŠ¡å™¨ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ¯å½“åƒæŸä¸ªåŒ…å«row_idéšè—åˆ—çš„è¡¨æ’å…¥ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå…¨å±€å˜é‡çš„å€¼å½“åšæ–°è®°å½•row_idçš„å€¼ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªå…¨å±€å˜é‡è‡ªå¢1ã€‚ æ¯å½“è¿™ä¸ªå…¨å±€å˜é‡çš„å€¼æ˜¯256çš„æ•´æ•°å€çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå˜é‡çš„å€¼åˆ·æ–°åˆ°ç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢ä¸­ä¸€ä¸ªå«åšMax Row IDçš„å±æ€§ä¸­ã€‚ å½“ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå°†Max Row IDå±æ€§åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶æŠŠè¿™ä¸ªå€¼åŠ ä¸Š256ä¹‹åèµ‹å€¼ç»™å‰é¢æåˆ°çš„å…¨å±€å˜é‡ã€‚ è¿™ä¸ªMax Row IDå ç”¨çš„å­˜å‚¨ç©ºé—´æ˜¯8å­—èŠ‚ã€‚å½“æŸä¸ªäº‹åŠ¡å‘æŸä¸ªåŒ…å«row_idçš„è¡¨æ’å…¥ä¸€æ¡è®°å½•å¹¶ä¸”è¯¥è®°å½•åˆ†é…çš„row_idå€¼ä¸º256çš„æ•´æ•°å€çš„æ—¶å€™ï¼Œå°±ä¼šåƒç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢çš„ç›¸åº”åç§»é‡å¤„å†™å…¥8å­—èŠ‚çš„å€¼ã€‚ä½†æ˜¯è¿™ä¸ªå†™å…¥æ“ä½œå®é™…ä¸Šæ˜¯åœ¨å†…å­˜ç¼“å†²åŒºå®Œæˆçš„ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™æ¬¡ä¿®æ”¹ä»¥redoæ—¥å¿—çš„å½¢å¼è®°å½•ä¸‹æ¥ï¼Œè¿™æ ·åœ¨äº‹åŠ¡æäº¤ä¹‹åï¼Œå³ä½¿ç³»ç»Ÿå´©æºƒï¼Œä¹Ÿå¯ä»¥å°†è¯¥é¡µé¢æ¢å¤æˆå´©æºƒå‰çš„çŠ¶æ€ã€‚åœ¨è¿™ç§å¯¹é¡µé¢çš„ä¿®æ”¹ç‰¹åˆ«ç®€å•çš„æ—¶å€™ï¼Œé‡åšæ—¥å¿—ä»…ä»…éœ€è¦è®°å½•ä¸€ä¸‹åœ¨æŸä¸ªé¡µé¢çš„æŸä¸ªåç§»é‡å¤„ä¿®æ”¹äº†å‡ ä¸ªå­—èŠ‚çš„å€¼ï¼Œå…·ä½“ä¿®æ”¹åçš„å†…å®¹æ˜¯ä»€ä¹ˆå°±å¯ä»¥äº†ã€‚è¿™ä¹Ÿå«åšç‰©ç†æ—¥å¿—ã€‚ offsetè¡¨ç¤ºé¡µé¢ä¸­çš„åç§»é‡ã€‚å¦‚æœå†™å…¥çš„æ˜¯å­—èŠ‚åºåˆ—ç±»å‹çš„é‡åšæ—¥å¿—ï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ªlenå±æ€§è®°å½•å®é™…å†™å…¥çš„é•¿åº¦ã€‚ 2.å¤æ‚çš„redoæ—¥å¿—ç±»å‹æœ‰æ—¶å€™æ‰§è¡Œä¸€æ¡è¯­å¥ä¼šä¿®æ”¹éå¸¸å¤šçš„é¡µé¢ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ•°æ®é¡µé¢å’Œç”¨æˆ·æ•°æ®é¡µé¢ï¼ˆç”¨æˆ·æ•°æ®æŒ‡çš„å°±æ˜¯èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•å¯¹åº”çš„B+æ ‘ï¼‰ è¿™æ—¶æˆ‘ä»¬å¦‚æœä½¿ç”¨ç®€å•çš„ç‰©ç†redoæ—¥å¿—æ¥è®°å½•è¿™äº›ä¿®æ”¹æ—¶ï¼Œå¯ä»¥æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š æ–¹æ¡ˆä¸€ï¼šåœ¨æ¯ä¸ªä¿®æ”¹çš„åœ°æ–¹éƒ½è®°å½•ä¸€æ¡redoæ—¥å¿—ã€‚ä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªä¿®æ”¹çš„è®°å½•ï¼Œå°±å†™å¤šå°‘æ¡ç‰©ç†redoæ—¥å¿—ã€‚è¿™æ ·å­è®°å½•redoæ—¥å¿—çš„ç¼ºç‚¹æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå› ä¸ºè¢«ä¿®æ”¹çš„åœ°æ–¹æ˜¯åœ¨å¤ªå¤šäº†ï¼Œå¯èƒ½è®°å½•çš„redoæ—¥å¿—å ç”¨çš„ç©ºé—´éƒ½æ¯”æ•´ä¸ªé¡µé¢å ç”¨çš„ç©ºé—´éƒ½å¤šã€‚ æ–¹æ¡ˆäºŒï¼šå°†æ•´ä¸ªé¡µé¢çš„ç¬¬ä¸€ä¸ªè¢«ä¿®æ”¹çš„å­—èŠ‚åˆ°æœ€åä¸€ä¸ªä¿®æ”¹çš„å­—èŠ‚ä¹‹é—´æ‰€æœ‰çš„æ•°æ®å½“æˆæ˜¯ä¸€æ¡ç‰©ç†redoæ—¥å¿—ä¸­çš„å…·ä½“æ•°æ®ã€‚ç¬¬ä¸€ä¸ªè¢«ä¿®æ”¹çš„å­—èŠ‚åˆ°æœ€åä¸€ä¸ªä¿®æ”¹çš„å­—èŠ‚ä¹‹é—´ä»ç„¶æœ‰è®¸å¤šæ²¡æœ‰ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œæˆ‘ä»¬æŠŠè¿™äº›æ²¡æœ‰ä¿®æ”¹çš„æ•°æ®ä¹ŸåŠ å…¥åˆ°redoæ—¥å¿—ä¸­å¤ªæµªè´¹äº†ã€‚ æ­£å› ä¸ºä¸Šè¿°ä¸¤ç§ä½¿ç”¨ç‰©ç†redoæ—¥å¿—çš„æ–¹å¼æ¥è®°å½•æŸä¸ªé¡µé¢ä¸­åšäº†å“ªäº›ä¿®æ”¹æ¯”è¾ƒæµªè´¹ï¼ŒInnoDBæå‡ºäº†ä¸€äº›æ–°çš„redoæ—¥å¿—ç±»å‹ã€‚ è¿™äº›ç±»å‹çš„redoæ—¥å¿—æ—¢åŒ…å«ç‰©ç†å±‚é¢çš„æ„æ€ï¼Œä¹ŸåŒ…å«é€»è¾‘å±‚é¢çš„æ„æ€ï¼Œå…·ä½“æŒ‡ï¼š ç‰©ç†å±‚é¢çœ‹ï¼Œè¿™äº›æ—¥å¿—éƒ½æŒ‡æ˜äº†å¯¹å“ªä¸ªè¡¨ç©ºé—´çš„å“ªä¸ªé¡µè¿›è¡Œäº†ä¿®æ”¹ã€‚ é€»è¾‘å±‚é¢çœ‹ï¼Œåœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶ï¼Œå¹¶ä¸èƒ½ç›´æ¥æ ¹æ®è¿™äº›æ—¥å¿—é‡Œçš„è®°è½½ï¼Œå°†é¡µé¢å†…çš„æŸä¸ªåç§»é‡å¤„æ¢å¤æˆæŸä¸ªæ•°æ®ï¼Œè€Œæ˜¯éœ€è¦è°ƒç”¨ä¸€äº›äº‹å…ˆå‡†å¤‡å¥½çš„å‡½æ•°ï¼Œæ‰§è¡Œå®Œè¿™äº›å‡½æ•°åæ‰å¯ä»¥å°†é¡µé¢æ¢å¤æˆç³»ç»Ÿå´©æºƒå‰çš„æ ·å­ã€‚ è¿™ä¸ªç±»å‹ä¸ºMLOG_COMP_REC_INSERTçš„redoæ—¥å¿—å¹¶æ²¡æœ‰è®°å½•PAGE_N_DIR_SLOTSçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆï¼ŒPAGE_HEAP_TOPçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆï¼ŒPAGE_N_HEAPçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆç­‰ç­‰è¿™äº›ä¿¡æ¯ï¼Œè€Œåªæ˜¯æŠŠåœ¨æœ¬é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ‰€æœ‰å¿…å¤‡çš„è¦ç´ è®°äº†ä¸‹æ¥ï¼Œä¹‹åç³»ç»Ÿå´©æºƒé‡å¯æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè°ƒç”¨ç›¸å…³å‘æŸä¸ªé¡µé¢æ’å…¥ä¸€æ¡è®°å½•çš„é‚£ä¸ªå‡½æ•°ï¼Œè€Œredoæ—¥å¿—ä¸­çš„é‚£äº›æ•°æ®å°±å¯ä»¥è¢«å½“æˆæ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æ‰€éœ€çš„å‚æ•°ï¼Œåœ¨è°ƒç”¨å®Œè¯¥å‡½æ•°åï¼Œé¡µé¢ä¸­çš„PAGE_N_DIR_SLOTSã€PAGE_HEAP_TOPã€PAGE_N_HEAPç­‰ç­‰çš„å€¼ä¹Ÿå°±éƒ½è¢«æ¢å¤åˆ°ç³»ç»Ÿå´©æºƒå‰çš„æ ·å­äº†ã€‚è¿™å°±æ˜¯æ‰€è°“çš„é€»è¾‘æ—¥å¿—çš„æ„æ€ã€‚ æ—¥å¿—æ ¼å¼è¯´äº†ä¸€å †æ ¸å¿ƒå…¶å®å°±æ˜¯ï¼šé‡åšæ—¥å¿—ä¼šæŠŠäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æ•°æ®åº“æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹éƒ½è®°å½•ä¸‹æ¥ï¼Œåœ¨ä¹‹åç³»ç»Ÿå› ä¸ºå´©æºƒè€Œé‡å¯åå¯ä»¥æŠŠäº‹åŠ¡æ‰€åšçš„ä»»ä½•ä¿®æ”¹éƒ½æ¢å¤è¿‡æ¥ã€‚ ä¸ºäº†èŠ‚çœé‡åšæ—¥å¿—å ç”¨çš„ç©ºé—´å¤§å°ï¼ŒInnoDBè¿˜å¯¹é‡åšæ—¥å¿—ä¸­çš„æŸäº›æ•°æ®è¿›è¡Œäº†å‹ç¼©å¤„ç†ï¼Œæ¯”å¦‚è¡¨ç©ºé—´ID&amp;page number ä¸€èˆ¬å ç”¨4å­—èŠ‚æ¥å­˜å‚¨ï¼Œä½†æ˜¯ç»è¿‡å‹ç¼©ä¹‹åå ç”¨çš„ç©ºé—´å°±æ›´å°äº†ã€‚ ä¸‰ï¼ŒMini-Transcation1.ä»¥ç»„çš„å½¢å¼å†™å…¥redoæ—¥å¿—è¯­å¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¿®æ”¹è‹¥å¹²ä¸ªé¡µé¢ã€‚æ¯”å¦‚æˆ‘ä»¬å‰è¾¹è¯´çš„ä¸€æ¡INSERTè¯­å¥å¯èƒ½ä¿®æ”¹ç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢çš„Max Row IDå±æ€§ï¼ˆå½“ç„¶ä¹Ÿå¯èƒ½æ›´æ–°åˆ«çš„ç³»ç»Ÿé¡µé¢ï¼Œåªä¸è¿‡æˆ‘ä»¬æ²¡æœ‰éƒ½åˆ—ä¸¾å‡ºæ¥è€Œå·²ï¼‰ï¼Œè¿˜ä¼šæ›´æ–°èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•å¯¹åº”B+æ ‘ä¸­çš„é¡µé¢ã€‚ç”±äºå¯¹è¿™äº›é¡µé¢çš„æ›´æ”¹éƒ½å‘ç”Ÿåœ¨Buffer Poolä¸­ï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹å®Œé¡µé¢ä¹‹åï¼Œéœ€è¦è®°å½•ä¸€ä¸‹ç›¸åº”çš„redoæ—¥å¿—ã€‚åœ¨æ‰§è¡Œè¯­å¥çš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoæ—¥å¿—è¢«InnoDBäººä¸ºçš„åˆ’åˆ†æˆäº†è‹¥å¹²ä¸ªä¸å¯åˆ†å‰²çš„ç»„ï¼Œæ¯”å¦‚ï¼š æ›´æ–°Max Row IDå±æ€§æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ å‘èšç°‡ç´¢å¼•å¯¹åº”B+æ ‘çš„é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ å‘æŸä¸ªäºŒçº§ç´¢å¼•å¯¹åº”B+æ ‘çš„é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ è¿˜æœ‰å…¶ä»–çš„ä¸€äº›å¯¹é¡µé¢çš„è®¿é—®æ“ä½œæ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ã€‚ã€‚ æ€ä¹ˆç†è§£è¿™ä¸ªä¸å¯åˆ†å‰²çš„æ„æ€å‘¢ï¼Ÿæˆ‘ä»¬ä»¥å‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘æ’å…¥ä¸€æ¡è®°å½•ä¸ºä¾‹ï¼Œåœ¨å‘B+æ ‘ä¸­æ’å…¥è¿™æ¡è®°å½•ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä½åˆ°è¿™æ¡è®°å½•åº”è¯¥è¢«æ’å…¥åˆ°å“ªä¸ªå¶å­èŠ‚ç‚¹ä»£è¡¨çš„æ•°æ®é¡µä¸­ï¼Œå®šä½åˆ°å…·ä½“çš„æ•°æ®é¡µä¹‹åï¼Œæœ‰ä¸¤ç§å¯èƒ½çš„æƒ…å†µï¼š æƒ…å†µä¸€ï¼šè¯¥æ•°æ®é¡µçš„å‰©ä½™çš„ç©ºé—²ç©ºé—´å……è¶³ï¼Œè¶³å¤Ÿå®¹çº³è¿™ä¸€æ¡å¾…æ’å…¥è®°å½•ï¼Œé‚£ä¹ˆäº‹æƒ…å¾ˆç®€å•ï¼Œç›´æ¥æŠŠè®°å½•æ’å…¥åˆ°è¿™ä¸ªæ•°æ®é¡µä¸­ï¼Œè®°å½•ä¸€æ¡ç±»å‹ä¸ºMLOG_COMP_REC_INSERTçš„redoæ—¥å¿—å°±å¥½äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç§°ä¹‹ä¸ºä¹è§‚æ’å…¥ã€‚å‡å¦‚æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘é•¿è¿™æ ·ï¼šç°åœ¨æˆ‘ä»¬è¦æ’å…¥ä¸€æ¡é”®å€¼ä¸º10çš„è®°å½•ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦è¢«æ’å…¥åˆ°é¡µbä¸­ï¼Œç”±äºé¡µbç°åœ¨æœ‰è¶³å¤Ÿçš„ç©ºé—´å®¹çº³ä¸€æ¡è®°å½•ï¼Œæ‰€ä»¥ç›´æ¥å°†è¯¥è®°å½•æ’å…¥åˆ°é¡µbä¸­å°±å¥½äº†ï¼Œå°±åƒè¿™æ ·ï¼š æƒ…å†µäºŒï¼šè¯¥æ•°æ®é¡µå‰©ä½™çš„ç©ºé—²ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆäº‹æƒ…å°±æ‚²å‰§äº†ï¼Œæˆ‘ä»¬å‰è¾¹è¯´è¿‡ï¼Œé‡åˆ°è¿™ç§æƒ…å†µè¦è¿›è¡Œæ‰€è°“çš„é¡µåˆ†è£‚æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ–°å»ºä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œç„¶åæŠŠåŸå…ˆæ•°æ®é¡µä¸­çš„ä¸€éƒ¨åˆ†è®°å½•å¤åˆ¶åˆ°è¿™ä¸ªæ–°çš„æ•°æ®é¡µä¸­ï¼Œç„¶åå†æŠŠè®°å½•æ’å…¥è¿›å»ï¼ŒæŠŠè¿™ä¸ªå¶å­èŠ‚ç‚¹æ’å…¥åˆ°å¶å­èŠ‚ç‚¹é“¾è¡¨ä¸­ï¼Œæœ€åè¿˜è¦åœ¨å†…èŠ‚ç‚¹ä¸­æ·»åŠ ä¸€æ¡ç›®å½•é¡¹è®°å½•æŒ‡å‘è¿™ä¸ªæ–°åˆ›å»ºçš„é¡µé¢ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹è¦å¯¹å¤šä¸ªé¡µé¢è¿›è¡Œä¿®æ”¹ï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šäº§ç”Ÿå¤šæ¡redoæ—¥å¿—ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç§°ä¹‹ä¸ºæ‚²è§‚æ’å…¥ã€‚å‡å¦‚æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘é•¿è¿™æ ·ï¼šç°åœ¨æˆ‘ä»¬è¦æ’å…¥ä¸€æ¡é”®å€¼ä¸º10çš„è®°å½•ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦è¢«æ’å…¥åˆ°é¡µbä¸­ï¼Œä½†æ˜¯ä»å›¾ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ­¤æ—¶é¡µbå·²ç»å¡æ»¡äº†è®°å½•ï¼Œæ²¡æœ‰æ›´å¤šçš„ç©ºé—²ç©ºé—´æ¥å®¹çº³è¿™æ¡æ–°è®°å½•äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œé¡µé¢çš„åˆ†è£‚æ“ä½œï¼Œå°±åƒè¿™æ ·ï¼šå¦‚æœä½œä¸ºå†…èŠ‚ç‚¹çš„é¡µaçš„å‰©ä½™ç©ºé—²ç©ºé—´ä¹Ÿä¸è¶³ä»¥å®¹çº³å¢åŠ ä¸€æ¡ç›®å½•é¡¹è®°å½•ï¼Œé‚£éœ€è¦ç»§ç»­åšå†…èŠ‚ç‚¹é¡µaçš„åˆ†è£‚æ“ä½œï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šä¿®æ”¹æ›´å¤šçš„é¡µé¢ï¼Œä»è€Œäº§ç”Ÿæ›´å¤šçš„redoæ—¥å¿—ã€‚å¦å¤–ï¼Œå¯¹äºæ‚²è§‚æ’å…¥æ¥è¯´ï¼Œç”±äºéœ€è¦æ–°ç”³è¯·æ•°æ®é¡µï¼Œè¿˜éœ€è¦æ”¹åŠ¨ä¸€äº›ç³»ç»Ÿé¡µé¢ï¼Œæ¯”æ–¹è¯´è¦ä¿®æ”¹å„ç§æ®µã€åŒºçš„ç»Ÿè®¡ä¿¡æ¯ä¿¡æ¯ï¼Œå„ç§é“¾è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¯”å¦‚ä»€ä¹ˆFREEé“¾è¡¨ã€FSP_FREE_FRAGé“¾è¡¨ç­‰ï¼Œæˆ‘ä»¬åœ¨ä»‹ç»è¡¨ç©ºé—´é‚£ä¸€ç¯‡ä¸­ä»‹ç»è¿‡çš„å„ç§ä¸œè¥¿)ï¼Œåæ­£æ€»å…±éœ€è¦è®°å½•çš„redoæ—¥å¿—æœ‰äºŒã€ä¸‰åæ¡ã€‚ å…¶å®ä¸å…‰æ˜¯æ‚²è§‚æ’å…¥ä¸€æ¡è®°å½•ä¼šç”Ÿæˆè®¸å¤šæ¡redoæ—¥å¿—ï¼ŒInnoDBä¸ºäº†å…¶ä»–çš„ä¸€äº›åŠŸèƒ½ï¼Œåœ¨ä¹è§‚æ’å…¥æ—¶ä¹Ÿå¯èƒ½äº§ç”Ÿå¤šæ¡redoæ—¥å¿—ã€‚ InnoDBè®¤ä¸ºå‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ’å…¥ä¸€æ¡è®°å½•çš„è¿™ä¸ªè¿‡ç¨‹å¿…é¡»æ˜¯åŸå­çš„ï¼Œä¸èƒ½è¯´æ’äº†ä¸€åŠä¹‹åå°±åœæ­¢äº†ã€‚æ¯”æ–¹è¯´åœ¨æ‚²è§‚æ’å…¥è¿‡ç¨‹ä¸­ï¼Œæ–°çš„é¡µé¢å·²ç»åˆ†é…å¥½äº†ï¼Œæ•°æ®ä¹Ÿå¤åˆ¶è¿‡å»äº†ï¼Œæ–°çš„è®°å½•ä¹Ÿæ’å…¥åˆ°é¡µé¢ä¸­äº†ï¼Œå¯æ˜¯æ²¡æœ‰å‘å†…èŠ‚ç‚¹ä¸­æ’å…¥ä¸€æ¡ç›®å½•é¡¹è®°å½•ï¼Œè¿™ä¸ªæ’å…¥è¿‡ç¨‹å°±æ˜¯ä¸å®Œæ•´çš„ï¼Œè¿™æ ·ä¼šå½¢æˆä¸€æ£µä¸æ­£ç¡®çš„B+æ ‘ã€‚æˆ‘ä»¬çŸ¥é“redoæ—¥å¿—æ˜¯ä¸ºäº†åœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶æ¢å¤å´©æºƒå‰çš„çŠ¶æ€ï¼Œå¦‚æœåœ¨æ‚²è§‚æ’å…¥çš„è¿‡ç¨‹ä¸­åªè®°å½•äº†ä¸€éƒ¨åˆ†redoæ—¥å¿—ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶ä¼šå°†ç´¢å¼•å¯¹åº”çš„B+æ ‘æ¢å¤æˆä¸€ç§ä¸æ­£ç¡®çš„çŠ¶æ€ï¼Œè¿™æ˜¯InnoDBæ‰€ä¸èƒ½å¿å—çš„ã€‚æ‰€ä»¥ä»–ä»¬è§„å®šåœ¨æ‰§è¡Œè¿™äº›éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œæ—¶å¿…é¡»ä»¥ç»„çš„å½¢å¼æ¥è®°å½•çš„redoæ—¥å¿—ï¼Œåœ¨è¿›è¡Œç³»ç»Ÿå´©æºƒé‡å¯æ¢å¤æ—¶ï¼Œé’ˆå¯¹æŸä¸ªç»„ä¸­çš„redoæ—¥å¿—ï¼Œè¦ä¹ˆæŠŠå…¨éƒ¨çš„æ—¥å¿—éƒ½æ¢å¤æ‰ï¼Œè¦ä¹ˆä¸€æ¡ä¹Ÿä¸æ¢å¤ã€‚æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿè¿™å¾—åˆ†æƒ…å†µè®¨è®ºï¼š æœ‰çš„éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œä¼šç”Ÿæˆå¤šæ¡redoæ—¥å¿—ï¼Œæ¯”å¦‚å‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­è¿›è¡Œä¸€æ¬¡æ‚²è§‚æ’å…¥å°±éœ€è¦ç”Ÿæˆè®¸å¤šæ¡redoæ—¥å¿—ã€‚å¦‚ä½•æŠŠè¿™äº›redoæ—¥å¿—åˆ’åˆ†åˆ°ä¸€ä¸ªç»„é‡Œè¾¹å„¿å‘¢ï¼ŸInnoDBåšäº†ä¸€ä¸ªå¾ˆç®€å•çš„æ“ä½œï¼Œå°±æ˜¯åœ¨è¯¥ç»„ä¸­çš„æœ€åä¸€æ¡redoæ—¥å¿—åè¾¹åŠ ä¸Šä¸€æ¡ç‰¹æ®Šç±»å‹çš„redoæ—¥å¿—ï¼Œè¯¥ç±»å‹åç§°ä¸ºMLOG_MULTI_REC_ENDï¼Œtypeå­—æ®µå¯¹åº”çš„åè¿›åˆ¶æ•°å­—ä¸º31ï¼Œè¯¥ç±»å‹çš„redoæ—¥å¿—ç»“æ„å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªtypeå­—æ®µï¼šæ‰€ä»¥æŸä¸ªéœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œäº§ç”Ÿçš„ä¸€ç³»åˆ—redoæ—¥å¿—å¿…é¡»è¦ä»¥ä¸€ä¸ªç±»å‹ä¸ºMLOG_MULTI_REC_ENDç»“å°¾ï¼Œå°±åƒè¿™æ ·ï¼šè¿™æ ·åœ¨ç³»ç»Ÿå´©æºƒé‡å¯è¿›è¡Œæ¢å¤æ—¶ï¼Œåªæœ‰å½“è§£æåˆ°ç±»å‹ä¸ºMLOG_MULTI_REC_ENDçš„redoæ—¥å¿—ï¼Œæ‰è®¤ä¸ºè§£æåˆ°äº†ä¸€ç»„å®Œæ•´çš„redoæ—¥å¿—ï¼Œæ‰ä¼šè¿›è¡Œæ¢å¤ã€‚å¦åˆ™çš„è¯ç›´æ¥æ”¾å¼ƒå‰è¾¹è§£æåˆ°çš„redoæ—¥å¿—ã€‚ æœ‰çš„éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªç”Ÿæˆä¸€æ¡redoæ—¥å¿—ï¼Œæ¯”å¦‚æ›´æ–°Max Row IDå±æ€§çš„æ“ä½œå°±åªä¼šç”Ÿæˆä¸€æ¡redoæ—¥å¿—ã€‚å…¶å®åœ¨ä¸€æ¡æ—¥å¿—åè¾¹è·Ÿä¸€ä¸ªç±»å‹ä¸ºMLOG_MULTI_REC_ENDçš„redoæ—¥å¿—ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒInnoDBä¸æƒ³æµªè´¹ä¸€ä¸ªæ¯”ç‰¹ä½ã€‚è™½ç„¶redoæ—¥å¿—çš„ç±»å‹æ¯”è¾ƒå¤šï¼Œä½†æ’‘æ­»äº†ä¹Ÿå°±æ˜¯å‡ åç§ï¼Œæ˜¯å°äº127è¿™ä¸ªæ•°å­—çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç”¨7ä¸ªæ¯”ç‰¹ä½å°±è¶³ä»¥åŒ…æ‹¬æ‰€æœ‰çš„redoæ—¥å¿—ç±»å‹ï¼Œè€Œtypeå­—æ®µå…¶å®æ˜¯å ç”¨1ä¸ªå­—èŠ‚çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥çœå‡ºæ¥ä¸€ä¸ªæ¯”ç‰¹ä½ç”¨æ¥è¡¨ç¤ºè¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªäº§ç”Ÿå•ä¸€çš„ä¸€æ¡redoæ—¥å¿—ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼šå¦‚æœtypeå­—æ®µçš„ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½ä¸º1ï¼Œä»£è¡¨è¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªäº§ç”Ÿäº†å•ä¸€çš„ä¸€æ¡redoæ—¥å¿—ï¼Œå¦åˆ™è¡¨ç¤ºè¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œäº§ç”Ÿäº†ä¸€ç³»åˆ—çš„redoæ—¥å¿—ã€‚ 2.Mini-TransactionMySQLæŠŠå¯¹åº•å±‚é¡µé¢ä¸­çš„ä¸€æ¬¡åŸå­è®¿é—®çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºä¸€ä¸ªMini-Transactionï¼Œç®€ç§°mtrï¼Œæ¯”å¦‚ä¸Šè¾¹æ‰€è¯´çš„ä¿®æ”¹ä¸€æ¬¡Max Row IDçš„å€¼ç®—æ˜¯ä¸€ä¸ªMini-Transactionï¼Œå‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ’å…¥ä¸€æ¡è®°å½•çš„è¿‡ç¨‹ä¹Ÿç®—æ˜¯ä¸€ä¸ªMini-Transactionã€‚ä¸€ä¸ªæ‰€è°“çš„mtrå¯ä»¥åŒ…å«ä¸€ç»„redoæ—¥å¿—ï¼Œåœ¨è¿›è¡Œå´©æºƒæ¢å¤æ—¶è¿™ä¸€ç»„redoæ—¥å¿—ä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ã€‚ ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«è‹¥å¹²æ¡è¯­å¥ï¼Œæ¯ä¸€æ¡è¯­å¥å…¶å®æ˜¯ç”±è‹¥å¹²ä¸ªmtrç»„æˆï¼Œæ¯ä¸€ä¸ªmtråˆå¯ä»¥åŒ…å«è‹¥å¹²æ¡redoæ—¥å¿—ï¼Œç”»ä¸ªå›¾è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»å°±æ˜¯è¿™æ ·ï¼š å››ï¼Œredoæ—¥å¿—çš„å†™å…¥è¿‡ç¨‹1.redo log blockInnoDBä¸ºäº†æ›´å¥½çš„è¿›è¡Œç³»ç»Ÿå´©æºƒæ¢å¤ï¼Œä»–ä»¬æŠŠé€šè¿‡mtrç”Ÿæˆçš„redoæ—¥å¿—éƒ½æ”¾åœ¨äº†å¤§å°ä¸º512å­—èŠ‚çš„é¡µä¸­ã€‚ä¸ºäº†å’Œè¡¨ç©ºé—´ä¸­çš„é¡µåšåŒºåˆ«ï¼Œæˆ‘ä»¬è¿™é‡ŒæŠŠç”¨æ¥å­˜å‚¨redoæ—¥å¿—çš„é¡µç§°ä¸ºblockã€‚ä¸€ä¸ªredo log blockçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š çœŸæ­£çš„redoæ—¥å¿—éƒ½æ˜¯å­˜å‚¨åˆ°å ç”¨496å­—èŠ‚å¤§å°çš„log block bodyä¸­ï¼Œå›¾ä¸­çš„log block headerå’Œlog block trailerå­˜å‚¨çš„æ˜¯ä¸€äº›ç®¡ç†ä¿¡æ¯ã€‚ å…¶ä¸­log block headerçš„å‡ ä¸ªå±æ€§çš„æ„æ€åˆ†åˆ«å¦‚ä¸‹ï¼š LOG_BLOCK_HDR_NOï¼šæ¯ä¸€ä¸ªblockéƒ½æœ‰ä¸€ä¸ªå¤§äº0çš„å”¯ä¸€æ ‡å·ï¼Œæœ¬å±æ€§å°±è¡¨ç¤ºè¯¥æ ‡å·å€¼ã€‚ LOG_BLOCK_HDR_DATA_LENï¼šè¡¨ç¤ºblockä¸­å·²ç»ä½¿ç”¨äº†å¤šå°‘å­—èŠ‚ï¼Œåˆå§‹å€¼ä¸º12ï¼ˆå› ä¸ºlog block bodyä»ç¬¬12ä¸ªå­—èŠ‚å¤„å¼€å§‹ï¼‰ã€‚éšç€å¾€blockä¸­å†™å…¥çš„redoæ—¥å¿—è¶Šæ¥ä¹Ÿå¤šï¼Œæœ¬å±æ€§å€¼ä¹Ÿè·Ÿç€å¢é•¿ã€‚å¦‚æœlog block bodyå·²ç»è¢«å…¨éƒ¨å†™æ»¡ï¼Œé‚£ä¹ˆæœ¬å±æ€§çš„å€¼è¢«è®¾ç½®ä¸º512ã€‚ LOG_BLOCK_FIRST_REC_GROUPï¼šä¸€æ¡redoæ—¥å¿—ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºä¸€æ¡redoæ—¥å¿—è®°å½•ï¼ˆredo log recordï¼‰ï¼Œä¸€ä¸ªmträ¼šç”Ÿäº§å¤šæ¡redoæ—¥å¿—è®°å½•ï¼Œè¿™äº›redoæ—¥å¿—è®°å½•è¢«ç§°ä¹‹ä¸ºä¸€ä¸ªredoæ—¥å¿—è®°å½•ç»„ï¼ˆredo log record groupï¼‰ã€‚LOG_BLOCK_FIRST_REC_GROUPå°±ä»£è¡¨è¯¥blockä¸­ç¬¬ä¸€ä¸ªmtrç”Ÿæˆçš„redoæ—¥å¿—è®°å½•ç»„çš„åç§»é‡ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯è¿™ä¸ªblocké‡Œç¬¬ä¸€ä¸ªmtrç”Ÿæˆçš„ç¬¬ä¸€æ¡redoæ—¥å¿—çš„åç§»é‡ï¼‰ã€‚ LOG_BLOCK_CHECKPOINT_NOï¼šè¡¨ç¤ºæ‰€è°“çš„checkpointçš„åºå·ï¼Œcheckpointæ˜¯æˆ‘ä»¬åç»­å†…å®¹çš„é‡ç‚¹ï¼Œç°åœ¨å…ˆä¸ç”¨æ¸…æ¥šå®ƒçš„æ„æ€ï¼Œç¨å®‰å‹¿èºã€‚ log block trailerä¸­å±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š LOG_BLOCK_CHECKSUMï¼šè¡¨ç¤ºblockçš„æ ¡éªŒå€¼ï¼Œç”¨äºæ­£ç¡®æ€§æ ¡éªŒï¼Œæˆ‘ä»¬æš‚æ—¶ä¸å…³å¿ƒå®ƒã€‚ 2.redo æ—¥å¿—ç¼“å†²åŒºInnoDBä¸ºäº†è§£å†³ç£ç›˜é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜è€Œå¼•å…¥äº†Buffer Poolã€‚åŒç†ï¼Œå†™å…¥redoæ—¥å¿—æ—¶ä¹Ÿä¸èƒ½ç›´æ¥ç›´æ¥å†™åˆ°ç£ç›˜ä¸Šï¼Œå®é™…ä¸Šåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å°±å‘æ“ä½œç³»ç»Ÿç”³è¯·äº†ä¸€å¤§ç‰‡ç§°ä¹‹ä¸ºredo log bufferçš„è¿ç»­å†…å­˜ç©ºé—´ï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯redoæ—¥å¿—ç¼“å†²åŒºï¼Œä¹Ÿå¯ä»¥ç®€ç§°ä¸ºlog bufferã€‚è¿™ç‰‡å†…å­˜ç©ºé—´è¢«åˆ’åˆ†æˆè‹¥å¹²ä¸ªè¿ç»­çš„redo log blockï¼Œå°±åƒè¿™æ ·ï¼š æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°innodb_log_buffer_sizeæ¥æŒ‡å®šlog bufferçš„å¤§å°ï¼Œåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œè¯¥å¯åŠ¨å‚æ•°çš„é»˜è®¤å€¼ä¸º16MBã€‚ 3.redo log æ—¥å¿—å†™å…¥log bufferå‘log bufferä¸­å†™å…¥redoæ—¥å¿—çš„è¿‡ç¨‹æ˜¯é¡ºåºçš„ï¼Œä¹Ÿå°±æ˜¯å…ˆå¾€å‰è¾¹çš„blockä¸­å†™ï¼Œå½“è¯¥blockçš„ç©ºé—²ç©ºé—´ç”¨å®Œä¹‹åå†å¾€ä¸‹ä¸€ä¸ªblockä¸­å†™ã€‚å½“æˆ‘ä»¬æƒ³å¾€log bufferä¸­å†™å…¥redoæ—¥å¿—æ—¶ï¼Œç¬¬ä¸€ä¸ªé‡åˆ°çš„é—®é¢˜å°±æ˜¯åº”è¯¥å†™åœ¨å“ªä¸ªblockçš„å“ªä¸ªåç§»é‡å¤„ï¼Œæ‰€ä»¥InnoDBç‰¹æ„æä¾›äº†ä¸€ä¸ªç§°ä¹‹ä¸ºbuf_freeçš„å…¨å±€å˜é‡ï¼Œè¯¥å˜é‡æŒ‡æ˜åç»­å†™å…¥çš„redoæ—¥å¿—åº”è¯¥å†™å…¥åˆ°log bufferä¸­çš„å“ªä¸ªä½ç½®ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š ä¸€ä¸ªmtræ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›redoæ—¥å¿—æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„ç»„ï¼Œæ‰€ä»¥å…¶å®å¹¶ä¸æ˜¯æ¯ç”Ÿæˆä¸€æ¡redoæ—¥å¿—ï¼Œå°±å°†å…¶æ’å…¥åˆ°log bufferä¸­ï¼Œè€Œæ˜¯æ¯ä¸ªmtrè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ—¥å¿—å…ˆæš‚æ—¶å­˜åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œå½“è¯¥mtrç»“æŸçš„æ—¶å€™ï¼Œå°†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å†å…¨éƒ¨å¤åˆ¶åˆ°log bufferä¸­ã€‚æˆ‘ä»¬ç°åœ¨å‡è®¾æœ‰ä¸¤ä¸ªåä¸ºT1ã€T2çš„äº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½åŒ…å«2ä¸ªmtrï¼Œæˆ‘ä»¬ç»™è¿™å‡ ä¸ªmtrå‘½åä¸€ä¸‹ï¼š äº‹åŠ¡T1çš„ä¸¤ä¸ªmtråˆ†åˆ«ç§°ä¸ºmtr_T1_1å’Œmtr_T1_2ã€‚ äº‹åŠ¡T2çš„ä¸¤ä¸ªmtråˆ†åˆ«ç§°ä¸ºmtr_T2_1å’Œmtr_T2_2ã€‚ æ¯ä¸ªmtréƒ½ä¼šäº§ç”Ÿä¸€ç»„redoæ—¥å¿—ï¼Œä¸åŒçš„äº‹åŠ¡å¯èƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œæ‰€ä»¥T1ã€T2ä¹‹é—´çš„mtrå¯èƒ½æ˜¯äº¤æ›¿æ‰§è¡Œçš„ã€‚æ¯å½“ä¸€ä¸ªmtræ‰§è¡Œå®Œæˆæ—¶ï¼Œä¼´éšè¯¥mtrç”Ÿæˆçš„ä¸€ç»„redoæ—¥å¿—å°±éœ€è¦è¢«å¤åˆ¶åˆ°log bufferä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒäº‹åŠ¡çš„mtrå¯èƒ½æ˜¯äº¤æ›¿å†™å…¥log bufferçš„ï¼Œæˆ‘ä»¬ç”»ä¸ªç¤ºæ„å›¾ï¼ˆä¸ºäº†ç¾è§‚ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªmträ¸­äº§ç”Ÿçš„æ‰€æœ‰çš„redoæ—¥å¿—å½“ä½œä¸€ä¸ªæ•´ä½“æ¥ç”»ï¼‰ï¼š ä»ç¤ºæ„å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸åŒçš„mträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´å¯èƒ½ä¸ä¸€æ ·ï¼Œæœ‰çš„mträº§ç”Ÿçš„redoæ—¥å¿—é‡å¾ˆå°‘ï¼Œæ¯”å¦‚mtr_t1_1ã€mtr_t2_1å°±è¢«æ”¾åˆ°åŒä¸€ä¸ªblockä¸­å­˜å‚¨ï¼Œæœ‰çš„mträº§ç”Ÿçš„redoæ—¥å¿—é‡éå¸¸å¤§ï¼Œæ¯”å¦‚mtr_t1_2äº§ç”Ÿçš„redoæ—¥å¿—ç”šè‡³å ç”¨äº†3ä¸ªblockæ¥å­˜å‚¨ã€‚ äº”ï¼Œredo æ—¥å¿—æ–‡ä»¶1.redoæ—¥å¿—åˆ·ç›˜æ—¶æœºmtrè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—åœ¨mtrç»“æŸæ—¶ä¼šè¢«å¤åˆ¶åˆ°log buffer`ä¸­ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹å®ƒä»¬ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜é‡Œï¼Œæ¯”å¦‚ï¼š log bufferç©ºé—´ä¸è¶³æ—¶log bufferçš„å¤§å°æ˜¯æœ‰é™çš„ï¼ˆé€šè¿‡ç³»ç»Ÿå˜é‡innodb_log_buffer_sizeæŒ‡å®šï¼‰ï¼Œå¦‚æœä¸åœçš„å¾€è¿™ä¸ªæœ‰é™å¤§å°çš„log bufferé‡Œå¡å…¥æ—¥å¿—ï¼Œå¾ˆå¿«å®ƒå°±ä¼šè¢«å¡«æ»¡ã€‚InnoDBè®¤ä¸ºå¦‚æœå½“å‰å†™å…¥log bufferçš„redoæ—¥å¿—é‡å·²ç»å æ»¡äº†log bufferæ€»å®¹é‡çš„å¤§çº¦ä¸€åŠå·¦å³ï¼Œå°±éœ€è¦æŠŠè¿™äº›æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ä¸Šã€‚ äº‹åŠ¡æäº¤æ—¶ä¹‹æ‰€ä»¥ä½¿ç”¨redoæ—¥å¿—ä¸»è¦æ˜¯å› ä¸ºå®ƒå ç”¨çš„ç©ºé—´å°‘ï¼Œè¿˜æ˜¯é¡ºåºå†™ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶å¯ä»¥ä¸æŠŠä¿®æ”¹è¿‡çš„Buffer Poolé¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯æŒä¹…æ€§ï¼Œå¿…é¡»è¦æŠŠä¿®æ”¹è¿™äº›é¡µé¢å¯¹åº”çš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ã€‚ å°†æŸä¸ªè„é¡µåˆ·æ–°åˆ°ç£ç›˜å‰ï¼Œä¼šä¿è¯å…ˆå°†è¯¥è„é¡µå¯¹åº”çš„ redo æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼ˆå†ä¸€æ¬¡ å¼ºè°ƒï¼Œredo æ—¥å¿—æ˜¯é¡ºåºåˆ·æ–°çš„ï¼Œæ‰€ä»¥åœ¨å°†æŸä¸ªè„é¡µå¯¹åº”çš„ redo æ—¥å¿—ä» redo log buffer åˆ·æ–°åˆ°ç£ç›˜æ—¶ï¼Œä¹Ÿä¼šä¿è¯å°†åœ¨å…¶ä¹‹å‰äº§ç”Ÿçš„ redo æ—¥å¿—ä¹Ÿåˆ·æ–°åˆ°ç£ç›˜ï¼‰ã€‚ åå°çº¿ç¨‹ä¸åœçš„åˆ·åå°æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤§çº¦æ¯ç§’éƒ½ä¼šåˆ·æ–°ä¸€æ¬¡log bufferä¸­çš„redoæ—¥å¿—åˆ°ç£ç›˜ã€‚ æ­£å¸¸å…³é—­æœåŠ¡å™¨æ—¶ åšæ‰€è°“çš„checkpointæ—¶ å…¶ä»–çš„ä¸€äº›æƒ…å†µâ€¦ 2.redoæ—¥å¿—æ–‡ä»¶ç»„MySQLçš„æ•°æ®ç›®å½•ï¼ˆä½¿ç”¨SHOW VARIABLES LIKE &#39;datadir&#39;æŸ¥çœ‹ï¼‰ä¸‹é»˜è®¤æœ‰ä¸¤ä¸ªåä¸ºib_logfile0å’Œib_logfile1çš„æ–‡ä»¶ï¼Œlog bufferä¸­çš„æ—¥å¿—é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯åˆ·æ–°åˆ°è¿™ä¸¤ä¸ªç£ç›˜æ–‡ä»¶ä¸­ã€‚å¦‚æœæˆ‘ä»¬å¯¹é»˜è®¤çš„redoæ—¥å¿—æ–‡ä»¶ä¸æ»¡æ„ï¼Œå¯ä»¥é€šè¿‡ä¸‹è¾¹å‡ ä¸ªå¯åŠ¨å‚æ•°æ¥è°ƒèŠ‚ï¼š innodb_log_group_home_dirè¯¥å‚æ•°æŒ‡å®šäº†redoæ—¥å¿—æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œé»˜è®¤å€¼å°±æ˜¯å½“å‰çš„æ•°æ®ç›®å½•ã€‚ innodb_log_file_sizeè¯¥å‚æ•°æŒ‡å®šäº†æ¯ä¸ªredoæ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼Œåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­çš„é»˜è®¤å€¼ä¸º48MBï¼Œ innodb_log_files_in_groupè¯¥å‚æ•°æŒ‡å®šredoæ—¥å¿—æ–‡ä»¶çš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼ä¸º2ï¼Œæœ€å¤§å€¼ä¸º100ã€‚ ç£ç›˜ä¸Šçš„redoæ—¥å¿—æ–‡ä»¶ä¸åªä¸€ä¸ªï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ç»„çš„å½¢å¼å‡ºç°çš„ã€‚è¿™äº›æ–‡ä»¶ä»¥ib_logfile[æ•°å­—]ï¼ˆæ•°å­—å¯ä»¥æ˜¯0ã€1ã€2â€¦ï¼‰çš„å½¢å¼è¿›è¡Œå‘½åã€‚åœ¨å°†redoæ—¥å¿—å†™å…¥æ—¥å¿—æ–‡ä»¶ç»„æ—¶ï¼Œæ˜¯ä»ib_logfile0å¼€å§‹å†™ï¼Œå¦‚æœib_logfile0å†™æ»¡äº†ï¼Œå°±æ¥ç€ib_logfile1å†™ï¼ŒåŒç†ï¼Œib_logfile1å†™æ»¡äº†å°±å»å†™ib_logfile2ï¼Œä¾æ­¤ç±»æ¨ã€‚å¦‚æœå†™åˆ°æœ€åä¸€ä¸ªæ–‡ä»¶è¯¥å’‹åŠï¼Ÿé‚£å°±é‡æ–°è½¬åˆ°ib_logfile0ç»§ç»­å†™ï¼Œæ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ€»å…±çš„redoæ—¥å¿—æ–‡ä»¶å¤§å°å…¶å®å°±æ˜¯ï¼šinnodb_log_file_size Ã— innodb_log_files_in_groupã€‚ å¦‚æœé‡‡ç”¨å¾ªç¯ä½¿ç”¨çš„æ–¹å¼å‘redoæ—¥å¿—æ–‡ä»¶ç»„é‡Œå†™æ•°æ®çš„è¯ï¼Œé‚£å²‚ä¸æ˜¯è¦è¿½å°¾ï¼Œä¹Ÿå°±æ˜¯åå†™å…¥çš„redoæ—¥å¿—è¦†ç›–æ‰å‰è¾¹å†™çš„redoæ—¥å¿—ï¼Ÿå½“ç„¶å¯èƒ½äº†ï¼æ‰€ä»¥InnoDBæå‡ºäº†checkpointçš„æ¦‚å¿µã€‚ 3.redoæ—¥å¿—æ–‡ä»¶æ ¼å¼log bufferæœ¬è´¨ä¸Šæ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¢«åˆ’åˆ†æˆäº†è‹¥å¹²ä¸ª512å­—èŠ‚å¤§å°çš„blockã€‚å°†log bufferä¸­çš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜çš„æœ¬è´¨å°±æ˜¯æŠŠblockçš„é•œåƒå†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥redoæ—¥å¿—æ–‡ä»¶å…¶å®ä¹Ÿæ˜¯ç”±è‹¥å¹²ä¸ª512å­—èŠ‚å¤§å°çš„blockç»„æˆã€‚ redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„æ¯ä¸ªæ–‡ä»¶å¤§å°éƒ½ä¸€æ ·ï¼Œæ ¼å¼ä¹Ÿä¸€æ ·ï¼Œéƒ½æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š å‰2048ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å‰4ä¸ªblockæ˜¯ç”¨æ¥å­˜å‚¨ä¸€äº›ç®¡ç†ä¿¡æ¯çš„ã€‚ ä»ç¬¬2048å­—èŠ‚å¾€åæ˜¯ç”¨æ¥å­˜å‚¨log bufferä¸­çš„blocké•œåƒçš„ã€‚ æ‰€ä»¥æˆ‘ä»¬å‰è¾¹æ‰€è¯´çš„å¾ªç¯ä½¿ç”¨redoæ—¥å¿—æ–‡ä»¶ï¼Œå…¶å®æ˜¯ä»æ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„ç¬¬2048ä¸ªå­—èŠ‚å¼€å§‹ç®—ï¼Œç”»ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š æ™®é€šblockçš„æ ¼å¼æˆ‘ä»¬åœ¨äº†è§£log bufferçš„æ—¶å€™éƒ½è¯´è¿‡äº†ï¼Œå°±æ˜¯log block headerã€log block bodyã€log block trialerè¿™ä¸‰ä¸ªéƒ¨åˆ†ã€‚è¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹æ¯ä¸ªredoæ—¥å¿—æ–‡ä»¶å‰2048ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å‰4ä¸ªç‰¹æ®Šblockçš„æ ¼å¼éƒ½æ˜¯ä»€ä¹ˆä½œç”¨ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™4ä¸ªblockåˆ†åˆ«æ˜¯ï¼š log file headerï¼šæè¿°è¯¥redoæ—¥å¿—æ–‡ä»¶çš„ä¸€äº›æ•´ä½“å±æ€§å„ä¸ªå±æ€§çš„å…·ä½“é‡Šä¹‰å¦‚ä¸‹ï¼š å±æ€§å é•¿åº¦ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ æè¿° LOG_HEADER_FORMAT 4 redoæ—¥å¿—çš„ç‰ˆæœ¬ï¼Œåœ¨MySQL 5.7.21ä¸­è¯¥å€¼æ°¸è¿œä¸º1 LOG_HEADER_PAD1 4 åšå­—èŠ‚å¡«å……ç”¨çš„ï¼Œæ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œå¿½ç•¥ï½ LOG_HEADER_START_LSN 8 æ ‡è®°æœ¬redoæ—¥å¿—æ–‡ä»¶å¼€å§‹çš„LSNå€¼ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶åç§»é‡ä¸º2048å­—èŠ‚åˆå¯¹åº”çš„LSNå€¼ã€‚ LOG_HEADER_CREATOR 32 ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ ‡è®°æœ¬redoæ—¥å¿—æ–‡ä»¶çš„åˆ›å»ºè€…æ˜¯è°ã€‚æ­£å¸¸è¿è¡Œæ—¶è¯¥å€¼ä¸ºMySQLçš„ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ï¼š&quot;MySQL 5.7.21&quot;ï¼Œä½¿ç”¨mysqlbackupå‘½ä»¤åˆ›å»ºçš„redoæ—¥å¿—æ–‡ä»¶çš„è¯¥å€¼ä¸º&quot;ibbackup&quot;å’Œåˆ›å»ºæ—¶é—´ã€‚ LOG_BLOCK_CHECKSUM 4 æœ¬blockçš„æ ¡éªŒå€¼ï¼Œæ‰€æœ‰blockéƒ½æœ‰ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ checkpoint1ï¼šè®°å½•å…³äºcheckpointçš„ä¸€äº›å±æ€§ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼šå„ä¸ªå±æ€§çš„å…·ä½“é‡Šä¹‰å¦‚ä¸‹ï¼š å±æ€§å é•¿åº¦ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ æè¿° LOG_CHECKPOINT_NO 8 æœåŠ¡å™¨åšcheckpointçš„ç¼–å·ï¼Œæ¯åšä¸€æ¬¡checkpointï¼Œè¯¥å€¼å°±åŠ 1ã€‚ LOG_CHECKPOINT_LSN 8 æœåŠ¡å™¨åšcheckpointç»“æŸæ—¶å¯¹åº”çš„LSNå€¼ï¼Œç³»ç»Ÿå´©æºƒæ¢å¤æ—¶å°†ä»è¯¥å€¼å¼€å§‹ã€‚ LOG_CHECKPOINT_OFFSET 8 ä¸Šä¸ªå±æ€§ä¸­çš„LSNå€¼åœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡ LOG_CHECKPOINT_LOG_BUF_SIZE 8 æœåŠ¡å™¨åœ¨åšcheckpointæ“ä½œæ—¶å¯¹åº”çš„log bufferçš„å¤§å° LOG_BLOCK_CHECKSUM 4 æœ¬blockçš„æ ¡éªŒå€¼ï¼Œæ‰€æœ‰blockéƒ½æœ‰ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ ç¬¬ä¸‰ä¸ªblockæœªä½¿ç”¨ï¼Œå¿½ç•¥ checkpoint2ï¼šç»“æ„å’Œcheckpoint1ä¸€æ ·ã€‚ å…­ï¼ŒLog Sequence Numberè‡ªç³»ç»Ÿå¼€å§‹è¿è¡Œï¼Œå°±ä¸æ–­çš„åœ¨ä¿®æ”¹é¡µé¢ï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šä¸æ–­çš„ç”Ÿæˆredoæ—¥å¿—ã€‚redoæ—¥å¿—çš„é‡åœ¨ä¸æ–­çš„é€’å¢ã€‚InnoDBä¸ºè®°å½•å·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œè®¾è®¡äº†ä¸€ä¸ªç§°ä¹‹ä¸ºLog Sequence Numberçš„å…¨å±€å˜é‡ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼šæ—¥å¿—åºåˆ—å·ï¼Œç®€ç§°lsnã€‚InnoDBè§„å®šåˆå§‹çš„lsnå€¼ä¸º8704ï¼ˆä¹Ÿå°±æ˜¯ä¸€æ¡redoæ—¥å¿—ä¹Ÿæ²¡å†™å…¥æ—¶ï¼Œlsnçš„å€¼ä¸º8704ï¼‰ã€‚ åœ¨å‘log bufferä¸­å†™å…¥redoæ—¥å¿—æ—¶ä¸æ˜¯ä¸€æ¡ä¸€æ¡å†™å…¥çš„ï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªmtrç”Ÿæˆçš„ä¸€ç»„redoæ—¥å¿—ä¸ºå•ä½è¿›è¡Œå†™å…¥çš„ã€‚è€Œä¸”å®é™…ä¸Šæ˜¯æŠŠæ—¥å¿—å†…å®¹å†™åœ¨äº†log block bodyå¤„ã€‚ä½†æ˜¯åœ¨ç»Ÿè®¡lsnçš„å¢é•¿é‡æ—¶ï¼Œæ˜¯æŒ‰ç…§å®é™…å†™å…¥çš„æ—¥å¿—é‡åŠ ä¸Šå ç”¨çš„log block headerå’Œlog block traileræ¥è®¡ç®—çš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨ååˆå§‹åŒ–log bufferæ—¶ï¼Œbuf_freeï¼ˆå°±æ˜¯æ ‡è®°ä¸‹ä¸€æ¡redoæ—¥å¿—åº”è¯¥å†™å…¥åˆ°log bufferçš„ä½ç½®çš„å˜é‡ï¼‰å°±ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªblockçš„åç§»é‡ä¸º12å­—èŠ‚ï¼ˆlog block headerçš„å¤§å°ï¼‰çš„åœ°æ–¹ï¼Œé‚£ä¹ˆlsnå€¼ä¹Ÿä¼šè·Ÿç€å¢åŠ 12ï¼š å¦‚æœæŸä¸ªmträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´æ¯”è¾ƒå°ï¼Œä¹Ÿå°±æ˜¯å¾…æ’å…¥çš„blockå‰©ä½™ç©ºé—²ç©ºé—´èƒ½å®¹çº³è¿™ä¸ªmtræäº¤çš„æ—¥å¿—æ—¶ï¼Œlsnå¢é•¿çš„é‡å°±æ˜¯è¯¥mtrç”Ÿæˆçš„redoæ—¥å¿—å ç”¨çš„å­—èŠ‚æ•°ï¼Œå°±åƒè¿™æ ·ï¼šæˆ‘ä»¬å‡è®¾ä¸Šå›¾ä¸­mtr_1äº§ç”Ÿçš„redoæ—¥å¿—é‡ä¸º200å­—èŠ‚ï¼Œé‚£ä¹ˆlsnå°±è¦åœ¨8716çš„åŸºç¡€ä¸Šå¢åŠ 200ï¼Œå˜ä¸º8916ã€‚ å¦‚æœæŸä¸ªmträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´æ¯”è¾ƒå¤§ï¼Œä¹Ÿå°±æ˜¯å¾…æ’å…¥çš„blockå‰©ä½™ç©ºé—²ç©ºé—´ä¸è¶³ä»¥å®¹çº³è¿™ä¸ªmtræäº¤çš„æ—¥å¿—æ—¶ï¼Œlsnå¢é•¿çš„é‡å°±æ˜¯è¯¥mtrç”Ÿæˆçš„redoæ—¥å¿—å ç”¨çš„å­—èŠ‚æ•°åŠ ä¸Šé¢å¤–å ç”¨çš„log block headerå’Œlog block trailerçš„å­—èŠ‚æ•°ï¼Œå°±åƒè¿™æ ·ï¼šæˆ‘ä»¬å‡è®¾ä¸Šå›¾ä¸­mtr_2äº§ç”Ÿçš„redoæ—¥å¿—é‡ä¸º1000å­—èŠ‚ï¼Œä¸ºäº†å°†mtr_2äº§ç”Ÿçš„redoæ—¥å¿—å†™å…¥log bufferï¼Œæˆ‘ä»¬ä¸å¾—ä¸é¢å¤–å¤šåˆ†é…ä¸¤ä¸ªblockï¼Œæ‰€ä»¥lsnçš„å€¼éœ€è¦åœ¨8916çš„åŸºç¡€ä¸Šå¢åŠ 1000 + 12Ã—2 + 4 Ã— 2 = 1032ã€‚ ä»ä¸Šè¾¹çš„æè¿°ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯ä¸€ç»„ç”±mtrç”Ÿæˆçš„redoæ—¥å¿—éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„LSNå€¼ä¸å…¶å¯¹åº”ï¼ŒLSNå€¼è¶Šå°ï¼Œè¯´æ˜redoæ—¥å¿—äº§ç”Ÿçš„è¶Šæ—©ã€‚ 1.flushed_to_disk_lsnredoæ—¥å¿—æ˜¯é¦–å…ˆå†™åˆ°log bufferä¸­ï¼Œä¹‹åæ‰ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šçš„redoæ—¥å¿—æ–‡ä»¶ã€‚æ‰€ä»¥InnoDBæå‡ºäº†ä¸€ä¸ªç§°ä¹‹ä¸ºbuf_next_to_writeçš„å…¨å±€å˜é‡ï¼Œæ ‡è®°å½“å‰log bufferä¸­å·²ç»æœ‰å“ªäº›æ—¥å¿—è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºå°±æ˜¯è¿™æ ·ï¼š lsnæ˜¯è¡¨ç¤ºå½“å‰ç³»ç»Ÿä¸­å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œè¿™åŒ…æ‹¬äº†å†™åˆ°log bufferè€Œæ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜çš„æ—¥å¿—ï¼Œç›¸åº”çš„ï¼ŒInnoDBæå‡ºäº†ä¸€ä¸ªè¡¨ç¤ºåˆ·æ–°åˆ°ç£ç›˜ä¸­çš„redoæ—¥å¿—é‡çš„å…¨å±€å˜é‡ï¼Œç§°ä¹‹ä¸ºflushed_to_disk_lsnã€‚ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œè¯¥å˜é‡çš„å€¼å’Œåˆå§‹çš„lsnå€¼æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯8704ã€‚éšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œredoæ—¥å¿—è¢«ä¸æ–­å†™å…¥log bufferï¼Œä½†æ˜¯å¹¶ä¸ä¼šç«‹å³åˆ·æ–°åˆ°ç£ç›˜ï¼Œlsnçš„å€¼å°±å’Œflushed_to_disk_lsnçš„å€¼æ‹‰å¼€äº†å·®è·ã€‚æˆ‘ä»¬æ¨ç†ä¸€ä¸‹ï¼š ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨åï¼Œå‘log bufferä¸­å†™å…¥äº†mtr_1ã€mtr_2ã€mtr_3è¿™ä¸‰ä¸ªmträº§ç”Ÿçš„redoæ—¥å¿—ï¼Œå‡è®¾è¿™ä¸‰ä¸ªmtrå¼€å§‹å’Œç»“æŸæ—¶å¯¹åº”çš„lsnå€¼åˆ†åˆ«æ˜¯ï¼š mtr_1ï¼š8716 ï½ 8916 mtr_2ï¼š8916 ï½ 9948 mtr_3ï¼š9948 ï½ 10000 æ­¤æ—¶çš„lsnå·²ç»å¢é•¿åˆ°äº†10000ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰åˆ·æ–°æ“ä½œï¼Œæ‰€ä»¥æ­¤æ—¶flushed_to_disk_lsnçš„å€¼ä»ä¸º8704ï¼Œå¦‚å›¾ï¼š éšåè¿›è¡Œå°†log bufferä¸­çš„blockåˆ·æ–°åˆ°redoæ—¥å¿—æ–‡ä»¶çš„æ“ä½œï¼Œå‡è®¾å°†mtr_1å’Œmtr_2çš„æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆflushed_to_disk_lsnå°±åº”è¯¥å¢é•¿mtr_1å’Œmtr_2å†™å…¥çš„æ—¥å¿—é‡ï¼Œæ‰€ä»¥flushed_to_disk_lsnçš„å€¼å¢é•¿åˆ°äº†9948ï¼Œå¦‚å›¾ï¼š ç»¼ä¸Šæ‰€è¿°ï¼Œå½“æœ‰æ–°çš„redoæ—¥å¿—å†™å…¥åˆ°log bufferæ—¶ï¼Œé¦–å…ˆlsnçš„å€¼ä¼šå¢é•¿ï¼Œä½†flushed_to_disk_lsnä¸å˜ï¼Œéšåéšç€ä¸æ–­æœ‰log bufferä¸­çš„æ—¥å¿—è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œflushed_to_disk_lsnçš„å€¼ä¹Ÿè·Ÿç€å¢é•¿ã€‚å¦‚æœä¸¤è€…çš„å€¼ç›¸åŒæ—¶ï¼Œè¯´æ˜log bufferä¸­çš„æ‰€æœ‰redoæ—¥å¿—éƒ½å·²ç»åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ã€‚ åº”ç”¨ç¨‹åºå‘ç£ç›˜å†™å…¥æ–‡ä»¶æ—¶å…¶å®æ˜¯å…ˆå†™åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºä¸­å»ï¼Œå¦‚æœæŸä¸ªå†™å…¥æ“ä½œè¦ç­‰åˆ°æ“ä½œç³»ç»Ÿç¡®è®¤å·²ç»å†™åˆ°ç£ç›˜æ—¶æ‰è¿”å›ï¼Œé‚£éœ€è¦è°ƒç”¨ä¸€ä¸‹æ“ä½œç³»ç»Ÿæä¾›çš„fsyncå‡½æ•°ã€‚å…¶å®åªæœ‰å½“ç³»ç»Ÿæ‰§è¡Œäº†fsyncå‡½æ•°åï¼Œflushed_to_disk_lsnçš„å€¼æ‰ä¼šè·Ÿç€å¢é•¿ï¼Œå½“ä»…ä»…æŠŠlog bufferä¸­çš„æ—¥å¿—å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å†²åŒºå´æ²¡æœ‰æ˜¾å¼çš„åˆ·æ–°åˆ°ç£ç›˜æ—¶ï¼Œå¦å¤–çš„ä¸€ä¸ªç§°ä¹‹ä¸ºwrite_lsnçš„å€¼è·Ÿç€å¢é•¿ã€‚ 2.lsnå€¼å’Œredoæ—¥å¿—æ–‡ä»¶åç§»é‡çš„å¯¹åº”å…³ç³»å› ä¸ºlsnçš„å€¼æ˜¯ä»£è¡¨ç³»ç»Ÿå†™å…¥çš„redoæ—¥å¿—é‡çš„ä¸€ä¸ªæ€»å’Œï¼Œä¸€ä¸ªmträ¸­äº§ç”Ÿå¤šå°‘æ—¥å¿—ï¼Œlsnçš„å€¼å°±å¢åŠ å¤šå°‘ï¼ˆå½“ç„¶æœ‰æ—¶å€™è¦åŠ ä¸Šlog block headerå’Œlog block trailerçš„å¤§å°ï¼‰ï¼Œè¿™æ ·mträº§ç”Ÿçš„æ—¥å¿—å†™åˆ°ç£ç›˜ä¸­æ—¶ï¼Œå¾ˆå®¹æ˜“è®¡ç®—æŸä¸€ä¸ªlsnå€¼åœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡ï¼Œå¦‚å›¾ï¼š åˆå§‹æ—¶çš„LSNå€¼æ˜¯8704ï¼Œå¯¹åº”æ–‡ä»¶åç§»é‡2048ï¼Œä¹‹åæ¯ä¸ªmtrå‘ç£ç›˜ä¸­å†™å…¥å¤šå°‘å­—èŠ‚æ—¥å¿—ï¼Œlsnçš„å€¼å°±å¢é•¿å¤šå°‘ã€‚ 3.flushé“¾è¡¨ä¸­çš„LSNä¸€ä¸ªmträ»£è¡¨ä¸€æ¬¡å¯¹åº•å±‚é¡µé¢çš„åŸå­è®¿é—®ï¼Œåœ¨è®¿é—®è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿä¸€ç»„ä¸å¯åˆ†å‰²çš„redoæ—¥å¿—ï¼Œåœ¨mtrç»“æŸæ—¶ï¼Œä¼šæŠŠè¿™ä¸€ç»„redoæ—¥å¿—å†™å…¥åˆ°log bufferä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨mtrç»“æŸæ—¶è¿˜æœ‰ä¸€ä»¶éå¸¸é‡è¦çš„äº‹æƒ…è¦åšï¼Œå°±æ˜¯æŠŠåœ¨mtræ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¿®æ”¹è¿‡çš„é¡µé¢åŠ å…¥åˆ°Buffer Poolçš„flushé“¾è¡¨ã€‚ å½“ç¬¬ä¸€æ¬¡ä¿®æ”¹æŸä¸ªç¼“å­˜åœ¨Buffer Poolä¸­çš„é¡µé¢æ—¶ï¼Œå°±ä¼šæŠŠè¿™ä¸ªé¡µé¢å¯¹åº”çš„æ§åˆ¶å—æ’å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ï¼Œä¹‹åå†ä¿®æ”¹è¯¥é¡µé¢æ—¶ç”±äºå®ƒå·²ç»åœ¨flushé“¾è¡¨ä¸­äº†ï¼Œå°±ä¸å†æ¬¡æ’å…¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´flushé“¾è¡¨ä¸­çš„è„é¡µæ˜¯æŒ‰ç…§é¡µé¢çš„ç¬¬ä¸€æ¬¡ä¿®æ”¹æ—¶é—´ä»å¤§åˆ°å°è¿›è¡Œæ’åºçš„ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šåœ¨ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—ä¸­è®°å½•ä¸¤ä¸ªå…³äºé¡µé¢ä½•æ—¶ä¿®æ”¹çš„å±æ€§ï¼š oldest_modificationï¼šå¦‚æœæŸä¸ªé¡µé¢è¢«åŠ è½½åˆ°Buffer Poolåè¿›è¡Œç¬¬ä¸€æ¬¡ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±å°†ä¿®æ”¹è¯¥é¡µé¢çš„mtrå¼€å§‹æ—¶å¯¹åº”çš„lsnå€¼å†™å…¥è¿™ä¸ªå±æ€§ã€‚ newest_modificationï¼šæ¯ä¿®æ”¹ä¸€æ¬¡é¡µé¢ï¼Œéƒ½ä¼šå°†ä¿®æ”¹è¯¥é¡µé¢çš„mtrç»“æŸæ—¶å¯¹åº”çš„lsnå€¼å†™å…¥è¿™ä¸ªå±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´è¯¥å±æ€§è¡¨ç¤ºé¡µé¢æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹åå¯¹åº”çš„ç³»ç»Ÿlsnå€¼ã€‚ æ¥ç€ä¸Šè¾¹flushed_to_disk_lsnçš„ä¾‹å­çœ‹ä¸€ä¸‹ï¼š å‡è®¾mtr_1æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹äº†é¡µaï¼Œé‚£ä¹ˆåœ¨mtr_1æ‰§è¡Œç»“æŸæ—¶ï¼Œå°±ä¼šå°†é¡µaå¯¹åº”çš„æ§åˆ¶å—åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ã€‚å¹¶ä¸”å°†mtr_1å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8716å†™å…¥é¡µaå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_1ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8916å†™å…¥é¡µaå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼ˆoldest_modificationç¼©å†™æˆäº†o_mï¼Œnewest_modificationç¼©å†™æˆäº†n_mï¼‰ï¼š æ¥ç€å‡è®¾mtr_2æ‰§è¡Œè¿‡ç¨‹ä¸­åˆä¿®æ”¹äº†é¡µbå’Œé¡µcä¸¤ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆåœ¨mtr_2æ‰§è¡Œç»“æŸæ—¶ï¼Œå°±ä¼šå°†é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—éƒ½åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ã€‚å¹¶ä¸”å°†mtr_2å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8916å†™å…¥é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_2ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯9948å†™å…¥é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼šä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯æ¬¡æ–°æ’å…¥åˆ°flushé“¾è¡¨ä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯è¢«æ”¾åœ¨äº†å¤´éƒ¨ï¼Œä¹Ÿå°±æ˜¯è¯´flushé“¾è¡¨ä¸­å‰è¾¹çš„è„é¡µä¿®æ”¹çš„æ—¶é—´æ¯”è¾ƒæ™šï¼Œåè¾¹çš„è„é¡µä¿®æ”¹æ—¶é—´æ¯”è¾ƒæ—©ã€‚ æ¥ç€å‡è®¾mtr_3æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹äº†é¡µbå’Œé¡µdï¼Œä¸è¿‡é¡µbä¹‹å‰å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥å®ƒå¯¹åº”çš„æ§åˆ¶å—å·²ç»è¢«æ’å…¥åˆ°äº†flushé“¾è¡¨ï¼Œæ‰€ä»¥åœ¨mtr_3æ‰§è¡Œç»“æŸæ—¶ï¼Œåªéœ€è¦å°†é¡µdå¯¹åº”çš„æ§åˆ¶å—éƒ½åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨å³å¯ã€‚æ‰€ä»¥éœ€è¦å°†mtr_3å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯9948å†™å…¥é¡µdå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_3ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯10000å†™å…¥é¡µdå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚å¦å¤–ï¼Œç”±äºé¡µbåœ¨mtr_3æ‰§è¡Œè¿‡ç¨‹ä¸­åˆå‘ç”Ÿäº†ä¸€æ¬¡ä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦æ›´æ–°é¡µbå¯¹åº”çš„æ§åˆ¶å—ä¸­newest_modificationçš„å€¼ä¸º10000ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼š æ€»ç»“ä¸€ä¸‹ä¸Šè¾¹è¯´çš„ï¼Œå°±æ˜¯ï¼šflushé“¾è¡¨ä¸­çš„è„é¡µæŒ‰ç…§ä¿®æ”¹å‘ç”Ÿçš„æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§oldest_modificationä»£è¡¨çš„LSNå€¼è¿›è¡Œæ’åºï¼Œè¢«å¤šæ¬¡æ›´æ–°çš„é¡µé¢ä¸ä¼šé‡å¤æ’å…¥åˆ°flushé“¾è¡¨ä¸­ï¼Œä½†æ˜¯ä¼šæ›´æ–°newest_modificationå±æ€§çš„å€¼ã€‚ ä¸ƒï¼Œcheckpointredoæ—¥å¿—æ–‡ä»¶ç»„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬ä¸å¾—ä¸é€‰æ‹©å¾ªç¯ä½¿ç”¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„æ–‡ä»¶ï¼Œä½†æ˜¯è¿™ä¼šé€ æˆæœ€åå†™çš„redoæ—¥å¿—ä¸æœ€å¼€å§‹å†™çš„redoæ—¥å¿—è¿½å°¾ï¼Œè¿™æ—¶åº”è¯¥æƒ³åˆ°ï¼šredoæ—¥å¿—åªæ˜¯ä¸ºäº†ç³»ç»Ÿå´©æºƒåæ¢å¤è„é¡µç”¨çš„ï¼Œå¦‚æœå¯¹åº”çš„è„é¡µå·²ç»åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿ç°åœ¨ç³»ç»Ÿå´©æºƒï¼Œé‚£ä¹ˆåœ¨é‡å¯åä¹Ÿç”¨ä¸ç€ä½¿ç”¨redoæ—¥å¿—æ¢å¤è¯¥é¡µé¢äº†ï¼Œæ‰€ä»¥è¯¥redoæ—¥å¿—ä¹Ÿå°±æ²¡æœ‰å­˜åœ¨çš„å¿…è¦äº†ï¼Œé‚£ä¹ˆå®ƒå ç”¨çš„ç£ç›˜ç©ºé—´å°±å¯ä»¥è¢«åç»­çš„redoæ—¥å¿—æ‰€é‡ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šåˆ¤æ–­æŸäº›redoæ—¥å¿—å ç”¨çš„ç£ç›˜ç©ºé—´æ˜¯å¦å¯ä»¥è¦†ç›–çš„ä¾æ®å°±æ˜¯å®ƒå¯¹åº”çš„è„é¡µæ˜¯å¦å·²ç»åˆ·æ–°åˆ°ç£ç›˜é‡Œã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å‰è¾¹çš„é‚£ä¸ªä¾‹å­ï¼š å¦‚å›¾ï¼Œè™½ç„¶mtr_1å’Œmtr_2ç”Ÿæˆçš„redoæ—¥å¿—éƒ½å·²ç»è¢«å†™åˆ°äº†ç£ç›˜ä¸Šï¼Œä½†æ˜¯å®ƒä»¬ä¿®æ”¹çš„è„é¡µä»ç„¶ç•™åœ¨Buffer Poolä¸­ï¼Œæ‰€ä»¥å®ƒä»¬ç”Ÿæˆçš„redoæ—¥å¿—åœ¨ç£ç›˜ä¸Šçš„ç©ºé—´æ˜¯ä¸å¯ä»¥è¢«è¦†ç›–çš„ã€‚ä¹‹åéšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œå¦‚æœé¡µaè¢«åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„æ§åˆ¶å—å°±ä¼šä»flushé“¾è¡¨ä¸­ç§»é™¤ï¼Œå°±åƒè¿™æ ·å­ï¼š è¿™æ ·mtr_1ç”Ÿæˆçš„redoæ—¥å¿—å°±æ²¡æœ‰ç”¨äº†ï¼Œå®ƒä»¬å ç”¨çš„ç£ç›˜ç©ºé—´å°±å¯ä»¥è¢«è¦†ç›–æ‰äº†ã€‚InnoDBæå‡ºäº†ä¸€ä¸ªå…¨å±€å˜é‡checkpoint_lsnæ¥ä»£è¡¨å½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—æ€»é‡æ˜¯å¤šå°‘ï¼Œè¿™ä¸ªå˜é‡åˆå§‹å€¼ä¹Ÿæ˜¯8704ã€‚ æ¯”æ–¹è¯´ç°åœ¨é¡µaè¢«åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œmtr_1ç”Ÿæˆçš„redoæ—¥å¿—å°±å¯ä»¥è¢«è¦†ç›–äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€ä¸ªå¢åŠ checkpoint_lsnçš„æ“ä½œï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºåšä¸€æ¬¡checkpointã€‚åšä¸€æ¬¡checkpointå…¶å®å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š æ­¥éª¤ä¸€ï¼šè®¡ç®—ä¸€ä¸‹å½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—å¯¹åº”çš„lsnå€¼æœ€å¤§æ˜¯å¤šå°‘ã€‚redoæ—¥å¿—å¯ä»¥è¢«è¦†ç›–ï¼Œæ„å‘³ç€å®ƒå¯¹åº”çš„è„é¡µè¢«åˆ·åˆ°äº†ç£ç›˜ï¼Œåªè¦æˆ‘ä»¬è®¡ç®—å‡ºå½“å‰ç³»ç»Ÿä¸­è¢«æœ€æ—©ä¿®æ”¹çš„è„é¡µå¯¹åº”çš„oldest_modificationå€¼ï¼Œé‚£å‡¡æ˜¯åœ¨ç³»ç»Ÿlsnå€¼å°äºè¯¥èŠ‚ç‚¹çš„oldest_modificationå€¼æ—¶äº§ç”Ÿçš„redoæ—¥å¿—éƒ½æ˜¯å¯ä»¥è¢«è¦†ç›–æ‰çš„ï¼Œæˆ‘ä»¬å°±æŠŠè¯¥è„é¡µçš„oldest_modificationèµ‹å€¼ç»™checkpoint_lsnã€‚æ¯”æ–¹è¯´å½“å‰ç³»ç»Ÿä¸­é¡µaå·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆflushé“¾è¡¨çš„å°¾èŠ‚ç‚¹å°±æ˜¯é¡µcï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯å½“å‰ç³»ç»Ÿä¸­æœ€æ—©ä¿®æ”¹çš„è„é¡µäº†ï¼Œå®ƒçš„oldest_modificationå€¼ä¸º8916ï¼Œæˆ‘ä»¬å°±æŠŠ8916èµ‹å€¼ç»™checkpoint_lsnï¼ˆä¹Ÿå°±æ˜¯è¯´åœ¨redoæ—¥å¿—å¯¹åº”çš„lsnå€¼å°äº8916æ—¶å°±å¯ä»¥è¢«è¦†ç›–æ‰ï¼‰ã€‚ æ­¥éª¤äºŒï¼šå°†checkpoint_lsnå’Œå¯¹åº”çš„redoæ—¥å¿—æ–‡ä»¶ç»„åç§»é‡ä»¥åŠæ­¤æ¬¡checkpintçš„ç¼–å·å†™åˆ°æ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ï¼ˆå°±æ˜¯checkpoint1æˆ–è€…checkpoint2ï¼‰ä¸­ã€‚InnoDBç»´æŠ¤äº†ä¸€ä¸ªç›®å‰ç³»ç»Ÿåšäº†å¤šå°‘æ¬¡checkpointçš„å˜é‡checkpoint_noï¼Œæ¯åšä¸€æ¬¡checkpointï¼Œè¯¥å˜é‡çš„å€¼å°±åŠ 1ã€‚æˆ‘ä»¬å‰è¾¹è¯´è¿‡è®¡ç®—ä¸€ä¸ªlsnå€¼å¯¹åº”çš„redoæ—¥å¿—æ–‡ä»¶ç»„åç§»é‡æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œæ‰€ä»¥å¯ä»¥è®¡ç®—å¾—åˆ°è¯¥checkpoint_lsnåœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­å¯¹åº”çš„åç§»é‡checkpoint_offsetï¼Œç„¶åæŠŠè¿™ä¸‰ä¸ªå€¼éƒ½å†™åˆ°redoæ—¥å¿—æ–‡ä»¶ç»„çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚æˆ‘ä»¬è¯´è¿‡ï¼Œæ¯ä¸€ä¸ªredoæ—¥å¿—æ–‡ä»¶éƒ½æœ‰2048ä¸ªå­—èŠ‚çš„ç®¡ç†ä¿¡æ¯ï¼Œä½†æ˜¯ä¸Šè¿°å…³äºcheckpointçš„ä¿¡æ¯åªä¼šè¢«å†™åˆ°æ—¥å¿—æ–‡ä»¶ç»„çš„ç¬¬ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚ä¸è¿‡æˆ‘ä»¬æ˜¯å­˜å‚¨åˆ°checkpoint1ä¸­è¿˜æ˜¯checkpoint2ä¸­å‘¢ï¼ŸInnoDBè§„å®šï¼Œå½“checkpoint_noçš„å€¼æ˜¯å¶æ•°æ—¶ï¼Œå°±å†™åˆ°checkpoint1ä¸­ï¼Œæ˜¯å¥‡æ•°æ—¶ï¼Œå°±å†™åˆ°checkpoint2ä¸­ã€‚ è®°å½•å®Œcheckpointçš„ä¿¡æ¯ä¹‹åï¼Œredoæ—¥å¿—æ–‡ä»¶ç»„ä¸­å„ä¸ªlsnå€¼çš„å…³ç³»å°±åƒè¿™æ ·ï¼š 1.æ‰¹é‡ä»flushé“¾è¡¨ä¸­åˆ·å‡ºè„é¡µä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯åå°çš„çº¿ç¨‹åœ¨å¯¹LRUé“¾è¡¨å’Œflushé“¾è¡¨è¿›è¡Œåˆ·è„æ“ä½œï¼Œè¿™ä¸»è¦å› ä¸ºåˆ·è„æ“ä½œæ¯”è¾ƒæ…¢ï¼Œä¸æƒ³å½±å“ç”¨æˆ·çº¿ç¨‹å¤„ç†è¯·æ±‚ã€‚ä½†æ˜¯å¦‚æœå½“å‰ç³»ç»Ÿä¿®æ”¹é¡µé¢çš„æ“ä½œååˆ†é¢‘ç¹ï¼Œè¿™æ ·å°±å¯¼è‡´å†™æ—¥å¿—æ“ä½œååˆ†é¢‘ç¹ï¼Œç³»ç»Ÿlsnå€¼å¢é•¿è¿‡å¿«ã€‚å¦‚æœåå°çš„åˆ·è„æ“ä½œä¸èƒ½å°†è„é¡µåˆ·å‡ºï¼Œé‚£ä¹ˆç³»ç»Ÿæ— æ³•åŠæ—¶åšcheckpointï¼Œå¯èƒ½å°±éœ€è¦ç”¨æˆ·çº¿ç¨‹åŒæ­¥çš„ä»flushé“¾è¡¨ä¸­æŠŠé‚£äº›æœ€æ—©ä¿®æ”¹çš„è„é¡µï¼ˆoldest_modificationæœ€å°çš„è„é¡µï¼‰åˆ·æ–°åˆ°ç£ç›˜ï¼Œè¿™æ ·è¿™äº›è„é¡µå¯¹åº”çš„redoæ—¥å¿—å°±æ²¡ç”¨äº†ï¼Œç„¶åå°±å¯ä»¥å»åšcheckpointäº†ã€‚ 2.æŸ¥çœ‹ç³»ç»Ÿä¸­çš„å„ç§LSNå€¼æˆ‘ä»¬å¯ä»¥ä½¿ç”¨SHOW ENGINE INNODB STATUSå‘½ä»¤æŸ¥çœ‹å½“å‰InnoDBå­˜å‚¨å¼•æ“ä¸­çš„å„ç§LSNå€¼çš„æƒ…å†µï¼Œæ¯”å¦‚ï¼š 12345678910111213mysql&gt; SHOW ENGINE INNODB STATUS\\G(...çœç•¥å‰è¾¹çš„è®¸å¤šçŠ¶æ€)LOG---Log sequence number 124476971Log flushed up to 124099769Pages flushed up to 124052503Last checkpoint at 1240524940 pending log flushes, 0 pending chkp writes24 log i/o&#x27;s done, 2.00 log i/o&#x27;s/second----------------------(...çœç•¥åè¾¹çš„è®¸å¤šçŠ¶æ€) å…¶ä¸­ï¼š Log sequence numberï¼šä»£è¡¨ç³»ç»Ÿä¸­çš„lsnå€¼ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç³»ç»Ÿå·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼ŒåŒ…æ‹¬å†™å…¥log bufferä¸­çš„æ—¥å¿—ã€‚ Log flushed up toï¼šä»£è¡¨flushed_to_disk_lsnçš„å€¼ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç³»ç»Ÿå·²ç»å†™å…¥ç£ç›˜çš„redoæ—¥å¿—é‡ã€‚ Pages flushed up toï¼šä»£è¡¨flushé“¾è¡¨ä¸­è¢«æœ€æ—©ä¿®æ”¹çš„é‚£ä¸ªé¡µé¢å¯¹åº”çš„oldest_modificationå±æ€§å€¼ã€‚ Last checkpoint atï¼šå½“å‰ç³»ç»Ÿçš„checkpoint_lsnå€¼ã€‚ 3.innodb_flush_log_at_trx_commitçš„ç”¨æ³•ä¸ºäº†ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œç”¨æˆ·çº¿ç¨‹åœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†è¯¥äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ‰€æœ‰redoæ—¥å¿—éƒ½åˆ·æ–°åˆ°ç£ç›˜ä¸Šã€‚è¿™ä¸€æ¡è¦æ±‚å¤ªç‹ äº†ï¼Œä¼šå¾ˆæ˜æ˜¾çš„é™ä½æ•°æ®åº“æ€§èƒ½ã€‚å¦‚æœå¯¹äº‹åŠ¡çš„æŒä¹…æ€§è¦æ±‚ä¸æ˜¯é‚£ä¹ˆå¼ºçƒˆçš„è¯ï¼Œå¯ä»¥é€‰æ‹©ä¿®æ”¹ä¸€ä¸ªç§°ä¸ºinnodb_flush_log_at_trx_commitçš„ç³»ç»Ÿå˜é‡çš„å€¼ï¼Œè¯¥å˜é‡æœ‰3ä¸ªå¯é€‰çš„å€¼ï¼š 0ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º0æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶ä¸ç«‹å³å‘ç£ç›˜ä¸­åŒæ­¥redoæ—¥å¿—ï¼Œè¿™ä¸ªä»»åŠ¡æ˜¯äº¤ç»™åå°çº¿ç¨‹åšçš„ã€‚è¿™æ ·å¾ˆæ˜æ˜¾ä¼šåŠ å¿«è¯·æ±‚å¤„ç†é€Ÿåº¦ï¼Œä½†æ˜¯å¦‚æœäº‹åŠ¡æäº¤åæœåŠ¡å™¨æŒ‚äº†ï¼Œåå°çº¿ç¨‹æ²¡æœ‰åŠæ—¶å°†redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆè¯¥äº‹åŠ¡å¯¹é¡µé¢çš„ä¿®æ”¹ä¼šä¸¢å¤±ã€‚ 1ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º1æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†redoæ—¥å¿—åŒæ­¥åˆ°ç£ç›˜ï¼Œå¯ä»¥ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚1ä¹Ÿæ˜¯innodb_flush_log_at_trx_commitçš„é»˜è®¤å€¼ã€‚ 2ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º2æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†redoæ—¥å¿—å†™åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºä¸­ï¼Œä½†å¹¶ä¸éœ€è¦ä¿è¯å°†æ—¥å¿—çœŸæ­£çš„åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™ç§æƒ…å†µä¸‹å¦‚æœæ•°æ®åº“æŒ‚äº†ï¼Œæ“ä½œç³»ç»Ÿæ²¡æŒ‚çš„è¯ï¼Œäº‹åŠ¡çš„æŒä¹…æ€§è¿˜æ˜¯å¯ä»¥ä¿è¯çš„ï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿä¹ŸæŒ‚äº†çš„è¯ï¼Œé‚£å°±ä¸èƒ½ä¿è¯æŒä¹…æ€§äº†ã€‚ å…«ï¼Œå´©æºƒæ¢å¤åœ¨æœåŠ¡å™¨ä¸æŒ‚çš„æƒ…å†µä¸‹ï¼Œredoæ—¥å¿—ä¸ä»…æ²¡ç”¨ï¼Œåè€Œè®©æ€§èƒ½å˜å¾—æ›´å·®ã€‚ä½†æ˜¯ä¸‡ä¸€æ•°æ®åº“æŒ‚äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨é‡å¯æ—¶æ ¹æ®redoæ—¥å¿—ä¸­çš„è®°å½•å°±å¯ä»¥å°†é¡µé¢æ¢å¤åˆ°ç³»ç»Ÿå´©æºƒå‰çš„çŠ¶æ€ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å¤§è‡´çœ‹ä¸€ä¸‹æ¢å¤è¿‡ç¨‹ã€‚ 1.ç¡®å®šæ¢å¤çš„èµ·ç‚¹checkpoint_lsnä¹‹å‰çš„redoæ—¥å¿—éƒ½å¯ä»¥è¢«è¦†ç›–ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›redoæ—¥å¿—å¯¹åº”çš„è„é¡µéƒ½å·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ï¼Œæ—¢ç„¶å®ƒä»¬å·²ç»è¢«åˆ·ç›˜ï¼Œæˆ‘ä»¬å°±æ²¡å¿…è¦æ¢å¤å®ƒä»¬äº†ã€‚å¯¹äºcheckpoint_lsnä¹‹åçš„redoæ—¥å¿—ï¼Œå®ƒä»¬å¯¹åº”çš„è„é¡µå¯èƒ½æ²¡è¢«åˆ·ç›˜ï¼Œä¹Ÿå¯èƒ½è¢«åˆ·ç›˜äº†ï¼Œæˆ‘ä»¬ä¸èƒ½ç¡®å®šï¼Œæ‰€ä»¥éœ€è¦ä»checkpoint_lsnå¼€å§‹è¯»å–redoæ—¥å¿—æ¥æ¢å¤é¡µé¢ã€‚ å½“ç„¶ï¼Œredoæ—¥å¿—æ–‡ä»¶ç»„çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­æœ‰ä¸¤ä¸ªblockéƒ½å­˜å‚¨äº†checkpoint_lsnçš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å½“ç„¶æ˜¯è¦é€‰å–æœ€è¿‘å‘ç”Ÿçš„é‚£æ¬¡checkpointçš„ä¿¡æ¯ã€‚è¡¡é‡checkpointå‘ç”Ÿæ—¶é—´æ—©æ™šçš„ä¿¡æ¯å°±æ˜¯æ‰€è°“çš„checkpoint_noï¼Œåªè¦æŠŠcheckpoint1å’Œcheckpoint2è¿™ä¸¤ä¸ªblockä¸­çš„checkpoint_noå€¼è¯»å‡ºæ¥æ¯”ä¸€ä¸‹å¤§å°ï¼Œå“ªä¸ªçš„checkpoint_noå€¼æ›´å¤§ï¼Œè¯´æ˜å“ªä¸ªblockå­˜å‚¨çš„å°±æ˜¯æœ€è¿‘çš„ä¸€æ¬¡checkpointä¿¡æ¯ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½æ‹¿åˆ°æœ€è¿‘å‘ç”Ÿçš„checkpointå¯¹åº”çš„checkpoint_lsnå€¼ä»¥åŠå®ƒåœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡checkpoint_offsetã€‚ 2.ç¡®å®šæ¢å¤çš„ç»ˆç‚¹redoæ—¥å¿—æ¢å¤çš„èµ·ç‚¹ç¡®å®šäº†ï¼Œé‚£ç»ˆç‚¹æ˜¯å“ªä¸ªå‘¢ï¼Ÿè¿™ä¸ªè¿˜å¾—ä»blockçš„ç»“æ„è¯´èµ·ã€‚åœ¨å†™redoæ—¥å¿—çš„æ—¶å€™éƒ½æ˜¯é¡ºåºå†™çš„ï¼Œå†™æ»¡äº†ä¸€ä¸ªblockä¹‹åä¼šå†å¾€ä¸‹ä¸€ä¸ªblockä¸­å†™ã€‚ æ™®é€šblockçš„log block headeréƒ¨åˆ†æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºLOG_BLOCK_HDR_DATA_LENçš„å±æ€§ï¼Œè¯¥å±æ€§å€¼è®°å½•äº†å½“å‰blocké‡Œä½¿ç”¨äº†å¤šå°‘å­—èŠ‚çš„ç©ºé—´ã€‚å¯¹äºè¢«å¡«æ»¡çš„blockæ¥è¯´ï¼Œè¯¥å€¼æ°¸è¿œä¸º512ã€‚å¦‚æœè¯¥å±æ€§çš„å€¼ä¸ä¸º512ï¼Œé‚£ä¹ˆå°±æ˜¯å®ƒäº†ï¼Œå®ƒå°±æ˜¯æ­¤æ¬¡å´©æºƒæ¢å¤ä¸­éœ€è¦æ‰«æçš„æœ€åä¸€ä¸ªblockã€‚ 3.æ€ä¹ˆæ¢å¤ç¡®å®šäº†éœ€è¦æ‰«æå“ªäº›redoæ—¥å¿—è¿›è¡Œå´©æºƒæ¢å¤ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆè¿›è¡Œæ¢å¤äº†ã€‚å‡è®¾ç°åœ¨çš„redoæ—¥å¿—æ–‡ä»¶ä¸­æœ‰5æ¡redoæ—¥å¿—ï¼Œå¦‚å›¾ï¼š ç”±äºredo 0åœ¨checkpoint_lsnåå‰è¾¹ï¼Œæ¢å¤æ—¶å¯ä»¥ä¸ç®¡å®ƒã€‚ç°åœ¨å¯ä»¥æŒ‰ç…§redoæ—¥å¿—çš„é¡ºåºä¾æ¬¡æ‰«æcheckpoint_lsnä¹‹åçš„å„æ¡redoæ—¥å¿—ï¼ŒæŒ‰ç…§æ—¥å¿—ä¸­è®°è½½çš„å†…å®¹å°†å¯¹åº”çš„é¡µé¢æ¢å¤å‡ºæ¥ã€‚è¿™æ ·æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä¸è¿‡InnoDBè¿˜æ˜¯æƒ³äº†ä¸€äº›åŠæ³•åŠ å¿«è¿™ä¸ªæ¢å¤çš„è¿‡ç¨‹ï¼š ä½¿ç”¨å“ˆå¸Œè¡¨æ ¹æ®redoæ—¥å¿—çš„space IDå’Œpage numberå±æ€§è®¡ç®—å‡ºæ•£åˆ—å€¼ï¼ŒæŠŠspace IDå’Œpage numberç›¸åŒçš„redoæ—¥å¿—æ”¾åˆ°å“ˆå¸Œè¡¨çš„åŒä¸€ä¸ªæ§½é‡Œï¼Œå¦‚æœæœ‰å¤šä¸ªspace IDå’Œpage numberéƒ½ç›¸åŒçš„redoæ—¥å¿—ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´ä½¿ç”¨é“¾è¡¨è¿æ¥èµ·æ¥ï¼ŒæŒ‰ç…§ç”Ÿæˆçš„å…ˆåé¡ºåºé“¾æ¥èµ·æ¥çš„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼šä¹‹åå°±å¯ä»¥éå†å“ˆå¸Œè¡¨ï¼Œå› ä¸ºå¯¹åŒä¸€ä¸ªé¡µé¢è¿›è¡Œä¿®æ”¹çš„redoæ—¥å¿—éƒ½æ”¾åœ¨äº†ä¸€ä¸ªæ§½é‡Œï¼Œæ‰€ä»¥å¯ä»¥ä¸€æ¬¡æ€§å°†ä¸€ä¸ªé¡µé¢ä¿®å¤å¥½ï¼ˆé¿å…äº†å¾ˆå¤šè¯»å–é¡µé¢çš„éšæœºIO)ï¼Œè¿™æ ·å¯ä»¥åŠ å¿«æ¢å¤é€Ÿåº¦ã€‚å¦å¤–éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼ŒåŒä¸€ä¸ªé¡µé¢çš„redoæ—¥å¿—æ˜¯æŒ‰ç…§ç”Ÿæˆæ—¶é—´é¡ºåºè¿›è¡Œæ’åºçš„ï¼Œæ‰€ä»¥æ¢å¤çš„æ—¶å€™ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºè¿›è¡Œæ¢å¤ï¼Œå¦‚æœä¸æŒ‰ç…§ç”Ÿæˆæ—¶é—´é¡ºåºè¿›è¡Œæ’åºçš„è¯ï¼Œé‚£ä¹ˆå¯èƒ½å‡ºç°é”™è¯¯ã€‚æ¯”å¦‚åŸå…ˆçš„ä¿®æ”¹æ“ä½œæ˜¯å…ˆæ’å…¥ä¸€æ¡è®°å½•ï¼Œå†åˆ é™¤è¯¥æ¡è®°å½•ï¼Œå¦‚æœæ¢å¤æ—¶ä¸æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¥ï¼Œå°±å¯èƒ½å˜æˆå…ˆåˆ é™¤ä¸€æ¡è®°å½•ï¼Œå†æ’å…¥ä¸€æ¡è®°å½•ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚ è·³è¿‡å·²ç»åˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢checkpoint_lsnä¹‹å‰çš„redoæ—¥å¿—å¯¹åº”çš„è„é¡µç¡®å®šéƒ½å·²ç»åˆ·åˆ°ç£ç›˜äº†ï¼Œä½†æ˜¯checkpoint_lsnä¹‹åçš„redoæ—¥å¿—æˆ‘ä»¬ä¸èƒ½ç¡®å®šæ˜¯å¦å·²ç»åˆ·åˆ°ç£ç›˜ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨æœ€è¿‘åšçš„ä¸€æ¬¡checkpointåï¼Œå¯èƒ½åå°çº¿ç¨‹åˆä¸æ–­çš„ä»LRUé“¾è¡¨å’Œflushé“¾è¡¨ä¸­å°†ä¸€äº›è„é¡µåˆ·å‡ºBuffer Poolã€‚è¿™äº›åœ¨checkpoint_lsnä¹‹åçš„redoæ—¥å¿—ï¼Œå¦‚æœå®ƒä»¬å¯¹åº”çš„è„é¡µåœ¨å´©æºƒå‘ç”Ÿæ—¶å·²ç»åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£åœ¨æ¢å¤æ—¶ä¹Ÿå°±æ²¡æœ‰å¿…è¦æ ¹æ®redoæ—¥å¿—çš„å†…å®¹ä¿®æ”¹è¯¥é¡µé¢äº†ã€‚é‚£åœ¨æ¢å¤æ—¶æ€ä¹ˆçŸ¥é“æŸä¸ªredoæ—¥å¿—å¯¹åº”çš„è„é¡µæ˜¯å¦åœ¨å´©æºƒå‘ç”Ÿæ—¶å·²ç»åˆ·æ–°åˆ°ç£ç›˜äº†å‘¢ï¼Ÿè¿™è¿˜å¾—ä»é¡µé¢çš„ç»“æ„è¯´èµ·ï¼Œæ¯ä¸ªé¡µé¢éƒ½æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºFile Headerçš„éƒ¨åˆ†ï¼Œåœ¨File Headeré‡Œæœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºFIL_PAGE_LSNçš„å±æ€§ï¼Œè¯¥å±æ€§è®°è½½äº†æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹é¡µé¢æ—¶å¯¹åº”çš„lsnå€¼ï¼ˆå…¶å®å°±æ˜¯é¡µé¢æ§åˆ¶å—ä¸­çš„newest_modificationå€¼ï¼‰ã€‚å¦‚æœåœ¨åšäº†æŸæ¬¡checkpointä¹‹åæœ‰è„é¡µè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œé‚£ä¹ˆè¯¥é¡µå¯¹åº”çš„FIL_PAGE_LSNä»£è¡¨çš„lsnå€¼è‚¯å®šå¤§äºcheckpoint_lsnçš„å€¼ï¼Œå‡¡æ˜¯ç¬¦åˆè¿™ç§æƒ…å†µçš„é¡µé¢å°±ä¸éœ€è¦é‡å¤æ‰§è¡Œlsnå€¼å°äºFIL_PAGE_LSNçš„redoæ—¥å¿—äº†ï¼Œæ‰€ä»¥æ›´è¿›ä¸€æ­¥æå‡äº†å´©æºƒæ¢å¤çš„é€Ÿåº¦ã€‚ ä¹ï¼ŒLOG_BLOCK_HDR_NOæ˜¯å¦‚ä½•è®¡ç®—çš„å¯¹äºå®é™…å­˜å‚¨redoæ—¥å¿—çš„æ™®é€šçš„log blockæ¥è¯´ï¼Œåœ¨log block headerå¤„æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºLOG_BLOCK_HDR_NOçš„å±æ€§ï¼Œæˆ‘ä»¬è¯´è¿™ä¸ªå±æ€§ä»£è¡¨ä¸€ä¸ªå”¯ä¸€çš„æ ‡å·ã€‚è¿™ä¸ªå±æ€§æ˜¯åˆæ¬¡ä½¿ç”¨è¯¥blockæ—¶åˆ†é…çš„ï¼Œè·Ÿå½“æ—¶çš„ç³»ç»Ÿlsnå€¼æœ‰å…³ã€‚ä½¿ç”¨ä¸‹è¾¹çš„å…¬å¼è®¡ç®—è¯¥blockçš„LOG_BLOCK_HDR_NOå€¼ï¼š 1((lsn / 512) &amp; 0x3FFFFFFFUL) + 1 ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œ0x3FFFFFFFULå¯¹åº”çš„äºŒè¿›åˆ¶æ•°çš„å‰2ä½ä¸º0ï¼Œå30ä½çš„å€¼éƒ½ä¸º1ã€‚ä¸€ä¸ªäºŒè¿›åˆ¶ä½ä¸0åšä¸è¿ç®—ï¼ˆ&amp;ï¼‰çš„ç»“æœè‚¯å®šæ˜¯0ï¼Œä¸€ä¸ªäºŒè¿›åˆ¶ä½ä¸1åšä¸è¿ç®—ï¼ˆ&amp;ï¼‰çš„ç»“æœå°±æ˜¯åŸå€¼ã€‚è®©ä¸€ä¸ªæ•°å’Œ0x3FFFFFFFULåšä¸è¿ç®—çš„æ„æ€å°±æ˜¯è¦å°†è¯¥å€¼çš„å‰2ä¸ªæ¯”ç‰¹ä½çš„å€¼ç½®ä¸º0ï¼Œè¿™æ ·è¯¥å€¼å°±è‚¯å®šå°äºæˆ–ç­‰äº0x3FFFFFFFULäº†ã€‚è¿™ä¹Ÿå°±è¯´æ˜äº†ï¼Œä¸è®ºlsnå¤šå¤§ï¼Œ((lsn / 512) &amp; 0x3FFFFFFFUL)çš„å€¼è‚¯å®šåœ¨0``0x3FFFFFFFULä¹‹é—´ï¼Œå†åŠ 1çš„è¯è‚¯å®šåœ¨1``0x40000000ULä¹‹é—´ã€‚è€Œ0x40000000ULè¿™ä¸ªå€¼å°±ä»£è¡¨ç€1GBã€‚ä¹Ÿå°±æ˜¯è¯´ç³»ç»Ÿæœ€å¤šèƒ½äº§ç”Ÿä¸é‡å¤çš„LOG_BLOCK_HDR_NOå€¼åªæœ‰1GBä¸ªã€‚InnoDBè§„å®šredoæ—¥å¿—æ–‡ä»¶ç»„ä¸­åŒ…å«çš„æ‰€æœ‰æ–‡ä»¶å¤§å°æ€»å’Œä¸å¾—è¶…è¿‡512GBï¼Œä¸€ä¸ªblockå¤§å°æ˜¯512å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­åŒ…å«çš„blockå—æœ€å¤šä¸º1GBä¸ªï¼Œæ‰€ä»¥æœ‰1GBä¸ªä¸é‡å¤çš„ç¼–å·å€¼ä¹Ÿå°±å¤Ÿç”¨äº†ã€‚ å¦å¤–ï¼ŒLOG_BLOCK_HDR_NOå€¼çš„ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½æ¯”è¾ƒç‰¹æ®Šï¼Œç§°ä¹‹ä¸ºflush bitï¼Œå¦‚æœè¯¥å€¼ä¸º1ï¼Œä»£è¡¨ç€æœ¬blockæ˜¯åœ¨æŸæ¬¡å°†log bufferä¸­çš„blockåˆ·æ–°åˆ°ç£ç›˜çš„æ“ä½œä¸­çš„ç¬¬ä¸€ä¸ªè¢«åˆ·å…¥çš„blockã€‚ åï¼Œdouble write1.è„é¡µåˆ·ç›˜é£é™©å…³äºIOçš„æœ€å°å•ä½ï¼š æ•°æ®åº“IOçš„æœ€å°å•ä½æ˜¯16Kï¼ˆMySQLé»˜è®¤ï¼Œoracleæ˜¯8Kï¼‰ æ–‡ä»¶ç³»ç»ŸIOçš„æœ€å°å•ä½æ˜¯4Kï¼ˆä¹Ÿæœ‰1Kçš„ï¼‰ ç£ç›˜IOçš„æœ€å°å•ä½æ˜¯512å­—èŠ‚ å› æ­¤ï¼Œå­˜åœ¨IOå†™å…¥å¯¼è‡´pageæŸåçš„é£é™©ï¼š 2.doublewriteï¼šä¸¤æ¬¡å†™æé«˜innodbçš„å¯é æ€§ï¼Œç”¨æ¥è§£å†³éƒ¨åˆ†å†™å¤±è´¥(partial page writeé¡µæ–­è£‚)ã€‚ 2.1 Double writeè§£å†³äº†ä»€ä¹ˆé—®é¢˜ä¸€ä¸ªæ•°æ®é¡µçš„å¤§å°æ˜¯16Kï¼Œå‡è®¾åœ¨æŠŠå†…å­˜ä¸­çš„è„é¡µå†™åˆ°æ•°æ®åº“çš„æ—¶å€™ï¼Œå†™äº†2Kçªç„¶æ‰ç”µï¼Œä¹Ÿå°±æ˜¯è¯´å‰2Kæ•°æ®æ˜¯æ–°çš„ï¼Œå14Kæ˜¯æ—§çš„ï¼Œé‚£ä¹ˆç£ç›˜æ•°æ®åº“è¿™ä¸ªæ•°æ®é¡µå°±æ˜¯ä¸å®Œæ•´çš„ï¼Œæ˜¯ä¸€ä¸ªåæ‰çš„æ•°æ®é¡µã€‚redoåªèƒ½åŠ ä¸Šæ—§ã€æ ¡æ£€å®Œæ•´çš„æ•°æ®é¡µæ¢å¤ä¸€ä¸ªè„å—ï¼Œä¸èƒ½ä¿®å¤åæ‰çš„æ•°æ®é¡µï¼Œæ‰€ä»¥è¿™ä¸ªæ•°æ®å°±ä¸¢å¤±äº†ï¼Œå¯èƒ½ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦double writeã€‚ 2.2ä½¿ç”¨æƒ…æ™¯å½“æ•°æ®åº“æ­£åœ¨ä»å†…å­˜æƒ³ç£ç›˜å†™ä¸€ä¸ªæ•°æ®é¡µæ˜¯ï¼Œæ•°æ®åº“å®•æœºï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªé¡µåªå†™äº†éƒ¨åˆ†æ•°æ®ï¼Œè¿™å°±æ˜¯éƒ¨åˆ†å†™å¤±æ•ˆï¼Œå®ƒä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚è¿™æ—¶æ˜¯æ— æ³•é€šè¿‡é‡åšæ—¥å¿—æ¢å¤çš„ï¼Œå› ä¸ºé‡åšæ—¥å¿—è®°å½•çš„æ˜¯å¯¹é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œå¦‚æœé¡µæœ¬èº«å·²ç»æŸåï¼Œé‡åšæ—¥å¿—ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚ 2.3 double writeå·¥ä½œæµç¨‹ doublewriteç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†ä¸ºå†…å­˜ä¸­çš„doublewrite bufferï¼Œå…¶å¤§å°ä¸º2MBï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ç£ç›˜ä¸Šå…±äº«è¡¨ç©ºé—´(ibdata x)ä¸­è¿ç»­çš„128ä¸ªé¡µï¼Œå³2ä¸ªåŒº(extent)ï¼Œå¤§å°ä¹Ÿæ˜¯2Mã€‚ å½“ä¸€ç³»åˆ—æœºåˆ¶è§¦å‘æ•°æ®ç¼“å†²æ± ä¸­çš„è„é¡µåˆ·æ–°æ—¶ï¼Œå¹¶ä¸ç›´æ¥å†™å…¥ç£ç›˜æ•°æ®æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯å…ˆæ‹·è´è‡³å†…å­˜ä¸­çš„doublewrite bufferä¸­ï¼› æ¥ç€ä»ä¸¤æ¬¡å†™ç¼“å†²åŒºåˆ†ä¸¤æ¬¡å†™å…¥ç£ç›˜å…±äº«è¡¨ç©ºé—´ä¸­(è¿ç»­å­˜å‚¨ï¼Œé¡ºåºå†™ï¼Œæ€§èƒ½å¾ˆé«˜)ï¼Œæ¯æ¬¡å†™1MBï¼› å¾…ç¬¬äºŒæ­¥å®Œæˆåï¼Œå†å°†doublewrite bufferä¸­çš„è„é¡µæ•°æ®å†™å…¥å®é™…çš„å„ä¸ªè¡¨ç©ºé—´æ–‡ä»¶(ç¦»æ•£å†™)ï¼›(è„é¡µæ•°æ®å›ºåŒ–åï¼Œå³è¿›è¡Œæ ‡è®°å¯¹åº”doublewriteæ•°æ®å¯è¦†ç›–) 2.4 doublewriteçš„å´©æºƒæ¢å¤å¦‚æœæ“ä½œç³»ç»Ÿåœ¨å°†é¡µå†™å…¥ç£ç›˜çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå´©æºƒï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œinnodbå­˜å‚¨å¼•æ“å¯ä»¥ä»å…±äº«è¡¨ç©ºé—´çš„doublewriteä¸­æ‰¾åˆ°è¯¥é¡µçš„ä¸€ä¸ªæœ€è¿‘çš„å‰¯æœ¬ï¼Œå°†å…¶å¤åˆ¶åˆ°è¡¨ç©ºé—´æ–‡ä»¶ï¼Œå†åº”ç”¨redo logï¼Œå°±å®Œæˆäº†æ¢å¤è¿‡ç¨‹ã€‚å› ä¸ºæœ‰å‰¯æœ¬æ‰€ä»¥ä¹Ÿä¸æ‹…å¿ƒè¡¨ç©ºé—´ä¸­æ•°æ®é¡µæ˜¯å¦æŸåã€‚ Qï¼šä¸ºä»€ä¹ˆ*log write*ä¸éœ€è¦*doublewrite*çš„æ”¯æŒï¼Ÿ Aï¼šå› ä¸º*redolog*å†™å…¥çš„å•ä½å°±æ˜¯512å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ç£ç›˜IOçš„æœ€å°å•ä½ï¼Œæ‰€ä»¥æ— æ‰€è°“æ•°æ®æŸåã€‚ 3.doublewriteçš„å‰¯ä½œç”¨3.1 double writeå¸¦æ¥çš„å†™è´Ÿè½½ double writeæ˜¯ä¸€ä¸ªbuffer, ä½†å…¶å®å®ƒæ˜¯å¼€åœ¨ç‰©ç†æ–‡ä»¶ä¸Šçš„ä¸€ä¸ªbuffer, å…¶å®ä¹Ÿå°±æ˜¯file, æ‰€ä»¥å®ƒä¼šå¯¼è‡´ç³»ç»Ÿæœ‰æ›´å¤šçš„fsyncæ“ä½œ, è€Œç¡¬ç›˜çš„fsyncæ€§èƒ½æ˜¯å¾ˆæ…¢çš„, æ‰€ä»¥å®ƒä¼šé™ä½mysqlçš„æ•´ä½“æ€§èƒ½ã€‚ ä½†æ˜¯ï¼Œdoublewrite bufferå†™å…¥ç£ç›˜å…±äº«è¡¨ç©ºé—´è¿™ä¸ªè¿‡ç¨‹æ˜¯è¿ç»­å­˜å‚¨ï¼Œæ˜¯é¡ºåºå†™ï¼Œæ€§èƒ½éå¸¸é«˜ï¼Œ(çº¦å å†™çš„10%)ï¼Œç‰ºç‰²ä¸€ç‚¹å†™æ€§èƒ½æ¥ä¿è¯æ•°æ®é¡µçš„å®Œæ•´è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ 3.2 ç›‘æ§double writeå·¥ä½œè´Ÿè½½12345678mysql&gt; show global status like &#x27;%dblwr%&#x27;;+----------------------------+-------+| Variable_name | Value |+----------------------------+-------+| Innodb_dblwr_pages_written | 7 || Innodb_dblwr_writes | 3 |+----------------------------+-------+2 rows in set (0.00 sec) å…³æ³¨ç‚¹ï¼šInnodb_dblwr_pages_written / Innodb_dblwr_writes å¼€å¯doublewriteåï¼Œæ¯æ¬¡è„é¡µåˆ·æ–°å¿…é¡»è¦å…ˆå†™doublewriteï¼Œè€Œdoublewriteå­˜åœ¨äºç£ç›˜ä¸Šçš„æ˜¯ä¸¤ä¸ªè¿ç»­çš„åŒºï¼Œæ¯ä¸ªåŒºç”±è¿ç»­çš„é¡µç»„æˆï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªåŒºæœ€å¤šæœ‰64ä¸ªé¡µï¼Œæ‰€ä»¥ä¸€æ¬¡IOå†™å…¥åº”è¯¥å¯ä»¥æœ€å¤šå†™64ä¸ªé¡µã€‚ è€Œæ ¹æ®ä»¥ä¸Šç³»ç»ŸInnodb_dblwr_pages_writtenä¸Innodb_dblwr_writesçš„æ¯”ä¾‹æ¥çœ‹ï¼Œå¤§æ¦‚åœ¨3å·¦å³ï¼Œè¿œè¿œè¿˜æ²¡åˆ°64(å¦‚æœçº¦ç­‰äº64ï¼Œé‚£ä¹ˆè¯´æ˜ç³»ç»Ÿçš„å†™å‹åŠ›éå¸¸å¤§ï¼Œæœ‰å¤§é‡çš„è„é¡µè¦å¾€ç£ç›˜ä¸Šå†™)ï¼Œæ‰€ä»¥ä»è¿™ä¸ªè§’åº¦ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿå†™å…¥å‹åŠ›å¹¶ä¸é«˜ã€‚ 3.3 å…³é—­double writeé€‚åˆçš„åœºæ™¯ æµ·é‡DML ä¸æƒ§æ€•æ•°æ®æŸåå’Œä¸¢å¤± ç³»ç»Ÿå†™è´Ÿè½½æˆä¸ºä¸»è¦è´Ÿè½½ 1234567mysql&gt; show variables like &#x27;%double%&#x27;;+--------------------+-------+| Variable_name | Value |+--------------------+-------+| innodb_doublewrite | ON |+--------------------+-------+1 row in set (0.04 sec) ä½œä¸ºInnoDBçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ï¼ŒdoublewriteåŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œä½†æ˜¯åœ¨ä¸Šè¿°ç‰¹æ®Šçš„ä¸€äº›åœºæ™¯ä¹Ÿå¯ä»¥è§†æƒ…å†µå…³é—­ï¼Œæ¥æé«˜æ•°æ®åº“å†™æ€§èƒ½ã€‚é™æ€å‚æ•°ï¼Œé…ç½®æ–‡ä»¶ä¿®æ”¹ï¼Œé‡å¯æ•°æ®åº“ã€‚ 3.4 ä¸ºä»€ä¹ˆæ²¡æœ‰æŠŠdouble writeé‡Œé¢çš„æ•°æ®å†™åˆ°data pageé‡Œé¢å‘¢ï¼Ÿ double writeé‡Œé¢çš„æ•°æ®æ˜¯è¿ç»­çš„ï¼Œå¦‚æœç›´æ¥å†™åˆ°data pageé‡Œé¢ï¼Œè€Œdata pageçš„é¡µåˆæ˜¯ç¦»æ•£çš„ï¼Œå†™å…¥ä¼šå¾ˆæ…¢ã€‚ double writeé‡Œé¢çš„æ•°æ®æ²¡æœ‰åŠæ³•è¢«åŠæ—¶çš„è¦†ç›–æ‰ï¼Œå¯¼è‡´double writeçš„å‹åŠ›å¾ˆå¤§ï¼›çŸ­æ—¶é—´å†…å¯èƒ½ä¼šå‡ºç°double writeæº¢å‡ºçš„æƒ…å†µã€‚ åä¸€ï¼Œæ€»ç»“redoæ—¥å¿—è®°å½•äº†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½ä¿®æ”¹äº†å“ªäº›å†…å®¹ã€‚ äº‹åŠ¡æäº¤æ—¶åªå°†æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„é¡µé¢éƒ½åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š redoæ—¥å¿—å ç”¨çš„ç©ºé—´éå¸¸å° redoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„ ä¸€æ¡redoæ—¥å¿—ç”±ä¸‹é¢å‡ éƒ¨åˆ†ç»„æˆã€‚ typeï¼šè¿™æ¡redoæ—¥å¿—çš„ç±»å‹ space ID:è¡¨ç©ºé—´ID page number :é¡µå· dataï¼šè¿™æ¡redoæ—¥å¿—çš„å…·ä½“å†…å®¹ redoæ—¥å¿—çš„ç±»å‹æœ‰ç®€å•å’Œå¤æ‚ä¹‹åˆ†ã€‚ç®€å•ç±»å‹çš„redoæ—¥å¿—æ˜¯çº¯ç²¹çš„ç‰©ç†æ—¥å¿—ï¼Œå¤æ‚ç±»å‹çš„redoæ—¥å¿—å…¼æœ‰ç‰©ç†æ—¥å¿—å’Œé€»è¾‘æ—¥å¿—çš„ç‰¹æ€§ã€‚ ä¸€ä¸ªMTRå¯ä»¥åŒ…å«ä¸€ç»„redoæ—¥å¿—ã€‚åœ¨è¿›è¡Œå´©æºƒæ¢å¤æ—¶ï¼Œè¿™ä¸€ç»„redoæ—¥å¿—ä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“æ¥å¤„ç†ã€‚ redoæ—¥å¿—å­˜æ”¾åœ¨å¤§å°ä¸º512å­—èŠ‚çš„blockä¸­ã€‚æ¯ä¸€ä¸ªblockè¢«åˆ†ä¸º3éƒ¨åˆ†ï¼š log block header log block body log block trailer redoæ—¥å¿—ç¼“å†²åŒºæ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç”±è‹¥å¹²ä¸ªblockç»„æˆï¼›å¯ä»¥é€šè¿‡å¯åŠ¨é€‰é¡¹innodb_log_buffer_size æ¥è°ƒæ•´ä»–çš„å¤§å°ã€‚ redoæ—¥å¿—æ–‡ä»¶ç»„ç”±è‹¥å¹²ä¸ªæ—¥å¿—æ–‡ä»¶ç»„æˆï¼Œè¿™äº›redoæ—¥å¿—æ–‡ä»¶æ˜¯è¢«å¾ªç¯ä½¿ç”¨çš„ã€‚redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­æ¯ä¸ªæ–‡ä»¶çš„å¤§å°éƒ½ä¸€æ ·ï¼Œæ ¼å¼ä¹Ÿä¸€æ ·ï¼Œéƒ½æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼š å‰2048å­—èŠ‚ç”¨æ¥å­˜å‚¨ä¸€äº›ç®¡ç†ä¿¡æ¯ ä»ç¬¬2048å­—èŠ‚å¾€åçš„å­—èŠ‚ç”¨æ¥å­˜å‚¨log bufferä¸­çš„blocké•œåƒ lsnæŒ‡å·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œflushed_to_disk_lsnæŒ‡åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„redoæ—¥å¿—é‡ï¼Œflushé“¾è¡¨ä¸­çš„è„é¡µæŒ‰ç…§ä¿®æ”¹å‘ç”Ÿçš„æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§oldest_modificationä»£è¡¨çš„lsnå€¼è¿›è¡Œæ’åºã€‚è¢«å¤šæ¬¡æ›´æ–°çš„é¡µé¢ä¸ä¼šé‡å¤æ’å…¥åˆ°flushé“¾è¡¨ï¼Œä½†æ˜¯ä¼šæ›´æ–°newest_modificationå±æ€§çš„å€¼ã€‚checkpoint_lsnè¡¨ç¤ºå½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—æ€»é‡æ˜¯å¤šå°‘ã€‚ redoæ—¥å¿—å ç”¨çš„ç£ç›˜ç©ºé—´åœ¨ä»–å¯¹åº”çš„è„é¡µå·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜åå³å¯è¢«è¦†ç›–ã€‚æ‰§è¡Œä¸€æ¬¡checkpointçš„æ„æ€å°±æ˜¯å¢åŠ checkpoint_lsnçš„å€¼ï¼Œç„¶åæŠŠç›¸å…³ä¿¡æ¯æ”¾åˆ°æ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚ innodb_flush_log_at_trx_commitç³»ç»Ÿå˜é‡æ§åˆ¶ç€åœ¨äº‹åŠ¡æäº¤æ—¶æ˜¯å¦å°†è¯¥äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoåˆ·æ–°åˆ°ç£ç›˜ã€‚ åœ¨å´©æºƒæ¢å¤è¿‡ç¨‹ä¸­ï¼Œä»redoæ—¥å¿—æ–‡ä»¶ç»„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­å–å‡ºæœ€è¿‘å‘ç”Ÿçš„é‚£æ¬¡checkpointä¿¡æ¯ï¼Œç„¶åä»checkpoint_lsnåœ¨æ—¥å¿—æ–‡ä»¶ç»„ä¸­å¯¹åº”çš„åç§»é‡å¼€å§‹ï¼Œä¸€ç›´æ‰«ææ—¥å¿—æ–‡ä»¶ä¸­çš„blockï¼Œç›´åˆ°æŸä¸ªblockçš„LOG_BLOCK_HDR_DATA_LENå€¼ä¸ç­‰äº512ä¸ºæ­¢ã€‚å†æ¢å¤è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨hashè¡¨å¯åŠ å¿«æ¢å¤è¿‡ç¨‹ï¼Œå¹¶ä¸”ä¼šè·³è¿‡å·²ç»åˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢ã€‚","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]}],"categories":[{"name":"5.ç¼“å­˜","slug":"5-ç¼“å­˜","permalink":"https://zhangxin66666.github.io/categories/5-%E7%BC%93%E5%AD%98/"},{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"},{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://zhangxin66666.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"},{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"},{"name":"11.æ–¹æ³•è®º","slug":"11-æ–¹æ³•è®º","permalink":"https://zhangxin66666.github.io/categories/11-%E6%96%B9%E6%B3%95%E8%AE%BA/"}],"tags":[{"name":"redis","slug":"redis","permalink":"https://zhangxin66666.github.io/tags/redis/"},{"name":"JVM","slug":"JVM","permalink":"https://zhangxin66666.github.io/tags/JVM/"},{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://zhangxin66666.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://zhangxin66666.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/tags/%E9%9D%A2%E8%AF%95/"},{"name":"æ–¹æ³•è®º","slug":"æ–¹æ³•è®º","permalink":"https://zhangxin66666.github.io/tags/%E6%96%B9%E6%B3%95%E8%AE%BA/"}]}