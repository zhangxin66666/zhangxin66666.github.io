{"meta":{"title":"é‡‘å­çˆ¸çˆ¸ã®å®¶","subtitle":"çƒ­çˆ±ç”Ÿæ´»ï¼Œå–œæ¬¢è½¯ä»¶","description":"æ¬¢è¿æ¥åˆ°é‡‘å­çˆ¸çˆ¸åšå®¢ã®å®¶","author":"é‡‘å­çˆ¸çˆ¸","url":"https://zhangxin66666.github.io","root":"/"},"pages":[{"title":"åˆ†ç±»","date":"2022-01-11T01:48:58.103Z","updated":"2022-01-11T01:48:58.103Z","comments":true,"path":"categories/index.html","permalink":"https://zhangxin66666.github.io/categories/index.html","excerpt":"","text":""},{"title":"","date":"2022-03-31T12:05:20.736Z","updated":"2022-03-31T12:05:20.736Z","comments":true,"path":"css/custom.css","permalink":"https://zhangxin66666.github.io/css/custom.css","excerpt":"","text":"/* æ–‡ç« é¡µH1-H6å›¾æ ‡æ ·å¼æ•ˆæœ */ h1::before, h2::before, h3::before, h4::before, h5::before, h6::before { -webkit-animation: ccc 1.6s linear infinite ; animation: ccc 1.6s linear infinite ; } @-webkit-keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } @keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } #content-inner.layout h1::before { color: #ef50a8 ; margin-left: -1.55rem; font-size: 1.3rem; margin-top: -0.23rem; } #content-inner.layout h2::before { color: #fb7061 ; margin-left: -1.35rem; font-size: 1.1rem; margin-top: -0.12rem; } #content-inner.layout h3::before { color: #ffbf00 ; margin-left: -1.22rem; font-size: 0.95rem; margin-top: -0.09rem; } #content-inner.layout h4::before { color: #a9e000 ; margin-left: -1.05rem; font-size: 0.8rem; margin-top: -0.09rem; } #content-inner.layout h5::before { color: #57c850 ; margin-left: -0.9rem; font-size: 0.7rem; margin-top: 0.0rem; } #content-inner.layout h6::before { color: #5ec1e0 ; margin-left: -0.9rem; font-size: 0.66rem; margin-top: 0.0rem; } #content-inner.layout h1:hover, #content-inner.layout h2:hover, #content-inner.layout h3:hover, #content-inner.layout h4:hover, #content-inner.layout h5:hover, #content-inner.layout h6:hover { color: #49b1f5 ; } #content-inner.layout h1:hover::before, #content-inner.layout h2:hover::before, #content-inner.layout h3:hover::before, #content-inner.layout h4:hover::before, #content-inner.layout h5:hover::before, #content-inner.layout h6:hover::before { color: #49b1f5 ; -webkit-animation: ccc 3.2s linear infinite ; animation: ccc 3.2s linear infinite ; } /* é¡µé¢è®¾ç½®iconè½¬åŠ¨é€Ÿåº¦è°ƒæ•´ */ #rightside_config i.fas.fa-cog.fa-spin { animation: fa-spin 5s linear infinite ; } /*--------æ›´æ¢å­—ä½“------------*/ @font-face { font-family: 'tzy'; /* å­—ä½“åè‡ªå®šä¹‰å³å¯ */ src: url('https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/font/ZhuZiAWan.woff2'); /* å­—ä½“æ–‡ä»¶è·¯å¾„ */ font-display: swap; } /*body,*/ /*.gitcalendar {*/ /* font-family: tzy !important;*/ /*}*/ .categoryBar-list { max-height: 400px; } .clock-row { overflow: hidden; text-overflow: ellipsis; } /*3sä¸ºåŠ è½½åŠ¨ç”»çš„æ—¶é—´ï¼Œ1ä¸ºåŠ è½½åŠ¨ç”»çš„æ¬¡æ•°ï¼Œease-in-outä¸ºåŠ¨ç”»æ•ˆæœ*/ #page-header, #web_bg { -webkit-animation: imgblur 2s 1 ease-in-out; animation: imgblur 2s 1 ease-in-out; } @keyframes imgblur { 0% { filter: blur(5px); } 100% { filter: blur(0px); } } /*é€‚é…ä½¿ç”¨-webkitå†…æ ¸çš„æµè§ˆå™¨ */ @-webkit-keyframes imgblur { 0% { -webkit-filter: blur(5px); } 100% { -webkit-filter: blur(0px); } } .table-wrap img { margin: .6rem auto .1rem !important; } /* æ ‡ç­¾å¤–æŒ‚ ç½‘ç«™å¡ç‰‡ start */ .site-card-group img { margin: 0 auto .1rem !important; } .site-card-group .info a img { margin-right: 10px !important; } [data-theme='dark'] .site-card-group .site-card .info .title { color: #f0f0f0 !important; } [data-theme='dark'] .site-card-group .site-card .info .desc { color: rgba(255, 255, 255, .7) !important; } .site-card-group .info .desc { margin-top: 4px !important; } /* ä»£ç å—é¢œè‰² */ figure.highlight pre .addition { color: #00bf03 !important; }"},{"title":"","date":"2022-03-31T12:05:25.237Z","updated":"2022-03-31T12:05:25.237Z","comments":true,"path":"js/chocolate.js","permalink":"https://zhangxin66666.github.io/js/chocolate.js","excerpt":"","text":"// å‹æƒ…é“¾æ¥é¡µé¢ å¤´åƒæ‰¾ä¸åˆ°æ—¶ æ›¿æ¢å›¾ç‰‡ if (location.href.indexOf(\"link\") !== -1) { var imgObj = document.getElementsByTagName(\"img\"); for (i = 0; i < imgObj.length; i++) { imgObj[i].onerror = function() { this.src = \"https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/friend_404.gif\" } } } $(function() { // æ°”æ³¡ function bubble() { $('#page-header').circleMagic({ radius: 10, density: .2, color: 'rgba(255,255,255,.4)', clearOffset: 0.99 }); }! function(p) { p.fn.circleMagic = function(t) { var o, a, n, r, e = !0, i = [], d = p.extend({ color: \"rgba(255,0,0,.5)\", radius: 10, density: .3, clearOffset: .2 }, t), l = this[0]; function c() { e = !(document.body.scrollTop > a) } function s() { o = l.clientWidth, a = l.clientHeight, l.height = a + \"px\", n.width = o, n.height = a } function h() { if (e) for (var t in r.clearRect(0, 0, o, a), i) i[t].draw(); requestAnimationFrame(h) } function f() { var t = this; function e() { t.pos.x = Math.random() * o, t.pos.y = a + 100 * Math.random(), t.alpha = .1 + Math.random() * d.clearOffset, t.scale = .1 + .3 * Math.random(), t.speed = Math.random(), \"random\" === d.color ? t.color = \"rgba(\" + Math.floor(255 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.random().toPrecision(2) + \")\" : t.color = d.color } t.pos = {}, e(), this.draw = function() { t.alpha"},{"title":"ç•™è¨€æ¿","date":"2022-01-11T01:48:58.203Z","updated":"2022-01-11T01:48:58.203Z","comments":true,"path":"message/index.html","permalink":"https://zhangxin66666.github.io/message/index.html","excerpt":"","text":"æœ¬é¡µé¢è¿˜åœ¨å¼€å‘ä¸­â€¦â€¦"},{"title":"æ ‡ç­¾","date":"2022-01-11T01:48:58.203Z","updated":"2022-01-11T01:48:58.203Z","comments":true,"path":"tags/index.html","permalink":"https://zhangxin66666.github.io/tags/index.html","excerpt":"","text":""},{"title":"å…³äºæˆ‘","date":"2022-03-31T02:55:43.206Z","updated":"2022-03-31T02:55:43.206Z","comments":true,"path":"å…³äºæˆ‘/index.html","permalink":"https://zhangxin66666.github.io/%E5%85%B3%E4%BA%8E%E6%88%91/index.html","excerpt":"","text":"å…³äºæˆ‘åå¹´ç”Ÿæ­»ä¸¤èŒ«èŒ«,å†™ç¨‹åºï¼Œåˆ°å¤©äº®ã€‚åƒè¡Œä»£ç ï¼ŒBugä½•å¤„è—ã€‚çºµä½¿ä¸Šçº¿åˆæ€æ ·ï¼Œæœä»¤æ”¹ï¼Œå¤•æ–­è‚ ã€‚é¢†å¯¼æ¯å¤©æ–°æƒ³æ³•ï¼Œå¤©å¤©æ”¹ï¼Œæ—¥æ—¥å¿™ã€‚ ç›¸é¡¾æ— è¨€ï¼ŒæƒŸæœ‰æ³ªåƒè¡Œã€‚æ¯æ™šç¯ç«é˜‘çŠå¤„ï¼Œç¨‹åºå‘˜ï¼ŒåˆåŠ ç­ï¼Œå·¥ä½œç‹‚~ æ¥ä¸€å¼ æ¥¼ä¸»æ— ç¾é¢œç”Ÿæ´»ç…§ï¼Œè§ç¬‘äº†ï¼ğŸ¤£ğŸ¤£ğŸ¤£ åŸºæœ¬ä¿¡æ¯ ç±»åˆ« ä¿¡æ¯ å‡ºç”Ÿå¹´æœˆ 1990å¹´2æœˆ ç°å±…åœ° åŒ—äº¬å¸‚æœé˜³åŒº ç±è´¯ è¾½å®çœé”¦å·å¸‚ é‚®ç®± &#x38;&#x33;&#x34;&#x36;&#49;&#x33;&#x32;&#64;&#113;&#113;&#x2e;&#99;&#111;&#x6d; æ•™è‚²ç»å† æ—¶é—´ å­¦æ ¡ ä¸“ä¸š å¤‡æ³¨ 2009.09~2013.07 æ²ˆé˜³åŒ–å·¥å¤§å­¦ ç”µå­ç§‘å­¦ä¸æŠ€æœ¯ ç»Ÿæ‹›æœ¬ç§‘ 2006.09~2009.07 è¾½å®çœåŒ—é•‡å¸‚é«˜çº§ä¸­å­¦ é«˜çº§åŸºç¡€æ•™è‚² å¸‚é‡ç‚¹ å·¥ä½œç»å† æ—¶é—´ å…¬å¸ èŒä½ 2021.04~è‡³ä»Š é¾™æ¹–é›†å›¢ Java å¼€å‘å·¥ç¨‹å¸ˆ 2017.05~2021.04 åŒ…å¤´å¸‚åŒ…é“¶æ¶ˆè´¹é‡‘èè‚¡ä»½æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ 2016.09~2017.04 å¤§è¿çµåŠ¨ç§‘æŠ€å‘å±•æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ 2013.07~2016.08 å¤§è¿å®‰å‰å°¼å°”ç§‘æŠ€æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ ä¸“ä¸šæŠ€èƒ½ Java åŸºç¡€æ‰å®ã€æŒæ¡ JVM åŸç†ã€å¤šçº¿ç¨‹ã€ç½‘ç»œåŸç†ã€è®¾è®¡æ¨¡å¼ã€å¸¸ç”¨çš„æ•°æ®ç»“æ„å’Œç®—æ³• ç†Ÿæ‚‰ Windowsã€Macã€Linux æ“ä½œç³»ç»Ÿï¼Œç†Ÿç»ƒä½¿ç”¨ linux å¸¸ç”¨æ“ä½œæŒ‡ä»¤ ç†Ÿç»ƒä½¿ç”¨ IntelliJ IDEA å¼€å‘å·¥å…·(åŠå„ç§æ’ä»¶)ã€ç†Ÿç»ƒä½¿ç”¨ Git ç‰ˆæœ¬åŒæ­¥å·¥å…· é˜…è¯»è¿‡ Springã€SpringMVCã€ç­‰å¼€æºæ¡†æ¶æºç ï¼Œç†è§£å…¶è®¾è®¡åŸç†åŠåº•å±‚æ¶æ„ï¼Œå…·å¤‡æ¡†æ¶å®šåˆ¶å¼€å‘èƒ½åŠ› ç†è§£ Redis çº¿ç¨‹æ¨¡å‹ï¼ŒNetty çº¿ç¨‹æ¨¡å‹ï¼ŒæŒæ¡åŸºäºå“åº”å¼çš„å¼‚æ­¥éé˜»å¡æ¨¡å‹çš„åŸºæœ¬åŸç†ï¼Œäº†è§£ Webflux ç†Ÿç»ƒæŒæ¡åˆ†å¸ƒå¼ç¼“å­˜ Redisã€Elaticsearchï¼Œå¯¹åˆ†å¸ƒå¼é”ï¼Œå¹‚ç­‰ç­‰å¸¸è§é—®é¢˜æœ‰æ·±å…¥ç ”ç©¶åŠå¤šå¹´å®æˆ˜ç»éªŒ ç†Ÿæ‚‰å¸¸è§æ¶ˆæ¯ä¸­é—´ä»¶çš„ä½¿ç”¨ï¼Œæœ‰å¤šå¹´ RabbitMQ çš„å®æˆ˜å¼€å‘ç»éªŒï¼Œå¯¹é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—æœ‰æ·±å…¥ç†è§£ ç†Ÿç»ƒæŒæ¡ Mysql äº‹åŠ¡ï¼Œç´¢å¼•ï¼Œé”ï¼ŒSQL ä¼˜åŒ–ç›¸å…³çŸ¥è¯†ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯ç»™å‡ºè¯¦ç»†åŠé«˜æ€§èƒ½è®¾è®¡æ–¹æ¡ˆ ç†Ÿç»ƒä½¿ç”¨æ•°æ®åº“æ“ä½œæ¡†æ¶ Mybatisã€Mybatsi-plus è¿›è¡Œé«˜æ•ˆä¸šåŠ¡åŠŸèƒ½å¼€å‘ æŒæ¡ springCloud ç›¸å…³æ¡†æ¶ï¼Œå¯¹ SpringBootã€SpringCloud åŸç†æœ‰ä¸€å®šäº†è§£ï¼Œæœ‰æˆç†Ÿé¡¹ç›®ç»éªŒ ç†Ÿæ‚‰å®šæ—¶ä»»åŠ¡åŠå»¶è¿Ÿä»»åŠ¡ç­‰ä¸šåŠ¡ç›¸å…³è®¾è®¡ï¼Œå¦‚ xxl-jobï¼Œå»¶è¿Ÿæ¶ˆæ¯ç­‰ç›¸å…³æŠ€æœ¯æœ‰å¤šå¹´å¼€å‘ç»éªŒ ç†Ÿæ‚‰å¾®æœåŠ¡æ€æƒ³ï¼ŒMVC åˆ†å±‚ï¼ŒDDD ç†è®ºï¼ŒæœåŠ¡æ‹†åˆ†ï¼Œæ²»ç†ï¼Œç›‘æ§ï¼ŒæœåŠ¡ç†”æ–­ï¼Œé™çº§ç­‰ç›¸å…³èƒ½åŠ› ç†Ÿæ‚‰ jvm åŸç†ï¼Œç†Ÿæ‚‰åƒåœ¾å›æ”¶ä»¥ jvm æ€§èƒ½è°ƒä¼˜æŠ€æœ¯ï¼Œæœ‰è¿‡çº¿ä¸ŠæœåŠ¡å™¨æ€§èƒ½ç›‘æµ‹åŠè°ƒä¼˜ç»éªŒ ç†Ÿæ‚‰å¤šçº¿ç¨‹åŠçº¿ç¨‹æ± ä½¿ç”¨ï¼Œæœ‰å¤šå¹´å¤šçº¿ç¨‹ä¸šåŠ¡å¤„ç†ç»éªŒï¼Œå°è£…è¿‡å¤šçº¿ç¨‹æ‰¹å¤„ç†å·¥å…·ç±»ç­‰å…¬ç”¨ç»„å»º äº†è§£ Mysql åˆ†åº“åˆ†è¡¨ç›¸å…³åŸç†ï¼Œå¦‚ Sardingsphereã€Mycat ç­‰æ¡†æ¶æœ‰ç›¸å…³ä½¿ç”¨ç»éªŒ äº†è§£æ“ä½œç³»ç»Ÿåº•å±‚åŸç†ä»¥åŠ Cã€C++ç¨‹åºå¼€å‘ï¼Œå¯¹è®¡ç®—æœºåº•å±‚åŸç†æœ‰åˆæ­¥äº†è§£ äº†è§£å‰ç«¯å¼€å‘ï¼Œäº†è§£ htmlï¼Œcssï¼Œjsï¼Œvue ç­‰å‰ç«¯æŠ€æœ¯ï¼Œå¯¹å‰ç«¯å¼€å‘æœ‰ä¸€å®šçš„äº†è§£ ç ”ç©¶è¿‡å•ç‰‡æœºç­‰ç¡¬ä»¶å¼€å‘ï¼Œå–œæ¬¢ç§‘æŠ€äº§å“ï¼Œå–œæ¬¢è½¯ä»¶ï¼Œå–œæ¬¢æŠ˜è…¾å„ç§ç”µå­äº§å“ä»¥åŠè½¯ä»¶ é¡¹ç›®ç»éªŒâ€‹ é¡¹ç›®ç»éªŒåªå†™äº†åœ¨åŒ—äº¬ä¹‹åå‚ä¸è¿‡çš„ç›¸å…³é¡¹ç›®ï¼Œåœ¨å¤§è¿åšçš„é¡¹ç›®åå‘äºä¼ ç»Ÿï¼Œé¡¹ç›®ä¹Ÿéƒ½æ˜¯å•ç‚¹éƒ¨ç½²ï¼Œä¸»è¦ç”¨çš„æ¡†æ¶éƒ½æ˜¯springã€mybatisã€Hibernateã€springMVCç­‰ç›¸äº’ç»“åˆä½¿ç”¨ï¼Œå³ï¼šSSMï¼ŒSSHï¼Œç›¸æ¯”äºspringBootæ¥è¯´ä¸å€¼ä¸€æï¼Œç°åœ¨åº”è¯¥æ²¡æœ‰å‡ ä¸ªå…¬å¸è¿˜æ²¡ç”¨springBootäº†å§(#^.^#)ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåˆšæ¯•ä¸šé‚£ä¼šï¼Œåšäº†åŠå¹´çš„Cè¯­è¨€åµŒå…¥å¼å¼€å‘ï¼Œå¤–åŒ…åˆ°å¤§è¿ä¸œè½¯åšå¯¹æ—¥çš„ä½³èƒ½ç›¸æœºç³»ç»Ÿï¼Œè™½ç„¶ç›®å‰æˆ‘å·²ç»åšäº†å¤šå¹´çš„javaå¼€å‘ï¼Œä½†æ˜¯é‚£æ¯•ç«Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å‚åŠ å¼€å‘é¡¹ç›®ï¼Œäººéƒ½æ˜¯æœ‰åˆæ‹æƒ…èŠ‚çš„å˜›ï¼Œå¯¹è‡ªå·±çš„ç¬¬ä¸€æ¬¡å¿µå¿µä¸å¿˜(æˆ‘æŒ‡å¾—æ˜¯å·¥ä½œğŸ¤­)ï¼Œé‚£åŠå¹´è®©æˆ‘å¯¹ç¡¬ä»¶åº•å±‚æœ‰äº†ä¸€äº›ç†è§£ï¼Œä¹Ÿç®—æ˜¯æœ€å¤§çš„æ”¶è·äº†å§ã€‚ â€”â€” åŒ…é“¶æ¶ˆè´¹é‡‘è(ç°åï¼šè’™å•†æ¶ˆè´¹) â€”â€”â€‹ åŒ…å¤´å¸‚åŒ…é“¶æ¶ˆè´¹é‡‘èè‚¡ä»½æœ‰é™å…¬å¸æ˜¯ç»ä¸­å›½é“¶ç›‘ä¼šæ‰¹å‡†æˆç«‹çš„æŒç‰Œæ¶ˆè´¹é‡‘èå…¬å¸ï¼Œç”±åŒ…å•†é“¶è¡Œå‘èµ·è®¾ç«‹ï¼ŒåŒ…é“¶æ¶ˆè´¹é‡‘èä¸ºä¸ªäººæ¶ˆè´¹è€…æä¾›æ¶ˆè´¹ä¿¡è´·æœåŠ¡ã€‚å…¶ä¸»è¦åˆä½œæ¸ é“æœ‰ï¼šè¯å¤§è´¢å¯Œï¼Œäº¬ä¸œé‡‘æ¡ï¼Œå¾®ç²’è´·ï¼Œå»å“ªå„¿ï¼Œäº¬ä¸œå€Ÿè´·å¹³å°ï¼Œåˆ†æœŸä¹ï¼Œå°ç±³ç­‰å¤šå®¶æ”¾æ¬¾æ¸ é“ã€‚ç›®å‰ï¼Œå·²ç´¯è®¡å®Œæˆ 1200 å¤šä¸‡å®¢æˆ·æ³¨å†Œå’Œ 320 å¤šäº¿æ”¾æ¬¾è§„æ¨¡ã€‚ acsï¼šæ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿä¸»è¦åŒ…å«ä¿¡è´·æ ¸ç®—ä¸šåŠ¡å’Œè™šæ‹Ÿè´¦æˆ·ä¸šåŠ¡ï¼Œä¿¡è´·æ ¸ç®—ä¸»è¦è´Ÿè´£å€Ÿè¿˜æ¬¾ã€æ ¸é”€å‡å…äº¤æ˜“ã€åˆ©æ¯ã€ç½šæ¯è®¡æã€å„ç§è´¹ç”¨ç­‰ä¸šåŠ¡çš„è®¡ç®—å’Œè½åœ°ï¼Œæ—¥ç»ˆç”Ÿæˆäº¤æ˜“æµæ°´æ–‡ä»¶ä¾›ä¼šè®¡æ ¸ç®—ç³»ç»Ÿç”Ÿæˆä¼šè®¡åˆ†å½•ï¼›è™šæ‹Ÿè´¦æˆ·éƒ¨åˆ†ä¸»è¦ä¸ºæ¸…ç»“ç®—äººå‘˜æä¾›äº¤æ˜“äº§ç”Ÿçš„ä¸åŒèµ„é‡‘è´¦æˆ·é‡‘é¢çš„å˜åŒ–åŠèµ„é‡‘æµå‘ï¼Œä¸ºæ¸…ç»“ç®—äººå‘˜å¯¹è´¦æä¾›æ•°æ®æ”¯æŒï¼›ç³»ç»Ÿå¯ä»¥å¤„ç†æ¯åˆ†é’Ÿå³°å€¼ 640 å¤šç¬”æˆä¿¡ç”³è¯·ï¼Œæ¯å°æ—¶å³°å€¼ 2 ä¸‡ç¬”æˆä¿¡ç”³è¯·ï¼Œè´·åæ”¯æŒæ¯å°æ—¶ 17 ä¸‡å®¢æˆ·æ•°æ®ã€‚æ ¸å¿ƒæ—¥ç»ˆå¤„ç†é‡è¾¾ 152 ä¸‡ç¬”(å€Ÿæ®æ•°é‡)ã€‚ glsï¼šè´¢åŠ¡æ ¸ç®—ç³»ç»Ÿå¯¹æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿæ—¥ç»ˆç”Ÿæˆçš„äº¤æ˜“æµæ°´è§£æä¹‹åæŒ‰ç…§åˆ†å½•å€Ÿè´·è§„åˆ™ç”Ÿæˆè´¢åŠ¡åˆ†å½•æ–‡ä»¶äº¤ç»™é‡‘è¶ç³»ç»Ÿï¼Œ17 å¹´è´¢åŠ¡æ ¸ç®—ç³»ç»Ÿæ˜¯ä¹°æ¥çš„ç³»ç»Ÿï¼Œ19 å¹´ç”±æˆ‘é‡æ–°å¼€å‘å‡ºå±äºå…¬å¸è‡ªå·±çš„è´¢åŠ¡æ ¸ç®—ç³»ç»Ÿï¼Œå¹¶å¢åŠ äº†è´¢åŠ¡å¯¹è´¦åŠŸèƒ½(æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿå’Œè´¢åŠ¡åˆ†å½•å¯¹è´¦)ï¼Œä¸ä½†åŠæ—¶å‘ç°çº¿ä¸Šäº¤æ˜“çš„é”™è¯¯æ•°æ®ï¼ŒåŠæ—¶è§£å†³é—®é¢˜ï¼Œæ›´æå‡äº†æœˆç»ˆå¯¹è´¦ï¼Œå¹´ç»“çš„æ•ˆç‡ï¼Œå®ç°äº†è´¢åŠ¡å¯¹è´¦è‡ªåŠ¨åŒ–ï¼Œè§£å†³äº†å¹´ç»“äººå·¥å¯¹è´¦çš„ç—›ç‚¹ã€‚ ecifï¼šæ¸ é“ç³»ç»Ÿè¦è´Ÿè´£å¯¹æ¥ç¬¬ä¸‰æ–¹å¼•æµæ¸ é“ï¼Œå®¢æˆ·é€šè¿‡ç¬¬ä¸‰æ–¹æ¸ é“æˆä¿¡ã€å€Ÿæ¬¾ï¼Œæ¸ é“å¼•æµåˆ°åŒ…é“¶ï¼Œç”±äºä¸åŒæ¸ é“çš„æˆä¿¡ã€æ”¾æ¬¾ä¸šåŠ¡é€»è¾‘ä¸åŒï¼Œé’ˆå¯¹ä¸åŒæ¸ é“æä¾›ä¸åŒçš„åŠŸèƒ½å¼€å‘ã€‚å…¶ä¸­éƒ¨åˆ†æ¸ é“ç§¯ç´¯ä¸€å¤©å®¢æˆ·æˆä¿¡è¯·æ±‚æŒ‡å®šæ—¶é—´ç»Ÿä¸€å‘é€æˆä¿¡ç”³è¯·åˆ°åŒ…é“¶ï¼Œç³»ç»Ÿå¯å¤„ç†æ¯åˆ†é’Ÿ 800 ç¬”æˆä¿¡è¯·æ±‚ã€‚ cssï¼šæ¸…ç»“ç®—ç³»ç»Ÿæ­¤ç³»ç»Ÿæ˜¯å…¬å¸å†…éƒ¨æ¸…ç»“ç®—äººå‘˜ä½¿ç”¨çš„å†…éƒ¨ä¸šåŠ¡ç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½æœ‰ä¸ªäººæº¢ç¼´æ¬¾è´¦æˆ·ç®¡ç†ã€å¯¹å…¬ä»˜æ¬¾ã€å¯¹ç§ä»˜æ¬¾ã€é€€æ¬¾ä»¥åŠæ¸…ç»“ç®—åŒäº‹è½¬è´¦ä¸šåŠ¡çš„å‘èµ·å’Œå®¡æ ¸åŠŸèƒ½ è”åˆè´·æ¬¾ç³»ç»Ÿä¸»è¦åŠŸèƒ½æœ‰è”åˆè´·æ¬¾åè®®ï¼Œè·¯ç”±é…ç½®ï¼Œè·¯ç”±è§„åˆ™ï¼Œå€Ÿæ®è¿˜æ¬¾è®¡åˆ’æ‹†åˆ†ï¼Œèµ„æ–¹æˆä¿¡ï¼Œå€Ÿæ®ã€äº¤æ˜“æµæ°´æ–‡ä»¶ï¼Œè”åˆè´·æ¬¾æˆä¿¡å½±éŸ³èµ„æ–™æ¨é€ ç›‘ç®¡æŠ¥é€ç³»ç»ŸæŒ‰ç…§ç›‘ç®¡æŠ¥é€éœ€æ±‚ï¼Œå¯¹å€Ÿæ®(æ¯æœˆæŠ¥é€å…¨é‡æ•°æ®)ï¼Œè¿˜æ¬¾è®¡åˆ’ï¼Œè¿˜æ¬¾æµæ°´ï¼Œå®¢æˆ·ï¼Œäº§å“ï¼Œæ ¸é”€ï¼Œå€Ÿæ¬¾ç”³è¯·ï¼Œèµ„äº§è¯åˆ¸åŒ–ï¼Œäº”çº§åˆ†ç±»ç­‰ä¿¡æ¯è¿›è¡ŒåŠ å·¥ä¹‹åæ¨é€ç»™ç›‘ç®¡æŠ¥é€ç³»ç»Ÿ è‡ªæˆ‘è¯„ä»·ä¸šç²¾äºå‹¤ï¼Œè’äºå¬‰ ã€è¡Œæˆäºæ€ï¼Œæ¯äºéšã€‚ æ€§æ ¼ä¹è§‚å¼€æœ—ï¼Œè¯ç—¨ï¼Œçƒ­çˆ±ç”Ÿæ´»ï¼Œå–œæ¬¢æ‹è§†é¢‘è®°å½•ç”Ÿæ´»ï¼Œå–œæ¬¢åˆ†äº«çŸ¥è¯†ï¼Œåˆ†äº«æŠ€æœ¯ï¼Œåˆ†äº«ç”Ÿæ´»ä¸­çš„ç‚¹ç‚¹æ»´æ»´ï¼Œè„¾æ°”å¥½ï¼Œæ€•è€å©† ä¸ªäººçˆ±å¥½ ç”µå­ç§‘æŠ€äº§å“ è½¯ä»¶ â€”â€” å–œæ¬¢winã€Macã€Android å¥½ç”¨æ— å¹¿å‘Šè½¯ä»¶ç ”ç©¶åŠåˆ†äº« è¶³çƒ â€”â€” å–œæ¬¢ä½†æ˜¯æ²¡æœºä¼šç©ï¼Œæ€€å¿µé«˜ä¸­æ—¶ä»£å‘€â€¦. ä¸‰å›½æ€ â€”â€” åŸºæœ¬å·²ç»è¢«å‡‰ä¼é€¼åˆ°é€€æ¸¸äº†â€¦.è€Œä¸”ç”Ÿæ´»ä¸­ä¹Ÿå¾ˆéš¾æ‰¾åˆ°ä¸€èµ·ç©è¿™ä¸ªæ¸¸æˆçš„æœ‹å‹äº†ğŸ¤£ é€›Bç«™ â€”â€” ç”Ÿæ´»åŒºå’Œç§‘æŠ€åŒºä¸€ä¸ªä¸çŸ¥åé˜¿å©†ä¸»ğŸ˜‚ï¼Œä½›ç³»æ›´æ–°è§†é¢‘ ğŸ‘‰ ç‚¹å‡»æ‰“å¼€æˆ‘çš„Bç«™ä¸ªäººç©ºé—´ è®°å¾—ä¸‰è¿ ğŸ‘ğŸ‘ğŸ‘ çœ‹ç”µå½± â€”â€” å–œæ¬¢ç§‘å¹»ã€æ¼«å¨ç²‰ã€è¿½æ–—ç½—å¤§é™†â€¦.."},{"title":"æŠ€æœ¯ç¬”è®°","date":"2022-01-11T01:48:58.204Z","updated":"2022-01-11T01:48:58.204Z","comments":true,"path":"æŠ€æœ¯ç¬”è®°/index.html","permalink":"https://zhangxin66666.github.io/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/index.html","excerpt":"","text":"æˆ‘æ˜¯æŠ€æœ¯ç¬”è®°"}],"posts":[{"title":"ConcurrentHashMapæºç è§£è¯»","slug":"1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap","date":"2022-03-31T02:55:44.587Z","updated":"2022-03-31T02:55:44.588Z","comments":true,"path":"2022/03/31/1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap/","link":"","permalink":"https://zhangxin66666.github.io/2022/03/31/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ConcurrentHashMap/","excerpt":"","text":"#1.æˆå‘˜å˜é‡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147//æ•£åˆ—è¡¨æ•°ç»„çš„æœ€å¤§é™åˆ¶private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;//æ•£åˆ—è¡¨é»˜è®¤å€¼private static final int DEFAULT_CAPACITY = 16;static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;//å¹¶å‘çº§åˆ«ï¼šjdk7å†å²é—ç•™é—®é¢˜ï¼Œä»…ä»…åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨åˆ°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ä»£è¡¨å¹¶å‘çº§åˆ«private static final int DEFAULT_CONCURRENCY_LEVEL = 16;//è´Ÿè½½å› å­ï¼ŒJDK1.8ä¸­ ConcurrentHashMap æ˜¯å›ºå®šå€¼private static final float LOAD_FACTOR = 0.75f;//æ ‘åŒ–é˜ˆå€¼ï¼ŒæŒ‡å®šæ¡¶ä½ é“¾è¡¨é•¿åº¦è¾¾åˆ°8çš„è¯ï¼Œæœ‰å¯èƒ½å‘ç”Ÿæ ‘åŒ–æ“ä½œã€‚static final int TREEIFY_THRESHOLD = 8;//çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼static final int UNTREEIFY_THRESHOLD = 6;//è”åˆTREEIFY_THRESHOLDæ§åˆ¶æ¡¶ä½æ˜¯å¦æ ‘åŒ–ï¼Œåªæœ‰å½“tableæ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸” æŸä¸ªæ¡¶ä½ ä¸­çš„é“¾è¡¨é•¿åº¦è¾¾åˆ°8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–static final int MIN_TREEIFY_CAPACITY = 64;//çº¿ç¨‹è¿ç§»æ•°æ®æœ€å°æ­¥é•¿ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡æœ€å°åŒºé—´ä¸€ä¸ªå€¼private static final int MIN_TRANSFER_STRIDE = 16;//è®¡ç®—æ‰©å®¹æ—¶å€™ç”Ÿæˆçš„ä¸€ä¸ª æ ‡è¯†æˆ³private static int RESIZE_STAMP_BITS = 16;//ç»“æœæ˜¯65535 è¡¨ç¤ºå¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°private static final int MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1;//æ‰©å®¹ç›¸å…³private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;//å½“nodeèŠ‚ç‚¹hash=-1 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»è¢«è¿ç§»äº† ï¼ŒfwdèŠ‚ç‚¹static final int MOVED = -1; // hash for forwarding nodes//node hash=-2 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ– ä¸” å½“å‰èŠ‚ç‚¹ä¸ºtreebinå¯¹è±¡ ï¼Œä»£ç†æ“ä½œçº¢é»‘æ ‘static final int TREEBIN = -2; // hash for roots of treesstatic final int RESERVED = -3; // hash for transient reservations//è½¬åŒ–æˆäºŒè¿›åˆ¶å®é™…ä¸Šæ˜¯ 31ä¸ª 1 å¯ä»¥å°†ä¸€ä¸ªè´Ÿæ•°é€šè¿‡ä½ç§»è¿ç®—å¾—åˆ°ä¸€ä¸ªæ­£æ•°static final int HASH_BITS = 0x7fffffff; // usable bits of normal node hash//å½“å‰ç³»ç»Ÿçš„cpuæ•°é‡static final int NCPU = Runtime.getRuntime().availableProcessors();//ä¸ºäº†å…¼å®¹7ç‰ˆæœ¬çš„chpä¿å­˜çš„ï¼Œæ ¸å¿ƒä»£ç å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°private static final ObjectStreamField[] serialPersistentFields = &#123; new ObjectStreamField(&quot;segments&quot;, Segment[].class), new ObjectStreamField(&quot;segmentMask&quot;, Integer.TYPE), new ObjectStreamField(&quot;segmentShift&quot;, Integer.TYPE) &#125;;//æ•£åˆ—è¡¨ï¼Œé•¿åº¦ä¸€å®šæ˜¯2æ¬¡æ–¹æ•°transient volatile Node&lt;K,V&gt;[] table;//æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–°table èµ‹å€¼ç»™nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸ºNullprivate transient volatile Node&lt;K,V&gt;[] nextTable;//LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶ æˆ–è€… å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ°baseCountä¸­private transient volatile long baseCount;/** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private transient volatile int sizeCtl;/** * * æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œè®°å½•å½“å‰è¿›åº¦ã€‚æ‰€æœ‰çº¿ç¨‹éƒ½éœ€è¦ä»transferIndexä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œå»æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ã€‚ */private transient volatile int transferIndex;/** * LongAdderä¸­çš„cellsBuzy 0è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡åŠ é”çŠ¶æ€ */private transient volatile int cellsBusy;/** * LongAdderä¸­çš„cellsæ•°ç»„ï¼Œå½“baseCountå‘ç”Ÿç«äº‰åï¼Œä¼šåˆ›å»ºcellsæ•°ç»„ï¼Œ * çº¿ç¨‹ä¼šé€šè¿‡è®¡ç®—hashå€¼ å–åˆ° è‡ªå·±çš„cell ï¼Œå°†å¢é‡ç´¯åŠ åˆ°æŒ‡å®šcellä¸­ * æ€»æ•° = sum(cells) + baseCount */private transient volatile CounterCell[] counterCells;// Unsafe mechanicsprivate static final sun.misc.Unsafe U;/**è¡¨ç¤ºsizeCtlå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long SIZECTL;/**è¡¨ç¤ºtransferIndexå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long TRANSFERINDEX;/**è¡¨ç¤ºbaseCountå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long BASECOUNT;/**è¡¨ç¤ºcellsBusyå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLSBUSY;/**è¡¨ç¤ºcellValueå±æ€§åœ¨CounterCellä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLVALUE;/**è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€*/private static final long ABASE;private static final int ASHIFT;static &#123; try &#123; U = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = ConcurrentHashMap.class; SIZECTL = U.objectFieldOffset (k.getDeclaredField(&quot;sizeCtl&quot;)); TRANSFERINDEX = U.objectFieldOffset (k.getDeclaredField(&quot;transferIndex&quot;)); BASECOUNT = U.objectFieldOffset (k.getDeclaredField(&quot;baseCount&quot;)); CELLSBUSY = U.objectFieldOffset (k.getDeclaredField(&quot;cellsBusy&quot;)); Class&lt;?&gt; ck = CounterCell.class; CELLVALUE = U.objectFieldOffset (ck.getDeclaredField(&quot;value&quot;)); Class&lt;?&gt; ak = Node[].class; ABASE = U.arrayBaseOffset(ak); //è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°,scale è¡¨ç¤ºNode[]æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å° int scale = U.arrayIndexScale(ak); //1 0000 &amp; 0 1111 = 0 if ((scale &amp; (scale - 1)) != 0) throw new Error(&quot;data type scale not a power of two&quot;); //numberOfLeadingZeros() è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€å—ã€‚ //8 =&gt; 1000 numberOfLeadingZeros(8) = 28 //4 =&gt; 100 numberOfLeadingZeros(4) = 29 //ASHIFT = 31 - 29 = 2 ï¼Ÿï¼Ÿ //ABASE + ï¼ˆ5 &lt;&lt; ASHIFTï¼‰ ASHIFT = 31 - Integer.numberOfLeadingZeros(scale); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125; #2.åŸºç¡€æ–¹æ³•##2.1 spreadé«˜ä½è¿ç®— 123static final int spread(int h) &#123; return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;&#125; ##2.2 tabAtè¯¥æ–¹æ³•è·å–å¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„å¯¹è±¡fieldçš„å€¼ã€‚å®é™…ä¸Šè¿™æ®µä»£ç çš„å«ä¹‰ç­‰ä»·äºtab[i],ä½†æ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ tab[i]æ¥è®¡ç®—å‘¢ï¼Ÿ getObjectVolatileï¼Œä¸€æ—¦çœ‹åˆ° volatile å…³é”®å­—ï¼Œå°±è¡¨ç¤ºå¯è§æ€§ã€‚å› ä¸ºå¯¹ volatile å†™æ“ä½œ happen-before äº volatile è¯»æ“ä½œï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹å¯¹ table çš„ä¿®æ”¹å‡å¯¹ get è¯»å–å¯è§ï¼› è™½ç„¶ table æ•°ç»„æœ¬èº«æ˜¯å¢åŠ äº† volatile å±æ€§ï¼Œä½†æ˜¯â€œvolatile çš„æ•°ç»„åªé’ˆå¯¹æ•°ç»„çš„å¼•ç”¨å…·æœ‰volatile çš„è¯­ä¹‰ï¼Œè€Œä¸æ˜¯å®ƒçš„å…ƒç´ â€ã€‚ æ‰€ä»¥å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªæ•°ç»„çš„å…ƒç´ è¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ¥è¯»çš„æ—¶å€™ä¸ä¸€å®šèƒ½è¯»åˆ°æœ€æ–°çš„å€¼ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒDoug Lea ç›´æ¥é€šè¿‡ Unsafe ç±»æ¥å¯¹ table è¿›è¡Œæ“ä½œã€‚ 123static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i) &#123; return (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE);&#125; ##2.3 casTabAtcasè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ 1234static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v) &#123; return U.compareAndSwapObject(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, c, v);&#125; ##2.4 setTabAt 123static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v) &#123; U.putObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, v);&#125; ##2.5 resizeStampresizeStamp ç”¨æ¥ç”Ÿæˆä¸€ä¸ªå’Œæ‰©å®¹æœ‰å…³çš„æ‰©å®¹æˆ³ï¼Œå…·ä½“æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ 123static final int resizeStamp(int n) &#123; return Integer.numberOfLeadingZeros(n) | (1 &lt;&lt; (RESIZE_STAMP_BITS - 1));&#125; Integer.numberOfLeadingZeros è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›æ— ç¬¦å·æ•´æ•° n æœ€é«˜ä½é 0 ä½å‰é¢çš„ 0 çš„ä¸ªæ•°ã€‚ æ¯”å¦‚ 10 çš„äºŒè¿›åˆ¶æ˜¯ 0000 0000 0000 0000 0000 0000 0000 1010ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•è¿”å›çš„å€¼å°±æ˜¯ 28ã€‚ æ ¹æ® resizeStamp çš„è¿ç®—é€»è¾‘ï¼Œæˆ‘ä»¬æ¥æ¨æ¼”ä¸€ä¸‹ï¼Œå‡å¦‚ n=16ï¼Œé‚£ä¹ˆ resizeStamp(16)=32796è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ˜¯[0000 0000 0000 0000 1000 0000 0001 1100] æ¥ç€å†æ¥çœ‹,å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç ï¼š U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)rs å·¦ç§» 16 ä½ï¼Œç›¸å½“äºåŸæœ¬çš„äºŒè¿›åˆ¶ä½ä½å˜æˆäº†é«˜ä½ 1000 0000 0001 1100 0000 0000 00000000 ç„¶åå†+2 =1000 0000 0001 1100 0000 0000 0000 0000+10=1000 0000 0001 1100 0000 00000000 0010 é«˜ 16 ä½ä»£è¡¨æ‰©å®¹çš„æ ‡è®°ã€ä½ 16 ä½ä»£è¡¨å¹¶è¡Œæ‰©å®¹çš„çº¿ç¨‹æ•° è¿™æ ·æ¥å­˜å‚¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ 1ï¼Œé¦–å…ˆåœ¨ CHM ä¸­æ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰çš„æ•°ç»„éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹æ¥å…±åŒè´Ÿè´£ 2ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡æ‰©å®¹éƒ½ç”Ÿæˆå”¯ä¸€çš„ç”Ÿæˆæˆ³ï¼Œæ¯æ¬¡æ–°çš„æ‰©å®¹ï¼Œéƒ½æœ‰ä¸€ä¸ªä¸åŒçš„ nï¼Œè¿™ä¸ªç”Ÿæˆæˆ³å°±æ˜¯æ ¹æ® n æ¥è®¡ç®—å‡ºæ¥çš„ä¸€ä¸ªæ•°å­—ï¼Œn ä¸åŒï¼Œè¿™ä¸ªæ•°å­—ä¹Ÿä¸åŒ ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•æ‰©å®¹çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯+2 å› ä¸º 1 è¡¨ç¤ºåˆå§‹åŒ–ï¼Œ2 è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹ï¼Œè€Œä¸”å¯¹ sizeCtl çš„æ“ä½œéƒ½æ˜¯åŸºäºä½è¿ç®—çš„ï¼Œæ‰€ä»¥ä¸ä¼šå…³å¿ƒå®ƒæœ¬èº«çš„æ•°å€¼æ˜¯å¤šå°‘ï¼Œåªå…³å¿ƒå®ƒåœ¨äºŒè¿›åˆ¶ä¸Šçš„æ•°å€¼ï¼Œè€Œ sc + 1 ä¼šåœ¨ä½ 16 ä½ä¸ŠåŠ  1ã€‚##2.6 tableSizeForç»è¿‡å¤šæ¬¡ä½ç§»è¿”å›å¤§äºç­‰äºcçš„æœ€å°çš„äºŒæ¬¡æ–¹æ•° 1234567891011121314151617181920 /** * Returns a power of two table size for the given desired capacity. * See Hackers Delight, sec 3.2 * è¿”å›&gt;=cçš„æœ€å°çš„2çš„æ¬¡æ–¹æ•° * c=28 * n=27 =&gt; 0b 11011 * 11011 | 01101 =&gt; 11111 * 11111 | 00111 =&gt; 11111 * .... * =&gt; 11111 + 1 =100000 = 32 */private static final int tableSizeFor(int c) &#123; int n = c - 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;&#125; #3. æ„é€ æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public ConcurrentHashMap() &#123;&#125;public ConcurrentHashMap(int initialCapacity) &#123; if (initialCapacity &lt; 0) throw new IllegalArgumentException(); //å¦‚æœæŒ‡å®šçš„å®¹é‡è¶…è¿‡å…è®¸çš„æœ€å¤§å€¼ï¼Œè®¾ç½®ä¸ºæœ€å¤§å€¼ int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1)); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125;public ConcurrentHashMap(Map&lt;? extends K, ? extends V&gt; m) &#123; this.sizeCtl = DEFAULT_CAPACITY; putAll(m);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor) &#123; this(initialCapacity, loadFactor, 1);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) &#123; //å‚æ•°æ ¡éªŒ if (!(loadFactor &gt; 0.0f) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0) throw new IllegalArgumentException(); //å¦‚æœåˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«ï¼Œé‚£å°±è®¾ç½®åˆå§‹å®¹é‡ä¸ºå¹¶å‘çº§åˆ« if (initialCapacity &lt; concurrencyLevel) initialCapacity = concurrencyLevel; //16/0.75 +1 = 22 long size = (long)(1.0 + (long)initialCapacity / loadFactor); // 22 - &gt; 32 int cap = (size &gt;= (long)MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)size); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125; #4.put 1234public V put(K key, V value) &#123; //å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Œé»˜è®¤æ˜¯false return putVal(key, value, false);&#125; #5 putVal 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129final V putVal(K key, V value, boolean onlyIfAbsent) &#123; //æ§åˆ¶k å’Œ v ä¸èƒ½ä¸ºnull if (key == null || value == null) throw new NullPointerException(); //é€šè¿‡spreadæ–¹æ³•ï¼Œå¯ä»¥è®©é«˜ä½ä¹Ÿèƒ½å‚ä¸è¿›å¯»å€è¿ç®—ã€‚ int hash = spread(key.hashCode()); //binCountè¡¨ç¤ºå½“å‰k-v å°è£…æˆnodeåæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½® //0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸ºnullï¼Œnodeå¯ä»¥ç›´æ¥æ”¾ç€ //2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»å¯èƒ½æ˜¯çº¢é»‘æ ‘ int binCount = 0; //tab å¼•ç”¨mapå¯¹è±¡çš„table //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //f è¡¨ç¤ºæ¡¶ä½çš„å¤´ç»“ç‚¹ //n è¡¨ç¤ºæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ //i è¡¨ç¤ºkeyé€šè¿‡å¯»å€è®¡ç®—åï¼Œå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ //fh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„hashå€¼ Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼šæˆç«‹ï¼Œè¡¨ç¤ºå½“å‰mapä¸­çš„tableå°šæœªåˆå§‹åŒ–.. if (tab == null || (n = tab.length) == 0) //æœ€ç»ˆå½“å‰çº¿ç¨‹éƒ½ä¼šè·å–åˆ°æœ€æ–°çš„map.tableå¼•ç”¨ã€‚ tab = initTable(); //CASE2ï¼ši è¡¨ç¤ºkeyä½¿ç”¨è·¯ç”±å¯»å€ç®—æ³•å¾—åˆ° keyå¯¹åº” tableæ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹ f else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123; //è¿›å…¥åˆ°CASE2ä»£ç å— å‰ç½®æ¡ä»¶ å½“å‰tableæ•°ç»„iæ¡¶ä½æ˜¯Nullæ—¶ã€‚ //ä½¿ç”¨CASæ–¹å¼ è®¾ç½® æŒ‡å®šæ•°ç»„iæ¡¶ä½ ä¸º new Node&lt;K,V&gt;(hash, key, value, null),å¹¶ä¸”æœŸæœ›å€¼æ˜¯null //casæ“ä½œæˆåŠŸ è¡¨ç¤ºokï¼Œç›´æ¥break forå¾ªç¯å³å¯ //casæ“ä½œå¤±è´¥ï¼Œè¡¨ç¤ºåœ¨å½“å‰çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å…¶å®ƒçº¿ç¨‹å…ˆä½ ä¸€æ­¥å‘æŒ‡å®šiæ¡¶ä½è®¾ç½®å€¼äº†ã€‚ //å½“å‰çº¿ç¨‹åªèƒ½å†æ¬¡è‡ªæ—‹ï¼Œå»èµ°å…¶å®ƒé€»è¾‘ã€‚ if (casTabAt(tab, i, null, new Node&lt;K,V&gt;(hash, key, value, null))) break; // no lock when adding to empty bin &#125; //CASE3ï¼šå‰ç½®æ¡ä»¶ï¼Œæ¡¶ä½çš„å¤´ç»“ç‚¹ä¸€å®šä¸æ˜¯nullã€‚ //æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ ä¸º FWDç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰mapæ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­.. else if ((fh = f.hash) == MOVED) //çœ‹åˆ°fwdèŠ‚ç‚¹åï¼Œå½“å‰èŠ‚ç‚¹æœ‰ä¹‰åŠ¡å¸®åŠ©å½“å‰mapå¯¹è±¡å®Œæˆè¿ç§»æ•°æ®çš„å·¥ä½œ //å¸®åŠ©æ‰©å®¹ tab = helpTransfer(tab, f); //CASE4ï¼šå½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else &#123; //å½“æ’å…¥keyå­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™oldValï¼Œè¿”å›ç»™putæ–¹æ³•è°ƒç”¨å¤„.. V oldVal = null; //ä½¿ç”¨sync åŠ é”â€œå¤´èŠ‚ç‚¹â€ï¼Œç†è®ºä¸Šæ˜¯â€œå¤´ç»“ç‚¹â€ synchronized (f) &#123; //ä¸ºä»€ä¹ˆåˆè¦å¯¹æ¯”ä¸€ä¸‹ï¼Œçœ‹çœ‹å½“å‰æ¡¶ä½çš„å¤´èŠ‚ç‚¹ æ˜¯å¦ä¸º ä¹‹å‰è·å–çš„å¤´ç»“ç‚¹ï¼Ÿ //ä¸ºäº†é¿å…å…¶å®ƒçº¿ç¨‹å°†è¯¥æ¡¶ä½çš„å¤´ç»“ç‚¹ä¿®æ”¹æ‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ä»sync åŠ é” å°±æœ‰é—®é¢˜äº†ã€‚ä¹‹åæ‰€æœ‰æ“ä½œéƒ½ä¸ç”¨åœ¨åšäº†ã€‚ if (tabAt(tab, i) == f) &#123;//æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å’±ä»¬ åŠ é” çš„å¯¹è±¡æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥è¿›æ¥é€ äº†ï¼ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰æ¡¶ä½å°±æ˜¯æ™®é€šé“¾è¡¨æ¡¶ä½ã€‚ if (fh &gt;= 0) &#123; //1.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­æ‰€æœ‰å…ƒç´ çš„keyéƒ½ä¸ä¸€è‡´æ—¶ï¼Œå½“å‰çš„æ’å…¥æ“ä½œæ˜¯è¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ //2.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­çš„æŸä¸ªå…ƒç´ çš„keyä¸€è‡´æ—¶ï¼Œå½“å‰æ’å…¥æ“ä½œå¯èƒ½å°±æ˜¯æ›¿æ¢äº†ã€‚binCountè¡¨ç¤ºå†²çªä½ç½®ï¼ˆbinCount - 1ï¼‰ binCount = 1; //è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œeæ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ã€‚ for (Node&lt;K,V&gt; e = f;; ++binCount) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹ key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash æˆç«‹ è¡¨ç¤ºå¾ªç¯çš„å½“å‰å…ƒç´ çš„hashå€¼ä¸æ’å…¥èŠ‚ç‚¹çš„hashå€¼ä¸€è‡´ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ //æ¡ä»¶äºŒï¼š((ek = e.key) == key ||(ek != null &amp;&amp; key.equals(ek))) // æˆç«‹ï¼šè¯´æ˜å¾ªç¯çš„å½“å‰èŠ‚ç‚¹ä¸æ’å…¥èŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå‘ç”Ÿå†²çªäº† if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å°†å½“å‰å¾ªç¯çš„å…ƒç´ çš„ å€¼ èµ‹å€¼ç»™oldVal oldVal = e.val; if (!onlyIfAbsent) e.val = value; break; &#125; //å½“å‰å…ƒç´  ä¸ æ’å…¥å…ƒç´ çš„keyä¸ä¸€è‡´ æ—¶ï¼Œä¼šèµ°ä¸‹é¢ç¨‹åºã€‚ //1.æ›´æ–°å¾ªç¯å¤„ç†èŠ‚ç‚¹ä¸º å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ //2.åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯nullï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æ˜¯é˜Ÿå°¾äº†ï¼Œæ’å…¥æ•°æ®éœ€è¦è¿½åŠ åˆ°é˜Ÿå°¾èŠ‚ç‚¹çš„åé¢ã€‚ Node&lt;K,V&gt; pred = e; if ((e = e.next) == null) &#123; pred.next = new Node&lt;K,V&gt;(hash, key, value, null); break; &#125; &#125; &#125; //å‰ç½®æ¡ä»¶ï¼Œè¯¥æ¡¶ä½ä¸€å®šä¸æ˜¯é“¾è¡¨ //æ¡ä»¶æˆç«‹ï¼Œè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //p è¡¨ç¤ºçº¢é»‘æ ‘ä¸­å¦‚æœä¸ä½ æ’å…¥èŠ‚ç‚¹çš„key æœ‰å†²çªèŠ‚ç‚¹çš„è¯ ï¼Œåˆ™putTreeVal æ–¹æ³• ä¼šè¿”å›å†²çªèŠ‚ç‚¹çš„å¼•ç”¨ã€‚ Node&lt;K,V&gt; p; //å¼ºåˆ¶è®¾ç½®binCountä¸º2ï¼Œå› ä¸ºbinCount &lt;= 1 æ—¶æœ‰å…¶å®ƒå«ä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºäº†2 binCount = 2; //æ¡ä»¶ä¸€ï¼šæˆç«‹ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„keyä¸çº¢é»‘æ ‘ä¸­çš„æŸä¸ªèŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå†²çªäº† if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != null) &#123; //å°†å†²çªèŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal oldVal = p.val; if (!onlyIfAbsent) p.val = value; &#125; &#125; &#125; &#125; //è¯´æ˜å½“å‰æ¡¶ä½ä¸ä¸ºnullï¼Œå¯èƒ½æ˜¯çº¢é»‘æ ‘ ä¹Ÿå¯èƒ½æ˜¯é“¾è¡¨ if (binCount != 0) &#123; //å¦‚æœbinCount&gt;=8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ if (binCount &gt;= TREEIFY_THRESHOLD) //è°ƒç”¨è½¬åŒ–é“¾è¡¨ä¸ºçº¢é»‘æ ‘çš„æ–¹æ³• treeifyBin(tab, i); //è¯´æ˜å½“å‰çº¿ç¨‹æ’å…¥çš„æ•°æ®keyï¼Œä¸åŸæœ‰k-vå‘ç”Ÿå†²çªï¼Œéœ€è¦å°†åŸæ•°æ®vè¿”å›ç»™è°ƒç”¨è€…ã€‚ if (oldVal != null) return oldVal; break; &#125; &#125; &#125; //1.ç»Ÿè®¡å½“å‰tableä¸€å…±æœ‰å¤šå°‘æ•°æ® //2.åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹ã€‚ addCount(1L, binCount); return null;&#125; #6 initTableæ•°ç»„åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ã€‚ sizeCtl ï¼šè¿™ä¸ªæ ‡å¿—æ˜¯åœ¨ Node æ•°ç»„åˆå§‹åŒ–æˆ–è€…æ‰©å®¹çš„æ—¶å€™çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†ï¼Œè´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–è€…æ‰©å®¹æ“ä½œã€‚ -1 ä»£è¡¨æ­£åœ¨åˆå§‹åŒ– -N ä»£è¡¨æœ‰ N-1 ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè¿™é‡Œä¸æ˜¯ç®€å•çš„ç†è§£æˆ n ä¸ªçº¿ç¨‹ï¼ŒsizeCtl å°±æ˜¯-N 0 æ ‡è¯† Node æ•°ç»„è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ­£æ•°ä»£è¡¨åˆå§‹åŒ–æˆ–è€…ä¸‹ä¸€æ¬¡æ‰©å®¹çš„å¤§å° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/** * Initializes table, using the size recorded in sizeCtl. * * sizeCtl &lt; 0 * * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * * * sizeCtl &gt; 0 * * * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private final Node&lt;K,V&gt;[] initTable() &#123; //tab å¼•ç”¨map.table //sc sizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab; int sc; //è‡ªæ—‹ æ¡ä»¶ï¼šmap.table å°šæœªåˆå§‹åŒ– while ((tab = table) == null || tab.length == 0) &#123; if ((sc = sizeCtl) &lt; 0) //å¤§æ¦‚ç‡å°±æ˜¯-1ï¼Œè¡¨ç¤ºå…¶å®ƒçº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ›å»ºtableçš„è¿‡ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ²¡æœ‰ç«äº‰åˆ°åˆå§‹åŒ–tableçš„é”ã€‚ Thread.yield(); // lost initialization race; just spin //1.sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° //2.å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° //3.å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123; try &#123; //è¿™é‡Œä¸ºä»€ä¹ˆåˆè¦åˆ¤æ–­å‘¢ï¼Ÿ é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œç„¶åå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–..å¯¼è‡´ä¸¢å¤±æ•°æ®ã€‚ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å…¶å®ƒçº¿ç¨‹éƒ½æ²¡æœ‰è¿›å…¥è¿‡è¿™ä¸ªifå—ï¼Œå½“å‰çº¿ç¨‹å°±æ˜¯å…·å¤‡åˆå§‹åŒ–tableæƒåˆ©äº†ã€‚ if ((tab = table) == null || tab.length == 0) &#123; //scå¤§äº0 åˆ›å»ºtableæ—¶ ä½¿ç”¨ scä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼. int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY; @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n]; //æœ€ç»ˆèµ‹å€¼ç»™ map.table table = tab = nt; //n &gt;&gt;&gt; 2 =&gt; ç­‰äº 1/4 n n - (1/4)n = 3/4 n =&gt; 0.75 * n //sc 0.75 n è¡¨ç¤ºä¸‹ä¸€æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ã€‚ sc = n - (n &gt;&gt;&gt; 2); &#125; &#125; finally &#123; //1.å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹è¯ï¼Œscè¡¨ç¤ºçš„æ˜¯ ä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼ //2.è¡¨ç¤ºå½“å‰çº¿ç¨‹ å¹¶ä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥åˆ°else if å— æ—¶ï¼Œå°† //sizeCtl è®¾ç½®ä¸ºäº†-1 ï¼Œé‚£ä¹ˆè¿™æ—¶éœ€è¦å°†å…¶ä¿®æ”¹ä¸º è¿›å…¥æ—¶çš„å€¼ã€‚ sizeCtl = sc; &#125; break; &#125; &#125; return tab;&#125; #7 addCount 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124private final void addCount(long x, int check) &#123; //as è¡¨ç¤º LongAdder.cells //b è¡¨ç¤ºLongAdder.base //s è¡¨ç¤ºå½“å‰map.tableä¸­å…ƒç´ çš„æ•°é‡ CounterCell[] as; long b, s; //æ¡ä»¶ä¸€ï¼štrue-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®ç´¯åŠ åˆ° base //æ¡ä»¶äºŒï¼šfalse-&gt;è¡¨ç¤ºå†™baseæˆåŠŸï¼Œæ•°æ®ç´¯åŠ åˆ°baseä¸­äº†ï¼Œå½“å‰ç«äº‰ä¸æ¿€çƒˆï¼Œä¸éœ€è¦åˆ›å»ºcells // true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ if ((as = counterCells) != null || !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) &#123; //æœ‰å‡ ç§æƒ…å†µè¿›å…¥åˆ°ifå—ä¸­ï¼Ÿ //1.true-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® //2.true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ //a è¡¨ç¤ºå½“å‰çº¿ç¨‹hashå¯»å€å‘½ä¸­çš„cell CounterCell a; //v è¡¨ç¤ºå½“å‰çº¿ç¨‹å†™cellæ—¶çš„æœŸæœ›å€¼ long v; //m è¡¨ç¤ºå½“å‰cellsæ•°ç»„çš„é•¿åº¦ int m; //true -&gt; æœªç«äº‰ false-&gt;å‘ç”Ÿç«äº‰ boolean uncontended = true; //æ¡ä»¶ä¸€ï¼šas == null || (m = as.length - 1) &lt; 0 //true-&gt; è¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯é€šè¿‡ å†™baseç«äº‰å¤±è´¥ ç„¶åè¿›å…¥çš„ifå—ï¼Œå°±éœ€è¦è°ƒç”¨fullAddCountæ–¹æ³•å»æ‰©å®¹ æˆ–è€… é‡è¯•.. LongAdder.longAccumulate //æ¡ä»¶äºŒï¼ša = as[ThreadLocalRandom.getProbe() &amp; m]) == null å‰ç½®æ¡ä»¶ï¼šcellså·²ç»åˆå§‹åŒ–äº† //true-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„cellè¡¨æ ¼æ˜¯ä¸ªç©ºï¼Œéœ€è¦å½“å‰çº¿ç¨‹è¿›å…¥fullAddCountæ–¹æ³•å»åˆå§‹åŒ– cellï¼Œæ”¾å…¥å½“å‰ä½ç½®. //æ¡ä»¶ä¸‰ï¼š!(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x) // false-&gt;å–åå¾—åˆ°falseï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellæˆåŠŸ // true-&gt;å–åå¾—åˆ°true,è¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellå¤±è´¥ï¼Œéœ€è¦è¿›å…¥fullAddCountè¿›è¡Œé‡è¯• æˆ–è€… æ‰©å®¹ cellsã€‚ if (as == null || (m = as.length - 1) &lt; 0 || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null || !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x)) ) &#123; fullAddCount(x, uncontended); //è€ƒè™‘åˆ°fullAddCounté‡Œé¢çš„äº‹æƒ…æ¯”è¾ƒç´¯ï¼Œå°±è®©å½“å‰çº¿ç¨‹ ä¸å‚ä¸åˆ° æ‰©å®¹ç›¸å…³çš„é€»è¾‘äº†ï¼Œç›´æ¥è¿”å›åˆ°è°ƒç”¨ç‚¹ã€‚ return; &#125; if (check &lt;= 1) return; //è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼ s = sumCount(); &#125; //è¡¨ç¤ºä¸€å®šæ˜¯ä¸€ä¸ªputæ“ä½œè°ƒç”¨çš„addCount if (check &gt;= 0) &#123; //tab è¡¨ç¤ºmap.table //nt è¡¨ç¤ºmap.nextTable //n è¡¨ç¤ºmap.tableæ•°ç»„çš„é•¿åº¦ //sc è¡¨ç¤ºsizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab, nt; int n, sc; /** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */ //è‡ªæ—‹ //æ¡ä»¶ä¸€ï¼šs &gt;= (long)(sc = sizeCtl) // true-&gt; 1.å½“å‰sizeCtlä¸ºä¸€ä¸ªè´Ÿæ•° è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­.. // 2.å½“å‰sizeCtlæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼ // false-&gt; è¡¨ç¤ºå½“å‰tableå°šæœªè¾¾åˆ°æ‰©å®¹æ¡ä»¶ //æ¡ä»¶äºŒï¼š(tab = table) != null // æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š(n = tab.length) &lt; MAXIMUM_CAPACITY // true-&gt;å½“å‰tableé•¿åº¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œåˆ™å¯ä»¥è¿›è¡Œæ‰©å®¹ã€‚ while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp; (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123; //æ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ //16 -&gt; 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011 int rs = resizeStamp(n); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰tableæ­£åœ¨æ‰©å®¹ // å½“å‰çº¿ç¨‹ç†è®ºä¸Šåº”è¯¥ååŠ©tableå®Œæˆæ‰©å®¹ if (sc &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼š(nt = nextTable) == null // true-&gt;è¡¨ç¤ºæœ¬æ¬¡æ‰©å®¹ç»“æŸ // false-&gt;æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0) break; //å‰ç½®æ¡ä»¶ï¼šå½“å‰tableæ­£åœ¨æ‰§è¡Œæ‰©å®¹ä¸­.. å½“å‰çº¿ç¨‹æœ‰æœºä¼šå‚ä¸è¿›æ‰©å®¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸå‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå¹¶ä¸”å°†scä½16ä½å€¼åŠ 1ï¼Œè¡¨ç¤ºå¤šäº†ä¸€ä¸ªçº¿ç¨‹å‚ä¸å·¥ä½œ //æ¡ä»¶å¤±è´¥ï¼š1.å½“å‰æœ‰å¾ˆå¤šçº¿ç¨‹éƒ½åœ¨æ­¤å¤„å°è¯•ä¿®æ”¹sizeCtlï¼Œæœ‰å…¶å®ƒä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æˆåŠŸäº†ï¼Œå¯¼è‡´ä½ çš„scæœŸæœ›å€¼ä¸å†…å­˜ä¸­çš„å€¼ä¸ä¸€è‡´ ä¿®æ”¹å¤±è´¥ // 2.transfer ä»»åŠ¡å†…éƒ¨çš„çº¿ç¨‹ä¹Ÿä¿®æ”¹äº†sizeCtlã€‚ if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) //ååŠ©æ‰©å®¹çº¿ç¨‹ï¼ŒæŒæœ‰nextTableå‚æ•° transfer(tab, nt); &#125; //1000 0000 0001 1011 0000 0000 0000 0000 +2 =&gt; 1000 0000 0001 1011 0000 0000 0000 0010 //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨transferæ–¹æ³•éœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)) //è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ ä¸æŒæœ‰nextTable transfer(tab, null); s = sumCount(); &#125; &#125;&#125; #8. transferConcurrentHashMap æ”¯æŒå¹¶å‘æ‰©å®¹ï¼Œå®ç°æ–¹å¼æ˜¯ï¼ŒæŠŠ Node æ•°ç»„è¿›è¡Œæ‹†åˆ†ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†è‡ªå·±çš„åŒºåŸŸï¼Œå‡è®¾ table æ•°ç»„æ€»é•¿åº¦æ˜¯ 64ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å¯ä»¥åˆ†åˆ° 16 ä¸ª bucketã€‚ç„¶åæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„èŒƒå›´ï¼ŒæŒ‰ç…§å€’åºæ¥åšè¿ç§»ã€‚ é€šè¿‡ for è‡ªå¾ªç¯å¤„ç†æ¯ä¸ªæ§½ä½ä¸­çš„é“¾è¡¨å…ƒç´ ï¼Œé»˜è®¤ advace ä¸ºçœŸï¼Œé€šè¿‡ CAS è®¾ç½® transferIndexå±æ€§å€¼ï¼Œå¹¶åˆå§‹åŒ– i å’Œ bound å€¼ï¼Œi æŒ‡å½“å‰å¤„ç†çš„æ§½ä½åºå·ï¼Œbound æŒ‡éœ€è¦å¤„ç†çš„æ§½ä½è¾¹ç•Œï¼Œå…ˆå¤„ç†æ§½ä½ 31 çš„èŠ‚ç‚¹ï¼› ï¼ˆbound,iï¼‰ =(16,31) ä» 31 çš„ä½ç½®å¾€å‰æ¨åŠ¨ã€‚ æ¯å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ‰©å®¹æ“ä½œï¼Œå°±é€šè¿‡ cas æ‰§è¡Œ sc-1ã€‚ æ¥ç€åˆ¤æ–­(sc-2) !=resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT ; å¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºå½“å‰ä¸ºæ•´ä¸ªæ‰©å®¹æ“ä½œçš„ æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ„å‘³ç€æ•´ä¸ªæ‰©å®¹æ“ä½œå°±ç»“æŸäº†ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜è¿˜å¾—ç»§ç»­ã€‚ è¿™ä¹ˆåšçš„ç›®çš„ï¼Œä¸€æ–¹é¢æ˜¯é˜²æ­¢ä¸åŒæ‰©å®¹ä¹‹é—´å‡ºç°ç›¸åŒçš„ sizeCtlï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œè¿˜å¯ä»¥é¿å…sizeCtl çš„ ABA é—®é¢˜å¯¼è‡´çš„æ‰©å®¹é‡å çš„æƒ…å†µã€‚ æ‰©å®¹å›¾è§£åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å½“æ›´æ–°åçš„é”®å€¼å¯¹æ€»æ•° baseCount &gt;= é˜ˆå€¼ sizeCtl æ—¶ï¼Œè¿›è¡Œrehashï¼Œè¿™é‡Œé¢ä¼šæœ‰ä¸¤ä¸ªé€»è¾‘ã€‚ å¦‚æœå½“å‰æ­£åœ¨å¤„äºæ‰©å®¹é˜¶æ®µï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šåŠ å…¥å¹¶ä¸”ååŠ©æ‰©å®¹ã€‚ å¦‚æœå½“å‰æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œåˆ™ç›´æ¥è§¦å‘æ‰©å®¹æ“ä½œã€‚ æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®çš„è½¬ç§»å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯æŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ä½†æ˜¯è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåœ¨æ‰©å®¹çš„æ—¶å€™å…¶ä»–çº¿ç¨‹ä¹Ÿå¯èƒ½æ­£åœ¨æ·»åŠ å…ƒç´ ï¼Œè¿™æ—¶åˆè§¦å‘äº†æ‰©å®¹æ€ä¹ˆåŠï¼Ÿå¯èƒ½å¤§å®¶æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åŠ äº’æ–¥é”ï¼ŒæŠŠè½¬ç§»è¿‡ç¨‹é”ä½ï¼Œè™½ç„¶æ˜¯å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¼šå¸¦æ¥è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ã€‚å› ä¸ºäº’æ–¥é”ä¼šå¯¼è‡´æ‰€æœ‰è®¿é—®ä¸´ç•ŒåŒºçš„çº¿ç¨‹é™·å…¥åˆ°é˜»å¡çŠ¶æ€ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹è€—æ—¶è¶Šé•¿ï¼Œå…¶ä»–ç«äº‰çº¿ç¨‹å°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¯¼è‡´ååé‡è¾ƒä½ã€‚è€Œä¸”è¿˜å¯èƒ½å¯¼è‡´æ­»é”ã€‚ è€Œ ConcurrentHashMap å¹¶æ²¡æœ‰ç›´æ¥åŠ é”ï¼Œè€Œæ˜¯é‡‡ç”¨ CAS å®ç°æ— é”çš„å¹¶å‘åŒæ­¥ç­–ç•¥ï¼Œæœ€ç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ã€‚ å®ƒæŠŠ Node æ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹é”è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingNodeèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å®ƒçš„æºç å®ç°ã€‚ fwd:è¿™ä¸ªç±»æ˜¯ä¸ªæ ‡è¯†ç±»ï¼Œç”¨äºæŒ‡å‘æ–°è¡¨ç”¨çš„ï¼Œå…¶ä»–çº¿ç¨‹é‡åˆ°è¿™ä¸ªç±»ä¼šä¸»åŠ¨è·³è¿‡è¿™ä¸ªç±»ï¼Œå› ä¸ºè¿™ä¸ªç±»è¦ä¹ˆå°±æ˜¯æ‰©å®¹è¿ç§»æ­£åœ¨è¿›è¡Œï¼Œè¦ä¹ˆå°±æ˜¯å·²ç»å®Œæˆæ‰©å®¹è¿ç§»ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç±»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå†è¿›è¡Œæ“ä½œã€‚ advance:è¿™ä¸ªå˜é‡æ˜¯ç”¨äºæç¤ºä»£ç æ˜¯å¦è¿›è¡Œæ¨è¿›å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ¡¶å¤„ç†å®Œï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ¡¶çš„æ ‡è¯†ã€‚ finishing:è¿™ä¸ªå˜é‡ç”¨äºæç¤ºæ‰©å®¹æ˜¯å¦ç»“æŸç”¨çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) &#123; //n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰tableæ•°ç»„çš„é•¿åº¦ //stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ int n = tab.length, stride; // stride å›ºå®šä¸º 16 if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE) stride = MIN_TRANSFER_STRIDE; // subdivide range //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯ååŠ©æ‰©å®¹çš„çº¿ç¨‹.. if (nextTab == null) &#123; // initiating try &#123; //åˆ›å»ºäº†ä¸€ä¸ªæ¯”æ‰©å®¹ä¹‹å‰å¤§ä¸€å€çš„table @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1]; nextTab = nt; &#125; catch (Throwable ex) &#123; // try to cope with OOME sizeCtl = Integer.MAX_VALUE; return; &#125; //èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTable ï¼Œæ–¹ä¾¿ååŠ©æ‰©å®¹çº¿ç¨‹ æ‹¿åˆ°æ–°è¡¨ nextTable = nextTab; //è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ã€‚indexè®¡æ•°æ˜¯ä»1å¼€å§‹è®¡ç®—çš„ã€‚ transferIndex = n; &#125; //è¡¨ç¤ºæ–°æ•°ç»„çš„é•¿åº¦ int nextn = nextTab.length; //fwd èŠ‚ç‚¹ï¼Œå½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸ºfwdèŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹ æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œä¼šæœ‰ä¸åŒé€»è¾‘ã€‚ ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab); //æ¨è¿›æ ‡è®° boolean advance = true; //å®Œæˆæ ‡è®° boolean finishing = false; // to ensure sweep before committing nextTab //i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½ //bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ int i = 0, bound = 0; //è‡ªæ—‹ for (;;) &#123; //f æ¡¶ä½çš„å¤´ç»“ç‚¹ //fh å¤´ç»“ç‚¹çš„hash Node&lt;K,V&gt; f; int fh; /** * 1.ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡åŒºé—´ * 2.ç»´æŠ¤å½“å‰çº¿ç¨‹ä»»åŠ¡è¿›åº¦ï¼ˆi è¡¨ç¤ºå½“å‰å¤„ç†çš„æ¡¶ä½ï¼‰ * 3.ç»´æŠ¤mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„è¿›åº¦ */ while (advance) &#123; //åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ //åˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡ int nextIndex, nextBound; //CASE1: //æ¡ä»¶ä¸€ï¼š--i &gt;= bound //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œè¿˜æœ‰ç›¸åº”çš„åŒºé—´çš„æ¡¶ä½è¦å¤„ç†ï¼Œ--i å°±è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ª æ¡¶ä½. //ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… if (--i &gt;= bound || finishing) advance = false; //CASE2: //å‰ç½®æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½éƒ½åˆ†é…å®Œæ¯•äº†ï¼Œæ²¡æœ‰åŒºé—´å¯åˆ†é…äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„iå˜é‡ä¸º-1 è·³å‡ºå¾ªç¯åï¼Œæ‰§è¡Œé€€å‡ºè¿ç§»ä»»åŠ¡ç›¸å…³çš„ç¨‹åº //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½å°šæœªåˆ†é…å®Œæ¯•ï¼Œè¿˜æœ‰åŒºé—´å¯åˆ†é… else if ((nextIndex = transferIndex) &lt;= 0) &#123; i = -1; advance = false; &#125; //CASE3: //å‰ç½®æ¡ä»¶ï¼š1ã€å½“å‰çº¿ç¨‹éœ€è¦åˆ†é…ä»»åŠ¡åŒºé—´ 2.å…¨å±€èŒƒå›´å†…è¿˜æœ‰æ¡¶ä½å°šæœªè¿ç§» //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡æˆåŠŸ //æ¡ä»¶å¤±è´¥ï¼šè¯´æ˜åˆ†é…ç»™å½“å‰çº¿ç¨‹å¤±è´¥ï¼Œåº”è¯¥æ˜¯å’Œå…¶å®ƒçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰å§ else if (U.compareAndSwapInt (this, TRANSFERINDEX, nextIndex, nextBound = (nextIndex &gt; stride ? nextIndex - stride : 0))) &#123; bound = nextBound; i = nextIndex - 1; advance = false; &#125; &#125; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼ši &lt; 0 //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) &#123; //ä¿å­˜sizeCtl çš„å˜é‡ int sc; if (finishing) &#123; nextTable = null; table = nextTab; sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1); return; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜è®¾ç½®sizeCtl ä½16ä½ -1 æˆåŠŸï¼Œå½“å‰çº¿ç¨‹å¯ä»¥æ­£å¸¸é€€å‡º if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) &#123; //1000 0000 0001 1011 0000 0000 0000 0000 //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯æœ€åä¸€ä¸ªé€€å‡ºtransferä»»åŠ¡çš„çº¿ç¨‹ if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) //æ­£å¸¸é€€å‡º return; finishing = advance = true; i = n; // recheck before commit &#125; &#125; //å‰ç½®æ¡ä»¶ï¼šã€CASE2~CASE4ã€‘ å½“å‰çº¿ç¨‹ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œæ­£åœ¨è¿›è¡Œä¸­ //CASE2: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸ºfwdèŠ‚ç‚¹å³å¯ã€‚ else if ((f = tabAt(tab, i)) == null) advance = casTabAt(tab, i, null, fwd); //CASE3: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å†æ¬¡æ›´æ–°å½“å‰çº¿ç¨‹ä»»åŠ¡ç´¢å¼•ï¼Œå†æ¬¡å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½ æˆ–è€… å…¶å®ƒæ“ä½œ else if ((fh = f.hash) == MOVED) advance = true; // already processed //CASE4: //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸”nodeèŠ‚ç‚¹ ä¸æ˜¯ fwdèŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»ã€‚ else &#123; //sync åŠ é”å½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ synchronized (f) &#123; //é˜²æ­¢åœ¨ä½ åŠ é”å¤´å¯¹è±¡ä¹‹å‰ï¼Œå½“å‰æ¡¶ä½çš„å¤´å¯¹è±¡è¢«å…¶å®ƒå†™çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œå¯¼è‡´ä½ ç›®å‰åŠ é”å¯¹è±¡é”™è¯¯... if (tabAt(tab, i) == f) &#123; //ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨ //hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨ Node&lt;K,V&gt; ln, hn; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½ if (fh &gt;= 0) &#123; //lastRun //å¯ä»¥è·å–å‡º å½“å‰é“¾è¡¨ æœ«å°¾è¿ç»­é«˜ä½ä¸å˜çš„ node int runBit = fh &amp; n; Node&lt;K,V&gt; lastRun = f; for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º ä½ä½é“¾è¡¨ï¼Œé‚£ä¹ˆå°±è®© ln æŒ‡å‘ ä½ä½é“¾è¡¨ if (runBit == 0) &#123; ln = lastRun; hn = null; &#125; //å¦åˆ™ï¼Œè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º é«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘ é«˜ä½é“¾è¡¨ else &#123; hn = lastRun; ln = null; &#125; for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn); &#125; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //è½¬æ¢å¤´ç»“ç‚¹ä¸º treeBinå¼•ç”¨ t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //ä½ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘ä½ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘ä½ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; lo = null, loTail = null; //é«˜ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘é«˜ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘é«˜ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; hi = null, hiTail = null; //lc è¡¨ç¤ºä½ä½é“¾è¡¨å…ƒç´ æ•°é‡ //hc è¡¨ç¤ºé«˜ä½é“¾è¡¨å…ƒç´ æ•°é‡ int lc = 0, hc = 0; //è¿­ä»£TreeBinä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹ è‡³ å°¾èŠ‚ç‚¹ for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) &#123; // h è¡¨ç¤ºå¾ªç¯å¤„ç†å½“å‰å…ƒç´ çš„ hash int h = e.hash; //ä½¿ç”¨å½“å‰èŠ‚ç‚¹ æ„å»ºå‡ºæ¥çš„ æ–°çš„ TreeNode TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt; (h, e.key, e.val, null, null); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹ å±äºä½ä½é“¾ èŠ‚ç‚¹ if ((h &amp; n) == 0) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä½ä½é“¾è¡¨ è¿˜æ²¡æœ‰æ•°æ® if ((p.prev = loTail) == null) lo = p; //è¯´æ˜ ä½ä½é“¾è¡¨å·²ç»æœ‰æ•°æ®äº†ï¼Œæ­¤æ—¶å½“å‰å…ƒç´  è¿½åŠ åˆ° ä½ä½é“¾è¡¨çš„æœ«å°¾å°±è¡Œäº† else loTail.next = p; //å°†ä½ä½é“¾è¡¨å°¾æŒ‡é’ˆæŒ‡å‘ p èŠ‚ç‚¹ loTail = p; ++lc; &#125; //å½“å‰èŠ‚ç‚¹ å±äº é«˜ä½é“¾ èŠ‚ç‚¹ else &#123; if ((p.prev = hiTail) == null) hi = p; else hiTail.next = p; hiTail = p; ++hc; &#125; &#125; ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) : (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t; hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) : (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; &#125; &#125; &#125; &#125;&#125; é“¾è¡¨è¿ç§»åŸç† 1ï¼‰é«˜ä½ä½åŸç†åˆ†æ ConcurrentHashMap åœ¨åšé“¾è¡¨è¿ç§»æ—¶ï¼Œä¼šç”¨é«˜ä½ä½æ¥å®ç°ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜è¦åˆ†æä¸€ä¸‹ 1ï¼Œå¦‚ä½•å®ç°é«˜ä½ä½é“¾è¡¨çš„åŒºåˆ† å‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªé˜Ÿåˆ—ç¬¬ 14 ä¸ªæ§½ä½æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åï¼Œé“¾è¡¨å…ƒç´ ä¸ªæ•°å·²ç»è¾¾åˆ°äº† 8ï¼Œä¸”æ•°ç»„é•¿åº¦ä¸º 16ï¼Œä¼˜å…ˆé€šè¿‡æ‰©å®¹æ¥ç¼“è§£é“¾è¡¨è¿‡é•¿çš„é—®é¢˜ å‡å¦‚å½“å‰çº¿ç¨‹æ­£åœ¨å¤„ç†æ§½ä½ä¸º 14 çš„èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œåœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆå®šä¹‰ä¸¤ä¸ªå˜é‡èŠ‚ç‚¹ ln å’Œ hnï¼Œå®é™…å°±æ˜¯ lowNode å’Œ HighNodeï¼Œåˆ†åˆ«ä¿å­˜ hash å€¼çš„ç¬¬ x ä½ä¸º 0 å’Œä¸ç­‰äº0 çš„èŠ‚ç‚¹ é€šè¿‡ fn&amp;n å¯ä»¥æŠŠè¿™ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ åˆ†ä¸ºä¸¤ç±»ï¼ŒA ç±»æ˜¯ hash å€¼çš„ç¬¬ X ä½ä¸º 0ï¼ŒB ç±»æ˜¯ hash å€¼çš„ç¬¬ x ä½ä¸ºä¸ç­‰äº 0ï¼ˆè‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåŒºåˆ†ï¼Œç¨ååˆ†æï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ lastRun è®°å½•æœ€åè¦å¤„ç†çš„èŠ‚ç‚¹ã€‚æœ€ç»ˆè¦è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼ŒA ç±»çš„é“¾è¡¨ä¿æŒä½ç½®ä¸åŠ¨ï¼ŒB ç±»çš„é“¾è¡¨ä¸º 14+16(æ‰©å®¹å¢åŠ çš„é•¿åº¦)=30 æŠŠ 14 æ§½ä½çš„é“¾è¡¨å•ç‹¬ä¼¶å‡ºæ¥ï¼Œç”¨è“è‰²è¡¨ç¤º fn&amp;n=0 çš„èŠ‚ç‚¹ï¼Œå‡å¦‚é“¾è¡¨çš„åˆ†ç±»æ˜¯è¿™æ · 1234567for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125;&#125; é€šè¿‡ä¸Šé¢è¿™æ®µä»£ç éå†ï¼Œä¼šè®°å½• runBit ä»¥åŠ lastRunï¼ŒæŒ‰ç…§ä¸Šé¢è¿™ä¸ªç»“æ„ï¼Œé‚£ä¹ˆ runBit åº”è¯¥æ˜¯è“è‰²èŠ‚ç‚¹ï¼ŒlastRun åº”è¯¥æ˜¯ç¬¬ 6 ä¸ªèŠ‚ç‚¹æ¥ç€ï¼Œå†é€šè¿‡è¿™æ®µä»£ç è¿›è¡Œéå†ï¼Œç”Ÿæˆ ln é“¾ä»¥åŠ hn é“¾ 1234567for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);&#125; æ¥ç€ï¼Œé€šè¿‡ CAS æ“ä½œï¼ŒæŠŠ hn é“¾æ”¾åœ¨ i+n ä¹Ÿå°±æ˜¯ 14+16 çš„ä½ç½®ï¼Œln é“¾ä¿æŒåŸæ¥çš„ä½ç½®ä¸åŠ¨ã€‚å¹¶ä¸”è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º fwdï¼Œè¡¨ç¤ºå·²ç»è¢«å½“å‰çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ 123setTabAt(nextTab, i, ln);setTabAt(nextTab, i + n, hn);setTabAt(tab, i, fwd); è¿ç§»å®Œæˆä»¥åçš„æ•°æ®åˆ†å¸ƒå¦‚ä¸‹ 2)ä¸ºä»€ä¹ˆè¦åšé«˜ä½ä½çš„åˆ’åˆ† è¦æƒ³äº†è§£è¿™ä¹ˆè®¾è®¡çš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦ä» ConcurrentHashMap çš„æ ¹æ®ä¸‹æ ‡è·å–å¯¹è±¡çš„ç®—æ³•æ¥çœ‹ï¼Œåœ¨ putVal æ–¹æ³•ä¸­ 1018 è¡Œï¼š (f = tabAt(tab, i = (n - 1) &amp; hash)) == null é€šè¿‡(n-1) &amp; hash æ¥è·å¾—åœ¨ table ä¸­çš„æ•°ç»„ä¸‹æ ‡æ¥è·å–èŠ‚ç‚¹æ•°æ®ï¼Œã€&amp;è¿ç®—æ˜¯äºŒè¿›åˆ¶è¿ç®—ç¬¦ï¼Œ1&amp; 1=1ï¼Œå…¶ä»–éƒ½ä¸º 0ã€‘ã€‚ #9.helpTransferå¦‚æœå¯¹åº”çš„èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ hash æ˜¯ä¸æ˜¯ç­‰äº MOVED(-1)ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ForwardingNode èŠ‚ç‚¹ï¼Œæ„å‘³ç€æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé‚£ä¹ˆå½“å‰ç°åœ¨ç›´æ¥å¸®åŠ©å®ƒè¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤è°ƒç”¨ helpTransferæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455final Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123; //nextTab å¼•ç”¨çš„æ˜¯ fwd.nextTable == map.nextTable ç†è®ºä¸Šæ˜¯è¿™æ ·ã€‚ //sc ä¿å­˜map.sizeCtl Node&lt;K,V&gt;[] nextTab; int sc; //æ¡ä»¶ä¸€ï¼štab != null æ’æˆç«‹ true //æ¡ä»¶äºŒï¼š(f instanceof ForwardingNode) æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š((ForwardingNode&lt;K,V&gt;)f).nextTable) != null æ’æˆç«‹ true if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp; (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != null) &#123; //æ‹¿å½“å‰æ ‡çš„é•¿åº¦ è·å– æ‰©å®¹æ ‡è¯†æˆ³ å‡è®¾ 16 -&gt; 32 æ‰©å®¹ï¼š1000 0000 0001 1011 int rs = resizeStamp(tab.length); //æ¡ä»¶ä¸€ï¼šnextTab == nextTable //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼š1.nextTableè¢«è®¾ç½®ä¸ºNull äº†ï¼Œæ‰©å®¹å®Œæ¯•åï¼Œä¼šè¢«è®¾ä¸ºNull // 2.å†æ¬¡å‡ºå‘æ‰©å®¹äº†...å’±ä»¬æ‹¿åˆ°çš„nextTab ä¹Ÿå·²ç»è¿‡æœŸäº†... //æ¡ä»¶äºŒï¼štable == tab //æˆç«‹ï¼šè¯´æ˜ æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¿˜æœªå®Œæˆ //ä¸æˆç«‹ï¼šè¯´æ˜æ‰©å®¹å·²ç»ç»“æŸäº†ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œæœ€åé€€å‡ºçš„çº¿ç¨‹ ä¼šè®¾ç½® nextTable ä¸º table //æ¡ä»¶ä¸‰ï¼š(sc = sizeCtl) &lt; 0 //æˆç«‹ï¼šè¯´æ˜æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼šè¯´æ˜sizeCtlå½“å‰æ˜¯ä¸€ä¸ªå¤§äº0çš„æ•°ï¼Œæ­¤æ—¶ä»£è¡¨ä¸‹æ¬¡æ‰©å®¹çš„é˜ˆå€¼ï¼Œå½“å‰æ‰©å®¹å·²ç»ç»“æŸã€‚ while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼štransferIndex &lt;= 0 // true-&gt;è¯´æ˜mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„ä»»åŠ¡å·²ç»åˆ†é…å®Œäº†ï¼Œå½“å‰çº¿ç¨‹è¿›å»ä¹Ÿæ²¡æ´»å¹².. // false-&gt;è¿˜æœ‰ä»»åŠ¡å¯ä»¥åˆ†é…ã€‚ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || transferIndex &lt;= 0) break; if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) &#123; transfer(tab, nextTab); break; &#125; &#125; return nextTab; &#125; return table;&#125; #10.get 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public V get(Object key) &#123; //tab å¼•ç”¨map.table //e å½“å‰å…ƒç´  //p ç›®æ ‡èŠ‚ç‚¹ //n tableæ•°ç»„é•¿åº¦ //eh å½“å‰å…ƒç´ hash //ek å½“å‰å…ƒç´ key Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek; //æ‰°åŠ¨è¿ç®—åå¾—åˆ° æ›´æ•£åˆ—çš„hashå€¼ int h = spread(key.hashCode()); //æ¡ä»¶ä¸€ï¼š(tab = table) != null //true-&gt;è¡¨ç¤ºå·²ç»putè¿‡æ•°æ®ï¼Œå¹¶ä¸”mapå†…éƒ¨çš„tableä¹Ÿå·²ç»åˆå§‹åŒ–å®Œæ¯• //false-&gt;è¡¨ç¤ºåˆ›å»ºå®Œmapåï¼Œå¹¶æ²¡æœ‰putè¿‡æ•°æ®ï¼Œmapå†…éƒ¨çš„tableæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å†™æ•°æ®æ—¶ä¼šè§¦å‘åˆ›å»ºé€»è¾‘ã€‚ //æ¡ä»¶äºŒï¼š(n = tab.length) &gt; 0 true-&gt;è¡¨ç¤ºtableå·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(e = tabAt(tab, (n - 1) &amp; h)) != null //true-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ æœ‰å€¼ //false-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ä¸­æ˜¯nullï¼Œæ˜¯nullç›´æ¥è¿”å›null if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123; //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ® //å¯¹æ¯”å¤´ç»“ç‚¹hashä¸æŸ¥è¯¢keyçš„hashæ˜¯å¦ä¸€è‡´ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹ä¸æŸ¥è¯¢Keyçš„hashå€¼ å®Œå…¨ä¸€è‡´ if ((eh = e.hash) == h) &#123; //å®Œå…¨æ¯”å¯¹ æŸ¥è¯¢key å’Œ å¤´ç»“ç‚¹çš„key //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹å°±æ˜¯æŸ¥è¯¢æ•°æ® if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) return e.val; &#125; //æ¡ä»¶æˆç«‹ï¼š //1.-1 fwd è¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ï¼Œä¸”å½“å‰æŸ¥è¯¢çš„è¿™ä¸ªæ¡¶ä½çš„æ•°æ® å·²ç»è¢«è¿ç§»èµ°äº† //2.-2 TreeBinèŠ‚ç‚¹ï¼Œéœ€è¦ä½¿ç”¨TreeBin æä¾›çš„find æ–¹æ³•æŸ¥è¯¢ã€‚ else if (eh &lt; 0) return (p = e.find(h, key)) != null ? p.val : null; //å½“å‰æ¡¶ä½å·²ç»å½¢æˆé“¾è¡¨çš„è¿™ç§æƒ…å†µ while ((e = e.next) != null) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) return e.val; &#125; &#125; return null;&#125; #11.remove 123public V remove(Object key) &#123; return replaceNode(key, null, null);&#125; #12.replaceNode 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143final V replaceNode(Object key, V value, Object cv) &#123; //è®¡ç®—keyç»è¿‡æ‰°åŠ¨è¿ç®—åçš„hash int hash = spread(key.hashCode()); //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //fè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ //nè¡¨ç¤ºå½“å‰tableæ•°ç»„é•¿åº¦ //iè¡¨ç¤ºhashå‘½ä¸­æ¡¶ä½ä¸‹æ ‡ //fhè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ hash Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼štab == null true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶äºŒï¼š(n = tab.length) == 0 true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(f = tabAt(tab, i = (n - 1) &amp; hash)) == null true -&gt; è¡¨ç¤ºå‘½ä¸­æ¡¶ä½ä¸­ä¸ºnullï¼Œç›´æ¥breakï¼Œ ä¼šè¿”å› if (tab == null || (n = tab.length) == 0 || (f = tabAt(tab, i = (n - 1) &amp; hash)) == null) break; //CASE2ï¼š //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ä¸­ï¼Œå½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ©tableå®Œæˆæ‰©å®¹ã€‚ else if ((fh = f.hash) == MOVED) tab = helpTransfer(tab, f); //CASE3: //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //å½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ &quot;é“¾è¡¨&quot; ä¹Ÿå¯èƒ½ æ˜¯ &quot;çº¢é»‘æ ‘&quot; TreeBin else &#123; //ä¿ç•™æ›¿æ¢ä¹‹å‰çš„æ•°æ®å¼•ç”¨ V oldVal = null; //æ ¡éªŒæ ‡è®° boolean validated = false; //åŠ é”å½“å‰æ¡¶ä½ å¤´ç»“ç‚¹ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ ä»£ç å—ã€‚ synchronized (f) &#123; //åˆ¤æ–­syncåŠ é”æ˜¯å¦ä¸ºå½“å‰æ¡¶ä½ å¤´èŠ‚ç‚¹ï¼Œé˜²æ­¢å…¶å®ƒçº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹åŠ é”æˆåŠŸä¹‹å‰ï¼Œä¿®æ”¹è¿‡ æ¡¶ä½ çš„å¤´ç»“ç‚¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šå½“å‰æ¡¶ä½å¤´ç»“ç‚¹ ä»ç„¶ä¸ºfï¼Œå…¶å®ƒçº¿ç¨‹æ²¡ä¿®æ”¹è¿‡ã€‚ if (tabAt(tab, i) == f) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ¡¶ä½ ä¸º é“¾è¡¨ æˆ–è€… å•ä¸ª node if (fh &gt;= 0) &#123; validated = true; //e è¡¨ç¤ºå½“å‰å¾ªç¯å¤„ç†å…ƒç´  //pred è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ Node&lt;K,V&gt; e = f, pred = null; for (;;) &#123; //å½“å‰èŠ‚ç‚¹key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash true-&gt;è¯´æ˜å½“å‰èŠ‚ç‚¹çš„hashä¸æŸ¥æ‰¾èŠ‚ç‚¹hashä¸€è‡´ //æ¡ä»¶äºŒï¼š((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) //if æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜key ä¸æŸ¥è¯¢çš„keyå®Œå…¨ä¸€è‡´ã€‚ if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å½“å‰èŠ‚ç‚¹çš„value V ev = e.val; //æ¡ä»¶ä¸€ï¼šcv == null true-&gt;æ›¿æ¢çš„å€¼ä¸ºnull é‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªåˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == ev || (ev != null &amp;&amp; cv.equals(ev)) é‚£ä¹ˆæ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (cv == null || cv == ev || (ev != null &amp;&amp; cv.equals(ev))) &#123; //åˆ é™¤ æˆ–è€… æ›¿æ¢ //å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ° oldVal = ev; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (value != null) //ç›´æ¥æ›¿æ¢ e.val = value; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰èŠ‚ç‚¹éå¤´ç»“ç‚¹ else if (pred != null) //å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ pred.next = e.next; else //è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸º å¤´ç»“ç‚¹ï¼Œåªéœ€è¦å°† æ¡¶ä½è®¾ç½®ä¸ºå¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ setTabAt(tab, i, e.next); &#125; break; &#125; pred = e; if ((e = e.next) == null) break; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šTreeBinèŠ‚ç‚¹ã€‚ else if (f instanceof TreeBin) &#123; validated = true; //è½¬æ¢ä¸ºå®é™…ç±»å‹ TreeBin t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //r è¡¨ç¤º çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ //p è¡¨ç¤º çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾åˆ°å¯¹åº”key ä¸€è‡´çš„node TreeNode&lt;K,V&gt; r, p; //æ¡ä»¶ä¸€ï¼š(r = t.root) != null ç†è®ºä¸Šæ˜¯æˆç«‹ //æ¡ä»¶äºŒï¼šTreeNode.findTreeNode ä»¥å½“å‰èŠ‚ç‚¹ä¸ºå…¥å£ï¼Œå‘ä¸‹æŸ¥æ‰¾keyï¼ˆåŒ…æ‹¬æœ¬èº«èŠ‚ç‚¹ï¼‰ // true-&gt;è¯´æ˜æŸ¥æ‰¾åˆ°ç›¸åº”key å¯¹åº”çš„nodeèŠ‚ç‚¹ã€‚ä¼šèµ‹å€¼ç»™p if ((r = t.root) != null &amp;&amp; (p = r.findTreeNode(hash, key, null)) != null) &#123; //ä¿å­˜p.val åˆ°pv V pv = p.val; //æ¡ä»¶ä¸€ï¼šcv == null æˆç«‹ï¼šä¸å¿…å¯¹valueï¼Œå°±åšæ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == pv ||(pv != null &amp;&amp; cv.equals(pv)) æˆç«‹ï¼šè¯´æ˜â€œå¯¹æ¯”å€¼â€ä¸å½“å‰pèŠ‚ç‚¹çš„å€¼ ä¸€è‡´ if (cv == null || cv == pv || (pv != null &amp;&amp; cv.equals(pv))) &#123; //æ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ oldVal = pv; //æ¡ä»¶æˆç«‹ï¼šæ›¿æ¢æ“ä½œ if (value != null) p.val = value; //åˆ é™¤æ“ä½œ else if (t.removeTreeNode(p)) //è¿™é‡Œæ²¡åšåˆ¤æ–­ï¼Œç›´æ¥æäº†...å¾ˆç–‘æƒ‘ setTabAt(tab, i, untreeify(t.first)); &#125; &#125; &#125; &#125; &#125; //å½“å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½ å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹ é”é”™å¯¹è±¡æ—¶ï¼Œvalidated ä¸ºfalseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡for è‡ªæ—‹ if (validated) &#123; if (oldVal != null) &#123; //æ›¿æ¢çš„å€¼ ä¸ºnullï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼ŒoldVal ï¼=null æˆç«‹ï¼Œè¯´æ˜åˆ é™¤æˆåŠŸï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‚ if (value == null) addCount(-1L, -1); return oldVal; &#125; break; &#125; &#125; &#125; return null;&#125; #13.TreeBin##13.1 å±æ€§ 1234567891011121314151617//çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ TreeNode&lt;K,V&gt; root;//é“¾è¡¨çš„å¤´èŠ‚ç‚¹volatile TreeNode&lt;K,V&gt; first;//ç­‰å¾…è€…çº¿ç¨‹ï¼ˆå½“å‰lockStateæ˜¯è¯»é”çŠ¶æ€ï¼‰volatile Thread waiter;/** * 1.å†™é”çŠ¶æ€ å†™æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ°TreeBinä¸­çš„å†™çº¿ç¨‹ åŒä¸€æ—¶åˆ» åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ 1 * 2.è¯»é”çŠ¶æ€ è¯»é”æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBinå¯¹è±¡ä¸­è·å–æ•°æ®ã€‚ æ¯ä¸€ä¸ªçº¿ç¨‹ éƒ½ä¼šç»™ lockStat + 4 * 3.ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“TreeBinä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆå°±å°†lockStateçš„æœ€ä½2ä½ è®¾ç½®ä¸º 0b 10 */volatile int lockState;// values for lockStatestatic final int WRITER = 1; // set while holding write lockstatic final int WAITER = 2; // set when waiting for write lockstatic final int READER = 4; // increment value for setting read lock ##13.2 æ„é€ å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586TreeBin(TreeNode&lt;K,V&gt; b) &#123; //è®¾ç½®èŠ‚ç‚¹hashä¸º-2 è¡¨ç¤ºæ­¤èŠ‚ç‚¹æ˜¯TreeBinèŠ‚ç‚¹ super(TREEBIN, null, null, null); //ä½¿ç”¨first å¼•ç”¨ treeNodeé“¾è¡¨ this.first = b; //r çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹å¼•ç”¨ TreeNode&lt;K,V&gt; r = null; //xè¡¨ç¤ºéå†çš„å½“å‰èŠ‚ç‚¹ for (TreeNode&lt;K,V&gt; x = b, next; x != null; x = next) &#123; next = (TreeNode&lt;K,V&gt;)x.next; //å¼ºåˆ¶è®¾ç½®å½“å‰æ’å…¥èŠ‚ç‚¹çš„å·¦å³å­æ ‘ä¸ºnull x.left = x.right = null; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¢é»‘æ ‘ æ˜¯ä¸€ä¸ªç©ºæ ‘ï¼Œé‚£ä¹ˆè®¾ç½®æ’å…¥å…ƒç´  ä¸ºæ ¹èŠ‚ç‚¹ if (r == null) &#123; //æ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸€å®šä¸º null x.parent = null; //é¢œè‰²æ”¹ä¸ºé»‘è‰² x.red = false; //è®©rå¼•ç”¨xæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚ r = x; &#125; else &#123; //éç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œéƒ½ä¼šæ¥å¸¦elseåˆ†æ”¯ï¼Œæ­¤æ—¶çº¢é»‘æ ‘å·²ç»æœ‰æ•°æ®äº† //k è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„key K k = x.key; //h è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„hash int h = x.hash; //kc è¡¨ç¤º æ’å…¥èŠ‚ç‚¹keyçš„classç±»å‹ Class&lt;?&gt; kc = null; //p è¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; p = r; for (;;) &#123; //dir (-1, 1) //-1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼å¤§äº å½“å‰pèŠ‚ç‚¹çš„hash //1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰pèŠ‚ç‚¹çš„hash //ph pè¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„hash int dir, ph; //ä¸´æ—¶èŠ‚ç‚¹ key K pk = p.key; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰èŠ‚ç‚¹ if ((ph = p.hash) &gt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å·¦å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = -1; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å¤§äº å½“å‰èŠ‚ç‚¹ else if (ph &lt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å³å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = 1; //å¦‚æœæ‰§è¡Œåˆ° CASE3ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„hash ä¸ å½“å‰èŠ‚ç‚¹çš„hashä¸€è‡´ï¼Œä¼šåœ¨case3 åšå‡ºæœ€ç»ˆæ’åºã€‚æœ€ç»ˆ //æ‹¿åˆ°çš„dir ä¸€å®šä¸æ˜¯0ï¼Œï¼ˆ-1ï¼Œ 1ï¼‰ else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) dir = tieBreakOrder(k, pk); //xp æƒ³è¦è¡¨ç¤ºçš„æ˜¯ æ’å…¥èŠ‚ç‚¹çš„ çˆ¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; xp = p; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰pèŠ‚ç‚¹ å³ä¸ºæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ //æ¡ä»¶ä¸æˆç«‹ï¼šè¯´æ˜pèŠ‚ç‚¹ åº•ä¸‹è¿˜æœ‰å±‚æ¬¡ï¼Œéœ€è¦å°†pæŒ‡å‘ pçš„å·¦å­èŠ‚ç‚¹ æˆ–è€… å³å­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºç»§ç»­å‘ä¸‹æœç´¢ã€‚ if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //è®¾ç½®æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸º å½“å‰èŠ‚ç‚¹ x.parent = xp; //å°äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ if (dir &lt;= 0) xp.left = x; //å¤§äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ else xp.right = x; //æ’å…¥èŠ‚ç‚¹åï¼Œçº¢é»‘æ ‘æ€§è´¨ å¯èƒ½ä¼šè¢«ç ´åï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ å¹³è¡¡æ–¹æ³• r = balanceInsertion(r, x); break; &#125; &#125; &#125; &#125; //å°†r èµ‹å€¼ç»™ TreeBinå¯¹è±¡çš„ rootå¼•ç”¨ã€‚ this.root = r; assert checkInvariants(root);&#125; ##13.3 putTreeVal 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970final TreeNode&lt;K,V&gt; putTreeVal(int h, K k, V v) &#123; Class&lt;?&gt; kc = null; boolean searched = false; for (TreeNode&lt;K,V&gt; p = root;;) &#123; int dir, ph; K pk; if (p == null) &#123; first = root = new TreeNode&lt;K,V&gt;(h, k, v, null, null); break; &#125; else if ((ph = p.hash) &gt; h) dir = -1; else if (ph &lt; h) dir = 1; else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk))) return p; else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) &#123; if (!searched) &#123; TreeNode&lt;K,V&gt; q, ch; searched = true; if (((ch = p.left) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null) || ((ch = p.right) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null)) return q; &#125; dir = tieBreakOrder(k, pk); &#125; TreeNode&lt;K,V&gt; xp = p; if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹xp å³ä¸º x èŠ‚ç‚¹çš„çˆ¸çˆ¸ //x è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹ //f è€çš„å¤´ç»“ç‚¹ TreeNode&lt;K,V&gt; x, f = first; first = x = new TreeNode&lt;K,V&gt;(h, k, v, f, xp); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜é“¾è¡¨æœ‰æ•°æ® if (f != null) //è®¾ç½®è€çš„å¤´ç»“ç‚¹çš„å‰ç½®å¼•ç”¨ä¸º å½“å‰çš„å¤´ç»“ç‚¹ã€‚ f.prev = x; if (dir &lt;= 0) xp.left = x; else xp.right = x; if (!xp.red) x.red = true; else &#123; //è¡¨ç¤º å½“å‰æ–°æ’å…¥èŠ‚ç‚¹åï¼Œæ–°æ’å…¥èŠ‚ç‚¹ ä¸ çˆ¶èŠ‚ç‚¹ å½¢æˆ â€œçº¢çº¢ç›¸è¿â€ lockRoot(); try &#123; //å¹³è¡¡çº¢é»‘æ ‘ï¼Œä½¿å…¶å†æ¬¡ç¬¦åˆè§„èŒƒã€‚ root = balanceInsertion(root, x); &#125; finally &#123; unlockRoot(); &#125; &#125; break; &#125; &#125; assert checkInvariants(root); return null;&#125; ##13.4 find 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748final Node&lt;K,V&gt; find(int h, Object k) &#123; if (k != null) &#123; //e è¡¨ç¤ºå¾ªç¯è¿­ä»£çš„å½“å‰èŠ‚ç‚¹ è¿­ä»£çš„æ˜¯firstå¼•ç”¨çš„é“¾è¡¨ for (Node&lt;K,V&gt; e = first; e != null; ) &#123; //s ä¿å­˜çš„æ˜¯lockä¸´æ—¶çŠ¶æ€ //ek é“¾è¡¨å½“å‰èŠ‚ç‚¹ çš„key int s; K ek; //(WAITER|WRITER) =&gt; 0010 | 0001 =&gt; 0011 //lockState &amp; 0011 != 0 æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰TreeBin æœ‰ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… ç›®å‰æœ‰å†™æ“ä½œçº¿ç¨‹æ­£åœ¨åŠ é” if (((s = lockState) &amp; (WAITER|WRITER)) != 0) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek)))) return e; e = e.next; &#125; //å‰ç½®æ¡ä»¶ï¼šå½“å‰TreeBinä¸­ ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… å†™çº¿ç¨‹ éƒ½æ²¡æœ‰ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ·»åŠ è¯»é”æˆåŠŸ else if (U.compareAndSwapInt(this, LOCKSTATE, s, s + READER)) &#123; TreeNode&lt;K,V&gt; r, p; try &#123; //æŸ¥è¯¢æ“ä½œ p = ((r = root) == null ? null : r.findTreeNode(h, k, null)); &#125; finally &#123; //w è¡¨ç¤ºç­‰å¾…è€…çº¿ç¨‹ Thread w; //U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) //1.å½“å‰çº¿ç¨‹æŸ¥è¯¢çº¢é»‘æ ‘ç»“æŸï¼Œé‡Šæ”¾å½“å‰çº¿ç¨‹çš„è¯»é” å°±æ˜¯è®© lockstate å€¼ - 4 //(READER|WAITER) = 0110 =&gt; è¡¨ç¤ºå½“å‰åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œä¸”â€œæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…â€ //å½“å‰è¯»çº¿ç¨‹ä¸º TreeBinä¸­çš„æœ€åä¸€ä¸ªè¯»çº¿ç¨‹ã€‚ //2.(w = waiter) != null è¯´æ˜æœ‰ä¸€ä¸ªå†™çº¿ç¨‹åœ¨ç­‰å¾…è¯»æ“ä½œå…¨éƒ¨ç»“æŸã€‚ if (U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) &amp;&amp; (w = waiter) != null) //ä½¿ç”¨unpark è®© å†™çº¿ç¨‹ æ¢å¤è¿è¡ŒçŠ¶æ€ã€‚ LockSupport.unpark(w); &#125; return p; &#125; &#125; &#125; return null;&#125; #æ€»ç»“åœ¨java8ä¸­ï¼ŒConcurrentHashMapä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»„åˆæ–¹å¼ï¼Œåˆ©ç”¨caså’Œsynchronizedä¿è¯å¹¶å‘å†™çš„å®‰å…¨ã€‚ å¼•å…¥çº¢é»‘æ ‘çš„åŸå› ï¼šé“¾è¡¨æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸ºOnï¼Œä½†æ˜¯çº¢é»‘æ ‘çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(log(n)),æ‰€ä»¥åœ¨èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¢é»‘æ ‘å¯ä»¥å¤§å¤§æå‡æ€§èƒ½ã€‚ é“¾å¼æ¡¶æ˜¯ä¸€ä¸ªç”±nodeèŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ã€‚æ ‘çŠ¶æ¡¶æ˜¯ä¸€é¢—ç”±TreeNodeèŠ‚ç‚¹ç»„æˆçš„çº¢é»‘æ ‘ã€‚è¾“çš„æ ¹èŠ‚ç‚¹ä¸ºTreeBinç±»å‹ã€‚ å½“é“¾è¡¨é•¿åº¦å¤§äº8æ•´ä¸ªhashè¡¨é•¿åº¦å¤§äº64çš„æ—¶å€™ï¼Œå°±ä¼šè½¬åŒ–ä¸ºTreeBinã€‚TreeBinä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯çº¢é»‘æ ‘å¯¹è±¡ã€‚åœ¨ConcurrentHashMapçš„tableæ•°ç»„ä¸­ï¼Œå­˜æ”¾çš„å°±æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNoeå¯¹è±¡ã€‚ æ•°ç»„tableæ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œæ‰€ä»¥initTable()å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ é‡è¦çš„å±æ€§å°±æ˜¯sizeCtlï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹æ“ä½œçš„è¿‡ç¨‹ï¼š â— -1ä»£è¡¨tableæ­£åœ¨åˆå§‹åŒ–ï¼Œå…¶ä»–çº¿ç¨‹ç›´æ¥joinç­‰å¾…ã€‚ â— -Nä»£è¡¨æœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œä¸¥æ ¼æ¥è¯´ï¼Œå½“å…¶ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œåªç”¨åˆ°äº†ä½16ä½ï¼Œå¦‚æœä½16ä½ä¸ºMï¼Œæ­¤æ—¶æœ‰M-1ä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹ã€‚ â— å¤§äº0æœ‰ä¸¤ç§æƒ…å†µï¼šå¦‚æœtableæ²¡æœ‰åˆå§‹åŒ–ï¼Œå¥¹å°±è¡¨ç¤ºtableåˆå§‹åŒ–çš„å¤§å°ï¼Œå¦‚æœtableåˆå§‹åŒ–å®Œäº†ï¼Œå°±è¡¨ç¤ºtableçš„å®¹é‡ï¼Œé»˜è®¤æ˜¯tableå¤§å°çš„å››åˆ†ä¹‹ä¸‰ã€‚ Transfer()æ‰©å®¹ tableæ•°æ®è½¬ç§»åˆ°nextTableã€‚æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼ŒæŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ConcurrentHashMapç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒæŠŠtableæ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹æ‰€è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„ Bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰Bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ helpTransfer()å¸®åŠ©æ‰©å®¹ ConcurrentHashMapå¹¶å‘æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œå…¶ä»–çº¿ç¨‹ä¼šå¸®åŠ©æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å¤šçº¿ç¨‹æ‰©å®¹ã€‚ ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œé»˜è®¤åˆå§‹é•¿åº¦ä¸º16ï¼Œå½“å¾€tableä¸­ç»§ç»­æ·»åŠ å…ƒç´ æ—¶ï¼Œé€šè¿‡Hashå€¼è·Ÿæ•°ç»„é•¿åº¦å–ä½™æ¥å†³å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªBucketä½ç½®ï¼Œå¦‚æœå‡ºç°æ”¾åœ¨åŒä¸€ä¸ªä½ç½®ï¼Œå°±ä¼˜å…ˆä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼Œåœ¨åŒä¸€ä¸ªä½ç½®çš„ä¸ªæ•°è¾¾åˆ°äº†8ä¸ªä»¥ä¸Šï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦è¿˜å°äº64ï¼Œå°±ä¼šæ‰©å®¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64ï¼Œå°±ä¼šå°†è¯¥èŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢æˆæ ‘ã€‚ é€šè¿‡æ‰©å®¹æ•°ç»„çš„æ–¹å¼æ¥æŠŠè¿™äº›èŠ‚ç‚¹åˆ†æ•£å¼€ã€‚ç„¶åå°†è¿™äº›å…ƒç´ å¤åˆ¶åˆ°æ‰©å®¹åçš„æ–°æ•°ç»„ä¸­ï¼ŒåŒä¸€ä¸ªBucketä¸­çš„å…ƒç´ é€šè¿‡Hashå€¼çš„æ•°ç»„é•¿åº¦ä½æ¥é‡æ–°ç¡®å®šä½ç½®ï¼Œå¯èƒ½è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®ï¼Œä¹Ÿå¯èƒ½æ”¾åˆ°æ–°çš„ä½ç½®ã€‚è€Œä¸”ï¼Œåœ¨æ‰©å®¹å®Œæˆä¹‹åï¼Œå¦‚æœä¹‹å‰æŸä¸ªèŠ‚ç‚¹æ˜¯æ ‘ï¼Œä½†æ˜¯ç°åœ¨è¯¥èŠ‚ç‚¹çš„â€œKey-Valueå¯¹â€æ•°åˆå°äºç­‰äº6ä¸ªï¼Œå°±ä¼šå°†è¯¥æ ‘è½¬ä¸ºé“¾è¡¨ã€‚ put() JDK1.8åœ¨ä½¿ç”¨CASè‡ªæ—‹å®Œæˆæ¡¶çš„è®¾ç½®æ—¶ï¼Œä½¿ç”¨synchronizedå†…ç½®é”ä¿è¯æ¡¶å†…å¹¶å‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡å¯¹åŒä¸€ä¸ªMapæ“ä½œçš„çº¿ç¨‹äº‰ç”¨ä¼šéå¸¸æ¿€çƒˆï¼Œä½†æ˜¯åœ¨åŒä¸€ä¸ªæ¡¶å†…çš„çº¿ç¨‹äº‰ç”¨é€šå¸¸ä¸ä¼šå¾ˆæ¿€çƒˆï¼Œæ‰€ä»¥ä½¿ç”¨CASè‡ªæ—‹ã€synchronizedä¸ä¼šé™ä½ConcurrentHashMapçš„æ€§èƒ½ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ReentrantLockæ˜¾å¼é”å‘¢?å¦‚æœä¸ºæ¯ ä¸ªæ¡¶éƒ½åˆ›å»ºä¸€ä¸ªReentrantLockå® ä¾‹ï¼Œå°±ä¼šå¸¦æ¥å¤§é‡çš„å†…å­˜æ¶ˆè€—ï¼Œåè¿‡æ¥ï¼Œä½¿ç”¨CASè‡ªæ—‹ã€synchronizedï¼Œå†…å­˜æ¶ˆè€—çš„å¢åŠ æ›´å°ã€‚ get() get()é€šè¿‡UnSafeçš„getObjectVolatile()æ¥è¯»å–æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åš?è™½ç„¶HashEntryæ•°ç»„çš„å¼•ç”¨æ˜¯volatileç±»å‹ï¼Œä½†æ˜¯æ•°ç»„å†…å…ƒç´ çš„ ç”¨ä¸æ˜¯volatileç±»å‹ï¼Œå› æ­¤å¤šçº¿ç¨‹å¯¹ æ•°ç»„å…ƒç´ çš„ä¿®æ”¹æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šåœ¨æ•°ç»„ä¸­è¯»å–åˆ°å°šæœªæ„é€ å®Œæˆçš„å…ƒç´ å¯¹è±¡ã€‚get()æ–¹æ³•é€šè¿‡UnSafeçš„getObjectVolatileæ–¹æ³•æ¥ä¿è¯å…ƒç´ çš„è¯»å–å®‰å…¨ï¼Œè°ƒç”¨getObjectVolatile()å»è¯»å–æ•°ç»„å…ƒç´ éœ€è¦å…ˆè·å¾—å…ƒç´ åœ¨æ•°ç»„ä¸­çš„åç§»é‡ï¼Œåœ¨è¿™é‡Œï¼Œget()æ–¹æ³•æ ¹æ®å“ˆå¸Œç è®¡ç®—å‡ºåç§»é‡ä¸ºuï¼Œç„¶åé€šè¿‡åç§»é‡uæ¥å°è¯•è¯»å–æ•°å€¼ã€‚","categories":[{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://zhangxin66666.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://zhangxin66666.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]},{"title":"é¢è¯•çŸ¥è¯†ç‚¹æ€»ç»“","slug":"12.é¢è¯•/å¸¸è§é¢è¯•é¢˜","date":"2022-03-30T16:00:00.000Z","updated":"2022-04-02T03:10:36.669Z","comments":true,"path":"2022/03/31/12.é¢è¯•/å¸¸è§é¢è¯•é¢˜/","link":"","permalink":"https://zhangxin66666.github.io/2022/03/31/12.%E9%9D%A2%E8%AF%95/%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/","excerpt":"","text":"ä¸€ã€åŸºç¡€çŸ¥è¯†1.é›†åˆ1.1ConcurrentHashMapConcurrentHashMap 1.2xxxSet,List,Mapæœ‰ä»€ä¹ˆåŒºåˆ« ç»“æ„ç‰¹ç‚¹ List å’Œ Set æ˜¯å­˜å‚¨å•åˆ—æ•°æ®çš„é›†åˆï¼Œ Map æ˜¯å­˜å‚¨é”®å’Œå€¼è¿™æ ·çš„åŒåˆ—æ•°æ®çš„é›†åˆ; Listä¸­å­˜å‚¨çš„æ•°æ®æ˜¯æœ‰é¡ºåºï¼Œå¹¶ä¸”å…è®¸é‡å¤; Map ä¸­å­˜å‚¨çš„æ•°æ®æ˜¯æ²¡æœ‰é¡ºåºçš„ï¼Œå…¶é”®æ˜¯ä¸èƒ½é‡å¤çš„ï¼Œå®ƒçš„å€¼æ˜¯å¯ä»¥æœ‰é‡å¤çš„ï¼Œ Set ä¸­å­˜å‚¨çš„æ•°æ®æ˜¯æ— åºçš„ï¼Œä¸”ä¸å…è®¸æœ‰é‡å¤ï¼Œä½†å…ƒç´ åœ¨é›†åˆä¸­çš„ä½ç½®ç”±å…ƒç´ çš„hashcodeå†³å®šï¼Œä½ç½®æ˜¯å›ºå®šçš„(Seté›†åˆæ ¹æ® hashcode æ¥è¿›è¡Œæ•°æ®çš„å­˜å‚¨ï¼Œæ‰€ä»¥ä½ç½®æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯ä½ç½®ä¸æ˜¯ç”¨æˆ·å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥å¯¹äºç”¨æˆ·æ¥è¯´ set ä¸­çš„å…ƒç´ è¿˜æ˜¯æ— åºçš„); HashMapå’ŒHashTableæœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸåŒºåˆ«ï¼š HashMapæ–¹æ³•æ²¡æœ‰synchronizedä¿®é¥°ï¼Œçº¿ç¨‹éå®‰å…¨ï¼ŒHashTableçº¿ç¨‹å®‰å…¨ï¼› HashMapå…è®¸keyå’Œvalueä¸ºnullï¼Œè€ŒHashTableä¸å…è®¸ HashMapåº•å±‚å®ç° jdk1.7åº•å±‚é‡‡ç”¨çš„æ˜¯æ•°ç»„+é“¾è¡¨å®ç°ï¼›jdk1.8åº•å±‚é‡‡ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘å®ç°ï¼Œç›¸å¯¹äº1.7æå‡äº†æŸ¥è¯¢çš„æ€§èƒ½ é“¾è¡¨è¿‡åº¦åˆ°çº¢é»‘æ ‘çš„é˜ˆå€¼ä¸º8ï¼Œçº¢é»‘æ ‘é€€åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼æ˜¯6ï¼ŒåŸå› åœ¨æºç ä¸­332è¡Œç»™äº†æ˜ç¡®è§£é‡Š(Poisson distribution)æ³Šæ¾åˆ†å¸ƒï¼Œè¿™æ˜¯æ•°å­¦é‡Œé¢ç±»ä¼¼äºæ­£æ€åˆ†å¸ƒçš„ä¸€ä¸ªé—®é¢˜ï¼Œè¿™æ˜¯ç»Ÿè®¡å­¦é‡Œé¢çš„ä¸€äº›ä¸œè¥¿ HashMapåˆå§‹åŒ–çš„æ•°ç»„é•¿åº¦ä¸º16(ç®—æ³•å¯¼è®ºä¸­çš„é™¤æ³•æ•£åˆ—æ³•è®²åˆ° Kå–æ¨¡må¾—åˆ°ä¸€ä¸ªå¯¹åº”çš„ä½ç½®ï¼Œæ ¹æ®å…·ä½“ä½ç½®æ’å…¥ä¸€ä¸ªæ•°æ®å€¼ï¼Œå‡å¦‚é•¿åº¦æ˜¯16ï¼Œé•¿åº¦èŒƒå›´å°±æ˜¯015ï¼Œå–æ¨¡ä¹‹åæˆ‘çš„ä½™æ•°ä¸º015ä¹‹é—´ï¼Œè€Œç®—æ³•å¯¼è®ºä¸­æŒ‡å‡ºï¼Œä¸€ä¸ªä¸å¤ªæ¥è¿‘2çš„æ•´æ•°å¹‚çš„ç´ æ•°ï¼ˆè´¨æ•°ï¼šåªèƒ½è¢«1å’Œå®ƒæœ¬èº«æ•´å‡ºçš„æ•°ï¼‰ï¼Œå¸¸å¸¸æ˜¯mçš„æœ€å¥½é€‰æ‹©ã€‚ä½†æ˜¯hashMapä¸­æœªé‡‡ç”¨ç´ æ•°ï¼Œè€Œæ˜¯é‡‡ç”¨2çš„næ¬¡æ–¹(åˆæ•°)ä½œä¸ºæ•°ç»„é•¿åº¦)ï¼ŒåŸå› ä¸ºï¼š1ã€æ›´ä¾¿äºä½ç½®è®¡ç®—ï¼›2ã€æ–¹ä¾¿åšæ•°æ®è¿ç§»ã€‚ ä¸ºäº†ä¿è¯å­˜å…¥çš„æ•°æ®å‡åŒ€çš„æ•£åˆ—åˆ†å¸ƒåœ¨æ•°ç»„ä¸­ï¼Œéœ€è¦è®¾è®¡è‰¯å¥½çš„hashæ•£åˆ—ç®—æ³•(hashMapä¸­é‡‡ç”¨æ‰°åŠ¨å‡½æ•°æ¥åšçš„ï¼šç§»ä½å’Œå¼‚æˆ–ç›¸å…³æ“ä½œConcurrentHashMapæºç ä¸­684è¡Œspreadæ–¹æ³•ï¼Œå³ï¼šè®©intçš„é«˜16ä½å¼‚æˆ–å®ƒæœ¬èº«)ï¼Œå°½å¯èƒ½çš„é¿å…hashå†²çª(æ¦‚ç‡é—®é¢˜)ï¼Œå…·ä½“è½åˆ°æ•°ç»„å“ªä¸ªèŠ‚ç‚¹å¹¶éæ˜¯é€šè¿‡å–æ¨¡è¿ç®—å¾—å‡ºï¼Œè€Œæ˜¯é€šè¿‡ä¸ä¸Šæ•°ç»„é•¿åº¦-1å³å¯(åªéœ€è¦intç±»å‹æ•°32ä½çš„åå››ä½å‚ä¸è¿ç®—)ï¼Œå³å¯å¾—åˆ°0~15ä¹‹é—´çš„æ•°ï¼Œå› ä¸ºå–æ¨¡è¿ç®—æ•ˆç‡è¿œä½äºä½è¿ç®—ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯hashMapè¦æ±‚åº•å±‚æ•°ç»„é•¿åº¦å¿…é¡»ä¸º2çš„næ¬¡æ–¹çš„åŸå› ä¹‹ä¸€ï¼ˆConcurrentHashMapæºç ä¸­514è¡Œè§„å®šï¼‰ã€‚ HashMap putæµç¨‹ HashMap/ConcurrentHashMap å¹¶ä¸æ˜¯é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºé»˜è®¤ç©ºé—´çš„ï¼Œè€Œæ˜¯é€šè¿‡putæ•°æ®çš„æ—¶å€™è·å–åˆ°å¯¹åº”çš„æ•°æ®ç©ºé—´çš„ï¼Œå¦‚æœæ•°ç»„é•¿åº¦æ˜¯0ï¼Œåˆ™é€šè¿‡CASæ“ä½œååˆå§‹åŒ–æ•°ç»„ï¼Œå¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨åšåˆå§‹åŒ–æ•°ç»„æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹åˆ™è®©å‡ºæ—¶é—´ç‰‡ HashMapæ‰©å®¹æµç¨‹ hashMapè§„å®šäº†å½“æˆ‘çš„æ•°ç»„å¿«æ”¾æ»¡çš„æ—¶å€™å°±è¦å¼€å§‹æ‰©å®¹äº†ï¼Œä»€ä¹ˆæ—¶å€™ç®—æ˜¯å¿«æ”¾æ»¡ï¼ŸHashMapæ˜¯é€šè¿‡æ‰©å®¹å› å­æ¥è§„å®šçš„ HashMapè§„å®šæ‰©å®¹å› å­æ˜¯0.75ï¼Œå¦‚æœé»˜è®¤é•¿åº¦æ˜¯16ï¼Œä¹Ÿå°±æ˜¯è¯´å½“HashMapåº•å±‚æ•°ç»„çš„å®¹é‡è¾¾åˆ°12çš„æ—¶å€™è¿›è¡Œæ‰©å®¹æ“ä½œã€‚0.75åˆ™æ˜¯æ ¹æ®ç»Ÿè®¡å­¦å¾—æ¥çš„ã€‚private static final float LOAD_FACTOR = 0.75f; æ‰©å®¹é¦–å…ˆè¦åˆ›å»ºæ–°çš„æ•°ç»„ï¼ˆåŸæ¥å¤§å°å·¦ç§»1ä½ï¼‰ConcurrentHaspMapæºç 2367è¡Œå¼€å§‹æ‰©å®¹æ“ä½œ è½¬ç§»æ—§æ•°æ®åˆ°æ–°çš„æ•°ç»„ä¸­å»ï¼ˆæ€ä¹ˆè®¡ç®—æ‰©å®¹åæ•°æ®ä¸‹æ ‡ä½ç½®ï¼Ÿï¼‰åŸæ¥ï¼šh&amp;(n-1)è®¡ç®—ä¸‹æ ‡ä½ç½®ï¼Œæ‰©å®¹å h$(31)ï¼ŒåŸæ¥å ç”¨4ä¸ªäºŒè¿›åˆ¶ä½ï¼Œæ‰©å®¹åå ç”¨5ä¸ªäºŒè¿›åˆ¶ä½ï¼Œæ‰€ä»¥åªéœ€è¦çœ‹ç¬¬äº”ä½å³å¯ï¼Œå¦‚æœç¬¬äº”ä½æ˜¯0ï¼Œæ‰©å®¹åçš„çš„ä¸‹æ ‡è·ŸåŸä½ç½®ä¸€æ ·ï¼Œå¦‚æœæ˜¯1ï¼Œæ–°ä¸‹æ ‡ä½ç½®åœ¨åŸæ•°ç»„çš„ä½ç½®çš„åŸºç¡€ä¸ŠåŠ ä¸ŠåŸæ¥æ•°ç»„é•¿åº¦å³å¯ï¼Œè¿™ä¹Ÿæ˜¯æ•°ç»„é•¿åº¦é‡‡ç”¨2çš„Næ¬¡æ–¹æ‰©å®¹çš„ç¬¬äºŒä¸ªåŸå›  å‡è®¾åŸæ¥é•¿åº¦æ˜¯128ï¼Œæ‰©å®¹åæ˜¯256ï¼Œæ•´ä½“æ‰©å®¹æ–¹å¼æ˜¯é€šè¿‡å¤šçº¿ç¨‹æ–¹å¼è¿è¡Œçš„ï¼Œä½†æ˜¯è¦ä¿è¯æ•°æ®ä¸èƒ½ä¹±ï¼Œå°†åŸæ¥æ•°ç»„åˆ†æ®µï¼Œè§„å®šæ¯ä¸ªçº¿ç¨‹æœ€å°‘è´Ÿè´£16ä¸ªæ¡¶çš„è¿ç§»å·¥ä½œï¼Œ8ä¸ªçº¿ç¨‹å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œå¦‚æœå°äº16ä¸ªæ¡¶ï¼Œç›´æ¥å•çº¿ç¨‹æ‰§è¡Œ ä¸ºä»€ä¹ˆé€‰æ‹©ç”¨çº¢é»‘æ ‘äºŒå‰æ ‘åœ¨æç«¯æƒ…å†µä¸‹ä¼šé€€åŒ–ä¸ºé“¾è¡¨ï¼ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦è·Ÿé“¾è¡¨ç›¸ä¼¼ï¼Œè€ŒAVLæ ‘ï¼ŒSBæ ‘ï¼Œçº¢é»‘æ ‘ï¼Œéƒ½å±äºå¹³è¡¡äºŒå‰æ ‘ï¼Œå°½é‡ä¿æŒå·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦å·®ä¸è¦ç›¸å·®å¤ªå¤§ï¼Œè€Œè¿™ä¸‰ç§æ ‘çš„å·®åˆ«å°±åœ¨äºå·¦æ ‘å’Œå³æ ‘çš„é«˜åº¦è§„åˆ™ä¸åŒã€‚ AVLæ ‘ï¼šä¸¥æ ¼æ„ä¹‰å¹³è¡¡æ ‘ï¼Œçš„è¦æ±‚å·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦å·®ä¸èƒ½è¶…è¿‡1ï¼ŒæŸå¤±äº†éƒ¨åˆ†æ’å…¥æ€§èƒ½ï¼Œå¸¦æ¥äº†é«˜æ•ˆçš„æŸ¥è¯¢ SBæ ‘ï¼š çº¢é»‘æ ‘ï¼šè¦æ±‚æœ€é•¿å­æ ‘ä¸èƒ½è¶…è¿‡æœ€çŸ­å­æ ‘çš„2å€å³å¯ï¼ŒæŸå¤±äº†éƒ¨åˆ†æŸ¥è¯¢æ€§èƒ½ï¼Œä½¿å¾—æŸ¥è¯¢æ•ˆç‡é«˜äºé“¾è¡¨çš„åŒæ—¶ï¼Œç›¸æ¯”äºå…¶ä»–æ ‘æå‡äº†æ’å…¥æ€§èƒ½ï¼Œå°½é‡åšåˆ°äº†æ’å…¥å’ŒæŸ¥è¯¢çš„ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œè€ŒHashMapåˆ™æ˜¯æŸ¥å¤šï¼Œæ’å…¥å°‘(è¿™é‡Œçš„æ’å…¥æŒ‡çš„æ˜¯äº§ç”ŸHashå†²çªä¸‹çš„æ’å…¥)ï¼Œæ‰€ä»¥çº¢é»‘æ ‘æ›´é€‚åˆHashMapæ¥åšåº•å±‚çš„å­˜å‚¨ç»“æ„ã€‚ ConcurrentHaspMap ConcurrentHaspMapæ˜¯çº¿ç¨‹å®‰å…¨çš„HashMapï¼Œå®ƒåº•å±‚é‡‡ç”¨å¤§é‡çš„CASæ“ä½œ é¢å‘å¯¹è±¡çš„ç‰¹å¾?é¢å‘å¯¹è±¡çš„ç‰¹å¾:å°è£…ã€ç»§æ‰¿ã€å¤šæ€ã€æŠ½è±¡ã€‚ å°è£…:å°±æ˜¯æŠŠå¯¹è±¡çš„å±æ€§å’Œè¡Œä¸º(æ•°æ®)ç»“åˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ•´ä½“ï¼Œå¹¶å°½å¯èƒ½éšè—å¯¹è±¡çš„å†… éƒ¨å®ç°ç»†èŠ‚ï¼Œå°±æ˜¯æŠŠä¸æƒ³å‘Šè¯‰æˆ–è€…ä¸è¯¥å‘Šè¯‰åˆ«äººçš„ä¸œè¥¿éšè—èµ·æ¥ï¼ŒæŠŠå¯ä»¥å‘Šè¯‰åˆ«äººçš„å…¬å¼€ï¼Œåˆ«äººåªèƒ½ç”¨æˆ‘æä¾›çš„åŠŸèƒ½å®ç°éœ€æ±‚ï¼Œè€Œä¸çŸ¥é“æ˜¯å¦‚ä½•å®ç°çš„ã€‚å¢åŠ å®‰å…¨æ€§ã€‚ ç»§æ‰¿:å­ç±»ç»§æ‰¿çˆ¶ç±»çš„æ•°æ®å±æ€§å’Œè¡Œä¸ºï¼Œå¹¶èƒ½æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ‰©å±•å‡ºæ–°çš„è¡Œä¸ºï¼Œæé«˜äº†ä»£ ç çš„å¤ç”¨æ€§ã€‚ å¤šæ€:æŒ‡å…è®¸ä¸åŒçš„å¯¹è±¡å¯¹åŒä¸€æ¶ˆæ¯åšå‡ºç›¸åº”ã€‚å³åŒä¸€æ¶ˆæ¯å¯ä»¥æ ¹æ®å‘é€å¯¹è±¡çš„ä¸åŒè€Œé‡‡ ç”¨å¤šç§ä¸åŒçš„è¡Œä¸ºæ–¹å¼(å‘é€æ¶ˆæ¯å°±æ˜¯å‡½æ•°è°ƒç”¨)ã€‚å°è£…å’Œç»§æ‰¿å‡ ä¹éƒ½æ˜¯ä¸ºå¤šæ€è€Œå‡†å¤‡ çš„ï¼Œåœ¨æ‰§è¡ŒæœŸé—´åˆ¤æ–­å¼•ç”¨å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œæ ¹æ®å…¶å®é™…çš„ç±»å‹è°ƒç”¨å…¶ç›¸åº”çš„æ–¹æ³•ã€‚ æŠ½è±¡:è¡¨ç¤ºå¯¹é—®é¢˜é¢†åŸŸè¿›è¡Œåˆ†æã€è®¾è®¡ä¸­å¾—å‡ºçš„æŠ½è±¡çš„æ¦‚å¿µï¼Œæ˜¯å¯¹ä¸€ç³»åˆ—çœ‹ä¸Šå»ä¸åŒï¼Œä½†æ˜¯æœ¬è´¨ä¸Šç›¸åŒçš„å…·ä½“æ¦‚å¿µçš„æŠ½è±¡ã€‚åœ¨ Java ä¸­æŠ½è±¡ç”¨ abstract å…³é”®å­—æ¥ä¿®é¥°ï¼Œç”¨abstractä¿®é¥°ç±»æ—¶ï¼Œæ­¤ç±»å°±ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼ŒæŠ½è±¡ç±»(æ¥å£)å°±æ˜¯ä¸ºäº†ç»§æ‰¿è€Œå­˜åœ¨çš„ã€‚ å¸¸è§çš„RuntimeException java.lang.NullPointerException ç©ºæŒ‡é’ˆå¼‚å¸¸;å‡ºç°åŸå› :è°ƒç”¨äº†æœªç»åˆå§‹åŒ–çš„å¯¹è±¡æˆ–è€…æ˜¯ä¸å­˜åœ¨ çš„å¯¹è±¡ã€‚ java.lang.ClassNotFoundException æŒ‡å®šçš„ç±»æ‰¾ä¸åˆ°;å‡ºç°åŸå› :ç±»çš„åç§°å’Œè·¯å¾„åŠ è½½é”™è¯¯;é€šå¸¸ éƒ½æ˜¯ç¨‹åºè¯•å›¾é€šè¿‡å­—ç¬¦ä¸²æ¥åŠ è½½æŸä¸ªç±»æ—¶å¯èƒ½å¼•å‘å¼‚å¸¸ã€‚ java.lang.NumberFormatException å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—å¼‚å¸¸;å‡ºç°åŸå› :å­—ç¬¦å‹æ•°æ®ä¸­åŒ…å«éæ•° å­—å‹å­—ç¬¦ã€‚ java.lang.IndexOutOfBoundsException æ•°ç»„è§’æ ‡è¶Šç•Œå¼‚å¸¸ï¼Œå¸¸è§äºæ“ä½œæ•°ç»„å¯¹è±¡æ—¶å‘ç”Ÿã€‚ java.lang.IllegalArgumentException æ–¹æ³•ä¼ é€’å‚æ•°é”™è¯¯ã€‚ java.lang.ClassCastException æ•°æ®ç±»å‹è½¬æ¢å¼‚å¸¸ã€‚ java.lang.NoClassDefFoundException æœªæ‰¾åˆ°ç±»å®šä¹‰é”™è¯¯ã€‚ SQLException SQL å¼‚å¸¸ï¼Œå¸¸è§äºæ“ä½œæ•°æ®åº“æ—¶çš„ SQL è¯­å¥é”™è¯¯ã€‚ java.lang.InstantiationExceptionå®ä¾‹åŒ–å¼‚å¸¸ã€‚ java.lang.NoSuchMethodExceptionæ–¹æ³•ä¸å­˜åœ¨å¼‚å¸¸ã€‚ å¸¸è§çš„å¼•ç”¨ç±»å‹javaçš„å¼•ç”¨ç±»å‹ä¸€èˆ¬åˆ†ä¸ºå››ç§ï¼šå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨ å¼ºå¼•ç”¨ï¼šæ™®é€šçš„å˜é‡å¼•ç”¨ è½¯å¼•ç”¨ï¼šå°†å¯¹è±¡ç”¨SoftReferenceè½¯å¼•ç”¨ç±»å‹çš„å¯¹è±¡åŒ…è£¹ï¼Œæ­£å¸¸æƒ…å†µä¸ä¼šè¢«å›æ”¶ï¼Œä½†æ˜¯GCåšå®Œåå‘ç°é‡Šæ”¾ä¸å‡ºç©ºé—´å­˜æ”¾æ–°çš„å¯¹è±¡ï¼Œåˆ™ä¼šæŠŠè¿™äº›è½¯å¼•ç”¨çš„å¯¹è±¡å›æ”¶æ‰ã€‚è½¯å¼•ç”¨å¯ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜ã€‚ å¼±å¼•ç”¨ï¼šå°†å¯¹è±¡ç”¨WeakReferenceè½¯å¼•ç”¨ç±»å‹çš„å¯¹è±¡åŒ…è£¹ï¼Œå¼±å¼•ç”¨è·Ÿæ²¡å¼•ç”¨å·®ä¸å¤šï¼ŒGCä¼šç›´æ¥å›æ”¶æ‰ï¼Œå¾ˆå°‘ç”¨ è™šå¼•ç”¨ï¼šè™šå¼•ç”¨ä¹Ÿç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ï¼Œå‡ ä¹ä¸ç”¨ äºŒã€JVM1.jvmåŸºç¡€1.1jvmå†…å­˜æ¨¡å‹ å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ ç±»åŠ è½½æ£€æŸ¥ï¼šè™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆå°†å»æ£€æŸ¥è¿™ä¸ªç±»æ˜¯å¦å·²è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£å¿…é¡»å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹ï¼šç±»åŠ è½½è¿‡ç¨‹ä¸­ä¼šé€šè¿‡jvmè‡ªå¸¦çš„ä¸‰ä¸ªç±»åŠ è½½å™¨æŒ‰ç…§åŒäº²å§”æ´¾æœºåˆ¶è¿›è¡Œç±»åŠ è½½è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¸¸è§çš„ClassNotFoundExceptionå°±æ˜¯åœ¨è¿™é‡Œå‘ç”Ÿçš„ï¼Œæˆ‘ä»¬ä»£ç ä¸­çš„é™æ€ä»£ç å—é‡Œé¢çš„å†…å®¹ä¹Ÿæ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰§è¡Œçš„ã€‚ åˆ†é…å†…å­˜ï¼šåœ¨ç±»åŠ è½½æ£€æŸ¥é€šè¿‡åï¼Œè™šæ‹Ÿæœºå°†ä¸ºæ–°ç”Ÿå¯¹è±¡åˆ†é…å†…å­˜ã€‚å¯¹è±¡æ‰€éœ€å†…å­˜çš„å¤§å°åœ¨ç±»åŠ è½½å®Œæˆåä¾¿å¯å®Œå…¨ç¡®å®šï¼Œä¸ºå¯¹è±¡åˆ†é…ç©ºé—´çš„ä»»åŠ¡ç­‰åŒäºæŠŠ ä¸€å—ç¡®å®šå¤§å°çš„å†…å­˜ä»Javaå †ä¸­åˆ’åˆ†å‡ºæ¥ã€‚ åˆå§‹åŒ–é›¶å€¼ï¼šå†…å­˜åˆ†é…å®Œæˆåï¼Œè™šæ‹Ÿæœºéœ€è¦å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰ï¼Œè¿™ä¸€æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨Javaä»£ç ä¸­å¯ä»¥ä¸èµ‹åˆå§‹å€¼å°±ç›´æ¥ä½¿ç”¨ï¼Œç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼ã€‚ è®¾ç½®å¯¹è±¡å¤´ï¼šåˆå§‹åŒ–é›¶å€¼ä¹‹åï¼Œè™šæ‹Ÿæœºè¦å¯¹å¯¹è±¡è¿›è¡Œå¿…è¦çš„è®¾ç½®ï¼Œä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯(å³å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹)ã€å¯¹è±¡çš„å“ˆå¸Œç ï¼ˆHashCodeï¼‰ã€å¯¹è±¡çš„GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡çš„å¯¹è±¡å¤´Object Headerä¹‹ä¸­ã€‚ æ‰§è¡Œæ–¹æ³•ï¼šæ‰§è¡Œæ–¹æ³•ï¼Œå³å¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ã€‚å¯¹åº”åˆ°è¯­è¨€å±‚é¢ä¸Šè®²ï¼Œå°±æ˜¯ä¸ºå±æ€§èµ‹å€¼ï¼ˆæ³¨æ„ï¼Œè¿™ä¸ä¸Šé¢çš„èµ‹é›¶å€¼ä¸åŒï¼Œè¿™æ˜¯ç”±ç¨‹åºå‘˜èµ‹çš„å€¼ï¼‰ï¼Œå’Œæ‰§è¡Œæ„é€ æ–¹æ³•ã€‚ åƒåœ¾å›æ”¶ç®—æ³• å¼•ç”¨è®¡æ•°æ³• å¯è¾¾æ€§åˆ†ææ³• å¯¹äºå¯è¾¾æ€§åˆ†ææ³•ï¼Œæˆ‘ä»¬çŸ¥é“éœ€è¦å­˜åœ¨ä¸€ä¸ªGC Rootçš„å¯¹è±¡ä½œä¸ºèµ·ç‚¹ï¼Œä»è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼ˆå°±æ˜¯ä»GC Rootsåˆ°å¯¹è±¡ä¸å¯è¾¾ï¼‰æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚ GC Rootæœ‰å“ªäº›ï¼Ÿ è™šæ‹Ÿæœºæ ˆä¸­çš„å¼•ç”¨å¯¹è±¡ æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨å¯¹è±¡ æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIå¼•ç”¨å¯¹è±¡ åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›ï¼Ÿ Serialæ”¶é›†å™¨(-XX:+UseSerialGC -XX:+UseSerialOldGC)ï¼šSerialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨ï¼Œæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚ Parallel Scavengeæ”¶é›†å™¨(-XX:+UseParallelGC(å¹´è½»ä»£),-XX:+UseParallelOldGC(è€å¹´ä»£)) ï¼šParallelæ”¶é›†å™¨å…¶å®å°±æ˜¯Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œé™¤äº†ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å¤–ï¼Œå…¶ä½™è¡Œä¸ºï¼ˆæ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€å›æ”¶ç­–ç•¥ç­‰ç­‰ï¼‰å’ŒSerialæ”¶é›†å™¨ç±»ä¼¼ã€‚é»˜è®¤çš„æ”¶é›†çº¿ç¨‹æ•°è·Ÿcpuæ ¸æ•°ç›¸åŒ ParNewæ”¶é›†å™¨(-XX:+UseParNewGC)ï¼šåªæœ‰å®ƒèƒ½ä¸CMSæ”¶é›†å™¨ï¼ˆçœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œåé¢ä¼šä»‹ç»åˆ°ï¼‰é…åˆå·¥ä½œ CMSæ”¶é›†å™¨(-XX:+UseConcMarkSweepGC(old))ï¼šæ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨CMSæ”¶é›†å™¨æ˜¯ä¸€ç§ â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•å®ç°çš„ã€‚CMSç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰ã€‚æ‰€è°“ååé‡å°±æ˜¯CPUä¸­ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸CPUæ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ã€‚ G1æ”¶é›†å™¨(-XX:+UseG1GC)ï¼šG1 (Garbage-First)æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡å™¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸»è¦é’ˆå¯¹é…å¤‡å¤šé¢—å¤„ç†å™¨åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨. ä»¥æé«˜æ¦‚ç‡æ»¡è¶³GCåœé¡¿æ—¶é—´è¦æ±‚çš„åŒæ—¶,è¿˜å…·å¤‡é«˜ååé‡æ€§èƒ½ç‰¹å¾ã€‚G1å°†Javaå †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ï¼ŒJVMæœ€å¤šå¯ä»¥æœ‰2048ä¸ªRegionã€‚ä¸€èˆ¬Regionå¤§å°ç­‰äºå †å¤§å°é™¤ä»¥2048ï¼Œæ¯”å¦‚å †å¤§å°ä¸º4096Mï¼Œåˆ™Regionå¤§å°ä¸º2M Shenandoahï¼šå¯ä»¥çœ‹æˆæ˜¯G1å‡çº§ç‰ˆ ZGCæ”¶é›†å™¨ï¼šZGCæ˜¯ä¸€æ¬¾JDK 11ä¸­æ–°åŠ å…¥çš„å…·æœ‰å®éªŒæ€§è´¨çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ã€‚1ã€æ”¯æŒTBé‡çº§çš„å †ï¼›2ã€æœ€å¤§GCåœé¡¿æ—¶é—´ä¸è¶…10msï¼›3ã€å¥ å®šæœªæ¥GCç‰¹æ€§çš„åŸºç¡€ï¼›4ã€æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ååé‡ä¼šé™ä½15% CMSè¿è¡Œè¿‡ç¨‹ï¼Œç¼ºç‚¹ï¼Ÿæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ åˆå§‹æ ‡è®°(STW)ï¼š æš‚åœæ‰€æœ‰çš„å…¶ä»–çº¿ç¨‹(STW)ï¼Œå¹¶è®°å½•ä¸‹gc rootsç›´æ¥èƒ½å¼•ç”¨çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿« å¹¶å‘æ ‡è®°ï¼š å¹¶å‘æ ‡è®°é˜¶æ®µå°±æ˜¯ä»GC Rootsçš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼Œ è¿™ä¸ªè¿‡ç¨‹è€—æ—¶è¾ƒé•¿ä½†æ˜¯ä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œå› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œï¼Œå¯èƒ½ä¼šæœ‰å¯¼è‡´å·²ç»æ ‡è®°è¿‡çš„å¯¹è±¡çŠ¶æ€å‘ç”Ÿæ”¹å˜ã€‚ é‡æ–°æ ‡è®°(STW)ï¼š é‡æ–°æ ‡è®°é˜¶æ®µå°±æ˜¯ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´ä¸€èˆ¬ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µçš„æ—¶é—´ç¨é•¿ï¼Œè¿œè¿œæ¯”å¹¶å‘æ ‡è®°é˜¶æ®µæ—¶é—´çŸ­ã€‚ å¹¶å‘æ¸…ç†ï¼š å¼€å¯ç”¨æˆ·çº¿ç¨‹ï¼ŒåŒæ—¶GCçº¿ç¨‹å¼€å§‹å¯¹æœªæ ‡è®°çš„åŒºåŸŸåšæ¸…æ‰«ã€‚ å¹¶å‘é‡ç½®ï¼šé‡ç½®æœ¬æ¬¡GCè¿‡ç¨‹ä¸­çš„æ ‡è®°æ•°æ®ã€‚ ç¼ºç‚¹ï¼š å¯¹CPUèµ„æºæ•æ„Ÿï¼ˆä¼šå’ŒæœåŠ¡æŠ¢èµ„æºï¼‰ æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾(åœ¨å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…ç†é˜¶æ®µåˆäº§ç”Ÿåƒåœ¾ï¼Œè¿™ç§æµ®åŠ¨åƒåœ¾åªèƒ½ç­‰åˆ°ä¸‹ä¸€æ¬¡gcå†æ¸…ç†äº†)ï¼› å®ƒä½¿ç”¨çš„å›æ”¶ç®—æ³•-â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¼šå¯¼è‡´æ”¶é›†ç»“æŸæ—¶ä¼šæœ‰å¤§é‡ç©ºé—´ç¢ç‰‡äº§ç”Ÿï¼Œå½“ç„¶é€šè¿‡å‚æ•°-XX:+UseCMSCompactAtFullCollectionå¯ä»¥è®©jvmåœ¨æ‰§è¡Œå®Œæ ‡è®°æ¸…é™¤åå†åšæ•´ç† å¹¶å‘æ¨¡å¼å¤±è´¥(æœ€å¤§é—®é¢˜)ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸ç¡®å®šæ€§ï¼Œä¼šå­˜åœ¨ä¸Šä¸€æ¬¡åƒåœ¾å›æ”¶è¿˜æ²¡æ‰§è¡Œå®Œï¼Œç„¶ååƒåœ¾å›æ”¶åˆè¢«è§¦å‘çš„æƒ…å†µï¼Œç‰¹åˆ«æ˜¯åœ¨å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…ç†é˜¶æ®µä¼šå‡ºç°ï¼Œä¸€è¾¹å›æ”¶ï¼Œç³»ç»Ÿä¸€è¾¹è¿è¡Œï¼Œä¹Ÿè®¸æ²¡å›æ”¶å®Œå°±å†æ¬¡è§¦å‘full gcï¼Œä¹Ÿå°±æ˜¯â€concurrent mode failureâ€ï¼Œæ­¤æ—¶ä¼šè¿›å…¥stop the worldï¼Œç”¨serial oldåƒåœ¾æ”¶é›†å™¨æ¥å›æ”¶ G1è¿è¡Œè¿‡ç¨‹G1æ”¶é›†å™¨ä¸€æ¬¡GCçš„è¿ä½œè¿‡ç¨‹å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š åˆå§‹æ ‡è®°ï¼ˆinitial markï¼ŒSTWï¼‰ï¼šæš‚åœæ‰€æœ‰çš„å…¶ä»–çº¿ç¨‹ï¼Œå¹¶è®°å½•ä¸‹gc rootsç›´æ¥èƒ½å¼•ç”¨çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿« ï¼› å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰ï¼šåŒCMSçš„å¹¶å‘æ ‡è®° æœ€ç»ˆæ ‡è®°ï¼ˆRemarkï¼ŒSTWï¼‰ï¼šåŒCMSçš„é‡æ–°æ ‡è®° ç­›é€‰å›æ”¶ï¼ˆCleanupï¼ŒSTWï¼‰ï¼šG1é‡‡ç”¨å¤åˆ¶ç®—æ³•å›æ”¶å‡ ä¹ä¸ä¼šæœ‰å¤ªå¤šå†…å­˜ç¢ç‰‡ G1é€‚åˆä»€ä¹ˆåœºæ™¯ 50%ä»¥ä¸Šçš„å †è¢«å­˜æ´»å¯¹è±¡å ç”¨ å¯¹è±¡åˆ†é…å’Œæ™‹å‡çš„é€Ÿåº¦å˜åŒ–éå¸¸å¤§ åƒåœ¾å›æ”¶æ—¶é—´ç‰¹åˆ«é•¿ï¼Œè¶…è¿‡1ç§’ 8GBä»¥ä¸Šçš„å †å†…å­˜(å»ºè®®å€¼) åœé¡¿æ—¶é—´æ˜¯500msä»¥å†… åˆ¤æ–­å…ƒç©ºé—´æ˜¯æ— ç”¨çš„ç±»æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰ä¸»è¦å›æ”¶çš„æ˜¯æ— ç”¨çš„ç±»ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»å‘¢ï¼Ÿç±»éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢3ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯ â€œæ— ç”¨çš„ç±»â€ ï¼š è¯¥ç±»æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚ åŠ è½½è¯¥ç±»çš„ ClassLoader å·²ç»è¢«å›æ”¶ã€‚ï¼ˆæ¡ä»¶è‹›åˆ»ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¼šè¢«å›æ”¶æ‰ï¼‰ è¯¥ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚ å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸå®‰å…¨ç‚¹ï¼šå°±æ˜¯æŒ‡ä»£ç ä¸­ä¸€äº›ç‰¹å®šçš„ä½ç½®,å½“çº¿ç¨‹è¿è¡Œåˆ°è¿™äº›ä½ç½®æ—¶å®ƒçš„çŠ¶æ€æ˜¯ç¡®å®šçš„,è¿™æ ·JVMå°±å¯ä»¥å®‰å…¨çš„è¿›è¡Œä¸€äº›æ“ä½œ,æ¯”å¦‚GCç­‰ï¼Œæ‰€ä»¥GCä¸æ˜¯æƒ³ä»€ä¹ˆæ—¶å€™åšå°±ç«‹å³è§¦å‘çš„ï¼Œæ˜¯éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹è¿è¡Œåˆ°å®‰å…¨ç‚¹åæ‰èƒ½è§¦å‘ã€‚è¿™äº›ç‰¹å®šçš„å®‰å…¨ç‚¹ä½ç½®ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§: æ–¹æ³•è¿”å›ä¹‹å‰ è°ƒç”¨æŸä¸ªæ–¹æ³•ä¹‹å æŠ›å‡ºå¼‚å¸¸çš„ä½ç½® å¾ªç¯çš„æœ«å°¾ å®‰å…¨åŒºåŸŸï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹å¤„äº Sleep æˆ–ä¸­æ–­çŠ¶æ€ï¼Œå®ƒå°±ä¸èƒ½å“åº” JVM çš„ä¸­æ–­è¯·æ±‚ï¼Œå¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚åœ¨è¿™ä¸ªåŒºåŸŸå†…çš„ä»»æ„åœ°æ–¹å¼€å§‹ GC éƒ½æ˜¯å®‰å…¨çš„ã€‚ ç±»åŠ è½½å™¨ï¼ŸåŒäº²å§”æ´¾ï¼Œå¥½å¤„ï¼ŸJDKè‡ªå¸¦æœ‰ä¸‰ä¸ªç±»åŠ è½½å™¨ï¼šbootstrapClassLoader(å¼•å¯¼ç±»åŠ è½½å™¨)ã€ExtClassLoader(æ‰©å±•ç±»åŠ è½½å™¨)ã€AppClassLoader(ç³»ç»Ÿç±»åŠ è½½å™¨)ï¼ŒbootstrapClassLoaderæ˜¯ExtClassLoaderçš„çˆ¶ç±»åŠ è½½å™¨(å¹¶ä¸æ˜¯é›†æˆå…³ç³»ï¼Œæ˜¯å±æ€§å…³ç³»)é»˜è®¤åŠ è½½%JAVA_HOME%/libä¸‹çš„jaråŒ…å’Œclassæ–‡ä»¶ExtClassLoaderæ˜¯AppClassLoaderçš„çˆ¶ç±»åŠ è½½å™¨ï¼Œé»˜è®¤åŠ è½½%JAVA_HOME%/lib/extæ–‡ä»¶å¤¹ä¸‹çš„jaråŒ…å’Œclassæ–‡ä»¶AppClassLoaderæ˜¯è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½classpathä¸‹çš„ç±»æ–‡ä»¶ åŒäº²å§”æ´¾ï¼šåˆ†ä¸ºå‘ä¸Šå§”æ´¾å’Œå‘ä¸‹æŸ¥æ‰¾ï¼Œæ¯ä¸€ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰å„è‡ªçš„ç¼“å­˜ï¼Œéƒ½ä¼šè®°å½•è‡ªå·±åŠ è½½è¿‡çš„ç±»ï¼Œå½“ä¸€ä¸ªç±»éœ€è¦åŠ è½½ï¼ŒAppClassLoaderå…ˆæŸ¥æ‰¾è‡ªå·±çš„ç¼“å­˜æœ‰æ²¡æœ‰åŠ è½½è¿‡è¿™ä¸ªç±»ï¼Œæ²¡æœ‰åŠ è½½è¿‡å°±ä¼šè°ƒç”¨ExtClassLoaderå»æŸ¥æ‰¾ï¼ŒExtClassLoaderæ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±ä¼šè°ƒç”¨bootstrapClassLoaderç±»å»åŠ è½½ï¼Œå¦‚æœbootstrapClassLoaderæ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±ä¼šå»ä»–çš„ç±»åŠ è½½è·¯å¾„æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ExtClassLoaderå°±ä¼šæŸ¥æ‰¾ä»–çš„ç±»åŠ è½½è·¯å¾„ï¼Œå‘ä¸Šå§”æ´¾å°±æ˜¯æŸ¥æ‰¾ç¼“å­˜ï¼ŒæŸ¥æ‰¾åˆ°bootstrapClassLoaderä½ç½®ï¼Œå‘ä¸‹æŸ¥æ‰¾å°±æ˜¯æŸ¥æ‰¾ç±»åŠ è½½è·¯å¾„ï¼ŒæŸ¥æ‰¾åˆ°å‘èµ·çš„ç±»åŠ è½½å™¨ä¸ºæ­¢ã€‚ å¥½å¤„ï¼š1ã€å®‰å…¨æ€§ï¼Œé¿å…è‡ªå·±å†™çš„ç±»æ›¿æ¢æ‰javaæ ¸å¿ƒç±»ï¼›2ã€é¿å…ç±»é‡å¤åŠ è½½ï¼Œç›¸åŒclassæ–‡ä»¶ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½çš„ä¹Ÿæ˜¯ä¸¤ä¸ªç±»ã€‚ YGCå’ŒFGCå‘ç”Ÿçš„åœºæ™¯YGCï¼šå¯¹æ–°ç”Ÿä»£å †è¿›è¡Œgcã€‚é¢‘ç‡æ¯”è¾ƒé«˜ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å¯¹è±¡çš„å­˜æ´»å¯¿å‘½è¾ƒçŸ­ï¼Œåœ¨æ–°ç”Ÿä»£é‡Œè¢«å›æ”¶ã€‚æ€§èƒ½è€—è´¹è¾ƒå°ã€‚ednç©ºé—´ä¸è¶³,æ‰§è¡Œ FGCï¼šå…¨å †èŒƒå›´çš„gcã€‚é»˜è®¤å †ç©ºé—´ä½¿ç”¨åˆ°è¾¾80%(å¯è°ƒæ•´)çš„æ—¶å€™ä¼šè§¦å‘fgcã€‚ç”Ÿäº§ç¯å¢ƒï¼Œä¸€èˆ¬æ¯”è¾ƒå°‘ä¼šè§¦å‘fgcï¼Œæœ‰æ—¶10å¤©æˆ–ä¸€å‘¨å·¦å³ä¼šæœ‰ä¸€æ¬¡ã€‚ è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼Œæ°¸ä¹…åŒºç©ºé—´ä¸è¶³ï¼Œè°ƒç”¨æ–¹æ³•System.gc() ï¼Œygcæ—¶çš„æ‚²è§‚ç­–ç•¥, dump liveçš„å†…å­˜ä¿¡æ¯æ—¶(jmap â€“dump:live)ï¼Œéƒ½ä¼šæ‰§è¡Œfull gc jstackï¼Œjmapï¼ŒJstatä½œç”¨jmapï¼šå¯ä»¥ç”¨æ¥æŸ¥çœ‹å†…å­˜ä¿¡æ¯ï¼Œå®ä¾‹ä¸ªæ•°ä»¥åŠå ç”¨å†…å­˜å¤§å° jmap -heap è¿›ç¨‹å·ï¼šæŸ¥çœ‹å †å†…å­˜ä¿¡æ¯ jmap â€dump:format=b,file=eureka.hprof è¿›ç¨‹å·ï¼š å †å†…å­˜çš„å¿«ç…§ä¿¡æ¯ï¼Œæ·»åŠ jvmå‚æ•°ä¹Ÿå¯ä»¥è®¾ç½®å†…å­˜æº¢å‡ºè‡ªåŠ¨å¯¼å‡ºdumpæ–‡ä»¶ jstack: å¯ä»¥è·å¾—javaçº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼Œå¯ä»¥æŸ¥çœ‹æ­»é”ï¼Œé˜»å¡ï¼Œç­‰å¾… Jstack -l PID &gt;&gt; 123.txt æ‰“å°æŸä¸ªjavaè¿›ç¨‹çš„å †æ ˆä¿¡æ¯ Jstatï¼šjstatå‘½ä»¤å¯ä»¥æŸ¥çœ‹å †å†…å­˜å„éƒ¨åˆ†çš„ä½¿ç”¨é‡ï¼Œä»¥åŠåŠ è½½ç±»çš„æ•°é‡ jstat -gc pid æœ€å¸¸ç”¨ï¼Œå¯ä»¥è¯„ä¼°ç¨‹åºå†…å­˜ä½¿ç”¨åŠGCå‹åŠ›æ•´ä½“æƒ…å†µ ä¸‰ã€Mysqlæ•°æ®åº“1.ç´¢å¼•åº•å±‚ç»“æ„&amp;è¡Œæ ¼å¼&amp;é¡µæ ¼å¼è¡Œé¡µç´¢å¼•åº•å±‚ç»“æ„ 2.ä¸€æ¡ SQL çš„æ‰§è¡Œè¿‡ç¨‹è¯¦è§£https://www.pdai.tech/md/db/sql-mysql/sql-mysql-execute.html 3.acidåŠå®ç°åŸç†4.MVCChttps://www.pdai.tech/md/db/sql-mysql/sql-mysql-mvcc.html 5.mysqlä¸‰å¤§æ—¥å¿—6.redoæ—¥å¿—7.undoæ—¥å¿—8.èƒ½è¯´ä¸‹myisam å’Œ innodbçš„åŒºåˆ«å—myisamå¼•æ“æ˜¯5.1ç‰ˆæœ¬ä¹‹å‰çš„é»˜è®¤å¼•æ“ï¼Œæ”¯æŒå…¨æ–‡æ£€ç´¢ã€å‹ç¼©ã€ç©ºé—´å‡½æ•°ç­‰ï¼Œä½†æ˜¯ä¸æ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨äºæœ‰å¤§é‡æŸ¥è¯¢å°‘é‡æ’å…¥çš„åœºæ™¯æ¥ä½¿ç”¨ï¼Œè€Œä¸”myisamä¸æ”¯æŒå¤–é”®ï¼Œå¹¶ä¸”ç´¢å¼•å’Œæ•°æ®æ˜¯åˆ†å¼€å­˜å‚¨çš„ã€‚ innodbæ˜¯åŸºäºèšç°‡ç´¢å¼•å»ºç«‹çš„ï¼Œå’Œmyisamç›¸åå®ƒæ”¯æŒäº‹åŠ¡ã€å¤–é”®ï¼Œå¹¶ä¸”é€šè¿‡MVCCæ¥æ”¯æŒé«˜å¹¶å‘ï¼Œç´¢å¼•å’Œæ•°æ®å­˜å‚¨åœ¨ä¸€èµ·ã€‚ 9.è¯´ä¸‹mysqlçš„ç´¢å¼•æœ‰å“ªäº›å§ï¼Œèšç°‡å’Œéèšç°‡ç´¢å¼•åˆæ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«èšç°‡ç´¢å¼•ï¼šå°†æ•°æ®å­˜å‚¨ä¸ç´¢å¼•æ”¾åˆ°äº†ä¸€å—ï¼Œæ‰¾åˆ°ç´¢å¼•ä¹Ÿå°±æ‰¾åˆ°äº†æ•°æ®éèšç°‡ç´¢å¼•ï¼šå°†æ•°æ®å­˜å‚¨äºç´¢å¼•åˆ†å¼€ç»“æ„ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹æŒ‡å‘äº†æ•°æ®çš„å¯¹åº”è¡Œï¼Œmyisamé€šè¿‡key_bufferæŠŠç´¢å¼•å…ˆç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå½“éœ€è¦è®¿é—®æ•°æ®æ—¶ï¼ˆé€šè¿‡ç´¢å¼•è®¿é—®æ•°æ®ï¼‰ï¼Œåœ¨å†…å­˜ä¸­ç›´æ¥æœç´¢ç´¢å¼•ï¼Œç„¶åé€šè¿‡ç´¢å¼•æ‰¾åˆ°ç£ç›˜ç›¸åº”æ•°æ®ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç´¢å¼•ä¸åœ¨key bufferå‘½ä¸­æ—¶ï¼Œé€Ÿåº¦æ…¢çš„åŸå›  10.ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•å’Œå›è¡¨è¦†ç›–ç´¢å¼•æŒ‡çš„æ˜¯åœ¨ä¸€æ¬¡æŸ¥è¯¢ä¸­ï¼Œå¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«æˆ–è€…è¯´è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œæˆ‘ä»¬å°±ç§°ä¹‹ä¸ºè¦†ç›–ç´¢å¼•ï¼Œè€Œä¸å†éœ€è¦å›è¡¨æŸ¥è¯¢ã€‚ å›è¡¨ï¼Ÿï¼Ÿ 11.mysqlçš„å„ç§é”ã€‚ é—´éš™é”12.mysqlä¸»ä»åŒæ­¥æ€ä¹ˆåšçš„13.åˆ†åº“åˆ†è¡¨14.åˆ†å¸ƒå¼å”¯ä¸€id15.æ•°æ®åº“ä¸‰å¤§èŒƒå¼æ˜¯ä»€ä¹ˆç¬¬ä¸€èŒƒå¼ï¼šæ¯ä¸ªåˆ—éƒ½ä¸å¯ä»¥å†æ‹†åˆ†ã€‚ ç¬¬äºŒèŒƒå¼ï¼šåœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œéä¸»é”®åˆ—å®Œå…¨ä¾èµ–äºä¸»é”®ï¼Œè€Œä¸èƒ½æ˜¯ä¾èµ–äºä¸»é”®çš„ä¸€éƒ¨åˆ†ã€‚ ç¬¬ä¸‰èŒƒå¼ï¼šåœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œéä¸»é”®åˆ—åªä¾èµ–äºä¸»é”®ï¼Œä¸ä¾èµ–äºå…¶ä»–éä¸»é”®ã€‚ åœ¨è®¾è®¡æ•°æ®åº“ç»“æ„çš„æ—¶å€™ï¼Œè¦å°½é‡éµå®ˆä¸‰èŒƒå¼ï¼Œå¦‚æœä¸éµå®ˆï¼Œå¿…é¡»æœ‰è¶³å¤Ÿçš„ç†ç”±ã€‚æ¯”å¦‚æ€§èƒ½ã€‚äº‹å®ä¸Šæˆ‘ä»¬ç»å¸¸ä¼šä¸ºäº†æ€§èƒ½è€Œå¦¥åæ•°æ®åº“çš„è®¾è®¡ã€‚ 16.InnoDBå¼•æ“çš„4å¤§ç‰¹æ€§æ’å…¥ç¼“å†²ï¼ˆinsert buffer) äºŒæ¬¡å†™(double write) è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•(ahi) é¢„è¯»(read ahead) 17.ç´¢å¼•å¤±æ•ˆçš„æƒ…å†µè°ˆåˆ°ç´¢å¼•ä¸»è¦ä»ä¸¤æ–¹é¢æ¥åˆ†æï¼šIO å’Œæ•°æ®ç»“æ„ï¼šä¸ç®¡ç´¢å¼•æ•°æ®è¿˜æ˜¯è¡Œæ•°æ®ï¼Œéƒ½æ˜¯å­˜åœ¨ç£ç›˜é‡Œé¢çš„ï¼Œæˆ‘ä»¬å°½å¯èƒ½å°‘çš„å–å‡ºæ•°æ® IOâ€”â€“&gt;è¯»å–æ¬¡æ•°å°‘ã€é‡å°‘â€”â€”&gt;åˆ†å—è¯»å–â€”â€”&gt;å±€éƒ¨æ€§åŸç†ã€ç£ç›˜é¢„è¯» æ•°æ®ç»“æ„â€”â€”&gt;B+æ ‘â€”â€”&gt;äºŒå‰æ ‘ã€AVLæ ‘ã€çº¢é»‘æ ‘ã€Bæ ‘ ç»„åˆç´¢å¼•ä¸éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™ ç»„åˆç´¢å¼•å‰é¢ç´¢å¼•åˆ—ä½¿ç”¨èŒƒå›´æŸ¥è¯¢(&lt;,&gt;,like),ä¼šå¯¼è‡´åç»­ç´¢å¼•å¤±æ•ˆï¼› ä¸è¦åœ¨ç´¢å¼•ä¸Šåšä»»ä½•æ“ä½œï¼ˆè®¡ç®—ï¼Œå‡½æ•°ï¼Œç±»å‹è½¬æ¢ï¼‰ is nullå’Œis not null æ— æ³•ä½¿ç”¨ç´¢å¼• å°½é‡å°‘ä½¿ç”¨oræ“ä½œç¬¦ï¼Œå¦åˆ™è¿æ¥æ—¶ç´¢å¼•ä¼šå¤±æ•ˆ å­—ç¬¦ä¸²ä¸æ·»åŠ å¼•å·ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼ˆéšå¼ç±»å‹è½¬æ¢ï¼‰ ä¸¤è¡¨å…³è”ä½¿ç”¨çš„æ¡ä»¶å­—æ®µä¸­å­—æ®µçš„é•¿åº¦ï¼Œç¼–ç ä¸ä¸€è‡´ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ likeè¯­å¥ä¸­ï¼Œä»¥%å¼€å¤´çš„æ¨¡ç³ŠæŸ¥è¯¢ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ å¦‚æœmysqlä¸­ä½¿ç”¨å…¨è¡¨æ‰«ææ¯”ç´¢å¼•å¿«ï¼Œä¹Ÿä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ ï¼ˆforce index:å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼‰ 18.æœ€å·¦å‰ç¼€åŸåˆ™ã€‚ è”åˆç´¢å¼•ä½¿ç”¨åˆ†æå®æˆ˜é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æœ€å·¦ä¼˜å…ˆï¼Œåœ¨åˆ›å»ºå¤šåˆ—ç´¢å¼•æ—¶ï¼Œè¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œwhereå­å¥ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„ä¸€åˆ—æ”¾åœ¨æœ€å·¦è¾¹ã€‚æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œéå¸¸é‡è¦çš„åŸåˆ™ï¼Œmysqlä¼šä¸€ç›´å‘å³åŒ¹é…ç›´åˆ°é‡åˆ°èŒƒå›´æŸ¥è¯¢(&gt;ã€&lt;ã€betweenã€like)å°±åœæ­¢åŒ¹é…ï¼Œæ¯”å¦‚a = 1 and b = 2 and c &gt; 3 and d = 4 å¦‚æœå»ºç«‹(a,b,c,d)é¡ºåºçš„ç´¢å¼•ï¼Œdæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„ï¼Œå¦‚æœå»ºç«‹(a,b,d,c)çš„ç´¢å¼•åˆ™éƒ½å¯ä»¥ç”¨åˆ°ï¼Œa,b,dçš„é¡ºåºå¯ä»¥ä»»æ„è°ƒæ•´ã€‚=å’Œinå¯ä»¥ä¹±åºï¼Œæ¯”å¦‚a = 1 and b = 2 and c = 3 å»ºç«‹(a,b,c)ç´¢å¼•å¯ä»¥ä»»æ„é¡ºåºï¼Œmysqlçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šå¸®ä½ ä¼˜åŒ–æˆç´¢å¼•å¯ä»¥è¯†åˆ«çš„å½¢å¼ å®æˆ˜ï¼Ÿï¼Ÿ 19.sqlä¼˜åŒ–ä¹‹explain è¯¦è§£20.mysqlä¸»ä»å¤åˆ¶åŸç†21.ä¸»ä»åŒæ­¥å»¶æ—¶å¦‚ä½•è§£å†³22.éš”ç¦»çº§åˆ«23.RCå’ŒRRçš„æœ¬è´¨åŒºåˆ«ã€‚readviewå±‚é¢24.ä»€ä¹ˆæ˜¯readview25.å¿«ç…§è¯»ä¸å½“å‰è¯»çš„åŒºåˆ«26.å¹»è¯»å’Œä¸å¯é‡å¤è¯»åŒºåˆ«27.MySQLåœ¨RRçº§åˆ«ä¸­å®Œå…¨è§£å†³äº†å¹»è¯»çš„é—®é¢˜ä¹ˆï¼Ÿ28.è„é¡µæ˜¯ä»€ä¹ˆï¼Œåˆ·è„é¡µæ—¶æœº29.bufferpool30.å‡ å¤§æ ¸å¿ƒçº¿ç¨‹31.äº‹åŠ¡ä¼ æ’­æœºåˆ¶32.åˆ†å¸ƒå¼äº‹åŠ¡é€šç”¨æ–¹æ¡ˆ33.æˆæœ¬åˆ†æ34.è¡¨ä¸­æ•°æ®é‡å¦‚ä½•è®¡ç®—æ€»é‡35.count(1) count(*) count(id) count(å­—æ®µ) æ€§èƒ½å¯¹æ¯”åˆ†æ36.mysqlä¸­in å’Œexists åŒºåˆ«37.joinæŸ¥è¯¢åŸç†38.ç´¢å¼•ä¸‹æ¨39.ä¸¤ç§æ’åºæ–¹å¼1ã€MySQLæ”¯æŒä¸¤ç§æ–¹å¼çš„æ’åºfilesortå’Œindexï¼ŒUsing indexæ˜¯æŒ‡MySQLæ‰«æç´¢å¼•æœ¬èº«å®Œæˆæ’åºã€‚index æ•ˆç‡é«˜ï¼Œfilesortæ•ˆç‡ä½ã€‚ 40.filesortæ’åºåŸç†Using filesortæ–‡ä»¶æ’åºåŸç†è¯¦è§£ filesortæ–‡ä»¶æ’åºæ–¹å¼ å•è·¯æ’åºï¼šæ˜¯ä¸€æ¬¡æ€§å–å‡ºæ»¡è¶³æ¡ä»¶è¡Œçš„æ‰€æœ‰å­—æ®µï¼Œç„¶ååœ¨sort bufferä¸­è¿›è¡Œæ’åºï¼›ç”¨traceå·¥å…·å¯ ä»¥çœ‹åˆ°sort_modeä¿¡æ¯é‡Œæ˜¾ç¤º&lt; sort_key, additional_fields &gt;æˆ–è€…&lt; sort_key, packed_additional_fields &gt; åŒè·¯æ’åºï¼ˆåˆå«å›è¡¨æ’åºæ¨¡å¼ï¼‰ï¼šæ˜¯é¦–å…ˆæ ¹æ®ç›¸åº”çš„æ¡ä»¶å–å‡ºç›¸åº”çš„æ’åºå­—æ®µå’Œå¯ä»¥ç›´æ¥å®šä½è¡Œ æ•°æ®çš„è¡Œ IDï¼Œç„¶ååœ¨ sort buffer ä¸­è¿›è¡Œæ’åºï¼Œæ’åºå®Œåéœ€è¦å†æ¬¡å–å›å…¶å®ƒéœ€è¦çš„å­—æ®µï¼›ç”¨traceå·¥å…· å¯ä»¥çœ‹åˆ°sort_modeä¿¡æ¯é‡Œæ˜¾ç¤º&lt; sort_key, rowid &gt; MySQL é€šè¿‡æ¯”è¾ƒç³»ç»Ÿå˜é‡ max_length_for_sort_data(é»˜è®¤1024å­—èŠ‚) çš„å¤§å°å’Œéœ€è¦æŸ¥è¯¢çš„å­—æ®µæ€»å¤§å°æ¥ 41.filesortåˆ¤æ–­ä½¿ç”¨å“ªç§æ’åºæ¨¡å¼ã€‚ ï¼ˆå•è·¯oråŒè·¯ï¼‰å¦‚æœ å­—æ®µçš„æ€»é•¿åº¦å°äºmax_length_for_sort_data ï¼Œé‚£ä¹ˆä½¿ç”¨ å•è·¯æ’åºæ¨¡å¼ï¼› å¦‚æœ å­—æ®µçš„æ€»é•¿åº¦å¤§äºmax_length_for_sort_data ï¼Œé‚£ä¹ˆä½¿ç”¨ åŒè·¯æ’åºæ¨¡âˆ™å¼ã€‚ 40.å•è·¯æ’åºã€åŒè·¯æ’åºè¯¦ç»†è¿‡ç¨‹æˆ‘ä»¬å…ˆçœ‹å•è·¯æ’åºçš„è¯¦ç»†è¿‡ç¨‹ï¼š \\1. ä»ç´¢å¼•nameæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³ name = â€˜zhugeâ€™ æ¡ä»¶çš„ä¸»é”® id \\2. æ ¹æ®ä¸»é”® id å–å‡ºæ•´è¡Œï¼Œå–å‡ºæ‰€æœ‰å­—æ®µçš„å€¼ï¼Œå­˜å…¥ sort_buffer ä¸­ \\3. ä»ç´¢å¼•nameæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ»¡è¶³ name = â€˜zhugeâ€™ æ¡ä»¶çš„ä¸»é”® id \\4. é‡å¤æ­¥éª¤ 2ã€3 ç›´åˆ°ä¸æ»¡è¶³ name = â€˜zhugeâ€™ \\5. å¯¹ sort_buffer ä¸­çš„æ•°æ®æŒ‰ç…§å­—æ®µ position è¿›è¡Œæ’åº \\6. è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ æˆ‘ä»¬å†çœ‹ä¸‹åŒè·¯æ’åºçš„è¯¦ç»†è¿‡ç¨‹ï¼š \\1. ä»ç´¢å¼• name æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³ name = â€˜zhugeâ€™ çš„ä¸»é”®id \\2. æ ¹æ®ä¸»é”® id å–å‡ºæ•´è¡Œï¼ŒæŠŠæ’åºå­—æ®µ position å’Œä¸»é”® id è¿™ä¸¤ä¸ªå­—æ®µæ”¾åˆ° sort buffer ä¸­ \\3. ä»ç´¢å¼• name å–ä¸‹ä¸€ä¸ªæ»¡è¶³ name = â€˜zhugeâ€™ è®°å½•çš„ä¸»é”® id \\4. é‡å¤ 3ã€4 ç›´åˆ°ä¸æ»¡è¶³ name = â€˜zhugeâ€™ \\5. å¯¹ sort_buffer ä¸­çš„å­—æ®µ position å’Œä¸»é”® id æŒ‰ç…§å­—æ®µ position è¿›è¡Œæ’åº \\6. éå†æ’åºå¥½çš„ id å’Œå­—æ®µ positionï¼ŒæŒ‰ç…§ id çš„å€¼å›åˆ°åŸè¡¨ä¸­å–å‡º æ‰€æœ‰å­—æ®µçš„å€¼è¿”å›ç»™å®¢æˆ·ç«¯ å…¶å®å¯¹æ¯”ä¸¤ä¸ªæ’åºæ¨¡å¼ï¼Œå•è·¯æ’åºä¼šæŠŠæ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µéƒ½æ”¾åˆ° sort buffer ä¸­ï¼Œè€ŒåŒè·¯æ’åºåªä¼šæŠŠä¸»é”® ACIDç†è®ºâ€‹ äº‹åŠ¡å¤„ç†å‡ ä¹æ˜¯æ¯ä¸€ä¸ªä¿¡æ¯ç³»ç»Ÿä¸­éƒ½ä¼šæ¶‰åŠåˆ°çš„é—®é¢˜ï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰å°±æ˜¯ä¿è¯ç³»ç»Ÿä¸­çš„æ•°æ®æ˜¯æ­£ç¡®çš„ï¼Œä¸åŒæ•°æ®é—´ä¸ä¼šäº§ç”ŸçŸ›ç›¾ï¼Œä¹Ÿå°±æ˜¯ä¿è¯æ•°æ®çŠ¶æ€çš„ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼Œç†è®ºä¸Šï¼Œè¦è¾¾æˆè¿™ä¸ªç›®æ ‡éœ€è¦ä¸‰æ–¹é¢çš„å…±åŒåŠªåŠ›ï¼š åŸå­æ€§ï¼ˆAtomicï¼‰ï¼šåœ¨åŒä¸€é¡¹ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œäº‹åŠ¡ä¿è¯äº†å¤šä¸ªå¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·è¢«æ’¤é”€ã€‚åŸå­æ€§æ˜¯ç”±undologæ—¥å¿—æ¥ä¿è¯çš„ï¼Œå®ƒè®°å½•äº†éœ€è¦å›æ»šçš„æ—¥å¿—ä¿¡æ¯ï¼Œäº‹åŠ¡å›æ»šæ—¶ï¼Œæ’¤é”€å·²ç»æ‰§è¡ŒæˆåŠŸçš„sqlã€‚ éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šåœ¨ä¸åŒçš„ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œäº‹åŠ¡ä¿è¯äº†å„è‡ªä¸šåŠ¡æ­£åœ¨è¯»ã€å†™çš„æ•°æ®äº’ç›¸ç‹¬ç«‹ï¼Œä¸ä¼šå½¼æ­¤å½±å“ã€‚éš”ç¦»æ€§æ˜¯ç”±MVCCæ¥ä¿è¯çš„ã€‚ æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šäº‹åŠ¡åº”å½“ä¿è¯æ‰€æœ‰è¢«æˆåŠŸæäº¤çš„æ•°æ®ä¿®æ”¹éƒ½èƒ½å¤Ÿæ­£ç¡®åœ°è¢«æŒä¹…åŒ–ï¼Œä¸ä¸¢å¤±æ•°æ®ã€‚æŒä¹…æ€§ç”±redologæ¥ä¿è¯çš„ï¼Œmysqlä¿®æ”¹æ•°æ®çš„æ—¶å€™ä¼šåœ¨redologä¸­è®°å½•ä¸€ä»½æ—¥å¿—æ•°æ®ï¼Œå°±ç®—æ•°æ®æ²¡æœ‰ä¿å­˜æˆåŠŸï¼Œåªè¦æ—¥å¿—ä¿å­˜æˆåŠŸäº†ï¼Œæ•°æ®ä»ç„¶ä¸ä¼šä¸¢å¤±ã€‚ ä»¥ä¸Šå°±æ˜¯äº‹åŠ¡çš„â€œACIDâ€çš„æ¦‚å¿µææ³•ã€‚æˆ‘è‡ªå·±å¯¹è¿™ç§å·²ç»å½¢æˆä¹ æƒ¯çš„â€œACIDâ€çš„ææ³•æ˜¯ä¸å¤ªè®¤åŒçš„ï¼Œå› ä¸ºè¿™å››ç§ç‰¹æ€§å¹¶ä¸æ­£äº¤ï¼ŒAã€Iã€D æ˜¯æ‰‹æ®µï¼ŒC æ˜¯ç›®çš„ï¼Œå®Œå…¨æ˜¯ä¸ºäº†æ‹¼å‡‘ä¸ªå•è¯ç¼©å†™æ‰å¼„åˆ°ä¸€å—å»ï¼Œè¯¯å¯¼çš„å¼Šç«¯å·²ç»è¶…è¿‡äº†æ˜“äºä¼ æ’­çš„å¥½å¤„ã€‚ InnoDBå’ŒMyISAMåŒºåˆ« åŒºåˆ« InnoDB MyISAM äº‹åŠ¡ æ”¯æŒ ä¸æ”¯æŒ å¤–é”® æ”¯æŒ ä¸æ”¯æŒ ç´¢å¼• èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼• éèšç°‡ç´¢å¼• è¡Œé” æ”¯æŒ ä¸æ”¯æŒ è¡¨é” æ”¯æŒ æ”¯æŒ å­˜å‚¨æ–‡ä»¶ frm(è¡¨ç»“æ„)ï¼Œibd(æ•°æ®å’Œç´¢å¼•) frmï¼Œmyi(ç´¢å¼•æ–‡ä»¶)ï¼Œmyd(æ•°æ®æ–‡ä»¶) å…·ä½“è¡Œæ•° å…¨è¡¨æ‰«æç»Ÿè®¡è¡Œæ•° é€šè¿‡å˜é‡ä¿å­˜è¡Œæ•° MyISAMä¸æ”¯æŒäº‹åŠ¡ï¼Œåœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥SELECTå‰ï¼Œä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„æ‰€æœ‰è¡¨åŠ è¯»é”,åœ¨æ‰§è¡Œupdateã€insertã€deleteæ“ä½œä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„è¡¨åŠ å†™é”ã€‚ InnoDBåœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥SELECTæ—¶(éä¸²è¡Œéš”ç¦»çº§åˆ«)ï¼Œ(å› ä¸ºæœ‰mvccæœºåˆ¶)ä¸ä¼šåŠ é”ã€‚ä½†æ˜¯updateã€insertã€deleteæ“ä½œä¼šåŠ è¡Œé”ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯è¯»é”ä¼šé˜»å¡å†™ï¼Œä½†æ˜¯ä¸ä¼šé˜»å¡è¯»ã€‚è€Œå†™é”åˆ™ä¼šæŠŠè¯»å’Œå†™éƒ½é˜»å¡ã€‚ Bæ ‘å’ŒB+æ•°çš„åŒºåˆ«B-Tree B+Tree(B-Treeå˜ç§) B+Treeéå¶å­èŠ‚ç‚¹ä¸å­˜å‚¨dataï¼Œåªå­˜å‚¨å†—ä½™ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹åŒ…å«æ‰€æœ‰ç´¢å¼•å­—æ®µ ã€‚ä¼˜ç‚¹ï¼šå¯ä»¥æ”¾æ›´å¤šçš„ç´¢å¼•ï¼ŒBTreeéå¶å­èŠ‚ç‚¹ä¼šå­˜å‚¨ç´¢å¼•å’Œæ•°æ® B+Treeå¶å­èŠ‚ç‚¹ç”¨æŒ‡é’ˆè¿æ¥ã€‚ä¼˜ç‚¹ï¼šæé«˜åŒºé—´è®¿é—®çš„æ€§èƒ½ï¼ˆèŒƒå›´æŸ¥æ‰¾ï¼‰ï¼ŒBTreeå¶å­èŠ‚ç‚¹æŒ‡é’ˆä¸ºç©º äº‹åŠ¡éš”ç¦»çº§åˆ« äº‹åŠ¡éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» è¯»æœªæäº¤ï¼ˆread-uncomm è¯»å·²æäº¤ï¼ˆread-committedï¼‰ å¦ æ˜¯ æ˜¯ å¯é‡å¤è¯»ï¼ˆrepeatable-readï¼‰ mysqlé»˜è®¤ å¦ å¦ æ˜¯ ä¸²è¡ŒåŒ–ï¼ˆserializableï¼‰ å¦ å¦ å¦ Mysqlåœ¨å¯é‡å¤åº¦éš”ç¦»çº§åˆ«ä¸‹é€šè¿‡MVCCä¿è¯äº‹åŠ¡éš”ç¦»æ€§ å¹»è¯»æ˜¯æŒ‡å½“ä¸€ä¸ªäº‹åŠ¡Aè¯»å–æŸä¸€ä¸ªèŒƒå›´çš„æ•°æ®æ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡Båœ¨è¿™ä¸ªèŒƒå›´æ’å…¥è¡Œï¼ŒAäº‹åŠ¡å†æ¬¡è¯»å–è¿™ä¸ªèŒƒå›´æ•°æ®æ—¶ï¼Œä¼šäº§ç”Ÿå¹»è¯» Mysqlå¹»è¯»æ˜¯æ€ä¹ˆè§£å†³çš„é¦–å…ˆè¦ç¡®è®¤ä¸€ä¸‹å¹»è¯»æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ï¼Œå…ˆå¼„æ¸…ä¸¤ä¸ªæ¦‚å¿µï¼Œé‚£å°±æ˜¯å½“å‰è¯»å’Œå¿«ç…§è¯» å½“å‰è¯» åƒselect lock in share mode(å…±äº«é”)ï¼Œselect for updateï¼Œupdateï¼Œinsertï¼Œdeleteï¼ˆæ’ä»–é”ï¼‰è¿™äº›æ“ä½œéƒ½æ˜¯ä¸€ç§å½“å‰è¯»ï¼Œä¸ºä»€ä¹ˆå«å½“å‰è¯»ï¼Ÿå°±æ˜¯ä»–è¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯»å–æ—¶è¿˜è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œä¼šå¯¹è¯»å–è®°å½•è¿›è¡ŒåŠ é” å¿«ç…§è¯» â€‹ åƒä¸åŠ é”çš„selectæ“ä½œå°±æ˜¯å¿«ç…§è¯»ï¼Œä¹Ÿå°±æ˜¯ä¸åŠ é”çš„éé˜»å¡è¯»ï¼›å¿«ç…§è¯»çš„å‰ææ˜¯éš”ç¦»çº§åˆ«ä¸æ˜¯ä¸²è¡ŒåŒ–ï¼Œä¸²è¡Œçº§åˆ«çš„å¿«ç…§è¯»ä¼šé€€åŒ–æˆå½“å‰è¯»ï¼Œå¿«ç…§è¯»çš„å®ç°æ˜¯åŸºäºå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯MVCCï¼Œå¯ä»¥è®¤ä¸ºMVCCæ˜¯è¡Œé”çš„ä¸€ä¸ªå˜ç§ï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹é¿å…åŠ é”æ“ä½œï¼Œå¿«ç…§è¯»å¯èƒ½è¯»åˆ°çš„å¹¶ä¸ä¸€å®šæ˜¯æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œæœ‰å¯èƒ½æ˜¯ä¹‹å‰çš„å†å²ç‰ˆæœ¬ å¦‚æœåªæœ‰å¿«ç…§è¯»æ˜¯ä¸ä¼šäº§ç”Ÿå¹»è¯»é—®é¢˜ï¼Œåªæœ‰å¿«ç…§è¯»å’Œå½“å‰è¯»ä¸€èµ·ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šäº§ç”Ÿå¹»è¯»ã€‚ Mysqlåœ¨å¯é‡å¤åº¦éš”ç¦»çº§åˆ«ä¸‹å¯ä»¥é€šè¿‡MVCCå’Œä¸´é”®é”ï¼ˆè®°å½•é”+é—´éš™é”ï¼‰è§£å†³å¹»è¯»é—®é¢˜ã€‚ MVCCå¯¹äºmvccçš„ç†è§£ï¼Œå¯ä»¥ä»æ•°æ®åº“ä¸‰ç§å¹¶å‘åœºæ™¯æ¥è¯´ ç¬¬ä¸€ç§æ˜¯è¯»å’Œè¯»çš„å¹¶å‘ï¼šå°±æ˜¯ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBåŒæ—¶è¿›è¡Œè¯»æ“ä½œï¼Œè¿™ç§æƒ…å†µä¸‹å‘¢ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•çš„å¹¶å‘é—®é¢˜ ç¬¬äºŒç§æ˜¯è¯»å†™å¹¶å‘ï¼šå°±æ˜¯è¯´ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBåœ¨åŒä¸€æ—¶åˆ»åˆ†åˆ«è¿›è¡Œè¯»å†™æ“ä½œï¼Œè¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¹æ•°æ®åº“çš„æ•°æ®é€ æˆä¸€äº›é—®é¢˜ï¼Œç¬¬ä¸€ã€äº‹åŠ¡éš”ç¦»æ€§é—®é¢˜ï¼›ç¬¬äºŒã€ä¼šé€ æˆè„è¯»ï¼Œå¹»è¯»ï¼Œä¸å¯é‡å¤è¯»çš„é—®é¢˜ ç¬¬ä¸‰ç§æ˜¯å†™å’Œå†™çš„å¹¶å‘ï¼šå°±æ˜¯ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBåŒæ—¶è¿›è¡Œå†™æ“ä½œï¼Œè¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¼šå­˜åœ¨æ•°æ®æ›´æ–°çš„ä¸¢å¤±é—®é¢˜ MVCCå°±æ˜¯ä¸ºäº†è§£å†³äº‹åŠ¡æ“ä½œä¸­å¹¶å‘å®‰å…¨é—®é¢˜çš„ï¼Œæ— é”å¹¶å‘æ§åˆ¶æŠ€æœ¯ï¼Œå…¨ç§°å°±æ˜¯ï¼šå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œä»–æ˜¯é€šè¿‡æ•°æ®åº“è®°å½•ä¸­çš„éšå¼å­—æ®µUndoæ—¥å¿—å’ŒReadViewæ¥å®ç°çš„ï¼ŒMVCCä¸»è¦è§£å†³ä¸‰ä¸ªé—®é¢˜ï¼šç¬¬ä¸€ã€é€šè¿‡MVCCå¯ä»¥è§£å†³è¯»å†™å¹¶å‘é˜»å¡é—®é¢˜ï¼Œä»è€Œæé«˜æ•°æ®åº“çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼›ç¬¬äºŒã€MVCCé‡‡ç”¨çš„æ˜¯ä¹è§‚é”çš„æ–¹å¼å®ç°ï¼Œé™ä½äº†æ­»é”çš„æ¦‚ç‡ï¼›ç¬¬ä¸‰ã€è§£å†³äº†ä¸€è‡´æ€§è¯»çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œæ ¹æ®æŸä¸ªæ¡ä»¶å»è¯»å–åˆ°çš„æ•°æ®ï¼ŒçŸ¥é“äº‹åŠ¡ç»“æŸçš„æ—¶å€™å†å»æ‰§è¡Œç›¸åŒæ¡ä»¶ï¼Œè¿˜æ˜¯è¯»åˆ°åŒä¸€ä»½æ•°æ®ï¼Œä¸ä¼šå‘ç”Ÿå˜åŒ–å˜åŒ–ï¼Œè€Œæˆ‘ä»¬åœ¨ä½¿ç”¨MVCCçš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯æ ¹æ®ä¸šåŠ¡åœºæ™¯æ¥é€‰æ‹©ç»„åˆæ­é…ï¼Œä¹è§‚é”æˆ–è€…æ‚²è§‚é”ï¼ŒMVCCç”¨æ¥è§£å†³è¯»å†™å†²çªï¼Œè€Œä¹è§‚é”æ‚²è§‚é”ç”¨æ¥è§£å†³å†™å’Œå†™çš„å†²çªï¼Œä»è€Œæœ€å¤§ç¨‹åº¦å»æé«˜æ•°æ®åº“çš„å¹¶å‘æ€§èƒ½ã€‚ ä»€ä¹ˆåœºæ™¯ä¼šå¼•å‘å¹»è¯»å¹»è¯»æ˜¯æŒ‡åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå­˜åœ¨å‰åä¸¤æ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´çš„æ•°æ®ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡æŸ¥è¯¢å´çœ‹åˆ°äº†ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ²¡çœ‹åˆ°çš„è¡Œï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç‰¹æŒ‡äº‹åŠ¡æ‰§è¡Œä¸­æ–°å¢çš„å…¶ä»–è¡Œã€‚ sqlåœ¨mysqlçš„æ‰§è¡Œè¿‡ç¨‹ äº‹åŠ¡æ€ä¹ˆä¿è¯ä¸€è‡´æ€§redo logæ˜¯InnoDBå­˜å‚¨å¼•æ“å±‚çš„æ—¥å¿—ï¼Œåˆç§°é‡åšæ—¥å¿—æ–‡ä»¶ï¼Œç”¨äºè®°å½•äº‹åŠ¡æ“ä½œçš„å˜åŒ–ï¼Œè®°å½•çš„æ˜¯æ•°æ®ä¿®æ”¹ä¹‹åçš„å€¼ï¼Œä¸ç®¡äº‹åŠ¡æ˜¯å¦æäº¤éƒ½ä¼šè®°å½•ä¸‹æ¥ã€‚å¦‚æ•°æ®åº“æ‰ç”µï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šä½¿ç”¨redo logæ¢å¤åˆ°æ‰ç”µå‰çš„æ—¶åˆ»ï¼Œä»¥æ­¤æ¥ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚åœ¨ä¸€æ¡æ›´æ–°è¯­å¥è¿›è¡Œæ‰§è¡Œçš„æ—¶å€™ï¼ŒInnoDBå¼•æ“ä¼šæŠŠæ›´æ–°è®°å½•å†™åˆ°redo logæ—¥å¿—ä¸­ï¼Œç„¶åæ›´æ–°å†…å­˜ï¼Œæ­¤æ—¶ç®—æ˜¯è¯­å¥æ‰§è¡Œå®Œäº†ï¼Œç„¶ååœ¨ç©ºé—²çš„æ—¶å€™æˆ–è€…æ˜¯æŒ‰ç…§è®¾å®šçš„æ›´æ–°ç­–ç•¥å°†redo logä¸­çš„å†…å®¹æ›´æ–°åˆ°ç£ç›˜ä¸­ï¼Œè¿™é‡Œæ¶‰åŠåˆ°WALå³Write Ahead loggingæŠ€æœ¯ï¼Œä»–çš„å…³é”®ç‚¹æ˜¯å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ã€‚ binlog ã€undo ã€redo redo logé€šå¸¸æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œè€Œä¸æ˜¯æŸä¸€è¡Œæˆ–æŸå‡ è¡Œä¿®æ”¹æˆæ€æ ·æ€æ ·ï¼Œå®ƒç”¨æ¥æ¢å¤æäº¤åçš„ç‰©ç†æ•°æ®é¡µ(æ¢å¤æ•°æ®é¡µï¼Œä¸”åªèƒ½æ¢å¤åˆ°æœ€åä¸€æ¬¡æäº¤çš„ä½ç½®)ã€‚ undoç”¨æ¥å›æ»šè¡Œè®°å½•åˆ°æŸä¸ªç‰ˆæœ¬ã€‚undo logä¸€èˆ¬æ˜¯é€»è¾‘æ—¥å¿—ï¼Œæ ¹æ®æ¯è¡Œè®°å½•è¿›è¡Œè®°å½•ã€‚ äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰ èšç°‡å’Œéèšç°‡ç´¢å¼• èšç°‡ç´¢å¼•ä¹Ÿå¥½ã€éèšç°‡ç´¢å¼•ä¹Ÿå¥½ï¼Œéƒ½æ˜¯ç´¢å¼•çš„ä¸€ä¸ªåŸºæœ¬åˆ†ç±»ï¼Œä»–ä»¬æœ€æœ¬è´¨çš„ç‚¹åœ¨äºå­˜å‚¨å¼•æ“ï¼Œå¦‚æœæˆ‘ä»¬ç”¨InnoDBå­˜å‚¨å¼•æ“ï¼Œä»–çš„å­˜å‚¨æ–‡ä»¶æ˜¯.frmå’Œ.ibdæ–‡ä»¶ï¼Œè¿™æ„å‘³ç€InnoDBé‡Œé¢å­˜æ”¾æ•°æ®æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶æ˜¯åœ¨åŒä¸€ä¸ªæ–‡ä»¶.ibdæ–‡ä»¶é‡Œï¼Œæ‰€ä»¥ä»–çš„æ•°æ®å’Œç´¢å¼•æ˜¯æ”¾åœ¨ä¸€èµ·å­˜å‚¨çš„ï¼Œè¿™ç§å­˜å‚¨æ–¹å¼ç§°ä¹‹ä¸ºèšç°‡ç´¢å¼•ã€‚InnerDBåœ¨è¿›è¡Œæ•°æ®æ’å…¥çš„æ—¶å€™ï¼Œå¿…é¡»è¦ç»‘å®šä¸€ä¸ªç´¢å¼•åˆ—ä¸Šï¼Œé»˜è®¤æ˜¯ä¸»é”®ï¼Œå¦‚æœæ²¡æœ‰ä¸»é”®ï¼Œä¼šé€‰æ‹©å”¯ä¸€é”®ï¼Œå¦‚æœæ²¡æœ‰å”¯ä¸€é”®ï¼Œä¼šç”Ÿæˆ6å­—èŠ‚çš„rowidï¼Œè·Ÿæ•°æ®ç»‘å®šåœ¨ä¸€èµ· åƒMyISAMå­˜å‚¨å¼•æ“ï¼Œä»–å­˜å‚¨æ–‡ä»¶æ˜¯.frmï¼Œ.myi(ç´¢å¼•æ–‡ä»¶)ï¼Œ.myd(æ•°æ®æ–‡ä»¶)æ–‡ä»¶ï¼Œä»–æ˜¯æŠŠç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶åˆ†å¼€å­˜å‚¨çš„ï¼Œè¿™ç§å­˜å‚¨æ–¹å¼ç§°ä¸ºéèšç°‡ç´¢å¼•ï¼ŒInnoDBæ—¢æœ‰èšç°‡ç´¢å¼•ä¹Ÿæœ‰éèšç°‡ç´¢å¼•ï¼ŒMyISAMåªæœ‰éèšç°‡ç´¢å¼• æ•°æ®åº“æ…¢sqlä¼˜åŒ– å°½é‡åˆ›å»ºè”åˆç´¢å¼•, å¤šè¡¨å…³è”æŸ¥è¯¢ï¼šæ‰€æœ‰çš„joinæŸ¥è¯¢ï¼Œéƒ½æ˜¯é€šè¿‡åµŒå¥—å¾ªç¯è¿æ¥å®Œæˆçš„ï¼ŒåµŒå¥—å¾ªç¯joinæœ‰ä¸‰ä¸ªå˜ç§ï¼š Simple Nested-Loop Join ï¼šä»è¡¨ä¸­å–å‡ºåŒ¹é…æ‰€æœ‰åˆ—ï¼ŒåŒ¹é…ååˆå¹¶ï¼Œå¼€é”€å¤§ã€‚select * from t1,t2(ç¬›å¡å°”ç§¯) Index Nested-Loop Join ï¼š ç´¢å¼•åµŒå¥—è¿æ¥ï¼Œç”±äºéé©±åŠ¨è¡¨æœ‰ç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•å‡å°‘æ¯”è¾ƒï¼ŒåŠ é€ŸæŸ¥è¯¢ï¼Œæˆ‘ä»¬å†åšå…³è”æŸ¥è¯¢çš„æ—¶å€™å¿…é¡»è¦æ±‚å…³è”å­—æ®µæœ‰ç´¢å¼•ï¼›æŸ¥è¯¢è¿‡ç¨‹ï¼š1ã€æ ¹æ®å…³è”å­—æ®µç´¢å¼•è¿›è¡ŒæŸ¥æ‰¾ï¼Œåœ¨ç´¢å¼•ä¸Šæ‰¾åˆ°ç¬¦åˆçš„å€¼åå†å›è¡¨æŸ¥è¯¢ï¼Œåªæœ‰åŒ¹é…åˆ°ç´¢å¼•åæ‰ä¼šå›è¡¨ï¼Œè‡³äºé©±åŠ¨è¡¨é€‰æ‹©ï¼ŒMysqlä¼˜åŒ–å™¨ä¸€èˆ¬ä¼šé€‰æ‹©è®°å½•å°‘çš„ä½œä¸ºé©±åŠ¨è¡¨ï¼Œä½†æ˜¯å½“SQLç‰¹åˆ«å¤æ‚çš„æ—¶å€™ä¸æ’é™¤ä¼šé€‰æ‹©é”™ã€‚2ã€å¦‚æœéé©±åŠ¨è¡¨å…³è”ä¸»é”®ï¼Œæ€§èƒ½ä¼šéå¸¸é«˜ï¼Œå¦‚æœä¸æ˜¯ä¸»é”®ï¼Œå…³è”åè¿”å›è¡Œæ•°ç‰¹åˆ«å¤šçš„è¯ï¼Œæ•ˆç‡ä¹Ÿä¼šå¾ˆä½ï¼Œè¦å¤šæ¬¡å›è¡¨æ“ä½œã€‚ Block Nested-Loop Joinï¼šå½“è¿æ¥æ¡ä»¶æ²¡æœ‰ç´¢å¼•çš„æ—¶å€™ä¼šç”¨è¿™ç§æ–¹å¼å…³è”ï¼Œæ¯”Simple Nested-Loop Join å¤šäº†ä¸€ä¸ªä¸­é—´å¤„ç†è¿‡ç¨‹ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œå¯èƒ½joinçš„åˆ—å°±æ˜¯æ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆMySQLä¼šé€‰æ‹©Block Nested-Loop Joinç®—æ³•ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨Join bufferå°†é©±åŠ¨è¡¨çš„æŸ¥è¯¢Joinç›¸å…³åˆ—éƒ½ç¼“å­˜åˆ°Join bufferä¸­ï¼Œç„¶åæ‰¹é‡ä¸éé©±åŠ¨è¡¨è¿›è¡Œæ¯”è¾ƒï¼Œé™ä½äº†éé©±åŠ¨è¡¨çš„è®¿é—®é¢‘æ¬¡ã€‚æŸ¥çœ‹join buffer:show variables like &#39;join_buffer_size;&#39; å¦‚ä½•åšåˆ†åº“åˆ†è¡¨â€‹ ä½¿ç”¨mycatæˆ–è€…shardingsphereä¸­é—´ä»¶åšåˆ†åº“åˆ†è¡¨ï¼Œé€‰æ‹©åˆé€‚çš„ä¸­é—´ä»¶ï¼Œæ°´å¹³åˆ†åº“ï¼Œæ°´å¹³åˆ†è¡¨ï¼Œå‚ç›´åˆ†åº“ï¼Œå‚ç›´åˆ†è¡¨ï¼Œåœ¨è¿›è¡Œåˆ†åº“åˆ†è¡¨çš„æ—¶å€™å°½é‡éµå¾ªä»¥ä¸‹åŸåˆ™ èƒ½ä¸åˆ‡åˆ†å°½é‡ä¸è¦åˆ‡åˆ† å¦‚æœè¦åˆ‡åˆ†ä¸€å®šè¦é€‰æ‹©åˆé€‚çš„åˆ‡åˆ†è§„åˆ™ï¼Œæå‰è§„åˆ’å¥½ å¦‚æœåˆ‡åˆ†å°½é‡é€šè¿‡æ•°æ®å†—ä½™æˆ–è¡¨åˆ†ç»„æ¥é™ä½è·¨åº“Joinçš„å¯èƒ½ ç”±äºæ•°æ®åº“ä¸­é—´ä»¶å¯¹æ•°æ®Joinå®ç°çš„ä¼˜åŠ£éš¾ä»¥æŠŠæ¡ï¼Œè€Œä¸”å®ç°é«˜æ€§èƒ½éš¾åº¦æå¤§ï¼Œä¸šåŠ¡å°½é‡å°‘ä½¿ç”¨å¤šè¡¨Join Mysqlä¸»ä»å¤åˆ¶ ä»åº“é€šè¿‡æ‰‹å·¥æ‰§è¡Œchange master to è¯­å¥è¿æ¥ä¸»åº“ï¼Œæä¾›è¿æ¥ç”¨æˆ·ä¿¡æ¯ï¼ˆuserNameã€passWordã€portã€ipï¼‰äºŒè¿›åˆ¶æ—¥å¿—çš„èµ·ç‚¹ä½ç½®ï¼ˆfileå positionå·ï¼‰ï¼›start slave ä»åº“çš„IOçº¿ç¨‹å’Œä¸»åº“çš„dumpçº¿ç¨‹å»ºç«‹è¿æ¥ ä»åº“æ ¹æ®change master to è¯­å¥æä¾›çš„fileåå’Œpositionå·ï¼ŒIOçº¿ç¨‹å‘ä¸»åº“å‘èµ·binlogè¯·æ±‚ ä¸»åº“dumpçº¿ç¨‹æ ¹æ®ä»åº“è¯·æ±‚ï¼Œå°†æœ¬åœ°binlogä»¥eventsçš„æ–¹å¼å‘ç»™ä»åº“IOçº¿ç¨‹ ä»åº“IOçº¿ç¨‹æ¥å—binlog eventsï¼Œå¹¶æ”¾åˆ°æœ¬åœ°relay-logä¸­(é¡ºåºIO)ï¼Œä¼ é€è¿‡æ¥çš„ä¿¡æ¯ä¼šè®°å½•åˆ°master.infoä¸­ ä»åº“SQLçº¿ç¨‹åº”ç”¨relay-log,å¹¶ä¸”æŠŠåº”ç”¨è¿‡çš„è®°å½•åˆ°relay-log.infoä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå·²ç»åº”ç”¨è¿‡çš„relayä¼šè‡ªåŠ¨è¢«æ¸…ç†purge å…¨å±€åºå·ç”Ÿæˆè§„åˆ™ï¼Ÿ UUIDï¼šæ²¡é¡ºåºï¼Œé•¿åº¦è¿‡é•¿ï¼Œä½œä¸ºä¸»é”®ç´¢å¼•æ•ˆç‡ä½ æ•°æ®åº“è‡ªå¢idï¼šå®ç°ç®€å•ï¼Œä¿è¯å”¯ä¸€é€’å¢ï¼Œæ‰©å±•æ€§å·®ï¼Œæœ‰å•ç‚¹æ•…éšœé£é™© redisç”Ÿæˆid é›ªèŠ±ç®—æ³• é€šè¿‡ä¸€ä¸ªåºåˆ—è¡¨è®°å½•å½“å‰åºåˆ—å·ï¼Œæœºå™¨æ¯æ¬¡ä»åºåˆ—è¡¨ä¸­è·å–ä¸€å®šæ­¥é•¿çš„åºåˆ—æ•°ç„¶åç¼“å­˜å†æœ¬åœ°ï¼Œç­‰ç”¨å®Œåå†é‡æ–°ä»æ­¥é•¿è¡¨è·å– å››ã€ç¼“å­˜:RedisRedisæ•°æ®ç±»å‹ String Hash Listï¼šç±»ä¼¼äºæ•°ç»„ Setï¼šæ— åºé›†åˆ ç”¨æˆ·åˆ—è¡¨ï¼Œæ±‚é›†åˆçš„äº¤é›†ï¼Œå¹¶é›†ç­‰æ“ä½œ ZSetï¼šæœ‰åºé›†åˆ 1ï¼‰ç‚¹å‡»æ–°é—»ï¼šZINCRBY hotNews:20190819 1 å®ˆæŠ¤é¦™æ¸¯ 2ï¼‰å±•ç¤ºå½“æ—¥æ’è¡Œå‰åï¼šZREVRANGE hotNews:20190819 0 9 WITHSCORES 3ï¼‰ä¸ƒæ—¥æœç´¢æ¦œå•è®¡ç®—ï¼šZUNIONSTORE hotNews:20190813-20190819 7 hotNews:20190813 hotNews:20190814â€¦ hotNews:20190819 4ï¼‰å±•ç¤ºä¸ƒæ—¥æ’è¡Œå‰åï¼šZREVRANGE hotNews:20190813-20190819 0 9 WITHSCORES Rediså•çº¿ç¨‹æ¨¡å‹RedisåŸºäºReactoræ¨¡å¼å¼€å‘çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ˜¯å•çº¿ç¨‹çš„ï¼Œé‡‡ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶ç›‘å¬å¤šä¸ªSockerï¼Œæ ¹æ®Sockerä¸Šçš„äº‹ä»¶ç±»å‹é€‰æ‹©å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œå¯ä»¥å®ç°é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡ã€‚æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨åŒ…å«4ä¸ªéƒ¨åˆ†ï¼Œå¤šä¸ªSockerï¼ŒIOå¤šè·¯å¤ç”¨ç¨‹åºï¼Œæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨å’Œäº‹ä»¶å¤„ç†å™¨(å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ï¼Œå‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œé“¾æ¥åº”ç­”å¤„ç†å™¨)ï¼Œå¤šä¸ªSocketå¯èƒ½å¹¶å‘äº§ç”Ÿä¸åŒæ“ä½œï¼Œæ¯ä¸ªæ“ä½œå¯¹åº”ä¸åŒçš„æ–‡ä»¶äº‹ä»¶ï¼Œä½†æ˜¯IOå¤šè·¯å¤ç”¨ä¼šç›‘å¬å¤šä¸ªSocketï¼Œä¼šå°†Socketæ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¯æ¬¡ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªSocketç»™æ—¶é—´åˆ†æ´¾å™¨ï¼Œæ—¶é—´åˆ†æ´¾å™¨æŠŠSocketç»™å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚ å•çº¿ç¨‹å¿«çš„åŸå› ï¼š1.çº¯å†…å­˜æ“ä½œï¼›2.æ ¸å¿ƒæ˜¯åŸºäºéé˜»å¡çš„IOå¤šè·¯å¤ç”¨æœºåˆ¶ï¼›3.å•çº¿ç¨‹åè€Œé¿å…å¤šçº¿ç¨‹çš„é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢ åˆ†å¸ƒå¼é”æ€ä¹ˆå®ç°çš„ï¼Ÿ åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”ï¼šå”¯ä¸€ç´¢å¼•ï¼ŒçŠ¶æ€æœºå”¯ä¸€è”åˆç´¢å¼• åŸºäºç¼“å­˜ï¼ˆRedisç­‰ï¼‰å®ç°åˆ†å¸ƒå¼é”ï¼šSET key value NX PX 30000 åŸºäºZookeeperå®ç°åˆ†å¸ƒå¼é”ï¼› setnxç”¨åˆ°çš„å‚æ•°SET key value NX PX 30000 ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæŠŠkeyã€value setåˆ°redisä¸­çš„ç­–ç•¥ nx ï¼š not exists, åªæœ‰key ä¸å­˜åœ¨æ—¶æ‰æŠŠkey value set åˆ°redis xx ï¼š is exists ï¼Œåªæœ‰ key å­˜åœ¨æ˜¯ï¼Œæ‰æŠŠkey value set åˆ°redis ç¬¬å››ä¸ªå‚æ•°ï¼šè¿‡æœŸæ—¶é—´å•ä½ ex ï¼šseconds ç§’ px : milliseconds æ¯«ç§’ ä½¿ç”¨å…¶ä»–å€¼ï¼ŒæŠ›å‡º å¼‚å¸¸ ï¼š redis.clients.jedis.exceptions.JedisDataException : ERR syntax error ç¬¬äº”ä¸ªå‚æ•°ï¼šæœ‰ä¸¤ç§å¯é€‰çš„å€¼ï¼Œ int å’Œlong çš„timeï¼Œéƒ½æ˜¯è¿‡æœŸæ—¶é—´ ï¼Œexpx å‚æ•°æ˜¯pxçš„æ—¶å€™ï¼Œä½¿ç”¨longç±»å‹çš„å‚æ•°ï¼Œå¯ä»¥è¡¨ç¤ºæ›´å¤šæ—¶é—´ ç¼“å­˜ç©¿é€ï¼Œå‡»ç©¿ï¼Œé›ªå´© ç¼“å­˜é›ªå´©ï¼šç¼“å­˜åŒä¸€æ—¶é—´å¤§é¢ç§¯å¤±æ•ˆï¼Œåé¢è¯·æ±‚éƒ½è½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆå¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚ è¿‡æœŸæ—¶é—´éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸ ç¼“å­˜é¢„çƒ­ï¼šé¡¹ç›®å¯åŠ¨åŠ è½½ç¼“å­˜åˆ°redis äº’æ–¥é”ï¼šä¿®æ”¹çš„æ—¶å€™åªå…è®¸ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æ•°æ®åº“ï¼Œå…¶ä»–è¯»å†™çº¿ç¨‹ç­‰å¾… åŠ ç›¸åº”ç¼“å­˜æ ‡è®°ï¼Œè®°å½•ç¼“å­˜æ˜¯å¦å¤±æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œæ›´æ–°ç¼“å­˜(å†…å­˜æ¶ˆè€—å¤§ï¼Œä¸€èˆ¬ä¸ç”¨) ç¼“å­˜ç©¿é€ï¼šæŒ‡æ•°æ®åº“æ²¡æœ‰æ•°æ®ï¼Œå¯¼è‡´è¯·æ±‚è½åˆ°æ•°æ®åº“ä¸Š æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œå¯¹idè¿›è¡Œè§„åˆ™æ‹¦æˆª ç¼“å­˜å–ä¸åˆ°æ•°æ®ï¼Œè®¾ç½®nullå€¼åˆ°ç¼“å­˜ï¼Œè®¾ç½®çŸ­æ—¶é—´è¶…æ—¶ï¼Œé˜²æ­¢ç½‘ç»œæ”»å‡» å¸ƒéš†è¿‡æ»¤å™¨ï¼Œæ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„bitmapä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®å°±ä¼šè¢«è¿™ä¸ªbitmapæ‹¦æˆª ç¼“å­˜å‡»ç©¿ï¼šç¼“å­˜æ²¡æœ‰ï¼Œæ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ç¼“å­˜æ—¶é—´åˆ°æœŸï¼‰ï¼Œå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶å¤§é‡è¯·æ±‚è½åˆ°æ•°æ®åº“ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥è¯¢åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸ keyä¸è¿‡æœŸ åŠ äº’æ–¥é” Redisè¿‡æœŸé”®åˆ é™¤ç­–ç•¥Rediså¯¹äºè¿‡æœŸé”®æœ‰ä¸‰ç§æ¸…é™¤ç­–ç•¥ï¼š è¢«åŠ¨åˆ é™¤ï¼šå½“è¯»/å†™ä¸€ä¸ªå·²ç»è¿‡æœŸçš„keyæ—¶ï¼Œä¼šè§¦å‘æƒ°æ€§åˆ é™¤ç­–ç•¥ï¼Œç›´æ¥åˆ é™¤æ‰è¿™ä¸ªè¿‡æœŸkey ä¸»åŠ¨åˆ é™¤ï¼šç”±äºæƒ°æ€§åˆ é™¤ç­–ç•¥æ— æ³•ä¿è¯å†·æ•°æ®è¢«åŠæ—¶åˆ æ‰ï¼Œæ‰€ä»¥Redisä¼šå®šæœŸä¸»åŠ¨æ·˜æ±°ä¸€æ‰¹å·²è¿‡æœŸçš„key å½“å‰å·²ç”¨å†…å­˜è¶…è¿‡maxmemoryé™å®šæ—¶ï¼Œè§¦å‘ä¸»åŠ¨æ¸…ç†ç­–ç•¥ ä¸»åŠ¨æ¸…ç†ç­–ç•¥åœ¨Redis 4.0 ä¹‹å‰ä¸€å…±å®ç°äº† 6 ç§å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œåœ¨ 4.0 ä¹‹åï¼Œåˆå¢åŠ äº† 2 ç§ç­–ç•¥ï¼Œæ€»å…±8ç§ï¼š a) é’ˆå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyåšå¤„ç†ï¼š volatile-ttlï¼šåœ¨ç­›é€‰æ—¶ï¼Œä¼šé’ˆå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ï¼Œæ ¹æ®è¿‡æœŸæ—¶é—´çš„å…ˆåè¿›è¡Œåˆ é™¤ï¼Œè¶Šæ—©è¿‡æœŸçš„è¶Šå…ˆè¢«åˆ é™¤ã€‚ volatile-randomï¼šå°±åƒå®ƒçš„åç§°ä¸€æ ·ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ä¸­ï¼Œè¿›è¡Œéšæœºåˆ é™¤ã€‚ volatile-lruï¼šä¼šä½¿ç”¨ LRU ç®—æ³•ç­›é€‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹åˆ é™¤ã€‚ volatile-lfuï¼šä¼šä½¿ç”¨ LFU ç®—æ³•ç­›é€‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹åˆ é™¤ã€‚ b) é’ˆå¯¹æ‰€æœ‰çš„keyåšå¤„ç†ï¼š allkeys-randomï¼šä»æ‰€æœ‰é”®å€¼å¯¹ä¸­éšæœºé€‰æ‹©å¹¶åˆ é™¤æ•°æ®ã€‚ allkeys-lruï¼šä½¿ç”¨ LRU ç®—æ³•åœ¨æ‰€æœ‰æ•°æ®ä¸­è¿›è¡Œç­›é€‰åˆ é™¤ã€‚ allkeys-lfuï¼šä½¿ç”¨ LFU ç®—æ³•åœ¨æ‰€æœ‰æ•°æ®ä¸­è¿›è¡Œç­›é€‰åˆ é™¤ã€‚ c) ä¸å¤„ç†ï¼š noevictionï¼šä¸ä¼šå‰”é™¤ä»»ä½•æ•°æ®ï¼Œæ‹’ç»æ‰€æœ‰å†™å…¥æ“ä½œå¹¶è¿”å›å®¢æˆ·ç«¯é”™è¯¯ä¿¡æ¯â€(error) OOM command not allowed when used memoryâ€ï¼Œæ­¤æ—¶Redisåªå“åº”è¯»æ“ä½œã€‚ LRU ç®—æ³•ï¼ˆLeast Recently Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ æ·˜æ±°å¾ˆä¹…æ²¡è¢«è®¿é—®è¿‡çš„æ•°æ®ï¼Œä»¥æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ä½œä¸ºå‚è€ƒã€‚ LFU ç®—æ³•ï¼ˆLeast Frequently Usedï¼Œæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ æ·˜æ±°æœ€è¿‘ä¸€æ®µæ—¶é—´è¢«è®¿é—®æ¬¡æ•°æœ€å°‘çš„æ•°æ®ï¼Œä»¥æ¬¡æ•°ä½œä¸ºå‚è€ƒã€‚ å½“å­˜åœ¨çƒ­ç‚¹æ•°æ®æ—¶ï¼ŒLRUçš„æ•ˆç‡å¾ˆå¥½ï¼Œä½†å¶å‘æ€§çš„ã€å‘¨æœŸæ€§çš„æ‰¹é‡æ“ä½œä¼šå¯¼è‡´LRUå‘½ä¸­ç‡æ€¥å‰§ä¸‹é™ï¼Œç¼“å­˜æ±¡æŸ“æƒ…å†µæ¯”è¾ƒä¸¥é‡ã€‚è¿™æ—¶ä½¿ç”¨LFUå¯èƒ½æ›´å¥½ç‚¹ã€‚æ ¹æ®è‡ªèº«ä¸šåŠ¡ç±»å‹ï¼Œé…ç½®å¥½maxmemory-policy(é»˜è®¤æ˜¯noeviction)ï¼Œæ¨èä½¿ç”¨volatile-lruã€‚å¦‚æœä¸è®¾ç½®æœ€å¤§å†…å­˜ï¼Œå½“ Redis å†…å­˜è¶…å‡ºç‰©ç†å†…å­˜é™åˆ¶æ—¶ï¼Œå†…å­˜çš„æ•°æ®ä¼šå¼€å§‹å’Œç£ç›˜äº§ç”Ÿé¢‘ç¹çš„äº¤æ¢ (swap)ï¼Œä¼šè®© Redis çš„æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚å½“Redisè¿è¡Œåœ¨ä¸»ä»æ¨¡å¼æ—¶ï¼Œåªæœ‰ä¸»ç»“ç‚¹æ‰ä¼šæ‰§è¡Œè¿‡æœŸåˆ é™¤ç­–ç•¥ï¼Œç„¶åæŠŠåˆ é™¤æ“ä½œâ€del keyâ€åŒæ­¥åˆ°ä»ç»“ç‚¹åˆ é™¤æ•°æ®ã€‚ RedisæŒä¹…åŒ– RDBå¿«ç…§(snapshot) Redis å°†å†…å­˜æ•°æ®å¿«ç…§ä¿å­˜åœ¨åå­—ä¸º dump.rdb çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚å¯ä»¥å¯¹ Redis è¿›è¡Œè®¾ç½®ï¼Œ è®©å®ƒåœ¨â€œ N ç§’å†…æ•°æ®é›†è‡³å°‘æœ‰ M ä¸ªæ”¹åŠ¨â€è¿™ä¸€æ¡ä»¶è¢«æ»¡è¶³æ—¶ï¼Œ è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡æ•°æ®ï¼›**# save 60 1000 //** (60ç§’æ”¹1000æ¬¡è¿›è¡Œä¸€æ¬¡RDBæŒä¹…åŒ–)å…³é—­RDBåªéœ€è¦å°†æ‰€æœ‰çš„saveä¿å­˜ç­–ç•¥æ³¨é‡Šæ‰å³å¯ã€‚ é—®é¢˜ï¼šä¼šé˜»å¡å®¢æˆ·ç«¯å‘½ä»¤ã€‚ è¿˜å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ç”ŸæˆRDBå¿«ç…§ï¼Œè¿›å…¥rediså®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤saveæˆ–bgsaveå¯ä»¥ç”Ÿæˆdump.rdbæ–‡ä»¶ï¼Œæ¯æ¬¡å‘½ä»¤æ‰§è¡Œéƒ½ä¼šå°†æ‰€æœ‰rediså†…å­˜å¿«ç…§åˆ°ä¸€ä¸ªæ–°çš„rdbæ–‡ä»¶é‡Œï¼Œå¹¶è¦†ç›–åŸæœ‰rdbå¿«ç…§æ–‡ä»¶ã€‚ bgsaveçš„å†™æ—¶å¤åˆ¶(COW)æœºåˆ¶ï¼šRedis å€ŸåŠ©æ“ä½œç³»ç»Ÿæä¾›çš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼ˆCopy-On-Write, COWï¼‰ï¼Œåœ¨ç”Ÿæˆå¿«ç…§çš„åŒæ—¶ï¼Œä¾ç„¶å¯ä»¥æ­£å¸¸å¤„ç†å†™å‘½ä»¤ã€‚bgsave å­è¿›ç¨‹æ˜¯ç”±ä¸»çº¿ç¨‹ fork ç”Ÿæˆçš„ï¼Œå¯ä»¥å…±äº«ä¸»çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜æ•°æ®ã€‚bgsave å­è¿›ç¨‹è¿è¡Œåï¼Œå¼€å§‹è¯»å–ä¸»çº¿ç¨‹çš„å†…å­˜æ•°æ®ï¼Œå¹¶æŠŠå®ƒä»¬å†™å…¥ RDB æ–‡ä»¶ã€‚æ­¤æ—¶ï¼Œå¦‚æœä¸»çº¿ç¨‹å¯¹è¿™äº›æ•°æ®ä¹Ÿéƒ½æ˜¯è¯»æ“ä½œï¼Œé‚£ä¹ˆï¼Œä¸»çº¿ç¨‹å’Œ bgsave å­è¿›ç¨‹ç›¸äº’ä¸å½±å“ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸»çº¿ç¨‹è¦ä¿®æ”¹ä¸€å—æ•°æ®ï¼Œé‚£ä¹ˆï¼Œè¿™å—æ•°æ®å°±ä¼šè¢«å¤åˆ¶ä¸€ä»½ï¼Œç”Ÿæˆè¯¥æ•°æ®çš„å‰¯æœ¬ã€‚ç„¶åï¼Œbgsave å­è¿›ç¨‹ä¼šæŠŠè¿™ä¸ªå‰¯æœ¬æ•°æ®å†™å…¥ RDB æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹ä»ç„¶å¯ä»¥ä¿®æ”¹åŸæ¥çš„æ•°æ®ã€‚ AOF(append-only file) å¦‚æœ Redis å› ä¸ºæŸäº›åŸå› è€Œé€ æˆæ•…éšœåœæœºï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†ä¸¢å¤±æœ€è¿‘å†™å…¥ã€ä¸”ä»æœªä¿å­˜åˆ°å¿«ç…§ä¸­çš„é‚£äº›æ•°æ®ã€‚ä» 1.1 ç‰ˆæœ¬å¼€å§‹ï¼Œ Redis å¢åŠ äº†ä¸€ç§å®Œå…¨è€ä¹…çš„æŒä¹…åŒ–æ–¹å¼ï¼š AOF æŒä¹…åŒ–ï¼Œå°†ä¿®æ”¹çš„æ¯ä¸€æ¡æŒ‡ä»¤è®°å½•è¿›æ–‡ä»¶appendonly.aofä¸­(å…ˆå†™å…¥os cacheï¼Œæ¯éš”ä¸€æ®µæ—¶é—´fsyncåˆ°ç£ç›˜) ç¼“å­˜ä¸æ•°æ®åº“æ•°æ®ä¸€è‡´æ€§ è§£å†³æ–¹æ¡ˆï¼š å¯¹äºå¹¶å‘å‡ ç‡å¾ˆå°çš„æ•°æ®(å¦‚ä¸ªäººç»´åº¦çš„è®¢å•æ•°æ®ã€ç”¨æˆ·æ•°æ®ç­‰)ï¼Œè¿™ç§å‡ ä¹ä¸ç”¨è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œå¾ˆå°‘ä¼šå‘ç”Ÿç¼“å­˜ä¸ä¸€è‡´ï¼Œå¯ä»¥ç»™ç¼“å­˜æ•°æ®åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´è§¦å‘è¯»çš„ä¸»åŠ¨æ›´æ–°å³å¯ã€‚ å°±ç®—å¹¶å‘å¾ˆé«˜ï¼Œå¦‚æœä¸šåŠ¡ä¸Šèƒ½å®¹å¿çŸ­æ—¶é—´çš„ç¼“å­˜æ•°æ®ä¸ä¸€è‡´(å¦‚å•†å“åç§°ï¼Œå•†å“åˆ†ç±»èœå•ç­‰)ï¼Œç¼“å­˜åŠ ä¸Šè¿‡æœŸæ—¶é—´ä¾ç„¶å¯ä»¥è§£å†³å¤§éƒ¨åˆ†ä¸šåŠ¡å¯¹äºç¼“å­˜çš„è¦æ±‚ã€‚ å¦‚æœä¸èƒ½å®¹å¿ç¼“å­˜æ•°æ®ä¸ä¸€è‡´ï¼Œå¯ä»¥é€šè¿‡åŠ è¯»å†™é”ä¿è¯å¹¶å‘è¯»å†™æˆ–å†™å†™çš„æ—¶å€™æŒ‰é¡ºåºæ’å¥½é˜Ÿï¼Œè¯»è¯»çš„æ—¶å€™ç›¸å½“äºæ— é”ã€‚ ä¹Ÿå¯ä»¥ç”¨é˜¿é‡Œå¼€æºçš„canalé€šè¿‡ç›‘å¬æ•°æ®åº“çš„binlogæ—¥å¿—åŠæ—¶çš„å»ä¿®æ”¹ç¼“å­˜ï¼Œä½†æ˜¯å¼•å…¥äº†æ–°çš„ä¸­é—´ä»¶ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚ äº”ã€MQæ¶ˆæ¯é˜Ÿåˆ— Rabbitmqç”Ÿäº§é«˜å¯ç”¨æ€ä¹ˆå®ç°çš„ ç”Ÿäº§éƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼šé¿å…å•æœºæ¨¡å¼ä¸‹MQæœåŠ¡å™¨æŒ‚äº†å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œè¿˜å¯ä»¥æ‰¿è½½æ›´é«˜çš„å¹¶å‘é‡ï¼Œä½†æ˜¯é›†ç¾¤æ¨¡å¼æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºé˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—åªä¼šå­˜åœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼Œå…¶ä»–é›†ç¾¤èŠ‚ç‚¹ä¸ä¼šå¤‡ä»½è¯¥é˜Ÿåˆ—ï¼Œä¸€æ—¦è¯¥èŠ‚ç‚¹å®•æœºï¼Œè¯¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å°±ä¼šä¸¢å¤±(äº²æµ‹è®¾ç½®æŒä¹…åŒ–ä¹Ÿä¸¢å¤±) ä½¿ç”¨é•œåƒé˜Ÿåˆ—ï¼šå¯ä»¥è§£å†³é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªæœºå™¨ä¸Šåªæœ‰ä¸€ä¸ªé˜Ÿåˆ—çš„é—®é¢˜ï¼Œè®©æ¶ˆæ¯åœ¨å…¶ä»–èŠ‚ç‚¹å†å¤‡ä»½ä¸€ä»½ã€‚å¼€å¯æ–¹å¼ï¼šä»»ä½•èŠ‚ç‚¹æ·»åŠ policyç­–ç•¥å³å¯ï¼Œè¯¥é›†ç¾¤å°±å…·æœ‰é•œåƒé˜Ÿåˆ—èƒ½åŠ›ï¼Œå¯è®¾ç½®å¤‡ä»½çš„ä»½æ•°å’Œå¤‡ä»½é˜Ÿåˆ—è§„åˆ™ï¼Œå³ä½¿å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å®•æœºï¼Œä¹Ÿä¼šä¿è¯æ•´ä¸ªé›†ç¾¤ä¸­ä¿å­˜2ä»½ é«˜å¯ç”¨è´Ÿè½½å‡è¡¡ï¼šhaproxy+keepaliveï¼Œnginxï¼Œlvsç­‰å®ç°é«˜å¯ç”¨è´Ÿè½½å‡è¡¡ å…¶ä»–ï¼šFederation Exchangeè”é‚¦äº¤æ¢æœºæ’ä»¶è§£å†³ä¸¤åœ°æ¥å—æ¶ˆæ¯ç¡®è®¤æ¶ˆæ¯å»¶è¿Ÿé—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç”¨Shovelæ¥åšæ•°æ®åŒæ­¥ï¼Œéœ€è¦å®‰è£…æ’ä»¶ å…­ã€å¤šçº¿ç¨‹æ­»é” æ­»é”ï¼šæ˜¯æŒ‡ä¸€ç»„äº’ç›¸ç«äº‰èµ„æºçš„çº¿ç¨‹ï¼Œå› ä¸ºäº’ç›¸ç­‰å¾…ï¼Œå¯¼è‡´æ°¸ä¹…é˜»å¡çš„ç°è±¡ã€‚ åŸå› ï¼šå¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶ å…±äº«äº’æ–¥æ¡ä»¶ï¼šå…±äº«èµ„æºxå’Œyåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ å æœ‰ä¸”ç­‰å¾…ï¼šçº¿ç¨‹t1å·²ç»å æœ‰å…±äº«èµ„æºxï¼Œåœ¨ç­‰å¾…å…±äº«èµ„æºyçš„æ—¶å€™ä¸é‡Šæ”¾å…±äº«èµ„æºx ä¸å¯æŠ¢å ï¼šå…¶ä»–çº¿ç¨‹ä¸èƒ½å¼ºè¡ŒæŠ¢å çº¿ç¨‹t1å æœ‰çš„èµ„æº å¾ªç¯ç­‰å¾…ï¼šçº¿ç¨‹t1ç­‰å¾…çº¿ç¨‹t2å æœ‰çš„èµ„æºï¼Œçº¿ç¨‹t2ç­‰å¾…çº¿ç¨‹t1å æœ‰çš„èµ„æº å¦‚ä½•é¿å…æ­»é”ï¼š æ—¢ç„¶äº§ç”Ÿæ­»é”å¿…ç„¶æ»¡è¶³å››ä¸ªæ¡ä»¶ï¼Œé‚£æˆ‘ä»¬åªè¦æ‰“ç ´å››ä¸ªæ¡ä»¶ä¸­çš„ä¸€ä¸ªå°±å¯ä»¥é¿å…ï¼Œç¬¬ä¸€ä¸ªäº’æ–¥æ¡ä»¶æ˜¯æ— æ³•è¢«ç ´åçš„ï¼Œå› ä¸ºé”æœ¬èº«å°±æ˜¯é€šè¿‡äº’æ–¥æ¥è§£å†³çº¿ç¨‹å®‰å…¨çš„ é’ˆå¯¹åä¸‰ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬é€ä¸€åˆ†æï¼Œå æœ‰ä¸”ç­‰å¾…è¿™ä¸ªæ¡ä»¶æˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æºï¼Œä¸å­˜åœ¨ç­‰å¾…ï¼› ä¸å¯æŠ¢å è¿™ä¸ªæ¡ä»¶ï¼šå æœ‰éƒ¨åˆ†èµ„æºçš„çº¿ç¨‹è¿›ä¸€æ­¥ç”³è¯·å…¶ä»–èµ„æºçš„æ—¶å€™å¦‚æœç”³è¯·ä¸åˆ°ï¼Œå¯ä»¥ä¸»åŠ¨é‡Šæ”¾å·²å æœ‰çš„èµ„æºï¼Œè¿™æ ·ä¸å¯æŠ¢å è¿™æ¡ä»¶å°±ç ´åäº†ï¼› å¾ªç¯ç­‰å¾…è¿™ä¸ªæ¡ä»¶ï¼šå¯ä»¥æŒ‰ç…§é¡ºåºå»ç”³è¯·èµ„æºè¿›è¡Œé¢„é˜²ï¼Œå°±æ˜¯è¯´èµ„æºæ˜¯æœ‰çº¿æ€§é¡ºåºçš„ï¼Œç”³è¯·çš„æ—¶å€™å¯ä»¥å…ˆç”³è¯·èµ„æºåºå·å°çš„ï¼Œå†ç”³è¯·èµ„æºåºå·å¤§çš„ï¼Œçº¿æ€§åŒ–ä¹‹åï¼Œå°±ä¸å­˜åœ¨å¾ªç¯ç­‰å¾…äº† sleepå’ŒwaitåŒºåˆ« sleep æ˜¯ Thread ç±»çš„é™æ€æœ¬åœ°æ–¹æ³•ï¼Œwait åˆ™æ˜¯ Object ç±»çš„æœ¬åœ°æ–¹æ³• sleepæ–¹æ³•ä¸ä¼šé‡Šæ”¾é”ï¼Œä½†æ˜¯waitä¼šé‡Šæ”¾ï¼Œè€Œä¸”ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ sleepæ–¹æ³•ä¸ä¾èµ–äºåŒæ­¥å™¨synchronizedï¼Œä½†æ˜¯waitéœ€è¦ä¾èµ–synchronizedå…³é”®å­— sleepä¸éœ€è¦è¢«å”¤é†’ï¼ˆä¼‘çœ ä¹‹åæ¨å‡ºé˜»å¡ï¼‰ï¼Œä½†æ˜¯waitéœ€è¦ï¼ˆä¸æŒ‡å®šæ—¶é—´éœ€è¦è¢«åˆ«äººä¸­æ–­ï¼‰ sleep ä¸€èˆ¬ç”¨äºå½“å‰çº¿ç¨‹ä¼‘çœ ï¼Œæˆ–è€…è½®å¾ªæš‚åœæ“ä½œï¼Œwait åˆ™å¤šç”¨äºå¤šçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ sleep ä¼šè®©å‡º CPU æ‰§è¡Œæ—¶é—´ä¸”å¼ºåˆ¶ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œ wait åˆ™ä¸ä¸€å®šï¼Œwait åå¯èƒ½è¿˜æ˜¯æœ‰æœºä¼šé‡æ–°ç«äº‰åˆ°é”ç»§ç»­æ‰§è¡Œçš„ã€‚ sleepå°±æ˜¯æŠŠcpuçš„æ‰§è¡Œèµ„æ ¼å’Œæ‰§è¡Œæƒé‡Šæ”¾å‡ºå»ï¼Œä¸å†è¿è¡Œæ­¤çº¿ç¨‹ï¼Œå½“å®šæ—¶æ—¶é—´ç»“æŸå†å–å›cpuèµ„æºï¼Œå‚ä¸cpuçš„è°ƒåº¦ï¼Œè·å–åˆ°cpuèµ„æºåå°±å¯ä»¥ç»§ç»­è¿è¡Œäº†ã€‚è€Œå¦‚æœsleepæ—¶è¯¥çº¿ç¨‹æœ‰é”ï¼Œé‚£ä¹ˆsleepä¸ä¼šé‡Šæ”¾è¿™ä¸ªé”ï¼Œè€Œæ˜¯æŠŠé”å¸¦ç€è¿›å…¥äº†å†»ç»“çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶ä»–éœ€è¦è¿™ä¸ªé”çš„çº¿ç¨‹æ ¹æœ¬ä¸å¯èƒ½è·å–åˆ°è¿™ä¸ªé”ã€‚ä¹Ÿå°±æ˜¯è¯´æ— æ³•æ‰§è¡Œç¨‹åºã€‚å¦‚æœåœ¨ç¡çœ æœŸé—´å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†è¿™ä¸ªçº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ä¹Ÿä¼šæŠ›å‡ºinterruptexceptionå¼‚å¸¸è¿”å›ï¼Œè¿™ç‚¹å’Œwaitæ˜¯ä¸€æ ·çš„ã€‚ å½“æˆ‘ä»¬è°ƒç”¨waitï¼ˆï¼‰æ–¹æ³•åï¼Œçº¿ç¨‹ä¼šæ”¾åˆ°ç­‰å¾…æ± å½“ä¸­ï¼Œç­‰å¾…æ± çš„çº¿ç¨‹æ˜¯ä¸ä¼šå»ç«äº‰åŒæ­¥é”ã€‚åªæœ‰è°ƒç”¨äº†notifyï¼ˆï¼‰æˆ–notifyAll()åç­‰å¾…æ± çš„çº¿ç¨‹æ‰ä¼šå¼€å§‹å»ç«äº‰é”ï¼Œnotifyï¼ˆï¼‰æ˜¯éšæœºä»ç­‰å¾…æ± é€‰å‡ºä¸€ä¸ªçº¿ç¨‹æ”¾åˆ°é”æ± ï¼Œè€ŒnotifyAll()æ˜¯å°†ç­‰å¾…æ± çš„æ‰€æœ‰çº¿ç¨‹æ”¾åˆ°é”æ± å½“ä¸­ Volitileä½œç”¨ å¯è§æ€§ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ã€‚å†…å­˜å±éšœ-&gt;æ±‡ç¼–Lockå…³é”®å­—-&gt;ç¼“å­˜ä¸€è‡´æ€§åè®® åŸå­æ€§ï¼šå¯¹ä»»æ„å•ä¸ªvolatileå˜é‡çš„è¯»/å†™å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äºvolatile++è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ æœ‰åºæ€§ï¼šå¯¹volatileä¿®é¥°çš„å˜é‡çš„è¯»å†™æ“ä½œå‰ååŠ ä¸Šå„ç§ç‰¹å®šçš„å†…å­˜å±éšœæ¥ç¦æ­¢æŒ‡ä»¤é‡æ’åºæ¥ä¿éšœæœ‰åºæ€§ Volitileå¦‚ä½•ä¿è¯å¯è§æ€§ ç¼“å­˜ä¸€è‡´æ€§ï¼šåœ¨å…±äº«å†…å­˜å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ç¼“å­˜å†…å­˜ï¼Œå…±äº«æ•°æ®åœ¨ä¸»å†…å­˜å’Œå„å¤„ç†å™¨ç§æœ‰ç¼“å­˜åŒæ—¶å­˜åœ¨ã€‚å½“æ•°æ®çš„ä¸€ä¸ªå‰¯æœ¬å‘ç”Ÿæ›´æ”¹ï¼Œå…¶ä»–å‰¯æœ¬éœ€è¦æ„ŸçŸ¥åˆ°æœ€æ–°ä¿®æ”¹æ•°æ®ã€‚ç¼“å­˜ä¸€è‡´æ€§çš„æ‰‹æ®µä¸»è¦æœ‰ï¼š æ€»çº¿é”å®šï¼šæ€»çº¿é”å®šå°±æ˜¯ä½¿ç”¨å¤„ç†å™¨æä¾›çš„ä¸€ä¸ª LOCKï¼ƒä¿¡å·ï¼Œå½“å…¶ä¸­ä¸€ä¸ªå¤„ç†å™¨åœ¨æ€»çº¿ä¸Šè¾“å‡ºæ­¤ä¿¡å·æ—¶ï¼Œå…¶å®ƒå¤„ç†å™¨çš„è¯·æ±‚å°†è¢«é˜»å¡ï¼Œé‚£ä¹ˆè¯¥å¤„ç†å™¨å¯ä»¥ç‹¬å å…±äº«å†…å­˜ã€‚ æ€»çº¿çª¥æ¢(Bus snooping)ï¼šæ˜¯ç¼“å­˜ä¸­çš„ä¸€è‡´æ€§æ§åˆ¶å™¨çª¥æ¢æ€»çº¿äº‹åŠ¡çš„ä¸€ç§æ–¹æ¡ˆï¼ˆè¯¥æ–¹æ¡ˆç”±Ravishankarå’ŒGoodmanäº1983å¹´æå‡ºï¼‰å½“æ•°æ®è¢«å¤šä¸ªç¼“å­˜å…±äº«æ—¶ï¼Œä¸€ä¸ªå¤„ç†å™¨ä¿®æ”¹äº†å…±äº«æ•°æ®çš„å€¼ï¼Œå¯ä»¥æ˜¯åˆ·æ–°ç¼“å­˜å—æˆ–ä½¿ç¼“å­˜å—å¤±æ•ˆè¿˜å¯ä»¥é€šè¿‡ç¼“å­˜å—çŠ¶æ€çš„æ”¹å˜ï¼Œæ¥è¾¾åˆ°ç¼“å­˜ä¸€è‡´æ€§çš„ç›®çš„ï¼Œä¸»è¦å–å†³äºçª¥æ¢åè®®ç±»å‹ï¼š å†™å¤±æ•ˆï¼ˆWrite-invalidateï¼‰ ï¼šå½“ä¸€ä¸ªå¤„ç†å™¨å†™å…¥å…±äº«ç¼“å­˜æ—¶ï¼Œå…¶ä»–ç¼“å­˜ä¸­çš„æ‰€æœ‰å…±äº«å‰¯æœ¬éƒ½ä¼šé€šè¿‡æ€»çº¿çª¥æ¢å¤±æ•ˆã€‚ç¡®ä¿å¤„ç†å™¨åªèƒ½è¯»å†™ä¸€ä¸ªæ•°æ®å‰¯æœ¬ï¼Œå…¶ä»–ç¼“å­˜ä¸­çš„æ‰€æœ‰å…¶ä»–å‰¯æœ¬éƒ½æ— æ•ˆã€‚è¿™æ˜¯æœ€å¸¸ç”¨çš„çª¥æ¢åè®®ã€‚MSIã€MESIã€MOSIã€MOESIå’ŒMESIFåè®®å±äºè¯¥ç±»å‹ã€‚ å†™æ›´æ–°ï¼ˆWrite-updateï¼‰ï¼šå½“å¤„ç†å™¨å†™å…¥ä¸€ä¸ªå…±äº«ç¼“å­˜å—æ—¶ï¼Œå…¶ä»–ç¼“å­˜çš„æ‰€æœ‰å…±äº«å‰¯æœ¬éƒ½ä¼šé€šè¿‡æ€»çº¿çª¥æ¢æ›´æ–°ã€‚è¿™ä¸ªæ–¹æ³•å°†å†™æ•°æ®å¹¿æ’­åˆ°æ€»çº¿ä¸Šçš„æ‰€æœ‰ç¼“å­˜ä¸­ã€‚å®ƒæ¯”å†™å¤±æ•ˆåè®®å¼•èµ·æ›´å¤§çš„æ€»çº¿æµé‡ï¼Œå› æ­¤è¿™ç§æ–¹æ³•ä¸å¸¸è§ã€‚Dragonå’Œfireflyåè®®å±äºæ­¤ç±»åˆ«ã€‚ æŒ‡ä»¤é‡æ’åºJavaè¯­è¨€è§„èŒƒè§„å®šJVMçº¿ç¨‹å†…éƒ¨ç»´æŒé¡ºåºåŒ–è¯­ä¹‰ï¼Œå³åªè¦ç¨‹åºçš„æœ€ç»ˆç»“æœä¸å®ƒé¡ºåºåŒ–æƒ…å†µçš„ç»“æœç›¸ç­‰ï¼Œé‚£ä¹ˆæŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºå¯ä»¥ä¸ä»£ç é¡ºåºä¸ä¸€è‡´ï¼Œæ­¤è¿‡ç¨‹å«æŒ‡ä»¤çš„é‡æ’åºã€‚æŒ‡ä»¤é‡æ’åºçš„æ„ä¹‰ï¼šï¼šJVMèƒ½æ ¹æ®å¤„ç†å™¨ç‰¹æ€§ï¼ˆCPUå¤šçº§ç¼“å­˜ç³»ç»Ÿã€å¤šæ ¸å¤„ç†å™¨ç­‰ï¼‰é€‚å½“çš„å¯¹æœºå™¨æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä½¿æœºå™¨æŒ‡ä»¤èƒ½æ›´ç¬¦åˆCPUçš„æ‰§è¡Œç‰¹æ€§ï¼Œæœ€å¤§é™åº¦çš„å‘æŒ¥æœºå™¨æ€§èƒ½ã€‚ Javaçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ NEWï¼ˆåˆå§‹åŒ–çŠ¶æ€ï¼‰ RUNNABLEï¼ˆå¯è¿è¡ŒçŠ¶æ€+è¿è¡ŒçŠ¶æ€ï¼‰ BLOCKEDï¼ˆé˜»å¡çŠ¶æ€ï¼‰ WAITINGï¼ˆæ— æ—¶é™ç­‰å¾…ï¼‰ TIMED_WAITINGï¼ˆæœ‰æ—¶é™ç­‰å¾…ï¼‰ TERMINATEDï¼ˆç»ˆæ­¢çŠ¶æ€ï¼‰ åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œæœ‰äº”ç§çŠ¶æ€ï¼ŒJava çº¿ç¨‹ä¸­çš„ BLOCKEDã€WAITINGã€TIMED_WAITING æ˜¯ä¸€ç§çŠ¶æ€ï¼Œå³å‰é¢æˆ‘ä»¬æåˆ°çš„ä¼‘çœ çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´åªè¦ Java çº¿ç¨‹å¤„äºè¿™ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ°¸è¿œæ²¡æœ‰ CPU çš„ä½¿ç”¨æƒã€‚ linuxæŸ¥çœ‹çº¿ç¨‹å‘½ä»¤ ps - fe æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹ ps - fT - p æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆ PID ï¼‰çš„æ‰€æœ‰çº¿ç¨‹ kill æ€æ­»è¿›ç¨‹ top æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹ top - H - p æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆ PID ï¼‰çš„æ‰€æœ‰çº¿ç¨‹ jps å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹ jstack æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆ PID ï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€ jconsole æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰ Javaçº¿ç¨‹çš„å®ç°æ–¹å¼ æ–¹å¼1ï¼šä½¿ç”¨ Threadç±»æˆ–ç»§æ‰¿Threadç±» å®ç° Runnable æ¥å£é…åˆThread ä½¿ç”¨æœ‰è¿”å›å€¼çš„ Callableï¼Œå€ŸåŠ©çº¿ç¨‹æ± ä½¿ç”¨ ä½¿ç”¨ lambda æœ¬è´¨ä¸ŠJavaä¸­å®ç°çº¿ç¨‹åªæœ‰ä¸€ç§æ–¹å¼ï¼Œéƒ½æ˜¯é€šè¿‡new Thread()åˆ›å»ºçº¿ç¨‹ï¼Œè°ƒç”¨Thread#startå¯åŠ¨çº¿ç¨‹æœ€ç»ˆéƒ½ä¼šè°ƒç”¨Thread#runæ–¹æ³• Threadå¸¸ç”¨æ–¹æ³•sleepæ–¹æ³• è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» Running è¿›å…¥TIMED_WAITINGçŠ¶æ€ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é” å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡ºInterruptedExceptionï¼Œå¹¶ä¸”ä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿— ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ sleepå½“ä¼ å…¥å‚æ•°ä¸º0æ—¶ï¼Œå’Œyieldç›¸åŒ yieldæ–¹æ³• yieldä¼šé‡Šæ”¾CPUèµ„æºï¼Œè®©å½“å‰çº¿ç¨‹ä» Running è¿›å…¥ RunnableçŠ¶æ€ï¼Œè®©ä¼˜å…ˆçº§æ›´é«˜ï¼ˆè‡³å°‘æ˜¯ç›¸åŒï¼‰çš„çº¿ç¨‹è·å¾—æ‰§è¡Œæœºä¼šï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼› å‡è®¾å½“å‰è¿›ç¨‹åªæœ‰mainçº¿ç¨‹ï¼Œå½“è°ƒç”¨yieldä¹‹åï¼Œmainçº¿ç¨‹ä¼šç»§ç»­è¿è¡Œï¼Œå› ä¸ºæ²¡æœ‰æ¯”å®ƒä¼˜å…ˆçº§æ›´é«˜çš„çº¿ç¨‹ï¼› å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ ThreadLocalçš„å®ç°åŸç†ThreadLocalçš„å®ç°åŸç†ï¼Œæ¯ä¸€ä¸ªThreadç»´æŠ¤ä¸€ä¸ªThreadLocalMapï¼Œkeyä¸ºä½¿ç”¨å¼±å¼•ç”¨çš„ThreadLocalå®ä¾‹ï¼Œvalueä¸ºçº¿ç¨‹å˜é‡çš„å‰¯æœ¬ ThreadLocalåº”ç”¨åœºæ™¯ åœ¨è¿›è¡Œå¯¹è±¡è·¨å±‚ä¼ é€’çš„æ—¶å€™ï¼Œä½¿ç”¨ThreadLocalå¯ä»¥é¿å…å¤šæ¬¡ä¼ é€’ï¼Œæ‰“ç ´å±‚æ¬¡é—´çš„çº¦æŸã€‚ çº¿ç¨‹é—´æ•°æ®éš”ç¦» è¿›è¡Œäº‹åŠ¡æ“ä½œï¼Œç”¨äºå­˜å‚¨çº¿ç¨‹äº‹åŠ¡ä¿¡æ¯ã€‚ æ•°æ®åº“è¿æ¥ï¼ŒSessionä¼šè¯ç®¡ç†ã€‚ Springæ¡†æ¶åœ¨äº‹åŠ¡å¼€å§‹æ—¶ä¼šç»™å½“å‰çº¿ç¨‹ç»‘å®šä¸€ä¸ªJdbc Connection,åœ¨æ•´ä¸ªäº‹åŠ¡è¿‡ç¨‹éƒ½æ˜¯ä½¿ç”¨è¯¥çº¿ç¨‹ç»‘å®šçš„connectionæ¥æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œå®ç°äº†äº‹åŠ¡çš„éš”ç¦»æ€§ã€‚Springæ¡†æ¶é‡Œé¢å°±æ˜¯ç”¨çš„ThreadLocalæ¥å®ç°è¿™ç§éš”ç¦» ThreadLocalå†…å­˜æ³„éœ²åŸå› ï¼Œå¦‚ä½•é¿å… å¼ºå¼•ç”¨ï¼šä½¿ç”¨æœ€æ™®éçš„å¼•ç”¨(new)ï¼Œä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨ï¼Œä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå®æ„¿æŠ›å‡ºOutOfMemoryErroré”™è¯¯ï¼Œä½¿ç¨‹åºå¼‚å¸¸ç»ˆæ­¢ï¼Œä¹Ÿä¸å›æ”¶è¿™ç§å¯¹è±¡ã€‚ å¼±å¼•ç”¨ï¼šJVMè¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚åœ¨javaä¸­ï¼Œç”¨java.lang.ref.WeakReferenceç±»æ¥è¡¨ç¤ºã€‚å¯ä»¥åœ¨ç¼“å­˜ä¸­ä½¿ç”¨å¼±å¼•ç”¨ã€‚ ThreadLocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³• æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocaléƒ½è°ƒç”¨å®ƒçš„remove()æ–¹æ³•æ¸…é™¤æ•°æ® å°†ThreadLocalå˜é‡å®šä¹‰æˆprivate staticï¼Œè¿™æ ·å°±ä¸€ç›´å­˜åœ¨ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œä¹Ÿå°±èƒ½ä¿è¯ä»»ä½•æ—¶å€™éƒ½èƒ½é€šè¿‡ThreadLocalçš„å¼±å¼•ç”¨è®¿é—®åˆ°Entryçš„valueå€¼ï¼Œè¿›è€Œæ¸…é™¤æ‰ ã€‚ synchronizedå’ŒReentranLockåŒºåˆ«ï¼Ÿsynchronizedæ˜¯jvmå±‚é¢çš„å…³é”®å­—ï¼Œåº•å±‚æ˜¯é€šè¿‡monitorå¯¹è±¡æ¥å®Œæˆï¼Œmonitorå¯¹è±¡åº•å±‚ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„Mutexäº’æ–¥é‡ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„Pthreadåº“ï¼Œæ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥ç»´æŠ¤çš„ï¼Œè€Œæ“ä½œç³»ç»Ÿåˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„ï¼ŒJVMè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œè°ƒç”¨åº•å±‚æ“ä½œç³»ç»Ÿcpuä¼šè¿›è¡Œä¸€è½®çŠ¶æ€åˆ‡æ¢ï¼Œè¿™ä¸ªçŠ¶æ€åˆ‡æ¢æ˜¯æ¯”è¾ƒé‡å‹æ“ä½œï¼Œwait/notifyç­‰æ–¹æ³•ä¹Ÿä¾èµ–monitorå¯¹è±¡åªæœ‰åœ¨åŒæ­¥å—æˆ–æ–¹æ³•ä¸­æ‰èƒ½è°ƒwait/notifyç­‰æ–¹æ³•ã€‚ Lockæ˜¯å…·ä½“ç±»ï¼ˆjava.util.concurrent.Locks.Lock)æ˜¯apiå±‚é¢çš„é”ï¼Œæ˜¯ä»jdk1.5å¼€å§‹å¼•å…¥çš„ï¼Œé‚£ä¸ªæ—¶å€™synchronizedæ€§èƒ½è¿˜æ¯”è¾ƒå·®ï¼ŒReentranLockçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å½“æ—¶æ€§èƒ½å·®çš„é—®é¢˜ ä½¿ç”¨æ–¹æ³•ï¼šsynchronizedä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾é”ï¼ŒReentranLockåˆ™éœ€è¦ç”¨æˆ·æ‰‹åŠ¨é‡Šæ”¾é”(éœ€è¦lock()å’Œunlock()é…åˆtry/finallyä½¿ç”¨) ç­‰å¾…æ˜¯å¦å¯ä¸­æ–­ï¼šsynchronizedä¸å¯ä¸­æ–­ï¼Œé™¤éæŠ›å‡ºå¼‚å¸¸æˆ–è€…æ‰§è¡Œå®Œæˆï¼ŒReentranLockå¯ä¸­æ–­ è®¾ç½®è¶…æ—¶æ–¹æ³•tryLock(long timeout, timeUnit unit) lockInterruptibly()æ”¾ä»£ç å—å¿ ï¼Œè°ƒç”¨interrupt()æ–¹æ³•å¯ä¸­æ–­ åŠ é”æ˜¯å¦å…¬å¹³ï¼šsynchronizedéå…¬å¹³é”ï¼›ReentranLock ä¸¤è€…éƒ½å¯ä»¥ï¼Œé»˜è®¤éå…¬å¹³é”ï¼Œæ„é€ æ–¹æ³•ä¼ å…¥trueä¸ºå…¬å¹³é”ï¼Œfalseä¸ºéå…¬å¹³é” é”ç»‘å®šå¤šä¸ªæ¡ä»¶Conditionï¼šsynchronized æ²¡æœ‰ï¼›ReentranLock ç”¨æ¥å®ç°åˆ†ç»„å”¤é†’éœ€è¦å”¤é†’çš„çº¿ç¨‹ï¼Œå¯ä»¥ç²¾ç¡®å”¤é†’ï¼Œä¸åƒsynchronizedè¦ä¹ˆéšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œè¦ä¹ˆå…¨éƒ¨å”¤é†’ çº¿ç¨‹æ± å‚æ•°æœ‰ï¼Œæ ¸å¿ƒçº¿ç¨‹é…ç½®ï¼ŒåŸå› ï¼Ÿ corePoolSizeï¼šçº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒçº¿ç¨‹æ•° maximumPoolSizeï¼šçº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœå½“å‰é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”ç»§ç»­æäº¤ä»»åŠ¡ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ keepAliveTimeï¼šæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹å­˜æ´»è¶…æ—¶æ—¶é—´ unitï¼šæ—¶é—´å•ä½ workQueueï¼šç”¨æ¥ä¿å­˜ç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¸”ä»»åŠ¡å¿…é¡»å®ç°Runableæ¥å£ threadFactoryï¼šç”¨æ¥åˆ›å»ºæ–°çº¿ç¨‹ çº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥ï¼š( AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ç­–ç•¥ï¼›CallerRunsPolicyï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›DiscardOldestPolicyï¼šä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼›DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡) CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰ CPUå¯†é›†å‹ä¹Ÿå«è®¡ç®—å¯†é›†å‹ï¼Œåœ¨å¤šé‡ç¨‹åºç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨ä»½æ—¶é—´ç”¨æ¥åšè®¡ç®—ã€é€»è¾‘åˆ¤æ–­ç­‰CPUåŠ¨ä½œçš„ç¨‹åºç§°ä¹‹CPU boundã€‚ä¾‹å¦‚ä¸€ä¸ªè®¡ç®—åœ†å‘¨ç‡è‡³å°æ•°ç‚¹ä¸€åƒä½ä»¥ä¸‹çš„ç¨‹åºï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹å½“ä¸­ç»å¤§éƒ¨ä»½æ—¶é—´ç”¨åœ¨ä¸‰è§’å‡½æ•°å’Œå¼€æ ¹å·çš„è®¡ç®—ï¼Œä¾¿æ˜¯å±äºCPU boundçš„ç¨‹åºã€‚ çº¿ç¨‹æ•° = CPUæ ¸æ•°+1 (ç°ä»£CPUæ”¯æŒè¶…çº¿ç¨‹) IOå¯†é›†å‹ï¼ˆI/O boundï¼‰ IOå¯†é›†å‹æŒ‡çš„æ˜¯ç³»ç»Ÿçš„CPUæ€§èƒ½ç›¸å¯¹ç¡¬ç›˜ã€å†…å­˜è¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œï¼Œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPUåœ¨ç­‰I/O (ç¡¬ç›˜/å†…å­˜) çš„è¯»/å†™æ“ä½œ çº¿ç¨‹æ•° = ï¼ˆï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´+çº¿ç¨‹CPUæ—¶é—´ï¼‰/çº¿ç¨‹CPUæ—¶é—´ ï¼‰* CPUæ•°ç›® ä¸ƒã€springspringæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªç”Ÿæ€ç¯å¢ƒï¼Œåœ¨æˆ‘ä»¬çš„å¼€å‘æµç¨‹ä¸­ï¼Œæ‰€æœ‰çš„æ¡†æ¶åŸºæœ¬ä¸Šéƒ½ä¾èµ–äºspringï¼Œspringèµ·åˆ°äº†ä¸€ä¸ªIOCå®¹å™¨çš„ä½œç”¨ï¼Œç”¨æ¥æ‰¿è½½æˆ‘ä»¬æ•´ä½“çš„beanå¯¹è±¡ï¼Œå®ƒå¸®æˆ‘ä»¬å¤„ç†äº†beanå¯¹è±¡ä»åˆ›å»ºåˆ°é”€æ¯çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨springçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£çš„æ–¹å¼è¿›è¡Œç›¸å…³å¼€å‘ã€‚springæ¡†æ¶çš„å·¥ä½œä¸»è¦æµç¨‹æ˜¯ï¼Œå½“æˆ‘ä»¬ç¨‹åºå¼€å§‹å¯åŠ¨ä¹‹åï¼ŒspringæŠŠæ³¨è§£æˆ–è€…é…ç½®æ–‡ä»¶å®šä¹‰å¥½çš„beanå¯¹è±¡è½¬åŒ–æˆä¸ºBeanDefinitionranï¼Œç„¶åé€šBeanFactoryPostProcessorå®Œæˆæ•´ä¸ªçš„BeanDefinitionrançš„è§£æå’ŒåŠ è½½è¿‡ç¨‹ï¼Œç„¶åæ ¹æ®BeanDefinitionrané€šè¿‡åå°„çš„æ–¹å¼åˆ›å»ºbeanå¯¹è±¡ï¼Œç„¶åè¿›è¡Œå¯¹è±¡åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬ï¼šawareæ¥å£ç›¸å…³æ“ä½œï¼ŒBeanPostProcessoræ“ä½œï¼ŒInit-methordæ“ä½œå®Œæˆæ•´ä¸ªbeançš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¹‹åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨äº†ã€‚ Beançš„åˆå§‹åŒ–è¿‡ç¨‹ Beançš„ç”Ÿå‘½å‘¨æœŸ å¾ªç¯ä¾èµ–AOPçš„é¡ºåº spring4å’Œspring5æ˜¯ä¸ä¸€æ ·çš„ springMVCå¤„ç†è¯·æ±‚æµç¨‹ springäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶ TransactionDefinition.PROPAGATION_REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ TransactionDefinition.PROPAGATION_SUPPORTSï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡çš„è¯ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ TransactionDefinition.PROPAGATION_MANDATORYï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰äº‹åŠ¡æŠ›å‡ºå¼‚å¸¸ TransactionDefinition.PROPAGATION_REQUIRES_NEWï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡å¹¶æŒ‚èµ·å½“å‰äº‹åŠ¡ TransactionDefinition.PROPAGATION_NOT_SUPPORTEDï¼šä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡åˆ™å°†å½“å‰äº‹åŠ¡æŒ‚èµ· TransactionDefinition.PROPAGATION_NEVERï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿›è¡Œï¼Œå¦‚æœå­˜åœ¨äº‹åŠ¡åˆ™æŠ›å‡ºå¼‚å¸¸ TransactionDefinition.PROPAGATION_NESTEDï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œã€‚å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è¿›è¡Œä¸PROPAGATION_REQUIREDç±»ä¼¼çš„æ“ä½œã€‚ å…«ã€ç½‘ç»œç½‘ç»œä¸ƒå±‚æ¨¡å‹ ç¬¬ä¸€å±‚ï¼šç‰©ç†å±‚ ç¬¬äºŒå±‚ï¼šæ•°æ®é“¾è·¯å±‚ 802.2ã€802.3ATMã€HDLCã€FRAME RELAY ç¬¬ä¸‰å±‚ï¼šç½‘ç»œå±‚ IPã€IPXã€ARPã€APPLETALKã€ICMP ç¬¬å››å±‚ï¼šä¼ è¾“å±‚ TCPã€UDPã€SPX ç¬¬äº”å±‚ï¼šä¼šè¯å±‚ RPCã€SQLã€NFS ã€X WINDOWSã€ASP ç¬¬å…­å±‚ï¼šè¡¨ç¤ºå±‚ ASCLLã€PICTã€TIFFã€JPEGã€ MIDIã€MPEG ç¬¬ä¸ƒå±‚ï¼šåº”ç”¨å±‚ HTTP,FTP,SNMPç­‰ ç‰©ç†å±‚ï¼šç‰©ç†å±‚è´Ÿè´£æœ€åå°†ä¿¡æ¯ç¼–ç æˆç”µæµè„‰å†²æˆ–å…¶å®ƒä¿¡å·ç”¨äºç½‘ä¸Šä¼ è¾“ï¼› æ•°æ®é“¾è·¯å±‚ï¼šæ•°æ®é“¾è·¯å±‚é€šè¿‡ç‰©ç†ç½‘ç»œé“¾è·¯ô°ä¾›æ•°æ®ä¼ è¾“ã€‚ä¸åŒçš„æ•°æ®é“¾è·¯å±‚å®šä¹‰äº†ä¸åŒçš„ç½‘ç»œå’Œå è®®ç‰¹å¾,å…¶ä¸­åŒ…æ‹¬ç‰©ç†ç¼–å€ã€ç½‘ç»œæ‹“æ‰‘ç»“æ„ã€é”™è¯¯æ ¡éªŒã€æ•°æ®å¸§åºåˆ—ä»¥åŠæµæ§ã€‚å¯ä»¥ç®€å•çš„ç†è§£ä¸ºï¼šè§„å®šäº†0å’Œ1çš„åˆ†åŒ…å½¢å¼ï¼Œç¡®å®šäº†ç½‘ç»œæ•°æ®åŒ…çš„å½¢å¼ï¼› ç½‘ç»œå±‚ï¼šç½‘ç»œå±‚è´Ÿè´£åœ¨æºå’Œç»ˆç‚¹ä¹‹é—´å»ºç«‹è¿æ¥ã€‚å¯ä»¥ç†è§£ä¸ºï¼Œæ­¤å¤„éœ€è¦ç¡®å®šè®¡ç®—æœºçš„ä½ç½®ï¼Œæ€ä¹ˆç¡®å®šï¼ŸIPv4ï¼ŒIPv6ï¼ ä¼ è¾“å±‚ï¼šä¼ è¾“å±‚å‘é«˜å±‚æä¾›å¯é çš„ç«¯åˆ°ç«¯çš„ç½‘ç»œæ•°æ®æµæœåŠ¡ã€‚å¯ä»¥ç†è§£ä¸ºï¼šæ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šåœ¨ç½‘å¡æ³¨å†Œä¸€ä¸ªç«¯å£å·ï¼Œè¯¥å±‚å°±æ˜¯ç«¯å£ä¸ç«¯å£çš„é€šä¿¡ï¼å¸¸ç”¨çš„ï¼ˆTCPï¼IPï¼‰åè®®ï¼› ä¼šè¯å±‚ï¼šä¼šè¯å±‚å»ºç«‹ã€ç®¡ç†å’Œç»ˆæ­¢è¡¨ç¤ºå±‚ä¸å®ä½“ä¹‹é—´çš„é€šä¿¡ä¼šè¯ï¼›å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼ˆè‡ªåŠ¨çš„æ‰‹æœºä¿¡æ¯ã€è‡ªåŠ¨çš„ç½‘ç»œå¯»å€ï¼‰; è¡¨ç¤ºå±‚ï¼šè¡¨ç¤ºå±‚æä¾›å¤šç§åŠŸèƒ½ç”¨äºåº”ç”¨å±‚æ•°æ®ç¼–ç å’Œè½¬åŒ–,ä»¥ç¡®ä¿ä»¥ä¸€ä¸ªç³»ç»Ÿåº”ç”¨å±‚å‘é€çš„ä¿¡æ¯ å¯ä»¥è¢«å¦ä¸€ä¸ªç³»ç»Ÿåº”ç”¨å±‚è¯†åˆ«;å¯ä»¥ç†è§£ä¸ºï¼šè§£å†³ä¸åŒç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ï¼Œegï¼šLinuxä¸‹çš„QQå’ŒWindowsä¸‹çš„QQå¯ä»¥é€šä¿¡ï¼› åº”ç”¨å±‚ï¼šOSI çš„åº”ç”¨å±‚åè®®åŒ…æ‹¬æ–‡ä»¶çš„ä¼ è¾“ã€è®¿é—®åŠç®¡ç†åè®®(FTAM) ,ä»¥åŠæ–‡ä»¶è™šæ‹Ÿç»ˆç«¯åè®®(VIP)å’Œå…¬ç”¨ç®¡ç†ç³»ç»Ÿä¿¡æ¯(CMIP)ç­‰; http1.0å’Œhttp1.1åŒºåˆ«HTTP1.0æœ€æ—©åœ¨ç½‘é¡µä¸­ä½¿ç”¨æ˜¯åœ¨1996å¹´ï¼Œé‚£ä¸ªæ—¶å€™åªæ˜¯ä½¿ç”¨ä¸€äº›è¾ƒä¸ºç®€å•çš„ç½‘é¡µä¸Šå’Œç½‘ç»œè¯·æ±‚ä¸Šï¼Œè€ŒHTTP1.1åˆ™åœ¨1999å¹´æ‰å¼€å§‹å¹¿æ³›åº”ç”¨äºç°åœ¨çš„å„å¤§æµè§ˆå™¨ç½‘ç»œè¯·æ±‚ä¸­ï¼ŒåŒæ—¶HTTP1.1ä¹Ÿæ˜¯å½“å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„HTTPåè®®ã€‚ ä¸»è¦åŒºåˆ«ä¸»è¦ä½“ç°åœ¨ï¼š ç¼“å­˜å¤„ç†ï¼Œåœ¨HTTP1.0ä¸­ä¸»è¦ä½¿ç”¨headeré‡Œçš„If-Modified-Since,Expiresæ¥åšä¸ºç¼“å­˜åˆ¤æ–­çš„æ ‡å‡†ï¼ŒHTTP1.1åˆ™å¼•å…¥äº†æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ä¾‹å¦‚Entity tagï¼ŒIf-Unmodified-Since, If-Match, If-None-Matchç­‰æ›´å¤šå¯ä¾›é€‰æ‹©çš„ç¼“å­˜å¤´æ¥æ§åˆ¶ç¼“å­˜ç­–ç•¥ã€‚ å¸¦å®½ä¼˜åŒ–åŠç½‘ç»œè¿æ¥çš„ä½¿ç”¨ï¼ŒHTTP1.0ä¸­ï¼Œå­˜åœ¨ä¸€äº›æµªè´¹å¸¦å®½çš„ç°è±¡ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯åªæ˜¯éœ€è¦æŸä¸ªå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œè€ŒæœåŠ¡å™¨å´å°†æ•´ä¸ªå¯¹è±¡é€è¿‡æ¥äº†ï¼Œå¹¶ä¸”ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼ŒHTTP1.1åˆ™åœ¨è¯·æ±‚å¤´å¼•å…¥äº†rangeå¤´åŸŸï¼Œå®ƒå…è®¸åªè¯·æ±‚èµ„æºçš„æŸä¸ªéƒ¨åˆ†ï¼Œå³è¿”å›ç æ˜¯206ï¼ˆPartial Contentï¼‰ï¼Œè¿™æ ·å°±æ–¹ä¾¿äº†å¼€å‘è€…è‡ªç”±çš„é€‰æ‹©ä»¥ä¾¿äºå……åˆ†åˆ©ç”¨å¸¦å®½å’Œè¿æ¥ã€‚ é”™è¯¯é€šçŸ¥çš„ç®¡ç†ï¼Œåœ¨HTTP1.1ä¸­æ–°å¢äº†24ä¸ªé”™è¯¯çŠ¶æ€å“åº”ç ï¼Œå¦‚409ï¼ˆConflictï¼‰è¡¨ç¤ºè¯·æ±‚çš„èµ„æºä¸èµ„æºçš„å½“å‰çŠ¶æ€å‘ç”Ÿå†²çªï¼›410ï¼ˆGoneï¼‰è¡¨ç¤ºæœåŠ¡å™¨ä¸Šçš„æŸä¸ªèµ„æºè¢«æ°¸ä¹…æ€§çš„åˆ é™¤ã€‚ Hostå¤´å¤„ç†ï¼Œåœ¨HTTP1.0ä¸­è®¤ä¸ºæ¯å°æœåŠ¡å™¨éƒ½ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ï¼Œå› æ­¤ï¼Œè¯·æ±‚æ¶ˆæ¯ä¸­çš„URLå¹¶æ²¡æœ‰ä¼ é€’ä¸»æœºåï¼ˆhostnameï¼‰ã€‚ä½†éšç€è™šæ‹Ÿä¸»æœºæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼ˆMulti-homed Web Serversï¼‰ï¼Œå¹¶ä¸”å®ƒä»¬å…±äº«ä¸€ä¸ªIPåœ°å€ã€‚HTTP1.1çš„è¯·æ±‚æ¶ˆæ¯å’Œå“åº”æ¶ˆæ¯éƒ½åº”æ”¯æŒHostå¤´åŸŸï¼Œä¸”è¯·æ±‚æ¶ˆæ¯ä¸­å¦‚æœæ²¡æœ‰Hostå¤´åŸŸä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼ˆ400 Bad Requestï¼‰ã€‚ é•¿è¿æ¥ï¼ŒHTTP 1.1æ”¯æŒé•¿è¿æ¥ï¼ˆPersistentConnectionï¼‰å’Œè¯·æ±‚çš„æµæ°´çº¿ï¼ˆPipeliningï¼‰å¤„ç†ï¼Œåœ¨ä¸€ä¸ªTCPè¿æ¥ä¸Šå¯ä»¥ä¼ é€å¤šä¸ªHTTPè¯·æ±‚å’Œå“åº”ï¼Œå‡å°‘äº†å»ºç«‹å’Œå…³é—­è¿æ¥çš„æ¶ˆè€—å’Œå»¶è¿Ÿï¼Œåœ¨HTTP1.1ä¸­é»˜è®¤å¼€å¯Connectionï¼š keep-aliveï¼Œä¸€å®šç¨‹åº¦ä¸Šå¼¥è¡¥äº†HTTP1.0æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ›å»ºè¿æ¥çš„ç¼ºç‚¹ã€‚ HTTPSä¸HTTPçš„ä¸€äº›åŒºåˆ« HTTPSåè®®éœ€è¦åˆ°CAç”³è¯·è¯ä¹¦ï¼Œä¸€èˆ¬å…è´¹è¯ä¹¦å¾ˆå°‘ï¼Œéœ€è¦äº¤è´¹ã€‚ HTTPåè®®è¿è¡Œåœ¨TCPä¹‹ä¸Šï¼Œæ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½æ˜¯æ˜æ–‡ï¼ŒHTTPSè¿è¡Œåœ¨SSL/TLSä¹‹ä¸Šï¼ŒSSL/TLSè¿è¡Œåœ¨TCPä¹‹ä¸Šï¼Œæ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½ç»è¿‡åŠ å¯†çš„ã€‚ HTTPå’ŒHTTPSä½¿ç”¨çš„æ˜¯å®Œå…¨ä¸åŒçš„è¿æ¥æ–¹å¼ï¼Œç”¨çš„ç«¯å£ä¹Ÿä¸ä¸€æ ·ï¼Œå‰è€…æ˜¯80ï¼Œåè€…æ˜¯443ã€‚ HTTPSå¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢è¿è¥å•†åŠ«æŒï¼Œè§£å†³äº†é˜²åŠ«æŒçš„ä¸€ä¸ªå¤§é—®é¢˜ã€‚ httpä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹å…¶å®è¿™ä¹ˆè¯´æ˜¯ä¸å¤ªå‡†ç¡®çš„ï¼Œåº”è¯¥è¯´æ˜¯tcpåè®®å»ºç«‹è¿æ¥è¦3æ¬¡æ¡æ‰‹ï¼Œæ–­å¼€è¿æ¥è¦4æ¬¡æŒ¥æ‰‹ï¼Œè€Œhttpæ˜¯åŸºäºtcpåè®®çš„ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬ä¹Ÿè¿™ä¹ˆè¯´ï¼Œtcpå¯ä»¥æä¾›å…¨åŒå·¥çš„æ•°æ®æµä¼ è¾“æœåŠ¡ ä¸‰æ¬¡æ¡æ‰‹ TCPæœåŠ¡å™¨è¿›ç¨‹å…ˆåˆ›å»ºä¼ è¾“æ§åˆ¶å—TCBï¼Œæ—¶åˆ»å‡†å¤‡æ¥å—å®¢æˆ·è¿›ç¨‹çš„è¿æ¥è¯·æ±‚ï¼Œæ­¤æ—¶æœåŠ¡å™¨å°±è¿›å…¥äº†LISTENï¼ˆç›‘å¬ï¼‰çŠ¶æ€ï¼› TCPå®¢æˆ·è¿›ç¨‹ä¹Ÿæ˜¯å…ˆåˆ›å»ºä¼ è¾“æ§åˆ¶å—TCBï¼Œç„¶åå‘æœåŠ¡å™¨å‘å‡ºè¿æ¥è¯·æ±‚æŠ¥æ–‡ï¼Œè¿™æ˜¯æŠ¥æ–‡é¦–éƒ¨ä¸­çš„åŒéƒ¨ä½SYN=1ï¼ŒåŒæ—¶é€‰æ‹©ä¸€ä¸ªåˆå§‹åºåˆ—å· seq=x ï¼Œæ­¤æ—¶ï¼ŒTCPå®¢æˆ·ç«¯è¿›ç¨‹è¿›å…¥äº† SYN-SENTï¼ˆåŒæ­¥å·²å‘é€çŠ¶æ€ï¼‰çŠ¶æ€ã€‚TCPè§„å®šï¼ŒSYNæŠ¥æ–‡æ®µï¼ˆSYN=1çš„æŠ¥æ–‡æ®µï¼‰ä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†éœ€è¦æ¶ˆè€—æ‰ä¸€ä¸ªåºå·ã€‚ TCPæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æŠ¥æ–‡åï¼Œå¦‚æœåŒæ„è¿æ¥ï¼Œåˆ™å‘å‡ºç¡®è®¤æŠ¥æ–‡ã€‚ç¡®è®¤æŠ¥æ–‡ä¸­åº”è¯¥ ACK=1ï¼ŒSYN=1ï¼Œç¡®è®¤å·æ˜¯ack=x+1ï¼ŒåŒæ—¶ä¹Ÿè¦ä¸ºè‡ªå·±åˆå§‹åŒ–ä¸€ä¸ªåºåˆ—å· seq=yï¼Œæ­¤æ—¶ï¼ŒTCPæœåŠ¡å™¨è¿›ç¨‹è¿›å…¥äº†SYN-RCVDï¼ˆåŒæ­¥æ”¶åˆ°ï¼‰çŠ¶æ€ã€‚è¿™ä¸ªæŠ¥æ–‡ä¹Ÿä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†æ˜¯åŒæ ·è¦æ¶ˆè€—ä¸€ä¸ªåºå·ã€‚ TCPå®¢æˆ·è¿›ç¨‹æ”¶åˆ°ç¡®è®¤åï¼Œè¿˜è¦å‘æœåŠ¡å™¨ç»™å‡ºç¡®è®¤ã€‚ç¡®è®¤æŠ¥æ–‡çš„ACK=1ï¼Œack=y+1ï¼Œè‡ªå·±çš„åºåˆ—å·seq=x+1ï¼Œæ­¤æ—¶ï¼ŒTCPè¿æ¥å»ºç«‹ï¼Œå®¢æˆ·ç«¯è¿›å…¥ESTABLISHEDï¼ˆå·²å»ºç«‹è¿æ¥ï¼‰çŠ¶æ€ã€‚TCPè§„å®šï¼ŒACKæŠ¥æ–‡æ®µå¯ä»¥æºå¸¦æ•°æ®ï¼Œä½†æ˜¯å¦‚æœä¸æºå¸¦æ•°æ®åˆ™ä¸æ¶ˆè€—åºå·ã€‚ å½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ç¡®è®¤åä¹Ÿè¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œæ­¤ååŒæ–¹å°±å¯ä»¥å¼€å§‹é€šä¿¡äº†ã€‚ å››æ¬¡æŒ¥æ‰‹ä¹ã€è®¾è®¡æ¨¡å¼åã€Dubboä½ çŸ¥é“çš„jsonåºåˆ—åŒ–æ–¹å¼ï¼Ÿ è°·æ­Œçš„Gson json-smartï¼šå·ç§°æ˜¯é€Ÿåº¦æœ€å¿«çš„JSONè§£æå™¨ Common Lang3(3.1)çš„SerializationUtils é˜¿é‡Œå·´å·´çš„ FastJsonã€ä»¥åŠ Jackson ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´æ€ä¹ˆäº¤äº’çš„ï¼Ÿ å¥—æ¥å­—ï¼ˆsocketï¼‰ï¼šè¿™æ˜¯ä¸€ç§æ›´ä¸ºä¸€èˆ¬å¾—è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå®ƒå¯ç”¨äºç½‘ç»œä¸­ä¸åŒæœºå™¨ä¹‹é—´çš„è¿›ç¨‹é—´é€šä¿¡ï¼Œåº”ç”¨éå¸¸å¹¿æ³›ã€‚ å¯ä»¥é€šè¿‡RPCæ¡†æ¶ï¼ˆdubboã€feignç­‰ï¼‰è¿›è¡Œè¿œç¨‹è°ƒç”¨ ä¹Ÿå¯ä»¥å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ç­‰æ¶ˆæ¯ä¸­é—´ä»¶ä½œä¸ºç³»ç»Ÿä¹‹é—´ä¿¡æ¯äº¤äº’çš„æ¡¥æ¢ å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰ï¼šå¯ä»¥è¯´è¿™æ˜¯æœ€æœ‰ç”¨çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ã€‚å®ƒä½¿å¾—å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹å¯ä»¥åŠæ—¶çœ‹åˆ°å¯¹æ–¹è¿›ç¨‹ä¸­å¯¹å…±äº«å†…å­˜ä¸­æ•°æ®å¾—æ›´ dubboçš„åºåˆ—åŒ–ï¼Ÿdubbo æ”¯æŒ hessionã€Java äºŒè¿›åˆ¶åºåˆ—åŒ–ã€jsonã€SOAP æ–‡æœ¬åºåˆ—åŒ–å¤šç§åºåˆ—åŒ–åè®®ã€‚ hessian æ˜¯å…¶é»˜è®¤çš„åºåˆ—åŒ–åè®® dubbo æä¾›è€…(Provider)å¯åŠ¨æ—¶ï¼Œä¼šå‘æ³¨å†Œä¸­å¿ƒå†™å…¥è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯(è°ƒç”¨æ–¹å¼)ã€‚ æ¶ˆè´¹è€…(Consumer)å¯åŠ¨æ—¶ï¼Œä¹Ÿä¼šåœ¨æ³¨å†Œä¸­å¿ƒå†™å…¥è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¹¶ä¸”è®¢é˜…æœåŠ¡æä¾›è€…ï¼Œè·¯ç”±å’Œé…ç½®å…ƒæ•°æ®çš„ä¿¡æ¯ã€‚ æœåŠ¡æ²»ç†ä¸­å¿ƒ(duubo-admin)å¯åŠ¨æ—¶ï¼Œä¼šåŒæ—¶è®¢é˜…æ‰€æœ‰æ¶ˆè´¹è€…ï¼Œæä¾›è€…ï¼Œè·¯ç”±å’Œé…ç½®å…ƒæ•°æ®çš„ä¿¡æ¯ã€‚ å½“æä¾›è€…ç¦»å¼€æˆ–è€…æ–°æä¾›è€…åŠ å…¥æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒå‘ç°å˜åŒ–ä¼šé€šçŸ¥æ¶ˆè´¹è€…å’ŒæœåŠ¡æ²»ç†ä¸­å¿ƒã€‚ åä¸€ã€NettyNIOä¸‰å¤§æ ¸å¿ƒç»„ä»¶ Channel(é€šé“)ï¼Œ Buffer(ç¼“å†²åŒº)ï¼ŒSelector(å¤šè·¯å¤ç”¨å™¨) channel ç±»ä¼¼äºæµï¼Œæ¯ä¸ª channel å¯¹åº”ä¸€ä¸ª bufferç¼“å†²åŒºï¼Œbuffer åº•å±‚å°±æ˜¯ä¸ªæ•°ç»„ channel ä¼šæ³¨å†Œåˆ° selector ä¸Šï¼Œç”± selector æ ¹æ® channel è¯»å†™äº‹ä»¶çš„å‘ç”Ÿå°†å…¶äº¤ç”±æŸä¸ªç©ºé—²çš„çº¿ç¨‹å¤„ç† NIO çš„ Buffer å’Œ channel éƒ½æ˜¯æ—¢å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ Nettyçº¿ç¨‹æ¨¡å‹Nettyé€šè¿‡Reactoræ¨¡å‹åŸºäºå¤šè·¯å¤ç”¨å™¨æ¥æ”¶å¹¶å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå†…éƒ¨å®ç°bosså’Œworkä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œå…¶ä¸­bossçš„çº¿ç¨‹è´Ÿè´£å¤„ç†è¯·æ±‚çš„acceptäº‹ä»¶ï¼Œå½“æ¥æ”¶åˆ°acceptäº‹ä»¶çš„è¯·æ±‚æ—¶ï¼ŒæŠŠå¯¹åº”çš„socketå°è£…åˆ°ä¸€ä¸ªNioSocketChannelä¸­ï¼Œå¹¶äº¤ç»™workçº¿ç¨‹æ± ï¼Œå…¶ä¸­workçº¿ç¨‹æ± è´Ÿè´£è¯·æ±‚çš„readå’Œwriteäº‹ä»¶ï¼Œäº¤ç”±å¯¹åº”çš„Handlerå¤„ç†ã€‚ Netty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± BossGroupå’ŒWorkerGroupï¼ŒBossGroupä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥, WorkerGroupä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™ BossGroupå’ŒWorkerGroupç±»å‹éƒ½æ˜¯NioEventLoopGroup NioEventLoopGroup ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹ç»„, è¿™ä¸ªç»„ä¸­å«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹ ï¼Œ æ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹æ˜¯NioEventLoop æ¯ä¸ªNioEventLoopéƒ½æœ‰ä¸€ä¸ªselector , ç”¨äºç›‘å¬æ³¨å†Œåœ¨å…¶ä¸Šçš„socketChannelçš„ç½‘ç»œé€šè®¯ æ¯ä¸ªBossNioEventLoopçº¿ç¨‹å†…éƒ¨å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤æœ‰ 3 æ­¥ å¤„ç†acceptäº‹ä»¶ , ä¸client å»ºç«‹è¿æ¥ , ç”Ÿæˆ NioSocketChannel å°†NioSocketChannelæ³¨å†Œåˆ°æŸä¸ªworker NIOEventLoopä¸Šçš„selector å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ ï¼Œ å³runAllTasks æ¯ä¸ªworkerNIOEventLoopçº¿ç¨‹å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ è½®è¯¢æ³¨å†Œåˆ°è‡ªå·±selectorä¸Šçš„æ‰€æœ‰NioSocketChannel çš„read, writeäº‹ä»¶ å¤„ç† I/O äº‹ä»¶ï¼Œ å³read , write äº‹ä»¶ï¼Œ åœ¨å¯¹åº”NioSocketChannel å¤„ç†ä¸šåŠ¡ runAllTaskså¤„ç†ä»»åŠ¡é˜Ÿåˆ—TaskQueueçš„ä»»åŠ¡ ï¼Œä¸€äº›è€—æ—¶çš„ä¸šåŠ¡å¤„ç†ä¸€èˆ¬å¯ä»¥æ”¾å…¥TaskQueueä¸­æ…¢æ…¢å¤„ç†ï¼Œè¿™æ ·ä¸å½±å“æ•°æ®åœ¨ pipeline ä¸­çš„æµåŠ¨å¤„ç† Nettyæ¨¡å—ç»„ä»¶ Bootstrapã€ServerBootstrapï¼šBootstrap æ„æ€æ˜¯å¼•å¯¼ï¼Œä¸€ä¸ª Netty åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª Bootstrap å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª Netty ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶ï¼ŒNetty ä¸­ Bootstrap ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼ŒServerBootstrap æ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»ã€‚ Futureã€ChannelFutureï¼šæ­£å¦‚å‰é¢ä»‹ç»ï¼Œåœ¨ Netty ä¸­æ‰€æœ‰çš„ IO æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡ Future å’Œ ChannelFuturesï¼Œä»–ä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶ã€‚ Channelï¼šNetty ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œ I/O æ“ä½œã€‚Channel ä¸ºç”¨æˆ·æä¾›ï¼š å½“å‰ç½‘ç»œè¿æ¥çš„é€šé“çš„çŠ¶æ€ï¼ˆä¾‹å¦‚æ˜¯å¦æ‰“å¼€ï¼Ÿæ˜¯å¦å·²è¿æ¥ï¼Ÿï¼‰ ç½‘ç»œè¿æ¥çš„é…ç½®å‚æ•° ï¼ˆä¾‹å¦‚æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼‰ æä¾›å¼‚æ­¥çš„ç½‘ç»œ I/O æ“ä½œ(å¦‚å»ºç«‹è¿æ¥ï¼Œè¯»å†™ï¼Œç»‘å®šç«¯å£)ï¼Œå¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½• I/O è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œå¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨ç»“æŸæ—¶æ‰€è¯·æ±‚çš„ I/O æ“ä½œå·²å®Œæˆã€‚ è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª ChannelFuture å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œç›‘å¬å™¨åˆ° ChannelFuture ä¸Šï¼Œå¯ä»¥ I/O æ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹ã€‚ æ”¯æŒå…³è” I/O æ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åºã€‚ ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„ Channel ç±»å‹ä¸ä¹‹å¯¹åº”ã€‚ NioSocketChannelï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ TCP Socket è¿æ¥ã€‚ NioServerSocketChannelï¼Œå¼‚æ­¥çš„æœåŠ¡å™¨ç«¯ TCP Socket è¿æ¥ã€‚ NioDatagramChannelï¼Œå¼‚æ­¥çš„ UDP è¿æ¥ã€‚ NioSctpChannelï¼Œå¼‚æ­¥çš„å®¢æˆ·ç«¯ Sctp è¿æ¥ã€‚ NioSctpServerChannelï¼Œå¼‚æ­¥çš„ Sctp æœåŠ¡å™¨ç«¯è¿æ¥ã€‚ è¿™äº›é€šé“æ¶µç›–äº† UDP å’Œ TCP ç½‘ç»œ IO ä»¥åŠæ–‡ä»¶ IOã€‚ Selectorï¼šNetty åŸºäº Selector å¯¹è±¡å®ç° I/O å¤šè·¯å¤ç”¨ï¼Œé€šè¿‡ Selector ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„ Channel äº‹ä»¶ã€‚å½“å‘ä¸€ä¸ª Selector ä¸­æ³¨å†Œ Channel åï¼ŒSelector å†…éƒ¨çš„æœºåˆ¶å°±å¯ä»¥è‡ªåŠ¨ä¸æ–­åœ°æŸ¥è¯¢(Select) è¿™äº›æ³¨å†Œçš„ Channel æ˜¯å¦æœ‰å·²å°±ç»ªçš„ I/O äº‹ä»¶ï¼ˆä¾‹å¦‚å¯è¯»ï¼Œå¯å†™ï¼Œç½‘ç»œè¿æ¥å®Œæˆç­‰ï¼‰ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª Channel ã€‚ NioEventLoopï¼šNioEventLoop ä¸­ç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒå¼‚æ­¥æäº¤æ‰§è¡Œä»»åŠ¡ï¼Œçº¿ç¨‹å¯åŠ¨æ—¶ä¼šè°ƒç”¨ NioEventLoop çš„ run æ–¹æ³•ï¼Œæ‰§è¡Œ I/O ä»»åŠ¡å’Œé I/O ä»»åŠ¡ï¼šI/O ä»»åŠ¡ï¼Œå³ selectionKey ä¸­ ready çš„äº‹ä»¶ï¼Œå¦‚ acceptã€connectã€readã€write ç­‰ï¼Œç”± processSelectedKeys æ–¹æ³•è§¦å‘ã€‚é IO ä»»åŠ¡ï¼Œæ·»åŠ åˆ° taskQueue ä¸­çš„ä»»åŠ¡ï¼Œå¦‚ register0ã€bind0 ç­‰ä»»åŠ¡ï¼Œç”± runAllTasks æ–¹æ³•è§¦å‘ã€‚ NioEventLoopGroupï¼šNioEventLoopGroupï¼Œä¸»è¦ç®¡ç† eventLoop çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ç»„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹(NioEventLoop)è´Ÿè´£å¤„ç†å¤šä¸ª Channel ä¸Šçš„äº‹ä»¶ï¼Œè€Œä¸€ä¸ª Channel åªå¯¹åº”äºä¸€ä¸ªçº¿ç¨‹ã€‚ ChannelHandlerï¼šChannelHandler æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¤„ç† I/O äº‹ä»¶æˆ–æ‹¦æˆª I/O æ“ä½œï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å…¶ ChannelPipeline(ä¸šåŠ¡å¤„ç†é“¾)ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚ ChannelHandlerContextï¼šä¿å­˜ Channel ç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒæ—¶å…³è”ä¸€ä¸ª ChannelHandler å¯¹è±¡ã€‚ ChannelPiplineï¼šä¿å­˜ ChannelHandler çš„ Listï¼Œç”¨äºå¤„ç†æˆ–æ‹¦æˆª Channel çš„å…¥ç«™äº‹ä»¶å’Œå‡ºç«™æ“ä½œã€‚ChannelPipeline å®ç°äº†ä¸€ç§é«˜çº§å½¢å¼çš„æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠ Channel ä¸­å„ä¸ªçš„ ChannelHandler å¦‚ä½•ç›¸äº’äº¤äº’ã€‚åœ¨ Netty ä¸­æ¯ä¸ª Channel éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ChannelPipeline ä¸ä¹‹å¯¹åº”ï¼Œå®ƒä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹ï¼š ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipelineï¼Œè€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­åˆå…³è”ç€ä¸€ä¸ª ChannelHandlerã€‚readäº‹ä»¶(å…¥ç«™äº‹ä»¶)å’Œwriteäº‹ä»¶(å‡ºç«™äº‹ä»¶)åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œå…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨ head å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„ handlerï¼Œå‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨ tail å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„ handlerï¼Œä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰°ã€‚ Nettyç²˜åŒ…æ‹†åŒ…TCPæ˜¯ä¸€ä¸ªæµåè®®ï¼Œå°±æ˜¯æ²¡æœ‰ç•Œé™çš„ä¸€é•¿ä¸²äºŒè¿›åˆ¶æ•°æ®ã€‚TCPä½œä¸ºä¼ è¾“å±‚åè®®å¹¶ä¸ä¸äº†è§£ä¸Šå±‚ä¸šåŠ¡æ•°æ®çš„å…·ä½“å«ä¹‰ï¼Œå®ƒä¼šæ ¹æ®TCPç¼“å†²åŒºçš„å®é™…æƒ…å†µè¿›è¡Œæ•°æ®åŒ…çš„åˆ’åˆ†ï¼Œæ‰€ä»¥åœ¨ä¸šåŠ¡ä¸Šè®¤ä¸ºæ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ…ï¼Œå¯èƒ½ä¼šè¢«TCPæ‹†åˆ†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ï¼Œä¹Ÿæœ‰å¯èƒ½æŠŠå¤šä¸ªå°çš„åŒ…å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„TCPç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜ã€‚é¢å‘æµçš„é€šä¿¡æ˜¯æ— æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œçš„ã€‚ è§£å†³æ–¹æ¡ˆ æ¶ˆæ¯å®šé•¿åº¦ï¼Œä¼ è¾“çš„æ•°æ®å¤§å°å›ºå®šé•¿åº¦ï¼Œä¾‹å¦‚æ¯æ®µçš„é•¿åº¦å›ºå®šä¸º100å­—èŠ‚ï¼Œå¦‚æœä¸å¤Ÿç©ºä½è¡¥ç©ºæ ¼ åœ¨æ•°æ®åŒ…å°¾éƒ¨æ·»åŠ ç‰¹æ®Šåˆ†éš”ç¬¦ï¼Œæ¯”å¦‚ä¸‹åˆ’çº¿ï¼Œä¸­åˆ’çº¿ç­‰ï¼Œè¿™ç§æ–¹æ³•ç®€å•æ˜“è¡Œï¼Œä½†é€‰æ‹©åˆ†éš”ç¬¦çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„æ¯æ¡æ•°æ®çš„å†…éƒ¨ä¸€å®šä¸èƒ½å‡ºç°åˆ†éš”ç¬¦ã€‚ å‘é€é•¿åº¦ï¼šå‘é€æ¯æ¡æ•°æ®çš„æ—¶å€™ï¼Œå°†æ•°æ®çš„é•¿åº¦ä¸€å¹¶å‘é€ï¼Œæ¯”å¦‚å¯ä»¥é€‰æ‹©æ¯æ¡æ•°æ®çš„å‰4ä½æ˜¯æ•°æ®çš„é•¿åº¦ï¼Œåº”ç”¨å±‚å¤„ç†æ—¶å¯ä»¥æ ¹æ®é•¿åº¦æ¥åˆ¤æ–­æ¯æ¡æ•°æ®çš„å¼€å§‹å’Œç»“æŸã€‚ Nettyæä¾›äº†å¤šä¸ªè§£ç å™¨ï¼Œå¯ä»¥è¿›è¡Œåˆ†åŒ…çš„æ“ä½œï¼Œå¦‚ä¸‹ï¼š LineBasedFrameDecoder ï¼ˆå›è½¦æ¢è¡Œåˆ†åŒ…ï¼‰ DelimiterBasedFrameDecoderï¼ˆç‰¹æ®Šåˆ†éš”ç¬¦åˆ†åŒ…ï¼‰ FixedLengthFrameDecoderï¼ˆå›ºå®šé•¿åº¦æŠ¥æ–‡æ¥åˆ†åŒ…ï¼‰ åäºŒã€zookeeperzookeeperçš„ç†è§£ é›†ç¾¤ç®¡ç†ï¼šæä¾›äº†CPæ¨¡å‹æ¥ä¿è¯é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ åˆ†å¸ƒå¼é” é›†ç¾¤é€‰ä¸¾ zookeeperé€‰ä¸¾æœºåˆ¶ LeaderElection AuthFastLeaderElection FastLeaderElection ï¼ˆæœ€æ–°é»˜è®¤ï¼‰ ç›®å‰æœ‰5å°æœåŠ¡å™¨ï¼Œæ¯å°æœåŠ¡å™¨å‡æ²¡æœ‰æ•°æ®ï¼Œå®ƒä»¬çš„ç¼–å·åˆ†åˆ«æ˜¯1,2,3,4,5,æŒ‰ç¼–å·ä¾æ¬¡å¯åŠ¨ï¼Œå®ƒä»¬çš„é€‰æ‹©ä¸¾è¿‡ç¨‹å¦‚ä¸‹ï¼š æœåŠ¡å™¨1å¯åŠ¨ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼Œç„¶åå‘æŠ•ç¥¨ä¿¡æ¯ï¼Œç”±äºå…¶å®ƒæœºå™¨è¿˜æ²¡æœ‰å¯åŠ¨æ‰€ä»¥å®ƒæ”¶ä¸åˆ°åé¦ˆä¿¡æ¯ï¼ŒæœåŠ¡å™¨1çš„çŠ¶æ€ä¸€ç›´å±äºLooking(é€‰ä¸¾çŠ¶æ€)ã€‚ æœåŠ¡å™¨2å¯åŠ¨ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼ŒåŒæ—¶ä¸ä¹‹å‰å¯åŠ¨çš„æœåŠ¡å™¨1äº¤æ¢ç»“æœï¼Œç”±äºæœåŠ¡å™¨2çš„ç¼–å·å¤§æ‰€ä»¥æœåŠ¡å™¨2èƒœå‡ºï¼Œä½†æ­¤æ—¶æŠ•ç¥¨æ•°æ²¡æœ‰å¤§äºåŠæ•°ï¼Œæ‰€ä»¥ä¸¤ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€ä¾ç„¶æ˜¯LOOKINGã€‚ æœåŠ¡å™¨3å¯åŠ¨ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼ŒåŒæ—¶ä¸ä¹‹å‰å¯åŠ¨çš„æœåŠ¡å™¨1,2äº¤æ¢ä¿¡æ¯ï¼Œç”±äºæœåŠ¡å™¨3çš„ç¼–å·æœ€å¤§æ‰€ä»¥æœåŠ¡å™¨3èƒœå‡ºï¼Œæ­¤æ—¶æŠ•ç¥¨æ•°æ­£å¥½å¤§äºåŠæ•°ï¼Œæ‰€ä»¥æœåŠ¡å™¨3æˆä¸ºé¢†å¯¼è€…ï¼ŒæœåŠ¡å™¨1,2æˆä¸ºå°å¼Ÿã€‚ æœåŠ¡å™¨4å¯åŠ¨ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼ŒåŒæ—¶ä¸ä¹‹å‰å¯åŠ¨çš„æœåŠ¡å™¨1,2,3äº¤æ¢ä¿¡æ¯ï¼Œå°½ç®¡æœåŠ¡å™¨4çš„ç¼–å·å¤§ï¼Œä½†ä¹‹å‰æœåŠ¡å™¨3å·²ç»èƒœå‡ºï¼Œæ‰€ä»¥æœåŠ¡å™¨4åªèƒ½æˆä¸ºå°å¼Ÿã€‚ æœåŠ¡å™¨5å¯åŠ¨ï¼Œåé¢çš„é€»è¾‘åŒæœåŠ¡å™¨4æˆä¸ºå°å¼Ÿã€‚ åä¸‰ã€ç†è®ºCAPç†è®ºâ€‹ CAP ç†è®ºåˆå« Brewer ç†è®ºï¼Œè¿™æ˜¯åŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„åŸƒé‡Œå…‹ Â· å¸ƒé²å°”ï¼ˆEric Brewerï¼‰æ•™æˆï¼Œåœ¨ 2000 å¹´ 7 æœˆâ€œACM åˆ†å¸ƒå¼è®¡ç®—åŸç†ç ”è®¨ä¼šï¼ˆPODCï¼‰â€ä¸Šæå‡ºçš„ä¸€ä¸ªçŒœæƒ³ã€‚CAPç†è®ºåŸç¨¿ï¼ˆé‚£æ—¶å€™è¿˜åªæ˜¯çŒœæƒ³ï¼‰ç„¶ååˆ°äº† 2002 å¹´ï¼Œéº»çœç†å·¥å­¦é™¢çš„èµ›æ–¯ Â· å‰å°”ä¼¯ç‰¹ï¼ˆSeth Gilbertï¼‰å’Œå—å¸Œ Â· æ—å¥‡ï¼ˆNancy Lynchï¼‰å°±ä»¥ä¸¥è°¨çš„æ•°å­¦æ¨ç†è¯æ˜äº†è¿™ä¸ª CAP çŒœæƒ³ã€‚åœ¨è¿™ä¹‹åï¼ŒCAP ç†è®ºå°±æ­£å¼æˆä¸ºäº†åˆ†å¸ƒå¼è®¡ç®—é¢†åŸŸå…¬è®¤çš„è‘—åå®šç†ã€‚è¿™ä¸ªå®šç†é‡Œï¼Œæè¿°äº†ä¸€ä¸ªåˆ†å¸ƒå¼çš„ç³»ç»Ÿä¸­ï¼Œå½“æ¶‰åŠåˆ°å…±äº«æ•°æ®é—®é¢˜æ—¶ï¼Œä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§æœ€å¤šåªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ªï¼š ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šä»£è¡¨åœ¨ä»»ä½•æ—¶åˆ»ã€ä»»ä½•åˆ†å¸ƒå¼èŠ‚ç‚¹ä¸­ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„æ•°æ®éƒ½æ˜¯æ²¡æœ‰çŸ›ç›¾çš„ã€‚è¿™ä¸ ACID ä¸­çš„ C æ˜¯ç›¸åŒçš„å•è¯ï¼Œä½†å®ƒä»¬åˆæœ‰ä¸åŒçš„å®šä¹‰ï¼ˆåˆ†åˆ«æŒ‡ Replication çš„ä¸€è‡´æ€§å’Œæ•°æ®åº“çŠ¶æ€çš„ä¸€è‡´æ€§ï¼‰ã€‚åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼ŒACID çš„ C è¦ä»¥æ»¡è¶³ CAP ä¸­çš„ C ä¸ºå‰æã€‚ å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ï¼šä»£è¡¨ç³»ç»Ÿä¸é—´æ–­åœ°æä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚ åˆ†åŒºå®¹å¿æ€§ï¼ˆPartition Toleranceï¼‰ï¼šä»£è¡¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå½“éƒ¨åˆ†èŠ‚ç‚¹å› ç½‘ç»œåŸå› è€Œå½¼æ­¤å¤±è”ï¼ˆå³ä¸å…¶ä»–èŠ‚ç‚¹å½¢æˆâ€œç½‘ç»œåˆ†åŒºâ€ï¼‰æ—¶ï¼Œç³»ç»Ÿä»èƒ½æ­£ç¡®åœ°æä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚ DDDdddä¸æ˜¯ä¸€ç§æ¶æ„é£æ ¼ï¼Œè€Œæ˜¯ä¸€ç§æ–¹æ³•è®ºï¼Œä»€ä¹ˆæ˜¯æ–¹æ³•è®ºï¼Œæ¯ä¸ªäººæŒ‰ç…§è‡ªå·±çš„æƒ³æ³•æ¥è®¾è®¡å°±æ˜¯ä¸€å¥—æ–¹æ³•è®ºï¼›dddæ˜¯ä¸€ç§ä¸šåŠ¡æ¯”è¾ƒè®¤å¯ï¼Œå¯¹äºå¾®æœåŠ¡æ‹†åˆ†çš„ä¸€ç§æ–¹æ³•è®ºã€‚ åå››ã€é¡¹ç›® æœ€è¿‘åšçš„æ¯”è¾ƒç†Ÿæ‚‰çš„é¡¹ç›®æ˜¯å“ªä¸ªï¼Ÿç”»ä¸€ä¸‹é¡¹ç›®æŠ€æœ¯æ¶æ„å›¾ å†™ä¸¤ä¸ªç±»ï¼Œèƒ½å¤Ÿå®ç°å †å†…å­˜æº¢å‡ºå’Œæ ˆå†…å­˜æº¢å‡º å†™ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å•ä¾‹ã€‚ ä¸¤ä¸ªå¯å˜æœ‰åºé“¾è¡¨æ”¾åˆ°æ–°æ•°ç»„ä¸­ï¼Œæœ‰åº ESç®€ä»‹ESä»–æ˜¯å»ºç«‹åœ¨å…¨æ–‡æœç´¢å¼•æ“åº“ApacheLuceneåŸºç¡€ä¸Šçš„ä¸€ä¸ªå¼€æºæœç´¢å’Œåˆ†æå¼•æ“ï¼ŒESæœ¬èº«å…·æœ‰ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ï¼Œæ£€ç´¢é€Ÿåº¦å¿«çš„ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸ç”¨å®ƒå»å®ç°å…¨æ–‡æ£€ç´¢è¿™ä¸€ç±»çš„åœºæ™¯ï¼Œæ¯”å¦‚åƒç½‘ç«™æœç´¢ï¼Œå…¬å¸å†…éƒ¨ç”¨ELKåšæ—¥å¿—èšé›†å’Œæ£€ç´¢ï¼Œæ¥å»å¿«é€ŸæŸ¥æ‰¾æœåŠ¡å™¨çš„æ—¥å¿—è®°å½•ï¼Œå»å®šä½é—®é¢˜ï¼ŒåŸºæœ¬ä¸Šæ¶‰åŠåˆ°TBçº§åˆ«çš„æ•°æ®åœºæ™¯ï¼Œç”¨ESæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹© ESæŸ¥è¯¢å¿«çš„åŸå›  ç¬¬ä¸€ã€Luceneæ˜¯æ“…é•¿ç®¡ç†å¤§é‡çš„ç´¢å¼•æ•°æ®çš„ï¼Œå¦ä¸€æ–¹é¢ä»–ä¼šå¯¹æ•°æ®è¿›è¡Œåˆ†è¯ä»¥ååœ¨ä¿å­˜ç´¢å¼•ï¼Œè¿™æ ·èƒ½ææå‡æ•°æ®çš„æ£€ç´¢æ•ˆç‡ ç¬¬äºŒã€ESé‡‡ç”¨å€’æ’ç´¢å¼•ï¼Œæ‰€è°“å€’æ’ç´¢å¼•ï¼Œå°±æ˜¯é€šè¿‡å±æ€§å€¼æ¥ç¡®å®šæ•°æ®è®°å½•çš„ä½ç½®çš„ç´¢å¼•ï¼Œæ¥é¿å…å…¨è¡¨æ‰«æè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œ ç¬¬ä¸‰ã€ESé‡‡ç”¨åˆ†ç‰‡å­˜å‚¨æœºåˆ¶ ç¬¬å››ã€ESæ‰©å±•æ€§å¥½ï¼Œæˆ‘ä»¬å¯ä»¥æ°´å¹³æ‰©å±•å¢åŠ æœåŠ¡å™¨ï¼Œæå‡ESå¤„ç†æ€§èƒ½ï¼Œå¯ä»¥è¾¾åˆ°ç™¾å°æœåŠ¡å™¨èŠ‚ç‚¹æ‰©å±• ç¬¬äº”ã€ESå†…éƒ¨æä¾›äº†æ•°æ®æ±‡æ€»å’Œç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ä¸€äº›åŠŸèƒ½ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æ›´åŠ é«˜æ•ˆçš„å­˜å‚¨å’Œæœç´¢æ•°æ® ä½¿ç”¨ESæ³¨æ„äº‹é¡¹ ESé‡Œé¢ä¸å»ºè®®ä½¿ç”¨å¤æ‚çš„å…³è”æŸ¥è¯¢ï¼Œä¼šå¯¹æ€§èƒ½å½±å“å¾ˆå¤§ é¿å…æ·±åº¦åˆ†é¡µæŸ¥è¯¢ï¼Œå› ä¸ºESåˆ†é¡µæ˜¯æ”¯æŒfrontå’Œsizeå‚æ•°ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ¯ä¸ªåˆ†ç‰‡å¿…é¡»æ„é€ ä¸€ä¸ªé•¿åº¦ä¸ºfrontåŠ sizeçš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œç„¶åå›ä¼ åˆ°ç½‘å…³èŠ‚ç‚¹ï¼Œç½‘å…³èŠ‚ç‚¹å†å¯¹è¿™äº›é˜Ÿåˆ—è¿›è¡Œæ’åºå†æ‰¾åˆ°æ­£ç¡®çš„sizeæ–‡æ¡£ã€‚è€Œå½“frontè¶³å¤Ÿå¤§çš„æ—¶å€™å®¹æ˜“é€ æˆOOMä»¥åŠç½‘ç»œä¼ è¾“æ€§èƒ½å·®çš„ä¸€äº›é—®é¢˜","categories":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"}],"tags":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/tags/%E9%9D%A2%E8%AF%95/"}]},{"title":"æ•°æ®ç»“æ„å’Œç®—æ³•","slug":"2.ç®—æ³•/æ•°æ®ç»“æ„å’Œç®—æ³•","date":"2022-03-30T16:00:00.000Z","updated":"2022-03-31T03:01:38.754Z","comments":true,"path":"2022/03/31/2.ç®—æ³•/æ•°æ®ç»“æ„å’Œç®—æ³•/","link":"","permalink":"https://zhangxin66666.github.io/2022/03/31/2.%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/","excerpt":"","text":"æ’åºç®—æ³•é«˜æ•ˆäº¤æ¢ç®—æ³•(å¼‚æˆ–^)æ¦‚å¿µ 0^N = N ; N^N = 0 ç›¸åŒä¸º0ï¼Œä¸åŒä¸º1ï¼Œä¹Ÿå¯ä»¥å«åšæ— è¿›ä½ç›¸åŠ ï¼Œè¿™ä¹ˆåšçš„å‰æï¼šéœ€è¦äº¤æ¢çš„ä¸¤ä¸ªæ•°æŒ‡å‘çš„å†…å­˜æ˜¯ä¸¤ä½ä½ç½® å¼‚æˆ–è¿ç®—æ»¡è¶³äº¤æ¢å¾‹å’Œç»“åˆå¾‹ ä¸ç”¨é¢å¤–å˜é‡äº¤æ¢ä¸¤ä¸ªæ•° 123456// äº¤æ¢arrçš„iå’Œjä½ç½®ä¸Šçš„å€¼public static void swap(int[] arr, int i, int j) &#123; arr[i] = arr[i] ^ arr[j]; arr[j] = arr[i] ^ arr[j]; arr[i] = arr[i] ^ arr[j];&#125; ä¸€ç§æ•°å‡ºç°å¥‡æ•°æ¬¡ä¸€ä¸ªæ•°ç»„ä¸­æœ‰ä¸€ä¸ªæ•°å‡ºç°å¥‡æ•°æ¬¡ï¼Œå…¶ä»–æ•°éƒ½å‡ºç°å¶æ•°æ¬¡ï¼Œæ€ä¹ˆæ‰¾åˆ°è¿™ä¸€ä¸ªæ•°ï¼Ÿ 1234567public static void printOddTimesNum1(int[] arr) &#123; int eor = 0; for (int i = 0; i &lt; arr.length; i++) &#123; eor ^= arr[i]; &#125; System.out.println(eor);&#125; ä¸¤ç§æ•°å‡ºç°å¥‡æ•°æ¬¡ä¸€ä¸ªæ•°ç»„ä¸­æœ‰ä¸¤ä¸ªæ•°å‡ºç°å¥‡æ•°æ¬¡ï¼Œå…¶ä»–æ•°éƒ½å‡ºç°äº†å¶æ•°æ¬¡ï¼Œæ€ä¹ˆæ‰¾åˆ°è¿™ä¸¤ä¸ªæ•°ï¼Ÿ 123456789101112131415161718192021public static void printOddTimesNum2(int[] arr) &#123; int eor = 0; for (int i = 0; i &lt; arr.length; i++) &#123; eor ^= arr[i]; &#125; // a å’Œ bæ˜¯ä¸¤ç§æ•° // eor != 0 // eoræœ€å³ä¾§çš„1ï¼Œæå–å‡ºæ¥ // eor : 00110010110111000 // rightOne :00000000000001000 int rightOne = eor &amp; (-eor); // æå–å‡ºæœ€å³çš„1 int onlyOne = 0; // eor&#x27; for (int i = 0 ; i &lt; arr.length;i++) &#123; // arr[1] = 111100011110000 // rightOne= 000000000010000 if ((arr[i] &amp; rightOne) != 0) &#123; onlyOne ^= arr[i]; &#125; &#125; System.out.println(onlyOne + &quot; &quot; + (eor ^ onlyOne));&#125; å†’æ³¡æ’åº åŸºæœ¬å†’æ³¡æ’åºç®—æ³• 123456789101112131415public static void bubbleSort(int[] arr) &#123; if (arr == null || arr.length &lt; 2) &#123; return; &#125; // 0 ~ N-1 // 0 ~ N-2 // 0 ~ N-3 for (int e = arr.length - 1; e &gt; 0; e--) &#123; // 0 ~ e for (int i = 0; i &lt; e; i++) &#123; if (arr[i] &gt; arr[i + 1]) &#123; swap(arr, i, i + 1); &#125; &#125; &#125; &#125; å†’æ³¡æ’åºç®—æ³•ä¼˜åŒ– åœ¨ä¸€è¶Ÿæ’åºè¿‡ç¨‹ä¸­å¦‚æœä¸€æ¬¡éƒ½æ²¡æœ‰äº¤æ¢è¿‡ï¼Œé‚£è¯´æ˜åç»­çš„æ•°éƒ½æ˜¯æœ‰åºçš„ï¼Œä¸éœ€è¦åœ¨è¿›è¡Œåç»­çš„æ’åºäº†ï¼Œå¦‚æœå…ƒç´ æœ¬æ¥å°±æ˜¯æœ‰åºçš„ï¼Œå°±åªæ¯”è¾ƒä¸€æ¬¡å°±ç»“æŸäº†ã€‚ 12345678910111213141516171819202122232425public static void bubbleSort(int[] arr) &#123; if (arr == null || arr.length &lt; 2) &#123; return; &#125; // æ ‡è¯†å˜é‡ï¼Œè¡¨ç¤ºæ˜¯å¦è¿›è¡Œè¿‡äº¤æ¢ boolean flag = false; for (int i = 0; i &lt; arr.length - 1; i++) &#123; for (int j = 0; j &lt; arr.length - 1 - i; j++) &#123; // å¦‚æœå‰é¢çš„æ•°æ¯”åé¢çš„æ•°å¤§ï¼Œåˆ™äº¤æ¢ if (arr[j] &gt; arr[j + 1]) &#123; flag = true; int temp = arr[j]; arr[j] = arr[j + 1]; arr[j + 1] = temp; &#125; &#125; // åœ¨ä¸€è¶Ÿæ’åºä¸­ï¼Œä¸€æ¬¡äº¤æ¢éƒ½æ²¡æœ‰å‘ç”Ÿè¿‡ if (!flag) &#123; break; &#125; else &#123; // é‡ç½®flag!!!, è¿›è¡Œä¸‹æ¬¡åˆ¤æ–­ flag = false; &#125; &#125;&#125; é€‰æ‹©æ’åº 0 ~ N-1 æ‰¾åˆ°æœ€å°å€¼ï¼Œåœ¨å“ªï¼Œæ”¾åˆ°0ä½ç½®ä¸Š 1 ~ n-1 æ‰¾åˆ°æœ€å°å€¼ï¼Œåœ¨å“ªï¼Œæ”¾åˆ°1 ä½ç½®ä¸Š 2 ~ n-1 æ‰¾åˆ°æœ€å°å€¼ï¼Œåœ¨å“ªï¼Œæ”¾åˆ°2 ä½ç½®ä¸Š 123456789101112public static void selectionSort(int[] arr) &#123; if (arr == null || arr.length &lt; 2) &#123; return; &#125; for (int i = 0; i &lt; arr.length - 1; i++) &#123; int minIndex = i; for (int j = i + 1; j &lt; arr.length; j++) &#123; // i ~ N-1 ä¸Šæ‰¾æœ€å°å€¼çš„ä¸‹æ ‡ minIndex = arr[j] &lt; arr[minIndex] ? j : minIndex; &#125; swap(arr, i, minIndex); &#125;&#125; æ’å…¥æ’åº 0~1å•èŒƒå›´æœ‰åº 0~2èŒƒå›´æœ‰åº 0~3èŒƒå›´æœ‰åº 0~NèŒƒå›´æœ‰åº 1234567891011public static void insertionSort(int[] arr) &#123; if (arr == null || arr.length &lt; 2) &#123; return; &#125; // ä¸åª1ä¸ªæ•° for (int i = 1; i &lt; arr.length; i++) &#123; // 0 ~ i åšåˆ°æœ‰åº for (int j = i - 1; j &gt;= 0 &amp;&amp; arr[j] &gt; arr[j + 1]; j--) &#123; swap(arr, j, j + 1); &#125; &#125;&#125; æŸ¥æ‰¾ç®—æ³•äºŒåˆ†æŸ¥æ‰¾äºŒåˆ†æ³•çš„è¯¦è§£ä¸æ‰©å±• åœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ä¸­ï¼ŒæŸ¥æ‰¾æŸä¸ªæ•°æ˜¯å¦å­˜åœ¨ åœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„ä¸­ï¼Œæ‰¾&gt;=æŸä¸ªæ•°æœ€å·¦ä¾§çš„ä½ç½® å±€éƒ¨æœ€å°å€¼é—®é¢˜ 1234567891011121314151617181920public static boolean exist(int[] sortedArr, int num) &#123; if (sortedArr == null || sortedArr.length == 0) &#123; return false; &#125; int L = 0; int R = sortedArr.length - 1; int mid = 0; // L..R while (L &lt; R) &#123; // L..R è‡³å°‘ä¸¤ä¸ªæ•°çš„æ—¶å€™ mid = L + ((R - L) &gt;&gt; 1); if (sortedArr[mid] == num) &#123; return true; &#125; else if (sortedArr[mid] &gt; num) &#123; R = mid - 1; &#125; else &#123; L = mid + 1; &#125; &#125; return sortedArr[L] == num;&#125; æ•°ç»„èŒƒå›´ä¸Šæ±‚æœ€å¤§å€¼é€’å½’è§£æ³• 123456789101112public static int process(int[] arr, int L, int R) &#123; // arr[L..R]èŒƒå›´ä¸Šåªæœ‰ä¸€ä¸ªæ•°ï¼Œç›´æ¥è¿”å›ï¼Œbase case if (L == R) &#123; return arr[L]; &#125; // L...R ä¸åªä¸€ä¸ªæ•° // mid = (L + R) / 2 int mid = L + ((R - L) &gt;&gt; 1); // ä¸­ç‚¹ int leftMax = process(arr, L, mid); int rightMax = process(arr, mid + 1, R); return Math.max(leftMax, rightMax);&#125; å¯¹æ•°å™¨çš„æ¦‚å¿µ æœ‰ä¸€ä¸ªä½ æƒ³è¦æµ‹è¯•çš„æ–¹æ³•a å®ç°å¤æ‚åº¦ä¸å¥½ä½†æ˜¯å®¹æ˜“å®ç°çš„æ–¹æ³•b å®ç°ä¸€ä¸ªéšæœºæ ·æœ¬äº§ç”Ÿå™¨ æŠŠæ–¹æ³•aå’Œæ–¹æ³•bè·‘ç›¸åŒçš„éšæœºæ ·æœ¬ï¼Œçœ‹çœ‹å¾—åˆ°çš„ç»“æœæ˜¯å¦ä¸€æ · å¦‚æœæœ‰ä¸€ä¸ªéšæœºæ ·æœ¬æ—¶çš„æ¯”å¯¹ç»“æœä¸ä¸€è‡´ï¼Œæ‰“å°æ ·æœ¬è¿›è¡Œäººå·¥å¹²é¢„ï¼Œæ”¹å¯¹æ–¹æ³•aæˆ–è€…æ–¹æ³•b å½“æ ·æœ¬æ•°é‡å¾ˆå¤šæ—¶æ¯”å¯¹æµ‹è¯•ä¾ç„¶æ­£ç¡®ï¼Œå¯ä»¥ç¡®å®šæ–¹æ³•aå·²ç»æ­£ç¡® æ•°ç»„abæ•°ç»„åˆå¹¶åˆ°a é¢˜ç›®ï¼šç»™å‡ºä¸¤ä¸ªæœ‰åºçš„æ•´æ•°æ•°ç»„Aå’ŒBï¼Œè¯·å°†æ•°ç»„Båˆå¹¶åˆ°æ•°ç»„Aä¸­ï¼Œå˜æˆä¸€ä¸ªæœ‰åºçš„æ•°ç»„ã€‚æ³¨æ„ï¼šå¯ä»¥å‡è®¾Aæ•°ç»„æœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜æ”¾Bæ•°ç»„çš„å…ƒç´ ï¼ŒAå’ŒBä¸­åˆå§‹çš„å…ƒç´ æ•°ç›®åˆ†åˆ«ä¸ºmå’Œnã€‚ é¢˜è§£ï¼šæœ€ä¼˜è§£ï¼šä»åå¾€å‰å¤„ç†,ä¸éœ€è¦å¼€è¾Ÿé¢å¤–ç©ºé—´ã€‚ä»åå¾€å‰ï¼Œè¿™æ ·ä¸éœ€è¦è¿›è¡Œå†—ä½™å¤„ç†ã€‚ 12345678910111213141516171819202122/** * @param a æ•°ç»„aï¼Œæœ‰è¶³å¤Ÿçš„ç©ºé—´åˆå¹¶æ•°ç»„b * @param m æ•°ç»„aé‡Œé¢çš„å…ƒç´ ä¸ªæ•° * @param b æ•°ç»„b * @param n æ•°ç»„bé‡Œé¢çš„å…ƒç´ ä¸ªæ•° */public static void merge(int[] a, int m, int[] b, int n) &#123; int i = m - 1; int j = n - 1; int index = m + n - 1; while (i &gt;= 0 &amp;&amp; j &gt;= 0) &#123; if(a[i] &gt; b[j] )&#123; a[index--] = a[i--]; &#125; else &#123; a[index--] = b[j--]; &#125; &#125; //å¦‚æœAçš„æ•°å­—æ¯”Bå¤šï¼Œåˆ™ä¸ä¼šè¿›å…¥åç»­å¤„ç†ï¼›å¦‚æœBçš„æ•°å­—æ¯”Aå¤šï¼Œåˆ™è¿›å…¥åç»­å¤„ç†ï¼Œå°†Bå‰©ä½™æ•°å­—æ·»åŠ åˆ°æ•°ç»„Aä¸­ã€‚ while (j &gt;= 0) &#123; a[index--] = b[j--]; &#125;&#125; abæ•°ç»„åˆå¹¶åˆ°c é¢˜ç›®ï¼š åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•´å‹æ•°æ®ï¼ˆå…¥å‚ä¸¤ä¸ªéœ€è¦åˆå¹¶çš„æ•°ç»„ï¼Œè¿”å›å€¼åˆå¹¶å¥½çš„æ–°æ•°ç»„ï¼‰ 123456789101112131415161718192021222324252627private static int[] margeArr(int[] a, int[] b) &#123; int[] c = new int[a.length + b.length]; int i = 0, j = 0; int index = 0; //æ¯”è¾ƒæŒ‡é’ˆi,jæŒ‡å‘çš„å€¼ï¼Œå°çš„å€¼å­˜å…¥æŒ‡é’ˆindexæŒ‡å‘çš„ç»“æœæ•°ç»„ä¸­ï¼Œå½“æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ˆiæˆ–jï¼‰å…ˆåˆ°è¾¾æ•°ç»„æœ«å°¾æ—¶ï¼Œæ¯”è¾ƒç»“æŸï¼› while (i &lt; a.length &amp;&amp; j &lt; b.length) &#123; if (a[i] &lt; b[j]) &#123; c[index++] = a[i++]; &#125; else &#123; c[index++] = b[j++]; &#125; &#125; int l; //å°†æŒ‡é’ˆï¼ˆiæˆ–jï¼‰æ²¡æœ‰åˆ°è¾¾æ•°ç»„æœ«å°¾çš„æ•°ç»„å¤åˆ¶åˆ°æŒ‡é’ˆindexæŒ‡å‘çš„ç»“æœæ•°ç»„ä¸­ if (i &lt; a.length) &#123; for (l = i; l &lt; a.length; l++) &#123; c[index++] = a[l]; &#125; &#125; //å°†æŒ‡é’ˆï¼ˆiæˆ–jï¼‰æ²¡æœ‰åˆ°è¾¾æ•°ç»„æœ«å°¾çš„æ•°ç»„å¤åˆ¶åˆ°æŒ‡é’ˆindexæŒ‡å‘çš„ç»“æœæ•°ç»„ä¸­ if (j &lt; b.length) &#123; for (l = j; l &lt; b.length; l++) &#123; c[index++] = b[l]; &#125; &#125; return c;&#125; æŸ¥æ‰¾ä¸¤æ•°ä¹‹å’Œç­‰äºç›®æ ‡æ•° é¢˜ç›®ï¼šç»™å®šä¸€ä¸ªæ•°ç»„å’Œä¸€ä¸ªç›®æ ‡æ•°ï¼Œä»æ•°ç»„ä¸­æ‰¾åˆ°ä¸¤ä¸ªæ•°ï¼Œæ˜¯è¿™ä¸¤ä¸ªæ•°ä¹‹å’Œç­‰äºç›®æ ‡æ•°ã€‚è¿”å›å…¶åœ¨æ•°ç»„ä¸­çš„ç¼–å· 12345678910public static int[] twoSum(int[] nums, int target) &#123; Map&lt;Integer, Integer&gt; map = new HashMap&lt;&gt;(); for (int i = 0; i &lt; nums.length; i++) &#123; if (map.containsKey(target - nums[i])) &#123; return new int[]&#123;map.get(target - nums[i]), i&#125;; &#125; map.put(nums[i], i); &#125; return null;&#125; èºæ—‹æ‰“å°äºŒç»´æ•°ç»„1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public static void printEdge(int[][] m, int tR, int tC, int dR, int dC) &#123; if (tR == dR) &#123; for (int i = tC; i &lt;= dC; i++) &#123; System.out.print(m[tR][i] + &quot; &quot;); &#125; &#125; else if (tC == dC) &#123; for (int i = tR; i &lt;= dR; i++) &#123; System.out.print(m[i][tC] + &quot; &quot;); &#125; &#125; else &#123; int curC = tC; int curR = tR; while (curC != dC) &#123; System.out.print(m[tR][curC] + &quot; &quot;); curC++; &#125; while (curR != dR) &#123; System.out.print(m[curR][dC] + &quot; &quot;); curR++; &#125; while (curC != tC) &#123; System.out.print(m[dR][curC] + &quot; &quot;); curC--; &#125; while (curR != tR) &#123; System.out.print(m[curR][tC] + &quot; &quot;); curR--; &#125; &#125;&#125;public static void spiralOrderPrint(int[][] matrix) &#123; int tR = 0; int tC = 0; int dR = matrix.length - 1; int dC = matrix[0].length - 1; while (tR &lt;= dR &amp;&amp; tC &lt;= dC) &#123; printEdge(matrix, tR++, tC++, dR--, dC--); &#125;&#125;public static void main(String[] args) &#123; int[][] matrix = &#123; &#123; 1, 2, 3, 4 &#125;, &#123; 5, 6, 7, 8 &#125;, &#123; 9, 10, 11, 12 &#125;, &#123; 13, 14, 15, 16 &#125; &#125;; spiralOrderPrint(matrix);&#125; é“¾è¡¨ å¯¹äºç¬”è¯•ï¼Œä¸ç”¨å¤ªåœ¨ä¹ç©ºé—´å¤æ‚åº¦ï¼Œä¸€åˆ‡ä¸ºäº†æ—¶é—´å¤æ‚åº¦ å¯¹äºé¢è¯•ï¼Œæ—¶é—´å¤æ‚åº¦ä¾ç„¶æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œä½†æ˜¯ä¸€å®šè¦æ‰¾åˆ°ç©ºé—´æœ€çœçš„æ–¹æ³• é‡è¦æŠ€å·§ é¢å¤–æ•°æ®ç»“æ„è®°å½•ï¼ˆå“ˆå¸Œè¡¨ç­‰ï¼‰ å¿«æ…¢æŒ‡é’ˆ é“¾è¡¨åè½¬å•å‘é“¾è¡¨åè½¬123456789// å•å‘é“¾è¡¨èŠ‚ç‚¹public static class Node &#123; public int value; public Node next; public Node(int data) &#123; value = data; &#125;&#125; 1234567891011121314// head å•å‘é“¾è¡¨åè½¬ç®—æ³•// a -&gt; b -&gt; c -&gt; null// c -&gt; b -&gt; a -&gt; nullpublic static Node reverseLinkedList(Node head) &#123; Node pre = null; Node next = null; while (head != null) &#123; next = head.next; head.next = pre; pre = head; head = next; &#125; return pre;&#125; 123456789101112/** * é€’å½’åè½¬æ–¹å¼ */private Node reverseLinkedList(Node head) &#123; if (head == null || head.next == null) &#123; return head; &#125; Node newHead = reverseLinkedList(head.next); head.next.next = head; head.next = null; return newHead;&#125; åŒå‘é“¾è¡¨åè½¬12345678910// åŒå‘é“¾è¡¨èŠ‚ç‚¹public static class DoubleNode &#123; public int value; public DoubleNode last; public DoubleNode next; public DoubleNode(int data) &#123; value = data; &#125;&#125; 12345678910111213// åŒå‘é“¾è¡¨åè½¬ç®—æ³•public static DoubleNode reverseDoubleList(DoubleNode head) &#123; DoubleNode pre = null; DoubleNode next = null; while (head != null) &#123; next = head.next; head.next = pre; head.last = next; pre = head; head = next; &#125; return pre;&#125; æŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹å¿«æ…¢æŒ‡é’ˆåº”ç”¨ æŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹æˆ–ä¸­ç‚¹ä¸Šä¸€ä¸ª1234567891011121314// head å¤´ è§£ï¼šæŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹æˆ–è€…ä¸­ç‚¹å‰ä¸€ä¸ªèŠ‚ç‚¹public static Node midOrUpMidNode(Node head) &#123; if (head == null || head.next == null || head.next.next == null) &#123; return head; &#125; // é“¾è¡¨æœ‰3ä¸ªç‚¹æˆ–ä»¥ä¸Š Node slow = head.next; Node fast = head.next.next; while (fast.next != null &amp;&amp; fast.next.next != null) &#123; slow = slow.next; fast = fast.next.next; &#125; return slow;&#125; æŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹æˆ–ä¸­ç‚¹ä¸‹ä¸€ä¸ª12345678910111213// æŸ¥æ‰¾é“¾è¡¨ä¸­ç‚¹æˆ–è€…ä¸­ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹public static Node midOrDownMidNode(Node head) &#123; if (head == null || head.next == null) &#123; return head; &#125; Node slow = head.next; Node fast = head.next; while (fast.next != null &amp;&amp; fast.next.next != null) &#123; slow = slow.next; fast = fast.next.next; &#125; return slow;&#125; åˆ¤æ–­ä¸€ä¸ªé“¾è¡¨æ˜¯å¦æ˜¯å›æ–‡ç»“æ„ã€é¢˜ç›®ã€‘ç»™å®šä¸€ä¸ªå•å‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹headï¼Œè¯·åˆ¤æ–­è¯¥é“¾è¡¨æ˜¯å¦ä¸ºå›æ–‡ç»“æ„ã€‚ã€ä¾‹å­ã€‘1-&gt;2-&gt;1,è¿”å›true;1-&gt;2-&gt;2-&gt;1,è¿”å›trueï¼›15-&gt;6-&gt;15ï¼Œè¿”å›trueï¼›1-&gt;2-&gt;3ï¼Œè¿”å›falseã€‚å¦‚æœé“¾è¡¨é•¿åº¦ä¸ºNï¼Œæ—¶é—´å¤æ‚åº¦è¾¾åˆ°O(N)ï¼Œé¢å¤–ç©ºé—´å¤æ‚åº¦è¾¾åˆ°O(1)ã€‚ è§£é¢˜æ€è·¯1ï¼š 1ï¼šéå†é“¾è¡¨ï¼ŒæŠŠæ¯ä¸ªå…ƒç´ æ”¾åˆ°æ ˆé‡Œé¢ï¼›2ï¼šä»æ ˆé‡Œé¢ä¾æ¬¡å¼¹å‡ºå…ƒç´ å’ŒåŸæ¥é“¾è¡¨æŒ¨ä¸ªå…ƒç´ æ¯”å¯¹ã€‚ è§£é¢˜æ€è·¯2ï¼š 1ï¼šé€šè¿‡å¿«æ…¢æŒ‡é’ˆæ‰¾åˆ°ä¸­ç‚¹å’Œç»“æŸç‚¹ï¼ŒåªæŠŠå³ä¾§éƒ¨åˆ†æ”¾åˆ°æ ˆé‡Œé¢å»ï¼›2ï¼šä»æ ˆé‡Œé¢ä¾æ¬¡å¼¹å‡ºå…ƒç´ å’ŒåŸæ¥é“¾è¡¨æŒ¨ä¸ªå…ƒç´ æ¯”å¯¹ã€‚ 12345678910111213141516// 1ï¼šéå†é“¾è¡¨ï¼ŒæŠŠæ¯ä¸ªå…ƒç´ æ”¾åˆ°æ ˆé‡Œé¢ï¼›2ï¼šä»æ ˆé‡Œé¢ä¾æ¬¡å¼¹å‡ºå…ƒç´ å’ŒåŸæ¥é“¾è¡¨æŒ¨ä¸ªå…ƒç´ æ¯”å¯¹public static boolean isPalindrome1(Node head) &#123; Stack&lt;Node&gt; stack = new Stack&lt;Node&gt;(); Node cur = head; while (cur != null) &#123; stack.push(cur); cur = cur.next; &#125; while (head != null) &#123; if (head.value != stack.pop().value) &#123; return false; &#125; head = head.next; &#125; return true;&#125; 123456789101112131415161718192021222324// 1ï¼šé€šè¿‡å¿«æ…¢æŒ‡é’ˆæ‰¾åˆ°ä¸­ç‚¹å’Œç»“æŸç‚¹ï¼ŒåªæŠŠå³ä¾§éƒ¨åˆ†æ”¾åˆ°æ ˆé‡Œé¢å»ï¼›2ï¼šä»æ ˆé‡Œé¢ä¾æ¬¡å¼¹å‡ºå…ƒç´ å’ŒåŸæ¥é“¾è¡¨æŒ¨ä¸ªå…ƒç´ æ¯”å¯¹public static boolean isPalindrome2(Node head) &#123; if (head == null || head.next == null) &#123; return true; &#125; Node right = head.next; Node cur = head; while (cur.next != null &amp;&amp; cur.next.next != null) &#123; right = right.next; cur = cur.next.next; &#125; Stack&lt;Node&gt; stack = new Stack&lt;Node&gt;(); while (right != null) &#123; stack.push(right); right = right.next; &#125; while (!stack.isEmpty()) &#123; if (head.value != stack.pop().value) &#123; return false; &#125; head = head.next; &#125; return true;&#125; é“¾è¡¨æ’åºå•å‘é“¾è¡¨åˆ†å·¦ä¸­å³ã€é¢˜ç›®ã€‘ å°†å•å‘é“¾è¡¨æŒ‰ç…§æŸå€¼åˆ’åˆ†æˆå·¦è¾¹å°ï¼Œä¸­é—´ç›¸ç­‰ï¼Œå³è¾¹å¤§çš„å½¢å¼ï¼šç»™å®šä¸€ä¸ªå•é“¾è¡¨å¤´èŠ‚ç‚¹headï¼ŒèŠ‚ç‚¹çš„å€¼ç±»å‹æ˜¯æ•´å‹ï¼Œå†ç»™å®šä¸€ä¸ªæ•´æ•°pivotã€‚å®ç°ä¸€ä¸ªè°ƒæ•´é“¾è¡¨çš„å‡½æ•°ï¼Œå°†é“¾è¡¨è°ƒæ•´ä¸ºåšéƒ¨åˆ†éƒ½æ˜¯å€¼å°äºpivotçš„èŠ‚ç‚¹ï¼Œä¸­é—´éƒ¨åˆ†éƒ½æ˜¯å€¼ç­‰äºpiovtçš„èŠ‚ç‚¹ï¼Œæœ‰éƒ¨åˆ†éƒ½æ˜¯å€¼å¤§äºpiovtçš„èŠ‚ç‚¹ã€‚ã€è¿›é˜¶ã€‘åœ¨å®ç°åŸé—®é¢˜åŠŸèƒ½çš„åŸºç¡€ä¸Šå¢åŠ è¦æ±‚ï¼šå°äºï¼Œç­‰äºï¼Œå¤§äºpivotèŠ‚ç‚¹ä¹‹é—´é¡ºåºå’Œä¹‹å‰ä¸€æ ·ï¼Œæ—¶é—´å¤æ‚åº¦O(N)ï¼Œé¢å¤–ç©ºé—´å¤æ‚åº¦O(1)ã€‚ è§£é¢˜æ€è·¯1ï¼š å°†é“¾è¡¨æ”¾å…¥æ•°ç»„ï¼Œæ’åºï¼Œå†è½¬æˆé“¾è¡¨ è§£é¢˜æ€è·¯2ï¼š å·¦ä¸­å³åˆ†åˆ«å‡†å¤‡ä¸¤ä¸ªæŒ‡é’ˆ(å…±6ä¸ªå˜é‡)ï¼Œç„¶åéå†åŸé“¾è¡¨ï¼Œæ’åºä¹‹ååˆ†åˆ«æ’å…¥ç›¸åº”ä½ç½®(è€ƒè™‘è¾¹ç•Œé—®é¢˜) 12345678910111213141516171819202122232425262728293031323334353637383940414243444546// å°†é“¾è¡¨æ”¾å…¥æ•°ç»„ï¼Œæ’åºï¼Œå†è½¬æˆé“¾è¡¨public static Node listPartition1(Node head, int pivot) &#123; if (head == null) &#123; return head; &#125; Node cur = head; int i = 0; while (cur != null) &#123; i++; cur = cur.next; &#125; Node[] nodeArr = new Node[i]; i = 0; cur = head; for (i = 0; i != nodeArr.length; i++) &#123; nodeArr[i] = cur; cur = cur.next; &#125; arrPartition(nodeArr, pivot); for (i = 1; i != nodeArr.length; i++) &#123; nodeArr[i - 1].next = nodeArr[i]; &#125; nodeArr[i - 1].next = null; return nodeArr[0];&#125;public static void arrPartition(Node[] nodeArr, int pivot) &#123; int small = -1; int big = nodeArr.length; int index = 0; while (index != big) &#123; if (nodeArr[index].value &lt; pivot) &#123; swap(nodeArr, ++small, index++); &#125; else if (nodeArr[index].value == pivot) &#123; index++; &#125; else &#123; swap(nodeArr, --big, index); &#125; &#125;&#125;public static void swap(Node[] nodeArr, int a, int b) &#123; Node tmp = nodeArr[a]; nodeArr[a] = nodeArr[b]; nodeArr[b] = tmp;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354// å·¦ä¸­å³åˆ†åˆ«å‡†å¤‡ä¸¤ä¸ªæŒ‡é’ˆ(å…±6ä¸ªå˜é‡)ï¼Œç„¶åéå†åŸé“¾è¡¨ï¼Œæ’åºä¹‹ååˆ†åˆ«æ’å…¥ç›¸åº”ä½ç½®(è€ƒè™‘è¾¹ç•Œé—®é¢˜)public static Node listPartition2(Node head, int pivot) &#123; Node sH = null; // small head Node sT = null; // small tail Node eH = null; // equal head Node eT = null; // equal tail Node mH = null; // big head Node mT = null; // big tail Node next = null; // save next node // every node distributed to three lists while (head != null) &#123; next = head.next; head.next = null; if (head.value &lt; pivot) &#123; if (sH == null) &#123; sH = head; sT = head; &#125; else &#123; sT.next = head; sT = head; &#125; &#125; else if (head.value == pivot) &#123; if (eH == null) &#123; eH = head; eT = head; &#125; else &#123; eT.next = head; eT = head; &#125; &#125; else &#123; if (mH == null) &#123; mH = head; mT = head; &#125; else &#123; mT.next = head; mT = head; &#125; &#125; head = next; &#125; // å°äºåŒºåŸŸçš„å°¾å·´ï¼Œè¿ç­‰äºåŒºåŸŸçš„å¤´ï¼Œç­‰äºåŒºåŸŸçš„å°¾å·´è¿å¤§äºåŒºåŸŸçš„å¤´ if (sT != null) &#123; // å¦‚æœæœ‰å°äºåŒºåŸŸ sT.next = eH; eT = eT == null ? sT : eT; // ä¸‹ä¸€æ­¥ï¼Œè°å»è¿å¤§äºåŒºåŸŸçš„å¤´ï¼Œè°å°±å˜æˆeT &#125; // ä¸‹ä¸€æ­¥ï¼Œä¸€å®šæ˜¯éœ€è¦ç”¨eT å»æ¥ å¤§äºåŒºåŸŸçš„å¤´ // æœ‰ç­‰äºåŒºåŸŸï¼ŒeT -&gt; ç­‰äºåŒºåŸŸçš„å°¾ç»“ç‚¹ // æ— ç­‰äºåŒºåŸŸï¼ŒeT -&gt; å°äºåŒºåŸŸçš„å°¾ç»“ç‚¹ // eT å°½é‡ä¸ä¸ºç©ºçš„å°¾å·´èŠ‚ç‚¹ if (eT != null) &#123; // å¦‚æœå°äºåŒºåŸŸå’Œç­‰äºåŒºåŸŸï¼Œä¸æ˜¯éƒ½æ²¡æœ‰ eT.next = mH; &#125; return sH != null ? sH : (eH != null ? eH : mH);&#125; é“¾è¡¨é—­ç¯åŠç›¸äº¤é—®é¢˜å•é“¾è¡¨æŸ¥æ‰¾é—­ç¯ä½ç½®æ³¨ï¼šå•é“¾è¡¨é—­ç¯åªèƒ½æœ‰ä¸€ä¸ªç¯ï¼Œå¦‚æœäº§ç”Ÿç¯ï¼Œå¿…ç„¶ä¼šå‡ºç°é—­ç¯ è§£æ³•1ï¼šé¢å¤–ç©ºé—´è§£å†³ ç”³è¯·ä¸€ä¸ªseté›†åˆï¼Œä»å¤´èŠ‚ç‚¹éå†é“¾è¡¨ï¼Œæ¯éå†ä¸€ä¸ªå…ƒç´ å°±æŸ¥è¯¢è¯¥èŠ‚ç‚¹æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœæ²¡æœ‰å°±æŠŠè¯¥èŠ‚ç‚¹æ”¾è¿›å»ï¼Œå¦‚æœæœ‰ï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯ç¯ä½ç½® 1.... è§£æ³•2ï¼šæœ‰é™å‡ ä¸ªå˜é‡è§£å†³ å¿«æ…¢æŒ‡é’ˆä»å•é“¾è¡¨å¤´èŠ‚ç‚¹å¼€å§‹èµ°ï¼Œç›´è‡³ä¸¤ä¸ªèŠ‚ç‚¹ç›¸é‡ï¼Œè¯´æ˜æœ‰ç¯ï¼Œæœ€åæŒ‡å‘nullï¼Œè¯´æ˜æ— ç¯ ç›¸é‡ä¹‹åå¿«æŒ‡é’ˆå›åˆ°å¤´èŠ‚ç‚¹ï¼Œä¹‹åä¸€æ¬¡èµ°ä¸€æ­¥ï¼Œæ…¢æŒ‡é’ˆåœåœ¨åŸåœ°ï¼Œå†æ¬¡ç›¸é‡çš„ä½ç½®å³æ˜¯ç¯èŠ‚ç‚¹ä½ç½®(è®°ä½ç»“è®ºï¼Œä¸è¦é—®ä¸ºä»€ä¹ˆ) 123456789101112131415161718192021222324252627282930public static class Node &#123; public int value; public Node next; public Node(int data) &#123; this.value = data; &#125;&#125;// æ‰¾åˆ°é“¾è¡¨ç¬¬ä¸€ä¸ªå…¥ç¯èŠ‚ç‚¹ï¼Œå¦‚æœæ— ç¯ï¼Œè¿”å›nullpublic static Node getLoopNode(Node head) &#123; if (head == null || head.next == null || head.next.next == null) &#123; return null; &#125; // n1 æ…¢ n2 å¿« Node slow = head.next; // n1 -&gt; slow Node fast = head.next.next; // n2 -&gt; fast while (slow != fast) &#123; if (fast.next == null || fast.next.next == null) &#123; return null; &#125; fast = fast.next.next; slow = slow.next; &#125; // slow fast ç›¸é‡ fast = head; // n2 -&gt; walk again from head while (slow != fast) &#123; slow = slow.next; fast = fast.next; &#125; return slow;&#125; ä¸¤ä¸ªæ— ç¯é“¾è¡¨äº¤ç‚¹ä½ç½®æ³¨ï¼š å¦‚æœä¸¤ä¸ªå•å‘é“¾è¡¨ç›¸äº¤ï¼Œç›¸äº¤åé¢çš„éƒ¨åˆ†å¿…ç„¶æ˜¯å…±æœ‰çš„ï¼Œé‚£ä¹ˆä¸¤ä¸ªé“¾è¡¨æœ€åçš„é‚£ä¸ªèŠ‚ç‚¹å¿…ç„¶æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ é•¿é“¾è¡¨å…ˆèµ°ä¸¤ä¸ªé“¾è¡¨å·®å€¼çš„æ­¥æ•°ï¼Œç„¶åçŸ­é“¾è¡¨åœ¨å¼€å§‹èµ°ï¼Œä»–ä¿©ä¸€å®šä¼šåœ¨ç¬¬ä¸€ä¸ªç›¸äº¤çš„ä½ç½®ç›¸é‡ 123456789101112131415161718192021222324252627282930313233// å¦‚æœä¸¤ä¸ªé“¾è¡¨éƒ½æ— ç¯ï¼Œè¿”å›ç¬¬ä¸€ä¸ªç›¸äº¤èŠ‚ç‚¹ï¼Œå¦‚æœä¸æƒ³äº¤ï¼Œè¿”å›nullpublic static Node noLoop(Node head1, Node head2) &#123; if (head1 == null || head2 == null) &#123; return null; &#125; Node cur1 = head1; Node cur2 = head2; int n = 0; while (cur1.next != null) &#123; n++; cur1 = cur1.next; &#125; while (cur2.next != null) &#123; n--; cur2 = cur2.next; &#125; if (cur1 != cur2) &#123; return null; &#125; // n : é“¾è¡¨1é•¿åº¦å‡å»é“¾è¡¨2é•¿åº¦çš„å€¼ cur1 = n &gt; 0 ? head1 : head2; // è°é•¿ï¼Œè°çš„å¤´å˜æˆcur1 cur2 = cur1 == head1 ? head2 : head1; // è°çŸ­ï¼Œè°çš„å¤´å˜æˆcur2 n = Math.abs(n); while (n != 0) &#123; n--; cur1 = cur1.next; &#125; while (cur1 != cur2) &#123; cur1 = cur1.next; cur2 = cur2.next; &#125; return cur1;&#125; ä¸¤æ¡æœ‰ç¯é“¾è¡¨æŸ¥æ‰¾äº¤ç‚¹åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šå…¥ç¯èŠ‚ç‚¹å¯èƒ½æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚å›¾ æƒ…å†µ1ï¼šå…¥ç¯èŠ‚ç‚¹å¯èƒ½æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯æ±‚å•é“¾è¡¨çš„ç¬¬ä¸€ä¸ªç¯èŠ‚ç‚¹é—®é¢˜ï¼Œåªä¸è¿‡ä»ç›¸äº¤ä½ç½®å¼€å§‹èµ° æƒ…å†µ2ï¼šå¦‚æœé“¾è¡¨1åœ¨è½¬å›åˆ°è‡ªå·±çš„è¿‡ç¨‹ä¸­æ²¡æœ‰é‡åˆ°é“¾è¡¨2ï¼Œå°±è¯´æ˜æ˜¯å„è‡ªæˆç¯çš„ï¼Œç›¸äº¤èŠ‚ç‚¹è¿”å›ç©ºå°±é†’æ¥ï¼Œå¦‚æœé‡åˆ°ï¼Œå°±æ˜¯æƒ…å†µ2ï¼Œè¿”å›ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œéƒ½å¯¹ï¼Œéƒ½å±äºç¬¬ä¸€ä¸ªç›¸äº¤çš„èŠ‚ç‚¹ 123456789101112131415161718192021222324252627282930313233343536373839// ä¸¤ä¸ªæœ‰ç¯é“¾è¡¨ï¼Œè¿”å›ç¬¬ä¸€ä¸ªç›¸äº¤èŠ‚ç‚¹ï¼Œå¦‚æœä¸æƒ³äº¤è¿”å›nullpublic static Node bothLoop(Node head1, Node loop1, Node head2, Node loop2) &#123; Node cur1 = null; Node cur2 = null; if (loop1 == loop2) &#123; cur1 = head1; cur2 = head2; int n = 0; while (cur1 != loop1) &#123; n++; cur1 = cur1.next; &#125; while (cur2 != loop2) &#123; n--; cur2 = cur2.next; &#125; cur1 = n &gt; 0 ? head1 : head2; cur2 = cur1 == head1 ? head2 : head1; n = Math.abs(n); while (n != 0) &#123; n--; cur1 = cur1.next; &#125; while (cur1 != cur2) &#123; cur1 = cur1.next; cur2 = cur2.next; &#125; return cur1; &#125; else &#123; cur1 = loop1.next; while (cur1 != loop1) &#123; if (cur1 == loop2) &#123; return loop1; &#125; cur1 = cur1.next; &#125; return null; &#125;&#125; æŸ¥æ‰¾ä¸¤ä¸ªé“¾è¡¨ç›¸äº¤èŠ‚ç‚¹æ³¨ï¼šéš¾ç‚¹ä¸ºè€ƒè™‘æ˜¯å¦æœ‰ç¯ï¼Œæœ‰ç¯é“¾è¡¨ç›¸äº¤ä»¥åŠæ— ç¯é“¾è¡¨ç›¸äº¤é—®é¢˜ï¼Œæ²¡æœ‰ç”¨åˆ°é¢å¤–æ•°æ®ç»“æ„ï¼Œåªç”¨åˆ°æœ‰é™å‡ ä¸ªå˜é‡ 1234567891011121314151617public static Node getIntersectNode(Node head1, Node head2) &#123; if (head1 == null || head2 == null) &#123; return null; &#125; // åˆ†åˆ«æ‰¾åˆ°ä¸¤ä¸ªé“¾è¡¨çš„ç¯ä½ç½® Node loop1 = getLoopNode(head1); Node loop2 = getLoopNode(head2); if (loop1 == null &amp;&amp; loop2 == null) &#123; // æ— ç¯é“¾è¡¨ç›¸äº¤é—®é¢˜ return noLoop(head1, head2); &#125; if (loop1 != null &amp;&amp; loop2 != null) &#123; // ä¸¤æ¡æœ‰ç¯é“¾è¡¨ç›¸äº¤é—®é¢˜ return bothLoop(head1, loop1, head2, loop2); &#125; return null;&#125; äºŒå‰æ ‘æ•°æ®ç»“æ„ 12345678public static class Node &#123; public int value; public Node left; public Node right; public Node(int v) &#123; value = v; &#125;&#125; äºŒå‰æ ‘éå† å…ˆåºéå†ï¼šå¤´-&gt;å·¦-&gt;å³ ä¸­åºéå†ï¼šå·¦-&gt;å¤´-&gt;å³ ååºéå†ï¼šå·¦-&gt;å³-&gt;å¤´ é€’å½’éå†äºŒå‰æ ‘éå†è¯´æ˜ é€’å½’é€šè¿‡æ‰“å°æ—¶æœºä¸åŒï¼Œå®ç°å…ˆï¼Œä¸­ï¼Œååºéå† 12345678910public static void f(Node head) &#123; if (head == null) &#123; return; &#125; // 1 å‰åº f(head.left); // 2 ä¸­åº f(head.right); // 3 ååº&#125; éé€’å½’éå†äºŒå‰æ ‘ å…ˆåºéå†(æ·±åº¦æ€§éå†) å‡†å¤‡ä¸€ä¸ªæ ˆï¼Œæ ¹èŠ‚ç‚¹å…¥æ ˆå¼¹å‡ºï¼Œæ‰“å°ï¼Œç„¶åå…ˆå‹å³ï¼Œå†å‹å·¦ å¼¹å‡ºæ‰“å°ï¼Œå…ˆå‹å³å†å‹å·¦ï¼Œå‘¨è€Œå¤å§‹ 123456789101112131415161718public static void pre(Node head) &#123; System.out.print(&quot;pre-order: &quot;); if (head != null) &#123; Stack&lt;Node&gt; stack = new Stack&lt;Node&gt;(); stack.add(head); while (!stack.isEmpty()) &#123; head = stack.pop(); System.out.print(head.value + &quot; &quot;); if (head.right != null) &#123; stack.push(head.right); &#125; if (head.left != null) &#123; stack.push(head.left); &#125; &#125; &#125; System.out.println();&#125; ååºéå† åœ¨å…ˆåºéå†çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¢åŠ ä¸€ä¸ªæ”¶é›†æ ˆï¼Œå¼¹å‡ºæ¥å°±æ”¾åˆ°æ”¶é›†æ ˆä¸­(ä¸æ‰“å°)ï¼Œç„¶åå…ˆå‹å·¦ï¼Œå†å‹å³ æŠŠæ”¶é›†æ ˆä¸­çš„å…ƒç´ ä¾æ¬¡å‡ºæ ˆï¼Œæ‰“å° 1234567891011121314151617181920212223public static void pos1(Node head) &#123; System.out.print(&quot;pos-order: &quot;); if (head != null) &#123; Stack&lt;Node&gt; s1 = new Stack&lt;Node&gt;(); Stack&lt;Node&gt; s2 = new Stack&lt;Node&gt;(); s1.push(head); while (!s1.isEmpty()) &#123; head = s1.pop(); // å¤´ å³ å·¦ s2.push(head); if (head.left != null) &#123; s1.push(head.left); &#125; if (head.right != null) &#123; s1.push(head.right); &#125; &#125; // å·¦ å³ å¤´ while (!s2.isEmpty()) &#123; System.out.print(s2.pop().value + &quot; &quot;); &#125; &#125; System.out.println();&#125; ä¸­åºéå† æ•´æ£µæ ‘å·¦è¾¹ç•Œè¿›æ ˆï¼Œä¾æ¬¡å¼¹å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œæ‰“å°ï¼Œå¯¹å¼¹å‡ºèŠ‚ç‚¹çš„å³æ ‘å‘¨è€Œå¤å§‹ ä¸ºä»€ä¹ˆï¼Ÿ å› ä¸ºæ•´ä¸ªæ ‘éƒ½ä¼šè¢«ä»–çš„å·¦è¾¹ç•Œåˆ†è§£æ‰ï¼Œæˆ‘ä»¬æŠŠå¤´å’Œå·¦è¾¹ç•Œå‹æ ˆï¼Œç„¶åå†å³ï¼Œå‡ºæ ˆçš„æ—¶å€™å°±æ˜¯å·¦ï¼Œå¤´ï¼Œå³ 1234567891011121314151617public static void in(Node cur) &#123; System.out.print(&quot;in-order: &quot;); if (cur != null) &#123; Stack&lt;Node&gt; stack = new Stack&lt;Node&gt;(); while (!stack.isEmpty() || cur != null) &#123; if (cur != null) &#123; stack.push(cur); cur = cur.left; &#125; else &#123; cur = stack.pop(); System.out.print(cur.value + &quot; &quot;); cur = cur.right; &#125; &#125; &#125; System.out.println();&#125; å®½åº¦éå†å®½åº¦éå†å°±æ˜¯æ¨ªç€éå†ï¼Œä¹Ÿæ˜¯å±‚æ¬¡éå† ç”¨é˜Ÿåˆ—ï¼Œå¤´èŠ‚ç‚¹æ”¾é˜Ÿåˆ—ï¼Œæ¯ä¸€æ¬¡å¼¹å‡ºå°±æ‰“å°ï¼Œç„¶åå…ˆæ”¾å·¦å†æ”¾å³ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å‡ºé˜Ÿåˆ—éƒ½æ˜¯å…ˆæ”¾å·¦å†æ”¾å³ 123456789101112131415161718// ä»nodeå‡ºå‘ï¼Œè¿›è¡Œå®½åº¦ä¼˜å…ˆéå†public static void width(Node head) &#123; if (head == null) &#123; return; &#125; Queue&lt;Node&gt; queue = new LinkedList&lt;&gt;(); queue.add(head); while (!queue.isEmpty()) &#123; Node cur = queue.poll(); System.out.println(cur.value); if (cur.left != null) &#123; queue.add(cur.left); &#125; if (cur.right != null) &#123; queue.add(cur.right); &#125; &#125;&#125; æ±‚äºŒå‰æ ‘çš„æœ€å¤§å®½åº¦(éš¾)åˆ†æï¼šå®½åº¦æ€§éå†çš„æ—¶å€™è¦çŸ¥é“æ¯ä¸€å±‚çš„èŠ‚ç‚¹ä¸ªæ•° è§£ï¼šéå†æ¯ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼ŒçŸ¥é“ä»–åœ¨ç¬¬å‡ å±‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667// ç”¨hashè¡¨çš„è§£æ³•public static int maxWidthUseMap(Node head) &#123; if (head == null) &#123; return 0; &#125; Queue&lt;Node&gt; queue = new LinkedList&lt;&gt;(); queue.add(head); // key åœ¨ å“ªä¸€å±‚ï¼Œvalue HashMap&lt;Node, Integer&gt; levelMap = new HashMap&lt;&gt;(); levelMap.put(head, 1); int curLevel = 1; // å½“å‰ä½ æ­£åœ¨ç»Ÿè®¡å“ªä¸€å±‚çš„å®½åº¦ int curLevelNodes = 0; // å½“å‰å±‚curLevelå±‚ï¼Œå®½åº¦ç›®å‰æ˜¯å¤šå°‘ int max = 0; while (!queue.isEmpty()) &#123; Node cur = queue.poll(); int curNodeLevel = levelMap.get(cur); if (cur.left != null) &#123; levelMap.put(cur.left, curNodeLevel + 1); queue.add(cur.left); &#125; if (cur.right != null) &#123; levelMap.put(cur.right, curNodeLevel + 1); queue.add(cur.right); &#125; if (curNodeLevel == curLevel) &#123; curLevelNodes++; &#125; else &#123; max = Math.max(max, curLevelNodes); curLevel++; curLevelNodes = 1; &#125; &#125; max = Math.max(max, curLevelNodes); return max;&#125;// ä¸ç”¨hashè¡¨çš„æ–¹æ³• (éš¾åº¦é«˜)public static int maxWidthNoMap(Node head) &#123; if (head == null) &#123; return 0; &#125; Queue&lt;Node&gt; queue = new LinkedList&lt;&gt;(); queue.add(head); Node curEnd = head; // å½“å‰å±‚ï¼Œæœ€å³èŠ‚ç‚¹æ˜¯è° Node nextEnd = null; // ä¸‹ä¸€å±‚ï¼Œæœ€å³èŠ‚ç‚¹æ˜¯è° int max = 0; int curLevelNodes = 0; // å½“å‰å±‚çš„èŠ‚ç‚¹æ•° while (!queue.isEmpty()) &#123; Node cur = queue.poll(); if (cur.left != null) &#123; queue.add(cur.left); nextEnd = cur.left; &#125; if (cur.right != null) &#123; queue.add(cur.right); nextEnd = cur.right; &#125; curLevelNodes++; if (cur == curEnd) &#123; max = Math.max(max, curLevelNodes); curLevelNodes = 0; curEnd = nextEnd; &#125; &#125; return max;&#125; æŠ˜çº¸é—®é¢˜ ç»“æœå¯çœ‹åšå¤´èŠ‚ç‚¹æ˜¯å‡¹ï¼Œæ‰€æœ‰çš„å·¦å­æ ‘å¤´èŠ‚ç‚¹éƒ½æ˜¯å‡¹ï¼Œæ‰€æœ‰å³å­æ ‘å¤´è‚©ç‚¹éƒ½æ˜¯å‡¸çš„äºŒå‰æ ‘ ä¸­åºéå†å³å¯æ‰“å°å‡ºä»ä¸Šåˆ°ä¸‹çš„æ‰€æœ‰ç»“æ„ 12345678910111213141516public static void main(String[] args) &#123; int N = 4; process(1, N, true);&#125;// è¿™ä¸ªèŠ‚ç‚¹åœ¨ç¬¬iå±‚ï¼Œä¸€å…±æœ‰Nå±‚ï¼ŒNå›ºå®šä¸å˜çš„// è¿™ä¸ªèŠ‚ç‚¹å¦‚æœæ˜¯å‡¹çš„è¯ï¼Œdown = T// è¿™ä¸ªèŠ‚ç‚¹å¦‚æœæ˜¯å‡¸çš„è¯ï¼Œdown = F// å‡½æ•°çš„åŠŸèƒ½ï¼šä¸­åºæ‰“å°ä»¥ä½ æƒ³è±¡çš„èŠ‚ç‚¹ä¸ºå¤´çš„æ•´æ£µæ ‘ï¼public static void process(int i, int N, boolean down) &#123; if (i &gt; N) &#123; return; &#125; process(i + 1, N, true); System.out.print(down ? &quot;å‡¹ &quot; : &quot;å‡¸ &quot;); process(i + 1, N, false);&#125; æœç´¢äºŒå‰æ ‘(é€’å½’å¥—è·¯) é¢˜ç›®ï¼šå¦‚ä½•åˆ¤æ–­ä¸€é¢—äºŒå‰æ ‘æ˜¯æœç´¢äºŒå‰æ ‘ï¼Ÿ æœç´¢äºŒå‰æ ‘çš„ç‰¹ç‚¹ï¼šä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå·¦å­æ ‘çš„èŠ‚ç‚¹ä¸€å®šæ¯”å®ƒå°ï¼Œå³å­æ ‘çš„èŠ‚ç‚¹ä¸€å®šæ¯”å®ƒå¤§ è§£é¢˜ï¼š ä¸­åºéå†ä¸€å®šæ˜¯å‡åºï¼Œå¦‚æœæŸä¸ªä½ç½®æœ‰é™åºï¼Œä¸€å®šä¸æ˜¯æœç´¢äºŒå‰æ ‘ é€’å½’å¥—è·¯é¢˜è§£ :å‘æˆ‘å·¦æ ‘è¦ä¿¡æ¯ï¼Œå³æ ‘è¦ä¿¡æ¯ï¼Œå·¦æ ‘å¿…é¡»æ˜¯æœç´¢äºŒå‰æ ‘ä¸”å·¦æ ‘æœ€å¤§å€¼å°äºæˆ‘ï¼Œå³æ ‘æ˜¯æœç´¢äºŒå‰æ ‘å¹¶ä¸”æœ€å°å€¼å¤§äºæˆ‘ï¼›å·¦æ ‘ä¿¡æ¯ï¼š1.æ˜¯å¦æ˜¯æœç´¢äºŒå‰æ ‘ï¼Œ2.æœ€å¤§å€¼ï¼Œ3.æœ€å°å€¼ï¼›å³æ ‘ä¹Ÿæ˜¯ æ³¨æ„ï¼šé€’å½’å¥—è·¯ï¼Œå¯ä»¥è§£å†³ä¸€åˆ‡æ ‘å½¢DP é—®é¢˜ï¼Œæ— éæ˜¯å¯èƒ½æ€§çš„ç½—åˆ—æœ‰éš¾åº¦ 12345678910111213141516171819202122232425262728293031323334// è§£æ³•1ï¼š é¢å¤–å¼•å…¥æ•°ç»„// èŠ‚ç‚¹public static class Node &#123; public int value; public Node left; public Node right; public Node(int data) &#123; this.value = data; &#125;&#125;// ä¸­åºéå†åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç„¶ååˆ¤æ–­æ•°ç»„æ˜¯ä¸æ˜¯å‡åºpublic static boolean isBST1(Node head) &#123; if (head == null) &#123; return true; &#125; ArrayList&lt;Node&gt; arr = new ArrayList&lt;&gt;(); in(head, arr); for (int i = 1; i &lt; arr.size(); i++) &#123; if (arr.get(i).value &lt;= arr.get(i - 1).value) &#123; return false; &#125; &#125; return true;&#125;// ä¸­åºéå†public static void in(Node head, ArrayList&lt;Node&gt; arr) &#123; if (head == null) &#123; return; &#125; in(head.left, arr); arr.add(head); in(head.right, arr);&#125; 12345678910111213141516171819// è§£æ³•2ï¼šé€’å½’æ–¹å¼public static int preValue = Integer.MIN_VALUE;public static boolean checkBST(Node head) &#123; if (head == null) &#123; return true; &#125; boolean checkLeft = checkBST(head.left); if (!checkLeft) &#123; return false; &#125; // ä¸­åºæ‰“å°çš„æ—¶æœºï¼Œæ¢æˆäº†ä¸­åºæ¯”è¾ƒçš„æ—¶æœº if (head.value &lt;= preValue) &#123; return false; &#125; else &#123; preValue = head.value; &#125; return checkBST(head.right);&#125; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253// è§£æ³•3ï¼šé€’å½’å¥—è·¯/** * é€’å½’è¿”å›å€¼ */public static class Info &#123; public boolean isBST; // æ˜¯å¦æ˜¯æœç´¢äºŒå‰æ ‘ public int max; // æœ€å¤§å€¼ public int min; // æœ€å°å€¼ public Info(boolean i, int ma, int mi) &#123; isBST = i; max = ma; min = mi; &#125;&#125;public static Info process(Node x) &#123; if (x == null) &#123; return null; &#125; Info leftInfo = process(x.left); Info rightInfo = process(x.right); int min = x.value; int max = x.value; // æœ€å°å€¼å’Œæœ€å¤§å€¼å°±æ˜¯æˆ‘å½“å‰èŠ‚ç‚¹çš„å€¼å’Œå®ƒæ¯”è¾ƒå¾—å‡ºçš„æœ€å°å€¼å’Œæœ€å¤§å€¼ if (leftInfo != null) &#123; min = Math.min(min, leftInfo.min); max = Math.max(max, leftInfo.max); &#125; if (rightInfo != null) &#123; min = Math.min(min, rightInfo.min); max = Math.max(max, rightInfo.max); &#125; // æ˜¯å¦æ˜¯æœç´¢äºŒå‰æ ‘ boolean isBST = true; // å·¦è¾¹æœ‰ä¿¡æ¯å¹¶ä¸”å·¦è¾¹ä¸æ˜¯æœç´¢äºŒå‰æ ‘ if (leftInfo != null &amp;&amp; !leftInfo.isBST) &#123; isBST = false; &#125; if (rightInfo != null &amp;&amp; !rightInfo.isBST) &#123; isBST = false; &#125; // å·¦è¾¹æœ‰ä¿¡æ¯ï¼Œä½†æ˜¯å·¦è¾¹çš„æœ€å¤§å€¼å¤§äºç­‰äºæˆ‘çš„å€¼ if (leftInfo != null &amp;&amp; leftInfo.max &gt;= x.value) &#123; isBST = false; &#125; // å³è¾¹æœ‰ä¿¡æ¯ï¼Œå³è¾¹çš„æœ€å°å€¼å°äºç­‰äºæˆ‘å½“å‰å€¼ if (rightInfo != null &amp;&amp; rightInfo.min &lt;= x.value) &#123; isBST = false; &#125; return new Info(isBST, max, min);&#125; å®Œå…¨äºŒå‰æ ‘ å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªäºŒå‰æ ‘æ˜¯å®Œå…¨äºŒå‰æ ‘ å®Œå…¨äºŒå‰æ ‘ï¼šä¸€é¢—äºŒå‰æ ‘ä»å·¦åˆ°å³æ˜¯ä¾æ¬¡å˜æ»¡çš„ï¼Œå³ä½¿ä¸æ»¡ï¼Œä¹Ÿæ˜¯å˜æ»¡çš„æ ·å­ è§£é¢˜ï¼šäºŒå‰æ ‘å®½åº¦éå†ï¼Œ1.ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹å¦‚æœæœ‰æœ‰èŠ‚ç‚¹ï¼Œæ²¡å·¦èŠ‚ç‚¹ï¼Œfalseï¼›2.åœ¨ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸è¿è§„æƒ…å†µï¼Œå¦‚æœé‡åˆ°ç¬¬ä¸€ä¸ªå·¦å³ä¸¤ä¸ªèŠ‚ç‚¹ä¸åŒå…¨æƒ…å†µï¼Œæ¥ä¸‹æ¥é‡åˆ°çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¿…é¡»æ˜¯å¶å­èŠ‚ç‚¹ 1234567891011121314151617181920212223242526272829303132public static boolean isCBT(Node head) &#123; if (head == null) &#123; return true; &#125; LinkedList&lt;Node&gt; queue = new LinkedList&lt;&gt;(); // æ˜¯å¦é‡åˆ°è¿‡å·¦å³ä¸¤ä¸ªå­©å­ä¸åŒå…¨çš„èŠ‚ç‚¹ boolean leaf = false; Node l = null; Node r = null; queue.add(head); while (!queue.isEmpty()) &#123; head = queue.poll(); l = head.left; r = head.right; // å¦‚æœé‡åˆ°äº†ä¸åŒå…¨çš„èŠ‚ç‚¹ä¹‹åï¼Œåˆå‘ç°å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¶èŠ‚ç‚¹ if ((leaf &amp;&amp; (l != null || r != null)) || (l == null &amp;&amp; r != null)) &#123; return false; &#125; if (l != null) &#123; queue.add(l); &#125; if (r != null) &#123; queue.add(r); &#125; // é‡åˆ°å·¦å³ä¸¤ä¸ªèŠ‚ç‚¹ä¸åŒå…¨çš„æƒ…å†µï¼Œä¿®æ”¹æ ‡è®° if (l == null || r == null) &#123; leaf = true; &#125; &#125; return true;&#125; å¹³è¡¡äºŒå‰æ ‘ å¦‚ä½•åˆ¤æ–­ä¸€æ£µæ ‘æ˜¯å¹³è¡¡äºŒå‰æ ‘ å¹³è¡¡äºŒå‰æ ‘ç‰¹æ€§ï¼šå¯¹äºä»»ä½•ä¸€ä¸ªå­æ ‘æ¥è¯´ï¼Œå·¦æ ‘çš„é«˜åº¦å’Œå³æ ‘çš„é«˜åº¦å·®ï¼Œéƒ½ä¸è¶…è¿‡1 è§£å†³æ€è·¯ï¼šå‡è®¾æˆ‘å¯ä»¥å‘æˆ‘çš„å·¦æ ‘è¦ä¿¡æ¯ï¼Œå¯ä»¥å‘å³æ ‘è¦ä¿¡æ¯ï¼Œå¦‚æœæˆ‘æ•´æ£µæ ‘æ˜¯å¹³è¡¡äºŒå‰æ ‘ï¼Œæˆ‘å·¦æ ‘å¾—æ˜¯å¹³çš„ï¼Œå³æ ‘å¾—æ˜¯å¹³çš„ï¼Œå¯¹äºXèŠ‚ç‚¹æ¥è¯´ï¼Œå·¦æ ‘-å³æ ‘é«˜åº¦å·®&lt;=1ï¼›æˆ‘å‘å·¦æ ‘è¦ä¿¡æ¯ï¼š1.æ˜¯å¦æ˜¯å¹³çš„ï¼›2.é«˜åº¦æ˜¯å¤šå°‘ï¼Œå³æ ‘è¦ä¿¡æ¯ï¼š1.æ˜¯å¦æ˜¯å¹³çš„ï¼›2.é«˜åº¦æ˜¯å¤šå°‘ 12345678910111213141516171819202122232425262728293031323334/** * è¿”å›å€¼ä¿¡æ¯ */public static class Info &#123; public boolean isBalanced; public int height; public Info(boolean i, int h) &#123; isBalanced = i; height = h; &#125;&#125;public static Info process(Node x) &#123; if (x == null) &#123; return new Info(true, 0); &#125; Info leftInfo = process(x.left); Info rightInfo = process(x.right); // xä¸ºå¤´çš„èŠ‚ç‚¹çš„é«˜åº¦ï¼šå·¦æ ‘å’Œå³æ ‘è¾ƒå¤§çš„é‚£ä¸ªé«˜åº¦å†åŠ ä¸Šæˆ‘è‡ªå·±(+1) int height = Math.max(leftInfo.height, rightInfo.height) + 1; // æ˜¯å¦æ˜¯å¹³è¡¡æ ‘ï¼šæˆ‘å·¦æ ‘å¾—æ˜¯å¹³è¡¡ï¼Œå³æ ‘å¾—æ˜¯å¹³è¡¡æ ‘ï¼Œå¹¶ä¸”æˆ‘å·¦æ ‘å’Œå³æ ‘çš„é«˜åº¦å·®çš„ç»å¯¹å€¼å¾—å°äº2 boolean isBalanced = true; if (!leftInfo.isBalanced) &#123; isBalanced = false; &#125; if (!rightInfo.isBalanced) &#123; isBalanced = false; &#125; if (Math.abs(leftInfo.height - rightInfo.height) &gt; 1) &#123; isBalanced = false; &#125; return new Info(isBalanced, height);&#125; æ»¡äºŒå‰æ ‘ å¦‚ä½•åˆ¤æ–­ä¸€æ£µæ ‘æ˜¯æ»¡äºŒå‰æ ‘ æ ‘æœ€å¤§æ·±åº¦Lï¼ŒèŠ‚ç‚¹ä¸ªæ•°Nï¼Œæ»¡è¶³N=2(Læ¬¡æ–¹)-1 è§£æ³•(é€’å½’å¥—è·¯)ï¼šå…ˆæ±‚äºŒå‰æ ‘æœ€å¤§æ·±åº¦Lï¼Œå†æ±‚èŠ‚ç‚¹ä¸ªæ•°Nï¼Œæ»¡è¶³N=2(Læ¬¡æ–¹)-1 12345678910111213141516171819202122232425262728293031323334// æ»¡äºŒå‰æ ‘è§£æ³•ï¼šé€’å½’å¥—è·¯/** * è¿”å›å€¼ä¿¡æ¯ */public static class Info &#123; public int height; public int nodes; public Info(int h, int n) &#123; height = h; nodes = n; &#125;&#125;public static boolean isFull(Node head) &#123; if (head == null) &#123; return true; &#125; Info all = process(head); // N=2(Læ¬¡æ–¹)-1 return (1 &lt;&lt; all.height) - 1 == all.nodes;&#125;public static Info process(Node head) &#123; if (head == null) &#123; return new Info(0, 0); &#125; Info leftInfo = process(head.left); Info rightInfo = process(head.right); // é«˜åº¦ç­‰äºå·¦æ ‘å’Œå³æ ‘æœ€é«˜çš„é«˜åº¦+1 int height = Math.max(leftInfo.height, rightInfo.height) + 1; // æ€»ä¸ªæ•°ç­‰äºå·¦è¾¹çš„ä¸ªæ•°åŠ ä¸Šå³è¾¹çš„ä¸ªæ•°åŠ 1 int nodes = leftInfo.nodes + rightInfo.nodes + 1; return new Info(height, nodes);&#125; äºŒå‰æ ‘æœ€ä½å…¬å…±ç¥–å…ˆ ç»™å®šä¸¤ä¸ªäºŒå‰æ ‘èŠ‚ç‚¹node1å’Œnode2ï¼Œæ‰¾åˆ°ä»–ä»¬çš„æœ€ä½å…¬å…±ç¥–å…ˆèŠ‚ç‚¹ è§£æ³•1ï¼šéå†æ•´æ£µæ ‘ï¼ŒæŠŠæ‰€æœ‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹éƒ½ç»´æŠ¤åˆ°ä¸€ä¸ªMapä¸­ï¼Œç„¶åæ‰¾åˆ°node1çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹ç»´æŠ¤åˆ°setä¸­ï¼Œå†éå†node2çš„æ‰€æœ‰çš„çˆ¶ï¼Œç¬¬ä¸€ä¸ªåœ¨setä¸­é‡åˆ°çš„èŠ‚ç‚¹å°±æ˜¯æœ€ä½å…¬å…±ç¥–å…ˆ 1234567891011121314151617181920212223242526272829303132333435// è§£æ³•1public static Node lca(Node head, Node o1, Node o2) &#123; if (head == null) &#123; return null; &#125; HashMap&lt;Node, Node&gt; parentMap = new HashMap&lt;&gt;(); parentMap.put(head, null); fillParentMap(head, parentMap); HashSet&lt;Node&gt; set = new HashSet&lt;&gt;(); Node cur = o1; set.add(cur); // åªæœ‰å¤´èŠ‚ç‚¹æ‰ç­‰äºè‡ªå·±çš„çˆ¶ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹ä¸ç­‰äºè‡ªå·±çš„çˆ¶ï¼Œå°±å¯ä»¥å¾€ä¸Šèµ° while (null != parentMap.get(cur)) &#123; cur = parentMap.get(cur); set.add(cur); &#125; // o1å¾€ä¸Šæ‰€æœ‰èŠ‚ç‚¹éƒ½åœ¨è¿™ä¸ªseté‡Œé¢ï¼Œåªæœ‰æœ€åˆçš„headä¸åœ¨é‡Œé¢ cur = o2; while (!set.contains(cur)) &#123; cur = parentMap.get(cur); &#125; return cur;&#125;// ç»´æŠ¤æ•´æ£µæ ‘çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹åˆ°Mapä¸­private static void fillParentMap(Node head, HashMap&lt;Node, Node&gt; fatherMap) &#123; if (head.left != null) &#123; fatherMap.put(head.left, head); fillParentMap(head.left, fatherMap); &#125; if (head.right != null) &#123; fatherMap.put(head.right, head); fillParentMap(head.right, fatherMap); &#125;&#125; è§£æ³•2(éå¸¸æŠ½è±¡)ï¼šå¯èƒ½çš„æƒ…å†µæœ‰1ï¼šnode1å’Œnode2äº’ä¸ºå…¬å…±ç¥–å…ˆï¼›2ï¼šnode1å’Œnode2ä¸äº’ä¸ºå…¬å…±ç¥–å…ˆï¼› 1234567891011121314/** * è§£æ³•2ï¼šå¯èƒ½çš„æƒ…å†µæœ‰1ï¼šnode1å’Œnode2äº’ä¸ºå…¬å…±ç¥–å…ˆï¼›2ï¼šnode1å’Œnode2ä¸äº’ä¸ºå…¬å…±ç¥–å…ˆï¼› */public static Node lowestCommonAncestor(Node head, Node o1, Node o2) &#123; if (head == null || head == o1 || head == o2) &#123; return head; &#125; Node left = lowestCommonAncestor(head.left, o1, o2); Node right = lowestCommonAncestor(head.right, o1, o2); if (left != null &amp;&amp; right != null) &#123; return head; &#125; return left != null ? left : right;&#125; å›¾ å¸¸è§çš„è¡¨ç¤ºå›¾çš„æ–¹æ³•ï¼šä¸´æ¥è¡¨æ³•ï¼Œå’Œä¸´æ¥çŸ©é˜µæ³•ï¼Œæ•°ç»„ç­‰ åšæ¨¡æ¿ï¼Œç„¶åæŠŠæ‰€æœ‰çš„å›¾çš„é—®é¢˜è½¬åŒ–ä¸ºè‡ªå·±ç†Ÿæ‚‰çš„æ•°æ®ç»“æ„ï¼Œå¸¦ç€æ¨¡æ¿ä¸Šè€ƒåœº å›¾çš„å®½åº¦ä¼˜å…ˆéå†çº¦ç‘Ÿå¤«åœ†ç¯é—®é¢˜é€†æ³¢å…°è®¡ç®—å™¨ å®ç°ä¸€ä¸ªè®¡ç®—å™¨ï¼Œåªæœ‰åŠ å‡ä¹˜é™¤æ³•ï¼Œæ²¡æœ‰æ‹¬å·ï¼Œè¾“å…¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¦‚10+2+3*5 è§£é¢˜ï¼šè¡¨è¾¾å¼è½¬åŒ–ä¸ºåç¼€è¡¨è¾¾å¼ï¼ˆé€†æ³¢å…°è¡¨è¾¾å¼ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125// è§£é¢˜public static void main(String[] args) &#123; String str = &quot;10+2+3*5&quot;; // è¡¨è¾¾å¼è½¬æ¢ä¸ºæ“ä½œæ•°å’Œæ“ä½œç¬¦çš„ä¸­ç¼€è¡¨è¾¾å¼æ•°ç»„ String[] strArr = changeStrArr(str); // ä¸­ç¼€è¡¨è¾¾å¼è½¬åŒ–ä¸ºåç¼€è¡¨è¾¾å¼ List&lt;String&gt; polandList = polandNotation(strArr); System.out.println(polandList); // åç¼€è¡¨è¾¾å¼è®¡ç®— System.out.println(calculate(polandList));&#125;/** * å­—ç¬¦ä¸²è½¬æˆä¸­ç¼€çš„æ•°ç»„ * åªæœ‰åŠ å‡ä¹˜é™¤ï¼Œæ²¡æœ‰æ‰©å· */private static String[] changeStrArr(String str) &#123; StringBuilder stringBuilder = new StringBuilder(); for (char c : str.toCharArray()) &#123; if (&quot;+-*/&quot;.contains(String.valueOf(c))) &#123; stringBuilder.append(&quot;;&quot;); stringBuilder.append(c); stringBuilder.append(&quot;;&quot;); &#125; else &#123; stringBuilder.append(c); &#125; &#125; return stringBuilder.toString().split(&quot;;&quot;);&#125;/** * ä¸­ç¼€è¡¨è¾¾å¼è½¬åŒ–ä¸ºåç¼€è¡¨è¾¾å¼ * 1.åˆå§‹åŒ–ä¸¤ä¸ªæ ˆï¼Œè¿ç®—ç¬¦æ ˆs1å’Œå‚¨å­˜ä¸­é—´ç»“æœçš„æ ˆs2 * 2.ä»å·¦åˆ°å³æ‰«æä¸­ç¼€è¡¨è¾¾å¼ * 3.é‡åˆ°æ“ä½œæ•°ï¼Œå…¥æ ˆs2 * 4.é‡åˆ°è¿ç®—ç¬¦ï¼Œæ¯”è¾ƒå…¶ä¸s1æ ˆé¡¶è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§ï¼š * (1).å¦‚æœs1ä¸ºç©ºï¼Œæˆ–è€…æ ˆé¡¶è¿ç®—ç¬¦ä¸ºå·¦æ‹¬å·&quot;(&quot;,ç›´æ¥å°†è¿ç®—ç¬¦å…¥æ ˆï¼› * (2).å¦åˆ™ï¼Œè‹¥ä¼˜å…ˆçº§æ¯”æ ˆé¡¶è¿ç®—ç¬¦é«˜ï¼Œä¹Ÿå°†è¿ç®—ç¬¦å…¥æ ˆs1; * (3).å¦åˆ™ï¼Œå°†s1æ ˆé¡¶è¿ç®—ç¬¦å¼¹å‡ºå…¥æ ˆs2ä¸­ï¼Œå†æ¬¡è½¬åˆ°(4-1) ä¸s1ä¸­æ–°çš„æ ˆé¡¶è¿ç®—ç¬¦æ¯”è¾ƒï¼› * æœ¬æ–¹æ³•åªè€ƒè™‘åˆ°åŠ å‡ä¹˜é™¤æ“ä½œï¼Œä¸è€ƒè™‘æ‰©å· */private static List&lt;String&gt; polandNotation(String[] str) &#123; List&lt;String&gt; s2 = new ArrayList&lt;&gt;(); Stack&lt;String&gt; s1 = new Stack&lt;&gt;(); for (String itm : str) &#123; // é‡åˆ°æ“ä½œæ•°ï¼Œç›´æ¥å…¥æ ˆs2 if (itm.matches(&quot;\\\\d+&quot;)) &#123; s2.add(itm); &#125; else &#123; // å¦‚æœæ ˆä¸ä¸ºç©ºï¼Œå¹¶ä¸”æ ˆé¡¶ä¼˜å…ˆçº§æ¯”æˆ‘ç›®å‰è¿ç®—ç¬¦ä¼˜å…ˆçº§é«˜ï¼Œå°±æŠŠæ ˆé¡¶è¿ç®—ç¬¦å¦‚s2ï¼Œç„¶åå§å½“å‰è¿ç®—ç¬¦å¦‚s1 while (!s1.isEmpty() &amp;&amp; Operation.getValue(s1.peek()) &gt;= Operation.getValue(itm)) &#123; s2.add(s1.pop()); &#125; s1.push(itm); &#125; &#125; while (!s1.isEmpty()) &#123; s2.add(s1.pop()); &#125; return s2;&#125;/** * è¿ç®—ç¬¦æ¯”è¾ƒ */private static class Operation &#123; private static int ADD = 1; private static int SUB = 1; private static int MUL = 2; private static int DIV = 2; public static int getValue(String operation) &#123; int result = 0; switch (operation) &#123; case &quot;+&quot;: result = ADD; break; case &quot;-&quot;: result = SUB; break; case &quot;*&quot;: result = MUL; break; case &quot;/&quot;: result = DIV; break; default: break; &#125; return result; &#125;&#125;/** * é€†æ³¢å…°è¡¨è¾¾å¼è®¡ç®— * 1.å®šä¹‰ä¸€ä¸ªæ ˆï¼ŒåŒ¹é…åˆ°éè¿ç®—ç¬¦å°±å…¥æ ˆ * 2.é‡åˆ°è¿ç®—ç¬¦å°±æŠŠæ ˆé¡¶ä¸¤ä¸ªæ•°å­—å‡ºæ ˆï¼Œç”¨åå‡ºæ ˆçš„æ•°å’Œå…ˆå‡ºæ ˆçš„æ•°åšè¿ç®—ï¼ŒæŠŠè¿ç®—ç»“æœå†å…¥æ ˆ * 3.ç›´åˆ°æœ€åï¼Œæ ˆé¡¶ç»“æœå³ä¸ºè®¡ç®—ç»“æœ */private static int calculate(List&lt;String&gt; polandList) &#123; Stack&lt;String&gt; stack = new Stack&lt;&gt;(); for (String itm : polandList) &#123; // åŒ¹é…çš„æ˜¯å¤šä½æ•° if (itm.matches(&quot;\\\\d+&quot;)) &#123; stack.push(itm); &#125; else &#123; // å¼¹å‡ºä¸¤ä¸ªæ•°ï¼Œå¹¶è¿ç®—ï¼Œå†å…¥æ ˆ int num2 = Integer.parseInt(stack.pop()); int num1 = Integer.parseInt(stack.pop()); int res = 0; if (itm.equals(&quot;+&quot;)) &#123; res = num1 + num2; &#125; else if (itm.equals(&quot;-&quot;)) &#123; res = num1 - num2; &#125; else if (itm.equals(&quot;*&quot;)) &#123; res = num1 * num2; &#125; else if (itm.equals(&quot;/&quot;)) &#123; res = num1 / num2; &#125; else &#123; throw new RuntimeException(&quot;è¿ç®—ç¬¦æœ‰è¯¯&quot;); &#125; stack.push(String.valueOf(res)); &#125; &#125; return Integer.parseInt(stack.pop());&#125; å‰ç¼€æ ‘1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495// å‰ç¼€æ ‘æ•°æ®ç»“æ„public static class Node1 &#123; public int pass; public int end; public Node1[] nexts; // char tmp = &#x27;b&#x27; (tmp - &#x27;a&#x27;) public Node1() &#123; pass = 0; end = 0; // 0 a // 1 b // 2 c // .. .. // 25 z // nexts[i] == null iæ–¹å‘çš„è·¯ä¸å­˜åœ¨ // nexts[i] != null iæ–¹å‘çš„è·¯å­˜åœ¨ nexts = new Node1[26]; &#125;&#125;// æ·»åŠ å…ƒç´ public void insert(String word) &#123; if (word == null) &#123; return; &#125; char[] str = word.toCharArray(); Node1 node = root; node.pass++; int path = 0; for (int i = 0; i &lt; str.length; i++) &#123; // ä»å·¦å¾€å³éå†å­—ç¬¦ path = str[i] - &#x27;a&#x27;; // ç”±å­—ç¬¦ï¼Œå¯¹åº”æˆèµ°å‘å“ªæ¡è·¯ if (node.nexts[path] == null) &#123; node.nexts[path] = new Node1(); &#125; node = node.nexts[path]; node.pass++; &#125; node.end++;&#125;// wordè¿™ä¸ªå•è¯ä¹‹å‰åŠ å…¥è¿‡å‡ æ¬¡public int search(String word) &#123; if (word == null) &#123; return 0; &#125; char[] chs = word.toCharArray(); Node1 node = root; int index = 0; for (int i = 0; i &lt; chs.length; i++) &#123; index = chs[i] - &#x27;a&#x27;; if (node.nexts[index] == null) &#123; return 0; &#125; node = node.nexts[index]; &#125; return node.end;&#125;// æ‰€æœ‰åŠ å…¥çš„å­—ç¬¦ä¸²ä¸­ï¼Œæœ‰å‡ ä¸ªæ˜¯ä»¥preè¿™ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‰ç¼€çš„public int prefixNumber(String pre) &#123; if (pre == null) &#123; return 0; &#125; char[] chs = pre.toCharArray(); Node1 node = root; int index = 0; for (int i = 0; i &lt; chs.length; i++) &#123; index = chs[i] - &#x27;a&#x27;; if (node.nexts[index] == null) &#123; return 0; &#125; node = node.nexts[index]; &#125; return node.pass;&#125;// åˆ é™¤public void delete(String word) &#123; if (search(word) != 0) &#123; char[] chs = word.toCharArray(); Node1 node = root; node.pass--; int path = 0; for (int i = 0; i &lt; chs.length; i++) &#123; path = chs[i] - &#x27;a&#x27;; if (--node.nexts[path].pass == 0) &#123; node.nexts[path] = null; return; &#125; node = node.nexts[path]; &#125; node.end--; &#125;&#125; è´ªå¿ƒç®—æ³•åœ¨æŸä¸€ä¸ªæ ‡å‡†ä¸‹ï¼Œä¼˜å…ˆè€ƒè™‘æœ€æ»¡è¶³æ ‡å‡†çš„æ ·æœ¬ï¼Œæœ€åè€ƒè™‘æœ€ä¸æ»¡è¶³æ ‡å‡†çš„æ ·æœ¬ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªç­”æ¡ˆçš„ç®—æ³•ï¼Œå«åšè´ªå¿ƒç®—æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä»æ•´ä½“æœ€ä¼˜ä¸ŠåŠ ä»¥è€ƒè™‘ï¼Œæ‰€åšå‡ºçš„æ˜¯æŸç§æ„ä¹‰ä¸Šçš„å±€éƒ¨æœ€ä¼˜è§£ã€‚ ä¼šè®®å®¤å ç”¨é—®é¢˜é—®é¢˜ï¼šåªæœ‰ä¸€ä¸ªä¼šè®®å®¤ï¼Œå¤šä¸ªä¼šè®®å ç”¨ä¼šè®®å®¤çš„æ—¶é—´æœ‰å†²çªï¼Œå¦‚ä½•è®©ä¼šè®®å®¤è¿›è¡Œçš„ä¼šè®®æœ€å¤šï¼Œè¿”å›æœ€å¤šçš„ä¼šè®®åœºæ¬¡ è§£ï¼šå“ªä¸ªä¼šè®®ç»“æŸæ—¶é—´æ—©ï¼Œå°±ä¼˜å…ˆå®‰æ’ï¼Œç„¶åæ¥ä¸‹æ¥ç»§ç»­æ‰¾ä¸‹ä¸€ä¸ªä¼šè®®ç»“æŸæ—¶é—´æ—©çš„ä¼šè®® 1234567891011121314151617181920212223242526272829303132// ä¼šè®®å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´public static class Program &#123; public int start; public int end; public Program(int start, int end) &#123; this.start = start; this.end = end; &#125;&#125;// æ¯”è¾ƒå™¨public static class ProgramComparator implements Comparator&lt;Program&gt; &#123; @Override public int compare(Program o1, Program o2) &#123; return o1.end - o2.end; &#125;&#125;// ä¼šè®®çš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ï¼Œéƒ½æ˜¯æ•°å€¼ï¼Œä¸ä¼š &lt; 0public static int bestArrange2(Program[] programs) &#123; Arrays.sort(programs, new ProgramComparator()); int timeLine = 0; int result = 0; // ä¾æ¬¡éå†æ¯ä¸€ä¸ªä¼šè®®ï¼Œç»“æŸæ—¶é—´æ—©çš„ä¼šè®®å…ˆéå† for (int i = 0; i &lt; programs.length; i++) &#123; if (timeLine &lt;= programs[i].start) &#123; result++; timeLine = programs[i].end; &#125; &#125; return result;&#125; å…«çš‡åé—®é¢˜å¤šçº¿ç¨‹ç›¸å…³ä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å° ä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°ï¼Œ1çº¿ç¨‹æ‰“å°1ï¼›2çº¿ç¨‹æ‰“å°2ï¼›3çº¿ç¨‹æ‰“å°3ï¼›1çº¿ç¨‹æ‰“å°4â€¦â€¦ä¸€ç›´æ‰“å°åˆ°100 è§£é¢˜æ–¹å¼ç”±å¾ˆå¤šï¼Œæ— éå°±æ˜¯æ¶‰åŠåˆ°çº¿ç¨‹é€šä¿¡é—®é¢˜ä»¥åŠä¿®æ”¹å…±äº«å˜é‡é—®é¢˜ é¢˜è§£1ï¼šä¸åŠ é”ï¼Œåˆ©ç”¨çº¿ç¨‹å¯è§æ€§ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public class ThreadPrint &#123; private static volatile int i = 0; private static volatile int flag = 0; public static void main(String[] args) &#123; Thread thread1 = new Thread(new Thread1()); Thread thread2 = new Thread(new Thread2()); Thread thread3 = new Thread(new Thread3()); thread1.start(); thread2.start(); thread3.start(); &#125; public static class Thread1 implements Runnable &#123; public void run() &#123; while (i &lt;= 100) &#123; if (flag == 0) &#123; System.out.println(&quot;t1=&quot; + i); i++; flag = 1; &#125; &#125; &#125; &#125; public static class Thread2 implements Runnable &#123; public void run() &#123; while (i &lt;= 100) &#123; if (flag == 1) &#123; System.out.println(&quot;t2=&quot; + i); i++; flag = 2; &#125; &#125; &#125; &#125; public static class Thread3 implements Runnable &#123; public void run() &#123; while (i &lt;= 100) &#123; if (flag == 2) &#123; System.out.println(&quot;t3=&quot; + i); i++; flag = 0; &#125; &#125; &#125; &#125;&#125; é¢˜è§£2ï¼šLockSupport å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142public class ThreadPrint2 &#123; private static int number = 1; private static Thread thread1, thread2,thread3; public static void main(String[] args) &#123; thread1 = new Thread(ThreadPrint2::thread1, &quot;thread1&quot;); thread2 = new Thread(ThreadPrint2::thread2, &quot;thread2&quot;); thread3 = new Thread(ThreadPrint2::thread3, &quot;thread3&quot;); thread1.start(); thread2.start(); thread3.start(); &#125; public static void thread1() &#123; while (ThreadPrint2.number &lt;= 100) &#123; System.out.println(&quot;thread1:&quot; + ThreadPrint2.number); ThreadPrint2.number++; LockSupport.unpark(thread2); LockSupport.park(); &#125; &#125; public static void thread2() &#123; while (ThreadPrint2.number &lt;= 100) &#123; LockSupport.park(); System.out.println(&quot;thread2:&quot; + ThreadPrint2.number); ThreadPrint2.number++; LockSupport.unpark(thread3); &#125; &#125; public static void thread3() &#123; while (ThreadPrint2.number &lt;= 100) &#123; LockSupport.park(); System.out.println(&quot;thread3:&quot; + ThreadPrint2.number); ThreadPrint2.number++; LockSupport.unpark(thread1); &#125; &#125;&#125; é¢˜è§£3ï¼šç»å…¸å®ç° å®ç°wait-&gt;notifyAll 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public class ThreadPrint3 &#123; private static int count = 1; public static void main(String[] args) &#123; Object lock = new Object(); new Thread(() -&gt; &#123; try &#123; synchronized (lock) &#123; while (count &lt;= 100) &#123; if (count % 3 == 1) &#123; System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + count); count++; &#125; lock.notifyAll(); lock.wait(); &#125; lock.notifyAll(); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;, &quot;T1&quot;).start(); new Thread(() -&gt; &#123; try &#123; synchronized (lock) &#123; while (count &lt;= 100) &#123; if (count % 3 == 2) &#123; System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + count); count++; &#125; lock.notifyAll(); lock.wait(); &#125; lock.notifyAll(); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;, &quot;T2&quot;).start(); new Thread(() -&gt; &#123; try &#123; synchronized (lock) &#123; while (count &lt;= 100) &#123; if (count % 3 == 0) &#123; System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + count); count++; &#125; lock.notifyAll(); lock.wait(); &#125; lock.notifyAll(); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;, &quot;T3&quot;).start(); &#125;&#125; é¢˜è§£4ï¼šLockå®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public class ThreadPrint4 &#123; private static int cnt = 0; public static void main(String[] args) &#123; Lock lock = new ReentrantLock(); Condition c1 = lock.newCondition(); Condition c2 = lock.newCondition(); Condition c3 = lock.newCondition(); new Thread(() -&gt; &#123; lock.lock(); try &#123; while (cnt &lt;= 100 &amp;&amp; cnt % 3 == 0) &#123; System.out.println(Thread.currentThread().getName() + &quot;----&gt;&quot; + cnt); cnt++; c2.signal(); c1.await(); &#125; c3.signal(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;, &quot;T1&quot;).start(); new Thread(() -&gt; &#123; lock.lock(); try &#123; while (cnt &lt;= 100 &amp;&amp; cnt % 3 == 1) &#123; System.out.println(Thread.currentThread().getName() + &quot;----&gt;&quot; + cnt); cnt++; c3.signal(); c2.await(); &#125; c1.signal(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;, &quot;T2&quot;).start(); new Thread(() -&gt; &#123; lock.lock(); try &#123; while (cnt &lt;= 100 &amp;&amp; cnt % 3 == 2) &#123; System.out.println(Thread.currentThread().getName() + &quot;----&gt;&quot; + cnt); cnt++; c1.signal(); c3.await(); &#125; c2.signal(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;, &quot;T3&quot;).start(); &#125;&#125; å…¶ä»–ç®—æ³•é¢˜","categories":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://zhangxin66666.github.io/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ä¸šåŠ¡æ¶æ„-ç¨³å®šæ€§å»ºè®¾æ–¹æ³•è®º","slug":"11.æ–¹æ³•è®º/ä¸šåŠ¡æ¶æ„-ç¨³å®šæ€§å»ºè®¾æ–¹æ³•è®º","date":"2022-01-16T16:00:00.000Z","updated":"2022-03-31T02:55:44.589Z","comments":true,"path":"2022/01/17/11.æ–¹æ³•è®º/ä¸šåŠ¡æ¶æ„-ç¨³å®šæ€§å»ºè®¾æ–¹æ³•è®º/","link":"","permalink":"https://zhangxin66666.github.io/2022/01/17/11.%E6%96%B9%E6%B3%95%E8%AE%BA/%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84-%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%BB%BA%E8%AE%BE%E6%96%B9%E6%B3%95%E8%AE%BA/","excerpt":"","text":"å…ˆä»‹ç»å‡ ä¸ªæ¦‚å¿µï¼ŒåŒæ­¥ä¸€ä¸‹è®¤çŸ¥ï¼š å®¹ç¾ï¼šæ˜¯æŒ‡ç³»ç»Ÿå†—ä½™éƒ¨ç½²ï¼Œå½“ä¸€å¤„ç”±äºæ„å¤–åœæ­¢å·¥ä½œï¼Œæ•´ä¸ªç³»ç»Ÿåº”ç”¨è¿˜å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ å®¹é”™ï¼šæ˜¯æŒ‡åœ¨è¿è¡Œä¸­å‡ºç°é”™è¯¯ï¼ˆå¦‚ä¸Šä¸‹æ¸¸æ•…éšœæˆ–æ¦‚ç‡æ€§å¤±è´¥ï¼‰ä»å¯æ­£å¸¸æä¾›æœåŠ¡ã€‚ å¯ç”¨æ€§ï¼šæè¿°çš„æ˜¯ç³»ç»Ÿå¯æä¾›æœåŠ¡çš„æ—¶é—´é•¿çŸ­ã€‚ç”¨å…¬å¼æ¥è¯´å°±æ˜¯æ­£å¸¸å·¥ä½œæ—¶é—´/(æ­£å¸¸å·¥ä½œæ—¶é—´+æ•…éšœæ—¶é—´)ã€‚ å¯é æ€§ï¼šæè¿°çš„æ˜¯ç³»ç»ŸæŒ‡å®šæ—¶é—´å•ä½å†…æ— æ•…éšœçš„æ¬¡æ•°ã€‚æ¯”å¦‚ï¼šä¸€å¹´365å¤©ï¼Œä»¥å¤©ä¸ºå•ä½æ¥è¡¡é‡ã€‚æœ‰å¤©å‘ç”Ÿäº†æ•…éšœï¼Œå“ªæ€•åªæœ‰1ç§’ï¼Œè¿™å¤©ç®—ä¸å¯é ã€‚å…¶ä»–æ²¡æœ‰æ•…éšœçš„æ˜¯å¯é çš„ã€‚ ç¨³å®šæ€§ï¼šè¿™ä¸ªä¸šç•Œæ²¡æœ‰æ˜ç¡®çš„å®šä¹‰ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼šåœ¨å—åˆ°å„ç§å¹²æ‰°æ—¶ä»ç„¶èƒ½å¤Ÿæä¾›ç¬¦åˆé¢„æœŸçš„æœåŠ¡çš„èƒ½åŠ›ã€‚ ä¸€ã€å®¹ç¾å»ºè®¾1.ä»£ç å®¹ç¾ ç°ä»£äº’è”ç½‘å…¬å¸æœ€å€¼é’±çš„å°±æ˜¯ç¨‹åºå‘˜å†™å‡ºæ¥çš„ä»£ç å•¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ä»£ç è¿›è¡Œå®¹ç¾å¤‡ä»½ï¼Œé˜²æ­¢æ”¾ä»£ç çš„æœåŠ¡å™¨å“ªå¤©ä¸€ä¸é«˜å…´å®•æœºå¼‚æˆ–çˆ†ç‚¸å•¦æ•°æ®éƒ½ä¸¢äº†å°±å®Œè›‹äº†ï¼Œç°åœ¨ä»£ç åŒæ­¥çš„æ–¹æ¡ˆæ¯”è¾ƒå¤šï¼Œæ˜¯åœ¨ä¸è¡Œè¿ç»´äººå‘˜å†™ä¸ªè„šæœ¬ï¼Œæ¯å¤©æˆ–è€…å‡ ä¸ªå°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€ä¸‹å…¨é‡ä»£ç åˆ°å¦ä¸€ä¸ªæœºæˆ¿è¿˜æ˜¯å¯ä»¥åšåˆ°æ»´ã€‚ 2.æœåŠ¡å®¹ç¾æœåŠ¡å®¹ç¾çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å†—ä½™ã€‚å¤šå‡ ä¸ªå¤‡ä»½æ¥åˆ‡æ¢ã€‚å¸¸ç”¨çš„æœ‰N+1å®¹ç¾å’Œä¸¤åœ°ä¸‰ä¸­å¿ƒã€‚ Nå’Œä¸­å¿ƒå®é™…ä¸Šéƒ½æ˜¯æœºæˆ¿çš„æ„æ€ã€‚æ‰€è°“ä¸­å¿ƒå°±æ˜¯æ•°æ®ä¸­å¿ƒã€‚Næ˜¯æ•°æ®ä¸­å¿ƒçš„ç”µåŠ›é…ç½®éƒ¨åˆ†ã€‚ç”µåŠ›é…ç½®æœ‰å¸‚ç”µå’Œå¤‡ç”¨å‘åŠ¨æœºä¾›ç”µï¼Œä½†æ˜¯ä¸€èˆ¬äº’è”ç½‘å…¬å¸æ˜¯ä¸æ”¯æŒå¤‡ç”¨å‘åŠ¨æœºä¾›ç”µçš„ã€‚æ‰€ä»¥ä¸€èˆ¬ä¸€ä¸ªæœºæˆ¿å°±æ˜¯ä¸€ä¸ªNã€‚ 2.1åŒåŸå®¹ç¾N+1å®¹ç¾å°±æ˜¯è¦å¤šå‡ºä¸€ä¸ªæœºæˆ¿åšå®¹ç¾ï¼Œä¸€èˆ¬ä¼šåœ¨åŒåŸæˆ–è€…åŒæœºæˆ¿è¿›è¡Œå®¹ç¾ã€‚ 2.2å¼‚åœ°/è·¨æ´‹å®¹ç¾ä¸¤åœ°ä¸‰ä¸­å¿ƒï¼Œæ˜¯æé«˜äº†å®‰å…¨çº§åˆ«ï¼Œé™¤äº†åŒåŸä¸¤ä¸ªä¸­å¿ƒå¤–ï¼Œåœ¨å¼‚åœ°å†å¤šå‡ºæ¥ä¸€ä¸ªä¸­å¿ƒã€‚å¦‚æœæ•´ä¸ªåœ°åŒºå¸‚ç”µéƒ½ä¸ä¾›ç”µäº†ï¼Œè¿˜æœ‰ä¸ªå¤‡ä»½ã€‚ äºŒã€æœåŠ¡æ²»ç†1.é“¾è·¯æ¢³ç†éœ€è¦æ¢³ç†æ ¸å¿ƒæ¥å£æœåŠ¡çš„è¡€ç¼˜ä¾èµ–å…³ç³»ã€ç›¸å…³å¹²ç³»äººåŠè”ç³»æ–¹å¼ï¼Œåšåˆ°å¿ƒä¸­æœ‰æ•°ï¼Œå…³é”®æ¥å£è°ƒç”¨é“¾è·¯æµç¨‹å°½é‡çŸ­ï¼Œä¸‹æ¸¸ä¾èµ–æ¥å£tp999å°½é‡è¶Šå¿«è¶Šå¥½ã€‚ 2.å¼ºå¼±ä¾èµ–åˆ†æå¼ºä¾èµ–ï¼šå‡å®šæœåŠ¡Aä¾èµ–äºæœåŠ¡Bï¼ŒæœåŠ¡Bå‡ºç°æ•…éšœä¸å¯ç”¨æ—¶ï¼ŒæœåŠ¡Aä¹Ÿä¸å¯ç”¨ï¼Œé€šå¸¸æœåŠ¡Aä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°è¿™ç§ä¾èµ–ä¸ºå¼ºä¾èµ–ã€‚ å¼±ä¾èµ–ï¼šå‡å®šæœåŠ¡Aä¾èµ–äºæœåŠ¡Bï¼ŒæœåŠ¡Bå‡ºç°æ•…éšœä¸å¯ç”¨æ—¶ï¼ŒæœåŠ¡Aä»ç„¶å¯ç”¨ï¼Œé€šå¸¸æœåŠ¡Aä¼šè¿”å›æ­£ç¡®ä¿¡æ¯ï¼Œåªæ˜¯ä¸æœåŠ¡Bç›¸å…³çš„ä¿¡æ¯ä¼šä¸è¿”å›æˆ–è€…åšé»˜è®¤å¤„ç†ï¼Œæˆ‘ä»¬ç§°è¿™ç§ä¾èµ–ä¸ºå¼±ä¾èµ–ã€‚ é€šè¿‡ä¸‹é¢çš„æµç¨‹å›¾ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å¼ºå¼±ä¾èµ–ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æœåŠ¡Aä¸­è°ƒç”¨äº†æœåŠ¡Bå’ŒæœåŠ¡Cï¼Œä½†æ˜¯ä»–ä»¬çš„å¤„ç†é€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ã€‚ 1ã€è°ƒç”¨æœåŠ¡Bï¼šå¦‚æœè°ƒç”¨æˆåŠŸï¼Œåˆ™æ¥ç€è°ƒç”¨æœåŠ¡Cï¼›å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œåˆ™æœåŠ¡Aç›´æ¥ç»“æŸã€‚è¿™ç§åœºæ™¯æˆ‘ä»¬ç§°ä¹‹ä¸ºæœåŠ¡Aå¼ºä¾èµ–äºæœåŠ¡Bã€‚ 2ã€è°ƒç”¨æœåŠ¡Cï¼šä¸ç®¡è°ƒç”¨æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒæœåŠ¡Aä¼šæ¥ç»­æ‰§è¡Œåç»­é€»è¾‘å¤„ç†ã€‚è¿™ç§åœºæ™¯æˆ‘ä»¬ç§°ä¹‹ä¸ºæœåŠ¡Aå¼±ä¾èµ–äºæœåŠ¡Cã€‚ 12345678910111213141516171819public void serviceA()&#123; try &#123; System.out.println(&quot;it`s serviceA&quot;); /// serviceA å¼ºä¾èµ–äº serviceB serviceB(); try &#123; /// serviceA å¼±ä¾èµ–äº serviceC serviceC(); &#125; catch (Exception e)&#123; e.printStackTrace(); &#125; System.out.println(&quot;xxxxxxx&quot;); &#125; catch (Exception e)&#123; e.printStackTrace(); &#125; &#125; åœ¨ä»£ç çš„å¤„ç†ä¸Šï¼Œå¯ä»¥åˆ†ä¸ºä¸€ä¸‹ä¸‰ç§æ¨¡å¼ï¼š1ã€å¼±ä¾èµ–ï¼šæœåŠ¡Açš„ä¸»æµç¨‹ä¸ä¾èµ–æœåŠ¡Bçš„è¿”å›ç»“æœã€‚è¯¥åœºæ™¯å¯ä»¥æœ‰ä¸¤ç§è§£å†³æ–¹å¼ï¼š1ï¼‰å¯ä»¥å¯åŠ¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡ŒæœåŠ¡Bè°ƒç”¨ã€‚2ï¼‰åœ¨å½“å‰çº¿ç¨‹ä¸­å‘æ¶ˆæ¯ï¼Œåœ¨æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹ä¸­è®¿é—®æœåŠ¡Bã€‚ 2ã€å¼±ä¾èµ–ï¼šæœåŠ¡Açš„ä¸»æµç¨‹ä¾èµ–æœåŠ¡Bçš„è¿”å›ç»“æœã€‚ä¸å¼ºä¾èµ–å¤„ç†æœ‰äº›ç±»ä¼¼ï¼Œä¸€èˆ¬å»ºè®®å¯¹æœåŠ¡Båšé™çº§å¤„ç†ï¼Œæ ¹æ®è¯·æ±‚è¶…æ—¶æ—¶é—´ã€å¹¶å‘è¯·æ±‚æ•°ã€è¯·æ±‚å¤±è´¥æ•°ã€è¯·æ±‚è¿”å›çš„é”™è¯¯ç åšé™çº§(æˆ–è€…ç†”æ–­)å¤„ç†ã€‚åŒæ—¶ä½¿ç”¨é»˜è®¤å€¼æ¥ä»£æ›¿æœåŠ¡Bçš„è¿”å›ç»“æœï¼Œé»˜è®¤å€¼çš„è®¾ç½®éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œåˆ†æã€‚ 3ã€å¼ºä¾èµ–ï¼šæœåŠ¡Açš„ä¸»æµç¨‹ä¾èµ–æœåŠ¡Bçš„è¿”å›ç»“æœã€‚ä¸€èˆ¬å»ºè®®å¯¹æœåŠ¡Aæ•´ä½“åšé™çº§å¤„ç†ï¼Œè¯·æ±‚è¿”å›çš„é”™è¯¯ç ã€‚ åœ¨ç³»ç»Ÿè®¾è®¡æ—¶ä¸€å®šè¦è€ƒè™‘ç³»ç»Ÿçš„å¼ºå¼±ä¾èµ–å…³ç³»ï¼Œæ ¹æ®éœ€è¦é‡‡ç”¨ä¸åŒçš„å¤„ç†æ–¹æ¡ˆã€‚ 3.å¼‚æ­¥åŒ–å»ºè®¾æ™®é€šæµé‡ä¸‹çš„æ¥å£æµç¨‹è®¾è®¡ä¸Šå¯ä»¥ä¸€ä¸ªæ¥å£ï¼Œåšäº†å¥½å¤šå¥½å¤šäº‹æƒ…ï¼Œä¹‹åæ¥å£åŒæ­¥å®æ—¶è¿”å›å¤„ç†æˆåŠŸæˆ–è€…å¤„ç†å¤±è´¥ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¯éå¸¸ç³Ÿç³•çš„è®¾è®¡ï¼Œæ¥å£ä¸€æ–¹é¢ä¸šåŠ¡é€»è¾‘éå¸¸çš„é‡ï¼Œå¦ä¸€æ–¹é¢ï¼ŒåŒæ­¥æ¥å£ä¾èµ–çš„å¾ˆå¤šçš„ä¸‰æ–¹æ¥å£ï¼Œä¹Ÿå¯èƒ½ä¼šå¤šæ¬¡çš„æ“ä½œæ•°æ®åº“ï¼Œä¸€ä¸ªç‚¹å‡ºé—®é¢˜éƒ½ä¼šé€ æˆæ•´ä¸ªä¸šåŠ¡çš„ç˜«ç—ªã€‚æ­¤æ—¶å¯ä»¥æŠŠæ•´ä¸ªæµç¨‹å¼‚æ­¥åŒ–ï¼ŒåŒæ­¥æ¥å£é‡Œé¢åªåšä¸€äº›æ ¡éªŒå·¥ä½œä»¥åŠæ•°æ®çš„ä¿å­˜ï¼Œä¹‹åå‘é€mqè§¦å‘åç»­æµç¨‹çš„æ‰§è¡Œï¼Œæ­¤æ—¶å®æ—¶æ¥å£è¿”å›å¤„ç†ä¸­ï¼Œå¼‚æ­¥æµç¨‹ä¸­å¤„ç†å®Œæ¯•åé€šè¿‡å›è°ƒçš„æ–¹å¼é€šçŸ¥è°ƒç”¨æ–¹ç»“æœï¼ŒåŒæ—¶æä¾›æŸ¥è¯¢æ¥å£ä¾›è°ƒç”¨æ–¹ä¸»åŠ¨è·å–ç»“æœã€‚ éœ€è¦æ³¨æ„çš„æ˜¯å› ä¸ºæ˜¯é€šè¿‡å‘mqçš„æ–¹å¼è§¦å‘åç»­æµç¨‹ï¼Œé‚£ä¹ˆå°±è¦ä¿è¯mqä¸€å®šå‘é€æˆåŠŸï¼Œæ­¤å¤„ç‰µæ‰¯åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ç›¸å…³çš„æ–¹æ¡ˆï¼Œä¸åŒçš„ä¸šåŠ¡é€»è¾‘å¯èƒ½ä¼šä½¿ç”¨ä¸åŒçš„è§£å†³åŠæ³•ã€‚ï¼ˆæœ¬åœ°äº‹åŠ¡è¡¨æˆ–è€…ä¾é çŠ¶æ€æ¥é©±åŠ¨éƒ½å¯ä»¥ï¼‰ 4.åˆ‡é‡/é™çº§/é™æµ/ç†”æ–­4.1åˆ‡é‡åˆ‡é‡æ˜¯æ–°ä¸šåŠ¡ä¸Šçº¿åˆæœŸï¼Œæˆ–è€…å¤§ç‰ˆæœ¬æ›´æ–°çš„æ—¶å€™ï¼Œä¼šå¯¹ç”¨æˆ·è¿›è¡Œåˆ‡é‡å¼€æ”¾xxåŠŸèƒ½ï¼Œç”¨å°‘é‡çš„ç”Ÿäº§æµé‡éªŒè¯æµç¨‹ï¼Œå¦‚æœæ²¡æœ‰é—®é¢˜æ…¢æ…¢åˆ‡é‡å‰©ä½™ç”¨æˆ·ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œä¹Ÿä¼šå°†é—®é¢˜å½±å“é¢é™åˆ°æœ€ä½ã€‚ 4.2é™çº§é™çº§æ˜¯é€šè¿‡å¼€å…³é…ç½®å°†æŸäº›ä¸é‡è¦çš„ä¸šåŠ¡åŠŸèƒ½å±è”½æ‰ï¼Œä»¥æé«˜æœåŠ¡å¤„ç†èƒ½åŠ›ã€‚ åœ¨å¤§ä¿ƒåœºæ™¯ä¸­ç»å¸¸ä¼šå¯¹æŸäº›æœåŠ¡è¿›è¡Œé™çº§å¤„ç†ï¼Œå¤§ä¿ƒç»“æŸä¹‹åå†è¿›è¡Œå¤åŸã€‚ æœ¬ç³»ç»Ÿæˆ–è€…ä¸‹æ¸¸ç³»ç»Ÿå‡ºç°é—®é¢˜æ—¶ï¼Œå½“å‰ç³»ç»Ÿå¯ä»¥æ‰‹åŠ¨å¯¹æœåŠ¡è¿›è¡Œé™çº§æ“ä½œï¼Œé—®é¢˜ä¿®å¤åå…³é—­é™çº§ã€‚ å¤§ä¿ƒåœºæ™¯æ—¶ä¼šå¯¹æ—¥å¿—æ‰“å°è¿›è¡Œé™çº§ï¼Œé˜²æ­¢ç£ç›˜ioå¯¹ç³»ç»Ÿé€ æˆå½±å“ï¼Œå¦å¤–ä¹Ÿä¼šé¿å…æ­£å¥½å¤§ä¿ƒæ—¶ç£ç›˜ç©ºé—´æ»¡äº†ï¼Œç³»ç»Ÿæ²¡æ¥å¾—åŠå›æ”¶æ—¥å¿—é€ æˆæœåŠ¡ä¸å¯ç”¨ã€‚ ä¸ºä»€ä¹ˆè¦é™çº§åœ¨ä¸å½±å“ä¸šåŠ¡æ ¸å¿ƒé“¾è·¯çš„æƒ…å†µä¸‹ï¼Œå±è”½æŸäº›ä¸é‡è¦çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œå¯ä»¥èŠ‚çœç³»ç»Ÿçš„å¤„ç†æ—¶é—´ï¼Œæä¾›ç³»ç»Ÿçš„å“åº”èƒ½åŠ›ï¼Œåœ¨æœåŠ¡å™¨èµ„æºå›ºå®šçš„å‰æä¸‹å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚ 4.3é™æµé™æµæ˜¯é’ˆå¯¹æœåŠ¡è¯·æ±‚æ•°é‡çš„ä¸€ç§è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œå½“è¯·æ±‚æ•°é‡è¶…å‡ºæœåŠ¡çš„å¤„ç†èƒ½åŠ›æ—¶ï¼Œä¼šè‡ªåŠ¨ä¸¢å¼ƒæ–°æ¥çš„è¯·æ±‚ã€‚ ä¸ºä»€ä¹ˆè¦é™æµä»»ä½•ä¸€ä¸ªç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›éƒ½æ˜¯æœ‰æé™çš„ï¼Œå‡å®šæœåŠ¡Açš„å¤„ç†èƒ½åŠ›ä¸ºTPS=100ï¼Œå½“TPS&lt;100æ—¶æœåŠ¡Aå¯ä»¥æä¾›æ­£å¸¸çš„æœåŠ¡ã€‚å½“TPS&gt;100æ—¶ï¼Œç”±äºè¯·æ±‚é‡å¢å¤§ï¼Œä¼šå‡ºç°äº‰æŠ¢æœåŠ¡èµ„æºçš„æƒ…å†µï¼ˆæ•°æ®åº“è¿æ¥ã€CPUã€å†…å­˜ç­‰ï¼‰ï¼Œå¯¼è‡´æœåŠ¡Aå¤„ç†ç¼“æ…¢ï¼›å½“TPSç»§ç»­å¢å¤§æ—¶ï¼Œå¯èƒ½ä¼šé€ æˆæœåŠ¡Aå“åº”æ›´åŠ ç¼“æ…¢ç”šè‡³å¥”æºƒã€‚å¦‚æœä¸è¿›è¡Œé™æµæ§åˆ¶ï¼ŒæœåŠ¡Aå§‹ç»ˆä¼šé¢ä¸´ç€è¢«å¤§æµé‡å†²å‡»çš„é£é™©ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšå¥½ç³»ç»Ÿè¯·æ±‚æµé‡çš„è¯„ä¼°ï¼Œåˆ¶å®šåˆç†çš„é™æµç­–ç•¥ã€‚ 4.4ç†”æ–­åœ¨æœåŠ¡çš„ä¾èµ–è°ƒç”¨ä¸­ï¼Œè¢«è°ƒç”¨æ–¹å‡ºç°æ•…éšœæ—¶ï¼Œå‡ºäºè‡ªæˆ‘ä¿æŠ¤çš„ç›®çš„ï¼Œè°ƒç”¨æ–¹ä¼šä¸»åŠ¨åœæ­¢è°ƒç”¨ï¼Œå¹¶æ ¹æ®ä¸šåŠ¡éœ€è¦è¿›è¡Œç›¸åº”å¤„ç†ã€‚è°ƒç”¨æ–¹è¿™ç§ä¸»åŠ¨åœæ­¢è°ƒç”¨çš„è¡Œä¸ºæˆ‘ä»¬ç§°ä¹‹ä¸ºç†”æ–­ã€‚ ä¸ºä»€ä¹ˆè¦ç†”æ–­å‡å®šæœåŠ¡Aä¾èµ–æœåŠ¡Bï¼Œå½“æœåŠ¡Bå¤„äºæ­£å¸¸çŠ¶æ€ï¼Œæ•´ä¸ªè°ƒç”¨æ˜¯å¥åº·çš„ï¼ŒæœåŠ¡Aå¯ä»¥å¾—åˆ°æœåŠ¡Bçš„æ­£å¸¸å“åº”ã€‚å½“æœåŠ¡Bå‡ºç°æ•…éšœæ—¶ï¼Œæ¯”å¦‚å“åº”ç¼“æ…¢æˆ–è€…å“åº”è¶…æ—¶ï¼Œå¦‚æœæœåŠ¡Aç»§ç»­è¯·æ±‚æœåŠ¡Bï¼Œé‚£ä¹ˆæœåŠ¡Açš„å“åº”æ—¶é—´ä¹Ÿä¼šå¢åŠ ï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡Aå“åº”ç¼“æ…¢ã€‚å¦‚æœæœåŠ¡Aä¸è¿›è¡Œç†”æ–­å¤„ç†ï¼ŒæœåŠ¡Bçš„æ•…éšœä¼šä¼ å¯¼è‡³æœåŠ¡Aï¼Œæœ€ç»ˆå¯¼è‡´æœåŠ¡Aä¹Ÿä¸å¯ç”¨ã€‚ 5.traceidæ—¥å¿—ä¸­ä¸²ä¸€æ¬¡è¯·æ±‚çš„idï¼Œç³»ç»Ÿå¹¶å‘çš„æ—¶å€™ï¼Œå¤šæ¬¡è¯·æ±‚çš„æ—¥å¿—ä¼šäº¤å‰æ‰“å°ï¼Œæ’æŸ¥é—®é¢˜ä¼šæ¯”è¾ƒéš¾å—ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­åŠ å…¥traceidï¼Œå¯ä»¥ä¸²èµ·æ¥ä¸€æ¬¡å®Œæ•´è¯·æ±‚ï¼Œæœ‰æ¡ä»¶çš„å¯ä»¥æŠŠtraceidè¿›è¡Œä¼ é€’ï¼Œè¿™æ ·å°±èƒ½ç”¨traceidæŠŠä¸€èµ·å®Œæ•´çš„è¯·æ±‚åœ¨å„åº”ç”¨ç³»ç»Ÿä¸­ä¸€èµ·ä¸²èµ·æ¥ï¼Œä¹Ÿå°±å®ç°äº†é“¾è·¯è¿½è¸ªåŠŸèƒ½ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172//Constantä¸­çš„TRACE_IDå®šä¹‰//æ—¥å¿—ä¸­çš„traceidpublic static final String TRACE_ID = &quot;traceId&quot;;//traceidInterceptorimport org.slf4j.MDC;import org.springframework.util.StringUtils;import org.springframework.web.servlet.HandlerInterceptor;import javax.servlet.annotation.WebServlet;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.util.UUID;@WebServletpublic class TraceIDInterceptor implements HandlerInterceptor &#123; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) &#123; String traceID = request.getHeader(Constant.TRACE_ID); if (StringUtils.isEmpty(traceID)) &#123; traceID = UUID.randomUUID().toString(); &#125; MDC.put(Constant.TRACE_ID, traceID); return true; &#125;&#125;import org.springframework.context.annotation.Configuration;import org.springframework.web.servlet.config.annotation.InterceptorRegistry;import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;@Configurationpublic class InterceptorConfig implements WebMvcConfigurer &#123; @Override public void addInterceptors(InterceptorRegistry interceptorRegistry) &#123; // å¤šä¸ªæ‹¦æˆªå™¨ç»„æˆä¸€ä¸ªæ‹¦æˆªå™¨é“¾ // addPathPatterns ç”¨äºæ·»åŠ æ‹¦æˆªè§„åˆ™ // excludePathPatterns ç”¨æˆ·æ’é™¤æ‹¦æˆª interceptorRegistry.addInterceptor(new TraceIDInterceptor()).addPathPatterns(&quot;/**&quot;); &#125;&#125;//å¦‚æœfeignæ–¹å¼è°ƒç”¨å¾€ä¸‹æ¸¸ä¼ é€’çš„å¯ä»¥åŠ ä¸Šä¸‹é¢çš„Interceptorimport feign.RequestInterceptor;import feign.RequestTemplate;import org.slf4j.MDC;import org.springframework.context.annotation.Configuration;import org.springframework.util.StringUtils;import java.util.UUID;@Configurationpublic class FeignInterceptor implements RequestInterceptor &#123; @Override public void apply(RequestTemplate requestTemplate) &#123; String traceID = MDC.get(Constant.TRACE_ID); if (StringUtils.isEmpty(traceID)) &#123; traceID = UUID.randomUUID().toString(); &#125; requestTemplate.header(Constant.HEADER_TRACE_ID, traceID); &#125;&#125;//æ—¥å¿—é…ç½®æ–‡ä»¶ä¸­åŠ å…¥[%X&#123;traceId&#125;]//æ­¤æ—¶æ¥å£è°ƒç”¨çš„traceidåŠ å®Œäº†ï¼Œä½†æ˜¯ä¾‹å¦‚mqã€è°ƒåº¦ä¹‹ç±»çš„å¯èƒ½ä¸è¡Œï¼Œéœ€è¦åœ¨æ­¤ç±»ä»£ç å…¥å£æ‰‹åŠ¨è®¾ç½®traceidMDC.put(Constant.TRACE_ID, UUID.randomUUID().toString()); 6.æ–¹æ³•æ‰§è¡Œæ—¶é—´æ³¨è§£ä¸€ä¸ªæ¥å£è°ƒç”¨äº†ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼Œä¸€æ¬¡æ•°æ®åº“ä¿å­˜ï¼Œä¸¤æ¬¡rpcã€‚æŸä¸€å¤©ä¸Šæ¸¸åé¦ˆæ¥å£æ…¢ï¼Œè¯¥å¦‚ä½•è¿›è¡Œæ’æŸ¥å‘¢ï¼Ÿ ä¼˜åŒ–æ¥å£æ…¢ï¼Œé‚£å°±å¾—æ‰¾åˆ°å½±å“æ¥å£è€—æ—¶çš„å…³é”®ç‚¹ï¼Œæˆ‘ä»¬å¦‚æœçŸ¥é“äº†æ•°æ®åº“æŸ¥è¯¢è€—æ—¶ï¼Œæ•°æ®åº“ä¿å­˜è€—æ—¶ï¼Œä¸¤æ¬¡rpcçš„åˆ†åˆ«è€—æ—¶ï¼Œæ˜¯å¦é—®é¢˜å°±è¿åˆƒè€Œè§£äº†å‘¢ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051//è‡ªå®šä¹‰Timeræ³¨è§£import java.lang.annotation.ElementType;import java.lang.annotation.Retention;import java.lang.annotation.RetentionPolicy;import java.lang.annotation.Target;/** * æ ‡æ³¨éœ€è¦è®°å½•æ—¶é—´æ¶ˆè€—çš„æ–¹æ³• */@Target(ElementType.METHOD)@Retention(RetentionPolicy.RUNTIME)public @interface Timer &#123;&#125;//aopç¯ç»•è·å–æ–¹æ³•æ‰§è¡Œè€—æ—¶import lombok.extern.slf4j.Slf4j;import org.aspectj.lang.ProceedingJoinPoint;import org.aspectj.lang.annotation.Around;import org.aspectj.lang.annotation.Aspect;import org.springframework.stereotype.Component;/** * æ—¶é—´è®°å½•åˆ‡é¢ï¼Œæ”¶é›†æ¥å£çš„è¿è¡Œæ—¶é—´ */@Slf4j@Aspect@Componentpublic class TimeAspect &#123; // ä¿®æ­£Timeræ³¨è§£çš„å…¨å±€å”¯ä¸€é™å®šç¬¦ @Around(&quot;@annotation(com.renrenche.pricing.process.annotation.Timer)&quot;) public Object around(ProceedingJoinPoint joinPoint) throws Throwable &#123; // è·å–ç›®æ ‡ç±»åç§° String clazzName = joinPoint.getTarget().getClass().getName(); // è·å–ç›®æ ‡ç±»æ–¹æ³•åç§° String methodName = joinPoint.getSignature().getName(); long start = System.currentTimeMillis();// log.info(&quot;================================&#123;&#125;: &#123;&#125;: start...&quot;, clazzName, methodName); // è°ƒç”¨ç›®æ ‡æ–¹æ³• Object result = joinPoint.proceed(); long time = System.currentTimeMillis() - start; log.info(&quot;è€—æ—¶ç»Ÿè®¡:clazzName:&#123;&#125;,methodName:&#123;&#125;,time:&#123;&#125; ms&quot;, clazzName, methodName, time); return result; &#125;&#125;//ç”¨æ³•ï¼Œåœ¨éœ€è¦ç›‘æ§è€—æ—¶çš„æ–¹æ³•ä¸Šæ·»åŠ @Timeræ³¨è§£å³å¯è€—æ—¶ç»Ÿè®¡:clazzName:com.xx.xx.XX,methodName:queryXX,time:10 msè€—æ—¶ç»Ÿè®¡:clazzName:com.xx.xx.XX,methodName:saveXX,time:20 msè€—æ—¶ç»Ÿè®¡:clazzName:com.xx.xx.YY,methodName:queryYY,time:50 msè€—æ—¶ç»Ÿè®¡:clazzName:com.xx.xx.ZZ,methodName:queryZZ,time:500 msæˆ‘ä»¬åªéœ€è¦å»æ‰¾ä¸‹æ¸¸zzç³»ç»Ÿè´Ÿè´£äººæ²Ÿé€šæ¥å£è€—æ—¶é—®é¢˜å³å¯ 7.ä¸šåŠ¡è‡ªå®šä¹‰å¼‚å¸¸ä¼˜åŒ–å…³äºç³»ç»Ÿå†…éƒ¨è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ï¼Œå•ç³»ç»Ÿå†…éƒ¨å®šä¹‰ä¸€ä¸ªå³å¯ï¼Œå¦å¤–éœ€è¦é‡å†™Throwableä¸­fillInStackTraceæ–¹æ³•ï¼ŒåŸå› æœ‰äºŒï¼Œä¸€æ–¹é¢åŸfillInStackTraceæ–¹æ³•è¢«synchronizedä¿®é¥°ï¼Œå¦ä¸€æ–¹é¢fillInStackTraceæ–¹æ³•ä¸­è®¾ç½®äº†å¾ˆå¤šå †æ ˆä¿¡æ¯ï¼Œå¯¹äºè‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸æ¥è¯´æ˜¯ä¸å¤ªéœ€è¦çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344/** * è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ */public class BizException extends RuntimeException &#123; private static final long serialVersionUID = 1L; private String errorCode; private String errorMessage; public BizException(String errorCode, String errorMessage) &#123; this.errorMessage = errorMessage; this.errorCode = errorCode; &#125; public String getErrorCode() &#123; return this.errorCode; &#125; public void setErrorCode(String errorCode) &#123; this.errorCode = errorCode; &#125; public String getErrorMessage() &#123; return this.errorMessage; &#125; public void setErrorMessage(String errorMessage) &#123; this.errorMessage = errorMessage; &#125; //é‡å†™ä»¥æé«˜æ€§èƒ½ @Override public Throwable fillInStackTrace() &#123; return this; &#125; @Override public String toString() &#123; return &quot;AppRuntimeException&#123;&quot; + &quot;errorCode=&#x27;&quot; + errorCode + &#x27;\\&#x27;&#x27; + &quot;, errorMessage=&#x27;&quot; + errorMessage + &#x27;\\&#x27;&#x27; + &#x27;&#125;&#x27;; &#125;&#125; 8.é”™è¯¯æ–‡æ¡ˆè½¬æ¢å™¨1 9.validationutilå¾ˆå¤šäººå–œæ¬¢åœ¨controllerå±‚çš„reqå‰é¢å¢åŠ  @Validatedï¼Œç›´æ¥å¯¹å…¥å‚è¿›è¡Œæ ¼å¼æ ¡éªŒï¼Œä½†æ˜¯è¿™æ ·åšå¦‚æœå­—æ®µæ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼Œä¸ä¼šè¿›è¡Œå…¥å‚æ‰“å°ï¼Œä¸åˆ©äºé—®é¢˜æ’æŸ¥ï¼Œå¦ä¸€æ–¹é¢æŠ›å‡ºçš„å¼‚å¸¸ä¹Ÿä¸æ˜¯æˆ‘ä»¬æŒ‡å®šçš„ã€‚ 12345678910111213141516171819202122232425262728293031import com.renrenche.pricing.process.exception.BizException;import com.renrenche.rest.protocol.ErrorCode;import lombok.extern.slf4j.Slf4j;import org.springframework.util.CollectionUtils;import javax.validation.ConstraintViolation;import javax.validation.Validation;import javax.validation.Validator;import javax.validation.ValidatorFactory;import java.util.Set;@Slf4jpublic class ValidationUtil &#123; private static ValidatorFactory factory = Validation.buildDefaultValidatorFactory(); public static &lt;T&gt; void validate(T t) &#123; Validator validator = factory.getValidator(); Set&lt;ConstraintViolation&lt;T&gt;&gt; constraintViolations = validator.validate(t); if(!CollectionUtils.isEmpty(constraintViolations))&#123; StringBuilder errMsg=new StringBuilder(&quot;å‚æ•°æ ¡éªŒå¤±è´¥&quot;); for (ConstraintViolation&lt;T&gt; constraintViolation : constraintViolations) &#123; errMsg.append(&quot;,&quot;).append(constraintViolation.getMessage()); &#125; log.info(&quot;ValidationUtilæ ¡éªŒå‚æ•°å¤±è´¥&quot;); throw new BizException(ErrorCode.PARAM_INVALID, errMsg.toString()); //æ­¤å¤„å¯ä»¥å®šä¹‰ä¸€ä¸ªä¸“é—¨çš„ä¸šåŠ¡å¼‚å¸¸ç å€¼æ¥ä»£è¡¨å‚æ•°å¼‚å¸¸ï¼Œmsgæ”¾çš„æ˜¯å…¨é‡ä¿¡æ¯ï¼Œå¯ä»¥forå¾ªç¯è¿”å›å…¨é‡æœªé€šè¿‡åŸå› ï¼Œä¹Ÿå¯ä»¥åªè¿”å›å•æ¡ï¼Œä¸è¿‡å¤šæ¬¡è¯·æ±‚è¿”å›çš„ä¿¡æ¯ä¼šæœ‰ä¸åŒã€‚ &#125; &#125;&#125;//ç”¨æ³• ä»£ç æ˜¾ç¤ºè°ƒç”¨ValidationUtil.validate(xxx); 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import com.renrenche.pricing.process.validation.ValidationUtil;import lombok.Getter;import lombok.NoArgsConstructor;import lombok.Setter;import org.hibernate.validator.constraints.Length;import javax.validation.constraints.*;import java.io.Serializable;import java.math.BigDecimal;import java.util.List;@Setter@Getter@NoArgsConstructorpublic class DemoReq implements Serializable &#123; @NotBlank(message = &quot;nameä¸èƒ½ä¸ºç©º&quot;) @Length(min = 6, max = 30, message = &quot;nameåº”è¯¥åœ¨6-30å­—ç¬¦ä¹‹é—´&quot;) private String name; @NotNull(message = &quot;å¹´é¾„ä¸èƒ½ä¸ºç©º&quot;) @Min(value = 18, message = &quot;å¹´é¾„å¿…é¡»å¤§äºç­‰äº18&quot;) @Max(value = 20, message = &quot;å¹´é¾„å¿…é¡»å°äºç­‰äº20&quot;) private Integer age; @NotEmpty(message = &quot;nameListä¸èƒ½ä¸ºç©º&quot;) private List&lt;String&gt; nameList; @Pattern(regexp = &quot;^(.+)@(.+)$&quot;, message = &quot;é‚®ç®±çš„æ ¼å¼ä¸åˆæ³•&quot;) private String email; private Byte type; private Integer type2; @Pattern(regexp = &quot;aaaaa|bbbbb|ccccc&quot;, message = &quot;type3ä¸åœ¨æšä¸¾èŒƒå›´å†…&quot;) private String type3; @DecimalMin(value = &quot;150&quot;, message = &quot;å¿…é¡»å¤§äºç­‰äº150&quot;) @DecimalMax(value = &quot;300&quot;, message = &quot;å¿…é¡»å°äºç­‰äº300&quot;) @Digits(integer=3,fraction = 2,message = &quot;æ•´æ•°ä½ä¸Šé™ä¸º3ä½ï¼Œå°æ•°ä½ä¸Šé™ä¸º2ä½&quot;) private BigDecimal money; public static void main(String[] args) &#123; DemoReq demoReq=new DemoReq(); demoReq.setName(&quot;1111111&quot;);// demoReq.setType3(&quot;222&quot;); ValidationUtil.validate(demoReq); &#125; //å¦‚æœæœ‰å¯¹è±¡å®ä½“ï¼Œéœ€è¦æ·±å…¥æ ¡éªŒå¯¹è±¡å†…éƒ¨å­—æ®µæ ¼å¼çš„ï¼Œéœ€è¦åœ¨å®ä½“ä¸Šå¢åŠ @validæ³¨è§£&#125; 10.ç»Ÿä¸€æ—¥å¿—æ‰“å°å„å…¬å¸å†…éƒ¨åº”è¯¥é’ˆå¯¹äºæ—¥å¿—æ‰“å°æ ¼å¼å½¢æˆä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒï¼Œæ–¹ä¾¿æ—¥å¿—é‡‡é›†ï¼Œä¸ç®¡æ˜¯æœ€ç»ˆæ”¶é›†åˆ°å…¬å¸å†…éƒ¨è‡ªå»ºæ—¥å¿—å¹³å°ï¼Œè¿˜æ˜¯elkï¼Œæ ¼å¼è¿˜æ˜¯å¾—ç»Ÿä¸€çš„ã€‚ æŠ›ç –å¼•ç‰ï¼š log4j2 é…ç½®ï¼š 1Pattern: &quot;[%X&#123;trace_id&#125;] %-d&#123;yyyy-MM-dd HH:mm:ss&#125; - [%p] [%C&#123;1&#125; %M] %m%n&quot; logbacké…ç½® 1&lt;pattern&gt;[%X&#123;trace_id&#125;] %d&#123;yyyy-MM-dd HH:mm:ss&#125; - [%level] [%class&#123;0&#125; %method] %msg%n&lt;/pattern&gt; æ—¥å¿—ç¤ºä¾‹ï¼š [ed02f4ae5f18415b8a0143100b585f0e] 2019-03-14 18:32:08 - [INFO] [LogController test] this is my log!!! 11.æ¥å…¥ç»Ÿä¸€æ—¥å¿—å¹³å°ä¹‹å‰æœåŠ¡æ˜¯å•ä½“æ¶æ„ï¼Œä¸€ä¸ªæœåŠ¡å°±å¯¹åº”ä¸€å°æœåŠ¡å™¨ï¼Œæ’æ’ç”Ÿäº§é—®é¢˜æ—¶ï¼Œç™»é™†æœåŠ¡å™¨å³å¯ã€‚ ç°åœ¨éƒ½æ˜¯å¾®æœåŠ¡æ¶æ„ï¼Œä¸€ä¸ªæœåŠ¡ä¸€èˆ¬å¯¹åº”å¤šå°æœåŠ¡å™¨ï¼Œjdã€é˜¿é‡Œä¹‹ç±»çš„æ ¸å¿ƒç³»ç»ŸæœåŠ¡å™¨ä¸€ä¸ªé¡¹ç›®éƒ½æ˜¯ä¸Šåƒä¸Šä¸‡å°ï¼Œæ­¤æ—¶æ’æŸ¥é—®é¢˜å¦‚æœä¸€å°ä¸€å°ç™»é™†å»æŸ¥æ‰¾å°±æ ¹æœ¬æ²¡æ³•å¤„ç†äº†ã€‚ æ‰€ä»¥ä¸€èˆ¬å…¬å¸å†…éƒ¨éƒ½ä¼šæœ‰è‡ªå»ºæ—¥å¿—å¹³å°æˆ–è€…elkæ¥æ”¯æŒç”Ÿäº§æ—¥å¿—çš„å­˜å‚¨åŠæŸ¥è¯¢ã€‚ ä¸€èˆ¬çš„ä¸€ä¸ªæŸ¥è¯¢æµç¨‹ï¼šæ ¹æ®å…³é”®è¯æŸ¥è¯¢åˆ°å•æ¡æ—¥å¿—ï¼Œè·å–åˆ°traceidï¼Œç„¶åç»§ç»­æ ¹æ®traceidæŸ¥è¯¢å‡ºæ¥æœ¬æ¬¡è¯·æ±‚çš„å…¨é‡æ—¥å¿—è¿›è¡Œæ’æŸ¥ã€‚ 12.æ—¥å¿—çº§åˆ«åŠ¨æ€å˜æ›´ä¸€èˆ¬æœ‰ä¸‰ä¸ªå¾ˆå®é™…çš„åœºæ™¯ä¼šä½¿ç”¨ï¼Œä¸€ä¸ªæ˜¯å¤§ä¿ƒï¼ˆåŒåä¸€ã€618ï¼‰ï¼Œä¸€ä¸ªæ˜¯ç§’æ€ï¼Œå¦ä¸€ä¸ªæ˜¯çº¿ä¸Šå‡ºé—®é¢˜ä½†æ˜¯è¿˜æœªå®šä½åˆ°é—®é¢˜æ—¶ã€‚ å‰ä¸¤ç§æ˜¯å› ä¸ºç”¨æˆ·åˆæ³•è¯·æ±‚éå¸¸å¤šï¼Œæ‰“å°çš„æ—¥å¿—éå¸¸å¤šï¼Œæœ€åä¸€ç§æ˜¯ç”¨æˆ·ä¼šé¢‘ç¹ç‚¹å‡»ï¼Œæµé‡æ¿€å¢ä¸”é”™è¯¯æ—¥å¿—æ‰“å°éå¸¸å¤šã€‚æ­¤æ—¶éƒ½ä¼šé€ æˆæœºå™¨ioå‹åŠ›éå¸¸å¤§ã€‚å†ä»‹ç»ä¸€ä¸‹ä¸€èˆ¬æƒ…å†µä¸‹è¿ç»´æ¸…ç†æœåŠ¡å™¨æ—¥å¿—çš„æµç¨‹ï¼Œä¸€èˆ¬æ˜¯å®šæ—¶æ¯éš”xxæ—¶é—´å»æ‰«ææœåŠ¡å™¨ç£ç›˜ç©ºé—´å‰©ä½™ç™¾åˆ†æ¯”ï¼Œåˆ°è¾¾é˜ˆå€¼ä¼šè¿›è¡Œæ—¥å¿—å¤‡ä»½ï¼Œä¹‹ååˆ é™¤æœåŠ¡å™¨ä¸Šæ—¥å¿—ã€‚ä½†æ˜¯ä¸Šé¢ä¸‰ç§æƒ…å†µä¸‹ï¼Œä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œé¦–å…ˆæ˜¯ç£ç›˜ioä¼šéå¸¸é«˜ï¼Œä¼šå½±å“æ¥å£æ€§èƒ½ï¼Œå¦å¤–åœ¨è¿ç»´åŒå­¦è„šæœ¬æ‰«æçš„é—´éš™ï¼Œç£ç›˜æ»¡äº†ï¼Œæ­¤æ—¶æœåŠ¡å°±åºŸäº†ï¼Œè¿™ç§å…³é”®æ—¶é—´ç‚¹å‡ºäº‹æƒ…ï¼ŒP0å°‘ä¸äº†ï¼Œè½»åˆ™ä¸ªäººæ‹œæ‹œï¼Œé‡åˆ™éƒ¨é—¨è§£æ•£ï¼Œåæœå¾ˆä¸¥é‡ã€‚ ä¸€èˆ¬ä¼šå¯¹æ—¥å¿—è¿›è¡Œçº§åˆ«çš„åŠ¨æ€è°ƒæ•´ï¼Œå¹³æ—¶çº¿ä¸Šä¸ºinfoï¼Œå¤§ä¿ƒæ—¶é™åˆ°errorï¼Œçº¿ä¸Šå¤§æµé‡æœåŠ¡å‡ºé—®é¢˜æ—¶ï¼Œå¯ä»¥å…³é—­erroræ—¥å¿—ã€‚æ›´ä¼˜åŒ–çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ—¶ä¸æŒ‰ç…§é¡¹ç›®çº§åˆ«ç»Ÿä¸€å¯¹æ—¥å¿—çº§åˆ«è¿›è¡Œè°ƒæ•´ï¼Œè¿˜æ˜¯é’ˆå¯¹å•ä¸ªçš„loggerç±»æ¥è¿›è¡Œè°ƒæ•´ï¼Œè¿™æ ·ä¼šæ›´æœ‰é’ˆå¯¹æ€§ä¸€äº›ï¼Œå› ä¸ºæ—¥å¿—é™çº§æ˜¯ä¸ªåŒåˆƒå‰‘ï¼Œä¼šæå‡ç³»ç»Ÿæ€§èƒ½ï¼Œä½†æ˜¯åŒæ ·ä¼šä¸¢å¤±æ—¥å¿—ã€‚ 13.ä¸æ»‘ä¸Šçº¿ä¸‰ä¸ªæ–¹é¢ã€‚ æŠ€æœ¯å±‚é¢ã€‚ ä¸šåŠ¡å±‚é¢ã€‚å‘ç‰ˆç»éªŒ ã€‚ æŠ€æœ¯å±‚é¢ï¼š ä»¥Nacosæ³¨å†Œä¸­å¿ƒä¸ºä¾‹ï¼ŒæœåŠ¡aæœ‰ä¸¤å°æœåŠ¡å™¨ï¼Œä¸€èˆ¬ä¸Šçº¿çš„æ—¶å€™å¤§å®¶å°±ç›´æ¥å…ˆéƒ¨ç½²æœåŠ¡å™¨1ï¼Œå¯åŠ¨æˆåŠŸåå†éƒ¨ç½²æœåŠ¡å™¨2ï¼Œæ­¤æ—¶ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Œç›´æ¥é‡å¯æœåŠ¡å™¨1çš„æ—¶å€™ï¼ŒNacosæ˜¯ä¸çŸ¥é“æœåŠ¡å™¨1ä¸‹çº¿äº†ï¼Œè¿˜ä¼šæŠŠè¯·æ±‚è½¬å‘åˆ°æœåŠ¡å™¨1ä¸Šé¢ï¼Œè¿‡ä¸€æ®µæ—¶é—´Nacoså¿ƒè·³æ£€æµ‹å‘ç°æœåŠ¡å™¨1å®•æœºäº†ï¼Œæ­¤æ—¶æ‰ä¼šåœæ­¢è½¬å‘è¯·æ±‚åˆ°æœåŠ¡å™¨1ï¼Œä½†æ˜¯ä¸Šæ¸¸æ¥çœ‹å·²ç»æœ‰è¶…æ—¶å¤±è´¥çš„è¯·æ±‚äº†ã€‚ ä¸€ä¸ªåˆç†çš„ä¸Šçº¿æµç¨‹æ˜¯å…ˆåœ¨Nacosä¸Šå¯¹æœåŠ¡å™¨1çš„æœºå™¨è¿›è¡Œä¸‹çº¿ï¼Œè§‚å¯ŸæœåŠ¡å™¨1æ—¥å¿—ï¼Œç¡®è®¤æ— è¯·æ±‚è¿›å…¥åï¼Œé‡å¯æœåŠ¡å™¨1ï¼Œæ­¤æ—¶Nacosä¼šè‡ªåŠ¨é‡æ–°ä¸Šçº¿æœåŠ¡å™¨1ï¼Œä¹‹åè§‚å¯ŸæœåŠ¡å™¨1æœ‰æ­£å¸¸è¯·æ±‚è¿›å…¥åï¼Œåœ¨Nacosä¸Šå¯¹æœåŠ¡å™¨2çš„æœºå™¨è¿›è¡Œä¸‹çº¿ï¼Œè§‚å¯ŸæœåŠ¡å™¨2çš„æ—¥å¿—ï¼Œç¡®è®¤æ— è¯·æ±‚è¿›å…¥åï¼Œé‡å¯æœåŠ¡å™¨2ï¼Œç¡®ä¿æœåŠ¡å™¨2è¯·æ±‚æ­£å¸¸è¿›å…¥ï¼Œæœ¬æ¬¡å‘ç‰ˆç»“æŸã€‚ ä¸ºå•¥éœ€è¦Nacosä¸Šå¯¹æœåŠ¡å™¨ä¸‹çº¿ä»¥åè¿˜è¦ç»§ç»­è§‚å¯Ÿæ—¥å¿—å‘¢ï¼Œå› ä¸ºåœ¨Nacosä¸‹çº¿ä¸€å°æœåŠ¡å™¨åï¼Œå®é™…ç”Ÿæ•ˆä¼šæœ‰ä¸€ä¸ªçŸ­æš‚çš„é—´éš”ã€‚ ä¸Šé¢è¿™æ ·åšå¯¹äºä¸€ä¸ªæœåŠ¡å°±ä¸‰äº”å°æœåŠ¡å™¨çš„æœºå™¨æ¥è¯´ï¼Œè¿˜ç®—æœ‰å¯æ“ä½œæ€§ï¼Œå¤§å‚é‡Œé¢æœåŠ¡å™¨éƒ½æ˜¯å‡ åå°èµ·æ­¥ï¼Œæœ‰çš„ä¸Šåƒå°ï¼Œè¿™æ ·ææ•ˆç‡å¾ˆä½ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¯ä¸ªå…¬å¸éƒ½ä¼šæœ‰è‡ªå»ºçš„å‘ç‰ˆå¹³å°ï¼ˆegï¼šdevopsï¼‰ï¼Œåœ¨å¯¹æœºå™¨å‘ç‰ˆçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è¿›è¡ŒæœåŠ¡æµé‡ä¸‹çº¿ã€å‘ç‰ˆã€ä¸Šçº¿è¿™æ ·çš„æ“ä½œï¼Œå¯¹ç”¨æˆ·æ¥è®²å°±æ˜¯é€‰æ‹©å‡ å°æœºå™¨ï¼Œç„¶åå‘ç‰ˆå°±okäº†ã€‚ ä¸šåŠ¡å±‚é¢ï¼š ç»å¸¸ä¼šæœ‰çš„ä¸€ä¸ªéœ€æ±‚æ˜¯å¯¹æŸä¸ªæ¥å£çš„æµç¨‹è¿›è¡Œå‡çº§ï¼Œè€Œä¸”è¿˜æœ‰å¯èƒ½æ˜¯é¢ è¦†æ€§çš„ï¼Œæ­¤æ—¶å¦‚æœç›´æ¥ä¸Šçº¿ï¼Œå‡ºç‚¹é—®é¢˜ï¼Œæ•´ä¸ªæµç¨‹éƒ½åºŸäº†ï¼ŒP0æ€•æ˜¯è·‘ä¸äº†ã€‚ ä¸€èˆ¬è¿™ç§é¢ è¦†æ€§æˆ–è€…é‡æ„æ€§è´¨çš„å‡çº§ä¼šä¿ç•™è€æµç¨‹çš„é€»è¾‘ï¼Œè¿™å°±ä¿è¯äº†æœ‰é—®é¢˜çš„å¿«é€Ÿæµç¨‹åˆ‡æ¢ï¼Œå¦å¤–ä¸€æ–¹é¢ä¼šå¯¹æ–°è€æµç¨‹è¿›è¡Œåˆ‡é‡ï¼Œä¸Šçº¿åéƒ½æ˜¯100%è€æµç¨‹ï¼Œä¹‹å1%æ–°æµé‡ï¼Œè§‚å¯Ÿï¼Œçœ‹è¯·æ±‚æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œæœ‰é—®é¢˜ï¼Œç«‹é©¬100%åˆ‡è€æµç¨‹ï¼Œæ²¡é—®é¢˜ï¼Œæ¥å£é€»è¾‘æ­£å¸¸ï¼Œç¬¦åˆé¢„æœŸï¼Œç»§ç»­5%ï¼Œ10%ï¼Œç›´åˆ°100%æ–°æµç¨‹ã€‚ å‘ç‰ˆç»éªŒï¼š å‘ç‰ˆçš„æ—¶å€™ä¸€å®šè¦å…ˆåªå‘ä¸€å°ï¼Œå®Œäº†ä»¥åè§‚å¯Ÿæœ¬æ¬¡ä»£ç ä¿®æ”¹éƒ¨åˆ†æ˜¯å¦æ­£å¸¸ï¼Œç„¶åä¹Ÿè¦è§‚å¯Ÿerroræ—¥å¿—ï¼Œçœ‹æ˜¯å¦æœ‰å½±å“å…¶ä»–æµç¨‹ï¼Œè§‚å¯Ÿä¸€æ®µæ—¶é—´æ— é—®é¢˜ï¼Œåœ¨æ‰¹é‡å¯¹å…¶ä»–æœåŠ¡å™¨è¿›è¡Œå‘ç‰ˆã€‚ æœ‰äº›å…¬å¸æœåŠ¡å™¨ä¼šåˆ†ç»„ï¼Œæœ‰çš„æŒ‰æœºæˆ¿åˆ†ç»„ï¼Œæœ‰çš„æŒ‰è°ƒç”¨æ–¹åˆ†ç»„ï¼Œæ­¤æ—¶ä¸åŒåˆ†ç»„çš„é…ç½®æ–‡ä»¶å¯èƒ½æ˜¯ä¼šæœ‰äº›ä¸åŒçš„ï¼Œæ‰€ä»¥æ­¤æ—¶å‘ç‰ˆéœ€è¦æ¯ä¸ªåˆ†ç»„çš„æœºå™¨å„è‡ªå‘ç‰ˆä¸€å°ï¼ŒæŒ‰ä¸Šè¿°æµç¨‹è¿›è¡Œè§‚å¯Ÿï¼Œæ— é—®é¢˜åï¼Œå¯¹å…¶ä»–æœºå™¨è¿›è¡Œæ‰¹é‡å‘ç‰ˆã€‚é…ç½®æ–‡ä»¶çš„å°‘é…ï¼Œé…é”™ç»å¸¸å‘ç”Ÿï¼Œå¯¹çº¿ä¸Šæ“ä½œä¸€å®šè¦ä¿æŒæ•¬ç•ä¹‹å¿ƒã€‚ 14.æœåŠ¡éš”ç¦»æ ¸å¿ƒæœåŠ¡éœ€è¦åˆ†ç»„éƒ¨ç½²æä¾›æœåŠ¡ï¼Œä¸¤ç§åœºæ™¯å¯ä»¥ä½¿ç”¨ï¼ŒæœåŠ¡æ˜¯å…¬å…±æœåŠ¡ï¼Œå…¶ä¸­ä¸€ä¸ªä¸šåŠ¡æ–¹ç‰¹åˆ«å…³é”®ï¼Œå…¬å¸é»„é‡‘é“¾è·¯ç§çš„ä¸€ç¯ï¼Œå¦ä¸€ä¸ªæ˜¯å¤šä¸ªä¸šåŠ¡æ–¹ï¼Œå…¶ä¸­ä¸€ä¸ªé‡çº§ç‰¹åˆ«å¤§ï¼Œå…¶ä»–çš„åŠ èµ·æ¥ä¹Ÿå°±ä¸€ä¸¢ä¸¢ï¼Œæ­¤æ—¶å¯ä»¥è¿›è¡ŒæœåŠ¡éš”ç¦»ã€‚ ç±»ä¼¼äºdubboç±»å‹çš„æœåŠ¡å¯ä»¥åˆ†ä¸åŒåˆ«åæ¥ä¾›ä¸åŒä¸šåŠ¡æ–¹ä½¿ç”¨æ¥åšåˆ°æœåŠ¡éš”ç¦» httpç±»å‹çš„æœåŠ¡å¯ä»¥æ ¹æ®ä¸šåŠ¡æƒ…å†µéƒ¨ç½²å¤šå¥—ï¼Œä¸¾ä¸ªä¾‹å­ï¼šnginx Aè½¬å‘åˆ°æœåŠ¡å™¨1å’Œ2ï¼Œnginx Bè½¬å‘åˆ°æœåŠ¡å™¨3å’Œ4ï¼Œä¸ç”¨ä¸šåŠ¡æ–¹è°ƒç”¨ä¸åŒçš„è¯·æ±‚é“¾æ¥æ¥è¿›è¡ŒæœåŠ¡éš”ç¦» 15.è¿œç¨‹rpcè°ƒç”¨è¶…æ—¶æ—¶é—´åŠé‡è¯•æ§åˆ¶ä¸ºä»€ä¹ˆè¦è¿›è¡Œè¶…æ—¶è®¾ç½®å‘¢ï¼Ÿ ç”±äºä¸‹æ¸¸æœåŠ¡å“åº”è¿‡æ…¢ã€çº¿ç¨‹æ­»é”ã€çº¿ä¸ŠBUGç­‰ä¸€ç³»åˆ—åŸå› å¯¼è‡´æˆ‘ä»¬ä½œä¸ºè°ƒç”¨æ–¹è°ƒç”¨ä¹‹åä¸€ç›´æ²¡æœ‰å“åº”ã€‚ä»è€Œæœ€ç»ˆå¯¼è‡´ç”¨æˆ·è¯·æ±‚é•¿æ—¶é—´å¾—ä¸åˆ°å“åº”ï¼ŒåŒæ—¶é•¿æ—¶é—´å æœ‰çº¿ç¨‹èµ„æºç”šè‡³ä¼šæ‹–å®æ•´ä¸ªæœåŠ¡å½±å“å…¶ä»–æ­£å¸¸è¯·æ±‚ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥è¿›è¡Œè¶…æ—¶è®¾ç½®ï¼Œè¿™æ˜¯å¾®æœåŠ¡ä¸­å¿«é€Ÿå¤±è´¥çš„ä¸€ä¸ªåŸºæœ¬æ‰‹æ®µã€‚ ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è®¾ç½®å‘¢ï¼Ÿ é€šå¸¸æœ‰ä¸¤ä¸ªå±‚é¢çš„è¶…æ—¶ï¼šæœåŠ¡çº§è¶…æ—¶ã€æ¥å£çº§åˆ«çš„è¶…æ—¶ã€‚æœåŠ¡çº§åˆ«çš„è¶…æ—¶æ—¶é—´ä¸€èˆ¬ä»¥æœ€æ…¢æ¥å£çš„è€—æ—¶æ—¶é—´ä¸ºåŸºå‡†ã€‚è€Œä¸”å¤§éƒ¨åˆ†æ¡†æ¶éƒ½åªä¼šæœ‰æœåŠ¡çº§çš„è¶…æ—¶è®¾ç½®ï¼Œå¾ˆå°‘æœ‰æ¥å£çº§çš„è¶…æ—¶è®¾ç½®ã€‚æ¥å£çº§çš„è¶…æ—¶è®¾ç½®ï¼Œæ²¡æœ‰å¿…è¦æ‰€æœ‰æ¥å£éƒ½è®¾ç½®ï¼Œä»…é’ˆå¯¹æµé‡æå¤§ã€æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„æ¥å£è¿›è¡Œå•ç‹¬è®¾ç½®å°±è¡Œã€‚ ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼ŒæœåŠ¡è¶…æ—¶æ—¶æˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ åŸºäºè¿™ä¸ªè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸Šä¸‹æ¸¸ã€æµé‡ã€ä¸šåŠ¡åœºæ™¯è¿™ä¸‰ä¸ªç»´åº¦è¿›è¡Œè€ƒé‡ã€‚ è¶…æ—¶çš„å¤„ç†æ‰‹æ®µä¸€èˆ¬æœ‰ä¸¤ç§ï¼šé‡è¯•ã€å¼‚å¸¸å¿«é€Ÿè¿”å›ã€‚å†™åœºæ™¯é€šå¸¸ä¸è¦é‡è¯•ï¼ˆä¼šæœ‰å¹‚ç­‰ç›¸å…³é—®é¢˜ï¼Œä¸åŒæ¥å£å¹‚ç­‰å®ç°æ–¹å¼ä¸åŒï¼‰ã€‚æµé‡è¾ƒå¤§çš„æ¥å£ä¸€èˆ¬ä¸é€‚åˆé‡è¯•ï¼Œç›´æ¥è¿”å›å¼‚å¸¸å°±å¥½ï¼Œæœ€æç«¯çš„åœºæ™¯ä¸‹å®¹æ˜“å¯¼è‡´æµé‡ç¿»nå€ï¼Œå¯¼è‡´åé¢çš„é“¾è·¯å¥”æºƒã€‚ å…·ä½“è¶…æ—¶æ—¶é—´å’Œé‡è¯•æ¬¡æ•°å»ºè®®æ ¹æ®ä¸‹æ¸¸æ¥å£çš„å‹æµ‹TP999æ¥è¿›è¡Œè®¾ç½®ã€‚ egï¼šaæœåŠ¡ä¾èµ–bï¼ˆè¯»ï¼‰ã€cï¼ˆè¯»ï¼‰ã€dï¼ˆå†™ï¼‰æœåŠ¡ï¼ŒbæœåŠ¡tp999ä¸º15msï¼ŒcæœåŠ¡tp999ä¸º100msï¼ŒdæœåŠ¡tp999ä¸º20msï¼ŒaæœåŠ¡è¦æ±‚tp999å¿…é¡»åœ¨200msä»¥å†…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¾ç½®ï¼š bæœåŠ¡ï¼ˆè¶…æ—¶æ—¶é—´20msï¼Œé‡è¯•ä¸€æ¬¡ï¼‰ CæœåŠ¡ï¼ˆè¶…æ—¶æ—¶é—´120msï¼Œä¸é‡è¯•ï¼‰ dæœåŠ¡ï¼ˆè¶…æ—¶æ—¶é—´30msï¼Œä¸é‡è¯•ï¼‰ bæç«¯æƒ…å†µ20*2+cæç«¯120+dæç«¯30=190ms&lt;200ms 16.å¹‚ç­‰å¤„ç†æ¥å£çš„å¹‚ç­‰ä¸€èˆ¬é‡‡ç”¨ä¸¤å±‚é˜²æŠ¤æªæ–½è¿›è¡Œé˜²é‡è®¾è®¡ã€‚ é¦–å…ˆä¸€èˆ¬æ¥å£ä¼šåŠ ä¸Šè°ƒç”¨è¯·æ±‚æµæ°´å·å­—æ®µ 1.Redisçš„åˆ†å¸ƒå¼é”æ¥è§£å†³åŒç±»å‹è¯·æ±‚çš„å¹¶å‘ï¼ˆç›¸åŒç”¨æˆ·å¹¶å‘è¯·æ±‚ï¼Œçœ‹æƒ…å†µï¼Œæœ‰çš„ä¸šåŠ¡ä¹Ÿå¯ä»¥ä¸éœ€è¦ï¼Œå› ä¸ºæ¯•ç«Ÿæœ‰æ•°æ®çœ‹å…œåº•ï¼‰ 2.1åˆ†å¸ƒå¼é”ä¸­æŒ‰ç…§è¯·æ±‚æµæ°´å·æŸ¥è¯¢æ•°æ®ï¼Œæœ‰è®°å½•åˆ™ç›´æ¥è¿”å›ç°æœ‰æ•°æ®çŠ¶æ€åŠæ•°æ®ï¼Œæ— è®°å½•ç»§ç»­å¾€ä¸‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘ 2.2åˆ†å¸ƒå¼é”ä¸­æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åä¿å­˜ä¸šåŠ¡æ•°æ®ï¼Œé€šè¿‡æŠ“å–ä¿å­˜æ—¶æ•°æ®åº“æŠ¥å”¯ä¸€é”®å€¼å†²çªé”™æ¥è¾¾åˆ°å¹‚ç­‰å¤„ç†ï¼Œè¿”å›æ•°æ®ç°æœ‰æƒ…å†µ 3.DBå±‚ï¼Œè¯·æ±‚å”¯ä¸€æµæ°´å·è®¾ç½®å”¯ä¸€ç´¢å¼•ï¼Œä¿è¯DBåº•å±‚åªæœ‰ä¸€æ¡æ•°æ®å…¥åº“ã€‚ é€šå¸¸æƒ…å†µå¹‚ç­‰æ“ä½œä¼šæŒ‰ç…§ä¸Šè¿°é€»è¾‘è¿›è¡Œï¼Œç›¸åŒæµæ°´å·æ€ä¹ˆè¯·æ±‚ï¼Œè¿”å›çš„éƒ½æ˜¯å½“å‰æ—¶é—´ç‚¹è¯¥æ¡æ•°æ®çš„çœŸå®æƒ…å†µï¼Œä½†æ˜¯ä¹Ÿæœ‰åšçš„ç®€å•çš„æƒ…å†µï¼ŒæŒ‰ç…§æµæ°´å·æŸ¥è¯¢ï¼Œæœ‰æ•°æ®ï¼ŒæŠ›å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ä¸Šæ¸¸é”™è¯¯ç ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„å¦‚æœç”¨è¿™ç§æ–¹å¼ï¼Œä¸€æ–¹é¢éœ€è¦ä¿è¯è¯¥æ¥å£å¹‚ç­‰é”™è¯¯ç å”¯ä¸€ï¼Œä¸è¦å…¶ä»–æ ¡éªŒå¤±è´¥ä¹Ÿè¿”å›è¿™ä¸ªé”™è¯¯ç ï¼Œå¦ä¸€æ–¹é¢è¦æš´éœ²æŸ¥è¯¢æ¥å£ï¼Œè®©ä¸Šæ¸¸æ”¶åˆ°è¯¥é”™è¯¯ç åå¯ä»¥ç»§ç»­è¿›è¡ŒæŸ¥è¯¢æ¥å¾—åˆ°æœ€æ–°çš„çŠ¶æ€ç­‰ä¿¡æ¯ï¼Œä¸€èˆ¬å»ºè®®ç”¨ä¸Šé¢çš„æ–¹æ¡ˆï¼Œä½ å¥½æˆ‘å¥½å¤§å®¶å¥½ï¼Œå¤§å®¶å†™ä»£ç éƒ½æŒºèˆ’æœå¯¹å§ã€‚ ä¸‰ã€æ•°æ®æ²»ç†1.æ…¢æŸ¥è¯¢æ²»ç†å…¬å¸å†…éƒ¨æœ‰æ…¢sqlç›¸å…³è‡ªåŠ¨æŠ¥è­¦æœ€å¥½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°½é‡æ¯éš”ä¸€æ®µæ—¶é—´ä¸»åŠ¨æ‰¾dbaçœ‹çœ‹è‡ªå·±è´Ÿè´£ç³»ç»Ÿç›¸å…³åº“è¡¨ä¸­æ˜¯å¦æœ‰æ…¢sqlï¼Œç„¶ååœ¨æ ¹æ®ä¸åŒåœºæ™¯æ¥å†³å®šä¼˜åŒ–ä¸šåŠ¡æµç¨‹æˆ–è€…ä¿®æ”¹å¢åŠ ç´¢å¼•ã€‚ 2.æ•°æ®å¤‡ä»½ä¸æ¢å¤æ ¸å¿ƒæœåŠ¡æ•°æ®åº“ä¸»ä»åŒæ­¥è¿˜æ˜¯éœ€è¦æœ‰çš„ï¼Œä¸»åº“å‡ºé—®é¢˜çš„æ—¶å€™å¯ä»¥å¾ˆå¿«çš„è¿›è¡Œä¸»ä»åˆ‡æ¢ï¼Œå¦ä¸€æ–¹é¢å˜ç›¸çš„åšäº†æ•°æ®å¤‡ä»½ï¼Œå¦‚æœä¸€äº›éå®æ—¶æŸ¥è¯¢é€»è¾‘ä¹Ÿå¯ä»¥èµ°ä»åº“ã€‚ 3.å†·çƒ­æ•°æ®åˆ†ç¦»4.å†å²æ•°æ®å½’æ¡£å››ã€å˜æ›´ç®¡æ§1.å‘å¸ƒã€èµ„æºå˜æ›´2.æ•°æ®å˜æ›´3.æµé‡ç°åº¦4.A/B Testingäº”ã€å®¹é‡è¯„ä¼°1.å…¨é“¾è·¯å‹æµ‹2.å®¹é‡è§„åˆ’3.å¼¹æ€§èƒ½åŠ›å»ºè®¾4.å®¹é‡/æµé‡é¢„æµ‹å…­ã€é£é™©æ„ŸçŸ¥1.èµ„æºç›‘æ§2.ä¸šåŠ¡ç›‘æ§3.å®‰å…¨ç›‘æ§4.æ‹¨æµ‹5.ç³»ç»Ÿå·¡æ£€6.é’‰é’‰ä¸šåŠ¡æŠ¥è­¦7.jvmç›‘æ§8.æµé‡ç›‘æ§9.tps/tp999/maxç›‘æ§ä¸ƒã€é£é™©æ§åˆ¶1.é¢„æ¡ˆå»ºè®¾2.æµé‡è°ƒåº¦3.æœ€å°æƒé™ç®¡æ§å…«ã€é¢„é˜²ä¸æ¼”ç»ƒ1.å®¹ç¾æ¼”ç»ƒä¹ã€åˆ¶åº¦ä¿éšœ1.å€¼ç­oncall2.å¤„ç½®æµç¨‹3.æ•…éšœå®šä½4.ç¨³å®šæ€§å»ºè®¾ç›®æ ‡å’Œè¯„ä¼°","categories":[{"name":"11.æ–¹æ³•è®º","slug":"11-æ–¹æ³•è®º","permalink":"https://zhangxin66666.github.io/categories/11-%E6%96%B9%E6%B3%95%E8%AE%BA/"}],"tags":[{"name":"æ–¹æ³•è®º","slug":"æ–¹æ³•è®º","permalink":"https://zhangxin66666.github.io/tags/%E6%96%B9%E6%B3%95%E8%AE%BA/"}]},{"title":"è¡Œé¡µç´¢å¼•åº•å±‚ç»“æ„","slug":"7.mysql/è¡Œé¡µç´¢å¼•åº•å±‚ç»“æ„","date":"2022-01-04T16:00:00.000Z","updated":"2022-04-02T03:10:44.656Z","comments":true,"path":"2022/01/05/7.mysql/è¡Œé¡µç´¢å¼•åº•å±‚ç»“æ„/","link":"","permalink":"https://zhangxin66666.github.io/2022/01/05/7.mysql/%E8%A1%8C%E9%A1%B5%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84/","excerpt":"","text":"å‰è¨€é¦–å…ˆæ˜ç¡®ä¸‹ä»€ä¹ˆæ˜¯ç´¢å¼•å‘¢ï¼Ÿå‡è®¾æˆ‘ä¸€å¼ æ•°æ®åº“çš„è¡¨å­˜äº†10äº¿æ¡æ•°æ®ï¼Œå¦‚æœè¦æŸ¥æ‰¾å‡ºå…¶ä¸­çš„10æ¡æ•°æ®ï¼Œå¦‚æœé€æ¡éå†åŒ¹é…çš„è¯ï¼Œæ•ˆç‡ä¸Šè‚¯å®šæ˜¯æ— æ³•å®¹å¿çš„ã€‚æ‰€ä»¥ä¸ºäº†æé«˜æ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå°±éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¸€äº›æ ¼å¼åŒ–çš„å­˜å‚¨ï¼Œæ¥æ–¹ä¾¿æˆ‘ä»¬æ›´å¿«çš„æŸ¥æ‰¾ï¼Œè¿™å°±æ˜¯ç´¢å¼•ã€‚ ç´¢å¼•å…¶å®æ˜¯å¯¹æ•°æ®æŒ‰ç…§æŸç§æ ¼å¼è¿›è¡Œå­˜å‚¨çš„æ–‡ä»¶ã€‚å°±InnoDBæ¥è®²ï¼Œç´¢å¼•æ–‡ä»¶é‡Œé¢ä¼šæœ‰å¾ˆå¤šçš„åŸºæœ¬å•å…ƒã€é¡µã€‘ï¼Œä¸ºä»€ä¹ˆè¦æœ‰é¡µå‘¢ï¼Ÿ å¦‚æœæˆ‘ä»¬åœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ç›´æ¥äº¤äº’ç£ç›˜ï¼Œæ•ˆç‡æ˜¾ç„¶åˆä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥çœŸæ­£å¤„ç†æ•°æ®çš„è¿‡ç¨‹å…¶å®æ˜¯åœ¨å†…å­˜ä¸­ï¼Œè¿™æ ·å°±éœ€è¦æŠŠç£ç›˜çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œå¦‚æœæ˜¯å†™æ“ä½œï¼Œå¯èƒ½è¿˜è¦å°†å†…å­˜çš„æ•°æ®å†æ¬¡åˆ·æ–°åˆ°ç£ç›˜ã€‚å¦‚æœå†…å­˜ä¸ç£ç›˜çš„æ•°æ®äº¤äº’è¿‡ç¨‹æ˜¯åŸºäºä¸€æ¡æ¡è®°å½•æ¥è¿›è¡Œçš„ï¼Œæ˜¾ç„¶åˆä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥InnoDBé‡‡å–çš„æ–¹å¼æ˜¯å°†æ•°æ®åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªé¡µï¼Œä»¥é¡µæ¥ä½œä¸ºå†…å­˜å’Œç£ç›˜äº¤äº’çš„åŸºæœ¬å•ä½ï¼Œé»˜è®¤å¤§å°ä¸º16KBã€‚ æ¢å¥è¯è®²ï¼Œå…¶å®å°±æ˜¯å†…å­˜ä¸€æ¬¡æ‹‰åˆ°ç£ç›˜çš„æ•°æ®æœ€å°‘æ˜¯16KBï¼Œå†…å­˜å†™å…¥ç£ç›˜çš„æ•°æ®ä¸€æ¬¡æœ€å°‘ä¹Ÿæ˜¯16KBã€‚ ä¸Šé¢è§£é‡Šæ¸…æ¥šäº†ç´¢å¼•å’Œé¡µï¼ŒMySQLçš„InnoDBå­˜å‚¨å¼•æ“æ˜¯åŸºäºé¡µæ¥è¿›è¡Œå†…å­˜å’Œç£ç›˜çš„æ•°æ®äº¤äº’çš„ã€‚æ‰€ä»¥æˆ‘ä»¬çš„æ•°æ®æˆ–è€…å«è®°å½•ï¼Œå…¶å®æ˜¯ä»¥ã€è¡Œã€‘çš„æ ¼å¼å­˜å‚¨åœ¨é¡µé‡Œé¢çš„ï¼Œå¯ä»¥ç®€å•çš„ç†è§£æˆé¡µé‡Œé¢çš„ä¸€è¡Œå¯¹åº”ä¸€æ¡è®°å½•ã€‚ å½“ç„¶ç´¢å¼•æ–‡ä»¶é‡Œé¢è‚¯å®šä¸å…‰åªæœ‰é¡µï¼Œè¿˜ä¼šæœ‰å…¶ä½™çš„ä¸œè¥¿ï¼Œé¡µé‡Œé¢ä¹Ÿä¸å…‰åªæœ‰è¡Œæ ¼å¼ï¼Œä¹Ÿä¼šæœ‰é¢å¤–çš„ä¿¡æ¯ï¼Œè¿™ä¸ªä¸‹é¢æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†æï¼Œè‡³æ­¤æˆ‘ä»¬ä»…ä»…éœ€è¦æ˜ç¡®ä¸€ä¸‹ç´¢å¼•çš„æ¦‚å¿µå’Œå±‚çº§å…³ç³»ã€‚ æ˜ç¡®äº†è¿™ä¸ªå±‚çº§å…³ç³»ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»æœ€åŸºç¡€çš„è¡Œæ ¼å¼æ¥è¿›è¡Œåˆ†æã€‚ ä¸€ã€è¡Œæˆ‘ä»¬å¹³æ—¶éƒ½æ˜¯ä»¥è®°å½•ä¸ºå•ä½å‘è¡¨ä¸­æ’å…¥æ•°æ®çš„ï¼Œè¿™äº›è®°å½•åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨å½¢å¼è¢«ç§°ä¸ºè¡Œæ ¼å¼æˆ–è€…è®°å½•æ ¼å¼ï¼Œæˆªè‡³ç›®å‰ï¼Œä¸€å…±æœ‰4ç§è¡Œæ ¼å¼ã€‚åˆ†åˆ«æ˜¯ compact redundant dynamic compressedï¼ŒMySQL5.7é»˜è®¤çš„è¡Œæ ¼å¼ä¸ºdynamicã€‚ 1. å¦‚ä½•æŒ‡å®šè¡Œæ ¼å¼é¦–å…ˆæ¥çœ‹ä¸‹ï¼Œæˆ‘ä»¬å¦‚ä½•æ¥æŒ‡å®šè¡Œæ ¼å¼å‘¢ï¼Ÿ 123CREATE TABLE è¡¨å (åˆ—çš„ä¿¡æ¯) ROW_FORMAT=è¡Œæ ¼å¼åç§° ALTER TABLE è¡¨å ROW_FORMAT=è¡Œæ ¼å¼åç§° æ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€å¼ è¡¨æ¥æŒ‡å®šè¡Œæ ¼å¼ï¼š 123456create table record_format( c1 varchar(10), c2 varchar(10) not null, c3 char(10), c4 varchar(10))charset=ascii row_format=compact; 2.compact è¡Œæ ¼å¼ä¸€æ¡å®Œæ•´çš„è¡Œæ ¼å¼å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šè®°å½•é¢å¤–ä¿¡æ¯çš„éƒ¨åˆ†&amp;è®°å½•çœŸå®æ•°æ®çš„éƒ¨åˆ†ã€‚ 2.1 é¢å¤–çš„ä¿¡æ¯å…ˆæ¥çœ‹é¢å¤–çš„ä¿¡æ¯ï¼Œå…¶å®åŒ…å«ä¸‰éƒ¨åˆ†ï¼šå˜é•¿å­—æ®µçš„é•¿åº¦åˆ—è¡¨ï¼ŒNULLå€¼åˆ—è¡¨å’Œè®°å½•å¤´ä¿¡æ¯ã€‚ 2.1.1 å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨MySQLæ”¯æŒå¾ˆå¤šçš„å˜é•¿å­—æ®µï¼Œæˆ‘ä»¬å°±ä»¥æœ€ç»å…¸çš„varcharæ¥è¿›è¡Œä¸¾ä¾‹ï¼Œå˜é•¿å­—æ®µçš„æ•°æ®å­˜å‚¨å¤šå°‘å­—èŠ‚å…¶å®æ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨å­˜å‚¨çœŸå®çš„æ•°æ®çš„æ—¶å€™ï¼Œè¦è®°å½•ä¸€ä¸‹çœŸå®æ•°æ®çš„å­—èŠ‚æ•°ï¼Œè¿™æ ·çš„è¯ï¼Œä¸€ä¸ªå˜é•¿å­—æ®µåˆ—å®é™…ä¸Šå°±å ç”¨äº†ä¸¤éƒ¨åˆ†çš„ç©ºé—´æ¥å­˜å‚¨ï¼šã€çœŸå®æ•°æ®ã€‘&amp;ã€çœŸå®æ•°æ®å ç”¨å­—èŠ‚æ•°ã€‘ æ³¨æ„ï¼šå¯¹äºä¸€ä¸ªåˆ—varchar(100)ï¼Œæˆ‘ä»¬å®é™…ä¸Šå­˜å‚¨ä¸€ä¸ª10å­—èŠ‚çš„æ•°æ®ï¼Œå½“åœ¨å†…å­˜ä¸­ä¸ºè¿™ä¸ªåˆ—çš„æ•°æ®åˆ†é…å†…å­˜ç©ºé—´çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šåˆ†é…100å­—èŠ‚ï¼Œä½†æ˜¯è¿™ä¸ªåˆ—çš„æ•°æ®åœ¨ç£ç›˜ä¸Šï¼Œå®é™…ä¸Šåªä¼šåˆ†é…10å­—èŠ‚ã€‚ åœ¨Compactè¡Œæ ¼å¼ä¸­ï¼Œä¼šæŠŠæ‰€æœ‰çš„å˜é•¿å­—æ®µå ç”¨çš„çœŸå®é•¿åº¦å…¨éƒ¨é€†åºå­˜å‚¨åœ¨è®°å½•çš„å¼€å¤´ä½ç½®ï¼Œå½¢æˆä¸€ä¸ªå˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ã€‚ æ¯”å¦‚æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„é‚£å¼ è¡¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š c1,c2,c4ä¸‰ä¸ªåˆ—éƒ½æ˜¯å˜é•¿å­—æ®µï¼Œæ‰€ä»¥è¿™ä¸‰ä¸ªåˆ—çš„å€¼çš„é•¿åº¦å…¶å®éƒ½éœ€è¦ä¿å­˜åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œå› ä¸ºè¿™å¼ è¡¨çš„å­—ç¬¦é›†çš„ASCIIï¼Œæ‰€ä»¥æ¯ä¸ªå­—ç¬¦å®é™…åªå ç”¨1å­—èŠ‚æ¥è¿›è¡Œç¼–ç ï¼š åˆ—å å‚¨å­˜å†…å®¹ å†…å®¹é•¿åº¦(åè¿›åˆ¶è¡¨ç¤º) å†…å®¹é•¿åº¦(åå…­è¿›åˆ¶è¡¨ç¤º) C1 â€˜aaaaâ€™ 4 0x04 C2 â€˜bbbâ€™ 3 0x03 C4 â€˜dâ€™ 1 0x01 å› ä¸ºè¿™äº›é•¿åº¦æ˜¯æŒ‰ç…§é€†åºæ¥å­˜æ”¾çš„ï¼Œæ‰€ä»¥æœ€ç»ˆå˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨çš„å­—èŠ‚ä¸²ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºçš„æ•ˆæœå°±æ˜¯ã€010304ã€‘ã€‚ å› ä¸ºæˆ‘ä»¬æ¼”ç¤ºçš„è¿™æ¡è®°å½•ä¸­ï¼Œc1,c2,c4åˆ—ä¸­çš„å­—ç¬¦ä¸²éƒ½æ¯”è¾ƒçŸ­ï¼Œæ‰€ä»¥çœŸå®çš„æ•°æ®å ç”¨çš„å­—èŠ‚æ•°å°±æ¯”è¾ƒå°ï¼ŒçœŸå®æ•°æ®çš„é•¿åº¦ç”¨ä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºï¼Œä½†æ˜¯å¦‚æœå˜é•¿åˆ—çš„å†…å®¹å ç”¨å­—èŠ‚æ•°æ¯”è¾ƒå¤šï¼Œå¯èƒ½å°±éœ€è¦ç”¨2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚å¯¹æ­¤InnoDBçš„è§„å®šæ˜¯ï¼š ã€Wã€‘ï¼šæŸä¸ªå­—ç¬¦é›†ä¸­è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦ä½¿ç”¨çš„å­—èŠ‚æ•° ã€Mã€‘ï¼šå½“å‰åˆ—ç±»å‹æœ€å¤šèƒ½å­˜å‚¨çš„å­—ç¬¦æ•°(æ¯”å¦‚varchar(100),M=100),å¦‚æœæ¢ç®—æˆå­—èŠ‚æ•°å°±æ˜¯W*M ã€Lã€‘ï¼šçœŸå®å ç”¨çš„å­—èŠ‚æ•° å¦‚æœM*W&lt;=255,é‚£ä¹ˆä½¿ç”¨1å­—èŠ‚æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å®é™…ç”¨åˆ°çš„å­—èŠ‚æ•°ã€‚ InnoDBåœ¨è¯»è®°å½•çš„å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨çš„æ—¶å€™ä¼šå…ˆå»æŸ¥çœ‹è¡¨ç»“æ„ï¼Œåˆ¤æ–­ç”¨å‡ ä¸ªå­—èŠ‚å»å­˜å‚¨çš„ã€‚ å¦‚æœM*W&gt;=255,è¿™ä¸ªæ—¶å€™å†æ¬¡åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š å¦‚æœL&lt;=127ï¼Œé‚£å°±ç”¨1ä¸ªå­—èŠ‚è¡¨ç¤º å¦åˆ™å°±ç”¨2ä¸ªå­—èŠ‚è¡¨ç¤º å¦‚æœæŸä¸ªå˜é•¿å­—æ®µå…è®¸å­˜å‚¨çš„æœ€å¤§å­—èŠ‚æ•°å¤§äº255çš„æ—¶å€™ï¼Œæ€ä¹ˆåŒºåˆ†ä»–æ­£åœ¨è¯»å–çš„å­—èŠ‚æ˜¯ä¸€ä¸ªå•ç‹¬çš„å­—æ®µé•¿åº¦è¿˜æ˜¯åŠä¸ªå­—æ®µé•¿åº¦å‘¢ï¼Ÿ InnoDBç”¨è¯¥å­—èŠ‚çš„ç¬¬ä¸€ä¸ªäºŒè¿›åˆ¶ä¸ºä½œä¸ºæ ‡å¿—ä½ï¼Œ0ï¼šå•ç‹¬çš„å­—æ®µé•¿åº¦ï¼Œ1ï¼šåŠä¸ªå­—æ®µé•¿åº¦ã€‚ å¯¹äºä¸€äº›å ç”¨å­—èŠ‚æ•°ç‰¹åˆ«å¤šçš„å­—æ®µï¼Œå•ä¸ªé¡µéƒ½æ— æ³•å­˜å‚¨çš„æ—¶å€™ï¼ŒInnoDBä¼šæŠŠä¸€éƒ¨åˆ†æ•°æ®æ”¾åˆ°æ‰€è°“çš„æº¢å‡ºé¡µï¼Œåœ¨å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ä¸­åªä¼šè®°å½•å½“å‰é¡µçš„å­—æ®µé•¿åº¦ï¼Œæ‰€ä»¥ç”¨ä¸¤ä¸ªå­—èŠ‚ä¹Ÿå¯ä»¥å­˜çš„ä¸‹ã€‚ æ­¤å¤–ï¼Œå˜é•¿å­—æ®µçš„é•¿åº¦åˆ—è¡¨ä¸­åªå­˜å‚¨çœŸå®æ•°æ®å€¼ä¸ºéNULLçš„åˆ—å ç”¨çš„é•¿åº¦ï¼ŒçœŸå®æ•°æ®ä¸ºNULLçš„åˆ—çš„é•¿åº¦æ˜¯ä¸å­˜å‚¨çš„ã€‚ ä¹Ÿå¹¶ä¸æ˜¯æ‰€æœ‰çš„è®°å½•éƒ½ä¼šæœ‰å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œå‡å¦‚è¡¨ä¸­çš„åˆ—è¦æ˜¯æ²¡æœ‰å˜é•¿å­—æ®µï¼Œæˆ–è€…è®°å½•ä¸­çš„å˜é•¿å­—æ®µå€¼éƒ½æ˜¯NULLï¼Œé‚£å°±æ²¡æœ‰å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨äº†ã€‚ 2.1.2 NULLå€¼åˆ—è¡¨å¦‚æœä¸€æ¡è®°å½•æœ‰å¤šä¸ªå­—æ®µçš„çœŸå®å€¼ä¸ºNULLï¼Œä¸ç»Ÿä¸€ç®¡ç†çš„è¯å°±ä¼šæ¯”è¾ƒå ç”¨ç©ºé—´ï¼Œæ‰€ä»¥æŠ½å–å‡ºæ¥äº†NULLå€¼åˆ—è¡¨ã€‚ å½“ç„¶å¦‚æœè¿™ä¸ªè¡¨çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯NOT NULLçº¦æŸçš„ï¼Œå°±ä¸ä¼šæœ‰NULLå€¼åˆ—è¡¨ã€‚ çœ‹ä¸€ä¸‹å¤„ç†è¿‡ç¨‹ï¼š é¦–å…ˆç»Ÿè®¡å‡ºè¡¨ä¸­å…è®¸å­˜å‚¨NULLçš„å­—æ®µ å¦‚æœè¡¨ä¸­æ²¡æœ‰NULLå­—æ®µçš„åˆ—ï¼Œé‚£å°±æ²¡å¿…è¦å†å¾€ä¸‹äº†ï¼Œå¦åˆ™å°†æ¯ä¸ªå…è®¸å­˜å‚¨NULLçš„åˆ—å¯¹åº”çš„ä¸€ä¸ªäºŒè¿›åˆ¶ä½æŒ‰ç…§åˆ—çš„é¡ºåºé€†åºæ’åˆ—ã€‚1ï¼šNULLï¼Œ0ï¼šä¸æ˜¯NULLã€‚ MySQLè§„å®šNULLå€¼å¿…é¡»ç”¨æ•´æ•°ä¸ªå­—èŠ‚çš„ä½è¡¨ç¤ºï¼Œå¦‚æœä½¿ç”¨çš„äºŒè¿›åˆ¶ä½ä¸ªæ•°ä¸æ˜¯æ•´æ•°ä¸ªå­—èŠ‚ï¼Œåˆ™åœ¨å­—èŠ‚çš„é«˜ä½è¡¥0ã€‚ ä»¥æ­¤ç±»æ¨ï¼Œå¦‚æœä¸€ä¸ªè¡¨ä¸­æœ‰9ä¸ªå­—æ®µå…è®¸ä¸ºNULLï¼Œé‚£ä¹ˆè¿™ä¸ªè®°å½•çš„NULLå€¼åˆ—è¡¨éƒ¨åˆ†å°±éœ€è¦2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ è¿™ä¸ªæ—¶å€™å†æ¥çœ‹æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„è¡¨ä¸­çš„è®°å½•ã€‚ 2.1.3 è®°å½•å¤´ä¿¡æ¯ç”±äº”ä¸ªå›ºå®šçš„å­—èŠ‚ç»„æˆï¼Œæ¢ç®—æˆäºŒè¿›åˆ¶å°±æ˜¯40ä½ï¼Œæ¯ä¸€éƒ¨åˆ†ä»£è¡¨ä¸åŒçš„ä¿¡æ¯ã€‚ åç§° å¤§å°(bit) æè¿° é¢„ç•™ä½1 1 æ²¡æœ‰ä½¿ç”¨ é¢„ç•™ä½2 1 æ²¡æœ‰ä½¿ç”¨ delete_mask 1 æ ‡è®°è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤ min_rec_mask 1 B+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®° n_owned 4 è¡¨ç¤ºå½“å‰è®°å½•æ‹¥æœ‰çš„è®°å½•æ•° heap_no 13 è¡¨ç¤ºå½“å‰è®°å½•åœ¨è®°å½•å †çš„ä½ç½®ä¿¡æ¯ record_type 3 è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ 0 ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éé¡µèŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½• next_record 16 ä¸‹ä¸€æ¡è®°å½•çš„ç›¸å¯¹ä½ç½® é™¤äº†è¡¨ä¸­æ˜¾å¼å®šä¹‰çš„åˆ—ï¼ŒMySQLä¼šå¾€æˆ‘ä»¬çš„è¡¨ä¸­æ”¾ä¸€äº›éšè—åˆ—ã€‚ åˆ—å æ˜¯å¦å¿…é¡» å ç”¨ç©ºé—´ æè¿° row_id å¦ 6å­—èŠ‚ è¡ŒIDï¼Œå”¯ä¸€æ ‡è¯†ä¸€æ¡è®°å½• transaction_id æ˜¯ 6å­—èŠ‚ äº‹åŠ¡ID roll_pointer æ˜¯ 7å­—èŠ‚ å›æ»šæŒ‡é’ˆ ã€row_idã€‘ï¼šè¿™ä¸ªç©æ„ï¼Œè·Ÿä¸»é”®çš„é€‰æ‹©æœ‰å…³ï¼Œå¦‚æœæˆ‘ä»¬æ˜¾å¼å®šä¹‰äº†è¡¨çš„ä¸»é”®ï¼Œå°±ä¸ä¼šæœ‰å®ƒï¼Œå¦‚æœæˆ‘ä»¬æ²¡æ˜¾å¼å®šä¹‰ä¸»é”®ï¼Œé‚£ä¹ˆä¼šå»é€‰æ‹©ä¸€ä¸ªuniqueçš„åˆ—ä½œä¸ºä¸»é”®ï¼Œå¦‚æœuniqueçš„åˆ—ä¹Ÿæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±ä¼šç”Ÿæˆä¸€ä¸ªrow_idåˆ—ä½œä¸ºéšè—çš„ä¸»é”®ã€‚ ã€transaction_idã€‘&amp;ã€roll_pointerã€‘å’Œä¸€è‡´æ€§éé”è¯»(MVCC)æœ‰å…³,åé¢é‡åˆ°çš„æ—¶å€™æˆ‘ä¼šåœ¨åˆ†æä»‹ç»ã€‚ åœ¨å®Œå–„ä¸‹æˆ‘ä»¬å¼€å¤´åˆ›å»ºçš„é‚£å¼ è¡¨çš„è®°å½•å½¢è±¡ã€‚ è‡³æ­¤ï¼Œå…¶å®å°±å‰©ä¸‹æˆ‘ä»¬æ˜¾å¼æ’å…¥æ•°æ®åº“çš„çœŸå®è®°å½•äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç±»å‹éœ€è¦è¯´æ˜ä¸€ä¸‹ã€‚ 2.2.1 CHAR ä¹Ÿæ˜¯å˜é•¿çš„ï¼Ÿåœ¨Compactè¡Œæ ¼å¼ä¸‹åªä¼šæŠŠå˜é•¿ç±»å‹çš„åˆ—çš„é•¿åº¦é€†åºè®°å½•åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œä½†æ˜¯è¿™å…¶å®å’Œæˆ‘ä»¬çš„å­—ç¬¦é›†æœ‰å…³ç³»ï¼Œä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„è¡¨æ˜¾å¼æŒ‡å®šä¸ºASCIIå­—ç¬¦é›†ï¼Œè¿™ä¸ªæ—¶å€™ä¸€ä¸ªå­—ç¬¦åªä¼šç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œä½†æ˜¯å‡å¦‚æˆ‘ä»¬æŒ‡å®šçš„æ˜¯å…¶å®ƒå­—ç¬¦é›†ï¼Œæ¯”å¦‚utf8ï¼Œè¿™ä¸ªæ—¶å€™ä¸€ä¸ªå­—ç¬¦ç”¨å‡ ä¸ªå­—èŠ‚è¡¨ç¤ºå°±ä¸ç¡®å®šäº†ï¼Œæ‰€ä»¥CHARåˆ—çš„çœŸå®å­—èŠ‚é•¿åº¦ä¹Ÿä¼šè¢«è®°å½•åˆ°å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ã€‚ å¦å¤–ï¼Œå˜é•¿å­—ç¬¦é›†çš„CHAR(M)ç±»å‹çš„åˆ—è¦æ±‚è‡³å°‘å ç”¨Mä¸ªå­—èŠ‚ï¼Œè€ŒVARCHAR(M)å°±æ²¡æœ‰è¿™ä¸ªè¦æ±‚ã€‚ å¯¹äºä½¿ç”¨utf8å­—ç¬¦é›†çš„CHAR(10)çš„åˆ—æ¥è¯´ï¼Œè¯¥åˆ—å­˜å‚¨çš„æ•°æ®å­—èŠ‚é•¿åº¦çš„èŒƒå›´æ˜¯10ï½30ä¸ªå­—èŠ‚ã€‚å³ä½¿æˆ‘ä»¬å‘è¯¥åˆ—ä¸­å­˜å‚¨ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ä¹Ÿä¼šå ç”¨10ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯æ€•å°†æ¥æ›´æ–°è¯¥åˆ—çš„å€¼çš„å­—èŠ‚é•¿åº¦å¤§äºåŸæœ‰å€¼çš„å­—èŠ‚é•¿åº¦è€Œå°äº10ä¸ªå­—èŠ‚æ—¶ï¼Œå¯ä»¥åœ¨è¯¥è®°å½•å¤„ç›´æ¥æ›´æ–°ï¼Œè€Œä¸æ˜¯åœ¨å­˜å‚¨ç©ºé—´ä¸­é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„è®°å½•ç©ºé—´ï¼Œå¯¼è‡´åŸæœ‰çš„è®°å½•ç©ºé—´æˆä¸ºæ‰€è°“çš„ç¢ç‰‡ã€‚ 3. è¡Œæº¢å‡ºä¸Šé¢æåˆ°äº†ï¼Œå¦‚æœä¸€æ¡è®°å½•çš„çœŸå®å­—èŠ‚æ•°å¤ªå¤§ï¼Œå°±ä¼šå¯¼è‡´è¡Œæº¢å‡ºï¼ŒæŠŠè¶…å‡ºçš„ä¸€éƒ¨åˆ†æ•°æ®å­˜å‚¨åˆ°å…¶ä»–è¡Œæˆ–è€…é¡µã€‚ 3.1 varchar(M)æœ€å¤šèƒ½å­˜å‚¨çš„æ•°æ®varchar(M)çš„åˆ—æœ€å¤šå¯ä»¥å ç”¨65535ä¸ªå­—èŠ‚ã€‚å…¶ä¸­Mä»£è¡¨è¯¥ç±»å‹æœ€å¤šå­˜å‚¨çš„å­—ç¬¦æ•°é‡ã€‚ å®é™…ä¸Šï¼ŒMySQLå¯¹ä¸€æ¡è®°å½•å ç”¨çš„æœ€å¤§å­˜å‚¨ç©ºé—´æ˜¯æœ‰é™åˆ¶çš„ï¼Œé™¤äº†BLOBï¼ŒTEXTç±»å‹çš„åˆ—ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„åˆ—(ä¸åŒ…å«éšè—åˆ—å’Œè®°å½•å¤´ä¿¡æ¯)å ç”¨çš„å­—èŠ‚é•¿åº¦åŠ èµ·æ¥ä¸èƒ½è¶…è¿‡65535ä¸ªå­—èŠ‚ã€‚è¿™ä¸ª65535ä¸ªå­—èŠ‚é™¤äº†åˆ—æœ¬èº«çš„æ•°æ®ä¹‹å¤–ï¼Œè¿˜åŒ…æ‹¬ä¸€äº›å…¶ä»–çš„æ•°æ®ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ä¸ºäº†å­˜å‚¨ä¸€ä¸ªvarcharåˆ—ï¼Œå…¶å®è¿˜éœ€è¦å ç”¨3éƒ¨åˆ†ç©ºé—´ã€‚ çœŸå®æ•°æ® çœŸå®æ•°æ®å ç”¨çš„å­—èŠ‚é•¿åº¦ NULLå€¼æ ‡è¯†ï¼Œå¦‚æœè¯¥åˆ—æœ‰NOT_NULLå±æ€§åˆ™å¯ä»¥æ²¡æœ‰è¿™éƒ¨åˆ†å­˜å‚¨ç©ºé—´ å¦‚æœè¯¥varcharç±»å‹çš„åˆ—æ²¡æœ‰NOT NULLå±æ€§é‚£æœ€å¤šåªèƒ½å­˜å‚¨65532ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå› ä¸ºçœŸå®æ•°æ®çš„é•¿åº¦å¯èƒ½å ç”¨2ä¸ªå­—èŠ‚ï¼ŒNULLå€¼æ ‡è¯†éœ€è¦å ç”¨1ä¸ªå­—èŠ‚ã€‚ å¦‚æœVARCHARç±»å‹çš„åˆ—æœ‰NOT NULLå±æ€§ï¼Œé‚£æœ€å¤šåªèƒ½å­˜å‚¨65533ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå› ä¸ºçœŸå®æ•°æ®çš„é•¿åº¦å¯èƒ½å ç”¨2ä¸ªå­—èŠ‚ï¼Œä¸éœ€è¦NULLå€¼æ ‡è¯†ã€‚ å¦‚æœVARCHAR(M)ç±»å‹çš„åˆ—ä½¿ç”¨çš„ä¸æ˜¯asciiå­—ç¬¦é›†ï¼Œé‚£ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ å¦‚æœVARCHAR(M)ç±»å‹çš„åˆ—ä½¿ç”¨çš„ä¸æ˜¯asciiå­—ç¬¦é›†ï¼Œé‚£Mçš„æœ€å¤§å–å€¼å–å†³äºè¯¥å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦çš„å­—èŠ‚æ•°ã€‚åœ¨åˆ—çš„å€¼å…è®¸ä¸ºNULLçš„æƒ…å†µä¸‹ï¼Œgbkå­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦2ä¸ªå­—èŠ‚ï¼Œé‚£åœ¨è¯¥å­—ç¬¦é›†ä¸‹ï¼ŒMçš„æœ€å¤§å–å€¼å°±æ˜¯32766ï¼ˆä¹Ÿå°±æ˜¯ï¼š65532/2ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å¤šèƒ½å­˜å‚¨32766ä¸ªå­—ç¬¦ï¼›utf8å­—ç¬¦é›†è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æœ€å¤šéœ€è¦3ä¸ªå­—èŠ‚ï¼Œé‚£åœ¨è¯¥å­—ç¬¦é›†ä¸‹ï¼ŒMçš„æœ€å¤§å–å€¼å°±æ˜¯21844ï¼Œå°±æ˜¯è¯´æœ€å¤šèƒ½å­˜å‚¨21844ï¼ˆä¹Ÿå°±æ˜¯ï¼š65532/3ï¼‰ä¸ªå­—ç¬¦ã€‚ ä¸Šè¿°æ‰€è¨€åœ¨åˆ—çš„å€¼å…è®¸ä¸ºNULLçš„æƒ…å†µä¸‹ï¼Œgbkå­—ç¬¦é›†ä¸‹Mçš„æœ€å¤§å–å€¼å°±æ˜¯32766ï¼Œutf8å­—ç¬¦é›†ä¸‹Mçš„æœ€å¤§å–å€¼å°±æ˜¯21844ï¼Œè¿™éƒ½æ˜¯åœ¨è¡¨ä¸­åªæœ‰ä¸€ä¸ªå­—æ®µçš„æƒ…å†µä¸‹è¯´çš„ï¼Œä¸€å®šè¦è®°ä½ä¸€ä¸ªè¡Œä¸­çš„æ‰€æœ‰åˆ—ï¼ˆä¸åŒ…æ‹¬éšè—åˆ—å’Œè®°å½•å¤´ä¿¡æ¯ï¼‰å ç”¨çš„å­—èŠ‚é•¿åº¦åŠ èµ·æ¥ä¸èƒ½è¶…è¿‡65535ä¸ªå­—èŠ‚ï¼ 3.2 è®°å½•ä¸­çš„æ•°æ®å¤ªå¤šäº§ç”Ÿæº¢å‡ºMySQLä¸­ç£ç›˜å’Œå†…å­˜äº¤äº’çš„åŸºæœ¬å•ä½æ˜¯é¡µï¼Œä¹Ÿå°±æ˜¯è¯´MySQLæ˜¯ä»¥é¡µä¸ºåŸºæœ¬å•ä½æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œæˆ‘ä»¬çš„è®°å½•éƒ½ä¼šè¢«åˆ†é…åˆ°æŸä¸ªé¡µä¸­å­˜å‚¨ã€‚è€Œä¸€ä¸ªé¡µçš„å¤§å°ä¸€èˆ¬æ˜¯16KBï¼Œä¹Ÿå°±æ˜¯16384å­—èŠ‚ï¼Œè€Œä¸€ä¸ªVARCHAR(M)ç±»å‹çš„åˆ—å°±æœ€å¤šå¯ä»¥å­˜å‚¨65532ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±å¯èƒ½é€ æˆä¸€ä¸ªé¡µå­˜æ”¾ä¸äº†ä¸€æ¡è®°å½•çš„å°´å°¬æƒ…å†µã€‚ åœ¨Compactå’ŒRedundantè¡Œæ ¼å¼ä¸­ï¼Œå¯¹äºå ç”¨å­˜å‚¨ç©ºé—´éå¸¸å¤§çš„åˆ—ï¼Œåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„åªä¼šå­˜å‚¨è¯¥åˆ—çš„ä¸€éƒ¨åˆ†æ•°æ®ï¼ŒæŠŠå‰©ä½™çš„æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å‡ ä¸ªå…¶ä»–çš„é¡µä¸­ï¼Œç„¶åè®°å½•çš„çœŸå®æ•°æ®å¤„ç”¨20ä¸ªå­—èŠ‚å­˜å‚¨æŒ‡å‘è¿™äº›é¡µçš„åœ°å€ï¼ˆå½“ç„¶è¿™20ä¸ªå­—èŠ‚ä¸­è¿˜åŒ…æ‹¬è¿™äº›åˆ†æ•£åœ¨å…¶ä»–é¡µé¢ä¸­çš„æ•°æ®çš„å ç”¨çš„å­—èŠ‚æ•°ï¼‰ï¼Œä»è€Œå¯ä»¥æ‰¾åˆ°å‰©ä½™æ•°æ®æ‰€åœ¨çš„é¡µã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¯¹äºCompactå’ŒRedundantè¡Œæ ¼å¼æ¥è¯´ï¼Œå¦‚æœæŸä¸€åˆ—ä¸­çš„æ•°æ®éå¸¸å¤šçš„è¯ï¼Œåœ¨æœ¬è®°å½•çš„çœŸå®æ•°æ®å¤„åªä¼šå­˜å‚¨è¯¥åˆ—çš„å‰768ä¸ªå­—èŠ‚çš„æ•°æ®å’Œä¸€ä¸ªæŒ‡å‘å…¶ä»–é¡µçš„åœ°å€ï¼Œç„¶åæŠŠå‰©ä¸‹çš„æ•°æ®å­˜æ”¾åˆ°å…¶ä»–é¡µä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå«åšè¡Œæº¢å‡ºï¼Œå­˜å‚¨è¶…å‡º768å­—èŠ‚çš„é‚£äº›é¡µé¢ä¹Ÿè¢«ç§°ä¸ºæº¢å‡ºé¡µã€‚ç”»ä¸€ä¸ªç®€å›¾å°±æ˜¯è¿™æ ·ï¼š ä¸åªæ˜¯ VARCHAR(M)ç±»å‹çš„åˆ—ï¼Œå…¶ä»–çš„ TEXTã€BLOB ç±»å‹çš„åˆ—åœ¨å­˜å‚¨æ•°æ®éå¸¸å¤šçš„æ—¶å€™ä¹Ÿä¼šå‘ç”Ÿè¡Œæº¢å‡ºã€‚ 3.3 è¡Œæº¢å‡ºçš„ä¸´ç•Œç‚¹å‘ç”Ÿè¡Œæº¢å‡ºçš„ä¸´ç•Œç‚¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´åœ¨åˆ—å­˜å‚¨å¤šå°‘å­—èŠ‚çš„æ•°æ®æ—¶å°±ä¼šå‘ç”Ÿè¡Œæº¢å‡ºï¼Ÿ MySQLä¸­è§„å®šä¸€ä¸ªé¡µä¸­è‡³å°‘å­˜æ”¾ä¸¤è¡Œè®°å½•ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™ä¹ˆè§„å®šæˆ‘ä»¬ä¹‹åå†è¯´ï¼Œç°åœ¨çœ‹ä¸€ä¸‹è¿™ä¸ªè§„å®šé€ æˆçš„å½±å“ã€‚æˆ‘ä»¬å¾€è¡¨ä¸­æ’å…¥äº®æ¡è®°å½•ï¼Œæ¯æ¡è®°å½•æœ€å°‘æ’å…¥å¤šå°‘å­—èŠ‚çš„æ•°æ®æ‰ä¼šè¡Œæº¢å‡ºå‘¢ï¼Ÿ åˆ†æä¸€ä¸‹é¡µç©ºé—´æ˜¯å¦‚ä½•åˆ©ç”¨çš„ æ¯ä¸ªé¡µé™¤äº†å­˜æ”¾æˆ‘ä»¬çš„è®°å½•ä»¥å¤–ï¼Œä¹Ÿéœ€è¦å­˜å‚¨ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œä¹±ä¸ƒå…«ç³Ÿçš„é¢å¤–ä¿¡æ¯åŠ èµ·æ¥éœ€è¦132ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼ˆç°åœ¨åªè¦çŸ¥é“è¿™ä¸ªæ•°å­—å°±å¥½äº†ï¼‰ï¼Œå…¶ä»–çš„ç©ºé—´éƒ½å¯ä»¥è¢«ç”¨æ¥å­˜å‚¨è®°å½•ã€‚ æ¯ä¸ªè®°å½•éœ€è¦çš„é¢å¤–ä¿¡æ¯æ˜¯27å­—èŠ‚ã€‚è¿™27ä¸ªå­—èŠ‚åŒ…æ‹¬ä¸‹è¾¹è¿™äº›éƒ¨åˆ†ï¼š å†…å®¹ å¤§å°(å­—èŠ‚) çœŸå®æ•°æ®çš„é•¿åº¦ 2 åˆ—æ˜¯å¦æ˜¯NULLå€¼ 1 å¤´ä¿¡æ¯ 5 row_id 6 transaction_id 6 roll_pointer 7 å› ä¸ºè¡¨ä¸­å…·ä½“æœ‰å¤šå°‘åˆ—ä¸ç¡®å®šï¼Œæ‰€ä»¥æ²¡æ³•ç¡®å®šå…·ä½“çš„ä¸´ç•Œç‚¹ï¼Œåªéœ€è¦çŸ¥é“æ’å…¥çš„å­—æ®µæ•°æ®é•¿åº¦å¾ˆå¤§å°±ä¼šå¯¼è‡´è¡Œæº¢å‡ºçš„ç°è±¡ã€‚ 4.Dynamic &amp; Compressed è¡Œæ ¼å¼è¿™ä¿©è¡Œæ ¼å¼å’ŒCompactè¡Œæ ¼å¼æŒºåƒï¼Œåªä¸è¿‡åœ¨å¤„ç†è¡Œæº¢å‡ºæ•°æ®æ—¶æœ‰ç‚¹å„¿åˆ†æ­§ï¼Œå®ƒä»¬ä¸ä¼šåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„å­˜å‚¨å­—æ®µçœŸå®æ•°æ®çš„å‰768ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯æŠŠæ‰€æœ‰çš„å­—èŠ‚éƒ½å­˜å‚¨åˆ°å…¶ä»–é¡µé¢ä¸­ï¼Œåªåœ¨è®°å½•çš„çœŸå®æ•°æ®å¤„å­˜å‚¨å…¶ä»–é¡µé¢çš„åœ°å€ï¼Œå°±åƒè¿™æ ·ï¼š Compressedè¡Œæ ¼å¼å’ŒDynamicä¸åŒçš„ä¸€ç‚¹æ˜¯ï¼ŒCompressedè¡Œæ ¼å¼ä¼šé‡‡ç”¨å‹ç¼©ç®—æ³•å¯¹é¡µé¢è¿›è¡Œå‹ç¼©ï¼Œä»¥èŠ‚çœç©ºé—´ã€‚ è‡³æ­¤ï¼Œè¡Œæ ¼å¼å°±åˆ†æçš„å·®ä¸å¤šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹é¡µçš„å­˜å‚¨ç»“æ„ã€‚ äºŒã€é¡µInnoDBä¸ºäº†ä¸åŒçš„ç›®çš„è®¾è®¡äº†è®¸å¤šç§é¡µï¼Œæ¯”å¦‚å­˜æ”¾è¡¨ç©ºé—´å¤´éƒ¨ä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾ Insert Bufferä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾Innodeä¿¡æ¯çš„é¡µï¼Œå­˜æ”¾undoæ—¥å¿—ä¿¡æ¯çš„é¡µç­‰ç­‰ã€‚ æœ¬èŠ‚åˆ†æå­˜æ”¾è¡¨ä¸­è®°å½•çš„é¡µï¼Œå®˜æ–¹ç§°ä¸ºç´¢å¼•é¡µï¼Œä¸ºäº†åˆ†ææ–¹ä¾¿ï¼Œæˆ‘ä»¬æš‚ä¸”å«åšæ•°æ®é¡µã€‚ ç³»ç»Ÿå˜é‡innodb_page_sizeè¡¨æ˜äº†InnoDBå­˜å‚¨å¼•æ“ä¸­çš„é¡µå¤§å°ï¼Œé»˜è®¤å€¼æ˜¯16384å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯16kbã€‚ è¯¥å˜é‡åªèƒ½åœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–MySQLæ•°æ®ç›®å½•æ—¶æŒ‡å®šï¼Œä¹‹åå°±å†ä¹Ÿä¸èƒ½æ›´æ”¹äº†ã€‚ æ•°æ®é¡µä»£è¡¨çš„è¿™å—16kbçš„å­˜å‚¨ç©ºé—´è¢«åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†ï¼Œä¸åŒéƒ¨åˆ†æœ‰ä¸åŒçš„åŠŸèƒ½ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªInnoDBæ•°æ®é¡µçš„å­˜å‚¨ç©ºé—´å¤§è‡´è¢«åˆ’åˆ†ä¸ºäº†7ä¸ªéƒ¨åˆ†ï¼Œæœ‰çš„éƒ¨åˆ†å ç”¨çš„å­—èŠ‚æ•°æ˜¯ç¡®å®šçš„ï¼Œæœ‰çš„å ç”¨çš„å­—èŠ‚æ•°ä¸æ˜¯ç¡®å®šçš„ã€‚ åç§° ä¸­æ–‡å å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ ç®€å•æè¿° File Header æ–‡ä»¶å¤´éƒ¨ 38 é¡µçš„ä¸€äº›é€šç”¨ä¿¡æ¯ Page Header é¡µé¢å¤´éƒ¨ 56 æ•°æ®é¡µä¸“æœ‰çš„ä¸€äº›ä¿¡æ¯ Infifmum + Supremum æœ€å°è®°å½•å’Œæœ€å¤§è®°å½• 26 ä¸¤ä¸ªè™šæ‹Ÿçš„è¡Œè®°å½• User Records ç”¨æˆ·è®°å½• ä¸ç¡®å®š å®é™…å­˜å‚¨çš„è¡Œè®°å½•å†…å®¹ Free Space ç©ºé—²ç©ºé—´ ä¸ç¡®å®š é¡µä¸­å°šæœªä½¿ç”¨çš„ç©ºé—´ Page Directory é¡µé¢ç›®å½• ä¸ç¡®å®š é¡µä¸­æŸäº›è®°å½•çš„ç›¸å¯¹ä½ç½® File Trailer æ–‡ä»¶å°¾éƒ¨ 8 æ ¡éªŒé¡µæ˜¯å¦å®Œæ•´ 1. è®°å½•åœ¨é¡µä¸­çš„å­˜å‚¨æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€å¼ è¡¨ 1234567mysql&gt; create table page_demo( -&gt; c1 int , -&gt; c2 int , -&gt; c3 varchar(10000), -&gt; primary key(c1) -&gt; ) charset=ascii row_format=Compact;Query OK, 0 rows affected (0.03 sec) å› ä¸ºæˆ‘ä»¬æŒ‡å®šäº†ä¸»é”®ï¼Œæ‰€ä»¥å­˜å‚¨å®é™…æ•°æ®çš„åˆ—é‡Œé¢ä¸ä¼šæœ‰éšè—çš„row_id,æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–çš„è¡Œæ ¼å¼ã€‚ å†æ¬¡å›é¡¾ä¸‹è®°å½•å¤´ä¸­5ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ•°æ®ã€‚ åç§° å¤§å°(bit) æè¿° é¢„ç•™ä½1 1 æ²¡æœ‰ä½¿ç”¨ é¢„ç•™ä½2 1 æ²¡æœ‰ä½¿ç”¨ delete_mask 1 æ ‡è®°è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤ min_rec_mask 1 B+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®° n_owned 4 è¡¨ç¤ºå½“å‰è®°å½•æ‹¥æœ‰çš„è®°å½•æ•° heap_no 13 è¡¨ç¤ºå½“å‰è®°å½•åœ¨è®°å½•å †çš„ä½ç½®ä¿¡æ¯ record_type 3 è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ 0 ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éé¡µèŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½• next_record 16 ä¸‹ä¸€æ¡è®°å½•çš„ç›¸å¯¹ä½ç½® é’ˆå¯¹å½“å‰è¿™ä¸ªè¡¨çš„è¡Œæ ¼å¼ç®€åŒ–å›¾ï¼š æ¥ä¸‹æ¥æˆ‘ä»¬å¾€è¡¨ä¸­æ’å…¥å‡ æ¡æ•°æ®ï¼š 1INSERT INTO page_demo VALUES(1, 100, &#x27;aaaa&#x27;), (2, 200, &#x27;bbbb&#x27;), (3, 300, &#x27;cccc&#x27;), (4, 400, &#x27;dddd&#x27;); ä¸ºäº†åˆ†æè¿™äº›è®°å½•åœ¨é¡µçš„User Records éƒ¨åˆ†ä¸­æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„ï¼ŒæŠŠè®°å½•å¤´ä¿¡æ¯å’Œå®é™…çš„åˆ—æ•°æ®éƒ½ç”¨åè¿›åˆ¶è¡¨ç¤ºå‡ºæ¥äº†ï¼ˆå…¶å®æ˜¯ä¸€å †äºŒè¿›åˆ¶ä½ï¼‰ï¼Œæ‰€ä»¥è¿™äº›è®°å½•çš„ç¤ºæ„å›¾å°±æ˜¯ï¼š åˆ†æä¸€ä¸‹å¤´ä¿¡æ¯ä¸­çš„æ¯ä¸ªå±æ€§æ˜¯ä»€ä¹ˆæ„æ€ã€‚ 1.1 delete_maskæ ‡è®°å½“å‰è®°å½•æ˜¯å¦è¢«åˆ é™¤ï¼Œå ç”¨1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œ0ï¼šæœªåˆ é™¤ï¼Œ1ï¼šåˆ é™¤ã€‚ è¢«åˆ é™¤çš„è®°å½•ä¸ä¼šç«‹å³ä»ç£ç›˜ä¸Šåˆ é™¤ï¼Œå› ä¸ºåˆ é™¤ä»–ä»¬ä¹‹åå§å…¶ä»–çš„è®°å½•åœ¨ç£ç›˜ä¸Šé‡æ–°æ’åˆ—éœ€è¦æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥åªæ˜¯æ‰“ä¸€ä¸ªåˆ é™¤æ ‡è®°ï¼Œæ‰€æœ‰è¢«åˆ æ‰çš„æ•°æ®ä¼šç»„æˆä¸€ä¸ªåƒåœ¾é“¾è¡¨ï¼Œåœ¨è¿™ä¸ªé“¾è¡¨ä¸­çš„è®°å½•å ç”¨çš„ç©ºé—´æˆä¸ºå¯é‡ç”¨ç©ºé—´ï¼Œä¹‹åå¦‚æœæœ‰æ–°çš„è®°å½•æ’å…¥åˆ°è¡¨ä¸­ï¼Œå¯èƒ½ä¼šæŠŠè¿™äº›åˆ é™¤çš„è®°å½•è¦†ç›–æ‰ã€‚ å°†delete_mask è®¾ç½®ä¸º1 å’Œ å°†è¢«åˆ é™¤çš„è®°å½•åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­å…¶å®æ˜¯ä¸¤ä¸ªé˜¶æ®µã€‚ 1.2 min_rec_maskB+æ ‘çš„æ¯å±‚éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•éƒ½ä¼šæ·»åŠ è¯¥æ ‡è®°ï¼Œå¦‚æœè¿™ä¸ªå­—æ®µçš„å€¼æ˜¯0ï¼Œæ„å‘³ç€ä¸æ˜¯B+æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸­çš„æœ€å°è®°å½•ã€‚ 1.3 n_owned1.4 heap_noè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰è®°å½•åœ¨æœ¬é¡µä¸­çš„ä½ç½®ï¼Œæˆ‘ä»¬æ’å…¥çš„å››æ¡è®°å½•åœ¨æœ¬é¡µä¸­çš„ä½ç½®åˆ†åˆ«æ˜¯ 2ï¼Œ3ï¼Œ4 ï¼Œ5 ã€‚ä¸ºä»€ä¹ˆä¸è§ 0 å’Œ 1 çš„è®°å½•å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºInnoDBè‡ªåŠ¨ç»™æ¯ä¸ªé¡µé‡Œè¾¹åŠ äº†ä¸¤ä¸ªè®°å½•ï¼Œç”±äºè¿™ä¸¤ä¸ªè®°å½•å¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±æ’å…¥çš„ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿç§°ä¸ºè™šæ‹Ÿè®°å½•ã€‚è¿™ä¸¤ä¸ªä¼ªè®°å½•ä¸€ä¸ªä»£è¡¨æœ€å°è®°å½•ï¼Œä¸€ä¸ªä»£è¡¨æœ€å¤§è®°å½•ã€‚ è®°å½•æ˜¯å¦‚ä½•æ¯”è¾ƒå¤§å°çš„ï¼Ÿå¯¹äºä¸€æ¡å®Œæ•´çš„è®°å½•æ¥è¯´ï¼Œæ¯”è¾ƒè®°å½•å¤§å°å°±æ˜¯æ¯”è¾ƒä¸»é”®çš„å¤§å°ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æ’å…¥çš„4è¡Œè®°å½•çš„ä¸»é”®å€¼åˆ†åˆ«ä¸º1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€è¿™å››æ¡è®°å½•çš„å¤§å°ä»å¤§åˆ°å°é€’å¢ã€‚ ä½†æ˜¯ä¸ç®¡æˆ‘ä»¬å¾€é¡µä¸­æ’å…¥äº†å¤šå°‘è‡ªå·±çš„è®°å½•ï¼ŒInnoDBéƒ½è§„å®šä»–ä»¬å®šä¹‰çš„ä¸¤æ¡ä¼ªè®°å½•åˆ†åˆ«ä¸ºæœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ã€‚è¿™ä¸¤æ¡è®°å½•çš„æ„é€ ååˆ†ç®€å•ï¼Œéƒ½æ˜¯ç”±5å­—èŠ‚å¤§å°çš„è®°å½•å¤´ä¿¡æ¯å’Œ8å­—èŠ‚å¤§å°çš„ä¸€ä¸ªå›ºå®šçš„éƒ¨åˆ†ç»„æˆçš„ã€‚ ç”±äºè¿™ä¸¤æ¡è®°å½•ä¸æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„è®°å½•ï¼Œæ‰€ä»¥ä»–ä»¬å¹¶ä¸å­˜æ”¾åœ¨é¡µçš„User Recordséƒ¨åˆ†ï¼Œä»–ä»¬è¢«å•ç‹¬æ”¾åœ¨ä¸€ä¸ªç§°ä¸ºInfimum+Supremumçš„éƒ¨åˆ†ã€‚ ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œæœ€å°è®°å½•å’Œæœ€å¤§è®°å½•çš„heap_noå€¼åˆ†åˆ«æ˜¯0 å’Œ 1 ï¼Œ ä¹Ÿå°±æ˜¯è¯´ä»–ä»¬çš„ä½ç½®æœ€é å‰ã€‚ 1.5 record_typeè¿™ä¸ªå±æ€§è¡¨ç¤ºå½“å‰è®°å½•çš„ç±»å‹ã€‚0ï¼šæ™®é€šè®°å½•ï¼Œ1ï¼šB+æ ‘éå¶å­èŠ‚ç‚¹è®°å½•ï¼Œ2ï¼šæœ€å°è®°å½•ï¼Œ3ï¼šæœ€å¤§è®°å½•ã€‚ æˆ‘ä»¬è‡ªå·±æ’å…¥çš„è®°å½•æ˜¯æ™®é€šè®°å½• 0 ï¼Œ è€Œæœ€å¤§è®°å½•å’Œæœ€å°è®°å½•record_type åˆ†åˆ«ä¸º 2 å’Œ 3ã€‚ 1.6 next_recordè¡¨ç¤ºä»å½“å‰è®°å½•çš„çœŸå®æ•°æ®åˆ°ä¸‹ä¸€æ¡è®°å½•çš„çœŸå®æ•°æ®çš„åœ°å€åç§»é‡ã€‚è¿™å…¶å®æ˜¯ä¸€æ¡é“¾è¡¨ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¡è®°å½•æ‰¾åˆ°ä»–çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯ä¸‹ä¸€æ¡è®°å½•æŒ‡çš„å¹¶ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æ’å…¥é¡ºåºçš„ä¸‹ä¸€æ¡è®°å½•ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§çš„é¡ºåºçš„ä¸‹ä¸€æ¡è®°å½•ã€‚è€Œä¸”è§„å®š infimumè®°å½• çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æœ¬é¡µä¸»é”®å€¼æœ€å°çš„ç”¨æˆ·è®°å½•ï¼Œè€Œæœ¬é¡µä¸­ä¸»é”®æœ€å¤§çš„ç”¨æˆ·è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯supremumè®°å½•ã€‚ å¦‚æœä»ä¸­åˆ é™¤ä¸€æ¡è®°å½•ï¼Œè¿™ä¸ªé“¾è¡¨ä¹Ÿæ˜¯ä¼šè·Ÿç€å˜åŒ–çš„ï¼Œå‡å¦‚ç°åœ¨åˆ é™¤ç¬¬äºŒæ¡è®°å½• 1delete from page_demo where c1 =2 ; åˆ é™¤ç¬¬äºŒæ¡è®°å½•ä»¥åï¼š å‘ç”Ÿçš„å˜åŒ–ï¼š ç¬¬äºŒæ¡è®°å½•å¹¶æ²¡æœ‰ä»å­˜å‚¨ç©ºé—´ä¸­ç§»é™¤ï¼Œè€Œæ˜¯æŠŠè¯¥è®°å½•çš„delete_maskè®¾ç½®ä¸º1 ç¬¬äºŒæ¡è®°å½•çš„next_recordså€¼å˜æˆäº†0ï¼Œæ„å‘³ç€è¯¥è®°å½•æ²¡æœ‰ä¸‹ä¸€æ¡è®°å½•äº† ç¬¬ä¸€æ¡è®°å½•çš„next recordæŒ‡å‘äº†ç¬¬ä¸‰æ¡è®°å½• æœ€å¤§è®°å½•çš„ n_owned å€¼ä»5 å˜æˆäº†4 æ‰€ä»¥ï¼Œä¸è®ºæˆ‘ä»¬æ€ä¹ˆå¯¹é¡µä¸­çš„è®°å½•åšå¢åˆ æ”¹æŸ¥æ“ä½œï¼ŒInnoDBå§‹ç»ˆä¼šç»´æŠ¤ä¸€æ¡è®°å½•çš„å•é“¾è¡¨ï¼Œé“¾è¡¨ä¸­å„ä¸ªèŠ‚ç‚¹æ˜¯æŒ‰ç…§ä¸»é”®å€¼ç”±å°åˆ°å¤§çš„é¡ºåºè¿æ¥èµ·æ¥çš„ã€‚ next_records ä¸ºå•¥è¦æŒ‡å‘è®°å½•å¤´ä¿¡æ¯å’ŒçœŸå®æ•°æ®ä¹‹é—´çš„ä½ç½®å‘¢ï¼Ÿä¸ºå•¥ä¸å¹²è„†æŒ‡å‘æ•´æ¡è®°å½•çš„å¼€å¤´ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è®°å½•çš„é¢å¤–ä¿¡æ¯å¼€å¤´çš„ä½ç½®å‘¢ï¼Ÿ å› ä¸ºè¿™ä¸ªä½ç½®åˆšåˆšå¥½ï¼Œå‘å·¦è¯»å–å°±æ˜¯è®°å½•å¤´ä¿¡æ¯ï¼Œå‘å³è¯»å–å°±æ˜¯çœŸå®æ•°æ®ã€‚æˆ‘ä»¬å‰è¾¹è¿˜è¯´è¿‡å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨ï¼Œnullå€¼åˆ—è¡¨ä¸­çš„ä¿¡æ¯éƒ½æ˜¯é€†åºå­˜æ”¾çš„ï¼Œè¿™æ ·å¯ä»¥ä½¿è®°å½•ä¸­ä½ç½®é å‰çš„å­—æ®µå’Œä»–ä»¬å¯¹åº”çš„å­—æ®µé•¿åº¦ä¿¡æ¯åœ¨å†…å­˜ä¸­çš„è·ç¦»æ›´è¿‘ï¼Œå¯èƒ½ä¼šæé«˜é«˜é€Ÿç¼“å­˜çš„å‘½ä¸­ç‡ã€‚ å› ä¸ºä¸»é”®å€¼ä¸º2çš„è®°å½•å·²ç»è¢«æˆ‘ä»¬åˆ é™¤äº†ï¼Œä½†æ˜¯å­˜å‚¨ç©ºé—´å¹¶æ²¡æœ‰å›æ”¶ï¼Œå¦‚æœå†æ¬¡æŠŠè¿™æ¡è®°å½•æ’å…¥åˆ°è¡¨ä¸­ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ 1INSERT INTO page_demo VALUES(2, 200, &#x27;bbbb&#x27;); ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒInnoDBå¹¶æ²¡æœ‰å› ä¸ºæ–°è®°å½•çš„æ’å…¥è€Œä¸ºä»–ç”³è¯·æ–°çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œæ˜¯ç›´æ¥å¤ç”¨äº†åŸæ¥åˆ é™¤çš„è®°å½•çš„å­˜å‚¨ç©ºé—´ã€‚ 2. Page Directoryï¼ˆé¡µç›®å½•ï¼‰å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸»é”®å€¼æŸ¥æ‰¾é¡µä¸­æŸæ¡è®°å½•è¯¥å’‹åŠï¼Ÿ 1select * from page_demo where c1 = 3; å°†æ‰€æœ‰æ­£å¸¸çš„è®°å½•(åŒ…æ‹¬ä¸¤æ¡éšè—è®°å½•ä½†æ˜¯ä¸åŒ…æ‹¬å·²ç»æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•)åˆ’åˆ†ä¸ºå‡ ç»„ æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•ï¼ˆä¹Ÿå°±æ˜¯ç»„å†…æœ€å¤§çš„é‚£æ¡è®°å½•ï¼‰çš„å¤´ä¿¡æ¯ä¸­çš„n_ownedå±æ€§è¡¨ç¤ºè¯¥ç»„æ‹¥æœ‰å¤šå°‘æ¡è®°å½• å°†æ¯ä¸ªç»„çš„æœ€åä¸€æ¡è®°å½•çš„åœ°å€åç§»é‡å•ç‹¬æå–å‡ºæ¥æŒ‰ç…§é¡ºåºå­˜å‚¨åˆ°é è¿‘é¡µçš„å°¾éƒ¨çš„åœ°æ–¹ï¼Œè¿™ä¸ªåœ°æ–¹å°±æ˜¯æ‰€è°“çš„ã€Page Directoryã€‘,ä¹Ÿå°±æ˜¯é¡µç›®å½•ã€‚é¡µç›®å½•ä¸­çš„è¿™äº›åœ°å€åç§»é‡è¢«ç§°ä¸ºæ§½ï¼Œæ‰€ä»¥é¡µç›®å½•å°±æ˜¯ç”±æ§½ç»„æˆçš„ æ¯”æ–¹è¯´åˆšæ‰åˆ›å»ºçš„è¡¨ä¸­æ­£å¸¸çš„è®°å½•ç”±6æ¡ï¼ŒInnoDBä¼šæŠŠä»–ä»¬åˆ†æˆä¸¤ç»„ï¼Œç¬¬ä¸€ç»„ä¸­åªæœ‰ä¸€æ¡æœ€å°è®°å½•ï¼Œç¬¬äºŒç»„ä¸­æ˜¯å‰©ä½™çš„5æ¡è®°å½•ã€‚ ç°åœ¨é¡µç›®å½•éƒ¨åˆ†ä¸­æœ‰ä¸¤ä¸ªæ§½ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬çš„è®°å½•è¢«åˆ†æˆäº†ä¸¤ä¸ªç»„ï¼Œæ§½1ä¸­çš„å€¼ä¸º112ï¼Œä»£è¡¨æœ€å¤§è®°å½•çš„åœ°å€åç§»é‡ï¼›æ§½0çš„å€¼ä¸º99ï¼Œä»£è¡¨æœ€å°è®°å½•çš„åœ°å€åç§»é‡ã€‚ æ³¨æ„æœ€å¤§å’Œæœ€å°è®°å½•çš„å¤´ä¿¡æ¯çš„n_ownedå±æ€§ï¼š æœ€å°è®°å½•ä¸­çš„n_ownedå€¼ä¸º1ï¼Œè¿™å°±ä»£è¡¨ç€ä»¥æœ€å°è®°å½•ç»“å°¾çš„è¿™ä¸ªåˆ†ç»„ä¸­åªæœ‰1æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯æœ€å°è®°å½•æœ¬èº« æœ€å¤§è®°å½•ä¸­çš„n_ownedå€¼ä¸º5ï¼Œè¿™å°±ä»£è¡¨ç€ä»¥æœ€å¤§è®°å½•ç»“å°¾çš„è¿™ä¸ªåˆ†ç»„ä¸­åªæœ‰5æ¡è®°å½•ï¼ŒåŒ…æ‹¬æœ€å¤§è®°å½•æœ¬èº«è¿˜æœ‰æˆ‘ä»¬è‡ªå·±æ’å…¥çš„4æ¡è®°å½• ã€99ã€‘&amp;ã€112ã€‘è¿™æ ·çš„åœ°å€åç§»é‡å¾ˆä¸ç›´è§‚ï¼Œæˆ‘ä»¬ç”¨ç®­å¤´æŒ‡å‘çš„æ–¹å¼æ›¿ä»£æ•°å­—ã€‚ InnoDBå¯¹æ¯ä¸ªåˆ†ç»„ä¸­çš„è®°å½•æ¡æ•°æ˜¯æœ‰è§„å®šçš„ï¼šå¯¹äºæœ€å°è®°å½•æ‰€åœ¨çš„åˆ†ç»„åªèƒ½æœ‰ 1 æ¡è®°å½•ï¼Œæœ€å¤§è®°å½•æ‰€åœ¨çš„åˆ†ç»„æ‹¥æœ‰çš„è®°å½•æ¡æ•°åªèƒ½åœ¨ 1~8 æ¡ä¹‹é—´ï¼Œå‰©ä¸‹çš„åˆ†ç»„ä¸­è®°å½•çš„æ¡æ•°èŒƒå›´åªèƒ½åœ¨æ˜¯ 4~8 æ¡ä¹‹é—´ã€‚æ‰€ä»¥åˆ†ç»„æ˜¯æŒ‰ç…§ä¸‹è¾¹çš„æ­¥éª¤è¿›è¡Œçš„ï¼š åˆå§‹æƒ…å†µä¸‹ä¸€ä¸ªæ•°æ®é¡µé‡Œåªæœ‰æœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ä¸¤æ¡è®°å½•ï¼Œå®ƒä»¬åˆ†å±äºä¸¤ä¸ªåˆ†ç»„ã€‚ ä¹‹åæ¯æ’å…¥ä¸€æ¡è®°å½•ï¼Œéƒ½ä¼šä»é¡µç›®å½•ä¸­æ‰¾åˆ°ä¸»é”®å€¼æ¯”æœ¬è®°å½•çš„ä¸»é”®å€¼å¤§å¹¶ä¸”å·®å€¼æœ€å°çš„æ§½ï¼Œç„¶åæŠŠè¯¥æ§½å¯¹åº”çš„è®°å½•çš„n_ownedå€¼åŠ 1ï¼Œè¡¨ç¤ºæœ¬ç»„å†…åˆæ·»åŠ äº†ä¸€æ¡è®°å½•ï¼Œç›´åˆ°è¯¥ç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªã€‚ åœ¨ä¸€ä¸ªç»„ä¸­çš„è®°å½•æ•°ç­‰äº8ä¸ªåå†æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œä¼šå°†ç»„ä¸­çš„è®°å½•æ‹†åˆ†æˆä¸¤ä¸ªç»„ï¼Œä¸€ä¸ªç»„ä¸­4æ¡è®°å½•ï¼Œå¦ä¸€ä¸ª5æ¡è®°å½•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šåœ¨é¡µç›®å½•ä¸­æ–°å¢ä¸€ä¸ªæ§½æ¥è®°å½•è¿™ä¸ªæ–°å¢åˆ†ç»„ä¸­æœ€å¤§çš„é‚£æ¡è®°å½•çš„åç§»é‡ã€‚ ç”±äºç°åœ¨page_demoè¡¨ä¸­çš„è®°å½•å¤ªå°‘ï¼Œæ— æ³•æ¼”ç¤ºæ·»åŠ äº†é¡µç›®å½•ä¹‹ååŠ å¿«æŸ¥æ‰¾é€Ÿåº¦çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥å†å¾€page_demoè¡¨ä¸­æ·»åŠ ä¸€äº›è®°å½•ï¼š 1INSERT INTO page_demo VALUES(5, 500, &#x27;eeee&#x27;), (6, 600, &#x27;ffff&#x27;), (7, 700, &#x27;gggg&#x27;), (8, 800, &#x27;hhhh&#x27;), (9, 900, &#x27;iiii&#x27;), (10, 1000, &#x27;jjjj&#x27;), (11, 1100, &#x27;kkkk&#x27;), (12, 1200, &#x27;llll&#x27;), (13, 1300, &#x27;mmmm&#x27;), (14, 1400, &#x27;nnnn&#x27;), (15, 1500, &#x27;oooo&#x27;), (16, 1600, &#x27;pppp&#x27;); ç°åœ¨çœ‹æ€ä¹ˆä»è¿™ä¸ªé¡µç›®å½•ä¸­æŸ¥æ‰¾è®°å½•ã€‚å› ä¸ºå„ä¸ªæ§½ä»£è¡¨çš„è®°å½•çš„ä¸»é”®å€¼éƒ½æ˜¯ä»å°åˆ°å¤§æ’åºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‰€è°“çš„äºŒåˆ†æ³•æ¥è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾ã€‚5ä¸ªæ§½çš„ç¼–å·åˆ†åˆ«æ˜¯ï¼š0ã€1ã€2ã€3ã€4ï¼Œæ‰€ä»¥åˆå§‹æƒ…å†µä¸‹æœ€ä½çš„æ§½å°±æ˜¯low=0ï¼Œæœ€é«˜çš„æ§½å°±æ˜¯high=4ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æƒ³æ‰¾ä¸»é”®å€¼ä¸º6çš„è®°å½•ï¼Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+4)/2=2ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½2å¯¹åº”è®°å½•çš„ä¸»é”®å€¼ä¸º8ï¼Œåˆå› ä¸º8 &gt; 6ï¼Œæ‰€ä»¥è®¾ç½®high=2ï¼Œlowä¿æŒä¸å˜ã€‚ é‡æ–°è®¡ç®—ä¸­é—´æ§½çš„ä½ç½®ï¼š(0+2)/2=1ï¼Œæ‰€ä»¥æŸ¥çœ‹æ§½1å¯¹åº”çš„ä¸»é”®å€¼ä¸º4ï¼Œåˆå› ä¸º4 &lt; 6ï¼Œæ‰€ä»¥è®¾ç½®low=1ï¼Œhighä¿æŒä¸å˜ã€‚ å› ä¸ºhigh - lowçš„å€¼ä¸º1ï¼Œæ‰€ä»¥ç¡®å®šä¸»é”®å€¼ä¸º6çš„è®°å½•åœ¨æ§½2å¯¹åº”çš„ç»„ä¸­ã€‚æ­¤åˆ»æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„é‚£æ¡è®°å½•ï¼Œç„¶åæ²¿ç€å•å‘é“¾è¡¨éå†æ§½2ä¸­çš„è®°å½•ã€‚ä½†æ˜¯æˆ‘ä»¬å‰è¾¹åˆè¯´è¿‡ï¼Œæ¯ä¸ªæ§½å¯¹åº”çš„è®°å½•éƒ½æ˜¯è¯¥ç»„ä¸­ä¸»é”®å€¼æœ€å¤§çš„è®°å½•ï¼Œè¿™é‡Œæ§½2å¯¹åº”çš„è®°å½•æ˜¯ä¸»é”®å€¼ä¸º8çš„è®°å½•ï¼Œæ€ä¹ˆå®šä½ä¸€ä¸ªç»„ä¸­æœ€å°çš„è®°å½•å‘¢ï¼Ÿåˆ«å¿˜äº†å„ä¸ªæ§½éƒ½æ˜¯æŒ¨ç€çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„æ‹¿åˆ°æ§½1å¯¹åº”çš„è®°å½•ï¼ˆä¸»é”®å€¼ä¸º4ï¼‰ï¼Œè¯¥æ¡è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æ§½2ä¸­ä¸»é”®å€¼æœ€å°çš„è®°å½•ï¼Œè¯¥è®°å½•çš„ä¸»é”®å€¼ä¸º5ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™æ¡ä¸»é”®å€¼ä¸º5çš„è®°å½•å‡ºå‘ï¼Œéå†æ§½2ä¸­çš„å„æ¡è®°å½•ï¼Œç›´åˆ°æ‰¾åˆ°ä¸»é”®å€¼ä¸º6çš„é‚£æ¡è®°å½•å³å¯ã€‚ç”±äºä¸€ä¸ªç»„ä¸­åŒ…å«çš„è®°å½•æ¡æ•°åªèƒ½æ˜¯1~8æ¡ï¼Œæ‰€ä»¥éå†ä¸€ä¸ªç»„ä¸­çš„è®°å½•çš„ä»£ä»·æ˜¯å¾ˆå°çš„ã€‚ æ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®é¡µä¸­æŸ¥æ‰¾æŒ‡å®šä¸»é”®å€¼çš„è®°å½•çš„è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š é€šè¿‡äºŒåˆ†æ³•ç¡®å®šè¯¥è®°å½•æ‰€åœ¨çš„æ§½ï¼Œå¹¶æ‰¾åˆ°è¯¥æ§½æ‰€åœ¨åˆ†ç»„ä¸­ä¸»é”®å€¼æœ€å°çš„é‚£æ¡è®°å½•ã€‚ é€šè¿‡è®°å½•çš„next_recordå±æ€§éå†è¯¥æ§½æ‰€åœ¨çš„ç»„ä¸­çš„å„ä¸ªè®°å½•ã€‚ 3.Page Headerï¼ˆé¡µé¢å¤´éƒ¨ï¼‰ä¸ºäº†èƒ½å¾—åˆ°ä¸€ä¸ªæ•°æ®é¡µä¸­å­˜å‚¨çš„è®°å½•çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ¯”å¦‚æœ¬é¡µä¸­å·²ç»å­˜å‚¨äº†å¤šå°‘æ¡è®°å½•ï¼Œç¬¬ä¸€æ¡è®°å½•çš„åœ°å€æ˜¯ä»€ä¹ˆï¼Œé¡µç›®å½•ä¸­å­˜å‚¨äº†å¤šå°‘ä¸ªæ§½ç­‰ç­‰ï¼Œç‰¹æ„åœ¨é¡µä¸­å®šä¹‰äº†ä¸€ä¸ªå«Page Headerçš„éƒ¨åˆ†ï¼Œå®ƒæ˜¯é¡µç»“æ„çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†å ç”¨å›ºå®šçš„56ä¸ªå­—èŠ‚ï¼Œä¸“é—¨å­˜å‚¨å„ç§çŠ¶æ€ä¿¡æ¯ã€‚ åç§° å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ æè¿° PAGE_N_DIR_SLOTS 2 åœ¨é¡µç›®å½•ä¸­çš„æ§½æ•°é‡ PAGE_HEAP_TOP 2 è¿˜æœªä½¿ç”¨çš„ç©ºé—´æœ€å°åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ä»è¯¥åœ°å€ä¹‹åå°±æ˜¯Free Space PAGE_N_HEAP 2 æœ¬é¡µä¸­çš„è®°å½•çš„æ•°é‡ï¼ˆåŒ…æ‹¬æœ€å°å’Œæœ€å¤§è®°å½•ä»¥åŠæ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•ï¼‰ PAGE_FREE 2 ç¬¬ä¸€ä¸ªå·²ç»æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•åœ°å€ï¼ˆå„ä¸ªå·²åˆ é™¤çš„è®°å½•é€šè¿‡next_recordä¹Ÿä¼šç»„æˆä¸€ä¸ªå•é“¾è¡¨ï¼Œè¿™ä¸ªå•é“¾è¡¨ä¸­çš„è®°å½•å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ï¼‰ PAGE_GARBAGE 2 å·²åˆ é™¤è®°å½•å ç”¨çš„å­—èŠ‚æ•° PAGE_LAST_INSERT 2 æœ€åæ’å…¥è®°å½•çš„ä½ç½® PAGE_DIRECTION 2 è®°å½•æ’å…¥çš„æ–¹å‘ PAGE_N_DIRECTION 2 ä¸€ä¸ªæ–¹å‘è¿ç»­æ’å…¥çš„è®°å½•æ•°é‡ PAGE_N_RECS 2 è¯¥é¡µä¸­è®°å½•çš„æ•°é‡ï¼ˆä¸åŒ…æ‹¬æœ€å°å’Œæœ€å¤§è®°å½•ä»¥åŠè¢«æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•ï¼‰ PAGE_MAX_TRX_ID 8 ä¿®æ”¹å½“å‰é¡µçš„æœ€å¤§äº‹åŠ¡IDï¼Œè¯¥å€¼ä»…åœ¨äºŒçº§ç´¢å¼•ä¸­å®šä¹‰ PAGE_LEVEL 2 å½“å‰é¡µåœ¨B+æ ‘ä¸­æ‰€å¤„çš„å±‚çº§ PAGE_INDEX_ID 8 ç´¢å¼•IDï¼Œè¡¨ç¤ºå½“å‰é¡µå±äºå“ªä¸ªç´¢å¼• PAGE_BTR_SEG_LEAF 10 B+æ ‘å¶å­æ®µçš„å¤´éƒ¨ä¿¡æ¯ï¼Œä»…åœ¨B+æ ‘çš„Rooté¡µå®šä¹‰ PAGE_BTR_SEG_TOP 10 B+æ ‘éå¶å­æ®µçš„å¤´éƒ¨ä¿¡æ¯ï¼Œä»…åœ¨B+æ ‘çš„Rooté¡µå®šä¹‰ 4.File Headerï¼ˆæ–‡ä»¶å¤´éƒ¨ï¼‰File Headeré’ˆå¯¹å„ç§ç±»å‹çš„é¡µéƒ½é€šç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒç±»å‹çš„é¡µéƒ½ä¼šä»¥File Headerä½œä¸ºç¬¬ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå®ƒæè¿°äº†ä¸€äº›é’ˆå¯¹å„ç§é¡µéƒ½é€šç”¨çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”æ–¹è¯´è¿™ä¸ªé¡µçš„ç¼–å·æ˜¯å¤šå°‘ï¼Œå®ƒçš„ä¸Šä¸€ä¸ªé¡µã€ä¸‹ä¸€ä¸ªé¡µæ˜¯è°ï¼Œè¿™ä¸ªéƒ¨åˆ†å ç”¨å›ºå®šçš„38ä¸ªå­—èŠ‚ã€‚ åç§° å ç”¨ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰ æè¿° FIL_PAGE_SPACE_OR_CHKSUM 4 é¡µçš„æ ¡éªŒå’Œï¼ˆchecksumå€¼ï¼‰ FIL_PAGE_OFFSET 4 é¡µå· FIL_PAGE_PREV 4 ä¸Šä¸€ä¸ªé¡µçš„é¡µå· FIL_PAGE_NEXT 4 ä¸‹ä¸€ä¸ªé¡µçš„é¡µå· FIL_PAGE_LSN 8 é¡µé¢è¢«æœ€åä¿®æ”¹æ—¶å¯¹åº”çš„æ—¥å¿—åºåˆ—ä½ç½®ï¼ˆè‹±æ–‡åæ˜¯ï¼šLog Sequence Numberï¼‰ FIL_PAGE_TYPE 2 è¯¥é¡µçš„ç±»å‹ FIL_PAGE_FILE_FLUSH_LSN 8 ä»…åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ä¸€ä¸ªé¡µä¸­å®šä¹‰ï¼Œä»£è¡¨æ–‡ä»¶è‡³å°‘è¢«åˆ·æ–°åˆ°äº†å¯¹åº”çš„LSNå€¼ FIL_PAGE_ARCH_LOG_NO_OR_SPACE_ID 4 é¡µå±äºå“ªä¸ªè¡¨ç©ºé—´ InnoDBä¸ºäº†ä¸åŒçš„ç›®çš„è€ŒæŠŠé¡µåˆ†ä¸ºä¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬ä¸Šè¾¹ä»‹ç»çš„å…¶å®éƒ½æ˜¯å­˜å‚¨è®°å½•çš„æ•°æ®é¡µï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šåˆ«çš„ç±»å‹çš„é¡µï¼Œå…·ä½“å¦‚ä¸‹è¡¨ï¼š ç±»å‹åç§° åå…­è¿›åˆ¶ æè¿° FIL_PAGE_TYPE_ALLOCATED 0x0000 æœ€æ–°åˆ†é…ï¼Œè¿˜æ²¡ä½¿ç”¨ FIL_PAGE_UNDO_LOG 0x0002 Undoæ—¥å¿—é¡µ FIL_PAGE_INODE 0x0003 æ®µä¿¡æ¯èŠ‚ç‚¹ FIL_PAGE_IBUF_FREE_LIST 0x0004 Insert Bufferç©ºé—²åˆ—è¡¨ FIL_PAGE_IBUF_BITMAP 0x0005 Insert Bufferä½å›¾ FIL_PAGE_TYPE_SYS 0x0006 ç³»ç»Ÿé¡µ FIL_PAGE_TYPE_TRX_SYS 0x0007 äº‹åŠ¡ç³»ç»Ÿæ•°æ® FIL_PAGE_TYPE_FSP_HDR 0x0008 è¡¨ç©ºé—´å¤´éƒ¨ä¿¡æ¯ FIL_PAGE_TYPE_XDES 0x0009 æ‰©å±•æè¿°é¡µ FIL_PAGE_TYPE_BLOB 0x000A æº¢å‡ºé¡µ FIL_PAGE_INDEX 0x45BF ç´¢å¼•é¡µï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æ•°æ®é¡µ æˆ‘ä»¬å­˜æ”¾è®°å½•çš„æ•°æ®é¡µçš„ç±»å‹å…¶å®æ˜¯FIL_PAGE_INDEXï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ç´¢å¼•é¡µã€‚ æœ‰æ—¶å€™æˆ‘ä»¬å­˜æ”¾æŸç§ç±»å‹çš„æ•°æ®å ç”¨çš„ç©ºé—´éå¸¸å¤§ï¼ˆæ¯”æ–¹è¯´ä¸€å¼ è¡¨ä¸­å¯ä»¥æœ‰æˆåƒä¸Šä¸‡æ¡è®°å½•ï¼‰ï¼ŒInnoDBå¯èƒ½ä¸å¯ä»¥ä¸€æ¬¡æ€§ä¸ºè¿™ä¹ˆå¤šæ•°æ®åˆ†é…ä¸€ä¸ªéå¸¸å¤§çš„å­˜å‚¨ç©ºé—´ï¼Œå¦‚æœåˆ†æ•£åˆ°å¤šä¸ªä¸è¿ç»­çš„é¡µä¸­å­˜å‚¨çš„è¯éœ€è¦æŠŠè¿™äº›é¡µå…³è”èµ·æ¥ï¼ŒFIL_PAGE_PREVå’ŒFIL_PAGE_NEXTå°±åˆ†åˆ«ä»£è¡¨æœ¬é¡µçš„ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ªé¡µçš„é¡µå·ã€‚è¿™æ ·é€šè¿‡å»ºç«‹ä¸€ä¸ªåŒå‘é“¾è¡¨æŠŠè®¸è®¸å¤šå¤šçš„é¡µå°±éƒ½ä¸²è”èµ·æ¥äº†ï¼Œè€Œæ— éœ€è¿™äº›é¡µåœ¨ç‰©ç†ä¸ŠçœŸæ­£è¿ç€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ç±»å‹çš„é¡µéƒ½æœ‰ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ªé¡µçš„å±æ€§ï¼Œä¸è¿‡æˆ‘ä»¬ç°åœ¨åˆ†æçš„æ•°æ®é¡µï¼ˆä¹Ÿå°±æ˜¯ç±»å‹ä¸ºFIL_PAGE_INDEXçš„é¡µï¼‰æ˜¯æœ‰è¿™ä¸¤ä¸ªå±æ€§çš„ï¼Œæ‰€ä»¥æ‰€æœ‰çš„æ•°æ®é¡µå…¶å®æ˜¯ä¸€ä¸ªåŒé“¾è¡¨ã€‚ 5.File Trailer(æ–‡ä»¶å°¾éƒ¨)å¦‚æœé¡µä¸­çš„æ•°æ®åœ¨å†…å­˜ä¸­è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆåœ¨ä¿®æ”¹åçš„æŸä¸ªæ—¶é—´éœ€è¦æŠŠæ•°æ®åŒæ­¥åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯åœ¨åŒæ­¥äº†ä¸€åŠçš„æ—¶å€™ä¸­æ–­ç”µäº†å’‹åŠï¼Ÿ ä¸ºäº†æ£€æµ‹ä¸€ä¸ªé¡µæ˜¯å¦å®Œæ•´ï¼Œåœ¨æ¯ä¸ªé¡µçš„å°¾éƒ¨éƒ½åŠ äº†ä¸€ä¸ªFile Traileréƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†ç”±8ä¸ªå­—èŠ‚ç»„æˆï¼Œå¯ä»¥åˆ†æˆ2ä¸ªå°éƒ¨åˆ†ï¼š å‰å››ä¸ªå­—èŠ‚ä»£è¡¨æ ¡éªŒå’Œ åå››ä¸ªå­—èŠ‚ä»£è¡¨é¡µé¢è¢«æœ€åä¿®æ”¹æ—¶å¯¹åº”çš„æ—¥å¿—åºåˆ—ä½ç½® è¿™ä¸ªFile Trailer &amp; File Header ç±»ä¼¼ï¼Œéƒ½æ˜¯æ‰€æœ‰ç±»å‹çš„é¡µé€šç”¨çš„ã€‚ è‡³æ­¤ï¼Œæ•´ä¸ªæ•°æ®é¡µçš„ç»“æ„æˆ‘ä»¬ä¹ŸåŸºæœ¬ä¸Šåˆ†æå®Œäº†ï¼Œç°åœ¨åœ¨å›å¤´çœ‹ä¸€ä¸‹å¼€å¤´æˆ‘ä»¬é‚£å¼ ææ€–çš„å›¾ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰æ¸…æ™°å¾ˆå¤šäº†å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ†æç´¢å¼•çš„ç»“æ„ã€‚ ä¸‰ã€ç´¢å¼•1.ç´¢å¼•ç»“æ„1.1 èšç°‡ç´¢å¼•ä¸Šè¾¹ä»‹ç»çš„B+æ ‘æœ¬èº«å°±æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæˆ–è€…è¯´æœ¬èº«å°±æ˜¯ä¸€ä¸ªç´¢å¼•ã€‚å®ƒæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š ä½¿ç”¨è®°å½•ä¸»é”®å€¼çš„å¤§å°è¿›è¡Œè®°å½•å’Œé¡µçš„æ’åºï¼Œè¿™åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢çš„å«ä¹‰ï¼š é¡µå†…çš„è®°å½•æ˜¯æŒ‰ç…§ä¸»é”®çš„å¤§å°é¡ºåºæ’æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚ å„ä¸ªå­˜æ”¾ç”¨æˆ·è®°å½•çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ å­˜æ”¾ç›®å½•é¡¹è®°å½•çš„é¡µåˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œåœ¨åŒä¸€å±‚æ¬¡ä¸­çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç›®å½•é¡¹è®°å½•çš„ä¸»é”®å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ B+æ ‘çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯å®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ æ‰€è°“å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œå°±æ˜¯æŒ‡è¿™ä¸ªè®°å½•ä¸­å­˜å‚¨äº†æ‰€æœ‰åˆ—çš„å€¼ï¼ˆåŒ…æ‹¬éšè—åˆ—ï¼‰ã€‚ æˆ‘ä»¬æŠŠå…·æœ‰è¿™ä¸¤ç§ç‰¹æ€§çš„B+æ ‘ç§°ä¸ºèšç°‡ç´¢å¼•ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨è¿™ä¸ªèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å¤„ã€‚è¿™ç§èšç°‡ç´¢å¼•å¹¶ä¸éœ€è¦æˆ‘ä»¬åœ¨MySQLè¯­å¥ä¸­æ˜¾å¼çš„ä½¿ç”¨INDEXè¯­å¥å»åˆ›å»ºï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šè‡ªåŠ¨çš„ä¸ºæˆ‘ä»¬åˆ›å»ºèšç°‡ç´¢å¼•ã€‚å¦å¤–ï¼Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œèšç°‡ç´¢å¼•å°±æ˜¯æ•°æ®çš„å­˜å‚¨æ–¹å¼ï¼ˆæ‰€æœ‰çš„ç”¨æˆ·è®°å½•éƒ½å­˜å‚¨åœ¨äº†å¶å­èŠ‚ç‚¹ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ç´¢å¼•å³æ•°æ®ï¼Œæ•°æ®å³ç´¢å¼•ã€‚ 1.2 äºŒçº§ç´¢å¼•èšç°‡ç´¢å¼•åªèƒ½åœ¨æœç´¢æ¡ä»¶æ˜¯ä¸»é”®å€¼æ—¶æ‰èƒ½å‘æŒ¥ä½œç”¨ï¼Œå› ä¸ºB+æ ‘ä¸­çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§ä¸»é”®è¿›è¡Œæ’åºçš„ã€‚é‚£å¦‚æœæˆ‘ä»¬æƒ³ä»¥åˆ«çš„åˆ—ä½œä¸ºæœç´¢æ¡ä»¶æ€ä¹ˆåŠï¼Ÿ æˆ‘ä»¬å¯ä»¥å¤šå»ºå‡ æ£µB+æ ‘ï¼Œä¸åŒçš„B+æ ‘ä¸­çš„æ•°æ®é‡‡ç”¨ä¸åŒçš„æ’åºè§„åˆ™ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬ç”¨c2åˆ—çš„å¤§å°ä½œä¸ºæ•°æ®é¡µã€é¡µä¸­è®°å½•çš„æ’åºè§„åˆ™ï¼Œå†å»ºä¸€æ£µB+æ ‘ï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™ä¸ªB+æ ‘ä¸ä¸Šè¾¹ä»‹ç»çš„èšç°‡ç´¢å¼•æœ‰å‡ å¤„ä¸åŒï¼š ä½¿ç”¨è®°å½•c2åˆ—çš„å¤§å°è¿›è¡Œè®°å½•å’Œé¡µçš„æ’åºï¼Œè¿™åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢çš„å«ä¹‰ï¼š aé¡µå†…çš„è®°å½•æ˜¯æŒ‰ç…§c2åˆ—çš„å¤§å°é¡ºåºæ’æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚ bå„ä¸ªå­˜æ”¾ç”¨æˆ·è®°å½•çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­è®°å½•çš„c2åˆ—å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ cå­˜æ”¾ç›®å½•é¡¹è®°å½•çš„é¡µåˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œåœ¨åŒä¸€å±‚æ¬¡ä¸­çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç›®å½•é¡¹è®°å½•çš„c2åˆ—å¤§å°é¡ºåºæ’æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ B+æ ‘çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„å¹¶ä¸æ˜¯å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œè€Œåªæ˜¯c2åˆ—+ä¸»é”®è¿™ä¸¤ä¸ªåˆ—çš„å€¼ã€‚ ç›®å½•é¡¹è®°å½•ä¸­ä¸å†æ˜¯ä¸»é”®+é¡µå·çš„æ­é…ï¼Œè€Œå˜æˆäº†c2åˆ—+é¡µå·çš„æ­é…ã€‚ æ‰€ä»¥å¦‚æœæˆ‘ä»¬ç°åœ¨æƒ³é€šè¿‡c2åˆ—çš„å€¼æŸ¥æ‰¾æŸäº›è®°å½•çš„è¯å°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬åˆšåˆšå»ºå¥½çš„è¿™ä¸ªB+æ ‘äº†ã€‚ä»¥æŸ¥æ‰¾c2åˆ—çš„å€¼ä¸º4çš„è®°å½•ä¸ºä¾‹ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š 1ç¡®å®šç›®å½•é¡¹è®°å½•é¡µ æ ¹æ®æ ¹é¡µé¢ï¼Œä¹Ÿå°±æ˜¯é¡µ44ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°ç›®å½•é¡¹è®°å½•æ‰€åœ¨çš„é¡µä¸ºé¡µ42ï¼ˆå› ä¸º2 &lt; 4 &lt; 9ï¼‰ã€‚ 2é€šè¿‡ç›®å½•é¡¹è®°å½•é¡µç¡®å®šç”¨æˆ·è®°å½•çœŸå®æ‰€åœ¨çš„é¡µã€‚ åœ¨é¡µ42ä¸­å¯ä»¥å¿«é€Ÿå®šä½åˆ°å®é™…å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µï¼Œä½†æ˜¯ç”±äºc2åˆ—å¹¶æ²¡æœ‰å”¯ä¸€æ€§çº¦æŸï¼Œæ‰€ä»¥c2åˆ—å€¼ä¸º4çš„è®°å½•å¯èƒ½åˆ†å¸ƒåœ¨å¤šä¸ªæ•°æ®é¡µä¸­ï¼Œåˆå› ä¸º2 &lt; 4 â‰¤ 4ï¼Œæ‰€ä»¥ç¡®å®šå®é™…å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µåœ¨é¡µ34å’Œé¡µ35ä¸­ã€‚ 3åœ¨çœŸå®å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µä¸­å®šä½åˆ°å…·ä½“çš„è®°å½•. åˆ°é¡µ34å’Œé¡µ35ä¸­å®šä½åˆ°å…·ä½“çš„è®°å½•ã€‚ 4ä½†æ˜¯è¿™ä¸ªB+æ ‘çš„å¶å­èŠ‚ç‚¹ä¸­çš„è®°å½•åªå­˜å‚¨äº†c2å’Œc1ï¼ˆä¹Ÿå°±æ˜¯ä¸»é”®ï¼‰ä¸¤ä¸ªåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å†æ ¹æ®ä¸»é”®å€¼å»èšç°‡ç´¢å¼•ä¸­å†æŸ¥æ‰¾ä¸€éå®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ æˆ‘ä»¬æ ¹æ®è¿™ä¸ªä»¥c2åˆ—å¤§å°æ’åºçš„B+æ ‘åªèƒ½ç¡®å®šæˆ‘ä»¬è¦æŸ¥æ‰¾è®°å½•çš„ä¸»é”®å€¼ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®c2åˆ—çš„å€¼æŸ¥æ‰¾åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•çš„è¯ï¼Œä»ç„¶éœ€è¦åˆ°èšç°‡ç´¢å¼•ä¸­å†æŸ¥ä¸€éï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿè¢«ç§°ä¸ºå›è¡¨ã€‚ä¹Ÿå°±æ˜¯æ ¹æ®c2åˆ—çš„å€¼æŸ¥è¯¢ä¸€æ¡å®Œæ•´çš„ç”¨æˆ·è®°å½•éœ€è¦ä½¿ç”¨åˆ°2æ£µB+æ ‘ï¼ï¼ï¼ ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ä¸€æ¬¡å›è¡¨æ“ä½œå‘¢ï¼Ÿç›´æ¥æŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•æ”¾åˆ°å¶å­èŠ‚ç‚¹ä¸å°±å¥½äº†ä¹ˆï¼Ÿ å¦‚æœæŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•æ”¾åˆ°å¶å­èŠ‚ç‚¹æ˜¯å¯ä»¥ä¸ç”¨å›è¡¨ï¼Œç›¸å½“äºæ¯å»ºç«‹ä¸€æ£µB+æ ‘éƒ½éœ€è¦æŠŠæ‰€æœ‰çš„ç”¨æˆ·è®°å½•å†éƒ½æ‹·è´ä¸€éï¼Œè¿™å°±æœ‰ç‚¹å¤ªæµªè´¹å­˜å‚¨ç©ºé—´äº†ã€‚å› ä¸ºè¿™ç§æŒ‰ç…§éä¸»é”®åˆ—å»ºç«‹çš„B+æ ‘éœ€è¦ä¸€æ¬¡å›è¡¨æ“ä½œæ‰å¯ä»¥å®šä½åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œæ‰€ä»¥è¿™ç§B+æ ‘ä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•ï¼ˆè‹±æ–‡åsecondary indexï¼‰ï¼Œæˆ–è€…è¾…åŠ©ç´¢å¼•ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯c2åˆ—çš„å¤§å°ä½œä¸ºB+æ ‘çš„æ’åºè§„åˆ™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç§°è¿™ä¸ªB+æ ‘ä¸ºä¸ºc2åˆ—å»ºç«‹çš„ç´¢å¼•ã€‚ å‡è®¾æˆ‘ä»¬çš„æŸ¥è¯¢ç»“æœæ˜¯åæ¡ï¼Œé‚£å°±æ˜¯è¦è¿›è¡Œ10æ¬¡å›è¡¨ï¼Œé‚£è¿™æ ·çš„è¯ï¼Œæ•ˆç‡ä¸æ˜¯åˆæ…¢äº†ï¼Ÿ åœ¨MySQL5.6å¯¹è¿™ç§æƒ…å†µè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¦‚æœå‘ç°æŸ¥è¯¢ç»“æœä¼šå¯¼è‡´å¤šæ¬¡å›è¡¨ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡ŒIOåˆå¹¶ï¼Œæ‹¿åˆ°æ‰€æœ‰çš„ä¸»é”®å†å»è¿›è¡Œå›è¡¨ã€‚ 1.3 è”åˆç´¢å¼•æˆ‘ä»¬ä¹Ÿå¯ä»¥åŒæ—¶ä»¥å¤šä¸ªåˆ—çš„å¤§å°ä½œä¸ºæ’åºè§„åˆ™ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶ä¸ºå¤šä¸ªåˆ—å»ºç«‹ç´¢å¼•ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬æƒ³è®©B+æ ‘æŒ‰ç…§c2å’Œc3åˆ—çš„å¤§å°è¿›è¡Œæ’åºï¼Œè¿™ä¸ªåŒ…å«ä¸¤å±‚å«ä¹‰ï¼š â—å…ˆæŠŠå„ä¸ªè®°å½•å’Œé¡µæŒ‰ç…§c2åˆ—è¿›è¡Œæ’åºã€‚ â—åœ¨è®°å½•çš„c2åˆ—ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨c3åˆ—è¿›è¡Œæ’åº ä¸ºc2å’Œc3åˆ—å»ºç«‹çš„ç´¢å¼•çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š å››ã€æ€»ç»“ï¼šä¸€æ¬¡é€šè¿‡èšç°‡ç´¢å¼•å®šä½æ•°æ®çš„è¿‡ç¨‹å¤§å®¶ç†Ÿæ‚‰çš„ä¸‰ä¸ªç‰ˆæœ¬ç´¢å¼•ç»“æ„å›¾å¦‚ä¸‹ æ™®é€šç´¢å¼• äºŒçº§ç´¢å¼• ç»„åˆç´¢å¼•ç´¢å¼• ç›¸å¯¹å®Œæ•´äº›çš„ä¸‰ç§ç´¢å¼•ç»“æ„è§ï¼ˆä¸‰ã€ç´¢å¼•ï¼‰ ä¸‹å›¾ä¸ºèšç°‡ç´¢å¼•å®Œæ•´ç‰ˆç»“æ„ ä¸€æ¬¡æŒ‰ç…§ä¸»é”®idæŸ¥è¯¢id=5çš„æ•°æ®çš„å…¨æµç¨‹ 1.ç¡®å®šç›®å½•é¡¹è®°å½•é¡µï¼Œæ‰¾åˆ°é¡µ50 2.äºŒåˆ†æŸ¥æ‰¾ç¡®å®šæ‰€å±æ§½ä½1ï¼Œç„¶åéå†æ§½ä½1é‡Œçš„é“¾è¡¨å¾—çŸ¥ä¸‹æ¬¡è¯¥ç»§ç»­æŸ¥è¯¢é¡µ55 3.äºŒåˆ†æŸ¥æ‰¾ç¡®å®šæ‰€å±æ§½ä½1ï¼Œç„¶åéå†æ§½ä½1é‡Œçš„é“¾è¡¨å¾—çŸ¥ä¸‹æ¬¡è¯¥ç»§ç»­æŸ¥è¯¢é¡µ61 4.äºŒåˆ†æŸ¥æ‰¾ç¡®å®šæ‰€å±æ§½ä½2ï¼Œç„¶åéå†æ§½ä½2é‡Œçš„é“¾è¡¨å¾—åˆ°idä¸º4çš„æ•°æ®","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"ACIDåŠå®ç°åŸç†","slug":"7.mysql/ACIDåŠå®ç°åŸç†","date":"2021-12-27T16:00:00.000Z","updated":"2022-03-31T02:55:44.589Z","comments":true,"path":"2021/12/28/7.mysql/ACIDåŠå®ç°åŸç†/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/28/7.mysql/ACID%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/","excerpt":"","text":"ACIDç®€ä»‹ä»¥æœ€å¸¸è§çš„ InnoDB å¼•æ“æ¥è¯´ï¼Œæ˜¯å¦‚ä½•ä¿è¯ ACID çš„ã€‚ ï¼ˆAtomicityï¼‰åŸå­æ€§ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚è¦ä¹ˆå…¨éƒ½æ‰§è¡Œ,è¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œï¼› ï¼ˆConsistencyï¼‰ä¸€è‡´æ€§ï¼š æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œï¼ˆåŸå­æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§å°±æ˜¯ä¸ºäº†æ¥ä¿è¯ä¸€è‡´æ€§ï¼‰ï¼› ï¼ˆIsolationï¼‰éš”ç¦»æ€§ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œæ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶,ä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„â€œç‹¬ç«‹â€ç¯å¢ƒæ‰§è¡Œï¼› ï¼ˆDurabilityï¼‰æŒä¹…æ€§: ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚ åŸå­æ€§ï¼ˆAï¼‰å®ç°åŸå­æ€§çš„å…³é”®ï¼Œæ˜¯å½“äº‹åŠ¡å›æ»šæ—¶èƒ½å¤Ÿæ’¤é”€æ‰€æœ‰å·²ç»æˆåŠŸæ‰§è¡Œçš„sqlè¯­å¥ï¼ˆundo logï¼‰ã€‚å½“äº‹åŠ¡å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹æ—¶ï¼ŒInnoDBä¼šç”Ÿæˆå¯¹åº”çš„ undo logï¼›å¦‚æœäº‹åŠ¡æ‰§è¡Œå¤±è´¥æˆ–è°ƒç”¨äº† rollbackï¼Œå¯¼è‡´äº‹åŠ¡éœ€è¦å›æ»šï¼Œä¾¿å¯ä»¥åˆ©ç”¨ undo log ä¸­çš„ä¿¡æ¯å°†æ•°æ®å›æ»šåˆ°ä¿®æ”¹ä¹‹å‰çš„æ ·å­ã€‚undo log å±äºé€»è¾‘æ—¥å¿—ï¼Œå®ƒè®°å½•çš„æ˜¯sqlæ‰§è¡Œç›¸å…³çš„ä¿¡æ¯ã€‚å½“å‘ç”Ÿå›æ»šæ—¶ï¼ŒInnoDB ä¼šæ ¹æ® undo log çš„å†…å®¹åšä¸ä¹‹å‰ç›¸åçš„å·¥ä½œï¼š å¯¹äºæ¯ä¸ª insertï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œ deleteï¼› å¯¹äºæ¯ä¸ª deleteï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œinsertï¼› å¯¹äºæ¯ä¸ª updateï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œä¸€ä¸ªç›¸åçš„ updateï¼ŒæŠŠæ•°æ®æ”¹å›å»ã€‚ éš”ç¦»æ€§ï¼ˆIï¼‰é¦–å…ˆå›å¿†å››ç§mysqléš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ« è¯´æ˜ è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ° è¯»æäº¤ï¼ˆRead committedï¼‰ ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚å‡º äºæ€§èƒ½è€ƒè™‘äº’è”ç½‘å…¬å¸ä¼šä½¿ç”¨RC+ä¹è§‚é” å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰ ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¯¹åŒä¸€ä»½æ•°æ®çš„è¯»å–ç»“æœæ€»æ˜¯ç›¸åŒçš„ï¼Œæ— è®ºæ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡å¯¹è¿™ä»½æ•°æ®è¿›è¡Œæ“ä½œï¼Œä»¥åŠè¿™ä¸ªäº‹åŠ¡æ˜¯å¦æäº¤ã€‚InnoDBé»˜è®¤çº§åˆ«ã€‚ ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰ äº‹åŠ¡ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯æ¬¡è¯»éƒ½éœ€è¦è·å¾—è¡¨çº§å…±äº«é”ï¼Œè¯»å†™ç›¸äº’éƒ½ä¼šé˜»å¡ï¼Œéš”ç¦»çº§åˆ«æœ€é«˜ï¼Œç‰ºç‰²ç³»ç»Ÿå¹¶å‘æ€§ã€‚ æŸ¥çœ‹å½“å‰æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«:show variables like â€˜%tx_isolation%â€™; è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šset tx_isolation=â€™REPEATABLE-READâ€™; ä¸åŒçš„éš”ç¦»çº§åˆ«æ˜¯ä¸ºäº†è§£å†³ä¸åŒçš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è„è¯»ã€å¹»è¯»ã€ä¸å¯é‡å¤è¯»ã€‚ è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»åŒºåˆ«è„è¯»ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²ç»ä¿®æ”¹ä½†å°šæœªæäº¤çš„æ•°æ®ï¼Œã€‚ ä¸å¯é‡å¤è¯»ï¼šäº‹åŠ¡Aå†…éƒ¨çš„ç›¸åŒæŸ¥è¯¢è¯­å¥åœ¨ä¸åŒæ—¶åˆ»è¯»å‡ºçš„ç»“æœä¸ä¸€è‡´ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚ å¹»è¯»ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ ä¸å¯é‡å¤è¯»&amp;&amp;å¹»è¯»åŒºåˆ« ä¸å¯é‡å¤è¯»ï¼Œé‡ç‚¹æ˜¯ä¿®æ”¹ã€‚åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼ŒåŒæ ·çš„æ¡ä»¶ï¼Œç¬¬ä¸€æ¬¡è¯»çš„æ•°æ®å’Œç¬¬äºŒæ¬¡è¯»çš„æ•°æ®ä¸ä¸€æ ·ï¼Œæ•°æ®å˜åŒ– å¹»è¯»ï¼Œé‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤ã€‚åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼ŒåŒæ ·çš„æ¡ä»¶,ï¼Œç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è¯»å‡ºæ¥çš„è®°å½•æ•°ä¸ä¸€æ ·ï¼Œè¡Œæ•°å˜åŒ–ã€‚ éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» è¯»æœªæäº¤ å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° è¯»æäº¤ ä¸å…è®¸å‡ºç° å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° å¯é‡å¤è¯» ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° å¯ä»¥å‡ºç° åºåˆ—åŒ– ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œéš”ç¦»æ€§æ˜¯é é”æœºåˆ¶å’ŒMVCCå…±åŒå®ç°çš„ã€‚ MVCC(å¹¶å‘å¤šç‰ˆæœ¬æ§åˆ¶ï¼ŒMulti-Version Concurrency Control)MVCCç”¨äºè¯»å·²æäº¤ï¼ˆRCï¼‰å’Œå¯é‡å¤è¯»çº§åˆ«ï¼ˆRRï¼‰çš„æ§åˆ¶ï¼Œä¸»è¦é€šè¿‡undo logæ—¥å¿—ç‰ˆæœ¬é“¾å’Œread viewæ¥å®ç°ï¼Œ InnoDBä¸­MVCCçš„å®ç°ä¾èµ–å››ä¸ªæ¡ä»¶: éšè—å­—æ®µ, äº‹åŠ¡é“¾è¡¨ï¼Œread view, undo log æ•°æ®è¡¨é¢å¤–å­—æ®µDB_TRX_ID(6å­—èŠ‚): åœ¨innoDBä¸­, ä¼šä¸ºæ¯ä¸ªäº‹ç‰©åˆ†é…ä¸€ä¸ªäº‹åŠ¡ID. è€Œè¯¥å­—æ®µè¡¨ç¤ºçš„å°±æ˜¯æ’å…¥æˆ–æ›´æ–°è¯¥è¡Œçš„æœ€åä¸€ä¸ªäº‹åŠ¡çš„äº‹åŠ¡æ ‡è¯†ç¬¦. DB_ROLL_PTR(7å­—èŠ‚): è¿™ä¸ªå­—æ®µç§°ä¸ºå›æ»šæŒ‡é’ˆ, æŒ‡å‘äº†å›æ»šæ®µçš„æ’¤é”€æ—¥å¿—. (undo log) DB_ROW_ID(6å­—èŠ‚): è¿™ä¸ªå­—æ®µåŒ…å«äº†ä¸€ä¸ªè¡ŒID. è¯¥IDåœ¨æ’å…¥æ–°è¡Œæ—¶ä¼šå•è°ƒå¢åŠ . è¿™ä¸ªå­—æ®µæ˜¯ä¸ºäº†åœ¨è¡¨é‡Œæ²¡æœ‰ä¸»é”®IDçš„æ—¶å€™, ç”Ÿæˆèšç°‡ç´¢å¼•ä½¿ç”¨çš„. äº‹åŠ¡é“¾è¡¨MySQLä¸­çš„äº‹åŠ¡åœ¨å¼€å§‹åˆ°æäº¤è¿™æ®µè¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šè¢«ä¿å­˜åˆ°ä¸€ä¸ªå«trx_sysçš„äº‹åŠ¡é“¾è¡¨ä¸­ï¼ŒåŸºæœ¬çš„é“¾è¡¨ç»“æ„å¦‚ä¸‹ï¼š äº‹åŠ¡é“¾è¡¨ä¸­ä¿å­˜çš„éƒ½æ˜¯è¿˜æœªæäº¤çš„äº‹åŠ¡ï¼Œäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œåˆ™ä¼šè¢«ä»äº‹åŠ¡é“¾è¡¨ä¸­æ‘˜é™¤ã€‚ read viewRCçº§åˆ«ä¸‹æ¯æ¬¡éƒ½æ˜¯é‡æ–°ç”Ÿæˆread viewï¼Œè€Œåœ¨RRçº§åˆ«ä¸‹åˆ™æ˜¯ä¸€ç›´ä½¿ç”¨äº‹åŠ¡å†…ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶äº§ç”Ÿçš„read viewã€‚ ReadViewå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œåœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™ä¼šæ ¹æ®ä¸Šé¢çš„äº‹åŠ¡é“¾è¡¨æ„é€ ä¸€ä¸ªReadView,åˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹ï¼š 12345678910111213// readview åˆå§‹åŒ–// m_low_limit_id = trx_sys-&gt;max_trx_id; // m_up_limit_id = !m_ids.empty() ? m_ids.front() : m_low_limit_id;ReadView::ReadView() : m_low_limit_id(), m_up_limit_id(), m_creator_trx_id(), m_ids(), m_low_limit_no()&#123; ut_d(::memset(&amp;m_view_list, 0x0, sizeof(m_view_list)));&#125; trx_ids: è¡¨ç¤ºäº‹åŠ¡å¼€å¯çš„æ—¶å€™, å…¶å®ƒæœªæäº¤çš„æ´»è·ƒçš„äº‹åŠ¡ID. è¿™ä¸ªé›†åˆä¸­çš„äº‹åŠ¡å¯¹äºå½“å‰äº‹åŠ¡æ¥è¯´, ä¸€ç›´éƒ½æ˜¯ä¸å¯è§çš„. low_limit_id: è¡¨ç¤ºåœ¨ç”ŸæˆReadViewæ—¶å½“å‰ç³»ç»Ÿä¸­æœ€å¤§äº‹åŠ¡id. up_limit_id: è¡¨ç¤ºæœªæäº¤æ´»è·ƒäº‹åŠ¡Id(trx_ids)çš„æœ€å¤§å€¼. å¦‚æœtrx_idsä¸ºç©º, åˆ™up_limit_id=low_limit_id. é€šè¿‡è¯¥ReadViewï¼Œæ–°çš„äº‹åŠ¡å¯ä»¥æ ¹æ®æŸ¥è¯¢åˆ°çš„æ‰€æœ‰æ´»è·ƒäº‹åŠ¡è®°å½•çš„äº‹åŠ¡IDæ¥åŒ¹é…èƒ½å¤Ÿçœ‹è§è¯¥è®°å½•ï¼Œä»è€Œå®ç°æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»ï¼Œä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š é€šè¿‡èšç°‡ç´¢å¼•çš„è¡Œç»“æ„ä¸­DB_TRX_IDéšè—å­—æ®µå¯ä»¥çŸ¥é“æœ€è¿‘è¢«å“ªä¸ªäº‹åŠ¡IDä¿®æ”¹è¿‡ã€‚ä¸€ä¸ªæ–°çš„äº‹åŠ¡å¼€å§‹æ—¶ä¼šæ ¹æ®äº‹åŠ¡é“¾è¡¨æ„é€ ä¸€ä¸ªReadViewã€‚å½“å‰äº‹åŠ¡æ ¹æ®ReadViewä¸­çš„æ•°æ®å»è·Ÿæ£€ç´¢åˆ°çš„æ¯ä¸€æ¡æ•°æ®å»æ ¡éªŒ,çœ‹çœ‹å½“å‰äº‹åŠ¡æ˜¯ä¸æ˜¯èƒ½çœ‹åˆ°è¿™æ¡æ•°æ® 1234567891011121314151617181920212223242526// åˆ¤æ–­æ•°æ®å¯¹åº”çš„èšç°‡ç´¢å¼•ä¸­çš„äº‹åŠ¡idåœ¨è¿™ä¸ªreadviewä¸­æ˜¯å¦å¯è§bool changes_visible( trx_id_t id, // è®°å½•çš„id const table_name_t&amp; name) constMY_ATTRIBUTE((warn_unused_result))&#123; ut_ad(id &gt; 0); // å¦‚æœå½“å‰è®°å½•id &lt; äº‹åŠ¡é“¾è¡¨çš„æœ€å°å€¼æˆ–è€…ç­‰äºåˆ›å»ºè¯¥readviewçš„idå°±æ˜¯å®ƒè‡ªå·±,é‚£ä¹ˆæ˜¯å¯è§çš„ if (id &lt; m_up_limit_id || id == m_creator_trx_id) &#123; return(true); &#125; check_trx_id_sanity(id, name); // å¦‚æœè¯¥è®°å½•çš„äº‹åŠ¡idå¤§äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å¤§å€¼,é‚£ä¹ˆä¸å¯è§ if (id &gt;= m_low_limit_id) &#123; return(false); // å¦‚æœäº‹åŠ¡é“¾è¡¨æ˜¯ç©ºçš„,é‚£ä¹Ÿæ˜¯å¯è§çš„ &#125; else if (m_ids.empty()) &#123; return(true); &#125; const ids_t::value_type* p = m_ids.data(); //åˆ¤æ–­æ˜¯å¦åœ¨ReadViewä¸­ï¼Œå¦‚æœåœ¨è¯´æ˜åœ¨åˆ›å»ºReadViewæ—¶ æ­¤æ¡è®°å½•è¿˜å¤„äºæ´»è·ƒçŠ¶æ€åˆ™ä¸åº”è¯¥æŸ¥è¯¢åˆ°ï¼Œå¦åˆ™è¯´æ˜åˆ›å»ºReadViewæ˜¯æ­¤æ¡è®°å½•å·²ç»æ˜¯ä¸æ´»è·ƒçŠ¶æ€åˆ™å¯ä»¥æŸ¥è¯¢åˆ° return(!std::binary_search(p, p + m_ids.size(), id));&#125; å¯è§æ€§ç®—æ³•é€»è¾‘æ€»ç»“ï¼š å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDå°äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å°å€¼(æ•°æ®è¡Œçš„DB_TRX_ID &lt; m_up_limit_id)è¡¨ç¤ºè¿™ä¸ªæ•°æ®åœ¨å½“å‰äº‹åŠ¡å¼€å¯å‰å°±å·²ç»è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹è¿‡äº†,æ‰€ä»¥æ˜¯å¯è§çš„ã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDè¡¨ç¤ºçš„æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ä¿®æ”¹çš„æ•°æ®(æ•°æ®è¡Œçš„DB_TRX_ID = m_creator_trx_id) æ—¶ï¼Œæ•°æ®å¯è§ã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDå¤§äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å¤§å€¼(æ•°æ®è¡Œçš„DB_TRX_ID &gt;= m_low_limit_id) è¡¨ç¤ºè¿™ä¸ªæ•°æ®åœ¨å½“å‰äº‹åŠ¡å¼€å¯ååˆ°ä¸‹ä¸€æ¬¡æŸ¥è¯¢ä¹‹é—´åˆè¢«å…¶ä»–çš„äº‹åŠ¡ä¿®æ”¹è¿‡,é‚£ä¹ˆå°±æ˜¯ä¸å¯è§çš„ã€‚ å¦‚æœäº‹åŠ¡é“¾è¡¨ä¸ºç©º,é‚£ä¹ˆä¹Ÿæ˜¯å¯è§çš„,ä¹Ÿå°±æ˜¯å½“å‰äº‹åŠ¡å¼€å§‹çš„æ—¶å€™,æ²¡æœ‰å…¶ä»–ä»»æ„ä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDåœ¨äº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹é—´ï¼Œä»m_low_limit_idåˆ°m_up_limit_idè¿›è¡Œéå†ï¼Œå–å‡ºDB_ROLL_PTRæŒ‡é’ˆæ‰€æŒ‡å‘çš„å›æ»šæ®µçš„äº‹åŠ¡IDï¼ŒæŠŠå®ƒèµ‹å€¼ç»™ trx_id_current ï¼Œç„¶åä»æ­¥éª¤1é‡æ–°å¼€å§‹åˆ¤æ–­ï¼Œè¿™æ ·æ€»èƒ½æœ€åæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„è®°å½•ã€‚ Undo LogUndo logæ˜¯InnoDB MVCCäº‹åŠ¡ç‰¹æ€§çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚å½“æˆ‘ä»¬å¯¹è®°å½•åšäº†å˜æ›´æ“ä½œæ—¶å°±ä¼šäº§ç”ŸUndoè®°å½•ï¼ŒUndoè®°å½•é»˜è®¤è¢«è®°å½•åˆ°ç³»ç»Ÿè¡¨ç©ºé—´(ibdata)ä¸­ï¼Œä½†ä»5.6å¼€å§‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç‹¬ç«‹çš„Undo è¡¨ç©ºé—´ã€‚ Undoè®°å½•ä¸­å­˜å‚¨çš„æ˜¯è€ç‰ˆæœ¬æ•°æ®ï¼Œå½“ä¸€ä¸ªæ—§çš„äº‹åŠ¡éœ€è¦è¯»å–æ•°æ®æ—¶ï¼Œä¸ºäº†èƒ½è¯»å–åˆ°è€ç‰ˆæœ¬çš„æ•°æ®ï¼Œéœ€è¦é¡ºç€undoé“¾æ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•ã€‚å½“ç‰ˆæœ¬é“¾å¾ˆé•¿æ—¶ï¼Œé€šå¸¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œã€‚ Undo Log æ ¼å¼ åœ¨InnoDBå¼•æ“ä¸­ï¼Œundo logåˆ†ä¸ºï¼š insert undo logï¼š insert undo logæ˜¯æŒ‡åœ¨insertæ“ä½œä¸­äº§ç”Ÿçš„undo logï¼Œå› ä¸ºinsertæ“ä½œçš„è®°å½•ï¼Œåªå¯¹äº‹åŠ¡æœ¬èº«å¯è§ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ï¼ˆè¿™æ˜¯äº‹åŠ¡éš”ç¦»æ€§çš„è¦æ±‚ï¼‰ï¼Œæ•…è¯¥undo logå¯ä»¥åœ¨äº‹åŠ¡æäº¤åç›´æ¥åˆ é™¤ï¼Œä¸éœ€è¦è¿›è¡Œpurgeæ“ä½œã€‚ update undo logï¼š update undo logè®°å½•çš„æ˜¯deleteå’Œupdateæ“ä½œäº§ç”Ÿçš„undo logã€‚è¯¥undo logå¯èƒ½éœ€è¦æä¾›MVCCæœºåˆ¶ï¼Œå› æ­¤ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶å°±è¿›è¡Œåˆ é™¤ï¼Œæäº¤æ—¶æ”¾å…¥undo logé“¾è¡¨ï¼Œç­‰å¾…purgeçº¿ç¨‹è¿›è¡Œæœ€åçš„åˆ é™¤ã€‚ä¸‹é¢æ˜¯ä¸¤ç§undo logçš„ç»“æ„å›¾ã€‚ purgeå¯¹äºä¸€æ¡deleteè¯­å¥ delete from t where a = 1ï¼Œå¦‚æœåˆ—aæœ‰èšé›†ç´¢å¼•ï¼Œåˆ™ä¸ä¼šè¿›è¡ŒçœŸæ­£çš„åˆ é™¤ï¼Œè€Œåªæ˜¯åœ¨ä¸»é”®åˆ—ç­‰äº1çš„è®°å½•delete flagè®¾ç½®ä¸º1ï¼Œå³è®°å½•è¿˜æ˜¯å­˜åœ¨åœ¨B+æ ‘ä¸­ã€‚è€Œå¯¹äºupdateæ“ä½œï¼Œä¸æ˜¯ç›´æ¥å¯¹è®°å½•è¿›è¡Œæ›´æ–°ï¼Œè€Œæ˜¯æ ‡è¯†æ—§è®°å½•ä¸ºåˆ é™¤çŠ¶æ€ï¼Œç„¶åæ–°äº§ç”Ÿä¸€æ¡è®°å½•ã€‚é‚£è¿™äº›æ—§ç‰ˆæœ¬æ ‡è¯†ä½åˆ é™¤çš„è®°å½•ä½•æ—¶çœŸæ­£çš„åˆ é™¤ï¼Ÿæ€ä¹ˆåˆ é™¤ï¼Ÿ å…¶å®InnoDBæ˜¯é€šè¿‡undoæ—¥å¿—æ¥è¿›è¡Œæ—§ç‰ˆæœ¬çš„åˆ é™¤æ“ä½œçš„ï¼Œåœ¨InnoDBå†…éƒ¨ï¼Œè¿™ä¸ªæ“ä½œè¢«ç§°ä¹‹ä¸ºpurgeæ“ä½œï¼ŒåŸæ¥åœ¨srv_master_threadä¸»çº¿ç¨‹ä¸­å®Œæˆï¼Œåæ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¼€è¾Ÿäº†purgeçº¿ç¨‹è¿›è¡Œpurgeæ“ä½œï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®purgeçº¿ç¨‹çš„æ•°é‡ã€‚purgeæ“ä½œæ¯10sè¿›è¡Œä¸€æ¬¡ã€‚ ä¸ºäº†èŠ‚çœå­˜å‚¨ç©ºé—´ï¼ŒInnoDBå­˜å‚¨å¼•æ“çš„undo logè®¾è®¡æ˜¯è¿™æ ·çš„ï¼šä¸€ä¸ªé¡µä¸Šå…è®¸å¤šä¸ªäº‹åŠ¡çš„undo logå­˜åœ¨ã€‚è™½ç„¶è¿™ä¸ä»£è¡¨äº‹åŠ¡åœ¨å…¨å±€è¿‡ç¨‹ä¸­æäº¤çš„é¡ºåºï¼Œä½†æ˜¯åé¢çš„äº‹åŠ¡äº§ç”Ÿçš„undo logæ€»åœ¨æœ€åã€‚æ­¤å¤–ï¼ŒInnoDBå­˜å‚¨å¼•æ“è¿˜æœ‰ä¸€ä¸ªhistoryåˆ—è¡¨ï¼Œå®ƒæ ¹æ®äº‹åŠ¡æäº¤çš„é¡ºåºï¼Œå°†undo logè¿›è¡Œè¿æ¥ï¼Œå¦‚ä¸‹é¢çš„ä¸€ç§æƒ…å†µï¼š åœ¨æ‰§è¡Œpurgeè¿‡ç¨‹ä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“é¦–å…ˆä»history listä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªéœ€è¦è¢«æ¸…ç†çš„è®°å½•ï¼Œè¿™é‡Œä¸ºtrx1ï¼Œæ¸…ç†ä¹‹åInnoDBå­˜å‚¨å¼•æ“ä¼šåœ¨trx1æ‰€åœ¨çš„Undo pageä¸­ç»§ç»­å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¯ä»¥è¢«æ¸…ç†çš„è®°å½•ï¼Œè¿™é‡Œä¼šæ‰¾åˆ°äº‹åŠ¡trx3ï¼Œæ¥ç€æ‰¾åˆ°trx5ï¼Œä½†æ˜¯å‘ç°trx5è¢«å…¶ä»–äº‹åŠ¡æ‰€å¼•ç”¨è€Œä¸èƒ½æ¸…ç†ï¼Œæ•…å†å»history listä¸­å–æŸ¥æ‰¾ï¼Œå‘ç°æœ€å°¾ç«¯çš„è®°å½•æ—¶trx2ï¼Œæ¥ç€æ‰¾åˆ°trx2æ‰€åœ¨çš„Undo pageï¼Œä¾æ¬¡æŠŠtrx6ã€trx4æ¸…ç†ï¼Œç”±äºUndo page2ä¸­æ‰€æœ‰çš„è®°å½•éƒ½è¢«æ¸…ç†äº†ï¼Œå› æ­¤è¯¥Undo pageå¯ä»¥è¿›è¡Œé‡ç”¨ã€‚ InnoDBå­˜å‚¨å¼•æ“è¿™ç§å…ˆä»history listä¸­æ‰¾undo logï¼Œç„¶åå†ä»Undo pageä¸­æ‰¾undo logçš„è®¾è®¡æ¨¡å¼æ˜¯ä¸ºäº†é¿å…å¤§é‡éšæœºè¯»æ“ä½œï¼Œä»è€Œæé«˜purgeçš„æ•ˆç‡ã€‚ å¿«ç…§è¯»ä¸å½“å‰è¯»çš„åŒºåˆ«å¯¹äºè¿™ç§è¯»å–å†å²æ•°æ®çš„æ–¹å¼ï¼Œæˆ‘ä»¬å«å®ƒå¿«ç…§è¯» (snapshot read)ï¼Œè€Œè¯»å–æ•°æ®åº“å½“å‰ç‰ˆæœ¬æ•°æ®çš„æ–¹å¼ï¼Œå«å½“å‰è¯» (current read)ã€‚å¾ˆæ˜¾ç„¶ï¼Œåœ¨MVCCä¸­ï¼š å¿«ç…§è¯»ï¼šå°±æ˜¯select select * from table â€¦.; å½“å‰è¯»ï¼šç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œï¼Œå±äºå½“å‰è¯»ï¼Œå¤„ç†çš„éƒ½æ˜¯å½“å‰çš„æ•°æ®ï¼Œéœ€è¦åŠ é”ã€‚ select * from table where ? lock in share mode; select * from table where ? for update; insert; update ; delete; åœºæ™¯ä¸¾ä¾‹ï¼šæ–°å»ºä¸€å¼ æ•°æ®è¡¨userï¼Œåç»­æ‰€æœ‰æ“ä½œéƒ½ä¾æ‰˜äºåˆå§‹åŒ–çš„è¿™ä¸‰æ¡æ•°æ®ã€‚ id name age 1 zhangsan 1 2 lisi 5 3 wangwu 10 æ“ä½œ1ï¼š æ—¶åˆ» t1 t2 1 begin begin 2 update user set name=â€™zhangsan2â€™ where age=1;commit; 3 select * from user where age=1; æ­¤æ—¶ä¸ç®¡æ˜¯RCè¿˜æ˜¯RRï¼Œt1çš„selectéƒ½èƒ½å¤Ÿè¯»å–åˆ°t2updateçš„å€¼ å› ä¸ºåœ¨t1selectçš„æ—¶åˆ»æ‰ä¼šå»ç”Ÿæˆread viewï¼Œæ ¹æ®å¯è§æ€§ç®—æ³•å¾—å‡ºèƒ½çœ‹åˆ°æœ€æ–°çš„t2æ•°æ® æ“ä½œ2: æ—¶åˆ» t1 t2 1 begin begin 2 select * from user where age=1; 3 update user set name=â€™zhangsan2â€™ where age=1;commit; 4 select * from user where age=1; æ­¤æ—¶RCçº§åˆ«ä¸‹ï¼Œt1çš„ ç¬¬äºŒæ¬¡selectèƒ½å¤ŸæŸ¥çœ‹åˆ°t2updateçš„å€¼ï¼Œå› ä¸ºRCçº§åˆ«ä¸‹æ¯æ¬¡selectéƒ½ä¼šç”Ÿæˆæ–°çš„read view åœ¨RRçº§åˆ«ä¸‹ï¼Œt1çš„ ç¬¬äºŒæ¬¡ä¸èƒ½æŸ¥è¯¢åˆ°t2updateçš„å€¼ï¼Œå› ä¸ºRRçº§åˆ«ä¸‹çš„åé¢æŸ¥è¯¢éƒ½æ˜¯ä½¿ç”¨çš„ç¬¬ä¸€æ¬¡selectç”Ÿæˆçš„read view åŒç†ï¼Œt2è¯­å¥ä¸ºinsertæ—¶ä¹Ÿæ˜¯ä¸€æ ·çš„æƒ…å†µã€‚ æ“ä½œ3: æ—¶åˆ» t1 t2 1 begin begin update user set name=â€™zhangsan2â€™ where age=1; 3 insert into user values (4,â€™hahaâ€™,3);waiting~~~ 5 commit; 6 æ’å…¥æˆåŠŸcommit; RRçº§åˆ«ä¸‹ï¼Œt1è¿›è¡Œå½“å‰è¯»æ—¶ï¼Œä¼šå¯¹æ•°æ®åŠ é”ï¼Œå…·ä½“æ˜¯é—´éš™é”ï½œè¡Œé”ï½œnext-keyï¼Œåé¢ç»†è¯´ï¼Œæ­¤æ—¶t2çš„æ’å…¥ä¼šwaitingï¼Œç›´åˆ°t1é‡Šæäº¤äº‹åŠ¡ï¼Œæ¥è§£å†³insertæƒ…å†µä¸‹çš„å¹»è¯»é—®é¢˜ é‚£ä¹ˆï¼Œæ„Ÿè§‰RRå°±å·²ç»è§£å†³äº†å¹»è¯»ï¼Œä¸ºå•¥è¿˜éœ€è¦ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰ï¼Ÿï¼Ÿï¼Ÿ æ“ä½œ4: æ—¶åˆ» t1 t2 1 begin begin select * from user where age=1; 3 insert into user values (4,â€™hahaâ€™,1);commit; 5 update user set name=â€™zhangsan2â€™ where age=1; 6 commit; RRçº§åˆ«ä¸‹ï¼Œæ­¤æ—¶æƒ³è±¡ä¸­çš„ç»“æœä¸ºä¸‹é¢ï¼Œå› ä¸ºå®é™…ä¸Šåœ¨ç¬¬äº”è¡Œå¦‚æœä¸æ˜¯updateè€Œæ˜¯selectï¼Œæ˜¯è‚¯å®šå·®ä¸åˆ°æ–°æ•°æ®çš„ id name age 1 zhangsan2 1 2 lisi 5 3 wangwu 10 4 haha 1 ä½†æ˜¯å®é™…çš„æ•°æ®åº“ä¸­ç»“æœä¸ºï¼š id name age 1 zhangsan2 1 2 lisi 5 3 wangwu 10 4 zhangsan2 1 å…¶å®åœ¨ MySQLåœ¨RRçº§åˆ«ä¸­å¹¶ä¸æ˜¯å®Œå…¨è§£å†³äº†å¹»è¯»çš„é—®é¢˜ï¼Œå¯¹ç…§æ“ä½œ2ä¸­t2ä½¿ç”¨insertã€æ“ä½œ3ã€ä»¥åŠæ“ä½œ4å¯ä»¥çœ‹å‡ºæŸäº›åœºæ™¯ä¸‹RRè§£å†³äº†å¹»è¯»ï¼Œä½†æ˜¯MVCC å¯¹äºå¹»è¯»çš„è§£å†³æ˜¯ä¸å½»åº•çš„ã€‚ï¼ˆå¿«ç…§è¯»å’Œå½“å‰è¯»çš„æ··åˆä½¿ç”¨ä¼šäº§ç”Ÿå¹»è¯»é—®é¢˜ï¼‰ æŒä¹…æ€§Innnodbæœ‰å¾ˆå¤š logï¼ŒæŒä¹…æ€§é çš„æ˜¯ redo logã€‚","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"mysqlä¸‰å¤§æ—¥å¿—","slug":"7.mysql/mysqlä¸‰å¤§æ—¥å¿—","date":"2021-12-26T16:00:00.000Z","updated":"2022-03-31T02:55:44.590Z","comments":true,"path":"2021/12/27/7.mysql/mysqlä¸‰å¤§æ—¥å¿—/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/27/7.mysql/mysql%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97/","excerpt":"","text":"æ—¥å¿—æ˜¯ mysql æ•°æ®åº“çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè®°å½•ç€æ•°æ®åº“è¿è¡ŒæœŸé—´å„ç§çŠ¶æ€ä¿¡æ¯ã€‚mysqlæ—¥å¿—ä¸»è¦åŒ…æ‹¬é”™è¯¯æ—¥å¿—ã€æŸ¥è¯¢æ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—ã€äº‹åŠ¡æ—¥å¿—ã€äºŒè¿›åˆ¶æ—¥å¿—å‡ å¤§ç±»ã€‚ ä½œä¸ºå¼€å‘ï¼Œæˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯äºŒè¿›åˆ¶æ—¥å¿—( binlog )å’Œäº‹åŠ¡æ—¥å¿—(åŒ…æ‹¬redo log å’Œ undo log )ï¼Œæœ¬æ–‡æ¥ä¸‹æ¥ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸‰ç§æ—¥å¿—ã€‚ binlogbinlog ç”¨äºè®°å½•æ•°æ®åº“æ‰§è¡Œçš„å†™å…¥æ€§æ“ä½œ(ä¸åŒ…æ‹¬æŸ¥è¯¢)ä¿¡æ¯ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼ä¿å­˜åœ¨ç£ç›˜ä¸­ã€‚binlog æ˜¯ mysqlçš„é€»è¾‘æ—¥å¿—ï¼Œå¹¶ä¸”ç”± Server å±‚è¿›è¡Œè®°å½•ï¼Œä½¿ç”¨ä»»ä½•å­˜å‚¨å¼•æ“çš„ mysql æ•°æ®åº“éƒ½ä¼šè®°å½• binlog æ—¥å¿—ã€‚ é€»è¾‘æ—¥å¿—ï¼šå¯ä»¥ç®€å•ç†è§£ä¸ºè®°å½•çš„å°±æ˜¯sqlè¯­å¥ ã€‚ ç‰©ç†æ—¥å¿—ï¼šmysql æ•°æ®æœ€ç»ˆæ˜¯ä¿å­˜åœ¨æ•°æ®é¡µä¸­çš„ï¼Œç‰©ç†æ—¥å¿—è®°å½•çš„å°±æ˜¯æ•°æ®é¡µå˜æ›´ ã€‚ binlog æ˜¯é€šè¿‡è¿½åŠ çš„æ–¹å¼è¿›è¡Œå†™å…¥çš„ï¼Œå¯ä»¥é€šè¿‡max_binlog_size å‚æ•°è®¾ç½®æ¯ä¸ª binlogæ–‡ä»¶çš„å¤§å°ï¼Œå½“æ–‡ä»¶å¤§å°è¾¾åˆ°ç»™å®šå€¼ä¹‹åï¼Œä¼šç”Ÿæˆæ–°çš„æ–‡ä»¶æ¥ä¿å­˜æ—¥å¿—ã€‚ binlogä½¿ç”¨åœºæ™¯åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ binlog çš„ä¸»è¦ä½¿ç”¨åœºæ™¯æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ ä¸»ä»å¤åˆ¶ å’Œ æ•°æ®æ¢å¤ ã€‚ ä¸»ä»å¤åˆ¶ ï¼šåœ¨ Master ç«¯å¼€å¯ binlog ï¼Œç„¶åå°† binlogå‘é€åˆ°å„ä¸ª Slave ç«¯ï¼Œ Slave ç«¯é‡æ”¾ binlog ä»è€Œè¾¾åˆ°ä¸»ä»æ•°æ®ä¸€è‡´ã€‚ æ•°æ®æ¢å¤ ï¼šé€šè¿‡ä½¿ç”¨ mysqlbinlog å·¥å…·æ¥æ¢å¤æ•°æ®ã€‚ binlogåˆ·ç›˜æ—¶æœºå¯¹äº InnoDB å­˜å‚¨å¼•æ“è€Œè¨€ï¼Œåªæœ‰åœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šè®°å½•biglog ï¼Œæ­¤æ—¶è®°å½•è¿˜åœ¨å†…å­˜ä¸­ï¼Œé‚£ä¹ˆ biglogæ˜¯ä»€ä¹ˆæ—¶å€™åˆ·åˆ°ç£ç›˜ä¸­çš„å‘¢ï¼Ÿ mysql é€šè¿‡ sync_binlog å‚æ•°æ§åˆ¶ biglog çš„åˆ·ç›˜æ—¶æœºï¼Œå–å€¼èŒƒå›´æ˜¯ 0-Nï¼š 0ï¼šä¸å»å¼ºåˆ¶è¦æ±‚ï¼Œç”±ç³»ç»Ÿè‡ªè¡Œåˆ¤æ–­ä½•æ—¶å†™å…¥ç£ç›˜ï¼› 1ï¼šæ¯æ¬¡ commit çš„æ—¶å€™éƒ½è¦å°† binlog å†™å…¥ç£ç›˜ï¼› Nï¼šæ¯Nä¸ªäº‹åŠ¡ï¼Œæ‰ä¼šå°† binlog å†™å…¥ç£ç›˜ã€‚ ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ sync_binlog æœ€å®‰å…¨çš„æ˜¯è®¾ç½®æ˜¯ 1 ï¼Œè¿™ä¹Ÿæ˜¯MySQL 5.7.7ä¹‹åç‰ˆæœ¬çš„é»˜è®¤å€¼ã€‚ä½†æ˜¯è®¾ç½®ä¸€ä¸ªå¤§ä¸€äº›çš„å€¼å¯ä»¥æå‡æ•°æ®åº“æ€§èƒ½ï¼Œå› æ­¤å®é™…æƒ…å†µä¸‹ä¹Ÿå¯ä»¥å°†å€¼é€‚å½“è°ƒå¤§ï¼Œç‰ºç‰²ä¸€å®šçš„ä¸€è‡´æ€§æ¥è·å–æ›´å¥½çš„æ€§èƒ½ã€‚ binlogæ—¥å¿—æ ¼å¼binlog æ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œåˆ†åˆ«ä¸º STATMENT ã€ ROW å’Œ MIXEDã€‚ åœ¨ MySQL 5.7.7 ä¹‹å‰ï¼Œé»˜è®¤çš„æ ¼å¼æ˜¯ STATEMENT ï¼Œ MySQL 5.7.7 ä¹‹åï¼Œé»˜è®¤å€¼æ˜¯ ROWã€‚æ—¥å¿—æ ¼å¼é€šè¿‡ binlog-format æŒ‡å®šã€‚ STATMENTï¼šåŸºäºSQL è¯­å¥çš„å¤åˆ¶( statement-based replication, SBR )ï¼Œæ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqlè¯­å¥ä¼šè®°å½•åˆ°binlog ä¸­ ã€‚ ä¼˜ç‚¹ï¼šä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº† binlog æ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº† IO , ä»è€Œæé«˜äº†æ€§èƒ½ï¼› ç¼ºç‚¹ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ¯”å¦‚æ‰§è¡Œsysdate() ã€ slepp() ç­‰ ã€‚ ROWï¼šåŸºäºè¡Œçš„å¤åˆ¶(row-based replication, RBR )ï¼Œä¸è®°å½•æ¯æ¡sqlè¯­å¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»…éœ€è®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº† ã€‚ ä¼˜ç‚¹ï¼šä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹çš„å­˜å‚¨è¿‡ç¨‹ã€æˆ–functionã€æˆ–triggerçš„è°ƒç”¨å’Œè§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ ï¼› ç¼ºç‚¹ï¼šä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—ï¼Œå°¤å…¶æ˜¯alter table çš„æ—¶å€™ä¼šè®©æ—¥å¿—æš´æ¶¨ MIXEDï¼šåŸºäºSTATMENT å’Œ ROW ä¸¤ç§æ¨¡å¼çš„æ··åˆå¤åˆ¶(mixed-based replication, MBR )ï¼Œä¸€èˆ¬çš„å¤åˆ¶ä½¿ç”¨STATEMENT æ¨¡å¼ä¿å­˜ binlog ï¼Œå¯¹äº STATEMENT æ¨¡å¼æ— æ³•å¤åˆ¶çš„æ“ä½œä½¿ç”¨ ROW æ¨¡å¼ä¿å­˜ binlog redo logä¸ºä»€ä¹ˆéœ€è¦redo logæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œäº‹åŠ¡çš„å››å¤§ç‰¹æ€§é‡Œé¢æœ‰ä¸€ä¸ªæ˜¯ æŒä¹…æ€§ ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯åªè¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“åšçš„ä¿®æ”¹å°±è¢«æ°¸ä¹…ä¿å­˜ä¸‹æ¥äº†ï¼Œä¸å¯èƒ½å› ä¸ºä»»ä½•åŸå› å†å›åˆ°åŸæ¥çš„çŠ¶æ€ ã€‚ é‚£ä¹ˆ mysqlæ˜¯å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„å‘¢ï¼Ÿ æœ€ç®€å•çš„åšæ³•æ˜¯åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°†è¯¥äº‹åŠ¡æ¶‰åŠä¿®æ”¹çš„æ•°æ®é¡µå…¨éƒ¨åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯è¿™ä¹ˆåšä¼šæœ‰ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š å› ä¸º Innodb æ˜¯ä»¥ é¡µ ä¸ºå•ä½è¿›è¡Œç£ç›˜äº¤äº’çš„ï¼Œè€Œä¸€ä¸ªäº‹åŠ¡å¾ˆå¯èƒ½åªä¿®æ”¹ä¸€ä¸ªæ•°æ®é¡µé‡Œé¢çš„å‡ ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™å°†å®Œæ•´çš„æ•°æ®é¡µåˆ·åˆ°ç£ç›˜çš„è¯ï¼Œå¤ªæµªè´¹èµ„æºäº†ï¼ ä¸€ä¸ªäº‹åŠ¡å¯èƒ½æ¶‰åŠä¿®æ”¹å¤šä¸ªæ•°æ®é¡µï¼Œå¹¶ä¸”è¿™äº›æ•°æ®é¡µåœ¨ç‰©ç†ä¸Šå¹¶ä¸è¿ç»­ï¼Œä½¿ç”¨éšæœºIOå†™å…¥æ€§èƒ½å¤ªå·®ï¼ å› æ­¤ mysql è®¾è®¡äº† redo log ï¼Œ å…·ä½“æ¥è¯´å°±æ˜¯åªè®°å½•äº‹åŠ¡å¯¹æ•°æ®é¡µåšäº†å“ªäº›****ä¿®æ”¹ï¼Œè¿™æ ·å°±èƒ½å®Œç¾åœ°è§£å†³æ€§èƒ½é—®é¢˜äº†(ç›¸å¯¹è€Œè¨€æ–‡ä»¶æ›´å°å¹¶ä¸”æ˜¯é¡ºåºIO)ã€‚ redo logåŸºæœ¬æ¦‚å¿µredo log åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªæ˜¯å†…å­˜ä¸­çš„æ—¥å¿—ç¼“å†²( redo log buffer )ï¼Œå¦ä¸€ä¸ªæ˜¯ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶( redo logfile)ã€‚ mysql æ¯æ‰§è¡Œä¸€æ¡ DML è¯­å¥ï¼Œå…ˆå°†è®°å½•å†™å…¥ redo log bufferï¼Œåç»­æŸä¸ªæ—¶é—´ç‚¹å†ä¸€æ¬¡æ€§å°†å¤šä¸ªæ“ä½œè®°å½•å†™åˆ° redo log fileã€‚è¿™ç§ å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ çš„æŠ€æœ¯å°±æ˜¯ MySQLé‡Œç»å¸¸è¯´åˆ°çš„ WAL(Write-Ahead Logging) æŠ€æœ¯ã€‚ åœ¨è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´( user space )ä¸‹çš„ç¼“å†²åŒºæ•°æ®ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ— æ³•ç›´æ¥å†™å…¥ç£ç›˜çš„ï¼Œä¸­é—´å¿…é¡»ç»è¿‡æ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´( kernel space )ç¼“å†²åŒº( OS Buffer )ã€‚ å› æ­¤ï¼Œ redo log buffer å†™å…¥ redo logfile å®é™…ä¸Šæ˜¯å…ˆå†™å…¥ OS Buffer ï¼Œç„¶åå†é€šè¿‡ç³»ç»Ÿè°ƒç”¨ fsync() å°†å…¶åˆ·åˆ° redo log fileä¸­ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š mysql æ”¯æŒä¸‰ç§å°† redo log buffer å†™å…¥ redo log file çš„æ—¶æœºï¼Œå¯ä»¥é€šè¿‡ innodb_flush_log_at_trx_commit å‚æ•°é…ç½®ï¼Œå„å‚æ•°å€¼å«ä¹‰å¦‚ä¸‹ï¼š redo logè®°å½•å½¢å¼å‰é¢è¯´è¿‡ï¼Œ redo log å®é™…ä¸Šè®°å½•æ•°æ®é¡µçš„å˜æ›´ï¼Œè€Œè¿™ç§å˜æ›´è®°å½•æ˜¯æ²¡å¿…è¦å…¨éƒ¨ä¿å­˜ï¼Œå› æ­¤ redo logå®ç°ä¸Šé‡‡ç”¨äº†å¤§å°å›ºå®šï¼Œå¾ªç¯å†™å…¥çš„æ–¹å¼ï¼Œå½“å†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›åˆ°å¼€å¤´å¾ªç¯å†™æ—¥å¿—ã€‚ å¦‚ä¸‹å›¾ï¼š åŒæ—¶æˆ‘ä»¬å¾ˆå®¹æ˜“å¾—çŸ¥ï¼Œ åœ¨innodbä¸­ï¼Œæ—¢æœ‰redo log éœ€è¦åˆ·ç›˜ï¼Œè¿˜æœ‰ æ•°æ®é¡µ ä¹Ÿéœ€è¦åˆ·ç›˜ï¼Œ redo logå­˜åœ¨çš„æ„ä¹‰ä¸»è¦å°±æ˜¯é™ä½å¯¹ æ•°æ®é¡µ åˆ·ç›˜çš„è¦æ±‚ã€‚ åœ¨ä¸Šå›¾ä¸­ï¼Œ write pos è¡¨ç¤º redo log å½“å‰è®°å½•çš„ LSN (é€»è¾‘åºåˆ—å·)ä½ç½®ï¼Œ check point è¡¨ç¤º æ•°æ®é¡µæ›´æ”¹è®°å½• åˆ·ç›˜åå¯¹åº” redo log æ‰€å¤„çš„ LSN(é€»è¾‘åºåˆ—å·)ä½ç½®ã€‚ write pos åˆ° check point ä¹‹é—´çš„éƒ¨åˆ†æ˜¯ redo log ç©ºç€çš„éƒ¨åˆ†ï¼Œç”¨äºè®°å½•æ–°çš„è®°å½•ï¼›check point åˆ° write pos ä¹‹é—´æ˜¯ redo log å¾…è½ç›˜çš„æ•°æ®é¡µæ›´æ”¹è®°å½•ã€‚å½“ write posè¿½ä¸Šcheck point æ—¶ï¼Œä¼šå…ˆæ¨åŠ¨ check point å‘å‰ç§»åŠ¨ï¼Œç©ºå‡ºä½ç½®å†è®°å½•æ–°çš„æ—¥å¿—ã€‚ å¯åŠ¨ innodb çš„æ—¶å€™ï¼Œä¸ç®¡ä¸Šæ¬¡æ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯å¼‚å¸¸å…³é—­ï¼Œæ€»æ˜¯ä¼šè¿›è¡Œæ¢å¤æ“ä½œã€‚å› ä¸º redo logè®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼Œå› æ­¤æ¢å¤çš„æ—¶å€™é€Ÿåº¦æ¯”é€»è¾‘æ—¥å¿—(å¦‚ binlog )è¦å¿«å¾ˆå¤šã€‚ é‡å¯innodb æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ç£ç›˜ä¸­æ•°æ®é¡µçš„ LSN ï¼Œå¦‚æœæ•°æ®é¡µçš„LSN å°äºæ—¥å¿—ä¸­çš„ LSN ï¼Œåˆ™ä¼šä» checkpoint å¼€å§‹æ¢å¤ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œåœ¨å®•æœºå‰æ­£å¤„äºcheckpoint çš„åˆ·ç›˜è¿‡ç¨‹ï¼Œä¸”æ•°æ®é¡µçš„åˆ·ç›˜è¿›åº¦è¶…è¿‡äº†æ—¥å¿—é¡µçš„åˆ·ç›˜è¿›åº¦ï¼Œæ­¤æ—¶ä¼šå‡ºç°æ•°æ®é¡µä¸­è®°å½•çš„ LSN å¤§äºæ—¥å¿—ä¸­çš„ LSNï¼Œè¿™æ—¶è¶…å‡ºæ—¥å¿—è¿›åº¦çš„éƒ¨åˆ†å°†ä¸ä¼šé‡åšï¼Œå› ä¸ºè¿™æœ¬èº«å°±è¡¨ç¤ºå·²ç»åšè¿‡çš„äº‹æƒ…ï¼Œæ— éœ€å†é‡åšã€‚ redo logä¸binlogåŒºåˆ« ç”± binlog å’Œ redo log çš„åŒºåˆ«å¯çŸ¥ï¼šbinlog æ—¥å¿—åªç”¨äºå½’æ¡£ï¼Œåªä¾é  binlog æ˜¯æ²¡æœ‰ crash-safe èƒ½åŠ›çš„ã€‚ ä½†åªæœ‰ redo log ä¹Ÿä¸è¡Œï¼Œå› ä¸º redo log æ˜¯ InnoDBç‰¹æœ‰çš„ï¼Œä¸”æ—¥å¿—ä¸Šçš„è®°å½•è½ç›˜åä¼šè¢«è¦†ç›–æ‰ã€‚å› æ­¤éœ€è¦ binlogå’Œ redo logäºŒè€…åŒæ—¶è®°å½•ï¼Œæ‰èƒ½ä¿è¯å½“æ•°æ®åº“å‘ç”Ÿå®•æœºé‡å¯æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚ undo logæ•°æ®åº“äº‹åŠ¡å››å¤§ç‰¹æ€§ä¸­æœ‰ä¸€ä¸ªæ˜¯ åŸå­æ€§ ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ åŸå­æ€§æ˜¯æŒ‡å¯¹æ•°æ®åº“çš„ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å¯èƒ½å‡ºç°éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µã€‚ å®é™…ä¸Šï¼Œ åŸå­æ€§ åº•å±‚å°±æ˜¯é€šè¿‡ undo log å®ç°çš„ã€‚undo logä¸»è¦è®°å½•äº†æ•°æ®çš„é€»è¾‘å˜åŒ–ï¼Œæ¯”å¦‚ä¸€æ¡ INSERT è¯­å¥ï¼Œå¯¹åº”ä¸€æ¡DELETE çš„ undo log ï¼Œå¯¹äºæ¯ä¸ª UPDATE è¯­å¥ï¼Œå¯¹åº”ä¸€æ¡ç›¸åçš„ UPDATE çš„ undo log ï¼Œè¿™æ ·åœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå°±èƒ½å›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®çŠ¶æ€ã€‚ åŒæ—¶ï¼Œ undo log ä¹Ÿæ˜¯ MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)å®ç°çš„å…³é”®ã€‚ Undo logæ˜¯InnoDB MVCCäº‹åŠ¡ç‰¹æ€§çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚å½“æˆ‘ä»¬å¯¹è®°å½•åšäº†å˜æ›´æ“ä½œæ—¶å°±ä¼šäº§ç”ŸUndoè®°å½•ï¼ŒUndoè®°å½•é»˜è®¤è¢«è®°å½•åˆ°ç³»ç»Ÿè¡¨ç©ºé—´(ibdata)ä¸­ï¼Œä½†ä»5.6å¼€å§‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç‹¬ç«‹çš„Undo è¡¨ç©ºé—´ã€‚ Undoè®°å½•ä¸­å­˜å‚¨çš„æ˜¯è€ç‰ˆæœ¬æ•°æ®ï¼Œå½“ä¸€ä¸ªæ—§çš„äº‹åŠ¡éœ€è¦è¯»å–æ•°æ®æ—¶ï¼Œä¸ºäº†èƒ½è¯»å–åˆ°è€ç‰ˆæœ¬çš„æ•°æ®ï¼Œéœ€è¦é¡ºç€undoé“¾æ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•ã€‚å½“ç‰ˆæœ¬é“¾å¾ˆé•¿æ—¶ï¼Œé€šå¸¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œã€‚ Undo Log æ ¼å¼ åœ¨InnoDBå¼•æ“ä¸­ï¼Œundo logåˆ†ä¸ºï¼š insert undo logï¼š insert undo logæ˜¯æŒ‡åœ¨insertæ“ä½œä¸­äº§ç”Ÿçš„undo logï¼Œå› ä¸ºinsertæ“ä½œçš„è®°å½•ï¼Œåªå¯¹äº‹åŠ¡æœ¬èº«å¯è§ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ï¼ˆè¿™æ˜¯äº‹åŠ¡éš”ç¦»æ€§çš„è¦æ±‚ï¼‰ï¼Œæ•…è¯¥undo logå¯ä»¥åœ¨äº‹åŠ¡æäº¤åç›´æ¥åˆ é™¤ï¼Œä¸éœ€è¦è¿›è¡Œpurgeæ“ä½œã€‚ update undo logï¼š update undo logè®°å½•çš„æ˜¯deleteå’Œupdateæ“ä½œäº§ç”Ÿçš„undo logã€‚è¯¥undo logå¯èƒ½éœ€è¦æä¾›MVCCæœºåˆ¶ï¼Œå› æ­¤ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶å°±è¿›è¡Œåˆ é™¤ï¼Œæäº¤æ—¶æ”¾å…¥undo logé“¾è¡¨ï¼Œç­‰å¾…purgeçº¿ç¨‹è¿›è¡Œæœ€åçš„åˆ é™¤ã€‚ä¸‹é¢æ˜¯ä¸¤ç§undo logçš„ç»“æ„å›¾ã€‚","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"redolog","slug":"7.mysql/redoæ—¥å¿—","date":"2021-12-26T16:00:00.000Z","updated":"2022-03-31T02:55:44.591Z","comments":true,"path":"2021/12/27/7.mysql/redoæ—¥å¿—/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/27/7.mysql/redo%E6%97%A5%E5%BF%97/","excerpt":"","text":"ä¸€ï¼Œä»€ä¹ˆæ˜¯redoæ—¥å¿—InnoDBå­˜å‚¨å¼•æ“æ˜¯ä»¥é¡µä¸ºå•ä½æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œæˆ‘ä»¬çš„CRUDæ“ä½œå…¶å®éƒ½æ˜¯åœ¨è®¿é—®é¡µé¢ã€‚åœ¨çœŸæ­£è®¿é—®é¡µé¢ä¹‹å‰ï¼Œéœ€è¦æŠŠç£ç›˜ä¸­çš„é¡µåŠ è½½åˆ°å†…å­˜çš„BufferPoolï¼Œä¹‹åæ‰èƒ½è®¿é—®ï¼Œä½†æ˜¯å› ä¸ºäº‹åŠ¡è¦ä¿æŒæŒä¹…æ€§ï¼Œå¦‚æœæˆ‘ä»¬ä»…ä»…åœ¨å†…å­˜çš„ç¼“å†²æ± ä¿®æ”¹äº†é¡µé¢ï¼Œå‡è®¾äº‹åŠ¡æäº¤åçªç„¶å‘ç”Ÿæ•…éšœï¼Œå¯¼è‡´å†…å­˜çš„æ•°æ®éƒ½æ¶ˆå¤±äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå·²ç»æäº¤çš„äº‹åŠ¡åœ¨æ•°æ®åº“åšçš„æ›´æ”¹å°±ä¸¢å¤±äº†ã€‚ å¦‚ä½•ä¿è¯æŒä¹…æ€§å‘¢ï¼Ÿå¯ä»¥åœ¨äº‹åŠ¡æäº¤å®Œæˆä¹‹å‰ï¼ŒæŠŠäº‹åŠ¡ä¿®æ”¹çš„æ‰€æœ‰é¡µé¢éƒ½åˆ·æ–°åˆ°ç£ç›˜ã€‚ä¸è¿‡è¿™æ ·åšå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š åˆ·æ–°ä¸€ä¸ªå®Œæ•´çš„æ•°æ®é¡µè¿‡äºæµªè´¹ éšæœºIOæ•ˆç‡æ¯”è¾ƒä½ äº‹å®ä¸Šä»…ä»…æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œæ²¡æœ‰å¿…è¦æ¯æ¬¡æäº¤äº‹åŠ¡çš„æ—¶å€™å°±æŠŠè¯¥äº‹åŠ¡åœ¨å†…å­˜ä¿®æ”¹è¿‡çš„å…¨éƒ¨é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œåªéœ€è¦æŠŠä¿®æ”¹çš„å†…å®¹è®°å½•ä¸€ä¸‹å°±å¥½ï¼Œè¿™æ ·åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªè®°å½•åˆ·æ–°åˆ°ç£ç›˜ã€‚å³ä½¿ç³»ç»Ÿå› ä¸ºå´©æºƒè€Œé‡å¯åªéœ€è¦æŒ‰ç…§è®°å½•çš„å†…å®¹é‡æ–°æ›´æ–°æ•°æ®é¡µå³å¯æ¢å¤æ•°æ®ï¼Œä¸Šè¿°è®°å½•ä¿®æ”¹çš„å†…å®¹å°±å«åšé‡åšæ—¥å¿—ï¼ˆredo logï¼‰ã€‚ ç›¸æ¯”äºåœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„å†…å­˜ä¸­çš„é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‡åšæ—¥å¿—æœ‰ä»¥ä¸‹å¥½å¤„ï¼š redoæ—¥å¿—å ç”¨ç©ºé—´å°ï¼šåœ¨å­˜å‚¨è¡¨ç©ºé—´IDï¼Œé¡µå·ï¼Œåç§»é‡ä»¥åŠéœ€è¦æ›´æ–°çš„å€¼æ—¶ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´å¾ˆå°ã€‚ redoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„ï¼šåœ¨æ‰§è¡Œäº‹åŠ¡è¿‡ç¨‹ä¸­ï¼Œæ¯æ‰§è¡Œä¸€æ¡è¯­å¥ï¼Œå°±å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—æ˜¯æŒ‰ç…§äº§ç”Ÿçš„é¡ºåºå†™å…¥ç£ç›˜çš„ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é¡ºåºIOã€‚ äºŒï¼Œredoæ—¥å¿—æ ¼å¼é‡åšæ—¥å¿—æœ¬è´¨ä¸Šä»…ä»…æ˜¯è®°å½•äº†ä¸€ä¸‹äº‹åŠ¡å¯¹æ•°æ®åº“è¿›è¡Œäº†å“ªäº›ä¿®æ”¹ã€‚é’ˆå¯¹äº‹åŠ¡å¯¹æ•°æ®åº“çš„ä¸åŒä¿®æ”¹åœºæ™¯MySQLå®šä¹‰äº†å¾ˆå¤šç§é‡åšæ—¥å¿—ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†ç±»å‹çš„é‡åšæ—¥å¿—éƒ½æœ‰ä»¥ä¸‹çš„é€šç”¨ç»“æ„ã€‚ type é‡åšæ—¥å¿—çš„ç±»å‹ space ID è¡¨ç©ºé—´ID page number é¡µå· Data æ—¥å¿—çš„å…·ä½“å†…å®¹ 1. ç®€å•çš„redoæ—¥å¿—ç±»å‹è¡Œæ ¼å¼é‡Œé¢æœ‰ä¸€ä¸ªéšè—åˆ—å«åšrow_idã€‚ä¸ºrow_idè¿›è¡Œèµ‹å€¼çš„æ–¹å¼å¦‚ä¸‹ï¼š æœåŠ¡å™¨ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ¯å½“åƒæŸä¸ªåŒ…å«row_idéšè—åˆ—çš„è¡¨æ’å…¥ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå…¨å±€å˜é‡çš„å€¼å½“åšæ–°è®°å½•row_idçš„å€¼ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªå…¨å±€å˜é‡è‡ªå¢1ã€‚ æ¯å½“è¿™ä¸ªå…¨å±€å˜é‡çš„å€¼æ˜¯256çš„æ•´æ•°å€çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå˜é‡çš„å€¼åˆ·æ–°åˆ°ç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢ä¸­ä¸€ä¸ªå«åšMax Row IDçš„å±æ€§ä¸­ã€‚ å½“ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå°†Max Row IDå±æ€§åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶æŠŠè¿™ä¸ªå€¼åŠ ä¸Š256ä¹‹åèµ‹å€¼ç»™å‰é¢æåˆ°çš„å…¨å±€å˜é‡ã€‚ è¿™ä¸ªMax Row IDå ç”¨çš„å­˜å‚¨ç©ºé—´æ˜¯8å­—èŠ‚ã€‚å½“æŸä¸ªäº‹åŠ¡å‘æŸä¸ªåŒ…å«row_idçš„è¡¨æ’å…¥ä¸€æ¡è®°å½•å¹¶ä¸”è¯¥è®°å½•åˆ†é…çš„row_idå€¼ä¸º256çš„æ•´æ•°å€çš„æ—¶å€™ï¼Œå°±ä¼šåƒç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢çš„ç›¸åº”åç§»é‡å¤„å†™å…¥8å­—èŠ‚çš„å€¼ã€‚ä½†æ˜¯è¿™ä¸ªå†™å…¥æ“ä½œå®é™…ä¸Šæ˜¯åœ¨å†…å­˜ç¼“å†²åŒºå®Œæˆçš„ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™æ¬¡ä¿®æ”¹ä»¥redoæ—¥å¿—çš„å½¢å¼è®°å½•ä¸‹æ¥ï¼Œè¿™æ ·åœ¨äº‹åŠ¡æäº¤ä¹‹åï¼Œå³ä½¿ç³»ç»Ÿå´©æºƒï¼Œä¹Ÿå¯ä»¥å°†è¯¥é¡µé¢æ¢å¤æˆå´©æºƒå‰çš„çŠ¶æ€ã€‚åœ¨è¿™ç§å¯¹é¡µé¢çš„ä¿®æ”¹ç‰¹åˆ«ç®€å•çš„æ—¶å€™ï¼Œé‡åšæ—¥å¿—ä»…ä»…éœ€è¦è®°å½•ä¸€ä¸‹åœ¨æŸä¸ªé¡µé¢çš„æŸä¸ªåç§»é‡å¤„ä¿®æ”¹äº†å‡ ä¸ªå­—èŠ‚çš„å€¼ï¼Œå…·ä½“ä¿®æ”¹åçš„å†…å®¹æ˜¯ä»€ä¹ˆå°±å¯ä»¥äº†ã€‚è¿™ä¹Ÿå«åšç‰©ç†æ—¥å¿—ã€‚ offsetè¡¨ç¤ºé¡µé¢ä¸­çš„åç§»é‡ã€‚å¦‚æœå†™å…¥çš„æ˜¯å­—èŠ‚åºåˆ—ç±»å‹çš„é‡åšæ—¥å¿—ï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ªlenå±æ€§è®°å½•å®é™…å†™å…¥çš„é•¿åº¦ã€‚ 2.å¤æ‚çš„redoæ—¥å¿—ç±»å‹æœ‰æ—¶å€™æ‰§è¡Œä¸€æ¡è¯­å¥ä¼šä¿®æ”¹éå¸¸å¤šçš„é¡µé¢ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ•°æ®é¡µé¢å’Œç”¨æˆ·æ•°æ®é¡µé¢ï¼ˆç”¨æˆ·æ•°æ®æŒ‡çš„å°±æ˜¯èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•å¯¹åº”çš„B+æ ‘ï¼‰ è¿™æ—¶æˆ‘ä»¬å¦‚æœä½¿ç”¨ç®€å•çš„ç‰©ç†redoæ—¥å¿—æ¥è®°å½•è¿™äº›ä¿®æ”¹æ—¶ï¼Œå¯ä»¥æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š æ–¹æ¡ˆä¸€ï¼šåœ¨æ¯ä¸ªä¿®æ”¹çš„åœ°æ–¹éƒ½è®°å½•ä¸€æ¡redoæ—¥å¿—ã€‚ä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªä¿®æ”¹çš„è®°å½•ï¼Œå°±å†™å¤šå°‘æ¡ç‰©ç†redoæ—¥å¿—ã€‚è¿™æ ·å­è®°å½•redoæ—¥å¿—çš„ç¼ºç‚¹æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå› ä¸ºè¢«ä¿®æ”¹çš„åœ°æ–¹æ˜¯åœ¨å¤ªå¤šäº†ï¼Œå¯èƒ½è®°å½•çš„redoæ—¥å¿—å ç”¨çš„ç©ºé—´éƒ½æ¯”æ•´ä¸ªé¡µé¢å ç”¨çš„ç©ºé—´éƒ½å¤šã€‚ æ–¹æ¡ˆäºŒï¼šå°†æ•´ä¸ªé¡µé¢çš„ç¬¬ä¸€ä¸ªè¢«ä¿®æ”¹çš„å­—èŠ‚åˆ°æœ€åä¸€ä¸ªä¿®æ”¹çš„å­—èŠ‚ä¹‹é—´æ‰€æœ‰çš„æ•°æ®å½“æˆæ˜¯ä¸€æ¡ç‰©ç†redoæ—¥å¿—ä¸­çš„å…·ä½“æ•°æ®ã€‚ç¬¬ä¸€ä¸ªè¢«ä¿®æ”¹çš„å­—èŠ‚åˆ°æœ€åä¸€ä¸ªä¿®æ”¹çš„å­—èŠ‚ä¹‹é—´ä»ç„¶æœ‰è®¸å¤šæ²¡æœ‰ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œæˆ‘ä»¬æŠŠè¿™äº›æ²¡æœ‰ä¿®æ”¹çš„æ•°æ®ä¹ŸåŠ å…¥åˆ°redoæ—¥å¿—ä¸­å¤ªæµªè´¹äº†ã€‚ æ­£å› ä¸ºä¸Šè¿°ä¸¤ç§ä½¿ç”¨ç‰©ç†redoæ—¥å¿—çš„æ–¹å¼æ¥è®°å½•æŸä¸ªé¡µé¢ä¸­åšäº†å“ªäº›ä¿®æ”¹æ¯”è¾ƒæµªè´¹ï¼ŒInnoDBæå‡ºäº†ä¸€äº›æ–°çš„redoæ—¥å¿—ç±»å‹ã€‚ è¿™äº›ç±»å‹çš„redoæ—¥å¿—æ—¢åŒ…å«ç‰©ç†å±‚é¢çš„æ„æ€ï¼Œä¹ŸåŒ…å«é€»è¾‘å±‚é¢çš„æ„æ€ï¼Œå…·ä½“æŒ‡ï¼š ç‰©ç†å±‚é¢çœ‹ï¼Œè¿™äº›æ—¥å¿—éƒ½æŒ‡æ˜äº†å¯¹å“ªä¸ªè¡¨ç©ºé—´çš„å“ªä¸ªé¡µè¿›è¡Œäº†ä¿®æ”¹ã€‚ é€»è¾‘å±‚é¢çœ‹ï¼Œåœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶ï¼Œå¹¶ä¸èƒ½ç›´æ¥æ ¹æ®è¿™äº›æ—¥å¿—é‡Œçš„è®°è½½ï¼Œå°†é¡µé¢å†…çš„æŸä¸ªåç§»é‡å¤„æ¢å¤æˆæŸä¸ªæ•°æ®ï¼Œè€Œæ˜¯éœ€è¦è°ƒç”¨ä¸€äº›äº‹å…ˆå‡†å¤‡å¥½çš„å‡½æ•°ï¼Œæ‰§è¡Œå®Œè¿™äº›å‡½æ•°åæ‰å¯ä»¥å°†é¡µé¢æ¢å¤æˆç³»ç»Ÿå´©æºƒå‰çš„æ ·å­ã€‚ è¿™ä¸ªç±»å‹ä¸ºMLOG_COMP_REC_INSERTçš„redoæ—¥å¿—å¹¶æ²¡æœ‰è®°å½•PAGE_N_DIR_SLOTSçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆï¼ŒPAGE_HEAP_TOPçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆï¼ŒPAGE_N_HEAPçš„å€¼ä¿®æ”¹ä¸ºäº†ä»€ä¹ˆç­‰ç­‰è¿™äº›ä¿¡æ¯ï¼Œè€Œåªæ˜¯æŠŠåœ¨æœ¬é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ‰€æœ‰å¿…å¤‡çš„è¦ç´ è®°äº†ä¸‹æ¥ï¼Œä¹‹åç³»ç»Ÿå´©æºƒé‡å¯æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè°ƒç”¨ç›¸å…³å‘æŸä¸ªé¡µé¢æ’å…¥ä¸€æ¡è®°å½•çš„é‚£ä¸ªå‡½æ•°ï¼Œè€Œredoæ—¥å¿—ä¸­çš„é‚£äº›æ•°æ®å°±å¯ä»¥è¢«å½“æˆæ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æ‰€éœ€çš„å‚æ•°ï¼Œåœ¨è°ƒç”¨å®Œè¯¥å‡½æ•°åï¼Œé¡µé¢ä¸­çš„PAGE_N_DIR_SLOTSã€PAGE_HEAP_TOPã€PAGE_N_HEAPç­‰ç­‰çš„å€¼ä¹Ÿå°±éƒ½è¢«æ¢å¤åˆ°ç³»ç»Ÿå´©æºƒå‰çš„æ ·å­äº†ã€‚è¿™å°±æ˜¯æ‰€è°“çš„é€»è¾‘æ—¥å¿—çš„æ„æ€ã€‚ æ—¥å¿—æ ¼å¼è¯´äº†ä¸€å †æ ¸å¿ƒå…¶å®å°±æ˜¯ï¼šé‡åšæ—¥å¿—ä¼šæŠŠäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æ•°æ®åº“æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹éƒ½è®°å½•ä¸‹æ¥ï¼Œåœ¨ä¹‹åç³»ç»Ÿå› ä¸ºå´©æºƒè€Œé‡å¯åå¯ä»¥æŠŠäº‹åŠ¡æ‰€åšçš„ä»»ä½•ä¿®æ”¹éƒ½æ¢å¤è¿‡æ¥ã€‚ ä¸ºäº†èŠ‚çœé‡åšæ—¥å¿—å ç”¨çš„ç©ºé—´å¤§å°ï¼ŒInnoDBè¿˜å¯¹é‡åšæ—¥å¿—ä¸­çš„æŸäº›æ•°æ®è¿›è¡Œäº†å‹ç¼©å¤„ç†ï¼Œæ¯”å¦‚è¡¨ç©ºé—´ID&amp;page number ä¸€èˆ¬å ç”¨4å­—èŠ‚æ¥å­˜å‚¨ï¼Œä½†æ˜¯ç»è¿‡å‹ç¼©ä¹‹åå ç”¨çš„ç©ºé—´å°±æ›´å°äº†ã€‚ ä¸‰ï¼ŒMini-Transcation1.ä»¥ç»„çš„å½¢å¼å†™å…¥redoæ—¥å¿—è¯­å¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¿®æ”¹è‹¥å¹²ä¸ªé¡µé¢ã€‚æ¯”å¦‚æˆ‘ä»¬å‰è¾¹è¯´çš„ä¸€æ¡INSERTè¯­å¥å¯èƒ½ä¿®æ”¹ç³»ç»Ÿè¡¨ç©ºé—´é¡µå·ä¸º7çš„é¡µé¢çš„Max Row IDå±æ€§ï¼ˆå½“ç„¶ä¹Ÿå¯èƒ½æ›´æ–°åˆ«çš„ç³»ç»Ÿé¡µé¢ï¼Œåªä¸è¿‡æˆ‘ä»¬æ²¡æœ‰éƒ½åˆ—ä¸¾å‡ºæ¥è€Œå·²ï¼‰ï¼Œè¿˜ä¼šæ›´æ–°èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•å¯¹åº”B+æ ‘ä¸­çš„é¡µé¢ã€‚ç”±äºå¯¹è¿™äº›é¡µé¢çš„æ›´æ”¹éƒ½å‘ç”Ÿåœ¨Buffer Poolä¸­ï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹å®Œé¡µé¢ä¹‹åï¼Œéœ€è¦è®°å½•ä¸€ä¸‹ç›¸åº”çš„redoæ—¥å¿—ã€‚åœ¨æ‰§è¡Œè¯­å¥çš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoæ—¥å¿—è¢«InnoDBäººä¸ºçš„åˆ’åˆ†æˆäº†è‹¥å¹²ä¸ªä¸å¯åˆ†å‰²çš„ç»„ï¼Œæ¯”å¦‚ï¼š æ›´æ–°Max Row IDå±æ€§æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ å‘èšç°‡ç´¢å¼•å¯¹åº”B+æ ‘çš„é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ å‘æŸä¸ªäºŒçº§ç´¢å¼•å¯¹åº”B+æ ‘çš„é¡µé¢ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ è¿˜æœ‰å…¶ä»–çš„ä¸€äº›å¯¹é¡µé¢çš„è®¿é—®æ“ä½œæ—¶äº§ç”Ÿçš„redoæ—¥å¿—æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚ã€‚ã€‚ æ€ä¹ˆç†è§£è¿™ä¸ªä¸å¯åˆ†å‰²çš„æ„æ€å‘¢ï¼Ÿæˆ‘ä»¬ä»¥å‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘æ’å…¥ä¸€æ¡è®°å½•ä¸ºä¾‹ï¼Œåœ¨å‘B+æ ‘ä¸­æ’å…¥è¿™æ¡è®°å½•ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä½åˆ°è¿™æ¡è®°å½•åº”è¯¥è¢«æ’å…¥åˆ°å“ªä¸ªå¶å­èŠ‚ç‚¹ä»£è¡¨çš„æ•°æ®é¡µä¸­ï¼Œå®šä½åˆ°å…·ä½“çš„æ•°æ®é¡µä¹‹åï¼Œæœ‰ä¸¤ç§å¯èƒ½çš„æƒ…å†µï¼š æƒ…å†µä¸€ï¼šè¯¥æ•°æ®é¡µçš„å‰©ä½™çš„ç©ºé—²ç©ºé—´å……è¶³ï¼Œè¶³å¤Ÿå®¹çº³è¿™ä¸€æ¡å¾…æ’å…¥è®°å½•ï¼Œé‚£ä¹ˆäº‹æƒ…å¾ˆç®€å•ï¼Œç›´æ¥æŠŠè®°å½•æ’å…¥åˆ°è¿™ä¸ªæ•°æ®é¡µä¸­ï¼Œè®°å½•ä¸€æ¡ç±»å‹ä¸ºMLOG_COMP_REC_INSERTçš„redoæ—¥å¿—å°±å¥½äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç§°ä¹‹ä¸ºä¹è§‚æ’å…¥ã€‚å‡å¦‚æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘é•¿è¿™æ ·ï¼šç°åœ¨æˆ‘ä»¬è¦æ’å…¥ä¸€æ¡é”®å€¼ä¸º10çš„è®°å½•ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦è¢«æ’å…¥åˆ°é¡µbä¸­ï¼Œç”±äºé¡µbç°åœ¨æœ‰è¶³å¤Ÿçš„ç©ºé—´å®¹çº³ä¸€æ¡è®°å½•ï¼Œæ‰€ä»¥ç›´æ¥å°†è¯¥è®°å½•æ’å…¥åˆ°é¡µbä¸­å°±å¥½äº†ï¼Œå°±åƒè¿™æ ·ï¼š æƒ…å†µäºŒï¼šè¯¥æ•°æ®é¡µå‰©ä½™çš„ç©ºé—²ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆäº‹æƒ…å°±æ‚²å‰§äº†ï¼Œæˆ‘ä»¬å‰è¾¹è¯´è¿‡ï¼Œé‡åˆ°è¿™ç§æƒ…å†µè¦è¿›è¡Œæ‰€è°“çš„é¡µåˆ†è£‚æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ–°å»ºä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œç„¶åæŠŠåŸå…ˆæ•°æ®é¡µä¸­çš„ä¸€éƒ¨åˆ†è®°å½•å¤åˆ¶åˆ°è¿™ä¸ªæ–°çš„æ•°æ®é¡µä¸­ï¼Œç„¶åå†æŠŠè®°å½•æ’å…¥è¿›å»ï¼ŒæŠŠè¿™ä¸ªå¶å­èŠ‚ç‚¹æ’å…¥åˆ°å¶å­èŠ‚ç‚¹é“¾è¡¨ä¸­ï¼Œæœ€åè¿˜è¦åœ¨å†…èŠ‚ç‚¹ä¸­æ·»åŠ ä¸€æ¡ç›®å½•é¡¹è®°å½•æŒ‡å‘è¿™ä¸ªæ–°åˆ›å»ºçš„é¡µé¢ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹è¦å¯¹å¤šä¸ªé¡µé¢è¿›è¡Œä¿®æ”¹ï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šäº§ç”Ÿå¤šæ¡redoæ—¥å¿—ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç§°ä¹‹ä¸ºæ‚²è§‚æ’å…¥ã€‚å‡å¦‚æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘é•¿è¿™æ ·ï¼šç°åœ¨æˆ‘ä»¬è¦æ’å…¥ä¸€æ¡é”®å€¼ä¸º10çš„è®°å½•ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦è¢«æ’å…¥åˆ°é¡µbä¸­ï¼Œä½†æ˜¯ä»å›¾ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ­¤æ—¶é¡µbå·²ç»å¡æ»¡äº†è®°å½•ï¼Œæ²¡æœ‰æ›´å¤šçš„ç©ºé—²ç©ºé—´æ¥å®¹çº³è¿™æ¡æ–°è®°å½•äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œé¡µé¢çš„åˆ†è£‚æ“ä½œï¼Œå°±åƒè¿™æ ·ï¼šå¦‚æœä½œä¸ºå†…èŠ‚ç‚¹çš„é¡µaçš„å‰©ä½™ç©ºé—²ç©ºé—´ä¹Ÿä¸è¶³ä»¥å®¹çº³å¢åŠ ä¸€æ¡ç›®å½•é¡¹è®°å½•ï¼Œé‚£éœ€è¦ç»§ç»­åšå†…èŠ‚ç‚¹é¡µaçš„åˆ†è£‚æ“ä½œï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šä¿®æ”¹æ›´å¤šçš„é¡µé¢ï¼Œä»è€Œäº§ç”Ÿæ›´å¤šçš„redoæ—¥å¿—ã€‚å¦å¤–ï¼Œå¯¹äºæ‚²è§‚æ’å…¥æ¥è¯´ï¼Œç”±äºéœ€è¦æ–°ç”³è¯·æ•°æ®é¡µï¼Œè¿˜éœ€è¦æ”¹åŠ¨ä¸€äº›ç³»ç»Ÿé¡µé¢ï¼Œæ¯”æ–¹è¯´è¦ä¿®æ”¹å„ç§æ®µã€åŒºçš„ç»Ÿè®¡ä¿¡æ¯ä¿¡æ¯ï¼Œå„ç§é“¾è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¯”å¦‚ä»€ä¹ˆFREEé“¾è¡¨ã€FSP_FREE_FRAGé“¾è¡¨ç­‰ï¼Œæˆ‘ä»¬åœ¨ä»‹ç»è¡¨ç©ºé—´é‚£ä¸€ç¯‡ä¸­ä»‹ç»è¿‡çš„å„ç§ä¸œè¥¿)ï¼Œåæ­£æ€»å…±éœ€è¦è®°å½•çš„redoæ—¥å¿—æœ‰äºŒã€ä¸‰åæ¡ã€‚ å…¶å®ä¸å…‰æ˜¯æ‚²è§‚æ’å…¥ä¸€æ¡è®°å½•ä¼šç”Ÿæˆè®¸å¤šæ¡redoæ—¥å¿—ï¼ŒInnoDBä¸ºäº†å…¶ä»–çš„ä¸€äº›åŠŸèƒ½ï¼Œåœ¨ä¹è§‚æ’å…¥æ—¶ä¹Ÿå¯èƒ½äº§ç”Ÿå¤šæ¡redoæ—¥å¿—ã€‚ InnoDBè®¤ä¸ºå‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ’å…¥ä¸€æ¡è®°å½•çš„è¿™ä¸ªè¿‡ç¨‹å¿…é¡»æ˜¯åŸå­çš„ï¼Œä¸èƒ½è¯´æ’äº†ä¸€åŠä¹‹åå°±åœæ­¢äº†ã€‚æ¯”æ–¹è¯´åœ¨æ‚²è§‚æ’å…¥è¿‡ç¨‹ä¸­ï¼Œæ–°çš„é¡µé¢å·²ç»åˆ†é…å¥½äº†ï¼Œæ•°æ®ä¹Ÿå¤åˆ¶è¿‡å»äº†ï¼Œæ–°çš„è®°å½•ä¹Ÿæ’å…¥åˆ°é¡µé¢ä¸­äº†ï¼Œå¯æ˜¯æ²¡æœ‰å‘å†…èŠ‚ç‚¹ä¸­æ’å…¥ä¸€æ¡ç›®å½•é¡¹è®°å½•ï¼Œè¿™ä¸ªæ’å…¥è¿‡ç¨‹å°±æ˜¯ä¸å®Œæ•´çš„ï¼Œè¿™æ ·ä¼šå½¢æˆä¸€æ£µä¸æ­£ç¡®çš„B+æ ‘ã€‚æˆ‘ä»¬çŸ¥é“redoæ—¥å¿—æ˜¯ä¸ºäº†åœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶æ¢å¤å´©æºƒå‰çš„çŠ¶æ€ï¼Œå¦‚æœåœ¨æ‚²è§‚æ’å…¥çš„è¿‡ç¨‹ä¸­åªè®°å½•äº†ä¸€éƒ¨åˆ†redoæ—¥å¿—ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿå´©æºƒé‡å¯æ—¶ä¼šå°†ç´¢å¼•å¯¹åº”çš„B+æ ‘æ¢å¤æˆä¸€ç§ä¸æ­£ç¡®çš„çŠ¶æ€ï¼Œè¿™æ˜¯InnoDBæ‰€ä¸èƒ½å¿å—çš„ã€‚æ‰€ä»¥ä»–ä»¬è§„å®šåœ¨æ‰§è¡Œè¿™äº›éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œæ—¶å¿…é¡»ä»¥ç»„çš„å½¢å¼æ¥è®°å½•çš„redoæ—¥å¿—ï¼Œåœ¨è¿›è¡Œç³»ç»Ÿå´©æºƒé‡å¯æ¢å¤æ—¶ï¼Œé’ˆå¯¹æŸä¸ªç»„ä¸­çš„redoæ—¥å¿—ï¼Œè¦ä¹ˆæŠŠå…¨éƒ¨çš„æ—¥å¿—éƒ½æ¢å¤æ‰ï¼Œè¦ä¹ˆä¸€æ¡ä¹Ÿä¸æ¢å¤ã€‚æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿè¿™å¾—åˆ†æƒ…å†µè®¨è®ºï¼š æœ‰çš„éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œä¼šç”Ÿæˆå¤šæ¡redoæ—¥å¿—ï¼Œæ¯”å¦‚å‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­è¿›è¡Œä¸€æ¬¡æ‚²è§‚æ’å…¥å°±éœ€è¦ç”Ÿæˆè®¸å¤šæ¡redoæ—¥å¿—ã€‚å¦‚ä½•æŠŠè¿™äº›redoæ—¥å¿—åˆ’åˆ†åˆ°ä¸€ä¸ªç»„é‡Œè¾¹å„¿å‘¢ï¼ŸInnoDBåšäº†ä¸€ä¸ªå¾ˆç®€å•çš„æ“ä½œï¼Œå°±æ˜¯åœ¨è¯¥ç»„ä¸­çš„æœ€åä¸€æ¡redoæ—¥å¿—åè¾¹åŠ ä¸Šä¸€æ¡ç‰¹æ®Šç±»å‹çš„redoæ—¥å¿—ï¼Œè¯¥ç±»å‹åç§°ä¸ºMLOG_MULTI_REC_ENDï¼Œtypeå­—æ®µå¯¹åº”çš„åè¿›åˆ¶æ•°å­—ä¸º31ï¼Œè¯¥ç±»å‹çš„redoæ—¥å¿—ç»“æ„å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªtypeå­—æ®µï¼šæ‰€ä»¥æŸä¸ªéœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œäº§ç”Ÿçš„ä¸€ç³»åˆ—redoæ—¥å¿—å¿…é¡»è¦ä»¥ä¸€ä¸ªç±»å‹ä¸ºMLOG_MULTI_REC_ENDç»“å°¾ï¼Œå°±åƒè¿™æ ·ï¼šè¿™æ ·åœ¨ç³»ç»Ÿå´©æºƒé‡å¯è¿›è¡Œæ¢å¤æ—¶ï¼Œåªæœ‰å½“è§£æåˆ°ç±»å‹ä¸ºMLOG_MULTI_REC_ENDçš„redoæ—¥å¿—ï¼Œæ‰è®¤ä¸ºè§£æåˆ°äº†ä¸€ç»„å®Œæ•´çš„redoæ—¥å¿—ï¼Œæ‰ä¼šè¿›è¡Œæ¢å¤ã€‚å¦åˆ™çš„è¯ç›´æ¥æ”¾å¼ƒå‰è¾¹è§£æåˆ°çš„redoæ—¥å¿—ã€‚ æœ‰çš„éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªç”Ÿæˆä¸€æ¡redoæ—¥å¿—ï¼Œæ¯”å¦‚æ›´æ–°Max Row IDå±æ€§çš„æ“ä½œå°±åªä¼šç”Ÿæˆä¸€æ¡redoæ—¥å¿—ã€‚å…¶å®åœ¨ä¸€æ¡æ—¥å¿—åè¾¹è·Ÿä¸€ä¸ªç±»å‹ä¸ºMLOG_MULTI_REC_ENDçš„redoæ—¥å¿—ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒInnoDBä¸æƒ³æµªè´¹ä¸€ä¸ªæ¯”ç‰¹ä½ã€‚è™½ç„¶redoæ—¥å¿—çš„ç±»å‹æ¯”è¾ƒå¤šï¼Œä½†æ’‘æ­»äº†ä¹Ÿå°±æ˜¯å‡ åç§ï¼Œæ˜¯å°äº127è¿™ä¸ªæ•°å­—çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç”¨7ä¸ªæ¯”ç‰¹ä½å°±è¶³ä»¥åŒ…æ‹¬æ‰€æœ‰çš„redoæ—¥å¿—ç±»å‹ï¼Œè€Œtypeå­—æ®µå…¶å®æ˜¯å ç”¨1ä¸ªå­—èŠ‚çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥çœå‡ºæ¥ä¸€ä¸ªæ¯”ç‰¹ä½ç”¨æ¥è¡¨ç¤ºè¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªäº§ç”Ÿå•ä¸€çš„ä¸€æ¡redoæ—¥å¿—ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼šå¦‚æœtypeå­—æ®µçš„ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½ä¸º1ï¼Œä»£è¡¨è¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œåªäº§ç”Ÿäº†å•ä¸€çš„ä¸€æ¡redoæ—¥å¿—ï¼Œå¦åˆ™è¡¨ç¤ºè¯¥éœ€è¦ä¿è¯åŸå­æ€§çš„æ“ä½œäº§ç”Ÿäº†ä¸€ç³»åˆ—çš„redoæ—¥å¿—ã€‚ 2.Mini-TransactionMySQLæŠŠå¯¹åº•å±‚é¡µé¢ä¸­çš„ä¸€æ¬¡åŸå­è®¿é—®çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºä¸€ä¸ªMini-Transactionï¼Œç®€ç§°mtrï¼Œæ¯”å¦‚ä¸Šè¾¹æ‰€è¯´çš„ä¿®æ”¹ä¸€æ¬¡Max Row IDçš„å€¼ç®—æ˜¯ä¸€ä¸ªMini-Transactionï¼Œå‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ’å…¥ä¸€æ¡è®°å½•çš„è¿‡ç¨‹ä¹Ÿç®—æ˜¯ä¸€ä¸ªMini-Transactionã€‚ä¸€ä¸ªæ‰€è°“çš„mtrå¯ä»¥åŒ…å«ä¸€ç»„redoæ—¥å¿—ï¼Œåœ¨è¿›è¡Œå´©æºƒæ¢å¤æ—¶è¿™ä¸€ç»„redoæ—¥å¿—ä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ã€‚ ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«è‹¥å¹²æ¡è¯­å¥ï¼Œæ¯ä¸€æ¡è¯­å¥å…¶å®æ˜¯ç”±è‹¥å¹²ä¸ªmtrç»„æˆï¼Œæ¯ä¸€ä¸ªmtråˆå¯ä»¥åŒ…å«è‹¥å¹²æ¡redoæ—¥å¿—ï¼Œç”»ä¸ªå›¾è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»å°±æ˜¯è¿™æ ·ï¼š å››ï¼Œredoæ—¥å¿—çš„å†™å…¥è¿‡ç¨‹1.redo log blockInnoDBä¸ºäº†æ›´å¥½çš„è¿›è¡Œç³»ç»Ÿå´©æºƒæ¢å¤ï¼Œä»–ä»¬æŠŠé€šè¿‡mtrç”Ÿæˆçš„redoæ—¥å¿—éƒ½æ”¾åœ¨äº†å¤§å°ä¸º512å­—èŠ‚çš„é¡µä¸­ã€‚ä¸ºäº†å’Œè¡¨ç©ºé—´ä¸­çš„é¡µåšåŒºåˆ«ï¼Œæˆ‘ä»¬è¿™é‡ŒæŠŠç”¨æ¥å­˜å‚¨redoæ—¥å¿—çš„é¡µç§°ä¸ºblockã€‚ä¸€ä¸ªredo log blockçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š çœŸæ­£çš„redoæ—¥å¿—éƒ½æ˜¯å­˜å‚¨åˆ°å ç”¨496å­—èŠ‚å¤§å°çš„log block bodyä¸­ï¼Œå›¾ä¸­çš„log block headerå’Œlog block trailerå­˜å‚¨çš„æ˜¯ä¸€äº›ç®¡ç†ä¿¡æ¯ã€‚ å…¶ä¸­log block headerçš„å‡ ä¸ªå±æ€§çš„æ„æ€åˆ†åˆ«å¦‚ä¸‹ï¼š LOG_BLOCK_HDR_NOï¼šæ¯ä¸€ä¸ªblockéƒ½æœ‰ä¸€ä¸ªå¤§äº0çš„å”¯ä¸€æ ‡å·ï¼Œæœ¬å±æ€§å°±è¡¨ç¤ºè¯¥æ ‡å·å€¼ã€‚ LOG_BLOCK_HDR_DATA_LENï¼šè¡¨ç¤ºblockä¸­å·²ç»ä½¿ç”¨äº†å¤šå°‘å­—èŠ‚ï¼Œåˆå§‹å€¼ä¸º12ï¼ˆå› ä¸ºlog block bodyä»ç¬¬12ä¸ªå­—èŠ‚å¤„å¼€å§‹ï¼‰ã€‚éšç€å¾€blockä¸­å†™å…¥çš„redoæ—¥å¿—è¶Šæ¥ä¹Ÿå¤šï¼Œæœ¬å±æ€§å€¼ä¹Ÿè·Ÿç€å¢é•¿ã€‚å¦‚æœlog block bodyå·²ç»è¢«å…¨éƒ¨å†™æ»¡ï¼Œé‚£ä¹ˆæœ¬å±æ€§çš„å€¼è¢«è®¾ç½®ä¸º512ã€‚ LOG_BLOCK_FIRST_REC_GROUPï¼šä¸€æ¡redoæ—¥å¿—ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºä¸€æ¡redoæ—¥å¿—è®°å½•ï¼ˆredo log recordï¼‰ï¼Œä¸€ä¸ªmträ¼šç”Ÿäº§å¤šæ¡redoæ—¥å¿—è®°å½•ï¼Œè¿™äº›redoæ—¥å¿—è®°å½•è¢«ç§°ä¹‹ä¸ºä¸€ä¸ªredoæ—¥å¿—è®°å½•ç»„ï¼ˆredo log record groupï¼‰ã€‚LOG_BLOCK_FIRST_REC_GROUPå°±ä»£è¡¨è¯¥blockä¸­ç¬¬ä¸€ä¸ªmtrç”Ÿæˆçš„redoæ—¥å¿—è®°å½•ç»„çš„åç§»é‡ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯è¿™ä¸ªblocké‡Œç¬¬ä¸€ä¸ªmtrç”Ÿæˆçš„ç¬¬ä¸€æ¡redoæ—¥å¿—çš„åç§»é‡ï¼‰ã€‚ LOG_BLOCK_CHECKPOINT_NOï¼šè¡¨ç¤ºæ‰€è°“çš„checkpointçš„åºå·ï¼Œcheckpointæ˜¯æˆ‘ä»¬åç»­å†…å®¹çš„é‡ç‚¹ï¼Œç°åœ¨å…ˆä¸ç”¨æ¸…æ¥šå®ƒçš„æ„æ€ï¼Œç¨å®‰å‹¿èºã€‚ log block trailerä¸­å±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š LOG_BLOCK_CHECKSUMï¼šè¡¨ç¤ºblockçš„æ ¡éªŒå€¼ï¼Œç”¨äºæ­£ç¡®æ€§æ ¡éªŒï¼Œæˆ‘ä»¬æš‚æ—¶ä¸å…³å¿ƒå®ƒã€‚ 2.redo æ—¥å¿—ç¼“å†²åŒºInnoDBä¸ºäº†è§£å†³ç£ç›˜é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜è€Œå¼•å…¥äº†Buffer Poolã€‚åŒç†ï¼Œå†™å…¥redoæ—¥å¿—æ—¶ä¹Ÿä¸èƒ½ç›´æ¥ç›´æ¥å†™åˆ°ç£ç›˜ä¸Šï¼Œå®é™…ä¸Šåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å°±å‘æ“ä½œç³»ç»Ÿç”³è¯·äº†ä¸€å¤§ç‰‡ç§°ä¹‹ä¸ºredo log bufferçš„è¿ç»­å†…å­˜ç©ºé—´ï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯redoæ—¥å¿—ç¼“å†²åŒºï¼Œä¹Ÿå¯ä»¥ç®€ç§°ä¸ºlog bufferã€‚è¿™ç‰‡å†…å­˜ç©ºé—´è¢«åˆ’åˆ†æˆè‹¥å¹²ä¸ªè¿ç»­çš„redo log blockï¼Œå°±åƒè¿™æ ·ï¼š æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°innodb_log_buffer_sizeæ¥æŒ‡å®šlog bufferçš„å¤§å°ï¼Œåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œè¯¥å¯åŠ¨å‚æ•°çš„é»˜è®¤å€¼ä¸º16MBã€‚ 3.redo log æ—¥å¿—å†™å…¥log bufferå‘log bufferä¸­å†™å…¥redoæ—¥å¿—çš„è¿‡ç¨‹æ˜¯é¡ºåºçš„ï¼Œä¹Ÿå°±æ˜¯å…ˆå¾€å‰è¾¹çš„blockä¸­å†™ï¼Œå½“è¯¥blockçš„ç©ºé—²ç©ºé—´ç”¨å®Œä¹‹åå†å¾€ä¸‹ä¸€ä¸ªblockä¸­å†™ã€‚å½“æˆ‘ä»¬æƒ³å¾€log bufferä¸­å†™å…¥redoæ—¥å¿—æ—¶ï¼Œç¬¬ä¸€ä¸ªé‡åˆ°çš„é—®é¢˜å°±æ˜¯åº”è¯¥å†™åœ¨å“ªä¸ªblockçš„å“ªä¸ªåç§»é‡å¤„ï¼Œæ‰€ä»¥InnoDBç‰¹æ„æä¾›äº†ä¸€ä¸ªç§°ä¹‹ä¸ºbuf_freeçš„å…¨å±€å˜é‡ï¼Œè¯¥å˜é‡æŒ‡æ˜åç»­å†™å…¥çš„redoæ—¥å¿—åº”è¯¥å†™å…¥åˆ°log bufferä¸­çš„å“ªä¸ªä½ç½®ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š ä¸€ä¸ªmtræ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›redoæ—¥å¿—æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„ç»„ï¼Œæ‰€ä»¥å…¶å®å¹¶ä¸æ˜¯æ¯ç”Ÿæˆä¸€æ¡redoæ—¥å¿—ï¼Œå°±å°†å…¶æ’å…¥åˆ°log bufferä¸­ï¼Œè€Œæ˜¯æ¯ä¸ªmtrè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ—¥å¿—å…ˆæš‚æ—¶å­˜åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œå½“è¯¥mtrç»“æŸçš„æ—¶å€™ï¼Œå°†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å†å…¨éƒ¨å¤åˆ¶åˆ°log bufferä¸­ã€‚æˆ‘ä»¬ç°åœ¨å‡è®¾æœ‰ä¸¤ä¸ªåä¸ºT1ã€T2çš„äº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½åŒ…å«2ä¸ªmtrï¼Œæˆ‘ä»¬ç»™è¿™å‡ ä¸ªmtrå‘½åä¸€ä¸‹ï¼š äº‹åŠ¡T1çš„ä¸¤ä¸ªmtråˆ†åˆ«ç§°ä¸ºmtr_T1_1å’Œmtr_T1_2ã€‚ äº‹åŠ¡T2çš„ä¸¤ä¸ªmtråˆ†åˆ«ç§°ä¸ºmtr_T2_1å’Œmtr_T2_2ã€‚ æ¯ä¸ªmtréƒ½ä¼šäº§ç”Ÿä¸€ç»„redoæ—¥å¿—ï¼Œä¸åŒçš„äº‹åŠ¡å¯èƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œæ‰€ä»¥T1ã€T2ä¹‹é—´çš„mtrå¯èƒ½æ˜¯äº¤æ›¿æ‰§è¡Œçš„ã€‚æ¯å½“ä¸€ä¸ªmtræ‰§è¡Œå®Œæˆæ—¶ï¼Œä¼´éšè¯¥mtrç”Ÿæˆçš„ä¸€ç»„redoæ—¥å¿—å°±éœ€è¦è¢«å¤åˆ¶åˆ°log bufferä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒäº‹åŠ¡çš„mtrå¯èƒ½æ˜¯äº¤æ›¿å†™å…¥log bufferçš„ï¼Œæˆ‘ä»¬ç”»ä¸ªç¤ºæ„å›¾ï¼ˆä¸ºäº†ç¾è§‚ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªmträ¸­äº§ç”Ÿçš„æ‰€æœ‰çš„redoæ—¥å¿—å½“ä½œä¸€ä¸ªæ•´ä½“æ¥ç”»ï¼‰ï¼š ä»ç¤ºæ„å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸åŒçš„mträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´å¯èƒ½ä¸ä¸€æ ·ï¼Œæœ‰çš„mträº§ç”Ÿçš„redoæ—¥å¿—é‡å¾ˆå°‘ï¼Œæ¯”å¦‚mtr_t1_1ã€mtr_t2_1å°±è¢«æ”¾åˆ°åŒä¸€ä¸ªblockä¸­å­˜å‚¨ï¼Œæœ‰çš„mträº§ç”Ÿçš„redoæ—¥å¿—é‡éå¸¸å¤§ï¼Œæ¯”å¦‚mtr_t1_2äº§ç”Ÿçš„redoæ—¥å¿—ç”šè‡³å ç”¨äº†3ä¸ªblockæ¥å­˜å‚¨ã€‚ äº”ï¼Œredo æ—¥å¿—æ–‡ä»¶1.redoæ—¥å¿—åˆ·ç›˜æ—¶æœºmtrè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—åœ¨mtrç»“æŸæ—¶ä¼šè¢«å¤åˆ¶åˆ°log buffer`ä¸­ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹å®ƒä»¬ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜é‡Œï¼Œæ¯”å¦‚ï¼š log bufferç©ºé—´ä¸è¶³æ—¶log bufferçš„å¤§å°æ˜¯æœ‰é™çš„ï¼ˆé€šè¿‡ç³»ç»Ÿå˜é‡innodb_log_buffer_sizeæŒ‡å®šï¼‰ï¼Œå¦‚æœä¸åœçš„å¾€è¿™ä¸ªæœ‰é™å¤§å°çš„log bufferé‡Œå¡å…¥æ—¥å¿—ï¼Œå¾ˆå¿«å®ƒå°±ä¼šè¢«å¡«æ»¡ã€‚InnoDBè®¤ä¸ºå¦‚æœå½“å‰å†™å…¥log bufferçš„redoæ—¥å¿—é‡å·²ç»å æ»¡äº†log bufferæ€»å®¹é‡çš„å¤§çº¦ä¸€åŠå·¦å³ï¼Œå°±éœ€è¦æŠŠè¿™äº›æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ä¸Šã€‚ äº‹åŠ¡æäº¤æ—¶ä¹‹æ‰€ä»¥ä½¿ç”¨redoæ—¥å¿—ä¸»è¦æ˜¯å› ä¸ºå®ƒå ç”¨çš„ç©ºé—´å°‘ï¼Œè¿˜æ˜¯é¡ºåºå†™ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶å¯ä»¥ä¸æŠŠä¿®æ”¹è¿‡çš„Buffer Poolé¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯æŒä¹…æ€§ï¼Œå¿…é¡»è¦æŠŠä¿®æ”¹è¿™äº›é¡µé¢å¯¹åº”çš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ã€‚ å°†æŸä¸ªè„é¡µåˆ·æ–°åˆ°ç£ç›˜å‰ï¼Œä¼šä¿è¯å…ˆå°†è¯¥è„é¡µå¯¹åº”çš„ redo æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼ˆå†ä¸€æ¬¡ å¼ºè°ƒï¼Œredo æ—¥å¿—æ˜¯é¡ºåºåˆ·æ–°çš„ï¼Œæ‰€ä»¥åœ¨å°†æŸä¸ªè„é¡µå¯¹åº”çš„ redo æ—¥å¿—ä» redo log buffer åˆ·æ–°åˆ°ç£ç›˜æ—¶ï¼Œä¹Ÿä¼šä¿è¯å°†åœ¨å…¶ä¹‹å‰äº§ç”Ÿçš„ redo æ—¥å¿—ä¹Ÿåˆ·æ–°åˆ°ç£ç›˜ï¼‰ã€‚ åå°çº¿ç¨‹ä¸åœçš„åˆ·åå°æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤§çº¦æ¯ç§’éƒ½ä¼šåˆ·æ–°ä¸€æ¬¡log bufferä¸­çš„redoæ—¥å¿—åˆ°ç£ç›˜ã€‚ æ­£å¸¸å…³é—­æœåŠ¡å™¨æ—¶ åšæ‰€è°“çš„checkpointæ—¶ å…¶ä»–çš„ä¸€äº›æƒ…å†µâ€¦ 2.redoæ—¥å¿—æ–‡ä»¶ç»„MySQLçš„æ•°æ®ç›®å½•ï¼ˆä½¿ç”¨SHOW VARIABLES LIKE &#39;datadir&#39;æŸ¥çœ‹ï¼‰ä¸‹é»˜è®¤æœ‰ä¸¤ä¸ªåä¸ºib_logfile0å’Œib_logfile1çš„æ–‡ä»¶ï¼Œlog bufferä¸­çš„æ—¥å¿—é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯åˆ·æ–°åˆ°è¿™ä¸¤ä¸ªç£ç›˜æ–‡ä»¶ä¸­ã€‚å¦‚æœæˆ‘ä»¬å¯¹é»˜è®¤çš„redoæ—¥å¿—æ–‡ä»¶ä¸æ»¡æ„ï¼Œå¯ä»¥é€šè¿‡ä¸‹è¾¹å‡ ä¸ªå¯åŠ¨å‚æ•°æ¥è°ƒèŠ‚ï¼š innodb_log_group_home_dirè¯¥å‚æ•°æŒ‡å®šäº†redoæ—¥å¿—æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œé»˜è®¤å€¼å°±æ˜¯å½“å‰çš„æ•°æ®ç›®å½•ã€‚ innodb_log_file_sizeè¯¥å‚æ•°æŒ‡å®šäº†æ¯ä¸ªredoæ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼Œåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­çš„é»˜è®¤å€¼ä¸º48MBï¼Œ innodb_log_files_in_groupè¯¥å‚æ•°æŒ‡å®šredoæ—¥å¿—æ–‡ä»¶çš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼ä¸º2ï¼Œæœ€å¤§å€¼ä¸º100ã€‚ ç£ç›˜ä¸Šçš„redoæ—¥å¿—æ–‡ä»¶ä¸åªä¸€ä¸ªï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ç»„çš„å½¢å¼å‡ºç°çš„ã€‚è¿™äº›æ–‡ä»¶ä»¥ib_logfile[æ•°å­—]ï¼ˆæ•°å­—å¯ä»¥æ˜¯0ã€1ã€2â€¦ï¼‰çš„å½¢å¼è¿›è¡Œå‘½åã€‚åœ¨å°†redoæ—¥å¿—å†™å…¥æ—¥å¿—æ–‡ä»¶ç»„æ—¶ï¼Œæ˜¯ä»ib_logfile0å¼€å§‹å†™ï¼Œå¦‚æœib_logfile0å†™æ»¡äº†ï¼Œå°±æ¥ç€ib_logfile1å†™ï¼ŒåŒç†ï¼Œib_logfile1å†™æ»¡äº†å°±å»å†™ib_logfile2ï¼Œä¾æ­¤ç±»æ¨ã€‚å¦‚æœå†™åˆ°æœ€åä¸€ä¸ªæ–‡ä»¶è¯¥å’‹åŠï¼Ÿé‚£å°±é‡æ–°è½¬åˆ°ib_logfile0ç»§ç»­å†™ï¼Œæ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ€»å…±çš„redoæ—¥å¿—æ–‡ä»¶å¤§å°å…¶å®å°±æ˜¯ï¼šinnodb_log_file_size Ã— innodb_log_files_in_groupã€‚ å¦‚æœé‡‡ç”¨å¾ªç¯ä½¿ç”¨çš„æ–¹å¼å‘redoæ—¥å¿—æ–‡ä»¶ç»„é‡Œå†™æ•°æ®çš„è¯ï¼Œé‚£å²‚ä¸æ˜¯è¦è¿½å°¾ï¼Œä¹Ÿå°±æ˜¯åå†™å…¥çš„redoæ—¥å¿—è¦†ç›–æ‰å‰è¾¹å†™çš„redoæ—¥å¿—ï¼Ÿå½“ç„¶å¯èƒ½äº†ï¼æ‰€ä»¥InnoDBæå‡ºäº†checkpointçš„æ¦‚å¿µã€‚ 3.redoæ—¥å¿—æ–‡ä»¶æ ¼å¼log bufferæœ¬è´¨ä¸Šæ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¢«åˆ’åˆ†æˆäº†è‹¥å¹²ä¸ª512å­—èŠ‚å¤§å°çš„blockã€‚å°†log bufferä¸­çš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜çš„æœ¬è´¨å°±æ˜¯æŠŠblockçš„é•œåƒå†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥redoæ—¥å¿—æ–‡ä»¶å…¶å®ä¹Ÿæ˜¯ç”±è‹¥å¹²ä¸ª512å­—èŠ‚å¤§å°çš„blockç»„æˆã€‚ redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„æ¯ä¸ªæ–‡ä»¶å¤§å°éƒ½ä¸€æ ·ï¼Œæ ¼å¼ä¹Ÿä¸€æ ·ï¼Œéƒ½æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š å‰2048ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å‰4ä¸ªblockæ˜¯ç”¨æ¥å­˜å‚¨ä¸€äº›ç®¡ç†ä¿¡æ¯çš„ã€‚ ä»ç¬¬2048å­—èŠ‚å¾€åæ˜¯ç”¨æ¥å­˜å‚¨log bufferä¸­çš„blocké•œåƒçš„ã€‚ æ‰€ä»¥æˆ‘ä»¬å‰è¾¹æ‰€è¯´çš„å¾ªç¯ä½¿ç”¨redoæ—¥å¿—æ–‡ä»¶ï¼Œå…¶å®æ˜¯ä»æ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„ç¬¬2048ä¸ªå­—èŠ‚å¼€å§‹ç®—ï¼Œç”»ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š æ™®é€šblockçš„æ ¼å¼æˆ‘ä»¬åœ¨äº†è§£log bufferçš„æ—¶å€™éƒ½è¯´è¿‡äº†ï¼Œå°±æ˜¯log block headerã€log block bodyã€log block trialerè¿™ä¸‰ä¸ªéƒ¨åˆ†ã€‚è¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹æ¯ä¸ªredoæ—¥å¿—æ–‡ä»¶å‰2048ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å‰4ä¸ªç‰¹æ®Šblockçš„æ ¼å¼éƒ½æ˜¯ä»€ä¹ˆä½œç”¨ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™4ä¸ªblockåˆ†åˆ«æ˜¯ï¼š log file headerï¼šæè¿°è¯¥redoæ—¥å¿—æ–‡ä»¶çš„ä¸€äº›æ•´ä½“å±æ€§å„ä¸ªå±æ€§çš„å…·ä½“é‡Šä¹‰å¦‚ä¸‹ï¼š å±æ€§å é•¿åº¦ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ æè¿° LOG_HEADER_FORMAT 4 redoæ—¥å¿—çš„ç‰ˆæœ¬ï¼Œåœ¨MySQL 5.7.21ä¸­è¯¥å€¼æ°¸è¿œä¸º1 LOG_HEADER_PAD1 4 åšå­—èŠ‚å¡«å……ç”¨çš„ï¼Œæ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œå¿½ç•¥ï½ LOG_HEADER_START_LSN 8 æ ‡è®°æœ¬redoæ—¥å¿—æ–‡ä»¶å¼€å§‹çš„LSNå€¼ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶åç§»é‡ä¸º2048å­—èŠ‚åˆå¯¹åº”çš„LSNå€¼ã€‚ LOG_HEADER_CREATOR 32 ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ ‡è®°æœ¬redoæ—¥å¿—æ–‡ä»¶çš„åˆ›å»ºè€…æ˜¯è°ã€‚æ­£å¸¸è¿è¡Œæ—¶è¯¥å€¼ä¸ºMySQLçš„ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ï¼š&quot;MySQL 5.7.21&quot;ï¼Œä½¿ç”¨mysqlbackupå‘½ä»¤åˆ›å»ºçš„redoæ—¥å¿—æ–‡ä»¶çš„è¯¥å€¼ä¸º&quot;ibbackup&quot;å’Œåˆ›å»ºæ—¶é—´ã€‚ LOG_BLOCK_CHECKSUM 4 æœ¬blockçš„æ ¡éªŒå€¼ï¼Œæ‰€æœ‰blockéƒ½æœ‰ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ checkpoint1ï¼šè®°å½•å…³äºcheckpointçš„ä¸€äº›å±æ€§ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼šå„ä¸ªå±æ€§çš„å…·ä½“é‡Šä¹‰å¦‚ä¸‹ï¼š å±æ€§å é•¿åº¦ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ æè¿° LOG_CHECKPOINT_NO 8 æœåŠ¡å™¨åšcheckpointçš„ç¼–å·ï¼Œæ¯åšä¸€æ¬¡checkpointï¼Œè¯¥å€¼å°±åŠ 1ã€‚ LOG_CHECKPOINT_LSN 8 æœåŠ¡å™¨åšcheckpointç»“æŸæ—¶å¯¹åº”çš„LSNå€¼ï¼Œç³»ç»Ÿå´©æºƒæ¢å¤æ—¶å°†ä»è¯¥å€¼å¼€å§‹ã€‚ LOG_CHECKPOINT_OFFSET 8 ä¸Šä¸ªå±æ€§ä¸­çš„LSNå€¼åœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡ LOG_CHECKPOINT_LOG_BUF_SIZE 8 æœåŠ¡å™¨åœ¨åšcheckpointæ“ä½œæ—¶å¯¹åº”çš„log bufferçš„å¤§å° LOG_BLOCK_CHECKSUM 4 æœ¬blockçš„æ ¡éªŒå€¼ï¼Œæ‰€æœ‰blockéƒ½æœ‰ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ ç¬¬ä¸‰ä¸ªblockæœªä½¿ç”¨ï¼Œå¿½ç•¥ checkpoint2ï¼šç»“æ„å’Œcheckpoint1ä¸€æ ·ã€‚ å…­ï¼ŒLog Sequence Numberè‡ªç³»ç»Ÿå¼€å§‹è¿è¡Œï¼Œå°±ä¸æ–­çš„åœ¨ä¿®æ”¹é¡µé¢ï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šä¸æ–­çš„ç”Ÿæˆredoæ—¥å¿—ã€‚redoæ—¥å¿—çš„é‡åœ¨ä¸æ–­çš„é€’å¢ã€‚InnoDBä¸ºè®°å½•å·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œè®¾è®¡äº†ä¸€ä¸ªç§°ä¹‹ä¸ºLog Sequence Numberçš„å…¨å±€å˜é‡ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼šæ—¥å¿—åºåˆ—å·ï¼Œç®€ç§°lsnã€‚InnoDBè§„å®šåˆå§‹çš„lsnå€¼ä¸º8704ï¼ˆä¹Ÿå°±æ˜¯ä¸€æ¡redoæ—¥å¿—ä¹Ÿæ²¡å†™å…¥æ—¶ï¼Œlsnçš„å€¼ä¸º8704ï¼‰ã€‚ åœ¨å‘log bufferä¸­å†™å…¥redoæ—¥å¿—æ—¶ä¸æ˜¯ä¸€æ¡ä¸€æ¡å†™å…¥çš„ï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªmtrç”Ÿæˆçš„ä¸€ç»„redoæ—¥å¿—ä¸ºå•ä½è¿›è¡Œå†™å…¥çš„ã€‚è€Œä¸”å®é™…ä¸Šæ˜¯æŠŠæ—¥å¿—å†…å®¹å†™åœ¨äº†log block bodyå¤„ã€‚ä½†æ˜¯åœ¨ç»Ÿè®¡lsnçš„å¢é•¿é‡æ—¶ï¼Œæ˜¯æŒ‰ç…§å®é™…å†™å…¥çš„æ—¥å¿—é‡åŠ ä¸Šå ç”¨çš„log block headerå’Œlog block traileræ¥è®¡ç®—çš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨ååˆå§‹åŒ–log bufferæ—¶ï¼Œbuf_freeï¼ˆå°±æ˜¯æ ‡è®°ä¸‹ä¸€æ¡redoæ—¥å¿—åº”è¯¥å†™å…¥åˆ°log bufferçš„ä½ç½®çš„å˜é‡ï¼‰å°±ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªblockçš„åç§»é‡ä¸º12å­—èŠ‚ï¼ˆlog block headerçš„å¤§å°ï¼‰çš„åœ°æ–¹ï¼Œé‚£ä¹ˆlsnå€¼ä¹Ÿä¼šè·Ÿç€å¢åŠ 12ï¼š å¦‚æœæŸä¸ªmträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´æ¯”è¾ƒå°ï¼Œä¹Ÿå°±æ˜¯å¾…æ’å…¥çš„blockå‰©ä½™ç©ºé—²ç©ºé—´èƒ½å®¹çº³è¿™ä¸ªmtræäº¤çš„æ—¥å¿—æ—¶ï¼Œlsnå¢é•¿çš„é‡å°±æ˜¯è¯¥mtrç”Ÿæˆçš„redoæ—¥å¿—å ç”¨çš„å­—èŠ‚æ•°ï¼Œå°±åƒè¿™æ ·ï¼šæˆ‘ä»¬å‡è®¾ä¸Šå›¾ä¸­mtr_1äº§ç”Ÿçš„redoæ—¥å¿—é‡ä¸º200å­—èŠ‚ï¼Œé‚£ä¹ˆlsnå°±è¦åœ¨8716çš„åŸºç¡€ä¸Šå¢åŠ 200ï¼Œå˜ä¸º8916ã€‚ å¦‚æœæŸä¸ªmträº§ç”Ÿçš„ä¸€ç»„redoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´æ¯”è¾ƒå¤§ï¼Œä¹Ÿå°±æ˜¯å¾…æ’å…¥çš„blockå‰©ä½™ç©ºé—²ç©ºé—´ä¸è¶³ä»¥å®¹çº³è¿™ä¸ªmtræäº¤çš„æ—¥å¿—æ—¶ï¼Œlsnå¢é•¿çš„é‡å°±æ˜¯è¯¥mtrç”Ÿæˆçš„redoæ—¥å¿—å ç”¨çš„å­—èŠ‚æ•°åŠ ä¸Šé¢å¤–å ç”¨çš„log block headerå’Œlog block trailerçš„å­—èŠ‚æ•°ï¼Œå°±åƒè¿™æ ·ï¼šæˆ‘ä»¬å‡è®¾ä¸Šå›¾ä¸­mtr_2äº§ç”Ÿçš„redoæ—¥å¿—é‡ä¸º1000å­—èŠ‚ï¼Œä¸ºäº†å°†mtr_2äº§ç”Ÿçš„redoæ—¥å¿—å†™å…¥log bufferï¼Œæˆ‘ä»¬ä¸å¾—ä¸é¢å¤–å¤šåˆ†é…ä¸¤ä¸ªblockï¼Œæ‰€ä»¥lsnçš„å€¼éœ€è¦åœ¨8916çš„åŸºç¡€ä¸Šå¢åŠ 1000 + 12Ã—2 + 4 Ã— 2 = 1032ã€‚ ä»ä¸Šè¾¹çš„æè¿°ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯ä¸€ç»„ç”±mtrç”Ÿæˆçš„redoæ—¥å¿—éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„LSNå€¼ä¸å…¶å¯¹åº”ï¼ŒLSNå€¼è¶Šå°ï¼Œè¯´æ˜redoæ—¥å¿—äº§ç”Ÿçš„è¶Šæ—©ã€‚ 1.flushed_to_disk_lsnredoæ—¥å¿—æ˜¯é¦–å…ˆå†™åˆ°log bufferä¸­ï¼Œä¹‹åæ‰ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šçš„redoæ—¥å¿—æ–‡ä»¶ã€‚æ‰€ä»¥InnoDBæå‡ºäº†ä¸€ä¸ªç§°ä¹‹ä¸ºbuf_next_to_writeçš„å…¨å±€å˜é‡ï¼Œæ ‡è®°å½“å‰log bufferä¸­å·²ç»æœ‰å“ªäº›æ—¥å¿—è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºå°±æ˜¯è¿™æ ·ï¼š lsnæ˜¯è¡¨ç¤ºå½“å‰ç³»ç»Ÿä¸­å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œè¿™åŒ…æ‹¬äº†å†™åˆ°log bufferè€Œæ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜çš„æ—¥å¿—ï¼Œç›¸åº”çš„ï¼ŒInnoDBæå‡ºäº†ä¸€ä¸ªè¡¨ç¤ºåˆ·æ–°åˆ°ç£ç›˜ä¸­çš„redoæ—¥å¿—é‡çš„å…¨å±€å˜é‡ï¼Œç§°ä¹‹ä¸ºflushed_to_disk_lsnã€‚ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œè¯¥å˜é‡çš„å€¼å’Œåˆå§‹çš„lsnå€¼æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯8704ã€‚éšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œredoæ—¥å¿—è¢«ä¸æ–­å†™å…¥log bufferï¼Œä½†æ˜¯å¹¶ä¸ä¼šç«‹å³åˆ·æ–°åˆ°ç£ç›˜ï¼Œlsnçš„å€¼å°±å’Œflushed_to_disk_lsnçš„å€¼æ‹‰å¼€äº†å·®è·ã€‚æˆ‘ä»¬æ¨ç†ä¸€ä¸‹ï¼š ç³»ç»Ÿç¬¬ä¸€æ¬¡å¯åŠ¨åï¼Œå‘log bufferä¸­å†™å…¥äº†mtr_1ã€mtr_2ã€mtr_3è¿™ä¸‰ä¸ªmträº§ç”Ÿçš„redoæ—¥å¿—ï¼Œå‡è®¾è¿™ä¸‰ä¸ªmtrå¼€å§‹å’Œç»“æŸæ—¶å¯¹åº”çš„lsnå€¼åˆ†åˆ«æ˜¯ï¼š mtr_1ï¼š8716 ï½ 8916 mtr_2ï¼š8916 ï½ 9948 mtr_3ï¼š9948 ï½ 10000 æ­¤æ—¶çš„lsnå·²ç»å¢é•¿åˆ°äº†10000ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰åˆ·æ–°æ“ä½œï¼Œæ‰€ä»¥æ­¤æ—¶flushed_to_disk_lsnçš„å€¼ä»ä¸º8704ï¼Œå¦‚å›¾ï¼š éšåè¿›è¡Œå°†log bufferä¸­çš„blockåˆ·æ–°åˆ°redoæ—¥å¿—æ–‡ä»¶çš„æ“ä½œï¼Œå‡è®¾å°†mtr_1å’Œmtr_2çš„æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆflushed_to_disk_lsnå°±åº”è¯¥å¢é•¿mtr_1å’Œmtr_2å†™å…¥çš„æ—¥å¿—é‡ï¼Œæ‰€ä»¥flushed_to_disk_lsnçš„å€¼å¢é•¿åˆ°äº†9948ï¼Œå¦‚å›¾ï¼š ç»¼ä¸Šæ‰€è¿°ï¼Œå½“æœ‰æ–°çš„redoæ—¥å¿—å†™å…¥åˆ°log bufferæ—¶ï¼Œé¦–å…ˆlsnçš„å€¼ä¼šå¢é•¿ï¼Œä½†flushed_to_disk_lsnä¸å˜ï¼Œéšåéšç€ä¸æ–­æœ‰log bufferä¸­çš„æ—¥å¿—è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œflushed_to_disk_lsnçš„å€¼ä¹Ÿè·Ÿç€å¢é•¿ã€‚å¦‚æœä¸¤è€…çš„å€¼ç›¸åŒæ—¶ï¼Œè¯´æ˜log bufferä¸­çš„æ‰€æœ‰redoæ—¥å¿—éƒ½å·²ç»åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ã€‚ åº”ç”¨ç¨‹åºå‘ç£ç›˜å†™å…¥æ–‡ä»¶æ—¶å…¶å®æ˜¯å…ˆå†™åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºä¸­å»ï¼Œå¦‚æœæŸä¸ªå†™å…¥æ“ä½œè¦ç­‰åˆ°æ“ä½œç³»ç»Ÿç¡®è®¤å·²ç»å†™åˆ°ç£ç›˜æ—¶æ‰è¿”å›ï¼Œé‚£éœ€è¦è°ƒç”¨ä¸€ä¸‹æ“ä½œç³»ç»Ÿæä¾›çš„fsyncå‡½æ•°ã€‚å…¶å®åªæœ‰å½“ç³»ç»Ÿæ‰§è¡Œäº†fsyncå‡½æ•°åï¼Œflushed_to_disk_lsnçš„å€¼æ‰ä¼šè·Ÿç€å¢é•¿ï¼Œå½“ä»…ä»…æŠŠlog bufferä¸­çš„æ—¥å¿—å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å†²åŒºå´æ²¡æœ‰æ˜¾å¼çš„åˆ·æ–°åˆ°ç£ç›˜æ—¶ï¼Œå¦å¤–çš„ä¸€ä¸ªç§°ä¹‹ä¸ºwrite_lsnçš„å€¼è·Ÿç€å¢é•¿ã€‚ 2.lsnå€¼å’Œredoæ—¥å¿—æ–‡ä»¶åç§»é‡çš„å¯¹åº”å…³ç³»å› ä¸ºlsnçš„å€¼æ˜¯ä»£è¡¨ç³»ç»Ÿå†™å…¥çš„redoæ—¥å¿—é‡çš„ä¸€ä¸ªæ€»å’Œï¼Œä¸€ä¸ªmträ¸­äº§ç”Ÿå¤šå°‘æ—¥å¿—ï¼Œlsnçš„å€¼å°±å¢åŠ å¤šå°‘ï¼ˆå½“ç„¶æœ‰æ—¶å€™è¦åŠ ä¸Šlog block headerå’Œlog block trailerçš„å¤§å°ï¼‰ï¼Œè¿™æ ·mträº§ç”Ÿçš„æ—¥å¿—å†™åˆ°ç£ç›˜ä¸­æ—¶ï¼Œå¾ˆå®¹æ˜“è®¡ç®—æŸä¸€ä¸ªlsnå€¼åœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡ï¼Œå¦‚å›¾ï¼š åˆå§‹æ—¶çš„LSNå€¼æ˜¯8704ï¼Œå¯¹åº”æ–‡ä»¶åç§»é‡2048ï¼Œä¹‹åæ¯ä¸ªmtrå‘ç£ç›˜ä¸­å†™å…¥å¤šå°‘å­—èŠ‚æ—¥å¿—ï¼Œlsnçš„å€¼å°±å¢é•¿å¤šå°‘ã€‚ 3.flushé“¾è¡¨ä¸­çš„LSNä¸€ä¸ªmträ»£è¡¨ä¸€æ¬¡å¯¹åº•å±‚é¡µé¢çš„åŸå­è®¿é—®ï¼Œåœ¨è®¿é—®è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿä¸€ç»„ä¸å¯åˆ†å‰²çš„redoæ—¥å¿—ï¼Œåœ¨mtrç»“æŸæ—¶ï¼Œä¼šæŠŠè¿™ä¸€ç»„redoæ—¥å¿—å†™å…¥åˆ°log bufferä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨mtrç»“æŸæ—¶è¿˜æœ‰ä¸€ä»¶éå¸¸é‡è¦çš„äº‹æƒ…è¦åšï¼Œå°±æ˜¯æŠŠåœ¨mtræ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¿®æ”¹è¿‡çš„é¡µé¢åŠ å…¥åˆ°Buffer Poolçš„flushé“¾è¡¨ã€‚ å½“ç¬¬ä¸€æ¬¡ä¿®æ”¹æŸä¸ªç¼“å­˜åœ¨Buffer Poolä¸­çš„é¡µé¢æ—¶ï¼Œå°±ä¼šæŠŠè¿™ä¸ªé¡µé¢å¯¹åº”çš„æ§åˆ¶å—æ’å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ï¼Œä¹‹åå†ä¿®æ”¹è¯¥é¡µé¢æ—¶ç”±äºå®ƒå·²ç»åœ¨flushé“¾è¡¨ä¸­äº†ï¼Œå°±ä¸å†æ¬¡æ’å…¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´flushé“¾è¡¨ä¸­çš„è„é¡µæ˜¯æŒ‰ç…§é¡µé¢çš„ç¬¬ä¸€æ¬¡ä¿®æ”¹æ—¶é—´ä»å¤§åˆ°å°è¿›è¡Œæ’åºçš„ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šåœ¨ç¼“å­˜é¡µå¯¹åº”çš„æ§åˆ¶å—ä¸­è®°å½•ä¸¤ä¸ªå…³äºé¡µé¢ä½•æ—¶ä¿®æ”¹çš„å±æ€§ï¼š oldest_modificationï¼šå¦‚æœæŸä¸ªé¡µé¢è¢«åŠ è½½åˆ°Buffer Poolåè¿›è¡Œç¬¬ä¸€æ¬¡ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±å°†ä¿®æ”¹è¯¥é¡µé¢çš„mtrå¼€å§‹æ—¶å¯¹åº”çš„lsnå€¼å†™å…¥è¿™ä¸ªå±æ€§ã€‚ newest_modificationï¼šæ¯ä¿®æ”¹ä¸€æ¬¡é¡µé¢ï¼Œéƒ½ä¼šå°†ä¿®æ”¹è¯¥é¡µé¢çš„mtrç»“æŸæ—¶å¯¹åº”çš„lsnå€¼å†™å…¥è¿™ä¸ªå±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´è¯¥å±æ€§è¡¨ç¤ºé¡µé¢æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹åå¯¹åº”çš„ç³»ç»Ÿlsnå€¼ã€‚ æ¥ç€ä¸Šè¾¹flushed_to_disk_lsnçš„ä¾‹å­çœ‹ä¸€ä¸‹ï¼š å‡è®¾mtr_1æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹äº†é¡µaï¼Œé‚£ä¹ˆåœ¨mtr_1æ‰§è¡Œç»“æŸæ—¶ï¼Œå°±ä¼šå°†é¡µaå¯¹åº”çš„æ§åˆ¶å—åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ã€‚å¹¶ä¸”å°†mtr_1å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8716å†™å…¥é¡µaå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_1ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8916å†™å…¥é¡µaå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼ˆoldest_modificationç¼©å†™æˆäº†o_mï¼Œnewest_modificationç¼©å†™æˆäº†n_mï¼‰ï¼š æ¥ç€å‡è®¾mtr_2æ‰§è¡Œè¿‡ç¨‹ä¸­åˆä¿®æ”¹äº†é¡µbå’Œé¡µcä¸¤ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆåœ¨mtr_2æ‰§è¡Œç»“æŸæ—¶ï¼Œå°±ä¼šå°†é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—éƒ½åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨ã€‚å¹¶ä¸”å°†mtr_2å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯8916å†™å…¥é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_2ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯9948å†™å…¥é¡µbå’Œé¡µcå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼šä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯æ¬¡æ–°æ’å…¥åˆ°flushé“¾è¡¨ä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯è¢«æ”¾åœ¨äº†å¤´éƒ¨ï¼Œä¹Ÿå°±æ˜¯è¯´flushé“¾è¡¨ä¸­å‰è¾¹çš„è„é¡µä¿®æ”¹çš„æ—¶é—´æ¯”è¾ƒæ™šï¼Œåè¾¹çš„è„é¡µä¿®æ”¹æ—¶é—´æ¯”è¾ƒæ—©ã€‚ æ¥ç€å‡è®¾mtr_3æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹äº†é¡µbå’Œé¡µdï¼Œä¸è¿‡é¡µbä¹‹å‰å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥å®ƒå¯¹åº”çš„æ§åˆ¶å—å·²ç»è¢«æ’å…¥åˆ°äº†flushé“¾è¡¨ï¼Œæ‰€ä»¥åœ¨mtr_3æ‰§è¡Œç»“æŸæ—¶ï¼Œåªéœ€è¦å°†é¡µdå¯¹åº”çš„æ§åˆ¶å—éƒ½åŠ å…¥åˆ°flushé“¾è¡¨çš„å¤´éƒ¨å³å¯ã€‚æ‰€ä»¥éœ€è¦å°†mtr_3å¼€å§‹æ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯9948å†™å…¥é¡µdå¯¹åº”çš„æ§åˆ¶å—çš„oldest_modificationå±æ€§ä¸­ï¼ŒæŠŠmtr_3ç»“æŸæ—¶å¯¹åº”çš„lsnï¼Œä¹Ÿå°±æ˜¯10000å†™å…¥é¡µdå¯¹åº”çš„æ§åˆ¶å—çš„newest_modificationå±æ€§ä¸­ã€‚å¦å¤–ï¼Œç”±äºé¡µbåœ¨mtr_3æ‰§è¡Œè¿‡ç¨‹ä¸­åˆå‘ç”Ÿäº†ä¸€æ¬¡ä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦æ›´æ–°é¡µbå¯¹åº”çš„æ§åˆ¶å—ä¸­newest_modificationçš„å€¼ä¸º10000ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼š æ€»ç»“ä¸€ä¸‹ä¸Šè¾¹è¯´çš„ï¼Œå°±æ˜¯ï¼šflushé“¾è¡¨ä¸­çš„è„é¡µæŒ‰ç…§ä¿®æ”¹å‘ç”Ÿçš„æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§oldest_modificationä»£è¡¨çš„LSNå€¼è¿›è¡Œæ’åºï¼Œè¢«å¤šæ¬¡æ›´æ–°çš„é¡µé¢ä¸ä¼šé‡å¤æ’å…¥åˆ°flushé“¾è¡¨ä¸­ï¼Œä½†æ˜¯ä¼šæ›´æ–°newest_modificationå±æ€§çš„å€¼ã€‚ ä¸ƒï¼Œcheckpointredoæ—¥å¿—æ–‡ä»¶ç»„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬ä¸å¾—ä¸é€‰æ‹©å¾ªç¯ä½¿ç”¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„æ–‡ä»¶ï¼Œä½†æ˜¯è¿™ä¼šé€ æˆæœ€åå†™çš„redoæ—¥å¿—ä¸æœ€å¼€å§‹å†™çš„redoæ—¥å¿—è¿½å°¾ï¼Œè¿™æ—¶åº”è¯¥æƒ³åˆ°ï¼šredoæ—¥å¿—åªæ˜¯ä¸ºäº†ç³»ç»Ÿå´©æºƒåæ¢å¤è„é¡µç”¨çš„ï¼Œå¦‚æœå¯¹åº”çš„è„é¡µå·²ç»åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿ç°åœ¨ç³»ç»Ÿå´©æºƒï¼Œé‚£ä¹ˆåœ¨é‡å¯åä¹Ÿç”¨ä¸ç€ä½¿ç”¨redoæ—¥å¿—æ¢å¤è¯¥é¡µé¢äº†ï¼Œæ‰€ä»¥è¯¥redoæ—¥å¿—ä¹Ÿå°±æ²¡æœ‰å­˜åœ¨çš„å¿…è¦äº†ï¼Œé‚£ä¹ˆå®ƒå ç”¨çš„ç£ç›˜ç©ºé—´å°±å¯ä»¥è¢«åç»­çš„redoæ—¥å¿—æ‰€é‡ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šåˆ¤æ–­æŸäº›redoæ—¥å¿—å ç”¨çš„ç£ç›˜ç©ºé—´æ˜¯å¦å¯ä»¥è¦†ç›–çš„ä¾æ®å°±æ˜¯å®ƒå¯¹åº”çš„è„é¡µæ˜¯å¦å·²ç»åˆ·æ–°åˆ°ç£ç›˜é‡Œã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å‰è¾¹çš„é‚£ä¸ªä¾‹å­ï¼š å¦‚å›¾ï¼Œè™½ç„¶mtr_1å’Œmtr_2ç”Ÿæˆçš„redoæ—¥å¿—éƒ½å·²ç»è¢«å†™åˆ°äº†ç£ç›˜ä¸Šï¼Œä½†æ˜¯å®ƒä»¬ä¿®æ”¹çš„è„é¡µä»ç„¶ç•™åœ¨Buffer Poolä¸­ï¼Œæ‰€ä»¥å®ƒä»¬ç”Ÿæˆçš„redoæ—¥å¿—åœ¨ç£ç›˜ä¸Šçš„ç©ºé—´æ˜¯ä¸å¯ä»¥è¢«è¦†ç›–çš„ã€‚ä¹‹åéšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œå¦‚æœé¡µaè¢«åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„æ§åˆ¶å—å°±ä¼šä»flushé“¾è¡¨ä¸­ç§»é™¤ï¼Œå°±åƒè¿™æ ·å­ï¼š è¿™æ ·mtr_1ç”Ÿæˆçš„redoæ—¥å¿—å°±æ²¡æœ‰ç”¨äº†ï¼Œå®ƒä»¬å ç”¨çš„ç£ç›˜ç©ºé—´å°±å¯ä»¥è¢«è¦†ç›–æ‰äº†ã€‚InnoDBæå‡ºäº†ä¸€ä¸ªå…¨å±€å˜é‡checkpoint_lsnæ¥ä»£è¡¨å½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—æ€»é‡æ˜¯å¤šå°‘ï¼Œè¿™ä¸ªå˜é‡åˆå§‹å€¼ä¹Ÿæ˜¯8704ã€‚ æ¯”æ–¹è¯´ç°åœ¨é¡µaè¢«åˆ·æ–°åˆ°äº†ç£ç›˜ï¼Œmtr_1ç”Ÿæˆçš„redoæ—¥å¿—å°±å¯ä»¥è¢«è¦†ç›–äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€ä¸ªå¢åŠ checkpoint_lsnçš„æ“ä½œï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºåšä¸€æ¬¡checkpointã€‚åšä¸€æ¬¡checkpointå…¶å®å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š æ­¥éª¤ä¸€ï¼šè®¡ç®—ä¸€ä¸‹å½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—å¯¹åº”çš„lsnå€¼æœ€å¤§æ˜¯å¤šå°‘ã€‚redoæ—¥å¿—å¯ä»¥è¢«è¦†ç›–ï¼Œæ„å‘³ç€å®ƒå¯¹åº”çš„è„é¡µè¢«åˆ·åˆ°äº†ç£ç›˜ï¼Œåªè¦æˆ‘ä»¬è®¡ç®—å‡ºå½“å‰ç³»ç»Ÿä¸­è¢«æœ€æ—©ä¿®æ”¹çš„è„é¡µå¯¹åº”çš„oldest_modificationå€¼ï¼Œé‚£å‡¡æ˜¯åœ¨ç³»ç»Ÿlsnå€¼å°äºè¯¥èŠ‚ç‚¹çš„oldest_modificationå€¼æ—¶äº§ç”Ÿçš„redoæ—¥å¿—éƒ½æ˜¯å¯ä»¥è¢«è¦†ç›–æ‰çš„ï¼Œæˆ‘ä»¬å°±æŠŠè¯¥è„é¡µçš„oldest_modificationèµ‹å€¼ç»™checkpoint_lsnã€‚æ¯”æ–¹è¯´å½“å‰ç³»ç»Ÿä¸­é¡µaå·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆflushé“¾è¡¨çš„å°¾èŠ‚ç‚¹å°±æ˜¯é¡µcï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯å½“å‰ç³»ç»Ÿä¸­æœ€æ—©ä¿®æ”¹çš„è„é¡µäº†ï¼Œå®ƒçš„oldest_modificationå€¼ä¸º8916ï¼Œæˆ‘ä»¬å°±æŠŠ8916èµ‹å€¼ç»™checkpoint_lsnï¼ˆä¹Ÿå°±æ˜¯è¯´åœ¨redoæ—¥å¿—å¯¹åº”çš„lsnå€¼å°äº8916æ—¶å°±å¯ä»¥è¢«è¦†ç›–æ‰ï¼‰ã€‚ æ­¥éª¤äºŒï¼šå°†checkpoint_lsnå’Œå¯¹åº”çš„redoæ—¥å¿—æ–‡ä»¶ç»„åç§»é‡ä»¥åŠæ­¤æ¬¡checkpintçš„ç¼–å·å†™åˆ°æ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ï¼ˆå°±æ˜¯checkpoint1æˆ–è€…checkpoint2ï¼‰ä¸­ã€‚InnoDBç»´æŠ¤äº†ä¸€ä¸ªç›®å‰ç³»ç»Ÿåšäº†å¤šå°‘æ¬¡checkpointçš„å˜é‡checkpoint_noï¼Œæ¯åšä¸€æ¬¡checkpointï¼Œè¯¥å˜é‡çš„å€¼å°±åŠ 1ã€‚æˆ‘ä»¬å‰è¾¹è¯´è¿‡è®¡ç®—ä¸€ä¸ªlsnå€¼å¯¹åº”çš„redoæ—¥å¿—æ–‡ä»¶ç»„åç§»é‡æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œæ‰€ä»¥å¯ä»¥è®¡ç®—å¾—åˆ°è¯¥checkpoint_lsnåœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­å¯¹åº”çš„åç§»é‡checkpoint_offsetï¼Œç„¶åæŠŠè¿™ä¸‰ä¸ªå€¼éƒ½å†™åˆ°redoæ—¥å¿—æ–‡ä»¶ç»„çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚æˆ‘ä»¬è¯´è¿‡ï¼Œæ¯ä¸€ä¸ªredoæ—¥å¿—æ–‡ä»¶éƒ½æœ‰2048ä¸ªå­—èŠ‚çš„ç®¡ç†ä¿¡æ¯ï¼Œä½†æ˜¯ä¸Šè¿°å…³äºcheckpointçš„ä¿¡æ¯åªä¼šè¢«å†™åˆ°æ—¥å¿—æ–‡ä»¶ç»„çš„ç¬¬ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚ä¸è¿‡æˆ‘ä»¬æ˜¯å­˜å‚¨åˆ°checkpoint1ä¸­è¿˜æ˜¯checkpoint2ä¸­å‘¢ï¼ŸInnoDBè§„å®šï¼Œå½“checkpoint_noçš„å€¼æ˜¯å¶æ•°æ—¶ï¼Œå°±å†™åˆ°checkpoint1ä¸­ï¼Œæ˜¯å¥‡æ•°æ—¶ï¼Œå°±å†™åˆ°checkpoint2ä¸­ã€‚ è®°å½•å®Œcheckpointçš„ä¿¡æ¯ä¹‹åï¼Œredoæ—¥å¿—æ–‡ä»¶ç»„ä¸­å„ä¸ªlsnå€¼çš„å…³ç³»å°±åƒè¿™æ ·ï¼š 1.æ‰¹é‡ä»flushé“¾è¡¨ä¸­åˆ·å‡ºè„é¡µä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯åå°çš„çº¿ç¨‹åœ¨å¯¹LRUé“¾è¡¨å’Œflushé“¾è¡¨è¿›è¡Œåˆ·è„æ“ä½œï¼Œè¿™ä¸»è¦å› ä¸ºåˆ·è„æ“ä½œæ¯”è¾ƒæ…¢ï¼Œä¸æƒ³å½±å“ç”¨æˆ·çº¿ç¨‹å¤„ç†è¯·æ±‚ã€‚ä½†æ˜¯å¦‚æœå½“å‰ç³»ç»Ÿä¿®æ”¹é¡µé¢çš„æ“ä½œååˆ†é¢‘ç¹ï¼Œè¿™æ ·å°±å¯¼è‡´å†™æ—¥å¿—æ“ä½œååˆ†é¢‘ç¹ï¼Œç³»ç»Ÿlsnå€¼å¢é•¿è¿‡å¿«ã€‚å¦‚æœåå°çš„åˆ·è„æ“ä½œä¸èƒ½å°†è„é¡µåˆ·å‡ºï¼Œé‚£ä¹ˆç³»ç»Ÿæ— æ³•åŠæ—¶åšcheckpointï¼Œå¯èƒ½å°±éœ€è¦ç”¨æˆ·çº¿ç¨‹åŒæ­¥çš„ä»flushé“¾è¡¨ä¸­æŠŠé‚£äº›æœ€æ—©ä¿®æ”¹çš„è„é¡µï¼ˆoldest_modificationæœ€å°çš„è„é¡µï¼‰åˆ·æ–°åˆ°ç£ç›˜ï¼Œè¿™æ ·è¿™äº›è„é¡µå¯¹åº”çš„redoæ—¥å¿—å°±æ²¡ç”¨äº†ï¼Œç„¶åå°±å¯ä»¥å»åšcheckpointäº†ã€‚ 2.æŸ¥çœ‹ç³»ç»Ÿä¸­çš„å„ç§LSNå€¼æˆ‘ä»¬å¯ä»¥ä½¿ç”¨SHOW ENGINE INNODB STATUSå‘½ä»¤æŸ¥çœ‹å½“å‰InnoDBå­˜å‚¨å¼•æ“ä¸­çš„å„ç§LSNå€¼çš„æƒ…å†µï¼Œæ¯”å¦‚ï¼š 12345678910111213mysql&gt; SHOW ENGINE INNODB STATUS\\G(...çœç•¥å‰è¾¹çš„è®¸å¤šçŠ¶æ€)LOG---Log sequence number 124476971Log flushed up to 124099769Pages flushed up to 124052503Last checkpoint at 1240524940 pending log flushes, 0 pending chkp writes24 log i/o&#x27;s done, 2.00 log i/o&#x27;s/second----------------------(...çœç•¥åè¾¹çš„è®¸å¤šçŠ¶æ€) å…¶ä¸­ï¼š Log sequence numberï¼šä»£è¡¨ç³»ç»Ÿä¸­çš„lsnå€¼ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç³»ç»Ÿå·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼ŒåŒ…æ‹¬å†™å…¥log bufferä¸­çš„æ—¥å¿—ã€‚ Log flushed up toï¼šä»£è¡¨flushed_to_disk_lsnçš„å€¼ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç³»ç»Ÿå·²ç»å†™å…¥ç£ç›˜çš„redoæ—¥å¿—é‡ã€‚ Pages flushed up toï¼šä»£è¡¨flushé“¾è¡¨ä¸­è¢«æœ€æ—©ä¿®æ”¹çš„é‚£ä¸ªé¡µé¢å¯¹åº”çš„oldest_modificationå±æ€§å€¼ã€‚ Last checkpoint atï¼šå½“å‰ç³»ç»Ÿçš„checkpoint_lsnå€¼ã€‚ 3.innodb_flush_log_at_trx_commitçš„ç”¨æ³•ä¸ºäº†ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œç”¨æˆ·çº¿ç¨‹åœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†è¯¥äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ‰€æœ‰redoæ—¥å¿—éƒ½åˆ·æ–°åˆ°ç£ç›˜ä¸Šã€‚è¿™ä¸€æ¡è¦æ±‚å¤ªç‹ äº†ï¼Œä¼šå¾ˆæ˜æ˜¾çš„é™ä½æ•°æ®åº“æ€§èƒ½ã€‚å¦‚æœå¯¹äº‹åŠ¡çš„æŒä¹…æ€§è¦æ±‚ä¸æ˜¯é‚£ä¹ˆå¼ºçƒˆçš„è¯ï¼Œå¯ä»¥é€‰æ‹©ä¿®æ”¹ä¸€ä¸ªç§°ä¸ºinnodb_flush_log_at_trx_commitçš„ç³»ç»Ÿå˜é‡çš„å€¼ï¼Œè¯¥å˜é‡æœ‰3ä¸ªå¯é€‰çš„å€¼ï¼š 0ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º0æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶ä¸ç«‹å³å‘ç£ç›˜ä¸­åŒæ­¥redoæ—¥å¿—ï¼Œè¿™ä¸ªä»»åŠ¡æ˜¯äº¤ç»™åå°çº¿ç¨‹åšçš„ã€‚è¿™æ ·å¾ˆæ˜æ˜¾ä¼šåŠ å¿«è¯·æ±‚å¤„ç†é€Ÿåº¦ï¼Œä½†æ˜¯å¦‚æœäº‹åŠ¡æäº¤åæœåŠ¡å™¨æŒ‚äº†ï¼Œåå°çº¿ç¨‹æ²¡æœ‰åŠæ—¶å°†redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆè¯¥äº‹åŠ¡å¯¹é¡µé¢çš„ä¿®æ”¹ä¼šä¸¢å¤±ã€‚ 1ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º1æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†redoæ—¥å¿—åŒæ­¥åˆ°ç£ç›˜ï¼Œå¯ä»¥ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚1ä¹Ÿæ˜¯innodb_flush_log_at_trx_commitçš„é»˜è®¤å€¼ã€‚ 2ï¼šå½“è¯¥ç³»ç»Ÿå˜é‡å€¼ä¸º2æ—¶ï¼Œè¡¨ç¤ºåœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦å°†redoæ—¥å¿—å†™åˆ°æ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºä¸­ï¼Œä½†å¹¶ä¸éœ€è¦ä¿è¯å°†æ—¥å¿—çœŸæ­£çš„åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™ç§æƒ…å†µä¸‹å¦‚æœæ•°æ®åº“æŒ‚äº†ï¼Œæ“ä½œç³»ç»Ÿæ²¡æŒ‚çš„è¯ï¼Œäº‹åŠ¡çš„æŒä¹…æ€§è¿˜æ˜¯å¯ä»¥ä¿è¯çš„ï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿä¹ŸæŒ‚äº†çš„è¯ï¼Œé‚£å°±ä¸èƒ½ä¿è¯æŒä¹…æ€§äº†ã€‚ å…«ï¼Œå´©æºƒæ¢å¤åœ¨æœåŠ¡å™¨ä¸æŒ‚çš„æƒ…å†µä¸‹ï¼Œredoæ—¥å¿—ä¸ä»…æ²¡ç”¨ï¼Œåè€Œè®©æ€§èƒ½å˜å¾—æ›´å·®ã€‚ä½†æ˜¯ä¸‡ä¸€æ•°æ®åº“æŒ‚äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨é‡å¯æ—¶æ ¹æ®redoæ—¥å¿—ä¸­çš„è®°å½•å°±å¯ä»¥å°†é¡µé¢æ¢å¤åˆ°ç³»ç»Ÿå´©æºƒå‰çš„çŠ¶æ€ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å¤§è‡´çœ‹ä¸€ä¸‹æ¢å¤è¿‡ç¨‹ã€‚ 1.ç¡®å®šæ¢å¤çš„èµ·ç‚¹checkpoint_lsnä¹‹å‰çš„redoæ—¥å¿—éƒ½å¯ä»¥è¢«è¦†ç›–ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›redoæ—¥å¿—å¯¹åº”çš„è„é¡µéƒ½å·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­äº†ï¼Œæ—¢ç„¶å®ƒä»¬å·²ç»è¢«åˆ·ç›˜ï¼Œæˆ‘ä»¬å°±æ²¡å¿…è¦æ¢å¤å®ƒä»¬äº†ã€‚å¯¹äºcheckpoint_lsnä¹‹åçš„redoæ—¥å¿—ï¼Œå®ƒä»¬å¯¹åº”çš„è„é¡µå¯èƒ½æ²¡è¢«åˆ·ç›˜ï¼Œä¹Ÿå¯èƒ½è¢«åˆ·ç›˜äº†ï¼Œæˆ‘ä»¬ä¸èƒ½ç¡®å®šï¼Œæ‰€ä»¥éœ€è¦ä»checkpoint_lsnå¼€å§‹è¯»å–redoæ—¥å¿—æ¥æ¢å¤é¡µé¢ã€‚ å½“ç„¶ï¼Œredoæ—¥å¿—æ–‡ä»¶ç»„çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­æœ‰ä¸¤ä¸ªblockéƒ½å­˜å‚¨äº†checkpoint_lsnçš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å½“ç„¶æ˜¯è¦é€‰å–æœ€è¿‘å‘ç”Ÿçš„é‚£æ¬¡checkpointçš„ä¿¡æ¯ã€‚è¡¡é‡checkpointå‘ç”Ÿæ—¶é—´æ—©æ™šçš„ä¿¡æ¯å°±æ˜¯æ‰€è°“çš„checkpoint_noï¼Œåªè¦æŠŠcheckpoint1å’Œcheckpoint2è¿™ä¸¤ä¸ªblockä¸­çš„checkpoint_noå€¼è¯»å‡ºæ¥æ¯”ä¸€ä¸‹å¤§å°ï¼Œå“ªä¸ªçš„checkpoint_noå€¼æ›´å¤§ï¼Œè¯´æ˜å“ªä¸ªblockå­˜å‚¨çš„å°±æ˜¯æœ€è¿‘çš„ä¸€æ¬¡checkpointä¿¡æ¯ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½æ‹¿åˆ°æœ€è¿‘å‘ç”Ÿçš„checkpointå¯¹åº”çš„checkpoint_lsnå€¼ä»¥åŠå®ƒåœ¨redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­çš„åç§»é‡checkpoint_offsetã€‚ 2.ç¡®å®šæ¢å¤çš„ç»ˆç‚¹redoæ—¥å¿—æ¢å¤çš„èµ·ç‚¹ç¡®å®šäº†ï¼Œé‚£ç»ˆç‚¹æ˜¯å“ªä¸ªå‘¢ï¼Ÿè¿™ä¸ªè¿˜å¾—ä»blockçš„ç»“æ„è¯´èµ·ã€‚åœ¨å†™redoæ—¥å¿—çš„æ—¶å€™éƒ½æ˜¯é¡ºåºå†™çš„ï¼Œå†™æ»¡äº†ä¸€ä¸ªblockä¹‹åä¼šå†å¾€ä¸‹ä¸€ä¸ªblockä¸­å†™ã€‚ æ™®é€šblockçš„log block headeréƒ¨åˆ†æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºLOG_BLOCK_HDR_DATA_LENçš„å±æ€§ï¼Œè¯¥å±æ€§å€¼è®°å½•äº†å½“å‰blocké‡Œä½¿ç”¨äº†å¤šå°‘å­—èŠ‚çš„ç©ºé—´ã€‚å¯¹äºè¢«å¡«æ»¡çš„blockæ¥è¯´ï¼Œè¯¥å€¼æ°¸è¿œä¸º512ã€‚å¦‚æœè¯¥å±æ€§çš„å€¼ä¸ä¸º512ï¼Œé‚£ä¹ˆå°±æ˜¯å®ƒäº†ï¼Œå®ƒå°±æ˜¯æ­¤æ¬¡å´©æºƒæ¢å¤ä¸­éœ€è¦æ‰«æçš„æœ€åä¸€ä¸ªblockã€‚ 3.æ€ä¹ˆæ¢å¤ç¡®å®šäº†éœ€è¦æ‰«æå“ªäº›redoæ—¥å¿—è¿›è¡Œå´©æºƒæ¢å¤ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆè¿›è¡Œæ¢å¤äº†ã€‚å‡è®¾ç°åœ¨çš„redoæ—¥å¿—æ–‡ä»¶ä¸­æœ‰5æ¡redoæ—¥å¿—ï¼Œå¦‚å›¾ï¼š ç”±äºredo 0åœ¨checkpoint_lsnåå‰è¾¹ï¼Œæ¢å¤æ—¶å¯ä»¥ä¸ç®¡å®ƒã€‚ç°åœ¨å¯ä»¥æŒ‰ç…§redoæ—¥å¿—çš„é¡ºåºä¾æ¬¡æ‰«æcheckpoint_lsnä¹‹åçš„å„æ¡redoæ—¥å¿—ï¼ŒæŒ‰ç…§æ—¥å¿—ä¸­è®°è½½çš„å†…å®¹å°†å¯¹åº”çš„é¡µé¢æ¢å¤å‡ºæ¥ã€‚è¿™æ ·æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä¸è¿‡InnoDBè¿˜æ˜¯æƒ³äº†ä¸€äº›åŠæ³•åŠ å¿«è¿™ä¸ªæ¢å¤çš„è¿‡ç¨‹ï¼š ä½¿ç”¨å“ˆå¸Œè¡¨æ ¹æ®redoæ—¥å¿—çš„space IDå’Œpage numberå±æ€§è®¡ç®—å‡ºæ•£åˆ—å€¼ï¼ŒæŠŠspace IDå’Œpage numberç›¸åŒçš„redoæ—¥å¿—æ”¾åˆ°å“ˆå¸Œè¡¨çš„åŒä¸€ä¸ªæ§½é‡Œï¼Œå¦‚æœæœ‰å¤šä¸ªspace IDå’Œpage numberéƒ½ç›¸åŒçš„redoæ—¥å¿—ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´ä½¿ç”¨é“¾è¡¨è¿æ¥èµ·æ¥ï¼ŒæŒ‰ç…§ç”Ÿæˆçš„å…ˆåé¡ºåºé“¾æ¥èµ·æ¥çš„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼šä¹‹åå°±å¯ä»¥éå†å“ˆå¸Œè¡¨ï¼Œå› ä¸ºå¯¹åŒä¸€ä¸ªé¡µé¢è¿›è¡Œä¿®æ”¹çš„redoæ—¥å¿—éƒ½æ”¾åœ¨äº†ä¸€ä¸ªæ§½é‡Œï¼Œæ‰€ä»¥å¯ä»¥ä¸€æ¬¡æ€§å°†ä¸€ä¸ªé¡µé¢ä¿®å¤å¥½ï¼ˆé¿å…äº†å¾ˆå¤šè¯»å–é¡µé¢çš„éšæœºIO)ï¼Œè¿™æ ·å¯ä»¥åŠ å¿«æ¢å¤é€Ÿåº¦ã€‚å¦å¤–éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼ŒåŒä¸€ä¸ªé¡µé¢çš„redoæ—¥å¿—æ˜¯æŒ‰ç…§ç”Ÿæˆæ—¶é—´é¡ºåºè¿›è¡Œæ’åºçš„ï¼Œæ‰€ä»¥æ¢å¤çš„æ—¶å€™ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºè¿›è¡Œæ¢å¤ï¼Œå¦‚æœä¸æŒ‰ç…§ç”Ÿæˆæ—¶é—´é¡ºåºè¿›è¡Œæ’åºçš„è¯ï¼Œé‚£ä¹ˆå¯èƒ½å‡ºç°é”™è¯¯ã€‚æ¯”å¦‚åŸå…ˆçš„ä¿®æ”¹æ“ä½œæ˜¯å…ˆæ’å…¥ä¸€æ¡è®°å½•ï¼Œå†åˆ é™¤è¯¥æ¡è®°å½•ï¼Œå¦‚æœæ¢å¤æ—¶ä¸æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¥ï¼Œå°±å¯èƒ½å˜æˆå…ˆåˆ é™¤ä¸€æ¡è®°å½•ï¼Œå†æ’å…¥ä¸€æ¡è®°å½•ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚ è·³è¿‡å·²ç»åˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢checkpoint_lsnä¹‹å‰çš„redoæ—¥å¿—å¯¹åº”çš„è„é¡µç¡®å®šéƒ½å·²ç»åˆ·åˆ°ç£ç›˜äº†ï¼Œä½†æ˜¯checkpoint_lsnä¹‹åçš„redoæ—¥å¿—æˆ‘ä»¬ä¸èƒ½ç¡®å®šæ˜¯å¦å·²ç»åˆ·åˆ°ç£ç›˜ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨æœ€è¿‘åšçš„ä¸€æ¬¡checkpointåï¼Œå¯èƒ½åå°çº¿ç¨‹åˆä¸æ–­çš„ä»LRUé“¾è¡¨å’Œflushé“¾è¡¨ä¸­å°†ä¸€äº›è„é¡µåˆ·å‡ºBuffer Poolã€‚è¿™äº›åœ¨checkpoint_lsnä¹‹åçš„redoæ—¥å¿—ï¼Œå¦‚æœå®ƒä»¬å¯¹åº”çš„è„é¡µåœ¨å´©æºƒå‘ç”Ÿæ—¶å·²ç»åˆ·æ–°åˆ°ç£ç›˜ï¼Œé‚£åœ¨æ¢å¤æ—¶ä¹Ÿå°±æ²¡æœ‰å¿…è¦æ ¹æ®redoæ—¥å¿—çš„å†…å®¹ä¿®æ”¹è¯¥é¡µé¢äº†ã€‚é‚£åœ¨æ¢å¤æ—¶æ€ä¹ˆçŸ¥é“æŸä¸ªredoæ—¥å¿—å¯¹åº”çš„è„é¡µæ˜¯å¦åœ¨å´©æºƒå‘ç”Ÿæ—¶å·²ç»åˆ·æ–°åˆ°ç£ç›˜äº†å‘¢ï¼Ÿè¿™è¿˜å¾—ä»é¡µé¢çš„ç»“æ„è¯´èµ·ï¼Œæ¯ä¸ªé¡µé¢éƒ½æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºFile Headerçš„éƒ¨åˆ†ï¼Œåœ¨File Headeré‡Œæœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºFIL_PAGE_LSNçš„å±æ€§ï¼Œè¯¥å±æ€§è®°è½½äº†æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹é¡µé¢æ—¶å¯¹åº”çš„lsnå€¼ï¼ˆå…¶å®å°±æ˜¯é¡µé¢æ§åˆ¶å—ä¸­çš„newest_modificationå€¼ï¼‰ã€‚å¦‚æœåœ¨åšäº†æŸæ¬¡checkpointä¹‹åæœ‰è„é¡µè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œé‚£ä¹ˆè¯¥é¡µå¯¹åº”çš„FIL_PAGE_LSNä»£è¡¨çš„lsnå€¼è‚¯å®šå¤§äºcheckpoint_lsnçš„å€¼ï¼Œå‡¡æ˜¯ç¬¦åˆè¿™ç§æƒ…å†µçš„é¡µé¢å°±ä¸éœ€è¦é‡å¤æ‰§è¡Œlsnå€¼å°äºFIL_PAGE_LSNçš„redoæ—¥å¿—äº†ï¼Œæ‰€ä»¥æ›´è¿›ä¸€æ­¥æå‡äº†å´©æºƒæ¢å¤çš„é€Ÿåº¦ã€‚ ä¹ï¼ŒLOG_BLOCK_HDR_NOæ˜¯å¦‚ä½•è®¡ç®—çš„å¯¹äºå®é™…å­˜å‚¨redoæ—¥å¿—çš„æ™®é€šçš„log blockæ¥è¯´ï¼Œåœ¨log block headerå¤„æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºLOG_BLOCK_HDR_NOçš„å±æ€§ï¼Œæˆ‘ä»¬è¯´è¿™ä¸ªå±æ€§ä»£è¡¨ä¸€ä¸ªå”¯ä¸€çš„æ ‡å·ã€‚è¿™ä¸ªå±æ€§æ˜¯åˆæ¬¡ä½¿ç”¨è¯¥blockæ—¶åˆ†é…çš„ï¼Œè·Ÿå½“æ—¶çš„ç³»ç»Ÿlsnå€¼æœ‰å…³ã€‚ä½¿ç”¨ä¸‹è¾¹çš„å…¬å¼è®¡ç®—è¯¥blockçš„LOG_BLOCK_HDR_NOå€¼ï¼š 1((lsn / 512) &amp; 0x3FFFFFFFUL) + 1 ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œ0x3FFFFFFFULå¯¹åº”çš„äºŒè¿›åˆ¶æ•°çš„å‰2ä½ä¸º0ï¼Œå30ä½çš„å€¼éƒ½ä¸º1ã€‚ä¸€ä¸ªäºŒè¿›åˆ¶ä½ä¸0åšä¸è¿ç®—ï¼ˆ&amp;ï¼‰çš„ç»“æœè‚¯å®šæ˜¯0ï¼Œä¸€ä¸ªäºŒè¿›åˆ¶ä½ä¸1åšä¸è¿ç®—ï¼ˆ&amp;ï¼‰çš„ç»“æœå°±æ˜¯åŸå€¼ã€‚è®©ä¸€ä¸ªæ•°å’Œ0x3FFFFFFFULåšä¸è¿ç®—çš„æ„æ€å°±æ˜¯è¦å°†è¯¥å€¼çš„å‰2ä¸ªæ¯”ç‰¹ä½çš„å€¼ç½®ä¸º0ï¼Œè¿™æ ·è¯¥å€¼å°±è‚¯å®šå°äºæˆ–ç­‰äº0x3FFFFFFFULäº†ã€‚è¿™ä¹Ÿå°±è¯´æ˜äº†ï¼Œä¸è®ºlsnå¤šå¤§ï¼Œ((lsn / 512) &amp; 0x3FFFFFFFUL)çš„å€¼è‚¯å®šåœ¨0``0x3FFFFFFFULä¹‹é—´ï¼Œå†åŠ 1çš„è¯è‚¯å®šåœ¨1``0x40000000ULä¹‹é—´ã€‚è€Œ0x40000000ULè¿™ä¸ªå€¼å°±ä»£è¡¨ç€1GBã€‚ä¹Ÿå°±æ˜¯è¯´ç³»ç»Ÿæœ€å¤šèƒ½äº§ç”Ÿä¸é‡å¤çš„LOG_BLOCK_HDR_NOå€¼åªæœ‰1GBä¸ªã€‚InnoDBè§„å®šredoæ—¥å¿—æ–‡ä»¶ç»„ä¸­åŒ…å«çš„æ‰€æœ‰æ–‡ä»¶å¤§å°æ€»å’Œä¸å¾—è¶…è¿‡512GBï¼Œä¸€ä¸ªblockå¤§å°æ˜¯512å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­åŒ…å«çš„blockå—æœ€å¤šä¸º1GBä¸ªï¼Œæ‰€ä»¥æœ‰1GBä¸ªä¸é‡å¤çš„ç¼–å·å€¼ä¹Ÿå°±å¤Ÿç”¨äº†ã€‚ å¦å¤–ï¼ŒLOG_BLOCK_HDR_NOå€¼çš„ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½æ¯”è¾ƒç‰¹æ®Šï¼Œç§°ä¹‹ä¸ºflush bitï¼Œå¦‚æœè¯¥å€¼ä¸º1ï¼Œä»£è¡¨ç€æœ¬blockæ˜¯åœ¨æŸæ¬¡å°†log bufferä¸­çš„blockåˆ·æ–°åˆ°ç£ç›˜çš„æ“ä½œä¸­çš„ç¬¬ä¸€ä¸ªè¢«åˆ·å…¥çš„blockã€‚ åï¼Œdouble write1.è„é¡µåˆ·ç›˜é£é™©å…³äºIOçš„æœ€å°å•ä½ï¼š æ•°æ®åº“IOçš„æœ€å°å•ä½æ˜¯16Kï¼ˆMySQLé»˜è®¤ï¼Œoracleæ˜¯8Kï¼‰ æ–‡ä»¶ç³»ç»ŸIOçš„æœ€å°å•ä½æ˜¯4Kï¼ˆä¹Ÿæœ‰1Kçš„ï¼‰ ç£ç›˜IOçš„æœ€å°å•ä½æ˜¯512å­—èŠ‚ å› æ­¤ï¼Œå­˜åœ¨IOå†™å…¥å¯¼è‡´pageæŸåçš„é£é™©ï¼š 2.doublewriteï¼šä¸¤æ¬¡å†™æé«˜innodbçš„å¯é æ€§ï¼Œç”¨æ¥è§£å†³éƒ¨åˆ†å†™å¤±è´¥(partial page writeé¡µæ–­è£‚)ã€‚ 2.1 Double writeè§£å†³äº†ä»€ä¹ˆé—®é¢˜ä¸€ä¸ªæ•°æ®é¡µçš„å¤§å°æ˜¯16Kï¼Œå‡è®¾åœ¨æŠŠå†…å­˜ä¸­çš„è„é¡µå†™åˆ°æ•°æ®åº“çš„æ—¶å€™ï¼Œå†™äº†2Kçªç„¶æ‰ç”µï¼Œä¹Ÿå°±æ˜¯è¯´å‰2Kæ•°æ®æ˜¯æ–°çš„ï¼Œå14Kæ˜¯æ—§çš„ï¼Œé‚£ä¹ˆç£ç›˜æ•°æ®åº“è¿™ä¸ªæ•°æ®é¡µå°±æ˜¯ä¸å®Œæ•´çš„ï¼Œæ˜¯ä¸€ä¸ªåæ‰çš„æ•°æ®é¡µã€‚redoåªèƒ½åŠ ä¸Šæ—§ã€æ ¡æ£€å®Œæ•´çš„æ•°æ®é¡µæ¢å¤ä¸€ä¸ªè„å—ï¼Œä¸èƒ½ä¿®å¤åæ‰çš„æ•°æ®é¡µï¼Œæ‰€ä»¥è¿™ä¸ªæ•°æ®å°±ä¸¢å¤±äº†ï¼Œå¯èƒ½ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦double writeã€‚ 2.2ä½¿ç”¨æƒ…æ™¯å½“æ•°æ®åº“æ­£åœ¨ä»å†…å­˜æƒ³ç£ç›˜å†™ä¸€ä¸ªæ•°æ®é¡µæ˜¯ï¼Œæ•°æ®åº“å®•æœºï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªé¡µåªå†™äº†éƒ¨åˆ†æ•°æ®ï¼Œè¿™å°±æ˜¯éƒ¨åˆ†å†™å¤±æ•ˆï¼Œå®ƒä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚è¿™æ—¶æ˜¯æ— æ³•é€šè¿‡é‡åšæ—¥å¿—æ¢å¤çš„ï¼Œå› ä¸ºé‡åšæ—¥å¿—è®°å½•çš„æ˜¯å¯¹é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œå¦‚æœé¡µæœ¬èº«å·²ç»æŸåï¼Œé‡åšæ—¥å¿—ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚ 2.3 double writeå·¥ä½œæµç¨‹ doublewriteç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†ä¸ºå†…å­˜ä¸­çš„doublewrite bufferï¼Œå…¶å¤§å°ä¸º2MBï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ç£ç›˜ä¸Šå…±äº«è¡¨ç©ºé—´(ibdata x)ä¸­è¿ç»­çš„128ä¸ªé¡µï¼Œå³2ä¸ªåŒº(extent)ï¼Œå¤§å°ä¹Ÿæ˜¯2Mã€‚ å½“ä¸€ç³»åˆ—æœºåˆ¶è§¦å‘æ•°æ®ç¼“å†²æ± ä¸­çš„è„é¡µåˆ·æ–°æ—¶ï¼Œå¹¶ä¸ç›´æ¥å†™å…¥ç£ç›˜æ•°æ®æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯å…ˆæ‹·è´è‡³å†…å­˜ä¸­çš„doublewrite bufferä¸­ï¼› æ¥ç€ä»ä¸¤æ¬¡å†™ç¼“å†²åŒºåˆ†ä¸¤æ¬¡å†™å…¥ç£ç›˜å…±äº«è¡¨ç©ºé—´ä¸­(è¿ç»­å­˜å‚¨ï¼Œé¡ºåºå†™ï¼Œæ€§èƒ½å¾ˆé«˜)ï¼Œæ¯æ¬¡å†™1MBï¼› å¾…ç¬¬äºŒæ­¥å®Œæˆåï¼Œå†å°†doublewrite bufferä¸­çš„è„é¡µæ•°æ®å†™å…¥å®é™…çš„å„ä¸ªè¡¨ç©ºé—´æ–‡ä»¶(ç¦»æ•£å†™)ï¼›(è„é¡µæ•°æ®å›ºåŒ–åï¼Œå³è¿›è¡Œæ ‡è®°å¯¹åº”doublewriteæ•°æ®å¯è¦†ç›–) 2.4 doublewriteçš„å´©æºƒæ¢å¤å¦‚æœæ“ä½œç³»ç»Ÿåœ¨å°†é¡µå†™å…¥ç£ç›˜çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå´©æºƒï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œinnodbå­˜å‚¨å¼•æ“å¯ä»¥ä»å…±äº«è¡¨ç©ºé—´çš„doublewriteä¸­æ‰¾åˆ°è¯¥é¡µçš„ä¸€ä¸ªæœ€è¿‘çš„å‰¯æœ¬ï¼Œå°†å…¶å¤åˆ¶åˆ°è¡¨ç©ºé—´æ–‡ä»¶ï¼Œå†åº”ç”¨redo logï¼Œå°±å®Œæˆäº†æ¢å¤è¿‡ç¨‹ã€‚å› ä¸ºæœ‰å‰¯æœ¬æ‰€ä»¥ä¹Ÿä¸æ‹…å¿ƒè¡¨ç©ºé—´ä¸­æ•°æ®é¡µæ˜¯å¦æŸåã€‚ Qï¼šä¸ºä»€ä¹ˆ*log write*ä¸éœ€è¦*doublewrite*çš„æ”¯æŒï¼Ÿ Aï¼šå› ä¸º*redolog*å†™å…¥çš„å•ä½å°±æ˜¯512å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ç£ç›˜IOçš„æœ€å°å•ä½ï¼Œæ‰€ä»¥æ— æ‰€è°“æ•°æ®æŸåã€‚ 3.doublewriteçš„å‰¯ä½œç”¨3.1 double writeå¸¦æ¥çš„å†™è´Ÿè½½ double writeæ˜¯ä¸€ä¸ªbuffer, ä½†å…¶å®å®ƒæ˜¯å¼€åœ¨ç‰©ç†æ–‡ä»¶ä¸Šçš„ä¸€ä¸ªbuffer, å…¶å®ä¹Ÿå°±æ˜¯file, æ‰€ä»¥å®ƒä¼šå¯¼è‡´ç³»ç»Ÿæœ‰æ›´å¤šçš„fsyncæ“ä½œ, è€Œç¡¬ç›˜çš„fsyncæ€§èƒ½æ˜¯å¾ˆæ…¢çš„, æ‰€ä»¥å®ƒä¼šé™ä½mysqlçš„æ•´ä½“æ€§èƒ½ã€‚ ä½†æ˜¯ï¼Œdoublewrite bufferå†™å…¥ç£ç›˜å…±äº«è¡¨ç©ºé—´è¿™ä¸ªè¿‡ç¨‹æ˜¯è¿ç»­å­˜å‚¨ï¼Œæ˜¯é¡ºåºå†™ï¼Œæ€§èƒ½éå¸¸é«˜ï¼Œ(çº¦å å†™çš„10%)ï¼Œç‰ºç‰²ä¸€ç‚¹å†™æ€§èƒ½æ¥ä¿è¯æ•°æ®é¡µçš„å®Œæ•´è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ 3.2 ç›‘æ§double writeå·¥ä½œè´Ÿè½½12345678mysql&gt; show global status like &#x27;%dblwr%&#x27;;+----------------------------+-------+| Variable_name | Value |+----------------------------+-------+| Innodb_dblwr_pages_written | 7 || Innodb_dblwr_writes | 3 |+----------------------------+-------+2 rows in set (0.00 sec) å…³æ³¨ç‚¹ï¼šInnodb_dblwr_pages_written / Innodb_dblwr_writes å¼€å¯doublewriteåï¼Œæ¯æ¬¡è„é¡µåˆ·æ–°å¿…é¡»è¦å…ˆå†™doublewriteï¼Œè€Œdoublewriteå­˜åœ¨äºç£ç›˜ä¸Šçš„æ˜¯ä¸¤ä¸ªè¿ç»­çš„åŒºï¼Œæ¯ä¸ªåŒºç”±è¿ç»­çš„é¡µç»„æˆï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªåŒºæœ€å¤šæœ‰64ä¸ªé¡µï¼Œæ‰€ä»¥ä¸€æ¬¡IOå†™å…¥åº”è¯¥å¯ä»¥æœ€å¤šå†™64ä¸ªé¡µã€‚ è€Œæ ¹æ®ä»¥ä¸Šç³»ç»ŸInnodb_dblwr_pages_writtenä¸Innodb_dblwr_writesçš„æ¯”ä¾‹æ¥çœ‹ï¼Œå¤§æ¦‚åœ¨3å·¦å³ï¼Œè¿œè¿œè¿˜æ²¡åˆ°64(å¦‚æœçº¦ç­‰äº64ï¼Œé‚£ä¹ˆè¯´æ˜ç³»ç»Ÿçš„å†™å‹åŠ›éå¸¸å¤§ï¼Œæœ‰å¤§é‡çš„è„é¡µè¦å¾€ç£ç›˜ä¸Šå†™)ï¼Œæ‰€ä»¥ä»è¿™ä¸ªè§’åº¦ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿå†™å…¥å‹åŠ›å¹¶ä¸é«˜ã€‚ 3.3 å…³é—­double writeé€‚åˆçš„åœºæ™¯ æµ·é‡DML ä¸æƒ§æ€•æ•°æ®æŸåå’Œä¸¢å¤± ç³»ç»Ÿå†™è´Ÿè½½æˆä¸ºä¸»è¦è´Ÿè½½ 1234567mysql&gt; show variables like &#x27;%double%&#x27;;+--------------------+-------+| Variable_name | Value |+--------------------+-------+| innodb_doublewrite | ON |+--------------------+-------+1 row in set (0.04 sec) ä½œä¸ºInnoDBçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ï¼ŒdoublewriteåŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œä½†æ˜¯åœ¨ä¸Šè¿°ç‰¹æ®Šçš„ä¸€äº›åœºæ™¯ä¹Ÿå¯ä»¥è§†æƒ…å†µå…³é—­ï¼Œæ¥æé«˜æ•°æ®åº“å†™æ€§èƒ½ã€‚é™æ€å‚æ•°ï¼Œé…ç½®æ–‡ä»¶ä¿®æ”¹ï¼Œé‡å¯æ•°æ®åº“ã€‚ 3.4 ä¸ºä»€ä¹ˆæ²¡æœ‰æŠŠdouble writeé‡Œé¢çš„æ•°æ®å†™åˆ°data pageé‡Œé¢å‘¢ï¼Ÿ double writeé‡Œé¢çš„æ•°æ®æ˜¯è¿ç»­çš„ï¼Œå¦‚æœç›´æ¥å†™åˆ°data pageé‡Œé¢ï¼Œè€Œdata pageçš„é¡µåˆæ˜¯ç¦»æ•£çš„ï¼Œå†™å…¥ä¼šå¾ˆæ…¢ã€‚ double writeé‡Œé¢çš„æ•°æ®æ²¡æœ‰åŠæ³•è¢«åŠæ—¶çš„è¦†ç›–æ‰ï¼Œå¯¼è‡´double writeçš„å‹åŠ›å¾ˆå¤§ï¼›çŸ­æ—¶é—´å†…å¯èƒ½ä¼šå‡ºç°double writeæº¢å‡ºçš„æƒ…å†µã€‚ åä¸€ï¼Œæ€»ç»“redoæ—¥å¿—è®°å½•äº†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½ä¿®æ”¹äº†å“ªäº›å†…å®¹ã€‚ äº‹åŠ¡æäº¤æ—¶åªå°†æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„é¡µé¢éƒ½åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š redoæ—¥å¿—å ç”¨çš„ç©ºé—´éå¸¸å° redoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„ ä¸€æ¡redoæ—¥å¿—ç”±ä¸‹é¢å‡ éƒ¨åˆ†ç»„æˆã€‚ typeï¼šè¿™æ¡redoæ—¥å¿—çš„ç±»å‹ space ID:è¡¨ç©ºé—´ID page number :é¡µå· dataï¼šè¿™æ¡redoæ—¥å¿—çš„å…·ä½“å†…å®¹ redoæ—¥å¿—çš„ç±»å‹æœ‰ç®€å•å’Œå¤æ‚ä¹‹åˆ†ã€‚ç®€å•ç±»å‹çš„redoæ—¥å¿—æ˜¯çº¯ç²¹çš„ç‰©ç†æ—¥å¿—ï¼Œå¤æ‚ç±»å‹çš„redoæ—¥å¿—å…¼æœ‰ç‰©ç†æ—¥å¿—å’Œé€»è¾‘æ—¥å¿—çš„ç‰¹æ€§ã€‚ ä¸€ä¸ªMTRå¯ä»¥åŒ…å«ä¸€ç»„redoæ—¥å¿—ã€‚åœ¨è¿›è¡Œå´©æºƒæ¢å¤æ—¶ï¼Œè¿™ä¸€ç»„redoæ—¥å¿—ä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“æ¥å¤„ç†ã€‚ redoæ—¥å¿—å­˜æ”¾åœ¨å¤§å°ä¸º512å­—èŠ‚çš„blockä¸­ã€‚æ¯ä¸€ä¸ªblockè¢«åˆ†ä¸º3éƒ¨åˆ†ï¼š log block header log block body log block trailer redoæ—¥å¿—ç¼“å†²åŒºæ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç”±è‹¥å¹²ä¸ªblockç»„æˆï¼›å¯ä»¥é€šè¿‡å¯åŠ¨é€‰é¡¹innodb_log_buffer_size æ¥è°ƒæ•´ä»–çš„å¤§å°ã€‚ redoæ—¥å¿—æ–‡ä»¶ç»„ç”±è‹¥å¹²ä¸ªæ—¥å¿—æ–‡ä»¶ç»„æˆï¼Œè¿™äº›redoæ—¥å¿—æ–‡ä»¶æ˜¯è¢«å¾ªç¯ä½¿ç”¨çš„ã€‚redoæ—¥å¿—æ–‡ä»¶ç»„ä¸­æ¯ä¸ªæ–‡ä»¶çš„å¤§å°éƒ½ä¸€æ ·ï¼Œæ ¼å¼ä¹Ÿä¸€æ ·ï¼Œéƒ½æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼š å‰2048å­—èŠ‚ç”¨æ¥å­˜å‚¨ä¸€äº›ç®¡ç†ä¿¡æ¯ ä»ç¬¬2048å­—èŠ‚å¾€åçš„å­—èŠ‚ç”¨æ¥å­˜å‚¨log bufferä¸­çš„blocké•œåƒ lsnæŒ‡å·²ç»å†™å…¥çš„redoæ—¥å¿—é‡ï¼Œflushed_to_disk_lsnæŒ‡åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„redoæ—¥å¿—é‡ï¼Œflushé“¾è¡¨ä¸­çš„è„é¡µæŒ‰ç…§ä¿®æ”¹å‘ç”Ÿçš„æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§oldest_modificationä»£è¡¨çš„lsnå€¼è¿›è¡Œæ’åºã€‚è¢«å¤šæ¬¡æ›´æ–°çš„é¡µé¢ä¸ä¼šé‡å¤æ’å…¥åˆ°flushé“¾è¡¨ï¼Œä½†æ˜¯ä¼šæ›´æ–°newest_modificationå±æ€§çš„å€¼ã€‚checkpoint_lsnè¡¨ç¤ºå½“å‰ç³»ç»Ÿä¸­å¯ä»¥è¢«è¦†ç›–çš„redoæ—¥å¿—æ€»é‡æ˜¯å¤šå°‘ã€‚ redoæ—¥å¿—å ç”¨çš„ç£ç›˜ç©ºé—´åœ¨ä»–å¯¹åº”çš„è„é¡µå·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜åå³å¯è¢«è¦†ç›–ã€‚æ‰§è¡Œä¸€æ¬¡checkpointçš„æ„æ€å°±æ˜¯å¢åŠ checkpoint_lsnçš„å€¼ï¼Œç„¶åæŠŠç›¸å…³ä¿¡æ¯æ”¾åˆ°æ—¥å¿—æ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­ã€‚ innodb_flush_log_at_trx_commitç³»ç»Ÿå˜é‡æ§åˆ¶ç€åœ¨äº‹åŠ¡æäº¤æ—¶æ˜¯å¦å°†è¯¥äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoåˆ·æ–°åˆ°ç£ç›˜ã€‚ åœ¨å´©æºƒæ¢å¤è¿‡ç¨‹ä¸­ï¼Œä»redoæ—¥å¿—æ–‡ä»¶ç»„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç®¡ç†ä¿¡æ¯ä¸­å–å‡ºæœ€è¿‘å‘ç”Ÿçš„é‚£æ¬¡checkpointä¿¡æ¯ï¼Œç„¶åä»checkpoint_lsnåœ¨æ—¥å¿—æ–‡ä»¶ç»„ä¸­å¯¹åº”çš„åç§»é‡å¼€å§‹ï¼Œä¸€ç›´æ‰«ææ—¥å¿—æ–‡ä»¶ä¸­çš„blockï¼Œç›´åˆ°æŸä¸ªblockçš„LOG_BLOCK_HDR_DATA_LENå€¼ä¸ç­‰äº512ä¸ºæ­¢ã€‚å†æ¢å¤è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨hashè¡¨å¯åŠ å¿«æ¢å¤è¿‡ç¨‹ï¼Œå¹¶ä¸”ä¼šè·³è¿‡å·²ç»åˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢ã€‚","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"undolog","slug":"7.mysql/undoæ—¥å¿—","date":"2021-12-26T16:00:00.000Z","updated":"2022-03-31T02:55:44.591Z","comments":true,"path":"2021/12/27/7.mysql/undoæ—¥å¿—/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/27/7.mysql/undo%E6%97%A5%E5%BF%97/","excerpt":"","text":"1.äº‹åŠ¡å›æ»šçš„éœ€æ±‚æˆ‘ä»¬è¯´è¿‡äº‹åŠ¡éœ€è¦ä¿è¯åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆä»€ä¹ˆä¹Ÿä¸åšã€‚ä½†æ˜¯ååæœ‰æ—¶å€™äº‹åŠ¡æ‰§è¡Œåˆ°ä¸€åŠä¼šå‡ºç°ä¸€äº›æƒ…å†µï¼Œæ¯”å¦‚ï¼š æƒ…å†µä¸€ï¼šäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°å„ç§é”™è¯¯ï¼Œæ¯”å¦‚æœåŠ¡å™¨æœ¬èº«çš„é”™è¯¯ï¼Œæ“ä½œç³»ç»Ÿé”™è¯¯ï¼Œç”šè‡³æ˜¯çªç„¶æ–­ç”µå¯¼è‡´çš„é”™è¯¯ã€‚ æƒ…å†µäºŒï¼šç¨‹åºå‘˜å¯ä»¥åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰‹åŠ¨è¾“å…¥ROLLBACKè¯­å¥ç»“æŸå½“å‰çš„äº‹åŠ¡çš„æ‰§è¡Œã€‚ è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šå¯¼è‡´äº‹åŠ¡æ‰§è¡Œåˆ°ä¸€åŠå°±ç»“æŸï¼Œä½†æ˜¯äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å·²ç»ä¿®æ”¹äº†å¾ˆå¤šä¸œè¥¿ï¼Œä¸ºäº†ä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä¸œè¥¿æ”¹å›åŸå…ˆçš„æ ·å­ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç§°ä¹‹ä¸ºå›æ»šï¼ˆè‹±æ–‡åï¼šrollbackï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥é€ æˆä¸€ä¸ªå‡è±¡ï¼šè¿™ä¸ªäº‹åŠ¡çœ‹èµ·æ¥ä»€ä¹ˆéƒ½æ²¡åšï¼Œæ‰€ä»¥ç¬¦åˆåŸå­æ€§è¦æ±‚ã€‚ æ¯å½“æˆ‘ä»¬è¦å¯¹ä¸€æ¡è®°å½•åšæ”¹åŠ¨æ—¶ï¼ˆè¿™é‡Œçš„æ”¹åŠ¨å¯ä»¥æŒ‡INSERTã€DELETEã€UPDATEï¼‰ï¼Œéƒ½éœ€è¦ç•™ä¸€æ‰‹ â€”â€” æŠŠå›æ»šæ—¶æ‰€éœ€çš„ä¸œè¥¿éƒ½ç»™è®°ä¸‹æ¥ã€‚æ¯”æ–¹è¯´ï¼š ä½ æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œè‡³å°‘è¦æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®å€¼è®°ä¸‹æ¥ï¼Œä¹‹åå›æ»šçš„æ—¶å€™åªéœ€è¦æŠŠè¿™ä¸ªä¸»é”®å€¼å¯¹åº”çš„è®°å½•åˆ æ‰å°±å¥½äº†ã€‚ ä½ åˆ é™¤äº†ä¸€æ¡è®°å½•ï¼Œè‡³å°‘è¦æŠŠè¿™æ¡è®°å½•ä¸­çš„å†…å®¹éƒ½è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠç”±è¿™äº›å†…å®¹ç»„æˆçš„è®°å½•æ’å…¥åˆ°è¡¨ä¸­å°±å¥½äº†ã€‚ ä½ ä¿®æ”¹äº†ä¸€æ¡è®°å½•ï¼Œè‡³å°‘è¦æŠŠä¿®æ”¹è¿™æ¡è®°å½•å‰çš„æ—§å€¼éƒ½è®°å½•ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠè¿™æ¡è®°å½•æ›´æ–°ä¸ºæ—§å€¼å°±å¥½äº†ã€‚ æ•°æ®åº“æŠŠè¿™äº›ä¸ºäº†å›æ»šè€Œè®°å½•çš„è¿™äº›ä¸œè¥¿ç§°ä¹‹ä¸ºæ’¤é”€æ—¥å¿—ï¼Œè‹±æ–‡åä¸ºundo logï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœŸæ´‹ç»“åˆï¼Œç§°ä¹‹ä¸ºundoæ—¥å¿—ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äºæŸ¥è¯¢æ“ä½œï¼ˆSELECTï¼‰å¹¶ä¸ä¼šä¿®æ”¹ä»»ä½•ç”¨æˆ·è®°å½•ï¼Œæ‰€ä»¥åœ¨æŸ¥è¯¢æ“ä½œæ‰§è¡Œæ—¶ï¼Œå¹¶ä¸éœ€è¦è®°å½•ç›¸åº”çš„undoæ—¥å¿—ã€‚åœ¨çœŸå®çš„InnoDBä¸­ï¼Œundoæ—¥å¿—å…¶å®å¹¶ä¸åƒæˆ‘ä»¬ä¸Šè¾¹æ‰€è¯´çš„é‚£ä¹ˆç®€å•ï¼Œä¸åŒç±»å‹çš„æ“ä½œäº§ç”Ÿçš„undoæ—¥å¿—çš„æ ¼å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œä¸è¿‡å…ˆæš‚æ—¶æŠŠè¿™äº›å…·ä½“ç»†èŠ‚æ”¾ä¸€æ”¾ï¼Œæˆ‘ä»¬å…ˆå›è¿‡å¤´æ¥çœ‹çœ‹äº‹åŠ¡idã€‚ 2.äº‹åŠ¡id2.1ç»™äº‹åŠ¡åˆ†é…idçš„æ—¶æœºä¸€ä¸ªäº‹åŠ¡å¯ä»¥æ˜¯ä¸€ä¸ªåªè¯»äº‹åŠ¡ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼š æˆ‘ä»¬å¯ä»¥é€šè¿‡START TRANSACTION READ ONLYè¯­å¥å¼€å¯ä¸€ä¸ªåªè¯»äº‹åŠ¡ã€‚åœ¨åªè¯»äº‹åŠ¡ä¸­ä¸å¯ä»¥å¯¹æ™®é€šçš„è¡¨ï¼ˆå…¶ä»–äº‹åŠ¡ä¹Ÿèƒ½è®¿é—®åˆ°çš„è¡¨ï¼‰è¿›è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œï¼Œä½†å¯ä»¥å¯¹ä¸´æ—¶è¡¨åšå¢ã€åˆ ã€æ”¹æ“ä½œã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡START TRANSACTION READ WRITEè¯­å¥å¼€å¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼Œæˆ–è€…ä½¿ç”¨BEGINã€START TRANSACTIONè¯­å¥å¼€å¯çš„äº‹åŠ¡é»˜è®¤ä¹Ÿç®—æ˜¯è¯»å†™äº‹åŠ¡ã€‚åœ¨è¯»å†™äº‹åŠ¡ä¸­å¯ä»¥å¯¹è¡¨æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œã€‚ å¦‚æœæŸä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æŸä¸ªè¡¨æ‰§è¡Œäº†å¢ã€åˆ ã€æ”¹æ“ä½œï¼Œé‚£ä¹ˆInnoDBå­˜å‚¨å¼•æ“å°±ä¼šç»™å®ƒåˆ†é…ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„äº‹åŠ¡idï¼Œåˆ†é…æ–¹å¼å¦‚ä¸‹ï¼š å¯¹äºåªè¯»äº‹åŠ¡æ¥è¯´ï¼Œåªæœ‰åœ¨å®ƒç¬¬ä¸€æ¬¡å¯¹æŸä¸ªç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨æ‰§è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œæ—¶æ‰ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªäº‹åŠ¡idï¼Œå¦åˆ™çš„è¯æ˜¯ä¸åˆ†é…äº‹åŠ¡idçš„ã€‚ å¯¹æŸä¸ªæŸ¥è¯¢è¯­å¥æ‰§è¡ŒEXPLAINåˆ†æå®ƒçš„æŸ¥è¯¢è®¡åˆ’æ—¶ï¼Œæœ‰æ—¶å€™åœ¨Extraåˆ—ä¼šçœ‹åˆ°Using temporaryçš„æç¤ºï¼Œè¿™ä¸ªè¡¨æ˜åœ¨æ‰§è¡Œè¯¥æŸ¥è¯¢è¯­å¥æ—¶ä¼šç”¨åˆ°å†…éƒ¨ä¸´æ—¶è¡¨ã€‚è¿™ä¸ªæ‰€è°“çš„å†…éƒ¨ä¸´æ—¶è¡¨å’Œæˆ‘ä»¬æ‰‹åŠ¨ç”¨CREATE TEMPORARY TABLEåˆ›å»ºçš„ç”¨æˆ·ä¸´æ—¶è¡¨å¹¶ä¸ä¸€æ ·ï¼Œåœ¨äº‹åŠ¡å›æ»šæ—¶å¹¶ä¸éœ€è¦æŠŠæ‰§è¡ŒSELECTè¯­å¥è¿‡ç¨‹ä¸­ç”¨åˆ°çš„å†…éƒ¨ä¸´æ—¶è¡¨ä¹Ÿå›æ»šï¼Œåœ¨æ‰§è¡ŒSELECTè¯­å¥ç”¨åˆ°å†…éƒ¨ä¸´æ—¶è¡¨æ—¶å¹¶ä¸ä¼šä¸ºå®ƒåˆ†é…äº‹åŠ¡idã€‚ å¯¹äºè¯»å†™äº‹åŠ¡æ¥è¯´ï¼Œåªæœ‰åœ¨å®ƒç¬¬ä¸€æ¬¡å¯¹æŸä¸ªè¡¨ï¼ˆåŒ…æ‹¬ç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨ï¼‰æ‰§è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œæ—¶æ‰ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªäº‹åŠ¡idï¼Œå¦åˆ™çš„è¯ä¹Ÿæ˜¯ä¸åˆ†é…äº‹åŠ¡idçš„ã€‚æœ‰çš„æ—¶å€™è™½ç„¶æˆ‘ä»¬å¼€å¯äº†ä¸€ä¸ªè¯»å†™äº‹åŠ¡ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªäº‹åŠ¡ä¸­å…¨æ˜¯æŸ¥è¯¢è¯­å¥ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œå¢ã€åˆ ã€æ”¹çš„è¯­å¥ï¼Œé‚£ä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªäº‹åŠ¡å¹¶ä¸ä¼šè¢«åˆ†é…ä¸€ä¸ªäº‹åŠ¡idã€‚ åªæœ‰åœ¨äº‹åŠ¡å¯¹è¡¨ä¸­çš„è®°å½•åšæ”¹åŠ¨æ—¶æ‰ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„**äº‹åŠ¡id**ã€‚ ä¸Šè¾¹æè¿°çš„äº‹åŠ¡idåˆ†é…ç­–ç•¥æ˜¯é’ˆå¯¹MySQL 5.7æ¥è¯´çš„ï¼Œå‰è¾¹çš„ç‰ˆæœ¬çš„åˆ†é…æ–¹å¼å¯èƒ½ä¸åŒã€‚ 2.2äº‹åŠ¡idæ˜¯æ€ä¹ˆç”Ÿæˆçš„è¿™ä¸ªäº‹åŠ¡idæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå®ƒçš„åˆ†é…ç­–ç•¥å’Œå¯¹éšè—åˆ—row_idï¼ˆå½“ç”¨æˆ·æ²¡æœ‰ä¸ºè¡¨åˆ›å»ºä¸»é”®å’ŒUNIQUEé”®æ—¶InnoDBè‡ªåŠ¨åˆ›å»ºçš„åˆ—ï¼‰çš„åˆ†é…ç­–ç•¥å¤§æŠµç›¸åŒï¼Œå…·ä½“ç­–ç•¥å¦‚ä¸‹ï¼š æœåŠ¡å™¨ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ¯å½“éœ€è¦ä¸ºæŸä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªäº‹åŠ¡idæ—¶ï¼Œå°±ä¼šæŠŠè¯¥å˜é‡çš„å€¼å½“ä½œäº‹åŠ¡idåˆ†é…ç»™è¯¥äº‹åŠ¡ï¼Œå¹¶ä¸”æŠŠè¯¥å˜é‡è‡ªå¢1ã€‚ æ¯å½“è¿™ä¸ªå˜é‡çš„å€¼ä¸º256çš„å€æ•°æ—¶ï¼Œå°±ä¼šå°†è¯¥å˜é‡çš„å€¼åˆ·æ–°åˆ°ç³»ç»Ÿè¡¨ç©ºé—´çš„é¡µå·ä¸º5çš„é¡µé¢ä¸­ä¸€ä¸ªç§°ä¹‹ä¸ºMax Trx IDçš„å±æ€§å¤„ï¼Œè¿™ä¸ªå±æ€§å ç”¨8ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚ å½“ç³»ç»Ÿä¸‹ä¸€æ¬¡é‡æ–°å¯åŠ¨æ—¶ï¼Œä¼šå°†ä¸Šè¾¹æåˆ°çš„Max Trx IDå±æ€§åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå°†è¯¥å€¼åŠ ä¸Š256ä¹‹åèµ‹å€¼ç»™æˆ‘ä»¬å‰è¾¹æåˆ°çš„å…¨å±€å˜é‡ï¼ˆå› ä¸ºåœ¨ä¸Šæ¬¡å…³æœºæ—¶è¯¥å…¨å±€å˜é‡çš„å€¼å¯èƒ½å¤§äºMax Trx IDå±æ€§å€¼ï¼‰ã€‚ è¿™æ ·å°±å¯ä»¥ä¿è¯æ•´ä¸ªç³»ç»Ÿä¸­åˆ†é…çš„äº‹åŠ¡idå€¼æ˜¯ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚å…ˆè¢«åˆ†é…idçš„äº‹åŠ¡å¾—åˆ°çš„æ˜¯è¾ƒå°çš„äº‹åŠ¡idï¼Œåè¢«åˆ†é…idçš„äº‹åŠ¡å¾—åˆ°çš„æ˜¯è¾ƒå¤§çš„äº‹åŠ¡idã€‚ 2.3trx_idéšè—åˆ—èšç°‡ç´¢å¼•çš„è®°å½•é™¤äº†ä¼šä¿å­˜å®Œæ•´çš„ç”¨æˆ·æ•°æ®ä»¥å¤–ï¼Œè€Œä¸”è¿˜ä¼šè‡ªåŠ¨æ·»åŠ åä¸ºtrx_idã€roll_pointerçš„éšè—åˆ—ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰åœ¨è¡¨ä¸­å®šä¹‰ä¸»é”®ä»¥åŠUNIQUEé”®ï¼Œè¿˜ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªåä¸ºrow_idçš„éšè—åˆ—ã€‚æ‰€ä»¥ä¸€æ¡è®°å½•åœ¨é¡µé¢ä¸­çš„çœŸå®ç»“æ„çœ‹èµ·æ¥å°±æ˜¯è¿™æ ·çš„ï¼š å…¶ä¸­çš„trx_idåˆ—å…¶å®è¿˜è›®å¥½ç†è§£çš„ï¼Œå°±æ˜¯æŸä¸ªå¯¹è¿™ä¸ªèšç°‡ç´¢å¼•è®°å½•åšæ”¹åŠ¨çš„è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡å¯¹åº”çš„äº‹åŠ¡idè€Œå·²ï¼ˆæ­¤å¤„çš„æ”¹åŠ¨å¯ä»¥æ˜¯INSERTã€DELETEã€UPDATEæ“ä½œï¼‰ã€‚è‡³äºroll_pointeréšè—åˆ—æˆ‘ä»¬åè¾¹åˆ†æã€‚ 3.undoæ—¥å¿—çš„æ ¼å¼ä¸ºäº†å®ç°äº‹åŠ¡çš„åŸå­æ€§ï¼ŒInnoDBå­˜å‚¨å¼•æ“åœ¨å®é™…è¿›è¡Œå¢ã€åˆ ã€æ”¹ä¸€æ¡è®°å½•æ—¶ï¼Œéƒ½éœ€è¦å…ˆæŠŠå¯¹åº”çš„undoæ—¥å¿—è®°ä¸‹æ¥ã€‚ä¸€èˆ¬æ¯å¯¹ä¸€æ¡è®°å½•åšä¸€æ¬¡æ”¹åŠ¨ï¼Œå°±å¯¹åº”ç€ä¸€æ¡undoæ—¥å¿—ï¼Œä½†åœ¨æŸäº›æ›´æ–°è®°å½•çš„æ“ä½œä¸­ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¹åº”ç€2æ¡undoæ—¥å¿—ã€‚ä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½æ–°å¢ã€åˆ é™¤ã€æ›´æ–°è‹¥å¹²æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦è®°å½•å¾ˆå¤šæ¡å¯¹åº”çš„undoæ—¥å¿—ï¼Œè¿™äº›undoæ—¥å¿—ä¼šè¢«ä»0å¼€å§‹ç¼–å·ï¼Œä¹Ÿå°±æ˜¯è¯´æ ¹æ®ç”Ÿæˆçš„é¡ºåºåˆ†åˆ«è¢«ç§°ä¸ºç¬¬0å·undoæ—¥å¿—ã€ç¬¬1å·undoæ—¥å¿—ã€â€¦ã€ç¬¬nå·undoæ—¥å¿—ç­‰ï¼Œè¿™ä¸ªç¼–å·ä¹Ÿè¢«ç§°ä¹‹ä¸ºundo noã€‚ è¿™äº›undoæ—¥å¿—æ˜¯è¢«è®°å½•åˆ°ç±»å‹ä¸ºFIL_PAGE_UNDO_LOGçš„é¡µé¢ä¸­ã€‚è¿™äº›é¡µé¢å¯ä»¥ä»ç³»ç»Ÿè¡¨ç©ºé—´ä¸­åˆ†é…ï¼Œä¹Ÿå¯ä»¥ä»ä¸€ç§ä¸“é—¨å­˜æ”¾undoæ—¥å¿—çš„è¡¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„undo tablespaceä¸­åˆ†é…ã€‚å…ˆæ¥çœ‹çœ‹ä¸åŒæ“ä½œéƒ½ä¼šäº§ç”Ÿä»€ä¹ˆæ ·å­çš„undoæ—¥å¿—å§ï½æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€ä¸ªåä¸ºundo_demoçš„è¡¨ï¼š 1234567CREATE TABLE undo_demo ( id INT NOT NULL, key1 VARCHAR(100), col VARCHAR(100), PRIMARY KEY (id), KEY idx_key1 (key1))Engine=InnoDB CHARSET=utf8; è¿™ä¸ªè¡¨ä¸­æœ‰3ä¸ªåˆ—ï¼Œå…¶ä¸­idåˆ—æ˜¯ä¸»é”®ï¼Œæˆ‘ä»¬ä¸ºkey1åˆ—å»ºç«‹äº†ä¸€ä¸ªäºŒçº§ç´¢å¼•ï¼Œcolåˆ—æ˜¯ä¸€ä¸ªæ™®é€šçš„åˆ—ã€‚æ¯ä¸ªè¡¨éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„table idï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç³»ç»Ÿæ•°æ®åº“information_schemaä¸­çš„innodb_sys_tablesè¡¨æ¥æŸ¥çœ‹æŸä¸ªè¡¨å¯¹åº”çš„table idæ˜¯ä»€ä¹ˆï¼Œç°åœ¨æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹undo_demoå¯¹åº”çš„table idæ˜¯å¤šå°‘ï¼š 1234567mysql&gt; SELECT * FROM information_schema.innodb_sys_tables WHERE name = &#x27;yhd/undo_demo&#x27;;+----------+---------------------+------+--------+-------+-------------+------------+---------------+------------+| TABLE_ID | NAME | FLAG | N_COLS | SPACE | FILE_FORMAT | ROW_FORMAT | ZIP_PAGE_SIZE | SPACE_TYPE |+----------+---------------------+------+--------+-------+-------------+------------+---------------+------------+| 138 | yhd/undo_demo | 33 | 6 | 482 | Barracuda | Dynamic | 0 | Single |+----------+---------------------+------+--------+-------+-------------+------------+---------------+------------+1 row in set (0.01 sec) ä»æŸ¥è¯¢ç»“æœå¯ä»¥çœ‹å‡ºï¼Œundo_demoè¡¨å¯¹åº”çš„table idä¸º138ã€‚ 3.1INSERTæ“ä½œå¯¹åº”çš„undoæ—¥å¿—å½“æˆ‘ä»¬å‘è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶ä¼šæœ‰ä¹è§‚æ’å…¥å’Œæ‚²è§‚æ’å…¥çš„åŒºåˆ†ï¼Œä½†æ˜¯ä¸ç®¡æ€ä¹ˆæ’å…¥ï¼Œæœ€ç»ˆå¯¼è‡´çš„ç»“æœå°±æ˜¯è¿™æ¡è®°å½•è¢«æ”¾åˆ°äº†ä¸€ä¸ªæ•°æ®é¡µä¸­ã€‚å¦‚æœå¸Œæœ›å›æ»šè¿™ä¸ªæ’å…¥æ“ä½œï¼Œé‚£ä¹ˆæŠŠè¿™æ¡è®°å½•åˆ é™¤å°±å¥½äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å†™å¯¹åº”çš„undoæ—¥å¿—æ—¶ï¼Œä¸»è¦æ˜¯æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®ä¿¡æ¯è®°ä¸Šã€‚æ‰€ä»¥InnoDBè®¾è®¡äº†ä¸€ä¸ªç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œå®ƒçš„å®Œæ•´ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ ¹æ®ç¤ºæ„å›¾æˆ‘ä»¬å¼ºè°ƒå‡ ç‚¹ï¼š undo noåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ˜¯ä»0å¼€å§‹é€’å¢çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦äº‹åŠ¡æ²¡æäº¤ï¼Œæ¯ç”Ÿæˆä¸€æ¡undoæ—¥å¿—ï¼Œé‚£ä¹ˆè¯¥æ¡æ—¥å¿—çš„undo noå°±å¢1ã€‚ å¦‚æœè®°å½•ä¸­çš„ä¸»é”®åªåŒ…å«ä¸€ä¸ªåˆ—ï¼Œé‚£ä¹ˆåœ¨ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ä¸­åªéœ€è¦æŠŠè¯¥åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°å’ŒçœŸå®å€¼è®°å½•ä¸‹æ¥ï¼Œå¦‚æœè®°å½•ä¸­çš„ä¸»é”®åŒ…å«å¤šä¸ªåˆ—ï¼Œé‚£ä¹ˆæ¯ä¸ªåˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°å’Œå¯¹åº”çš„çœŸå®å€¼éƒ½éœ€è¦è®°å½•ä¸‹æ¥ï¼ˆå›¾ä¸­çš„lenå°±ä»£è¡¨åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œvalueå°±ä»£è¡¨åˆ—çš„çœŸå®å€¼ï¼‰ã€‚ å½“æˆ‘ä»¬å‘æŸä¸ªè¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œå®é™…ä¸Šéœ€è¦å‘èšç°‡ç´¢å¼•å’Œæ‰€æœ‰çš„äºŒçº§ç´¢å¼•éƒ½æ’å…¥ä¸€æ¡è®°å½•ã€‚ä¸è¿‡è®°å½•undoæ—¥å¿—æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦è€ƒè™‘å‘èšç°‡ç´¢å¼•æ’å…¥è®°å½•æ—¶çš„æƒ…å†µå°±å¥½äº†ï¼Œå› ä¸ºå…¶å®èšç°‡ç´¢å¼•è®°å½•å’ŒäºŒçº§ç´¢å¼•è®°å½•æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæˆ‘ä»¬åœ¨å›æ»šæ’å…¥æ“ä½œæ—¶ï¼Œåªéœ€è¦çŸ¥é“è¿™æ¡è®°å½•çš„ä¸»é”®ä¿¡æ¯ï¼Œç„¶åæ ¹æ®ä¸»é”®ä¿¡æ¯åšå¯¹åº”çš„åˆ é™¤æ“ä½œï¼Œåšåˆ é™¤æ“ä½œæ—¶å°±ä¼šé¡ºå¸¦ç€æŠŠæ‰€æœ‰äºŒçº§ç´¢å¼•ä¸­ç›¸åº”çš„è®°å½•ä¹Ÿåˆ é™¤æ‰ã€‚åè¾¹è¯´åˆ°çš„DELETEæ“ä½œå’ŒUPDATEæ“ä½œå¯¹åº”çš„undoæ—¥å¿—ä¹Ÿéƒ½æ˜¯é’ˆå¯¹èšç°‡ç´¢å¼•è®°å½•è€Œè¨€çš„ã€‚ ç°åœ¨æˆ‘ä»¬å‘undo_demoä¸­æ’å…¥ä¸¤æ¡è®°å½•ï¼š 12345BEGIN; # æ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå‡è®¾è¯¥äº‹åŠ¡çš„idä¸º100# æ’å…¥ä¸¤æ¡è®°å½•INSERT INTO undo_demo(id, key1, col) VALUES (1, &#x27;AWM&#x27;, &#x27;ç‹™å‡»æª&#x27;), (2, &#x27;M416&#x27;, &#x27;æ­¥æª&#x27;); å› ä¸ºè®°å½•çš„ä¸»é”®åªåŒ…å«ä¸€ä¸ªidåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¯¹åº”çš„undoæ—¥å¿—ä¸­åªéœ€è¦å°†å¾…æ’å…¥è®°å½•çš„idåˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´é•¿åº¦ï¼ˆidåˆ—çš„ç±»å‹ä¸ºINTï¼ŒINTç±»å‹å ç”¨çš„å­˜å‚¨ç©ºé—´é•¿åº¦ä¸º4ä¸ªå­—èŠ‚ï¼‰å’ŒçœŸå®å€¼è®°å½•ä¸‹æ¥ã€‚æœ¬ä¾‹ä¸­æ’å…¥äº†ä¸¤æ¡è®°å½•ï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿä¸¤æ¡ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—: ç¬¬ä¸€æ¡undoæ—¥å¿—çš„undo noä¸º0ï¼Œè®°å½•ä¸»é”®å ç”¨çš„å­˜å‚¨ç©ºé—´é•¿åº¦ä¸º4ï¼ŒçœŸå®å€¼ä¸º1ã€‚ç”»ä¸€ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š ç¬¬äºŒæ¡undoæ—¥å¿—çš„undo noä¸º1ï¼Œè®°å½•ä¸»é”®å ç”¨çš„å­˜å‚¨ç©ºé—´é•¿åº¦ä¸º4ï¼ŒçœŸå®å€¼ä¸º2ã€‚ç”»ä¸€ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼ˆä¸ç¬¬ä¸€æ¡undoæ—¥å¿—å¯¹æ¯”ï¼Œundo noå’Œä¸»é”®å„åˆ—ä¿¡æ¯æœ‰ä¸åŒï¼‰ï¼š ä¸ºäº†æœ€å¤§é™åº¦çš„èŠ‚çœundoæ—¥å¿—å ç”¨çš„å­˜å‚¨ç©ºé—´ï¼Œå’Œæˆ‘ä»¬å‰è¾¹è¯´è¿‡çš„redoæ—¥å¿—ç±»ä¼¼ï¼ŒInnoDBä¼šç»™undoæ—¥å¿—ä¸­çš„æŸäº›å±æ€§è¿›è¡Œå‹ç¼©å¤„ç†ã€‚ â‘ roll_pointeréšè—åˆ—çš„å«ä¹‰roll_pointeræœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæŒ‡å‘è®°å½•å¯¹åº”çš„undoæ—¥å¿—çš„ä¸€ä¸ªæŒ‡é’ˆã€‚æ¯”æ–¹è¯´æˆ‘ä»¬ä¸Šè¾¹å‘undo_demoè¡¨é‡Œæ’å…¥äº†2æ¡è®°å½•ï¼Œæ¯æ¡è®°å½•éƒ½æœ‰ä¸å…¶å¯¹åº”çš„ä¸€æ¡undoæ—¥å¿—ã€‚è®°å½•è¢«å­˜å‚¨åˆ°äº†ç±»å‹ä¸ºFIL_PAGE_INDEXçš„é¡µé¢ä¸­ï¼ˆå°±æ˜¯æˆ‘ä»¬å‰è¾¹ä¸€ç›´æ‰€è¯´çš„æ•°æ®é¡µï¼‰ï¼Œundoæ—¥å¿—è¢«å­˜æ”¾åˆ°äº†ç±»å‹ä¸ºFIL_PAGE_UNDO_LOGçš„é¡µé¢ä¸­ã€‚æ•ˆæœå¦‚å›¾æ‰€ç¤ºï¼š **roll_pointer**æœ¬è´¨å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è®°å½•å¯¹åº”çš„undoæ—¥å¿—ã€‚ 3.2 DELETEæ“ä½œå¯¹åº”çš„undoæ—¥å¿—æ’å…¥åˆ°é¡µé¢ä¸­çš„è®°å½•ä¼šæ ¹æ®è®°å½•å¤´ä¿¡æ¯ä¸­çš„next_recordå±æ€§ç»„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªé“¾è¡¨ç§°ä¹‹ä¸ºæ­£å¸¸è®°å½•é“¾è¡¨ï¼›è¢«åˆ é™¤çš„è®°å½•å…¶å®ä¹Ÿä¼šæ ¹æ®è®°å½•å¤´ä¿¡æ¯ä¸­çš„next_recordå±æ€§ç»„æˆä¸€ä¸ªé“¾è¡¨ï¼Œåªä¸è¿‡è¿™ä¸ªé“¾è¡¨ä¸­çš„è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ï¼Œæ‰€ä»¥ä¹Ÿç§°è¿™ä¸ªé“¾è¡¨ä¸ºåƒåœ¾é“¾è¡¨ã€‚Page Headeréƒ¨åˆ†æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºPAGE_FREEçš„å±æ€§ï¼Œå®ƒæŒ‡å‘ç”±è¢«åˆ é™¤è®°å½•ç»„æˆçš„åƒåœ¾é“¾è¡¨ä¸­çš„å¤´èŠ‚ç‚¹ã€‚æˆ‘ä»¬å…ˆç”»ä¸€ä¸ªå›¾ï¼Œå‡è®¾æ­¤åˆ»æŸä¸ªé¡µé¢ä¸­çš„è®°å½•åˆ†å¸ƒæƒ…å†µæ˜¯è¿™æ ·çš„ï¼ˆè¿™ä¸ªä¸æ˜¯undo_demoè¡¨ä¸­çš„è®°å½•ï¼Œåªæ˜¯æˆ‘ä»¬éšä¾¿ä¸¾çš„ä¸€ä¸ªä¾‹å­ï¼‰ï¼š ä¸ºäº†çªå‡ºä¸»é¢˜ï¼Œåœ¨è¿™ä¸ªç®€åŒ–ç‰ˆçš„ç¤ºæ„å›¾ä¸­ï¼Œæˆ‘ä»¬åªæŠŠè®°å½•çš„delete_maskæ ‡å¿—ä½å±•ç¤ºäº†å‡ºæ¥ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ­£å¸¸è®°å½•é“¾è¡¨ä¸­åŒ…å«äº†3æ¡æ­£å¸¸è®°å½•ï¼Œåƒåœ¾é“¾è¡¨é‡ŒåŒ…å«äº†2æ¡å·²åˆ é™¤è®°å½•ï¼Œåœ¨åƒåœ¾é“¾è¡¨ä¸­çš„è¿™äº›è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ã€‚é¡µé¢çš„Page Headeréƒ¨åˆ†çš„PAGE_FREEå±æ€§çš„å€¼ä»£è¡¨æŒ‡å‘åƒåœ¾é“¾è¡¨å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚å‡è®¾ç°åœ¨æˆ‘ä»¬å‡†å¤‡ä½¿ç”¨DELETEè¯­å¥æŠŠæ­£å¸¸è®°å½•é“¾è¡¨ä¸­çš„æœ€åä¸€æ¡è®°å½•ç»™åˆ é™¤æ‰ï¼Œå…¶å®è¿™ä¸ªåˆ é™¤çš„è¿‡ç¨‹éœ€è¦ç»å†ä¸¤ä¸ªé˜¶æ®µï¼š é˜¶æ®µä¸€ï¼šä»…ä»…å°†è®°å½•çš„delete_maskæ ‡è¯†ä½è®¾ç½®ä¸º1ï¼Œå…¶ä»–çš„ä¸åšä¿®æ”¹ï¼ˆå…¶å®ä¼šä¿®æ”¹è®°å½•çš„trx_idã€roll_pointerè¿™äº›éšè—åˆ—çš„å€¼ï¼‰ã€‚è®¾è®¡InnoDBçš„å¤§å”æŠŠè¿™ä¸ªé˜¶æ®µç§°ä¹‹ä¸ºdelete markã€‚æŠŠè¿™ä¸ªè¿‡ç¨‹ç”»ä¸‹æ¥å°±æ˜¯è¿™æ ·ï¼šå¯ä»¥çœ‹åˆ°ï¼Œæ­£å¸¸è®°å½•é“¾è¡¨ä¸­çš„æœ€åä¸€æ¡è®°å½•çš„delete_maskå€¼è¢«è®¾ç½®ä¸º1ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¢«åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ã€‚ä¹Ÿå°±æ˜¯æ­¤æ—¶è®°å½•å¤„äºä¸€ä¸ªä¸­é—´çŠ¶æ€ã€‚åœ¨åˆ é™¤è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œè¢«åˆ é™¤çš„è®°å½•ä¸€ç›´éƒ½å¤„äºè¿™ç§æ‰€è°“çš„ä¸­é—´çŠ¶æ€ã€‚ ä¸ºå•¥ä¼šæœ‰è¿™ç§å¥‡æ€ªçš„ä¸­é—´çŠ¶æ€å‘¢ï¼Ÿå…¶å®ä¸»è¦æ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªç§°ä¹‹ä¸ºMVCCçš„åŠŸèƒ½ã€‚ é˜¶æ®µäºŒï¼šå½“è¯¥åˆ é™¤è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡æäº¤ä¹‹åï¼Œä¼šæœ‰ä¸“é—¨çš„çº¿ç¨‹åæ¥çœŸæ­£çš„æŠŠè®°å½•åˆ é™¤æ‰ã€‚æ‰€è°“çœŸæ­£çš„åˆ é™¤å°±æ˜¯æŠŠè¯¥è®°å½•ä»æ­£å¸¸è®°å½•é“¾è¡¨ä¸­ç§»é™¤ï¼Œå¹¶ä¸”åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­ï¼Œç„¶åè¿˜è¦è°ƒæ•´ä¸€äº›é¡µé¢çš„å…¶ä»–ä¿¡æ¯ï¼Œæ¯”å¦‚é¡µé¢ä¸­çš„ç”¨æˆ·è®°å½•æ•°é‡PAGE_N_RECSã€ä¸Šæ¬¡æ’å…¥è®°å½•çš„ä½ç½®PAGE_LAST_INSERTã€åƒåœ¾é“¾è¡¨å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆPAGE_FREEã€é¡µé¢ä¸­å¯é‡ç”¨çš„å­—èŠ‚æ•°é‡PAGE_GARBAGEã€è¿˜æœ‰é¡µç›®å½•çš„ä¸€äº›ä¿¡æ¯ç­‰ç­‰ã€‚InnoDBæŠŠè¿™ä¸ªé˜¶æ®µç§°ä¹‹ä¸ºpurgeã€‚æŠŠé˜¶æ®µäºŒæ‰§è¡Œå®Œäº†ï¼Œè¿™æ¡è®°å½•å°±ç®—æ˜¯çœŸæ­£çš„è¢«åˆ é™¤æ‰äº†ã€‚è¿™æ¡å·²åˆ é™¤è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´ä¹Ÿå¯ä»¥è¢«é‡æ–°åˆ©ç”¨äº†ã€‚ç”»ä¸‹æ¥å°±æ˜¯è¿™æ ·ï¼šå°†è¢«åˆ é™¤è®°å½•åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨æ—¶ï¼Œå®é™…ä¸ŠåŠ å…¥åˆ°é“¾è¡¨çš„å¤´èŠ‚ç‚¹å¤„ï¼Œä¼šè·Ÿç€ä¿®æ”¹PAGE_FREEå±æ€§çš„å€¼ã€‚ é¡µé¢çš„Page Headeréƒ¨åˆ†æœ‰ä¸€ä¸ªPAGE_GARBAGEå±æ€§ï¼Œè¯¥å±æ€§è®°å½•ç€å½“å‰é¡µé¢ä¸­å¯é‡ç”¨å­˜å‚¨ç©ºé—´å ç”¨çš„æ€»å­—èŠ‚æ•°ã€‚æ¯å½“æœ‰å·²åˆ é™¤è®°å½•è¢«åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨åï¼Œéƒ½ä¼šæŠŠè¿™ä¸ªPAGE_GARBAGEå±æ€§çš„å€¼åŠ ä¸Šè¯¥å·²åˆ é™¤è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ã€‚PAGE_FREEæŒ‡å‘åƒåœ¾é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œä¹‹åæ¯å½“æ–°æ’å…¥è®°å½•æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­PAGE_FREEæŒ‡å‘çš„å¤´èŠ‚ç‚¹ä»£è¡¨çš„å·²åˆ é™¤è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´æ˜¯å¦è¶³å¤Ÿå®¹çº³è¿™æ¡æ–°æ’å…¥çš„è®°å½•ï¼Œå¦‚æœä¸å¯ä»¥å®¹çº³ï¼Œå°±ç›´æ¥å‘é¡µé¢ä¸­ç”³è¯·æ–°çš„ç©ºé—´æ¥å­˜å‚¨è¿™æ¡è®°å½•ï¼ˆå¹¶ä¸ä¼šå°è¯•éå†æ•´ä¸ªåƒåœ¾é“¾è¡¨ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å®¹çº³æ–°è®°å½•çš„èŠ‚ç‚¹ï¼‰ã€‚å¦‚æœå¯ä»¥å®¹çº³ï¼Œé‚£ä¹ˆç›´æ¥é‡ç”¨è¿™æ¡å·²åˆ é™¤è®°å½•çš„å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”æŠŠPAGE_FREEæŒ‡å‘åƒåœ¾é“¾è¡¨ä¸­çš„ä¸‹ä¸€æ¡å·²åˆ é™¤è®°å½•ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ–°æ’å…¥çš„é‚£æ¡è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°å°äºåƒåœ¾é“¾è¡¨çš„å¤´èŠ‚ç‚¹å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œé‚£å°±æ„å‘³å¤´èŠ‚ç‚¹å¯¹åº”çš„è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´é‡Œæœ‰ä¸€éƒ¨åˆ†ç©ºé—´ç”¨ä¸åˆ°ï¼Œè¿™éƒ¨åˆ†ç©ºé—´å°±è¢«ç§°ä¹‹ä¸ºç¢ç‰‡ç©ºé—´ã€‚é‚£è¿™äº›ç¢ç‰‡ç©ºé—´å²‚ä¸æ˜¯æ°¸è¿œéƒ½ç”¨ä¸åˆ°äº†ä¹ˆï¼Ÿå…¶å®ä¹Ÿä¸æ˜¯ï¼Œè¿™äº›ç¢ç‰‡ç©ºé—´å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¼šè¢«ç»Ÿè®¡åˆ°PAGE_GARBAGEå±æ€§ä¸­ï¼Œè¿™äº›ç¢ç‰‡ç©ºé—´åœ¨æ•´ä¸ªé¡µé¢å¿«ä½¿ç”¨å®Œå‰å¹¶ä¸ä¼šè¢«é‡æ–°åˆ©ç”¨ï¼Œä¸è¿‡å½“é¡µé¢å¿«æ»¡æ—¶ï¼Œå¦‚æœå†æ’å…¥ä¸€æ¡è®°å½•ï¼Œæ­¤æ—¶é¡µé¢ä¸­å¹¶ä¸èƒ½åˆ†é…ä¸€æ¡å®Œæ•´è®°å½•çš„ç©ºé—´ï¼Œè¿™æ—¶å€™ä¼šé¦–å…ˆçœ‹ä¸€çœ‹PAGE_GARBAGEçš„ç©ºé—´å’Œå‰©ä½™å¯åˆ©ç”¨çš„ç©ºé—´åŠ èµ·æ¥æ˜¯ä¸æ˜¯å¯ä»¥å®¹çº³ä¸‹è¿™æ¡è®°å½•ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼ŒInnoDBä¼šå°è¯•é‡æ–°ç»„ç»‡é¡µå†…çš„è®°å½•ï¼Œé‡æ–°ç»„ç»‡çš„è¿‡ç¨‹å°±æ˜¯å…ˆå¼€è¾Ÿä¸€ä¸ªä¸´æ—¶é¡µé¢ï¼ŒæŠŠé¡µé¢å†…çš„è®°å½•ä¾æ¬¡æ’å…¥ä¸€éï¼Œå› ä¸ºä¾æ¬¡æ’å…¥æ—¶å¹¶ä¸ä¼šäº§ç”Ÿç¢ç‰‡ï¼Œä¹‹åå†æŠŠä¸´æ—¶é¡µé¢çš„å†…å®¹å¤åˆ¶åˆ°æœ¬é¡µé¢ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠé‚£äº›ç¢ç‰‡ç©ºé—´éƒ½è§£æ”¾å‡ºæ¥ï¼ˆå¾ˆæ˜¾ç„¶é‡æ–°ç»„ç»‡é¡µé¢å†…çš„è®°å½•æ¯”è¾ƒè€—è´¹æ€§èƒ½ï¼‰ã€‚ ä»ä¸Šè¾¹çš„æè¿°ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨åˆ é™¤è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œåªä¼šç»å†é˜¶æ®µä¸€ï¼Œä¹Ÿå°±æ˜¯delete marké˜¶æ®µï¼ˆæäº¤ä¹‹åæˆ‘ä»¬å°±ä¸ç”¨å›æ»šäº†ï¼Œæ‰€ä»¥åªéœ€è€ƒè™‘å¯¹åˆ é™¤æ“ä½œçš„é˜¶æ®µä¸€åšçš„å½±å“è¿›è¡Œå›æ»šï¼‰ã€‚InnoDBä¸ºæ­¤è®¾è®¡äº†ä¸€ç§ç§°ä¹‹ä¸ºTRX_UNDO_DEL_MARK_RECç±»å‹çš„undoæ—¥å¿—ï¼Œå®ƒçš„å®Œæ•´ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åœ¨å¯¹ä¸€æ¡è®°å½•è¿›è¡Œdelete markæ“ä½œå‰ï¼Œéœ€è¦æŠŠè¯¥è®°å½•çš„æ—§çš„trx_idå’Œroll_pointeréšè—åˆ—çš„å€¼éƒ½ç»™è®°åˆ°å¯¹åº”çš„undoæ—¥å¿—ä¸­æ¥ï¼Œå°±æ˜¯æˆ‘ä»¬å›¾ä¸­æ˜¾ç¤ºçš„old trx_idå’Œold roll_pointerå±æ€§ã€‚è¿™æ ·æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œé‚£å°±æ˜¯å¯ä»¥é€šè¿‡undoæ—¥å¿—çš„old roll_pointeræ‰¾åˆ°è®°å½•åœ¨ä¿®æ”¹ä¹‹å‰å¯¹åº”çš„undoæ—¥å¿—ã€‚æ¯”æ–¹è¯´åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæˆ‘ä»¬å…ˆæ’å…¥äº†ä¸€æ¡è®°å½•ï¼Œç„¶ååˆæ‰§è¡Œå¯¹è¯¥è®°å½•çš„åˆ é™¤æ“ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼šä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰§è¡Œå®Œdelete markæ“ä½œåï¼Œå®ƒå¯¹åº”çš„undoæ—¥å¿—å’ŒINSERTæ“ä½œå¯¹åº”çš„undoæ—¥å¿—å°±ä¸²æˆäº†ä¸€ä¸ªé“¾è¡¨ã€‚è¿™ä¸ªé“¾è¡¨å°±ç§°ä¹‹ä¸ºç‰ˆæœ¬é“¾ã€‚ ä¸ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ä¸åŒï¼Œç±»å‹ä¸ºTRX_UNDO_DEL_MARK_RECçš„undoæ—¥å¿—è¿˜å¤šäº†ä¸€ä¸ªç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæŸä¸ªåˆ—è¢«åŒ…å«åœ¨æŸä¸ªç´¢å¼•ä¸­ï¼Œé‚£ä¹ˆå®ƒçš„ç›¸å…³ä¿¡æ¯å°±åº”è¯¥è¢«è®°å½•åˆ°è¿™ä¸ªç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯éƒ¨åˆ†ï¼Œæ‰€è°“çš„ç›¸å…³ä¿¡æ¯åŒ…æ‹¬è¯¥åˆ—åœ¨è®°å½•ä¸­çš„ä½ç½®ï¼ˆç”¨posè¡¨ç¤ºï¼‰ï¼Œè¯¥åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼ˆç”¨lenè¡¨ç¤ºï¼‰ï¼Œè¯¥åˆ—å®é™…å€¼ï¼ˆç”¨valueè¡¨ç¤ºï¼‰ã€‚æ‰€ä»¥ç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯å­˜å‚¨çš„å†…å®¹å®è´¨ä¸Šå°±æ˜¯&lt;pos, len, value&gt;çš„ä¸€ä¸ªåˆ—è¡¨ã€‚è¿™éƒ¨åˆ†ä¿¡æ¯ä¸»è¦æ˜¯ç”¨åœ¨äº‹åŠ¡æäº¤åï¼Œå¯¹è¯¥ä¸­é—´çŠ¶æ€è®°å½•åšçœŸæ­£åˆ é™¤çš„é˜¶æ®µäºŒï¼Œä¹Ÿå°±æ˜¯purgeé˜¶æ®µä¸­ä½¿ç”¨çš„ã€‚ ç°åœ¨ç»§ç»­åœ¨ä¸Šè¾¹é‚£ä¸ªäº‹åŠ¡idä¸º100çš„äº‹åŠ¡ä¸­åˆ é™¤ä¸€æ¡è®°å½•ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠidä¸º1çš„é‚£æ¡è®°å½•åˆ é™¤æ‰ï¼š 12345678BEGIN; # æ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå‡è®¾è¯¥äº‹åŠ¡çš„idä¸º100# æ’å…¥ä¸¤æ¡è®°å½•INSERT INTO undo_demo(id, key1, col) VALUES (1, &#x27;AWM&#x27;, &#x27;ç‹™å‡»æª&#x27;), (2, &#x27;M416&#x27;, &#x27;æ­¥æª&#x27;); # åˆ é™¤ä¸€æ¡è®°å½• DELETE FROM undo_demo WHERE id = 1; è¿™ä¸ªdelete markæ“ä½œå¯¹åº”çš„undoæ—¥å¿—çš„ç»“æ„å°±æ˜¯è¿™æ ·ï¼š å¯¹ç…§ç€è¿™ä¸ªå›¾ï¼Œæˆ‘ä»¬å¾—æ³¨æ„ä¸‹è¾¹å‡ ç‚¹ï¼š å› ä¸ºè¿™æ¡undoæ—¥å¿—æ˜¯idä¸º100çš„äº‹åŠ¡ä¸­äº§ç”Ÿçš„ç¬¬3æ¡undoæ—¥å¿—ï¼Œæ‰€ä»¥å®ƒå¯¹åº”çš„undo noå°±æ˜¯2ã€‚ åœ¨å¯¹è®°å½•åšdelete markæ“ä½œæ—¶ï¼Œè®°å½•çš„trx_idéšè—åˆ—çš„å€¼æ˜¯100ï¼ˆä¹Ÿå°±æ˜¯è¯´å¯¹è¯¥è®°å½•æœ€è¿‘çš„ä¸€æ¬¡ä¿®æ”¹å°±å‘ç”Ÿåœ¨æœ¬äº‹åŠ¡ä¸­ï¼‰ï¼Œæ‰€ä»¥æŠŠ100å¡«å…¥old trx_idå±æ€§ä¸­ã€‚ç„¶åæŠŠè®°å½•çš„roll_pointeréšè—åˆ—çš„å€¼å–å‡ºæ¥ï¼Œå¡«å…¥old roll_pointerå±æ€§ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡old roll_pointerå±æ€§å€¼æ‰¾åˆ°æœ€è¿‘ä¸€æ¬¡å¯¹è¯¥è®°å½•åšæ”¹åŠ¨æ—¶äº§ç”Ÿçš„undoæ—¥å¿—ã€‚ ç”±äºundo_demoè¡¨ä¸­æœ‰2ä¸ªç´¢å¼•ï¼šä¸€ä¸ªæ˜¯èšç°‡ç´¢å¼•ï¼Œä¸€ä¸ªæ˜¯äºŒçº§ç´¢å¼•idx_key1ã€‚åªè¦æ˜¯åŒ…å«åœ¨ç´¢å¼•ä¸­çš„åˆ—ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ—åœ¨è®°å½•ä¸­çš„ä½ç½®ï¼ˆposï¼‰ï¼Œå ç”¨å­˜å‚¨ç©ºé—´å¤§å°ï¼ˆlenï¼‰å’Œå®é™…å€¼ï¼ˆvalueï¼‰å°±éœ€è¦å­˜å‚¨åˆ°undoæ—¥å¿—ä¸­ã€‚ å¯¹äºä¸»é”®æ¥è¯´ï¼ŒåªåŒ…å«ä¸€ä¸ªidåˆ—ï¼Œå­˜å‚¨åˆ°undoæ—¥å¿—ä¸­çš„ç›¸å…³ä¿¡æ¯åˆ†åˆ«æ˜¯ï¼š posï¼šidåˆ—æ˜¯ä¸»é”®ï¼Œä¹Ÿå°±æ˜¯åœ¨è®°å½•çš„ç¬¬ä¸€ä¸ªåˆ—ï¼Œå®ƒå¯¹åº”çš„poså€¼ä¸º0ã€‚poså ç”¨1ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ lenï¼šidåˆ—çš„ç±»å‹ä¸ºINTï¼Œå ç”¨4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥lençš„å€¼ä¸º4ã€‚lenå ç”¨1ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ valueï¼šåœ¨è¢«åˆ é™¤çš„è®°å½•ä¸­idåˆ—çš„å€¼ä¸º1ï¼Œä¹Ÿå°±æ˜¯valueçš„å€¼ä¸º1ã€‚valueå ç”¨4ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ ç”»ä¸€ä¸ªå›¾æ¼”ç¤ºä¸€ä¸‹å°±æ˜¯è¿™æ ·ï¼š æ‰€ä»¥å¯¹äºidåˆ—æ¥è¯´ï¼Œæœ€ç»ˆå­˜å‚¨çš„ç»“æœå°±æ˜¯&lt;0, 4, 1&gt;ï¼Œå­˜å‚¨è¿™äº›ä¿¡æ¯å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¸º1 + 1 + 4 = 6ä¸ªå­—èŠ‚ã€‚ å¯¹äºidx_key1æ¥è¯´ï¼ŒåªåŒ…å«ä¸€ä¸ªkey1åˆ—ï¼Œå­˜å‚¨åˆ°undoæ—¥å¿—ä¸­çš„ç›¸å…³ä¿¡æ¯åˆ†åˆ«æ˜¯ï¼š posï¼škey1åˆ—æ˜¯æ’åœ¨idåˆ—ã€trx_idåˆ—ã€roll_pointeråˆ—ä¹‹åçš„ï¼Œå®ƒå¯¹åº”çš„poså€¼ä¸º3ã€‚poså ç”¨1ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ lenï¼škey1åˆ—çš„ç±»å‹ä¸ºVARCHAR(100)ï¼Œä½¿ç”¨utf8å­—ç¬¦é›†ï¼Œè¢«åˆ é™¤çš„è®°å½•å®é™…å­˜å‚¨çš„å†…å®¹æ˜¯AWMï¼Œæ‰€ä»¥ä¸€å…±å ç”¨3ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æ‰€ä»¥lençš„å€¼ä¸º3ã€‚lenå ç”¨1ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ valueï¼šåœ¨è¢«åˆ é™¤çš„è®°å½•ä¸­key1åˆ—çš„å€¼ä¸ºAWMï¼Œä¹Ÿå°±æ˜¯valueçš„å€¼ä¸ºAWMã€‚valueå ç”¨3ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚ ç”»ä¸€ä¸ªå›¾æ¼”ç¤ºä¸€ä¸‹å°±æ˜¯è¿™æ ·ï¼š æ‰€ä»¥å¯¹äºkey1åˆ—æ¥è¯´ï¼Œæœ€ç»ˆå­˜å‚¨çš„ç»“æœå°±æ˜¯&lt;3, 3, &#39;AWM&#39;&gt;ï¼Œå­˜å‚¨è¿™äº›ä¿¡æ¯å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¸º1 + 1 + 3 = 5ä¸ªå­—èŠ‚ã€‚ä»ä¸Šè¾¹çš„å™è¿°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ&lt;0, 4, 1&gt;å’Œ&lt;3, 3, &#39;AWM&#39;&gt;å…±å ç”¨11ä¸ªå­—èŠ‚ã€‚ç„¶åindex_col_info lenæœ¬èº«å ç”¨2ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åŠ èµ·æ¥ä¸€å…±å ç”¨13ä¸ªå­—èŠ‚ï¼ŒæŠŠæ•°å­—13å°±å¡«åˆ°äº†index_col_info lençš„å±æ€§ä¸­ã€‚ 3.3 UPDATEæ“ä½œå¯¹åº”çš„undoæ—¥å¿—åœ¨æ‰§è¡ŒUPDATEè¯­å¥æ—¶ï¼ŒInnoDBå¯¹æ›´æ–°ä¸»é”®å’Œä¸æ›´æ–°ä¸»é”®è¿™ä¸¤ç§æƒ…å†µæœ‰æˆªç„¶ä¸åŒçš„å¤„ç†æ–¹æ¡ˆã€‚ â‘ ä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µåœ¨ä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µä¸‹ï¼Œåˆå¯ä»¥ç»†åˆ†ä¸ºè¢«æ›´æ–°çš„åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´ä¸å‘ç”Ÿå˜åŒ–å’Œå‘ç”Ÿå˜åŒ–çš„æƒ…å†µã€‚ å°±åœ°æ›´æ–°ï¼ˆin-place updateï¼‰æ›´æ–°è®°å½•æ—¶ï¼Œå¯¹äºè¢«æ›´æ–°çš„æ¯ä¸ªåˆ—æ¥è¯´ï¼Œå¦‚æœæ›´æ–°åçš„åˆ—å’Œæ›´æ–°å‰çš„åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´éƒ½ä¸€æ ·å¤§ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›è¡Œå°±åœ°æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨åŸè®°å½•çš„åŸºç¡€ä¸Šä¿®æ”¹å¯¹åº”åˆ—çš„å€¼ã€‚ å…ˆåˆ é™¤æ‰æ—§è®°å½•ï¼Œå†æ’å…¥æ–°è®°å½•åœ¨ä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªè¢«æ›´æ–°çš„åˆ—æ›´æ–°å‰å’Œæ›´æ–°åå ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±éœ€è¦å…ˆæŠŠè¿™æ¡æ—§çš„è®°å½•ä»èšç°‡ç´¢å¼•é¡µé¢ä¸­åˆ é™¤æ‰ï¼Œç„¶åå†æ ¹æ®æ›´æ–°ååˆ—çš„å€¼åˆ›å»ºä¸€æ¡æ–°çš„è®°å½•æ’å…¥åˆ°é¡µé¢ä¸­ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ‰€è¯´çš„åˆ é™¤å¹¶ä¸æ˜¯delete markæ“ä½œï¼Œè€Œæ˜¯çœŸæ­£çš„åˆ é™¤æ‰ï¼Œä¹Ÿå°±æ˜¯æŠŠè¿™æ¡è®°å½•ä»æ­£å¸¸è®°å½•é“¾è¡¨ä¸­ç§»é™¤å¹¶åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­ï¼Œå¹¶ä¸”ä¿®æ”¹é¡µé¢ä¸­ç›¸åº”çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¯”å¦‚PAGE_FREEã€PAGE_GARBAGEç­‰è¿™äº›ä¿¡æ¯ï¼‰ã€‚ä¸è¿‡è¿™é‡ŒåšçœŸæ­£åˆ é™¤æ“ä½œçš„çº¿ç¨‹å¹¶ä¸æ˜¯åœ¨DELETEè¯­å¥ä¸­åšpurgeæ“ä½œæ—¶ä½¿ç”¨çš„å¦å¤–ä¸“é—¨çš„çº¿ç¨‹ï¼Œè€Œæ˜¯ç”±ç”¨æˆ·çº¿ç¨‹åŒæ­¥æ‰§è¡ŒçœŸæ­£çš„åˆ é™¤æ“ä½œï¼ŒçœŸæ­£åˆ é™¤ä¹‹åç´§æ¥ç€å°±è¦æ ¹æ®å„ä¸ªåˆ—æ›´æ–°åçš„å€¼åˆ›å»ºçš„æ–°è®°å½•æ’å…¥ã€‚è¿™é‡Œå¦‚æœæ–°åˆ›å»ºçš„è®°å½•å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ä¸è¶…è¿‡æ—§è®°å½•å ç”¨çš„ç©ºé—´ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥é‡ç”¨è¢«åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­çš„æ—§è®°å½•æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´ï¼Œå¦åˆ™çš„è¯éœ€è¦åœ¨é¡µé¢ä¸­æ–°ç”³è¯·ä¸€æ®µç©ºé—´ä»¥ä¾›æ–°è®°å½•ä½¿ç”¨ï¼Œå¦‚æœæœ¬é¡µé¢å†…å·²ç»æ²¡æœ‰å¯ç”¨çš„ç©ºé—´çš„è¯ï¼Œé‚£å°±éœ€è¦è¿›è¡Œé¡µé¢åˆ†è£‚æ“ä½œï¼Œç„¶åå†æ’å…¥æ–°è®°å½•ã€‚ é’ˆå¯¹UPDATEä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µï¼ˆåŒ…æ‹¬ä¸Šè¾¹æ‰€è¯´çš„å°±åœ°æ›´æ–°å’Œå…ˆåˆ é™¤æ—§è®°å½•å†æ’å…¥æ–°è®°å½•ï¼‰ï¼ŒInnoDBè®¾è®¡äº†ä¸€ç§ç±»å‹ä¸ºTRX_UNDO_UPD_EXIST_RECçš„undoæ—¥å¿—`ï¼Œå®ƒçš„å®Œæ•´ç»“æ„å¦‚ä¸‹ï¼š å…¶å®å¤§éƒ¨åˆ†å±æ€§å’Œæˆ‘ä»¬ä»‹ç»è¿‡çš„TRX_UNDO_DEL_MARK_RECç±»å‹çš„undoæ—¥å¿—æ˜¯ç±»ä¼¼çš„ï¼Œä¸è¿‡è¿˜æ˜¯è¦æ³¨æ„è¿™ä¹ˆå‡ ç‚¹ï¼š n_updatedå±æ€§è¡¨ç¤ºæœ¬æ¡UPDATEè¯­å¥æ‰§è¡Œåå°†æœ‰å‡ ä¸ªåˆ—è¢«æ›´æ–°ï¼Œåè¾¹è·Ÿç€çš„&lt;pos, old_len, old_value&gt;åˆ†åˆ«è¡¨ç¤ºè¢«æ›´æ–°åˆ—åœ¨è®°å½•ä¸­çš„ä½ç½®ã€æ›´æ–°å‰è¯¥åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ã€æ›´æ–°å‰è¯¥åˆ—çš„çœŸå®å€¼ã€‚ å¦‚æœåœ¨UPDATEè¯­å¥ä¸­æ›´æ–°çš„åˆ—åŒ…å«ç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆä¹Ÿä¼šæ·»åŠ ç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯è¿™ä¸ªéƒ¨åˆ†ï¼Œå¦åˆ™çš„è¯æ˜¯ä¸ä¼šæ·»åŠ è¿™ä¸ªéƒ¨åˆ†çš„ã€‚ ç°åœ¨ç»§ç»­åœ¨ä¸Šè¾¹é‚£ä¸ªäº‹åŠ¡idä¸º100çš„äº‹åŠ¡ä¸­æ›´æ–°ä¸€æ¡è®°å½•ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠidä¸º2çš„é‚£æ¡è®°å½•æ›´æ–°ä¸€ä¸‹ï¼š 12345678910111213BEGIN; # æ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå‡è®¾è¯¥äº‹åŠ¡çš„idä¸º100# æ’å…¥ä¸¤æ¡è®°å½•INSERT INTO undo_demo(id, key1, col) VALUES (1, &#x27;AWM&#x27;, &#x27;ç‹™å‡»æª&#x27;), (2, &#x27;M416&#x27;, &#x27;æ­¥æª&#x27;); # åˆ é™¤ä¸€æ¡è®°å½• DELETE FROM undo_demo WHERE id = 1; # æ›´æ–°ä¸€æ¡è®°å½•UPDATE undo_demo SET key1 = &#x27;M249&#x27;, col = &#x27;æœºæª&#x27; WHERE id = 2; è¿™ä¸ªUPDATEè¯­å¥æ›´æ–°çš„åˆ—å¤§å°éƒ½æ²¡æœ‰æ”¹åŠ¨ï¼Œæ‰€ä»¥å¯ä»¥é‡‡ç”¨å°±åœ°æ›´æ–°çš„æ–¹å¼æ¥æ‰§è¡Œï¼Œåœ¨çœŸæ­£æ”¹åŠ¨é¡µé¢è®°å½•æ—¶ï¼Œä¼šå…ˆè®°å½•ä¸€æ¡ç±»å‹ä¸ºTRX_UNDO_UPD_EXIST_RECçš„undoæ—¥å¿—ï¼Œé•¿è¿™æ ·ï¼š å¯¹ç…§ç€è¿™ä¸ªå›¾æˆ‘ä»¬æ³¨æ„ä¸€ä¸‹è¿™å‡ ä¸ªåœ°æ–¹ï¼š å› ä¸ºè¿™æ¡undoæ—¥å¿—æ˜¯idä¸º100çš„äº‹åŠ¡ä¸­äº§ç”Ÿçš„ç¬¬4æ¡undoæ—¥å¿—ï¼Œæ‰€ä»¥å®ƒå¯¹åº”çš„undo noå°±æ˜¯3ã€‚ è¿™æ¡æ—¥å¿—çš„roll_pointeræŒ‡å‘undo noä¸º1çš„é‚£æ¡æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯æ’å…¥ä¸»é”®å€¼ä¸º2çš„è®°å½•æ—¶äº§ç”Ÿçš„é‚£æ¡undoæ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯æœ€è¿‘ä¸€æ¬¡å¯¹è¯¥è®°å½•åšæ”¹åŠ¨æ—¶äº§ç”Ÿçš„undoæ—¥å¿—ã€‚ ç”±äºæœ¬æ¡UPDATEè¯­å¥ä¸­æ›´æ–°äº†ç´¢å¼•åˆ—key1çš„å€¼ï¼Œæ‰€ä»¥éœ€è¦è®°å½•ä¸€ä¸‹ç´¢å¼•åˆ—å„åˆ—ä¿¡æ¯éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸»é”®å’Œkey1åˆ—æ›´æ–°å‰çš„ä¿¡æ¯å¡«å…¥ã€‚ â‘¡æ›´æ–°ä¸»é”®çš„æƒ…å†µåœ¨èšç°‡ç´¢å¼•ä¸­ï¼Œè®°å½•æ˜¯æŒ‰ç…§ä¸»é”®å€¼çš„å¤§å°è¿æˆäº†ä¸€ä¸ªå•å‘é“¾è¡¨çš„ï¼Œå¦‚æœæˆ‘ä»¬æ›´æ–°äº†æŸæ¡è®°å½•çš„ä¸»é”®å€¼ï¼Œæ„å‘³ç€è¿™æ¡è®°å½•åœ¨èšç°‡ç´¢å¼•ä¸­çš„ä½ç½®å°†ä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ¯”å¦‚ä½ å°†è®°å½•çš„ä¸»é”®å€¼ä»1æ›´æ–°ä¸º10000ï¼Œå¦‚æœè¿˜æœ‰éå¸¸å¤šçš„è®°å½•çš„ä¸»é”®å€¼åˆ†å¸ƒåœ¨1 ~ 10000ä¹‹é—´çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸¤æ¡è®°å½•åœ¨èšç°‡ç´¢å¼•ä¸­å°±æœ‰å¯èƒ½ç¦»å¾—éå¸¸è¿œï¼Œç”šè‡³ä¸­é—´éš”äº†å¥½å¤šä¸ªé¡µé¢ã€‚é’ˆå¯¹UPDATEè¯­å¥ä¸­æ›´æ–°äº†è®°å½•ä¸»é”®å€¼çš„è¿™ç§æƒ…å†µï¼ŒInnoDBåœ¨èšç°‡ç´¢å¼•ä¸­åˆ†äº†ä¸¤æ­¥å¤„ç†ï¼š å°†æ—§è®°å½•è¿›è¡Œdelete markæ“ä½œé«˜èƒ½æ³¨æ„ï¼šè¿™é‡Œæ˜¯delete markæ“ä½œï¼è¿™é‡Œæ˜¯delete markæ“ä½œï¼è¿™é‡Œæ˜¯delete markæ“ä½œï¼ä¹Ÿå°±æ˜¯è¯´åœ¨UPDATEè¯­å¥æ‰€åœ¨çš„äº‹åŠ¡æäº¤å‰ï¼Œå¯¹æ—§è®°å½•åªåšä¸€ä¸ªdelete markæ“ä½œï¼Œåœ¨äº‹åŠ¡æäº¤åæ‰ç”±ä¸“é—¨çš„çº¿ç¨‹åšpurgeæ“ä½œï¼ŒæŠŠå®ƒåŠ å…¥åˆ°åƒåœ¾é“¾è¡¨ä¸­ã€‚ ä¹‹æ‰€ä»¥åªå¯¹æ—§è®°å½•åšdelete markæ“ä½œï¼Œæ˜¯å› ä¸ºåˆ«çš„äº‹åŠ¡åŒæ—¶ä¹Ÿå¯èƒ½è®¿é—®è¿™æ¡è®°å½•ï¼Œå¦‚æœæŠŠå®ƒçœŸæ­£çš„åˆ é™¤åŠ å…¥åˆ°åƒåœ¾é“¾è¡¨åï¼Œåˆ«çš„äº‹åŠ¡å°±è®¿é—®ä¸åˆ°äº†ã€‚è¿™ä¸ªåŠŸèƒ½å°±æ˜¯æ‰€è°“çš„MVCCã€‚ æ ¹æ®æ›´æ–°åå„åˆ—çš„å€¼åˆ›å»ºä¸€æ¡æ–°è®°å½•ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°èšç°‡ç´¢å¼•ä¸­ï¼ˆéœ€é‡æ–°å®šä½æ’å…¥çš„ä½ç½®ï¼‰ã€‚ç”±äºæ›´æ–°åçš„è®°å½•ä¸»é”®å€¼å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ä»èšç°‡ç´¢å¼•ä¸­å®šä½è¿™æ¡è®°å½•æ‰€åœ¨çš„ä½ç½®ï¼Œç„¶åæŠŠå®ƒæ’è¿›å»ã€‚ é’ˆå¯¹UPDATEè¯­å¥æ›´æ–°è®°å½•ä¸»é”®å€¼çš„è¿™ç§æƒ…å†µï¼Œåœ¨å¯¹è¯¥è®°å½•è¿›è¡Œdelete markæ“ä½œå‰ï¼Œä¼šè®°å½•ä¸€æ¡ç±»å‹ä¸ºTRX_UNDO_DEL_MARK_RECçš„undoæ—¥å¿—ï¼›ä¹‹åæ’å…¥æ–°è®°å½•æ—¶ï¼Œä¼šè®°å½•ä¸€æ¡ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯å¯¹ä¸€æ¡è®°å½•çš„ä¸»é”®å€¼åšæ”¹åŠ¨æ—¶ï¼Œä¼šè®°å½•2æ¡undoæ—¥å¿—ã€‚ 4.é€šç”¨é“¾è¡¨ç»“æ„åœ¨å†™å…¥undoæ—¥å¿—çš„è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨åˆ°å¤šä¸ªé“¾è¡¨ï¼Œå¾ˆå¤šé“¾è¡¨éƒ½æœ‰åŒæ ·çš„èŠ‚ç‚¹ç»“æ„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š åœ¨æŸä¸ªè¡¨ç©ºé—´å†…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªé¡µçš„é¡µå·å’Œåœ¨é¡µå†…çš„åç§»é‡æ¥å”¯ä¸€å®šä½ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ï¼Œè¿™ä¸¤ä¸ªä¿¡æ¯ä¹Ÿå°±ç›¸å½“äºæŒ‡å‘è¿™ä¸ªèŠ‚ç‚¹çš„ä¸€ä¸ªæŒ‡é’ˆã€‚æ‰€ä»¥ï¼š Pre Node Page Numberå’ŒPre Node Offsetçš„ç»„åˆå°±æ˜¯æŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ Next Node Page Numberå’ŒNext Node Offsetçš„ç»„åˆå°±æ˜¯æŒ‡å‘åä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚ æ•´ä¸ªList Nodeå ç”¨12ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚ ä¸ºäº†æ›´å¥½çš„ç®¡ç†é“¾è¡¨ï¼ŒInnoDBè¿˜æå‡ºäº†ä¸€ä¸ªåŸºèŠ‚ç‚¹çš„ç»“æ„ï¼Œé‡Œè¾¹å­˜å‚¨äº†è¿™ä¸ªé“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€å°¾èŠ‚ç‚¹ä»¥åŠé“¾è¡¨é•¿åº¦ä¿¡æ¯ï¼ŒåŸºèŠ‚ç‚¹çš„ç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š å…¶ä¸­ï¼š List Lengthè¡¨æ˜è¯¥é“¾è¡¨ä¸€å…±æœ‰å¤šå°‘èŠ‚ç‚¹ã€‚ First Node Page Numberå’ŒFirst Node Offsetçš„ç»„åˆå°±æ˜¯æŒ‡å‘é“¾è¡¨å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚ Last Node Page Numberå’ŒLast Node Offsetçš„ç»„åˆå°±æ˜¯æŒ‡å‘é“¾è¡¨å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚ æ•´ä¸ªList Base Nodeå ç”¨16ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚ æ‰€ä»¥ä½¿ç”¨List Base Nodeå’ŒList Nodeè¿™ä¸¤ä¸ªç»“æ„ç»„æˆçš„é“¾è¡¨çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š 5.FIL_PAGE_UNDO_LOGé¡µé¢è¡¨ç©ºé—´å…¶å®æ˜¯ç”±è®¸è®¸å¤šå¤šçš„é¡µé¢æ„æˆçš„ï¼Œé¡µé¢é»˜è®¤å¤§å°ä¸º16KBã€‚è¿™äº›é¡µé¢æœ‰ä¸åŒçš„ç±»å‹ï¼Œæ¯”å¦‚ç±»å‹ä¸ºFIL_PAGE_INDEXçš„é¡µé¢ç”¨äºå­˜å‚¨èšç°‡ç´¢å¼•ä»¥åŠäºŒçº§ç´¢å¼•ï¼Œç±»å‹ä¸ºFIL_PAGE_TYPE_FSP_HDRçš„é¡µé¢ç”¨äºå­˜å‚¨è¡¨ç©ºé—´å¤´éƒ¨ä¿¡æ¯çš„ï¼Œè¿˜æœ‰å…¶ä»–å„ç§ç±»å‹çš„é¡µé¢ï¼Œå…¶ä¸­æœ‰ä¸€ç§ç§°ä¹‹ä¸ºFIL_PAGE_UNDO_LOGç±»å‹çš„é¡µé¢æ˜¯ä¸“é—¨ç”¨æ¥å­˜å‚¨undoæ—¥å¿—çš„ï¼Œè¿™ç§ç±»å‹çš„é¡µé¢çš„é€šç”¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆä»¥é»˜è®¤çš„16KBå¤§å°ä¸ºä¾‹ï¼‰ï¼š æˆ‘ä»¬å°±ç®€ç§°ä¸ºUndoé¡µé¢ï¼Œä¸Šå›¾ä¸­çš„File Headerå’ŒFile Traileræ˜¯å„ç§é¡µé¢éƒ½æœ‰çš„é€šç”¨ç»“æ„ã€‚Undo Page Headeræ˜¯Undoé¡µé¢æ‰€ç‰¹æœ‰çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼š å…¶ä¸­å„ä¸ªå±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š TRX_UNDO_PAGE_TYPEï¼šæœ¬é¡µé¢å‡†å¤‡å­˜å‚¨ä»€ä¹ˆç§ç±»çš„undoæ—¥å¿—ã€‚å‰è¾¹ä»‹ç»äº†å¥½å‡ ç§ç±»å‹çš„undoæ—¥å¿—ï¼Œå®ƒä»¬å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼š TRX_UNDO_INSERTï¼ˆä½¿ç”¨åè¿›åˆ¶1è¡¨ç¤ºï¼‰ï¼šç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—å±äºæ­¤å¤§ç±»ï¼Œä¸€èˆ¬ç”±INSERTè¯­å¥äº§ç”Ÿï¼Œæˆ–è€…åœ¨UPDATEè¯­å¥ä¸­æœ‰æ›´æ–°ä¸»é”®çš„æƒ…å†µä¹Ÿä¼šäº§ç”Ÿæ­¤ç±»å‹çš„undoæ—¥å¿—ã€‚ TRX_UNDO_UPDATEï¼ˆä½¿ç”¨åè¿›åˆ¶2è¡¨ç¤ºï¼‰ï¼Œé™¤äº†ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œå…¶ä»–ç±»å‹çš„undoæ—¥å¿—éƒ½å±äºè¿™ä¸ªå¤§ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬å‰è¾¹è¯´çš„TRX_UNDO_DEL_MARK_RECã€TRX_UNDO_UPD_EXIST_RECå•¥çš„ï¼Œä¸€èˆ¬ç”±DELETEã€UPDATEè¯­å¥äº§ç”Ÿçš„undoæ—¥å¿—å±äºè¿™ä¸ªå¤§ç±»ã€‚ è¿™ä¸ªTRX_UNDO_PAGE_TYPEå±æ€§å¯é€‰çš„å€¼å°±æ˜¯ä¸Šè¾¹çš„ä¸¤ä¸ªï¼Œç”¨æ¥æ ‡è®°æœ¬é¡µé¢ç”¨äºå­˜å‚¨å“ªä¸ªå¤§ç±»çš„undoæ—¥å¿—ï¼Œä¸åŒå¤§ç±»çš„undoæ—¥å¿—ä¸èƒ½æ··ç€å­˜å‚¨ï¼Œæ¯”å¦‚ä¸€ä¸ªUndoé¡µé¢çš„TRX_UNDO_PAGE_TYPEå±æ€§å€¼ä¸ºTRX_UNDO_INSERTï¼Œé‚£ä¹ˆè¿™ä¸ªé¡µé¢å°±åªèƒ½å­˜å‚¨ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œå…¶ä»–ç±»å‹çš„undoæ—¥å¿—å°±ä¸èƒ½æ”¾åˆ°è¿™ä¸ªé¡µé¢ä¸­äº†ã€‚ ä¹‹æ‰€ä»¥æŠŠundoæ—¥å¿—åˆ†æˆä¸¤ä¸ªå¤§ç±»ï¼Œæ˜¯å› ä¸ºç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—åœ¨äº‹åŠ¡æäº¤åå¯ä»¥ç›´æ¥åˆ é™¤æ‰ï¼Œè€Œå…¶ä»–ç±»å‹çš„undoæ—¥å¿—è¿˜éœ€è¦ä¸ºæ‰€è°“çš„MVCCæœåŠ¡ï¼Œä¸èƒ½ç›´æ¥åˆ é™¤æ‰ï¼Œå¯¹å®ƒä»¬çš„å¤„ç†éœ€è¦åŒºåˆ«å¯¹å¾…ã€‚ TRX_UNDO_PAGE_STARTï¼šè¡¨ç¤ºåœ¨å½“å‰é¡µé¢ä¸­æ˜¯ä»ä»€ä¹ˆä½ç½®å¼€å§‹å­˜å‚¨undoæ—¥å¿—çš„ï¼Œæˆ–è€…è¯´è¡¨ç¤ºç¬¬ä¸€æ¡undoæ—¥å¿—åœ¨æœ¬é¡µé¢ä¸­çš„èµ·å§‹åç§»é‡ã€‚ TRX_UNDO_PAGE_FREEï¼šä¸ä¸Šè¾¹çš„TRX_UNDO_PAGE_STARTå¯¹åº”ï¼Œè¡¨ç¤ºå½“å‰é¡µé¢ä¸­å­˜å‚¨çš„æœ€åä¸€æ¡undoæ—¥å¿—ç»“æŸæ—¶çš„åç§»é‡ï¼Œæˆ–è€…è¯´ä»è¿™ä¸ªä½ç½®å¼€å§‹ï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ–°çš„undoæ—¥å¿—ã€‚å‡è®¾ç°åœ¨å‘é¡µé¢ä¸­å†™å…¥äº†3æ¡undoæ—¥å¿—ï¼Œé‚£ä¹ˆTRX_UNDO_PAGE_STARTå’ŒTRX_UNDO_PAGE_FREEçš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼šå½“ç„¶ï¼Œåœ¨æœ€åˆä¸€æ¡undoæ—¥å¿—ä¹Ÿæ²¡å†™å…¥çš„æƒ…å†µä¸‹ï¼ŒTRX_UNDO_PAGE_STARTå’ŒTRX_UNDO_PAGE_FREEçš„å€¼æ˜¯ç›¸åŒçš„ã€‚ TRX_UNDO_PAGE_NODEï¼šä»£è¡¨ä¸€ä¸ªList Nodeç»“æ„ï¼ˆé“¾è¡¨çš„æ™®é€šèŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä¸Šè¾¹åˆšè¯´çš„ï¼‰ã€‚ 6.Undoé¡µé¢é“¾è¡¨6.1å•ä¸ªäº‹åŠ¡ä¸­çš„Undoé¡µé¢é“¾è¡¨å› ä¸ºä¸€ä¸ªäº‹åŠ¡å¯èƒ½åŒ…å«å¤šä¸ªè¯­å¥ï¼Œè€Œä¸”ä¸€ä¸ªè¯­å¥å¯èƒ½å¯¹è‹¥å¹²æ¡è®°å½•è¿›è¡Œæ”¹åŠ¨ï¼Œè€Œå¯¹æ¯æ¡è®°å½•è¿›è¡Œæ”¹åŠ¨å‰ï¼Œéƒ½éœ€è¦è®°å½•1æ¡æˆ–2æ¡çš„undoæ—¥å¿—ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿå¾ˆå¤šundoæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—å¯èƒ½ä¸€ä¸ªé¡µé¢æ”¾ä¸ä¸‹ï¼Œéœ€è¦æ”¾åˆ°å¤šä¸ªé¡µé¢ä¸­ï¼Œè¿™äº›é¡µé¢å°±é€šè¿‡æˆ‘ä»¬ä¸Šè¾¹ä»‹ç»çš„TRX_UNDO_PAGE_NODEå±æ€§è¿æˆäº†é“¾è¡¨ï¼š æˆ‘ç‰¹æ„æŠŠé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªUndoé¡µé¢ç»™æ ‡äº†å‡ºæ¥ï¼Œç§°å®ƒä¸ºfirst undo pageï¼Œå…¶ä½™çš„Undoé¡µé¢ç§°ä¹‹ä¸ºnormal undo pageï¼Œè¿™æ˜¯å› ä¸ºåœ¨first undo pageä¸­é™¤äº†è®°å½•Undo Page Headerä¹‹å¤–ï¼Œè¿˜ä¼šè®°å½•å…¶ä»–çš„ä¸€äº›ç®¡ç†ä¿¡æ¯ã€‚ åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ··ç€æ‰§è¡ŒINSERTã€DELETEã€UPDATEè¯­å¥ï¼Œä¹Ÿå°±æ„å‘³ç€ä¼šäº§ç”Ÿä¸åŒç±»å‹çš„undoæ—¥å¿—ã€‚ä½†æ˜¯ï¼ŒåŒä¸€ä¸ªUndoé¡µé¢è¦ä¹ˆåªå­˜å‚¨TRX_UNDO_INSERTå¤§ç±»çš„undoæ—¥å¿—ï¼Œè¦ä¹ˆåªå­˜å‚¨TRX_UNDO_UPDATEå¤§ç±»çš„undoæ—¥å¿—ï¼Œåæ­£ä¸èƒ½æ··ç€å­˜ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å°±å¯èƒ½éœ€è¦2ä¸ªUndoé¡µé¢çš„é“¾è¡¨ï¼Œä¸€ä¸ªç§°ä¹‹ä¸ºinsert undoé“¾è¡¨ï¼Œå¦ä¸€ä¸ªç§°ä¹‹ä¸ºupdate undoé“¾è¡¨ï¼Œç”»ä¸ªç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š å¦å¤–ï¼ŒInnoDBè§„å®šå¯¹æ™®é€šè¡¨å’Œä¸´æ—¶è¡¨çš„è®°å½•æ”¹åŠ¨æ—¶äº§ç”Ÿçš„undoæ—¥å¿—è¦åˆ†åˆ«è®°å½•ï¼ˆæˆ‘ä»¬ç¨åé˜é‡Šä¸ºå•¥è¿™ä¹ˆåšï¼‰ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æœ€å¤šæœ‰4ä¸ªä»¥Undoé¡µé¢ä¸ºèŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ï¼š å½“ç„¶ï¼Œå¹¶ä¸æ˜¯åœ¨äº‹åŠ¡ä¸€å¼€å§‹å°±ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…è¿™4ä¸ªé“¾è¡¨ï¼Œå…·ä½“åˆ†é…ç­–ç•¥å¦‚ä¸‹ï¼š åˆšåˆšå¼€å¯äº‹åŠ¡æ—¶ï¼Œä¸€ä¸ªUndoé¡µé¢é“¾è¡¨ä¹Ÿä¸åˆ†é…ã€‚ å½“äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘æ™®é€šè¡¨ä¸­æ’å…¥è®°å½•æˆ–è€…æ‰§è¡Œæ›´æ–°è®°å½•ä¸»é”®çš„æ“ä½œä¹‹åï¼Œå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªæ™®é€šè¡¨çš„insert undoé“¾è¡¨ã€‚ å½“äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ é™¤æˆ–è€…æ›´æ–°äº†æ™®é€šè¡¨ä¸­çš„è®°å½•ä¹‹åï¼Œå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªæ™®é€šè¡¨çš„update undoé“¾è¡¨ã€‚ å½“äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ä¸´æ—¶è¡¨ä¸­æ’å…¥è®°å½•æˆ–è€…æ‰§è¡Œæ›´æ–°è®°å½•ä¸»é”®çš„æ“ä½œä¹‹åï¼Œå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªä¸´æ—¶è¡¨çš„insert undoé“¾è¡¨ã€‚ å½“äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ é™¤æˆ–è€…æ›´æ–°äº†ä¸´æ—¶è¡¨ä¸­çš„è®°å½•ä¹‹åï¼Œå°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªä¸´æ—¶è¡¨çš„update undoé“¾è¡¨ã€‚ æ€»ç»“ä¸€å¥å°±æ˜¯ï¼šæŒ‰éœ€åˆ†é…ï¼Œå•¥æ—¶å€™éœ€è¦å•¥æ—¶å€™å†åˆ†é…ï¼Œä¸éœ€è¦å°±ä¸åˆ†é…ã€‚ 6.2å¤šä¸ªäº‹åŠ¡ä¸­çš„Undoé¡µé¢é“¾è¡¨ä¸ºäº†å°½å¯èƒ½æé«˜undoæ—¥å¿—çš„å†™å…¥æ•ˆç‡ï¼Œä¸åŒäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„undoæ—¥å¿—éœ€è¦è¢«å†™å…¥åˆ°ä¸åŒçš„Undoé¡µé¢é“¾è¡¨ä¸­ã€‚æ¯”æ–¹è¯´ç°åœ¨æœ‰äº‹åŠ¡idåˆ†åˆ«ä¸º1ã€2çš„ä¸¤ä¸ªäº‹åŠ¡ï¼Œæˆ‘ä»¬åˆ†åˆ«ç§°ä¹‹ä¸ºtrx 1å’Œtrx 2ï¼Œå‡è®¾åœ¨è¿™ä¸¤ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼š trx 1å¯¹æ™®é€šè¡¨åšäº†DELETEæ“ä½œï¼Œå¯¹ä¸´æ—¶è¡¨åšäº†INSERTå’ŒUPDATEæ“ä½œã€‚InnoDBä¼šä¸ºtrx 1åˆ†é…3ä¸ªé“¾è¡¨ï¼Œåˆ†åˆ«æ˜¯ï¼š é’ˆå¯¹æ™®é€šè¡¨çš„update undoé“¾è¡¨ é’ˆå¯¹ä¸´æ—¶è¡¨çš„insert undoé“¾è¡¨ é’ˆå¯¹ä¸´æ—¶è¡¨çš„update undoé“¾è¡¨ã€‚ trx 2å¯¹æ™®é€šè¡¨åšäº†INSERTã€UPDATEå’ŒDELETEæ“ä½œï¼Œæ²¡æœ‰å¯¹ä¸´æ—¶è¡¨åšæ”¹åŠ¨ã€‚InnoDBä¼šä¸ºtrx 2åˆ†é…2ä¸ªé“¾è¡¨ï¼Œåˆ†åˆ«æ˜¯ï¼š é’ˆå¯¹æ™®é€šè¡¨çš„insert undoé“¾è¡¨ é’ˆå¯¹æ™®é€šè¡¨çš„update undoé“¾è¡¨ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨trx 1å’Œtrx 2æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒInnoDBå…±éœ€ä¸ºè¿™ä¸¤ä¸ªäº‹åŠ¡åˆ†é…5ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œç”»ä¸ªå›¾å°±æ˜¯è¿™æ ·ï¼š å¦‚æœæœ‰æ›´å¤šçš„äº‹åŠ¡ï¼Œé‚£å°±æ„å‘³ç€å¯èƒ½ä¼šäº§ç”Ÿæ›´å¤šçš„Undoé¡µé¢é“¾è¡¨ã€‚ 7.undoæ—¥å¿—å…·ä½“å†™å…¥è¿‡ç¨‹7.1æ®µï¼ˆSegmentï¼‰çš„æ¦‚å¿µæ®µæ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œæœ¬è´¨ä¸Šæ˜¯ç”±è‹¥å¹²ä¸ªé›¶æ•£é¡µé¢å’Œè‹¥å¹²ä¸ªå®Œæ•´çš„åŒºç»„æˆçš„ã€‚æ¯”å¦‚ä¸€ä¸ªB+æ ‘ç´¢å¼•è¢«åˆ’åˆ†æˆä¸¤ä¸ªæ®µï¼Œä¸€ä¸ªå¶å­èŠ‚ç‚¹æ®µï¼Œä¸€ä¸ªéå¶å­èŠ‚ç‚¹æ®µï¼Œè¿™æ ·å¶å­èŠ‚ç‚¹å°±å¯ä»¥è¢«å°½å¯èƒ½çš„å­˜åˆ°ä¸€èµ·ï¼Œéå¶å­èŠ‚ç‚¹è¢«å°½å¯èƒ½çš„å­˜åˆ°ä¸€èµ·ã€‚æ¯ä¸€ä¸ªæ®µå¯¹åº”ä¸€ä¸ªINODE Entryç»“æ„ï¼Œè¿™ä¸ªINODE Entryç»“æ„æè¿°äº†è¿™ä¸ªæ®µçš„å„ç§ä¿¡æ¯ï¼Œæ¯”å¦‚æ®µçš„IDï¼Œæ®µå†…çš„å„ç§é“¾è¡¨åŸºèŠ‚ç‚¹ï¼Œé›¶æ•£é¡µé¢çš„é¡µå·æœ‰å“ªäº›ç­‰ä¿¡æ¯ã€‚æˆ‘ä¸ºäº†å®šä½ä¸€ä¸ªINODE Entryï¼ŒInnoDBè®¾è®¡äº†ä¸€ä¸ªSegment Headerçš„ç»“æ„ï¼š æ•´ä¸ªSegment Headerå ç”¨10ä¸ªå­—èŠ‚å¤§å°ï¼Œå„ä¸ªå±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š Space ID of the INODE Entryï¼šINODE Entryç»“æ„æ‰€åœ¨çš„è¡¨ç©ºé—´IDã€‚ Page Number of the INODE Entryï¼šINODE Entryç»“æ„æ‰€åœ¨çš„é¡µé¢é¡µå·ã€‚ Byte Offset of the INODE Entï¼šINODE Entryç»“æ„åœ¨è¯¥é¡µé¢ä¸­çš„åç§»é‡ çŸ¥é“äº†è¡¨ç©ºé—´IDã€é¡µå·ã€é¡µå†…åç§»é‡ï¼Œå°±å¯ä»¥å”¯ä¸€å®šä½ä¸€ä¸ªINODE Entryçš„åœ°å€ã€‚ 7.2Undo Log Segment HeaderInnoDBè§„å®šï¼Œæ¯ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨éƒ½å¯¹åº”ç€ä¸€ä¸ªæ®µï¼Œç§°ä¹‹ä¸ºUndo Log Segmentã€‚ä¹Ÿå°±æ˜¯è¯´é“¾è¡¨ä¸­çš„é¡µé¢éƒ½æ˜¯ä»è¿™ä¸ªæ®µé‡Œè¾¹ç”³è¯·çš„ï¼Œæ‰€ä»¥ä»–ä»¬åœ¨Undoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¾¹æåˆ°çš„first undo pageä¸­è®¾è®¡äº†ä¸€ä¸ªç§°ä¹‹ä¸ºUndo Log Segment Headerçš„éƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†ä¸­åŒ…å«äº†è¯¥é“¾è¡¨å¯¹åº”çš„æ®µçš„segment headerä¿¡æ¯ä»¥åŠå…¶ä»–çš„ä¸€äº›å…³äºè¿™ä¸ªæ®µçš„ä¿¡æ¯ï¼Œæ‰€ä»¥Undoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢å…¶å®é•¿è¿™æ ·ï¼š å¯ä»¥çœ‹åˆ°è¿™ä¸ªUndoé“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢æ¯”æ™®é€šé¡µé¢å¤šäº†ä¸ªUndo Log Segment Headerï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼š å…¶ä¸­å„ä¸ªå±æ€§çš„æ„æ€å¦‚ä¸‹ï¼š TRX_UNDO_STATEï¼šæœ¬Undoé¡µé¢é“¾è¡¨å¤„åœ¨ä»€ä¹ˆçŠ¶æ€ã€‚ä¸€ä¸ªUndo Log Segmentå¯èƒ½å¤„åœ¨çš„çŠ¶æ€åŒ…æ‹¬ï¼š TRX_UNDO_ACTIVEï¼šæ´»è·ƒçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ´»è·ƒçš„äº‹åŠ¡æ­£åœ¨å¾€è¿™ä¸ªæ®µé‡Œè¾¹å†™å…¥undoæ—¥å¿—ã€‚ TRX_UNDO_CACHEDï¼šè¢«ç¼“å­˜çš„çŠ¶æ€ã€‚å¤„åœ¨è¯¥çŠ¶æ€çš„Undoé¡µé¢é“¾è¡¨ç­‰å¾…ç€ä¹‹åè¢«å…¶ä»–äº‹åŠ¡é‡ç”¨ã€‚ TRX_UNDO_TO_FREEï¼šå¯¹äºinsert undoé“¾è¡¨æ¥è¯´ï¼Œå¦‚æœåœ¨å®ƒå¯¹åº”çš„äº‹åŠ¡æäº¤ä¹‹åï¼Œè¯¥é“¾è¡¨ä¸èƒ½è¢«é‡ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå¤„äºè¿™ç§çŠ¶æ€ã€‚ TRX_UNDO_TO_PURGEï¼šå¯¹äºupdate undoé“¾è¡¨æ¥è¯´ï¼Œå¦‚æœåœ¨å®ƒå¯¹åº”çš„äº‹åŠ¡æäº¤ä¹‹åï¼Œè¯¥é“¾è¡¨ä¸èƒ½è¢«é‡ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå¤„äºè¿™ç§çŠ¶æ€ã€‚ TRX_UNDO_PREPAREDï¼šåŒ…å«å¤„äºPREPAREé˜¶æ®µçš„äº‹åŠ¡äº§ç”Ÿçš„undoæ—¥å¿—ã€‚ TRX_UNDO_LAST_LOGï¼šæœ¬Undoé¡µé¢é“¾è¡¨ä¸­æœ€åä¸€ä¸ªUndo Log Headerçš„ä½ç½®ã€‚ TRX_UNDO_FSEG_HEADERï¼šæœ¬Undoé¡µé¢é“¾è¡¨å¯¹åº”çš„æ®µçš„Segment Headerä¿¡æ¯ã€‚ TRX_UNDO_PAGE_LISTï¼šUndoé¡µé¢é“¾è¡¨çš„åŸºèŠ‚ç‚¹ã€‚ Undoé¡µé¢çš„Undo Page Headeréƒ¨åˆ†æœ‰ä¸€ä¸ª12å­—èŠ‚å¤§å°çš„TRX_UNDO_PAGE_NODEå±æ€§ï¼Œè¿™ä¸ªå±æ€§ä»£è¡¨ä¸€ä¸ªList Nodeç»“æ„ã€‚æ¯ä¸€ä¸ªUndoé¡µé¢éƒ½åŒ…å«Undo Page Headerç»“æ„ï¼Œè¿™äº›é¡µé¢å°±å¯ä»¥é€šè¿‡è¿™ä¸ªå±æ€§è¿æˆä¸€ä¸ªé“¾è¡¨ã€‚è¿™ä¸ªTRX_UNDO_PAGE_LISTå±æ€§ä»£è¡¨ç€è¿™ä¸ªé“¾è¡¨çš„åŸºèŠ‚ç‚¹ï¼Œå½“ç„¶è¿™ä¸ªåŸºèŠ‚ç‚¹åªå­˜åœ¨äºUndoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯first undo pageä¸­ã€‚ 7.3Undo Log Headerä¸€ä¸ªäº‹åŠ¡åœ¨å‘Undoé¡µé¢ä¸­å†™å…¥undoæ—¥å¿—æ—¶çš„æ–¹å¼æ˜¯ååˆ†ç®€å•æš´åŠ›çš„ï¼Œå°±æ˜¯ç›´æ¥å¾€é‡Œæ€¼ï¼Œå†™å®Œä¸€æ¡ç´§æ¥ç€å†™å¦ä¸€æ¡ï¼Œå„æ¡undoæ—¥å¿—ä¹‹é—´æ˜¯äº²å¯†æ— é—´çš„ã€‚å†™å®Œä¸€ä¸ªUndoé¡µé¢åï¼Œå†ä»æ®µé‡Œç”³è¯·ä¸€ä¸ªæ–°é¡µé¢ï¼Œç„¶åæŠŠè¿™ä¸ªé¡µé¢æ’å…¥åˆ°Undoé¡µé¢é“¾è¡¨ä¸­ï¼Œç»§ç»­å¾€è¿™ä¸ªæ–°ç”³è¯·çš„é¡µé¢ä¸­å†™ã€‚InnoDBè®¤ä¸ºåŒä¸€ä¸ªäº‹åŠ¡å‘ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨ä¸­å†™å…¥çš„undoæ—¥å¿—ç®—æ˜¯ä¸€ä¸ªç»„ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬ä¸Šè¾¹ä»‹ç»çš„trx 1ç”±äºä¼šåˆ†é…3ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œä¹Ÿå°±ä¼šå†™å…¥3ä¸ªç»„çš„undoæ—¥å¿—ï¼›trx 2ç”±äºä¼šåˆ†é…2ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œä¹Ÿå°±ä¼šå†™å…¥2ä¸ªç»„çš„undoæ—¥å¿—ã€‚åœ¨æ¯å†™å…¥ä¸€ç»„undoæ—¥å¿—æ—¶ï¼Œéƒ½ä¼šåœ¨è¿™ç»„undoæ—¥å¿—å‰å…ˆè®°å½•ä¸€ä¸‹å…³äºè¿™ä¸ªç»„çš„ä¸€äº›å±æ€§ï¼ŒInnoDBæŠŠå­˜å‚¨è¿™äº›å±æ€§çš„åœ°æ–¹ç§°ä¹‹ä¸ºUndo Log Headerã€‚æ‰€ä»¥Undoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢åœ¨çœŸæ­£å†™å…¥undoæ—¥å¿—å‰ï¼Œå…¶å®éƒ½ä¼šè¢«å¡«å……Undo Page Headerã€Undo Log Segment Headerã€Undo Log Headerè¿™3ä¸ªéƒ¨åˆ†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š è¿™ä¸ªUndo Log Headerå…·ä½“çš„ç»“æ„å¦‚ä¸‹ï¼š æˆ‘ä»¬å…ˆå¤§è‡´çœ‹ä¸€ä¸‹å®ƒä»¬éƒ½æ˜¯å•¥æ„æ€ï¼š TRX_UNDO_TRX_IDï¼šç”Ÿæˆæœ¬ç»„undoæ—¥å¿—çš„äº‹åŠ¡idã€‚ TRX_UNDO_TRX_NOï¼šäº‹åŠ¡æäº¤åç”Ÿæˆçš„ä¸€ä¸ªéœ€è¦åºå·ï¼Œä½¿ç”¨æ­¤åºå·æ¥æ ‡è®°äº‹åŠ¡çš„æäº¤é¡ºåºï¼ˆå…ˆæäº¤çš„æ­¤åºå·å°ï¼Œåæäº¤çš„æ­¤åºå·å¤§ï¼‰ã€‚ TRX_UNDO_DEL_MARKSï¼šæ ‡è®°æœ¬ç»„undoæ—¥å¿—ä¸­æ˜¯å¦åŒ…å«ç”±äºDelete markæ“ä½œäº§ç”Ÿçš„undoæ—¥å¿—ã€‚ TRX_UNDO_LOG_STARTï¼šè¡¨ç¤ºæœ¬ç»„undoæ—¥å¿—ä¸­ç¬¬ä¸€æ¡undoæ—¥å¿—çš„åœ¨é¡µé¢ä¸­çš„åç§»é‡ã€‚ TRX_UNDO_XID_EXISTSï¼šæœ¬ç»„undoæ—¥å¿—æ˜¯å¦åŒ…å«XIDä¿¡æ¯ã€‚ TRX_UNDO_DICT_TRANSï¼šæ ‡è®°æœ¬ç»„undoæ—¥å¿—æ˜¯ä¸æ˜¯ç”±DDLè¯­å¥äº§ç”Ÿçš„ã€‚ TRX_UNDO_TABLE_IDï¼šå¦‚æœTRX_UNDO_DICT_TRANSä¸ºçœŸï¼Œé‚£ä¹ˆæœ¬å±æ€§è¡¨ç¤ºDDLè¯­å¥æ“ä½œçš„è¡¨çš„table idã€‚ TRX_UNDO_NEXT_LOGï¼šä¸‹ä¸€ç»„çš„undoæ—¥å¿—åœ¨é¡µé¢ä¸­å¼€å§‹çš„åç§»é‡ã€‚ TRX_UNDO_PREV_LOGï¼šä¸Šä¸€ç»„çš„undoæ—¥å¿—åœ¨é¡µé¢ä¸­å¼€å§‹çš„åç§»é‡ã€‚ ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨åªå­˜å‚¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç»„undoæ—¥å¿—ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šåœ¨ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œä¹‹åå¼€å¯çš„äº‹åŠ¡é‡å¤åˆ©ç”¨è¿™ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªUndoé¡µé¢ä¸­å¯èƒ½å­˜æ”¾å¤šç»„Undoæ—¥å¿—ï¼ŒTRX_UNDO_NEXT_LOGå’ŒTRX_UNDO_PREV_LOGå°±æ˜¯ç”¨æ¥æ ‡è®°ä¸‹ä¸€ç»„å’Œä¸Šä¸€ç»„undoæ—¥å¿—åœ¨é¡µé¢ä¸­çš„åç§»é‡çš„ã€‚ TRX_UNDO_HISTORY_NODEï¼šä¸€ä¸ª12å­—èŠ‚çš„List Nodeç»“æ„ï¼Œä»£è¡¨ä¸€ä¸ªç§°ä¹‹ä¸ºHistoryé“¾è¡¨çš„èŠ‚ç‚¹ã€‚ 7.4å°ç»“å¯¹äºæ²¡æœ‰è¢«é‡ç”¨çš„Undoé¡µé¢é“¾è¡¨æ¥è¯´ï¼Œé“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯first undo pageåœ¨çœŸæ­£å†™å…¥undoæ—¥å¿—å‰ï¼Œä¼šå¡«å……Undo Page Headerã€Undo Log Segment Headerã€Undo Log Headerè¿™3ä¸ªéƒ¨åˆ†ï¼Œä¹‹åæ‰å¼€å§‹æ­£å¼å†™å…¥undoæ—¥å¿—ã€‚å¯¹äºå…¶ä»–çš„é¡µé¢æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯normal undo pageåœ¨çœŸæ­£å†™å…¥undoæ—¥å¿—å‰ï¼Œåªä¼šå¡«å……Undo Page Headerã€‚é“¾è¡¨çš„List Base Nodeå­˜æ”¾åˆ°first undo pageçš„Undo Log Segment Headeréƒ¨åˆ†ï¼ŒList Nodeä¿¡æ¯å­˜æ”¾åˆ°æ¯ä¸€ä¸ªUndoé¡µé¢çš„undo Page Headeréƒ¨åˆ†ï¼Œæ‰€ä»¥ç”»ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨çš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·ï¼š 8.é‡ç”¨Undoé¡µé¢ä¸ºäº†èƒ½æé«˜å¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡å†™å…¥undoæ—¥å¿—çš„æ€§èƒ½ï¼ŒInnoDBå†³å®šä¸ºæ¯ä¸ªäº‹åŠ¡å•ç‹¬åˆ†é…ç›¸åº”çš„Undoé¡µé¢é“¾è¡¨ï¼ˆæœ€å¤šå¯èƒ½å•ç‹¬åˆ†é…4ä¸ªé“¾è¡¨ï¼‰ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿé€ æˆäº†ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚å…¶å®å¤§éƒ¨åˆ†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½åªä¿®æ”¹äº†ä¸€æ¡æˆ–å‡ æ¡è®°å½•ï¼Œé’ˆå¯¹æŸä¸ªUndoé¡µé¢é“¾è¡¨åªäº§ç”Ÿäº†éå¸¸å°‘çš„undoæ—¥å¿—ï¼Œè¿™äº›undoæ—¥å¿—å¯èƒ½åªå ç”¨ä¸€ç‚¹å­˜å‚¨ç©ºé—´ï¼Œæ¯å¼€å¯ä¸€ä¸ªäº‹åŠ¡å°±æ–°åˆ›å»ºä¸€ä¸ªUndoé¡µé¢é“¾è¡¨ï¼ˆè™½ç„¶è¿™ä¸ªé“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªé¡µé¢ï¼‰æ¥å­˜å‚¨è¿™ä¹ˆä¸€ç‚¹undoæ—¥å¿—å²‚ä¸æ˜¯å¤ªæµªè´¹äº†ä¹ˆï¼Ÿçš„ç¡®æ˜¯æŒºæµªè´¹ï¼Œäºæ˜¯InnoDBå†³å®šåœ¨äº‹åŠ¡æäº¤ååœ¨æŸäº›æƒ…å†µä¸‹é‡ç”¨è¯¥äº‹åŠ¡çš„Undoé¡µé¢é“¾è¡¨ã€‚ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨æ˜¯å¦å¯ä»¥è¢«é‡ç”¨çš„æ¡ä»¶å¾ˆç®€å•ï¼š è¯¥é“¾è¡¨ä¸­åªåŒ…å«ä¸€ä¸ªUndoé¡µé¢ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†éå¸¸å¤šçš„undoæ—¥å¿—ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ç”³è¯·éå¸¸å¤šçš„é¡µé¢åŠ å…¥åˆ°Undoé¡µé¢é“¾è¡¨ä¸­ã€‚åœ¨è¯¥äº‹ç‰©æäº¤åï¼Œå¦‚æœå°†æ•´ä¸ªé“¾è¡¨ä¸­çš„é¡µé¢éƒ½é‡ç”¨ï¼Œé‚£å°±æ„å‘³ç€å³ä½¿æ–°çš„äº‹åŠ¡å¹¶æ²¡æœ‰å‘è¯¥Undoé¡µé¢é“¾è¡¨ä¸­å†™å…¥å¾ˆå¤šundoæ—¥å¿—ï¼Œé‚£è¯¥é“¾è¡¨ä¸­ä¹Ÿå¾—ç»´æŠ¤éå¸¸å¤šçš„é¡µé¢ï¼Œé‚£äº›ç”¨ä¸åˆ°çš„é¡µé¢ä¹Ÿä¸èƒ½è¢«åˆ«çš„äº‹åŠ¡æ‰€ä½¿ç”¨ï¼Œè¿™æ ·å°±é€ æˆäº†å¦ä¸€ç§æµªè´¹ã€‚æ‰€ä»¥InnoDBè§„å®šï¼Œåªæœ‰åœ¨Undoé¡µé¢é“¾è¡¨ä¸­åªåŒ…å«ä¸€ä¸ªUndoé¡µé¢æ—¶ï¼Œè¯¥é“¾è¡¨æ‰å¯ä»¥è¢«ä¸‹ä¸€ä¸ªäº‹åŠ¡æ‰€é‡ç”¨ã€‚ è¯¥Undoé¡µé¢å·²ç»ä½¿ç”¨çš„ç©ºé—´å°äºæ•´ä¸ªé¡µé¢ç©ºé—´çš„3/4ã€‚ Undoé¡µé¢é“¾è¡¨æŒ‰ç…§å­˜å‚¨çš„undoæ—¥å¿—æ‰€å±çš„å¤§ç±»å¯ä»¥è¢«åˆ†ä¸ºinsert undoé“¾è¡¨å’Œupdate undoé“¾è¡¨ä¸¤ç§ï¼Œè¿™ä¸¤ç§é“¾è¡¨åœ¨è¢«é‡ç”¨æ—¶çš„ç­–ç•¥ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹ä¸€ä¸‹ï¼š insert undoé“¾è¡¨insert undoé“¾è¡¨ä¸­åªå­˜å‚¨ç±»å‹ä¸ºTRX_UNDO_INSERT_RECçš„undoæ—¥å¿—ï¼Œè¿™ç§ç±»å‹çš„undoæ—¥å¿—åœ¨äº‹åŠ¡æäº¤ä¹‹åå°±æ²¡ç”¨äº†ï¼Œå°±å¯ä»¥è¢«æ¸…é™¤æ‰ã€‚æ‰€ä»¥åœ¨æŸä¸ªäº‹åŠ¡æäº¤åï¼Œé‡ç”¨è¿™ä¸ªäº‹åŠ¡çš„insert undoé“¾è¡¨ï¼ˆè¿™ä¸ªé“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªé¡µé¢ï¼‰æ—¶ï¼Œå¯ä»¥ç›´æ¥æŠŠä¹‹å‰äº‹åŠ¡å†™å…¥çš„ä¸€ç»„undoæ—¥å¿—è¦†ç›–æ‰ï¼Œä»å¤´å¼€å§‹å†™å…¥æ–°äº‹åŠ¡çš„ä¸€ç»„undoæ—¥å¿—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šå¦‚å›¾æ‰€ç¤ºï¼Œå‡è®¾æœ‰ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨çš„insert undoé“¾è¡¨ï¼Œåˆ°äº‹åŠ¡æäº¤æ—¶ï¼Œåªå‘insert undoé“¾è¡¨ä¸­æ’å…¥äº†3æ¡undoæ—¥å¿—ï¼Œè¿™ä¸ªinsert undoé“¾è¡¨åªç”³è¯·äº†ä¸€ä¸ªUndoé¡µé¢ã€‚å‡è®¾æ­¤åˆ»è¯¥é¡µé¢å·²ä½¿ç”¨çš„ç©ºé—´å°äºæ•´ä¸ªé¡µé¢å¤§å°çš„3/4ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªäº‹åŠ¡å°±å¯ä»¥é‡ç”¨è¿™ä¸ªinsert undoé“¾è¡¨ï¼ˆé“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªé¡µé¢)ã€‚å‡è®¾æ­¤æ—¶æœ‰ä¸€ä¸ªæ–°äº‹åŠ¡é‡ç”¨äº†è¯¥insert undoé“¾è¡¨ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æŠŠæ—§çš„ä¸€ç»„undoæ—¥å¿—è¦†ç›–æ‰ï¼Œå†™å…¥ä¸€ç»„æ–°çš„undoæ—¥å¿—ã€‚ åœ¨é‡ç”¨Undoé¡µé¢é“¾è¡¨å†™å…¥æ–°çš„ä¸€ç»„undoæ—¥å¿—æ—¶ï¼Œä¸ä»…ä¼šå†™å…¥æ–°çš„Undo Log Headerï¼Œè¿˜ä¼šé€‚å½“è°ƒæ•´Undo Page Headerã€Undo Log Segment Headerã€Undo Log Headerä¸­çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚TRX_UNDO_PAGE_STARTã€TRX_UNDO_PAGE_FREEç­‰ç­‰ã€‚ update undoé“¾è¡¨åœ¨ä¸€ä¸ªäº‹åŠ¡æäº¤åï¼Œå®ƒçš„update undoé“¾è¡¨ä¸­çš„undoæ—¥å¿—ä¹Ÿä¸èƒ½ç«‹å³åˆ é™¤æ‰ï¼ˆè¿™äº›æ—¥å¿—ç”¨äºMVCCï¼‰ã€‚æ‰€ä»¥å¦‚æœä¹‹åçš„äº‹åŠ¡æƒ³é‡ç”¨update undoé“¾è¡¨æ—¶ï¼Œå°±ä¸èƒ½è¦†ç›–ä¹‹å‰äº‹åŠ¡å†™å…¥çš„undoæ—¥å¿—ã€‚è¿™æ ·å°±ç›¸å½“äºåœ¨åŒä¸€ä¸ªUndoé¡µé¢ä¸­å†™å…¥äº†å¤šç»„çš„undoæ—¥å¿—ï¼Œæ•ˆæœçœ‹èµ·æ¥å°±æ˜¯è¿™æ ·ï¼š 9.å›æ»šæ®µ9.1å›æ»šæ®µçš„æ¦‚å¿µä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æœ€å¤šå¯ä»¥åˆ†é…4ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œåœ¨åŒä¸€æ—¶åˆ»ä¸åŒäº‹åŠ¡æ‹¥æœ‰çš„Undoé¡µé¢é“¾è¡¨æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥åœ¨åŒä¸€æ—¶åˆ»ç³»ç»Ÿé‡Œå…¶å®å¯ä»¥æœ‰è®¸è®¸å¤šå¤šä¸ªUndoé¡µé¢é“¾è¡¨å­˜åœ¨ã€‚ä¸ºäº†æ›´å¥½çš„ç®¡ç†è¿™äº›é“¾è¡¨ï¼ŒInnoDBåˆè®¾è®¡äº†ä¸€ä¸ªç§°ä¹‹ä¸ºRollback Segment Headerçš„é¡µé¢ï¼Œåœ¨è¿™ä¸ªé¡µé¢ä¸­å­˜æ”¾äº†å„ä¸ªUndoé¡µé¢é“¾è¡¨çš„frist undo pageçš„é¡µå·ï¼Œè¿™äº›é¡µå·ç§°ä¹‹ä¸ºundo slotã€‚å¯ä»¥è¿™æ ·ç†è§£ï¼Œæ¯ä¸ªUndoé¡µé¢é“¾è¡¨éƒ½ç›¸å½“äºæ˜¯ä¸€ä¸ªç­ï¼Œè¿™ä¸ªé“¾è¡¨çš„first undo pageå°±ç›¸å½“äºè¿™ä¸ªç­çš„ç­é•¿ï¼Œæ‰¾åˆ°äº†è¿™ä¸ªç­çš„ç­é•¿ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç­é‡Œçš„å…¶ä»–åŒå­¦ï¼ˆå…¶ä»–åŒå­¦ç›¸å½“äºnormal undo pageï¼‰ã€‚æœ‰æ—¶å€™å­¦æ ¡éœ€è¦å‘è¿™äº›ç­çº§ä¼ è¾¾ä¸€ä¸‹ç²¾ç¥ï¼Œå°±éœ€è¦æŠŠç­é•¿éƒ½å¬é›†åœ¨ä¼šè®®å®¤ï¼Œè¿™ä¸ªRollback Segment Headerå°±ç›¸å½“äºæ˜¯ä¸€ä¸ªä¼šè®®å®¤ã€‚ æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªç§°ä¹‹ä¸ºRollback Segment Headerçš„é¡µé¢é•¿å•¥æ ·ï¼ˆä»¥é»˜è®¤çš„16KBä¸ºä¾‹ï¼‰ï¼š InnoDBè§„å®šï¼Œæ¯ä¸€ä¸ªRollback Segment Headeré¡µé¢éƒ½å¯¹åº”ç€ä¸€ä¸ªæ®µï¼Œè¿™ä¸ªæ®µå°±ç§°ä¸ºRollback Segmentï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯å›æ»šæ®µã€‚ä¸ä¹‹å‰ä»‹ç»çš„å„ç§æ®µä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªRollback Segmenté‡Œå…¶å®åªæœ‰ä¸€ä¸ªé¡µé¢ã€‚ äº†è§£äº†Rollback Segmentçš„å«ä¹‰ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªç§°ä¹‹ä¸ºRollback Segment Headerçš„é¡µé¢çš„å„ä¸ªéƒ¨åˆ†çš„å«ä¹‰éƒ½æ˜¯å•¥æ„æ€ï¼š TRX_RSEG_MAX_SIZEï¼šæœ¬Rollback Segmentä¸­ç®¡ç†çš„æ‰€æœ‰Undoé¡µé¢é“¾è¡¨ä¸­çš„Undoé¡µé¢æ•°é‡ä¹‹å’Œçš„æœ€å¤§å€¼ã€‚æ¢å¥è¯è¯´ï¼Œæœ¬Rollback Segmentä¸­æ‰€æœ‰Undoé¡µé¢é“¾è¡¨ä¸­çš„Undoé¡µé¢æ•°é‡ä¹‹å’Œä¸èƒ½è¶…è¿‡TRX_RSEG_MAX_SIZEä»£è¡¨çš„å€¼ã€‚è¯¥å±æ€§çš„å€¼é»˜è®¤ä¸ºæ— é™å¤§ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æƒ³å†™å¤šå°‘Undoé¡µé¢éƒ½å¯ä»¥ã€‚ æ— é™å¤§å…¶å®ä¹Ÿåªæ˜¯ä¸ªå¤¸å¼ çš„è¯´æ³•ï¼Œ4ä¸ªå­—èŠ‚èƒ½è¡¨ç¤ºæœ€å¤§çš„æ•°ä¹Ÿå°±æ˜¯0xFFFFFFFFï¼Œä½†æ˜¯0xFFFFFFFFè¿™ä¸ªæ•°æœ‰ç‰¹æ®Šç”¨é€”ï¼Œæ‰€ä»¥å®é™…ä¸ŠTRX_RSEG_MAX_SIZEçš„å€¼ä¸º0xFFFFFFFEã€‚ TRX_RSEG_HISTORY_SIZEï¼šHistoryé“¾è¡¨å ç”¨çš„é¡µé¢æ•°é‡ã€‚ TRX_RSEG_HISTORYï¼šHistoryé“¾è¡¨çš„åŸºèŠ‚ç‚¹ã€‚ TRX_RSEG_FSEG_HEADERï¼šæœ¬Rollback Segmentå¯¹åº”çš„10å­—èŠ‚å¤§å°çš„Segment Headerç»“æ„ï¼Œé€šè¿‡å®ƒå¯ä»¥æ‰¾åˆ°æœ¬æ®µå¯¹åº”çš„INODE Entryã€‚ TRX_RSEG_UNDO_SLOTSï¼šå„ä¸ªUndoé¡µé¢é“¾è¡¨çš„first undo pageçš„é¡µå·é›†åˆï¼Œä¹Ÿå°±æ˜¯undo sloté›†åˆã€‚ä¸€ä¸ªé¡µå·å ç”¨4ä¸ªå­—èŠ‚ï¼Œå¯¹äº16KBå¤§å°çš„é¡µé¢æ¥è¯´ï¼Œè¿™ä¸ªTRX_RSEG_UNDO_SLOTSéƒ¨åˆ†å…±å­˜å‚¨äº†1024ä¸ªundo slotï¼Œæ‰€ä»¥å…±éœ€1024 Ã— 4 = 4096ä¸ªå­—èŠ‚ã€‚ 9.2 ä»å›æ»šæ®µä¸­ç”³è¯·Undoé¡µé¢é“¾è¡¨åˆå§‹æƒ…å†µä¸‹ï¼Œç”±äºæœªå‘ä»»ä½•äº‹åŠ¡åˆ†é…ä»»ä½•Undoé¡µé¢é“¾è¡¨ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ªRollback Segment Headeré¡µé¢æ¥è¯´ï¼Œå®ƒçš„å„ä¸ªundo slotéƒ½è¢«è®¾ç½®æˆäº†ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼šFIL_NULLï¼ˆå¯¹åº”çš„åå…­è¿›åˆ¶å°±æ˜¯0xFFFFFFFFï¼‰ï¼Œè¡¨ç¤ºè¯¥undo slotä¸æŒ‡å‘ä»»ä½•é¡µé¢ã€‚ éšç€æ—¶é—´çš„æµé€ï¼Œå¼€å§‹æœ‰äº‹åŠ¡éœ€è¦åˆ†é…Undoé¡µé¢é“¾è¡¨äº†ï¼Œå°±ä»å›æ»šæ®µçš„ç¬¬ä¸€ä¸ªundo slotå¼€å§‹ï¼Œçœ‹çœ‹è¯¥undo slotçš„å€¼æ˜¯ä¸æ˜¯FIL_NULLï¼š å¦‚æœæ˜¯FIL_NULLï¼Œé‚£ä¹ˆåœ¨è¡¨ç©ºé—´ä¸­æ–°åˆ›å»ºä¸€ä¸ªæ®µï¼ˆä¹Ÿå°±æ˜¯Undo Log Segmentï¼‰ï¼Œç„¶åä»æ®µé‡Œç”³è¯·ä¸€ä¸ªé¡µé¢ä½œä¸ºUndoé¡µé¢é“¾è¡¨çš„first undo pageï¼Œç„¶åæŠŠè¯¥undo slotçš„å€¼è®¾ç½®ä¸ºåˆšåˆšç”³è¯·çš„è¿™ä¸ªé¡µé¢çš„é¡µå·ï¼Œè¿™æ ·ä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªundo slotè¢«åˆ†é…ç»™äº†è¿™ä¸ªäº‹åŠ¡ã€‚ å¦‚æœä¸æ˜¯FIL_NULLï¼Œè¯´æ˜è¯¥undo slotå·²ç»æŒ‡å‘äº†ä¸€ä¸ªundoé“¾è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªundo slotå·²ç»è¢«åˆ«çš„äº‹åŠ¡å ç”¨äº†ï¼Œé‚£å°±è·³åˆ°ä¸‹ä¸€ä¸ªundo slotï¼Œåˆ¤æ–­è¯¥undo slotçš„å€¼æ˜¯ä¸æ˜¯FIL_NULLï¼Œé‡å¤ä¸Šè¾¹çš„æ­¥éª¤ã€‚ ä¸€ä¸ªRollback Segment Headeré¡µé¢ä¸­åŒ…å«1024ä¸ªundo slotï¼Œå¦‚æœè¿™1024ä¸ªundo slotçš„å€¼éƒ½ä¸ä¸ºFIL_NULLï¼Œè¿™å°±æ„å‘³ç€è¿™1024ä¸ªundo slotéƒ½å·²ç»è¢«åˆ†é…ç»™äº†æŸä¸ªäº‹åŠ¡ï¼Œæ­¤æ—¶ç”±äºæ–°äº‹åŠ¡æ— æ³•å†è·å¾—æ–°çš„Undoé¡µé¢é“¾è¡¨ï¼Œå°±ä¼šå›æ»šè¿™ä¸ªäº‹åŠ¡å¹¶ä¸”ç»™ç”¨æˆ·æŠ¥é”™ï¼š 1Too many active concurrent transactions ç”¨æˆ·çœ‹åˆ°è¿™ä¸ªé”™è¯¯ï¼Œå¯ä»¥é€‰æ‹©é‡æ–°æ‰§è¡Œè¿™ä¸ªäº‹åŠ¡ï¼ˆå¯èƒ½é‡æ–°æ‰§è¡Œæ—¶æœ‰åˆ«çš„äº‹åŠ¡æäº¤äº†ï¼Œè¯¥äº‹åŠ¡å°±å¯ä»¥è¢«åˆ†é…Undoé¡µé¢é“¾è¡¨äº†ï¼‰ã€‚ å½“ä¸€ä¸ªäº‹åŠ¡æäº¤æ—¶ï¼Œå®ƒæ‰€å ç”¨çš„undo slotæœ‰ä¸¤ç§å‘½è¿ï¼š å¦‚æœè¯¥undo slotæŒ‡å‘çš„Undoé¡µé¢é“¾è¡¨ç¬¦åˆè¢«é‡ç”¨çš„æ¡ä»¶ï¼ˆå°±æ˜¯æˆ‘ä»¬ä¸Šè¾¹è¯´çš„Undoé¡µé¢é“¾è¡¨åªå ç”¨ä¸€ä¸ªé¡µé¢å¹¶ä¸”å·²ä½¿ç”¨ç©ºé—´å°äºæ•´ä¸ªé¡µé¢çš„3/4ï¼‰ã€‚è¯¥undo slotå°±å¤„äºè¢«ç¼“å­˜çš„çŠ¶æ€ï¼ŒInnoDBè§„å®šè¿™æ—¶è¯¥Undoé¡µé¢é“¾è¡¨çš„TRX_UNDO_STATEå±æ€§ï¼ˆè¯¥å±æ€§åœ¨first undo pageçš„Undo Log Segment Headeréƒ¨åˆ†ï¼‰ä¼šè¢«è®¾ç½®ä¸ºTRX_UNDO_CACHEDã€‚ è¢«ç¼“å­˜çš„undo slotéƒ½ä¼šè¢«åŠ å…¥åˆ°ä¸€ä¸ªé“¾è¡¨ï¼Œæ ¹æ®å¯¹åº”çš„Undoé¡µé¢`é“¾è¡¨çš„ç±»å‹ä¸åŒï¼Œä¹Ÿä¼šè¢«åŠ å…¥åˆ°ä¸åŒçš„é“¾è¡¨ï¼š å¦‚æœå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨æ˜¯insert undoé“¾è¡¨ï¼Œåˆ™è¯¥undo slotä¼šè¢«åŠ å…¥insert undo cachedé“¾è¡¨ã€‚ å¦‚æœå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨æ˜¯update undoé“¾è¡¨ï¼Œåˆ™è¯¥undo slotä¼šè¢«åŠ å…¥update undo cachedé“¾è¡¨ã€‚ ä¸€ä¸ªå›æ»šæ®µå°±å¯¹åº”ç€ä¸Šè¿°ä¸¤ä¸ªcachedé“¾è¡¨ï¼Œå¦‚æœæœ‰æ–°äº‹åŠ¡è¦åˆ†é…undo slotæ—¶ï¼Œå…ˆä»å¯¹åº”çš„cachedé“¾è¡¨ä¸­æ‰¾ã€‚å¦‚æœæ²¡æœ‰è¢«ç¼“å­˜çš„undo slotï¼Œæ‰ä¼šåˆ°å›æ»šæ®µçš„Rollback Segment Headeré¡µé¢ä¸­å†å»æ‰¾ã€‚ å¦‚æœè¯¥undo slotæŒ‡å‘çš„Undoé¡µé¢é“¾è¡¨ä¸ç¬¦åˆè¢«é‡ç”¨çš„æ¡ä»¶ï¼Œé‚£ä¹ˆé’ˆå¯¹è¯¥undo slotå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨ç±»å‹ä¸åŒï¼Œä¹Ÿä¼šæœ‰ä¸åŒçš„å¤„ç†ï¼š å¦‚æœå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨æ˜¯insert undoé“¾è¡¨ï¼Œåˆ™è¯¥Undoé¡µé¢é“¾è¡¨çš„TRX_UNDO_STATEå±æ€§ä¼šè¢«è®¾ç½®ä¸ºTRX_UNDO_TO_FREEï¼Œä¹‹åè¯¥Undoé¡µé¢é“¾è¡¨å¯¹åº”çš„æ®µä¼šè¢«é‡Šæ”¾æ‰ï¼ˆä¹Ÿå°±æ„å‘³ç€æ®µä¸­çš„é¡µé¢å¯ä»¥è¢«æŒªä½œä»–ç”¨ï¼‰ï¼Œç„¶åæŠŠè¯¥undo slotçš„å€¼è®¾ç½®ä¸ºFIL_NULLã€‚ å¦‚æœå¯¹åº”çš„Undoé¡µé¢é“¾è¡¨æ˜¯update undoé“¾è¡¨ï¼Œåˆ™è¯¥Undoé¡µé¢é“¾è¡¨çš„TRX_UNDO_STATEå±æ€§ä¼šè¢«è®¾ç½®ä¸ºTRX_UNDO_TO_PRUGEï¼Œåˆ™ä¼šå°†è¯¥undo slotçš„å€¼è®¾ç½®ä¸ºFIL_NULLï¼Œç„¶åå°†æœ¬æ¬¡äº‹åŠ¡å†™å…¥çš„ä¸€ç»„undoæ—¥å¿—æ”¾åˆ°æ‰€è°“çš„Historyé“¾è¡¨ä¸­ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¹¶ä¸ä¼šå°†Undoé¡µé¢é“¾è¡¨å¯¹åº”çš„æ®µç»™é‡Šæ”¾æ‰ï¼Œå› ä¸ºè¿™äº›undoæ—¥å¿—è¿˜æœ‰ç”¨å‘¢ï½ï¼‰ã€‚ 9.3å¤šä¸ªå›æ»šæ®µä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æœ€å¤šåˆ†é…4ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œè€Œä¸€ä¸ªå›æ»šæ®µé‡Œåªæœ‰1024ä¸ªundo slotï¼Œå¾ˆæ˜¾ç„¶undo slotçš„æ•°é‡æœ‰ç‚¹å°‘ã€‚å³ä½¿å‡è®¾ä¸€ä¸ªè¯»å†™äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åªåˆ†é…1ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œé‚£1024ä¸ªundo slotä¹Ÿåªèƒ½æ”¯æŒ1024ä¸ªè¯»å†™äº‹åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå†å¤šäº†å°±å´©æºƒäº† åœ¨InnoDBçš„æ—©æœŸå‘å±•é˜¶æ®µçš„ç¡®åªæœ‰ä¸€ä¸ªå›æ»šæ®µï¼Œä½†æ˜¯InnoDBåæ¥æ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥InnoDBä¸€å£æ°”å®šä¹‰äº†128ä¸ªå›æ»šæ®µï¼Œä¹Ÿå°±ç›¸å½“äºæœ‰äº†128 Ã— 1024 = 131072ä¸ªundo slotã€‚å‡è®¾ä¸€ä¸ªè¯»å†™äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åªåˆ†é…1ä¸ªUndoé¡µé¢é“¾è¡¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŒæ—¶æ”¯æŒ131072ä¸ªè¯»å†™äº‹åŠ¡å¹¶å‘æ‰§è¡Œã€‚ åªè¯»äº‹åŠ¡å¹¶ä¸éœ€è¦åˆ†é…Undoé¡µé¢é“¾è¡¨ï¼ŒMySQL 5.7ä¸­æ‰€æœ‰åˆšå¼€å¯çš„äº‹åŠ¡é»˜è®¤éƒ½æ˜¯åªè¯»äº‹åŠ¡ï¼Œåªæœ‰åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹è®°å½•åšäº†æŸäº›æ”¹åŠ¨æ—¶æ‰ä¼šè¢«å‡çº§ä¸ºè¯»å†™äº‹åŠ¡ã€‚ æ¯ä¸ªå›æ»šæ®µéƒ½å¯¹åº”ç€ä¸€ä¸ªRollback Segment Headeré¡µé¢ï¼Œæœ‰128ä¸ªå›æ»šæ®µï¼Œè‡ªç„¶å°±è¦æœ‰128ä¸ªRollback Segment Headeré¡µé¢ï¼Œè¿™äº›é¡µé¢çš„åœ°å€éœ€è¦æ‰¾ä¸ªåœ°æ–¹å­˜ä¸€ä¸‹ï¼äºæ˜¯InnoDBåœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ç¬¬5å·é¡µé¢çš„æŸä¸ªåŒºåŸŸåŒ…å«äº†128ä¸ª8å­—èŠ‚å¤§å°çš„æ ¼å­ï¼š æ¯ä¸ª8å­—èŠ‚çš„æ ¼å­çš„æ„é€ å°±åƒè¿™æ ·ï¼š å¦‚æœæ‰€ç¤ºï¼Œæ¯ä¸ª8å­—èŠ‚çš„æ ¼å­å…¶å®ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š 4å­—èŠ‚å¤§å°çš„Space IDï¼Œä»£è¡¨ä¸€ä¸ªè¡¨ç©ºé—´çš„IDã€‚ 4å­—èŠ‚å¤§å°çš„Page numberï¼Œä»£è¡¨ä¸€ä¸ªé¡µå·ã€‚ ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª8å­—èŠ‚å¤§å°çš„æ ¼å­ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸ªè¡¨ç©ºé—´ä¸­çš„æŸä¸ªé¡µé¢ï¼Œè¿™äº›é¡µé¢å°±æ˜¯Rollback Segment Headerã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹äº‹ï¼Œè¦å®šä½ä¸€ä¸ªRollback Segment Headerè¿˜éœ€è¦çŸ¥é“å¯¹åº”çš„è¡¨ç©ºé—´IDï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä¸åŒçš„å›æ»šæ®µå¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„è¡¨ç©ºé—´ä¸­ã€‚ æ‰€ä»¥é€šè¿‡ä¸Šè¾¹çš„å™è¿°æˆ‘ä»¬å¯ä»¥å¤§è‡´æ¸…æ¥šï¼Œåœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ç¬¬5å·é¡µé¢ä¸­å­˜å‚¨äº†128ä¸ªRollback Segment Headeré¡µé¢åœ°å€ï¼Œæ¯ä¸ªRollback Segment Headerå°±ç›¸å½“äºä¸€ä¸ªå›æ»šæ®µã€‚åœ¨Rollback Segment Headeré¡µé¢ä¸­ï¼ŒåˆåŒ…å«1024ä¸ªundo slotï¼Œæ¯ä¸ªundo slotéƒ½å¯¹åº”ä¸€ä¸ªUndoé¡µé¢é“¾è¡¨ã€‚æˆ‘ä»¬ç”»ä¸ªç¤ºæ„å›¾ï¼š 9.4å›æ»šæ®µçš„åˆ†ç±»æˆ‘ä»¬æŠŠè¿™128ä¸ªå›æ»šæ®µç»™ç¼–ä¸€ä¸‹å·ï¼Œæœ€å¼€å§‹çš„å›æ»šæ®µç§°ä¹‹ä¸ºç¬¬0å·å›æ»šæ®µï¼Œä¹‹åä¾æ¬¡é€’å¢ï¼Œæœ€åä¸€ä¸ªå›æ»šæ®µå°±ç§°ä¹‹ä¸ºç¬¬127å·å›æ»šæ®µã€‚è¿™128ä¸ªå›æ»šæ®µå¯ä»¥è¢«åˆ†æˆä¸¤å¤§ç±»ï¼š ç¬¬0å·ã€ç¬¬33ï½127å·å›æ»šæ®µå±äºä¸€ç±»ã€‚å…¶ä¸­ç¬¬0å·å›æ»šæ®µå¿…é¡»åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ï¼ˆå°±æ˜¯è¯´ç¬¬0å·å›æ»šæ®µå¯¹åº”çš„Rollback Segment Headeré¡µé¢å¿…é¡»åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ï¼‰ï¼Œç¬¬33ï½127å·å›æ»šæ®µæ—¢å¯ä»¥åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨è‡ªå·±é…ç½®çš„undoè¡¨ç©ºé—´ä¸­ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç”±äºå¯¹æ™®é€šè¡¨çš„è®°å½•åšäº†æ”¹åŠ¨éœ€è¦åˆ†é…Undoé¡µé¢é“¾è¡¨æ—¶ï¼Œå¿…é¡»ä»è¿™ä¸€ç±»çš„æ®µä¸­åˆ†é…ç›¸åº”çš„undo slotã€‚ ç¬¬1ï½32å·å›æ»šæ®µå±äºä¸€ç±»ã€‚è¿™äº›å›æ»šæ®µå¿…é¡»åœ¨ä¸´æ—¶è¡¨ç©ºé—´ï¼ˆå¯¹åº”ç€æ•°æ®ç›®å½•ä¸­çš„ibtmp1æ–‡ä»¶ï¼‰ä¸­ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç”±äºå¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšäº†æ”¹åŠ¨éœ€è¦åˆ†é…Undoé¡µé¢é“¾è¡¨æ—¶ï¼Œå¿…é¡»ä»è¿™ä¸€ç±»çš„æ®µä¸­åˆ†é…ç›¸åº”çš„undo slotã€‚ ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢å¯¹æ™®é€šè¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œåˆå¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œé‚£ä¹ˆéœ€è¦ä¸ºè¿™ä¸ªè®°å½•åˆ†é…2ä¸ªå›æ»šæ®µï¼Œå†åˆ†åˆ«åˆ°è¿™ä¸¤ä¸ªå›æ»šæ®µä¸­åˆ†é…å¯¹åº”çš„undo slotã€‚ ä¸ºå•¥è¦æŠŠé’ˆå¯¹æ™®é€šè¡¨å’Œä¸´æ—¶è¡¨æ¥åˆ’åˆ†ä¸åŒç§ç±»çš„å›æ»šæ®µå‘¢ï¼Ÿè¿™ä¸ªè¿˜å¾—ä»Undoé¡µé¢æœ¬èº«è¯´èµ·ï¼Œæˆ‘ä»¬è¯´Undoé¡µé¢å…¶å®æ˜¯ç±»å‹ä¸ºFIL_PAGE_UNDO_LOGçš„é¡µé¢çš„ç®€ç§°ï¼Œè¯´åˆ°åº•å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ™®é€šçš„é¡µé¢ã€‚æˆ‘ä»¬å‰è¾¹è¯´è¿‡ï¼Œåœ¨ä¿®æ”¹é¡µé¢ä¹‹å‰ä¸€å®šè¦å…ˆæŠŠå¯¹åº”çš„redoæ—¥å¿—å†™ä¸Šï¼Œè¿™æ ·åœ¨ç³»ç»Ÿå¥”æºƒé‡å¯æ—¶æ‰èƒ½æ¢å¤åˆ°å¥”æºƒå‰çš„çŠ¶æ€ã€‚æˆ‘ä»¬å‘Undoé¡µé¢å†™å…¥undoæ—¥å¿—æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå†™é¡µé¢çš„è¿‡ç¨‹ï¼ŒInnoDBä¸ºæ­¤è¿˜è®¾è®¡äº†è®¸å¤šç§redoæ—¥å¿—çš„ç±»å‹ï¼Œæ¯”æ–¹è¯´MLOG_UNDO_HDR_CREATEã€MLOG_UNDO_INSERTã€MLOG_UNDO_INITç­‰ç­‰ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯¹Undoé¡µé¢åšçš„ä»»ä½•æ”¹åŠ¨éƒ½ä¼šè®°å½•ç›¸åº”ç±»å‹çš„redoæ—¥å¿—ã€‚ä½†æ˜¯å¯¹äºä¸´æ—¶è¡¨æ¥è¯´ï¼Œå› ä¸ºä¿®æ”¹ä¸´æ—¶è¡¨è€Œäº§ç”Ÿçš„undoæ—¥å¿—åªéœ€è¦åœ¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­æœ‰æ•ˆï¼Œå¦‚æœç³»ç»Ÿå¥”æºƒäº†ï¼Œé‚£ä¹ˆåœ¨é‡å¯æ—¶ä¹Ÿä¸éœ€è¦æ¢å¤è¿™äº›undoæ—¥å¿—æ‰€åœ¨çš„é¡µé¢ï¼Œæ‰€ä»¥åœ¨å†™é’ˆå¯¹ä¸´æ—¶è¡¨çš„Undoé¡µé¢æ—¶ï¼Œå¹¶ä¸éœ€è¦è®°å½•ç›¸åº”çš„redoæ—¥å¿—ã€‚æ€»ç»“ä¸€ä¸‹é’ˆå¯¹æ™®é€šè¡¨å’Œä¸´æ—¶è¡¨åˆ’åˆ†ä¸åŒç§ç±»çš„å›æ»šæ®µçš„åŸå› ï¼šåœ¨ä¿®æ”¹é’ˆå¯¹æ™®é€šè¡¨çš„å›æ»šæ®µä¸­çš„Undoé¡µé¢æ—¶ï¼Œéœ€è¦è®°å½•å¯¹åº”çš„redoæ—¥å¿—ï¼Œè€Œä¿®æ”¹é’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µä¸­çš„Undoé¡µé¢æ—¶ï¼Œä¸éœ€è¦è®°å½•å¯¹åº”çš„redoæ—¥å¿—ã€‚ å®é™…ä¸Šåœ¨MySQL 5.7.21è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä»…ä»…å¯¹æ™®é€šè¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œé‚£ä¹ˆåªä¼šä¸ºè¯¥äº‹åŠ¡åˆ†é…é’ˆå¯¹æ™®é€šè¡¨çš„å›æ»šæ®µï¼Œä¸åˆ†é…é’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä»…ä»…å¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œé‚£ä¹ˆæ—¢ä¼šä¸ºè¯¥äº‹åŠ¡åˆ†é…é’ˆå¯¹æ™®é€šè¡¨çš„å›æ»šæ®µï¼Œåˆä¼šä¸ºå…¶åˆ†é…é’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µï¼ˆä¸è¿‡åˆ†é…äº†å›æ»šæ®µå¹¶ä¸ä¼šç«‹å³åˆ†é…undo slotï¼Œåªæœ‰åœ¨çœŸæ­£éœ€è¦Undoé¡µé¢é“¾è¡¨æ—¶æ‰ä¼šå»åˆ†é…å›æ»šæ®µä¸­çš„undo slotï¼‰ã€‚ 9.5ä¸ºäº‹åŠ¡åˆ†é…Undoé¡µé¢é“¾è¡¨è¯¦ç»†è¿‡ç¨‹æ¥ä¸‹æ¥ä»¥äº‹åŠ¡å¯¹æ™®é€šè¡¨çš„è®°å½•åšæ”¹åŠ¨ä¸ºä¾‹ï¼Œæ¢³ç†ä¸€ä¸‹äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ†é…Undoé¡µé¢é“¾è¡¨æ—¶çš„å®Œæ•´è¿‡ç¨‹ï¼š äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æ™®é€šè¡¨çš„è®°å½•é¦–æ¬¡åšæ”¹åŠ¨ä¹‹å‰ï¼Œé¦–å…ˆä¼šåˆ°ç³»ç»Ÿè¡¨ç©ºé—´çš„ç¬¬5å·é¡µé¢ä¸­åˆ†é…ä¸€ä¸ªå›æ»šæ®µï¼ˆå…¶å®å°±æ˜¯è·å–ä¸€ä¸ªRollback Segment Headeré¡µé¢çš„åœ°å€ï¼‰ã€‚ä¸€æ—¦æŸä¸ªå›æ»šæ®µè¢«åˆ†é…ç»™äº†è¿™ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆä¹‹åè¯¥äº‹åŠ¡ä¸­å†å¯¹æ™®é€šè¡¨çš„è®°å½•åšæ”¹åŠ¨æ—¶ï¼Œå°±ä¸ä¼šé‡å¤åˆ†é…äº†ã€‚ä½¿ç”¨round-robinï¼ˆå¾ªç¯ä½¿ç”¨ï¼‰æ–¹å¼æ¥åˆ†é…å›æ»šæ®µã€‚æ¯”å¦‚å½“å‰äº‹åŠ¡åˆ†é…äº†ç¬¬0å·å›æ»šæ®µï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªäº‹åŠ¡å°±è¦åˆ†é…ç¬¬33å·å›æ»šæ®µï¼Œä¸‹ä¸‹ä¸ªäº‹åŠ¡å°±è¦åˆ†é…ç¬¬34å·å›æ»šæ®µï¼Œç®€å•ä¸€ç‚¹çš„è¯´å°±æ˜¯è¿™äº›å›æ»šæ®µè¢«è½®ç€åˆ†é…ç»™ä¸åŒçš„äº‹åŠ¡ã€‚ åœ¨åˆ†é…åˆ°å›æ»šæ®µåï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªå›æ»šæ®µçš„ä¸¤ä¸ªcachedé“¾è¡¨æœ‰æ²¡æœ‰å·²ç»ç¼“å­˜äº†çš„undo slotï¼Œæ¯”å¦‚å¦‚æœäº‹åŠ¡åšçš„æ˜¯INSERTæ“ä½œï¼Œå°±å»å›æ»šæ®µå¯¹åº”çš„insert undo cachedé“¾è¡¨ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ç¼“å­˜çš„undo slotï¼›å¦‚æœäº‹åŠ¡åšçš„æ˜¯DELETEæ“ä½œï¼Œå°±å»å›æ»šæ®µå¯¹åº”çš„update undo cachedé“¾è¡¨ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ç¼“å­˜çš„undo slotã€‚å¦‚æœæœ‰ç¼“å­˜çš„undo slotï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªç¼“å­˜çš„undo slotåˆ†é…ç»™è¯¥äº‹åŠ¡ã€‚ å¦‚æœæ²¡æœ‰ç¼“å­˜çš„undo slotå¯ä¾›åˆ†é…ï¼Œé‚£ä¹ˆå°±è¦åˆ°Rollback Segment Headeré¡µé¢ä¸­æ‰¾ä¸€ä¸ªå¯ç”¨çš„undo slotåˆ†é…ç»™å½“å‰äº‹åŠ¡ã€‚ä»Rollback Segment Headeré¡µé¢ä¸­åˆ†é…å¯ç”¨çš„undo slotçš„æ–¹å¼æˆ‘ä»¬ä¸Šè¾¹ä¹Ÿè¯´è¿‡äº†ï¼Œå°±æ˜¯ä»ç¬¬0ä¸ªundo slotå¼€å§‹ï¼Œå¦‚æœè¯¥undo slotçš„å€¼ä¸ºFIL_NULLï¼Œæ„å‘³ç€è¿™ä¸ªundo slotæ˜¯ç©ºé—²çš„ï¼Œå°±æŠŠè¿™ä¸ªundo slotåˆ†é…ç»™å½“å‰äº‹åŠ¡ï¼Œå¦åˆ™æŸ¥çœ‹ç¬¬1ä¸ªundo slotæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ªundo slotã€‚å¦‚æœè¿™1024ä¸ªundo slotéƒ½æ²¡æœ‰å€¼ä¸ºFIL_NULLçš„æƒ…å†µï¼Œå°±ç›´æ¥æŠ¥é”™ï¼ˆä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼‰ã€‚ æ‰¾åˆ°å¯ç”¨çš„undo slotåï¼Œå¦‚æœè¯¥undo slotæ˜¯ä»cachedé“¾è¡¨ä¸­è·å–çš„ï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„Undo Log Segmentå·²ç»åˆ†é…äº†ï¼Œå¦åˆ™çš„è¯éœ€è¦é‡æ–°åˆ†é…ä¸€ä¸ªUndo Log Segmentï¼Œç„¶åä»è¯¥Undo Log Segmentä¸­ç”³è¯·ä¸€ä¸ªé¡µé¢ä½œä¸ºUndoé¡µé¢é“¾è¡¨çš„first undo pageã€‚ ç„¶åäº‹åŠ¡å°±å¯ä»¥æŠŠundoæ—¥å¿—å†™å…¥åˆ°ä¸Šè¾¹ç”³è¯·çš„Undoé¡µé¢é“¾è¡¨äº†ï¼ å¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšæ”¹åŠ¨çš„æ­¥éª¤å’Œä¸Šè¿°çš„ä¸€æ ·ã€‚ä¸è¿‡éœ€è¦å†æ¬¡å¼ºè°ƒä¸€æ¬¡ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¢å¯¹æ™®é€šè¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œåˆå¯¹ä¸´æ—¶è¡¨çš„è®°å½•åšäº†æ”¹åŠ¨ï¼Œé‚£ä¹ˆéœ€è¦ä¸ºè¿™ä¸ªè®°å½•åˆ†é…2ä¸ªå›æ»šæ®µã€‚å¹¶å‘æ‰§è¡Œçš„ä¸åŒäº‹åŠ¡å…¶å®ä¹Ÿå¯ä»¥è¢«åˆ†é…ç›¸åŒçš„å›æ»šæ®µï¼Œåªè¦åˆ†é…ä¸åŒçš„undo slotå°±å¯ä»¥äº†ã€‚ 10.å›æ»šæ®µç›¸å…³é…ç½®10.1é…ç½®å›æ»šæ®µæ•°é‡ç³»ç»Ÿä¸­ä¸€å…±æœ‰128ä¸ªå›æ»šæ®µï¼Œå…¶å®è¿™åªæ˜¯é»˜è®¤å€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°innodb_rollback_segmentsæ¥é…ç½®å›æ»šæ®µçš„æ•°é‡ï¼Œå¯é…ç½®çš„èŒƒå›´æ˜¯1~128ã€‚ä½†æ˜¯è¿™ä¸ªå‚æ•°å¹¶ä¸ä¼šå½±å“é’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µæ•°é‡ï¼Œé’ˆå¯¹ä¸´æ—¶è¡¨çš„å›æ»šæ®µæ•°é‡ä¸€ç›´æ˜¯32ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š å¦‚æœæˆ‘ä»¬æŠŠinnodb_rollback_segmentsçš„å€¼è®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆåªä¼šæœ‰1ä¸ªé’ˆå¯¹æ™®é€šè¡¨çš„å¯ç”¨å›æ»šæ®µï¼Œä½†æ˜¯ä»ç„¶æœ‰32ä¸ªé’ˆå¯¹ä¸´æ—¶è¡¨çš„å¯ç”¨å›æ»šæ®µã€‚ å¦‚æœæˆ‘ä»¬æŠŠinnodb_rollback_segmentsçš„å€¼è®¾ç½®ä¸º2ï½33ä¹‹é—´çš„æ•°ï¼Œæ•ˆæœå’Œå°†å…¶è®¾ç½®ä¸º1æ˜¯ä¸€æ ·çš„ã€‚ å¦‚æœæˆ‘ä»¬æŠŠinnodb_rollback_segmentsè®¾ç½®ä¸ºå¤§äº33çš„æ•°ï¼Œé‚£ä¹ˆé’ˆå¯¹æ™®é€šè¡¨çš„å¯ç”¨å›æ»šæ®µæ•°é‡å°±æ˜¯è¯¥å€¼å‡å»32ã€‚ 10.2 é…ç½®undoè¡¨ç©ºé—´é»˜è®¤æƒ…å†µä¸‹ï¼Œé’ˆå¯¹æ™®é€šè¡¨è®¾ç«‹çš„å›æ»šæ®µï¼ˆç¬¬0å·ä»¥åŠç¬¬33~127å·å›æ»šæ®µï¼‰éƒ½æ˜¯è¢«åˆ†é…åˆ°ç³»ç»Ÿè¡¨ç©ºé—´çš„ã€‚å…¶ä¸­çš„ç¬¬0å·å›æ»šæ®µæ˜¯ä¸€ç›´åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„ï¼Œä½†æ˜¯ç¬¬33~127å·å›æ»šæ®µå¯ä»¥é€šè¿‡é…ç½®æ”¾åˆ°è‡ªå®šä¹‰çš„undoè¡¨ç©ºé—´ä¸­ã€‚ä½†æ˜¯è¿™ç§é…ç½®åªèƒ½åœ¨ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆåˆ›å»ºæ•°æ®ç›®å½•æ—¶ï¼‰çš„æ—¶å€™ä½¿ç”¨ï¼Œä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œä¹‹åå°±ä¸èƒ½å†æ¬¡æ›´æ”¹äº†ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ç›¸å…³å¯åŠ¨å‚æ•°ï¼š é€šè¿‡innodb_undo_directoryæŒ‡å®šundoè¡¨ç©ºé—´æ‰€åœ¨çš„ç›®å½•ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šè¯¥å‚æ•°ï¼Œåˆ™é»˜è®¤undoè¡¨ç©ºé—´æ‰€åœ¨çš„ç›®å½•å°±æ˜¯æ•°æ®ç›®å½•ã€‚ é€šè¿‡innodb_undo_tablespaceså®šä¹‰undoè¡¨ç©ºé—´çš„æ•°é‡ã€‚è¯¥å‚æ•°çš„é»˜è®¤å€¼ä¸º0ï¼Œè¡¨æ˜ä¸åˆ›å»ºä»»ä½•undoè¡¨ç©ºé—´ã€‚ç¬¬33~127å·å›æ»šæ®µå¯ä»¥å¹³å‡åˆ†å¸ƒåˆ°ä¸åŒçš„undoè¡¨ç©ºé—´ä¸­ã€‚ å¦‚æœæˆ‘ä»¬åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™æŒ‡å®šäº†åˆ›å»ºäº†undoè¡¨ç©ºé—´ï¼Œé‚£ä¹ˆç³»ç»Ÿè¡¨ç©ºé—´ä¸­çš„ç¬¬0å·å›æ»šæ®µå°†å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚ æ¯”å¦‚æˆ‘ä»¬åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶æŒ‡å®šçš„innodb_rollback_segmentsä¸º35ï¼Œinnodb_undo_tablespacesä¸º2ï¼Œè¿™æ ·å°±ä¼šå°†ç¬¬33ã€34å·å›æ»šæ®µåˆ†åˆ«åˆ†å¸ƒåˆ°ä¸€ä¸ªundoè¡¨ç©ºé—´ä¸­ã€‚ è®¾ç«‹undoè¡¨ç©ºé—´çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯åœ¨undoè¡¨ç©ºé—´ä¸­çš„æ–‡ä»¶å¤§åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨çš„å°†è¯¥undoè¡¨ç©ºé—´æˆªæ–­ï¼ˆtruncateï¼‰æˆä¸€ä¸ªå°æ–‡ä»¶ã€‚è€Œç³»ç»Ÿè¡¨ç©ºé—´çš„å¤§å°åªèƒ½ä¸æ–­çš„å¢å¤§ï¼Œå´ä¸èƒ½æˆªæ–­ã€‚ 11.æ€»ç»“ä¸ºäº†ä¿è¯äº‹åŠ¡çš„åŸå­æ€§è®¾è®¡ï¼ŒInnoDBå¼•å…¥äº†undoæ—¥å¿—ã€‚undoæ—¥å¿—è®°è½½äº†å›æ»šä¸€ä¸ªæ®µæ‰€éœ€çš„å¿…è¦å†…å®¹ã€‚ åœ¨äº‹åŠ¡å¯¹è¡¨ä¸­çš„è®°å½•è¿›è¡Œæ”¹åŠ¨çš„æ—¶å€™ï¼Œæ‰ä¼šä¸ºè¿™ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„IDã€‚äº‹åŠ¡IDå€¼æ˜¯ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚å…ˆè¢«åˆ†é…IDçš„äº‹åŠ¡å¾—åˆ°çš„æ˜¯è¾ƒå°çš„äº‹åŠ¡IDï¼Œåè¢«åˆ†é…IDçš„äº‹åŠ¡å¾—åˆ°çš„æ˜¯è¾ƒå¤§çš„äº‹åŠ¡IDã€‚æœªè¢«åˆ†é…äº‹åŠ¡IDçš„äº‹åŠ¡IDé»˜è®¤æ˜¯0ã€‚èšç°‡ç´¢å¼•è®°å½•ä¸­æœ‰ä¸€ä¸ªtrx_idéšè—åˆ—ï¼Œä»–ä»£è¡¨å¯¹è¿™ä¸ªèšç°‡ç´¢å¼•éšè—è®°å½•è¿›è¡Œæ”¹åŠ¨çš„è¯­å¥æ‰€åœ¨çš„äº‹åŠ¡å¯¹åº”çš„äº‹åŠ¡IDã€‚ InnoDBé’ˆå¯¹ä¸åŒçš„åœºæ™¯è®¾è®¡äº†ä¸åŒç±»å‹çš„undoæ—¥å¿—ã€‚ ç±»å‹ä¸ºFIL_PAGE_UNDO_LOGçš„é¡µé¢æ˜¯ä¸“é—¨ç”¨æ¥å­˜å‚¨undoæ—¥å¿—çš„ï¼Œç®€ç§°ä¸ºundoé¡µé¢ã€‚ åœ¨ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ€å¤šåˆ†é…å››ä¸ªundoé¡µé¢é“¾è¡¨ï¼š é’ˆå¯¹æ™®é€šè¡¨çš„insert undoé“¾è¡¨ é’ˆå¯¹æ™®é€šè¡¨çš„update undoé“¾è¡¨ é’ˆå¯¹ä¸´æ—¶è¡¨çš„insert undoé“¾è¡¨ é’ˆå¯¹ä¸´æ—¶è¡¨çš„update undoé“¾è¡¨ åªæœ‰åœ¨çœŸæ­£ç”¨åˆ°è¿™äº›é“¾è¡¨çš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºä»–ä»¬ã€‚ æ¯ä¸ªundoé¡µé¢é“¾è¡¨éƒ½å¯¹åº”ä¸€ä¸ªundo log segmentã€‚undoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢ä¸­æœ‰ä¸€ä¸ªåä¸ºundo log segment header çš„éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨å…³äºè¿™ä¸ªæ®µçš„ä¸€äº›ä¿¡æ¯ã€‚ åŒä¸€ä¸ªäº‹åŠ¡å‘ä¸€ä¸ªundoé¡µé¢é“¾è¡¨ä¸­å†™å…¥çš„undoæ—¥å¿—ç®—æ˜¯ä¸€ä¸ªç»„ï¼Œæ¯ä¸ªç»„éƒ½ä»¥ä¸€ä¸ªundo log headeréƒ¨åˆ†å¼€å¤´ã€‚ ä¸€ä¸ªundoé¡µé¢é“¾è¡¨å¦‚æœå¯ä»¥è¢«é‡ç”¨ï¼Œéœ€è¦ç¬¦åˆä¸¤ä¸ªæ¡ä»¶ï¼š è¯¥é“¾è¡¨åªåŒ…å«ä¸€ä¸ªundoé¡µé¢ è¯¥undoé¡µé¢å·²ç»ä½¿ç”¨çš„ç©ºé—´å°äºæ•´ä¸ªé¡µé¢ç©ºé—´çš„3/4 æ¯ä¸€ä¸ªRollback segmrnt header é¡µé¢éƒ½å¯¹åº”ä¸€ä¸ªå›æ»šæ®µï¼Œæ¯ä¸ªå›æ»šæ®µåŒ…å«1024ä¸ªundo slotï¼Œä¸€ä¸ªundo slotä»£è¡¨ä¸€ä¸ªundoé¡µé¢é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé¡µé¢çš„é¡µå·ã€‚ç›®å‰ï¼ŒInnoDBæœ€å¤šæ”¯æŒ128ä¸ªå›æ»šæ®µï¼Œå…¶ä¸­ç¬¬0å·ï¼Œç¬¬33127å·å›æ»šæ®µæ˜¯é’ˆå¯¹æ™®é€šè¡¨è®¾è®¡çš„ï¼Œç¬¬132å·å›æ»šæ®µæ˜¯é’ˆå¯¹ä¸´æ—¶è¡¨è®¾è®¡çš„ã€‚ æˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†undoæ—¥å¿—è®°å½•åˆ°ä¸“é—¨çš„undoè¡¨ç©ºé—´ä¸­ï¼Œåœ¨undoè¡¨ç©ºé—´ä¸­çš„æ–‡ä»¶å¤§åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨å°†è¯¥undoè¡¨ç©ºé—´æˆªæ–­ä¸ºå°æ–‡ä»¶ã€‚","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]}],"categories":[{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://zhangxin66666.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"},{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/categories/%E9%9D%A2%E8%AF%95/"},{"name":"11.æ–¹æ³•è®º","slug":"11-æ–¹æ³•è®º","permalink":"https://zhangxin66666.github.io/categories/11-%E6%96%B9%E6%B3%95%E8%AE%BA/"},{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://zhangxin66666.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"https://zhangxin66666.github.io/tags/%E9%9D%A2%E8%AF%95/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://zhangxin66666.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"æ–¹æ³•è®º","slug":"æ–¹æ³•è®º","permalink":"https://zhangxin66666.github.io/tags/%E6%96%B9%E6%B3%95%E8%AE%BA/"},{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]}