{"meta":{"title":"é‡‘å­çˆ¸çˆ¸ã®å®¶","subtitle":"çƒ­çˆ±ç”Ÿæ´»ï¼Œå–œæ¬¢è½¯ä»¶","description":"æ¬¢è¿æ¥åˆ°é‡‘å­çˆ¸çˆ¸åšå®¢ã®å®¶","author":"é‡‘å­çˆ¸çˆ¸","url":"https://zhangxin66666.github.io","root":"/"},"pages":[{"title":"åˆ†ç±»","date":"2021-12-27T12:21:34.977Z","updated":"2021-12-27T12:21:34.977Z","comments":true,"path":"categories/index.html","permalink":"https://zhangxin66666.github.io/categories/index.html","excerpt":"","text":""},{"title":"","date":"2021-12-27T12:21:34.977Z","updated":"2021-12-27T12:21:34.977Z","comments":true,"path":"css/custom.css","permalink":"https://zhangxin66666.github.io/css/custom.css","excerpt":"","text":"/* æ–‡ç« é¡µH1-H6å›¾æ ‡æ ·å¼æ•ˆæœ */ h1::before, h2::before, h3::before, h4::before, h5::before, h6::before { -webkit-animation: ccc 1.6s linear infinite ; animation: ccc 1.6s linear infinite ; } @-webkit-keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } @keyframes ccc { 0% { -webkit-transform: rotate(0deg); transform: rotate(0deg) } to { -webkit-transform: rotate(-1turn); transform: rotate(-1turn) } } #content-inner.layout h1::before { color: #ef50a8 ; margin-left: -1.55rem; font-size: 1.3rem; margin-top: -0.23rem; } #content-inner.layout h2::before { color: #fb7061 ; margin-left: -1.35rem; font-size: 1.1rem; margin-top: -0.12rem; } #content-inner.layout h3::before { color: #ffbf00 ; margin-left: -1.22rem; font-size: 0.95rem; margin-top: -0.09rem; } #content-inner.layout h4::before { color: #a9e000 ; margin-left: -1.05rem; font-size: 0.8rem; margin-top: -0.09rem; } #content-inner.layout h5::before { color: #57c850 ; margin-left: -0.9rem; font-size: 0.7rem; margin-top: 0.0rem; } #content-inner.layout h6::before { color: #5ec1e0 ; margin-left: -0.9rem; font-size: 0.66rem; margin-top: 0.0rem; } #content-inner.layout h1:hover, #content-inner.layout h2:hover, #content-inner.layout h3:hover, #content-inner.layout h4:hover, #content-inner.layout h5:hover, #content-inner.layout h6:hover { color: #49b1f5 ; } #content-inner.layout h1:hover::before, #content-inner.layout h2:hover::before, #content-inner.layout h3:hover::before, #content-inner.layout h4:hover::before, #content-inner.layout h5:hover::before, #content-inner.layout h6:hover::before { color: #49b1f5 ; -webkit-animation: ccc 3.2s linear infinite ; animation: ccc 3.2s linear infinite ; } /* é¡µé¢è®¾ç½®iconè½¬åŠ¨é€Ÿåº¦è°ƒæ•´ */ #rightside_config i.fas.fa-cog.fa-spin { animation: fa-spin 5s linear infinite ; } /*--------æ›´æ¢å­—ä½“------------*/ @font-face { font-family: 'tzy'; /* å­—ä½“åè‡ªå®šä¹‰å³å¯ */ src: url('https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/font/ZhuZiAWan.woff2'); /* å­—ä½“æ–‡ä»¶è·¯å¾„ */ font-display: swap; } body, .gitcalendar { font-family: tzy !important; } .categoryBar-list { max-height: 400px; } .clock-row { overflow: hidden; text-overflow: ellipsis; } /*3sä¸ºåŠ è½½åŠ¨ç”»çš„æ—¶é—´ï¼Œ1ä¸ºåŠ è½½åŠ¨ç”»çš„æ¬¡æ•°ï¼Œease-in-outä¸ºåŠ¨ç”»æ•ˆæœ*/ #page-header, #web_bg { -webkit-animation: imgblur 2s 1 ease-in-out; animation: imgblur 2s 1 ease-in-out; } @keyframes imgblur { 0% { filter: blur(5px); } 100% { filter: blur(0px); } } /*é€‚é…ä½¿ç”¨-webkitå†…æ ¸çš„æµè§ˆå™¨ */ @-webkit-keyframes imgblur { 0% { -webkit-filter: blur(5px); } 100% { -webkit-filter: blur(0px); } } .table-wrap img { margin: .6rem auto .1rem !important; } /* æ ‡ç­¾å¤–æŒ‚ ç½‘ç«™å¡ç‰‡ start */ .site-card-group img { margin: 0 auto .1rem !important; } .site-card-group .info a img { margin-right: 10px !important; } [data-theme='dark'] .site-card-group .site-card .info .title { color: #f0f0f0 !important; } [data-theme='dark'] .site-card-group .site-card .info .desc { color: rgba(255, 255, 255, .7) !important; } .site-card-group .info .desc { margin-top: 4px !important; } /* ä»£ç å—é¢œè‰² */ figure.highlight pre .addition { color: #00bf03 !important; }"},{"title":"","date":"2021-12-27T12:21:35.011Z","updated":"2021-12-27T12:21:35.011Z","comments":true,"path":"js/chocolate.js","permalink":"https://zhangxin66666.github.io/js/chocolate.js","excerpt":"","text":"/* * @Author: tzy1997 * @Date: 2020-12-15 20:55:25 * @LastEditors: tzy1997 * @LastEditTime: 2021-01-12 19:02:25 */ // å‹æƒ…é“¾æ¥é¡µé¢ å¤´åƒæ‰¾ä¸åˆ°æ—¶ æ›¿æ¢å›¾ç‰‡ if (location.href.indexOf(\"link\") !== -1) { var imgObj = document.getElementsByTagName(\"img\"); for (i = 0; i < imgObj.length; i++) { imgObj[i].onerror = function() { this.src = \"https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/friend_404.gif\" } } } $(function() { // æ°”æ³¡ function bubble() { $('#page-header').circleMagic({ radius: 10, density: .2, color: 'rgba(255,255,255,.4)', clearOffset: 0.99 }); }! function(p) { p.fn.circleMagic = function(t) { var o, a, n, r, e = !0, i = [], d = p.extend({ color: \"rgba(255,0,0,.5)\", radius: 10, density: .3, clearOffset: .2 }, t), l = this[0]; function c() { e = !(document.body.scrollTop > a) } function s() { o = l.clientWidth, a = l.clientHeight, l.height = a + \"px\", n.width = o, n.height = a } function h() { if (e) for (var t in r.clearRect(0, 0, o, a), i) i[t].draw(); requestAnimationFrame(h) } function f() { var t = this; function e() { t.pos.x = Math.random() * o, t.pos.y = a + 100 * Math.random(), t.alpha = .1 + Math.random() * d.clearOffset, t.scale = .1 + .3 * Math.random(), t.speed = Math.random(), \"random\" === d.color ? t.color = \"rgba(\" + Math.floor(255 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.floor(0 * Math.random()) + \", \" + Math.random().toPrecision(2) + \")\" : t.color = d.color } t.pos = {}, e(), this.draw = function() { t.alpha"},{"title":"æ ‡ç­¾","date":"2021-12-27T12:21:35.011Z","updated":"2021-12-27T12:21:35.011Z","comments":true,"path":"tags/index.html","permalink":"https://zhangxin66666.github.io/tags/index.html","excerpt":"","text":""},{"title":"å…³äºæˆ‘","date":"2021-12-28T03:23:33.445Z","updated":"2021-12-28T03:23:33.445Z","comments":true,"path":"å…³äºæˆ‘/index.html","permalink":"https://zhangxin66666.github.io/%E5%85%B3%E4%BA%8E%E6%88%91/index.html","excerpt":"","text":"å…³äºæˆ‘åå¹´ç”Ÿæ­»ä¸¤èŒ«èŒ«,å†™ç¨‹åºï¼Œåˆ°å¤©äº®ã€‚åƒè¡Œä»£ç ï¼ŒBugä½•å¤„è—ã€‚çºµä½¿ä¸Šçº¿åˆæ€æ ·ï¼Œæœä»¤æ”¹ï¼Œå¤•æ–­è‚ ã€‚é¢†å¯¼æ¯å¤©æ–°æƒ³æ³•ï¼Œå¤©å¤©æ”¹ï¼Œæ—¥æ—¥å¿™ã€‚ ç›¸é¡¾æ— è¨€ï¼ŒæƒŸæœ‰æ³ªåƒè¡Œã€‚æ¯æ™šç¯ç«é˜‘çŠå¤„ï¼Œç¨‹åºå‘˜ï¼ŒåˆåŠ ç­ï¼Œå·¥ä½œç‹‚~ æ¥ä¸€å¼ æ¥¼ä¸»æ— ç¾é¢œç”Ÿæ´»ç…§ï¼Œè§ç¬‘äº†ï¼ğŸ¤£ğŸ¤£ğŸ¤£ åŸºæœ¬ä¿¡æ¯ ç±»åˆ« ä¿¡æ¯ å‡ºç”Ÿå¹´æœˆ 1990å¹´2æœˆ ç°å±…åœ° åŒ—äº¬å¸‚æœé˜³åŒº ç±è´¯ è¾½å®çœé”¦å·å¸‚ é‚®ç®± &#x38;&#51;&#52;&#x36;&#x31;&#x33;&#x32;&#x40;&#113;&#x71;&#46;&#x63;&#x6f;&#109; æ•™è‚²ç»å† æ—¶é—´ å­¦æ ¡ ä¸“ä¸š å¤‡æ³¨ 2009.09~2013.07 æ²ˆé˜³åŒ–å·¥å¤§å­¦ ç”µå­ç§‘å­¦ä¸æŠ€æœ¯ ç»Ÿæ‹›æœ¬ç§‘ 2006.09~2009.07 è¾½å®çœåŒ—é•‡å¸‚é«˜çº§ä¸­å­¦ é«˜çº§åŸºç¡€æ•™è‚² å¸‚é‡ç‚¹ å·¥ä½œç»å† æ—¶é—´ å…¬å¸ èŒä½ 2021.04~è‡³ä»Š é¾™æ¹–é›†å›¢ Java å¼€å‘å·¥ç¨‹å¸ˆ 2017.05~2021.04 åŒ…å¤´å¸‚åŒ…é“¶æ¶ˆè´¹é‡‘èè‚¡ä»½æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ 2016.09~2017.04 å¤§è¿çµåŠ¨ç§‘æŠ€å‘å±•æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ 2013.07~2016.08 å¤§è¿å®‰å‰å°¼å°”ç§‘æŠ€æœ‰é™å…¬å¸ Java å¼€å‘å·¥ç¨‹å¸ˆ ä¸“ä¸šæŠ€èƒ½ Java åŸºç¡€æ‰å®ã€æŒæ¡ JVM åŸç†ã€å¤šçº¿ç¨‹ã€ç½‘ç»œåŸç†ã€è®¾è®¡æ¨¡å¼ã€å¸¸ç”¨çš„æ•°æ®ç»“æ„å’Œç®—æ³• ç†Ÿæ‚‰ Windowsã€Macã€Linux æ“ä½œç³»ç»Ÿï¼Œç†Ÿç»ƒä½¿ç”¨ linux å¸¸ç”¨æ“ä½œæŒ‡ä»¤ ç†Ÿç»ƒä½¿ç”¨ IntelliJ IDEA å¼€å‘å·¥å…·(åŠå„ç§æ’ä»¶)ã€ç†Ÿç»ƒä½¿ç”¨ Git ç‰ˆæœ¬åŒæ­¥å·¥å…· é˜…è¯»è¿‡ Springã€SpringMVCã€ç­‰å¼€æºæ¡†æ¶æºç ï¼Œç†è§£å…¶è®¾è®¡åŸç†åŠåº•å±‚æ¶æ„ï¼Œå…·å¤‡æ¡†æ¶å®šåˆ¶å¼€å‘èƒ½åŠ› ç†è§£ Redis çº¿ç¨‹æ¨¡å‹ï¼ŒNetty çº¿ç¨‹æ¨¡å‹ï¼ŒæŒæ¡åŸºäºå“åº”å¼çš„å¼‚æ­¥éé˜»å¡æ¨¡å‹çš„åŸºæœ¬åŸç†ï¼Œäº†è§£ Webflux ç†Ÿç»ƒæŒæ¡åˆ†å¸ƒå¼ç¼“å­˜ Redisã€Elaticsearchï¼Œå¯¹åˆ†å¸ƒå¼é”ï¼Œå¹‚ç­‰ç­‰å¸¸è§é—®é¢˜æœ‰æ·±å…¥ç ”ç©¶åŠå¤šå¹´å®æˆ˜ç»éªŒ ç†Ÿæ‚‰å¸¸è§æ¶ˆæ¯ä¸­é—´ä»¶çš„ä½¿ç”¨ï¼Œæœ‰å¤šå¹´ RabbitMQ çš„å®æˆ˜å¼€å‘ç»éªŒï¼Œå¯¹é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—æœ‰æ·±å…¥ç†è§£ ç†Ÿç»ƒæŒæ¡ Mysql äº‹åŠ¡ï¼Œç´¢å¼•ï¼Œé”ï¼ŒSQL ä¼˜åŒ–ç›¸å…³çŸ¥è¯†ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯ç»™å‡ºè¯¦ç»†åŠé«˜æ€§èƒ½è®¾è®¡æ–¹æ¡ˆ ç†Ÿç»ƒä½¿ç”¨æ•°æ®åº“æ“ä½œæ¡†æ¶ Mybatisã€Mybatsi-plus è¿›è¡Œé«˜æ•ˆä¸šåŠ¡åŠŸèƒ½å¼€å‘ æŒæ¡ springCloud ç›¸å…³æ¡†æ¶ï¼Œå¯¹ SpringBootã€SpringCloud åŸç†æœ‰ä¸€å®šäº†è§£ï¼Œæœ‰æˆç†Ÿé¡¹ç›®ç»éªŒ ç†Ÿæ‚‰å®šæ—¶ä»»åŠ¡åŠå»¶è¿Ÿä»»åŠ¡ç­‰ä¸šåŠ¡ç›¸å…³è®¾è®¡ï¼Œå¦‚ xxl-jobï¼Œå»¶è¿Ÿæ¶ˆæ¯ç­‰ç›¸å…³æŠ€æœ¯æœ‰å¤šå¹´å¼€å‘ç»éªŒ ç†Ÿæ‚‰å¾®æœåŠ¡æ€æƒ³ï¼ŒMVC åˆ†å±‚ï¼ŒDDD ç†è®ºï¼ŒæœåŠ¡æ‹†åˆ†ï¼Œæ²»ç†ï¼Œç›‘æ§ï¼ŒæœåŠ¡ç†”æ–­ï¼Œé™çº§ç­‰ç›¸å…³èƒ½åŠ› ç†Ÿæ‚‰ jvm åŸç†ï¼Œç†Ÿæ‚‰åƒåœ¾å›æ”¶ä»¥ jvm æ€§èƒ½è°ƒä¼˜æŠ€æœ¯ï¼Œæœ‰è¿‡çº¿ä¸ŠæœåŠ¡å™¨æ€§èƒ½ç›‘æµ‹åŠè°ƒä¼˜ç»éªŒ ç†Ÿæ‚‰å¤šçº¿ç¨‹åŠçº¿ç¨‹æ± ä½¿ç”¨ï¼Œæœ‰å¤šå¹´å¤šçº¿ç¨‹ä¸šåŠ¡å¤„ç†ç»éªŒï¼Œå°è£…è¿‡å¤šçº¿ç¨‹æ‰¹å¤„ç†å·¥å…·ç±»ç­‰å…¬ç”¨ç»„å»º äº†è§£ Mysql åˆ†åº“åˆ†è¡¨ç›¸å…³åŸç†ï¼Œå¦‚ Sardingsphereã€Mycat ç­‰æ¡†æ¶æœ‰ç›¸å…³ä½¿ç”¨ç»éªŒ äº†è§£æ“ä½œç³»ç»Ÿåº•å±‚åŸç†ä»¥åŠ Cã€C++ç¨‹åºå¼€å‘ï¼Œå¯¹è®¡ç®—æœºåº•å±‚åŸç†æœ‰åˆæ­¥äº†è§£ äº†è§£å‰ç«¯å¼€å‘ï¼Œäº†è§£ htmlï¼Œcssï¼Œjsï¼Œvue ç­‰å‰ç«¯æŠ€æœ¯ï¼Œå¯¹å‰ç«¯å¼€å‘æœ‰ä¸€å®šçš„äº†è§£ ç ”ç©¶è¿‡å•ç‰‡æœºç­‰ç¡¬ä»¶å¼€å‘ï¼Œå–œæ¬¢ç§‘æŠ€äº§å“ï¼Œå–œæ¬¢è½¯ä»¶ï¼Œå–œæ¬¢æŠ˜è…¾å„ç§ç”µå­äº§å“ä»¥åŠè½¯ä»¶ é¡¹ç›®ç»éªŒâ€‹ é¡¹ç›®ç»éªŒåªå†™äº†åœ¨åŒ—äº¬ä¹‹åå‚ä¸è¿‡çš„ç›¸å…³é¡¹ç›®ï¼Œåœ¨å¤§è¿åšçš„é¡¹ç›®åå‘äºä¼ ç»Ÿï¼Œé¡¹ç›®ä¹Ÿéƒ½æ˜¯å•ç‚¹éƒ¨ç½²ï¼Œä¸»è¦ç”¨çš„æ¡†æ¶éƒ½æ˜¯springã€mybatisã€Hibernateã€springMVCç­‰ç›¸äº’ç»“åˆä½¿ç”¨ï¼Œå³ï¼šSSMï¼ŒSSHï¼Œç›¸æ¯”äºspringBootæ¥è¯´ä¸å€¼ä¸€æï¼Œç°åœ¨åº”è¯¥æ²¡æœ‰å‡ ä¸ªå…¬å¸è¿˜æ²¡ç”¨springBootäº†å§(#^.^#)ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåˆšæ¯•ä¸šé‚£ä¼šï¼Œåšäº†åŠå¹´çš„Cè¯­è¨€åµŒå…¥å¼å¼€å‘ï¼Œå¤–åŒ…åˆ°å¤§è¿ä¸œè½¯åšå¯¹æ—¥çš„ä½³èƒ½ç›¸æœºç³»ç»Ÿï¼Œè™½ç„¶ç›®å‰æˆ‘å·²ç»åšäº†å¤šå¹´çš„javaå¼€å‘ï¼Œä½†æ˜¯é‚£æ¯•ç«Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å‚åŠ å¼€å‘é¡¹ç›®ï¼Œäººéƒ½æ˜¯æœ‰åˆæ‹æƒ…èŠ‚çš„å˜›ï¼Œå¯¹è‡ªå·±çš„ç¬¬ä¸€æ¬¡å¿µå¿µä¸å¿˜(æˆ‘æŒ‡å¾—æ˜¯å·¥ä½œğŸ¤­)ï¼Œé‚£åŠå¹´è®©æˆ‘å¯¹ç¡¬ä»¶åº•å±‚æœ‰äº†ä¸€äº›ç†è§£ï¼Œä¹Ÿç®—æ˜¯æœ€å¤§çš„æ”¶è·äº†å§ã€‚ â€”â€” åŒ…é“¶æ¶ˆè´¹é‡‘è(ç°åï¼šè’™å•†æ¶ˆè´¹) â€”â€”â€‹ åŒ…å¤´å¸‚åŒ…é“¶æ¶ˆè´¹é‡‘èè‚¡ä»½æœ‰é™å…¬å¸æ˜¯ç»ä¸­å›½é“¶ç›‘ä¼šæ‰¹å‡†æˆç«‹çš„æŒç‰Œæ¶ˆè´¹é‡‘èå…¬å¸ï¼Œç”±åŒ…å•†é“¶è¡Œå‘èµ·è®¾ç«‹ï¼ŒåŒ…é“¶æ¶ˆè´¹é‡‘èä¸ºä¸ªäººæ¶ˆè´¹è€…æä¾›æ¶ˆè´¹ä¿¡è´·æœåŠ¡ã€‚å…¶ä¸»è¦åˆä½œæ¸ é“æœ‰ï¼šè¯å¤§è´¢å¯Œï¼Œäº¬ä¸œé‡‘æ¡ï¼Œå¾®ç²’è´·ï¼Œå»å“ªå„¿ï¼Œäº¬ä¸œå€Ÿè´·å¹³å°ï¼Œåˆ†æœŸä¹ï¼Œå°ç±³ç­‰å¤šå®¶æ”¾æ¬¾æ¸ é“ã€‚ç›®å‰ï¼Œå·²ç´¯è®¡å®Œæˆ 1200 å¤šä¸‡å®¢æˆ·æ³¨å†Œå’Œ 320 å¤šäº¿æ”¾æ¬¾è§„æ¨¡ã€‚ acsï¼šæ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿä¸»è¦åŒ…å«ä¿¡è´·æ ¸ç®—ä¸šåŠ¡å’Œè™šæ‹Ÿè´¦æˆ·ä¸šåŠ¡ï¼Œä¿¡è´·æ ¸ç®—ä¸»è¦è´Ÿè´£å€Ÿè¿˜æ¬¾ã€æ ¸é”€å‡å…äº¤æ˜“ã€åˆ©æ¯ã€ç½šæ¯è®¡æã€å„ç§è´¹ç”¨ç­‰ä¸šåŠ¡çš„è®¡ç®—å’Œè½åœ°ï¼Œæ—¥ç»ˆç”Ÿæˆäº¤æ˜“æµæ°´æ–‡ä»¶ä¾›ä¼šè®¡æ ¸ç®—ç³»ç»Ÿç”Ÿæˆä¼šè®¡åˆ†å½•ï¼›è™šæ‹Ÿè´¦æˆ·éƒ¨åˆ†ä¸»è¦ä¸ºæ¸…ç»“ç®—äººå‘˜æä¾›äº¤æ˜“äº§ç”Ÿçš„ä¸åŒèµ„é‡‘è´¦æˆ·é‡‘é¢çš„å˜åŒ–åŠèµ„é‡‘æµå‘ï¼Œä¸ºæ¸…ç»“ç®—äººå‘˜å¯¹è´¦æä¾›æ•°æ®æ”¯æŒï¼›ç³»ç»Ÿå¯ä»¥å¤„ç†æ¯åˆ†é’Ÿå³°å€¼ 640 å¤šç¬”æˆä¿¡ç”³è¯·ï¼Œæ¯å°æ—¶å³°å€¼ 2 ä¸‡ç¬”æˆä¿¡ç”³è¯·ï¼Œè´·åæ”¯æŒæ¯å°æ—¶ 17 ä¸‡å®¢æˆ·æ•°æ®ã€‚æ ¸å¿ƒæ—¥ç»ˆå¤„ç†é‡è¾¾ 152 ä¸‡ç¬”(å€Ÿæ®æ•°é‡)ã€‚ glsï¼šè´¢åŠ¡æ ¸ç®—ç³»ç»Ÿå¯¹æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿæ—¥ç»ˆç”Ÿæˆçš„äº¤æ˜“æµæ°´è§£æä¹‹åæŒ‰ç…§åˆ†å½•å€Ÿè´·è§„åˆ™ç”Ÿæˆè´¢åŠ¡åˆ†å½•æ–‡ä»¶äº¤ç»™é‡‘è¶ç³»ç»Ÿï¼Œ17 å¹´è´¢åŠ¡æ ¸ç®—ç³»ç»Ÿæ˜¯ä¹°æ¥çš„ç³»ç»Ÿï¼Œ19 å¹´ç”±æˆ‘é‡æ–°å¼€å‘å‡ºå±äºå…¬å¸è‡ªå·±çš„è´¢åŠ¡æ ¸ç®—ç³»ç»Ÿï¼Œå¹¶å¢åŠ äº†è´¢åŠ¡å¯¹è´¦åŠŸèƒ½(æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿå’Œè´¢åŠ¡åˆ†å½•å¯¹è´¦)ï¼Œä¸ä½†åŠæ—¶å‘ç°çº¿ä¸Šäº¤æ˜“çš„é”™è¯¯æ•°æ®ï¼ŒåŠæ—¶è§£å†³é—®é¢˜ï¼Œæ›´æå‡äº†æœˆç»ˆå¯¹è´¦ï¼Œå¹´ç»“çš„æ•ˆç‡ï¼Œå®ç°äº†è´¢åŠ¡å¯¹è´¦è‡ªåŠ¨åŒ–ï¼Œè§£å†³äº†å¹´ç»“äººå·¥å¯¹è´¦çš„ç—›ç‚¹ã€‚ ecifï¼šæ¸ é“ç³»ç»Ÿè¦è´Ÿè´£å¯¹æ¥ç¬¬ä¸‰æ–¹å¼•æµæ¸ é“ï¼Œå®¢æˆ·é€šè¿‡ç¬¬ä¸‰æ–¹æ¸ é“æˆä¿¡ã€å€Ÿæ¬¾ï¼Œæ¸ é“å¼•æµåˆ°åŒ…é“¶ï¼Œç”±äºä¸åŒæ¸ é“çš„æˆä¿¡ã€æ”¾æ¬¾ä¸šåŠ¡é€»è¾‘ä¸åŒï¼Œé’ˆå¯¹ä¸åŒæ¸ é“æä¾›ä¸åŒçš„åŠŸèƒ½å¼€å‘ã€‚å…¶ä¸­éƒ¨åˆ†æ¸ é“ç§¯ç´¯ä¸€å¤©å®¢æˆ·æˆä¿¡è¯·æ±‚æŒ‡å®šæ—¶é—´ç»Ÿä¸€å‘é€æˆä¿¡ç”³è¯·åˆ°åŒ…é“¶ï¼Œç³»ç»Ÿå¯å¤„ç†æ¯åˆ†é’Ÿ 800 ç¬”æˆä¿¡è¯·æ±‚ã€‚ cssï¼šæ¸…ç»“ç®—ç³»ç»Ÿæ­¤ç³»ç»Ÿæ˜¯å…¬å¸å†…éƒ¨æ¸…ç»“ç®—äººå‘˜ä½¿ç”¨çš„å†…éƒ¨ä¸šåŠ¡ç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½æœ‰ä¸ªäººæº¢ç¼´æ¬¾è´¦æˆ·ç®¡ç†ã€å¯¹å…¬ä»˜æ¬¾ã€å¯¹ç§ä»˜æ¬¾ã€é€€æ¬¾ä»¥åŠæ¸…ç»“ç®—åŒäº‹è½¬è´¦ä¸šåŠ¡çš„å‘èµ·å’Œå®¡æ ¸åŠŸèƒ½ è”åˆè´·æ¬¾ç³»ç»Ÿä¸»è¦åŠŸèƒ½æœ‰è”åˆè´·æ¬¾åè®®ï¼Œè·¯ç”±é…ç½®ï¼Œè·¯ç”±è§„åˆ™ï¼Œå€Ÿæ®è¿˜æ¬¾è®¡åˆ’æ‹†åˆ†ï¼Œèµ„æ–¹æˆä¿¡ï¼Œå€Ÿæ®ã€äº¤æ˜“æµæ°´æ–‡ä»¶ï¼Œè”åˆè´·æ¬¾æˆä¿¡å½±éŸ³èµ„æ–™æ¨é€ ç›‘ç®¡æŠ¥é€ç³»ç»ŸæŒ‰ç…§ç›‘ç®¡æŠ¥é€éœ€æ±‚ï¼Œå¯¹å€Ÿæ®(æ¯æœˆæŠ¥é€å…¨é‡æ•°æ®)ï¼Œè¿˜æ¬¾è®¡åˆ’ï¼Œè¿˜æ¬¾æµæ°´ï¼Œå®¢æˆ·ï¼Œäº§å“ï¼Œæ ¸é”€ï¼Œå€Ÿæ¬¾ç”³è¯·ï¼Œèµ„äº§è¯åˆ¸åŒ–ï¼Œäº”çº§åˆ†ç±»ç­‰ä¿¡æ¯è¿›è¡ŒåŠ å·¥ä¹‹åæ¨é€ç»™ç›‘ç®¡æŠ¥é€ç³»ç»Ÿ è‡ªæˆ‘è¯„ä»·ä¸šç²¾äºå‹¤ï¼Œè’äºå¬‰ ã€è¡Œæˆäºæ€ï¼Œæ¯äºéšã€‚ æ€§æ ¼ä¹è§‚å¼€æœ—ï¼Œè¯ç—¨ï¼Œçƒ­çˆ±ç”Ÿæ´»ï¼Œå–œæ¬¢æ‹è§†é¢‘è®°å½•ç”Ÿæ´»ï¼Œå–œæ¬¢åˆ†äº«çŸ¥è¯†ï¼Œåˆ†äº«æŠ€æœ¯ï¼Œåˆ†äº«ç”Ÿæ´»ä¸­çš„ç‚¹ç‚¹æ»´æ»´ï¼Œè„¾æ°”å¥½ï¼Œæ€•è€å©† ä¸ªäººçˆ±å¥½ ç”µå­ç§‘æŠ€äº§å“ è½¯ä»¶ â€”â€” å–œæ¬¢winã€Macã€Android å¥½ç”¨æ— å¹¿å‘Šè½¯ä»¶ç ”ç©¶åŠåˆ†äº« è¶³çƒ â€”â€” å–œæ¬¢ä½†æ˜¯æ²¡æœºä¼šç©ï¼Œæ€€å¿µé«˜ä¸­æ—¶ä»£å‘€â€¦. ä¸‰å›½æ€ â€”â€” åŸºæœ¬å·²ç»è¢«å‡‰ä¼é€¼åˆ°é€€æ¸¸äº†â€¦.è€Œä¸”ç”Ÿæ´»ä¸­ä¹Ÿå¾ˆéš¾æ‰¾åˆ°ä¸€èµ·ç©è¿™ä¸ªæ¸¸æˆçš„æœ‹å‹äº†ğŸ¤£ é€›Bç«™ â€”â€” ç”Ÿæ´»åŒºå’Œç§‘æŠ€åŒºä¸€ä¸ªä¸çŸ¥åé˜¿å©†ä¸»ğŸ˜‚ï¼Œä½›ç³»æ›´æ–°è§†é¢‘ ğŸ‘‰ ç‚¹å‡»æ‰“å¼€æˆ‘çš„Bç«™ä¸ªäººç©ºé—´ è®°å¾—ä¸‰è¿ ğŸ‘ğŸ‘ğŸ‘ çœ‹ç”µå½± â€”â€” å–œæ¬¢ç§‘å¹»ã€æ¼«å¨ç²‰ã€è¿½æ–—ç½—å¤§é™†â€¦.."},{"title":"ç•™è¨€æ¿","date":"2021-12-27T12:21:35.011Z","updated":"2021-12-27T12:21:35.011Z","comments":true,"path":"message/index.html","permalink":"https://zhangxin66666.github.io/message/index.html","excerpt":"","text":"æœ¬é¡µé¢è¿˜åœ¨å¼€å‘ä¸­â€¦â€¦"},{"title":"æŠ€æœ¯ç¬”è®°","date":"2021-12-28T11:59:21.747Z","updated":"2021-12-27T12:21:35.011Z","comments":true,"path":"æŠ€æœ¯ç¬”è®°/index.html","permalink":"https://zhangxin66666.github.io/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/index.html","excerpt":"","text":"æˆ‘æ˜¯æŠ€æœ¯ç¬”è®°"}],"posts":[{"title":"ACIDåŠå®ç°åŸç†","slug":"7.mysql/ACIDåŠå®ç°åŸç†","date":"2021-12-29T01:45:02.460Z","updated":"2021-12-29T12:37:07.568Z","comments":true,"path":"2021/12/29/7.mysql/ACIDåŠå®ç°åŸç†/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/29/7.mysql/ACID%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/","excerpt":"","text":"ACIDç®€ä»‹ä»¥æœ€å¸¸è§çš„ InnoDB å¼•æ“æ¥è¯´ï¼Œæ˜¯å¦‚ä½•ä¿è¯ ACID çš„ã€‚ ï¼ˆAtomicityï¼‰åŸå­æ€§ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚è¦ä¹ˆå…¨éƒ½æ‰§è¡Œ,è¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œï¼› ï¼ˆConsistencyï¼‰ä¸€è‡´æ€§ï¼š æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œï¼ˆåŸå­æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§å°±æ˜¯ä¸ºäº†æ¥ä¿è¯ä¸€è‡´æ€§ï¼‰ï¼› ï¼ˆIsolationï¼‰éš”ç¦»æ€§ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œæ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶,ä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„â€œç‹¬ç«‹â€ç¯å¢ƒæ‰§è¡Œï¼› ï¼ˆDurabilityï¼‰æŒä¹…æ€§: ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚ åŸå­æ€§ï¼ˆAï¼‰å®ç°åŸå­æ€§çš„å…³é”®ï¼Œæ˜¯å½“äº‹åŠ¡å›æ»šæ—¶èƒ½å¤Ÿæ’¤é”€æ‰€æœ‰å·²ç»æˆåŠŸæ‰§è¡Œçš„sqlè¯­å¥ï¼ˆundo logï¼‰ã€‚å½“äº‹åŠ¡å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹æ—¶ï¼ŒInnoDBä¼šç”Ÿæˆå¯¹åº”çš„ undo logï¼›å¦‚æœäº‹åŠ¡æ‰§è¡Œå¤±è´¥æˆ–è°ƒç”¨äº† rollbackï¼Œå¯¼è‡´äº‹åŠ¡éœ€è¦å›æ»šï¼Œä¾¿å¯ä»¥åˆ©ç”¨ undo log ä¸­çš„ä¿¡æ¯å°†æ•°æ®å›æ»šåˆ°ä¿®æ”¹ä¹‹å‰çš„æ ·å­ã€‚undo log å±äºé€»è¾‘æ—¥å¿—ï¼Œå®ƒè®°å½•çš„æ˜¯sqlæ‰§è¡Œç›¸å…³çš„ä¿¡æ¯ã€‚å½“å‘ç”Ÿå›æ»šæ—¶ï¼ŒInnoDB ä¼šæ ¹æ® undo log çš„å†…å®¹åšä¸ä¹‹å‰ç›¸åçš„å·¥ä½œï¼š å¯¹äºæ¯ä¸ª insertï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œ deleteï¼› å¯¹äºæ¯ä¸ª deleteï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œinsertï¼› å¯¹äºæ¯ä¸ª updateï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œä¸€ä¸ªç›¸åçš„ updateï¼ŒæŠŠæ•°æ®æ”¹å›å»ã€‚ éš”ç¦»æ€§ï¼ˆIï¼‰é¦–å…ˆå›å¿†å››ç§mysqléš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ« è¯´æ˜ è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ° è¯»æäº¤ï¼ˆRead committedï¼‰ ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚å‡º äºæ€§èƒ½è€ƒè™‘äº’è”ç½‘å…¬å¸ä¼šä½¿ç”¨RC+ä¹è§‚é” å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰ ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¯¹åŒä¸€ä»½æ•°æ®çš„è¯»å–ç»“æœæ€»æ˜¯ç›¸åŒçš„ï¼Œæ— è®ºæ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡å¯¹è¿™ä»½æ•°æ®è¿›è¡Œæ“ä½œï¼Œä»¥åŠè¿™ä¸ªäº‹åŠ¡æ˜¯å¦æäº¤ã€‚InnoDBé»˜è®¤çº§åˆ«ã€‚ ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰ äº‹åŠ¡ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯æ¬¡è¯»éƒ½éœ€è¦è·å¾—è¡¨çº§å…±äº«é”ï¼Œè¯»å†™ç›¸äº’éƒ½ä¼šé˜»å¡ï¼Œéš”ç¦»çº§åˆ«æœ€é«˜ï¼Œç‰ºç‰²ç³»ç»Ÿå¹¶å‘æ€§ã€‚ æŸ¥çœ‹å½“å‰æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«:show variables like â€˜%tx_isolation%â€™; è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šset tx_isolation=â€™REPEATABLE-READâ€™; ä¸åŒçš„éš”ç¦»çº§åˆ«æ˜¯ä¸ºäº†è§£å†³ä¸åŒçš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è„è¯»ã€å¹»è¯»ã€ä¸å¯é‡å¤è¯»ã€‚ è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»åŒºåˆ«è„è¯»ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²ç»ä¿®æ”¹ä½†å°šæœªæäº¤çš„æ•°æ®ï¼Œã€‚ ä¸å¯é‡å¤è¯»ï¼šäº‹åŠ¡Aå†…éƒ¨çš„ç›¸åŒæŸ¥è¯¢è¯­å¥åœ¨ä¸åŒæ—¶åˆ»è¯»å‡ºçš„ç»“æœä¸ä¸€è‡´ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚ å¹»è¯»ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ ä¸å¯é‡å¤è¯»&amp;&amp;å¹»è¯»åŒºåˆ« ä¸å¯é‡å¤è¯»ï¼Œé‡ç‚¹æ˜¯ä¿®æ”¹ã€‚åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼ŒåŒæ ·çš„æ¡ä»¶ï¼Œç¬¬ä¸€æ¬¡è¯»çš„æ•°æ®å’Œç¬¬äºŒæ¬¡è¯»çš„æ•°æ®ä¸ä¸€æ ·ï¼Œæ•°æ®å˜åŒ– å¹»è¯»ï¼Œé‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤ã€‚åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼ŒåŒæ ·çš„æ¡ä»¶,ï¼Œç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è¯»å‡ºæ¥çš„è®°å½•æ•°ä¸ä¸€æ ·ï¼Œè¡Œæ•°å˜åŒ–ã€‚ éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» è¯»æœªæäº¤ å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° è¯»æäº¤ ä¸å…è®¸å‡ºç° å¯ä»¥å‡ºç° å¯ä»¥å‡ºç° å¯é‡å¤è¯» ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° å¯ä»¥å‡ºç° åºåˆ—åŒ– ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° ä¸å…è®¸å‡ºç° ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œéš”ç¦»æ€§æ˜¯é é”æœºåˆ¶å’ŒMVCCå…±åŒå®ç°çš„ã€‚ MVCC(å¹¶å‘å¤šç‰ˆæœ¬æ§åˆ¶ï¼ŒMulti-Version Concurrency Control)MVCCç”¨äºè¯»å·²æäº¤ï¼ˆRCï¼‰å’Œå¯é‡å¤è¯»çº§åˆ«ï¼ˆRRï¼‰çš„æ§åˆ¶ï¼Œä¸»è¦é€šè¿‡undo logæ—¥å¿—ç‰ˆæœ¬é“¾å’Œread viewæ¥å®ç°ï¼Œ InnoDBä¸­MVCCçš„å®ç°ä¾èµ–å››ä¸ªæ¡ä»¶: éšè—å­—æ®µ, äº‹åŠ¡é“¾è¡¨ï¼Œread view, undo log æ•°æ®è¡¨é¢å¤–å­—æ®µDB_TRX_ID(6å­—èŠ‚): åœ¨innoDBä¸­, ä¼šä¸ºæ¯ä¸ªäº‹ç‰©åˆ†é…ä¸€ä¸ªäº‹åŠ¡ID. è€Œè¯¥å­—æ®µè¡¨ç¤ºçš„å°±æ˜¯æ’å…¥æˆ–æ›´æ–°è¯¥è¡Œçš„æœ€åä¸€ä¸ªäº‹åŠ¡çš„äº‹åŠ¡æ ‡è¯†ç¬¦. DB_ROLL_PTR(7å­—èŠ‚): è¿™ä¸ªå­—æ®µç§°ä¸ºå›æ»šæŒ‡é’ˆ, æŒ‡å‘äº†å›æ»šæ®µçš„æ’¤é”€æ—¥å¿—. (undo log) DB_ROW_ID(6å­—èŠ‚): è¿™ä¸ªå­—æ®µåŒ…å«äº†ä¸€ä¸ªè¡ŒID. è¯¥IDåœ¨æ’å…¥æ–°è¡Œæ—¶ä¼šå•è°ƒå¢åŠ . è¿™ä¸ªå­—æ®µæ˜¯ä¸ºäº†åœ¨è¡¨é‡Œæ²¡æœ‰ä¸»é”®IDçš„æ—¶å€™, ç”Ÿæˆèšç°‡ç´¢å¼•ä½¿ç”¨çš„. äº‹åŠ¡é“¾è¡¨MySQLä¸­çš„äº‹åŠ¡åœ¨å¼€å§‹åˆ°æäº¤è¿™æ®µè¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šè¢«ä¿å­˜åˆ°ä¸€ä¸ªå«trx_sysçš„äº‹åŠ¡é“¾è¡¨ä¸­ï¼ŒåŸºæœ¬çš„é“¾è¡¨ç»“æ„å¦‚ä¸‹ï¼š äº‹åŠ¡é“¾è¡¨ä¸­ä¿å­˜çš„éƒ½æ˜¯è¿˜æœªæäº¤çš„äº‹åŠ¡ï¼Œäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œåˆ™ä¼šè¢«ä»äº‹åŠ¡é“¾è¡¨ä¸­æ‘˜é™¤ã€‚ read viewRCçº§åˆ«ä¸‹æ¯æ¬¡éƒ½æ˜¯é‡æ–°ç”Ÿæˆread viewï¼Œè€Œåœ¨RRçº§åˆ«ä¸‹åˆ™æ˜¯ä¸€ç›´ä½¿ç”¨äº‹åŠ¡å†…ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶äº§ç”Ÿçš„read viewã€‚ ReadViewå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œåœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™ä¼šæ ¹æ®ä¸Šé¢çš„äº‹åŠ¡é“¾è¡¨æ„é€ ä¸€ä¸ªReadView,åˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹ï¼š 12345678910111213// readview åˆå§‹åŒ–// m_low_limit_id = trx_sys-&gt;max_trx_id; // m_up_limit_id = !m_ids.empty() ? m_ids.front() : m_low_limit_id;ReadView::ReadView() : m_low_limit_id(), m_up_limit_id(), m_creator_trx_id(), m_ids(), m_low_limit_no()&#123; ut_d(::memset(&amp;m_view_list, 0x0, sizeof(m_view_list)));&#125; trx_ids: è¡¨ç¤ºäº‹åŠ¡å¼€å¯çš„æ—¶å€™, å…¶å®ƒæœªæäº¤çš„æ´»è·ƒçš„äº‹åŠ¡ID. è¿™ä¸ªé›†åˆä¸­çš„äº‹åŠ¡å¯¹äºå½“å‰äº‹åŠ¡æ¥è¯´, ä¸€ç›´éƒ½æ˜¯ä¸å¯è§çš„. low_limit_id: è¡¨ç¤ºåœ¨ç”ŸæˆReadViewæ—¶å½“å‰ç³»ç»Ÿä¸­æœ€å¤§äº‹åŠ¡id. up_limit_id: è¡¨ç¤ºæœªæäº¤æ´»è·ƒäº‹åŠ¡Id(trx_ids)çš„æœ€å¤§å€¼. å¦‚æœtrx_idsä¸ºç©º, åˆ™up_limit_id=low_limit_id. é€šè¿‡è¯¥ReadViewï¼Œæ–°çš„äº‹åŠ¡å¯ä»¥æ ¹æ®æŸ¥è¯¢åˆ°çš„æ‰€æœ‰æ´»è·ƒäº‹åŠ¡è®°å½•çš„äº‹åŠ¡IDæ¥åŒ¹é…èƒ½å¤Ÿçœ‹è§è¯¥è®°å½•ï¼Œä»è€Œå®ç°æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»ï¼Œä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š é€šè¿‡èšç°‡ç´¢å¼•çš„è¡Œç»“æ„ä¸­DB_TRX_IDéšè—å­—æ®µå¯ä»¥çŸ¥é“æœ€è¿‘è¢«å“ªä¸ªäº‹åŠ¡IDä¿®æ”¹è¿‡ã€‚ä¸€ä¸ªæ–°çš„äº‹åŠ¡å¼€å§‹æ—¶ä¼šæ ¹æ®äº‹åŠ¡é“¾è¡¨æ„é€ ä¸€ä¸ªReadViewã€‚å½“å‰äº‹åŠ¡æ ¹æ®ReadViewä¸­çš„æ•°æ®å»è·Ÿæ£€ç´¢åˆ°çš„æ¯ä¸€æ¡æ•°æ®å»æ ¡éªŒ,çœ‹çœ‹å½“å‰äº‹åŠ¡æ˜¯ä¸æ˜¯èƒ½çœ‹åˆ°è¿™æ¡æ•°æ® 1234567891011121314151617181920212223242526// åˆ¤æ–­æ•°æ®å¯¹åº”çš„èšç°‡ç´¢å¼•ä¸­çš„äº‹åŠ¡idåœ¨è¿™ä¸ªreadviewä¸­æ˜¯å¦å¯è§bool changes_visible( trx_id_t id, // è®°å½•çš„id const table_name_t&amp; name) constMY_ATTRIBUTE((warn_unused_result))&#123; ut_ad(id &gt; 0); // å¦‚æœå½“å‰è®°å½•id &lt; äº‹åŠ¡é“¾è¡¨çš„æœ€å°å€¼æˆ–è€…ç­‰äºåˆ›å»ºè¯¥readviewçš„idå°±æ˜¯å®ƒè‡ªå·±,é‚£ä¹ˆæ˜¯å¯è§çš„ if (id &lt; m_up_limit_id || id == m_creator_trx_id) &#123; return(true); &#125; check_trx_id_sanity(id, name); // å¦‚æœè¯¥è®°å½•çš„äº‹åŠ¡idå¤§äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å¤§å€¼,é‚£ä¹ˆä¸å¯è§ if (id &gt;= m_low_limit_id) &#123; return(false); // å¦‚æœäº‹åŠ¡é“¾è¡¨æ˜¯ç©ºçš„,é‚£ä¹Ÿæ˜¯å¯è§çš„ &#125; else if (m_ids.empty()) &#123; return(true); &#125; const ids_t::value_type* p = m_ids.data(); //åˆ¤æ–­æ˜¯å¦åœ¨ReadViewä¸­ï¼Œå¦‚æœåœ¨è¯´æ˜åœ¨åˆ›å»ºReadViewæ—¶ æ­¤æ¡è®°å½•è¿˜å¤„äºæ´»è·ƒçŠ¶æ€åˆ™ä¸åº”è¯¥æŸ¥è¯¢åˆ°ï¼Œå¦åˆ™è¯´æ˜åˆ›å»ºReadViewæ˜¯æ­¤æ¡è®°å½•å·²ç»æ˜¯ä¸æ´»è·ƒçŠ¶æ€åˆ™å¯ä»¥æŸ¥è¯¢åˆ° return(!std::binary_search(p, p + m_ids.size(), id));&#125; å¯è§æ€§ç®—æ³•é€»è¾‘æ€»ç»“ï¼š å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDå°äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å°å€¼(æ•°æ®è¡Œçš„DB_TRX_ID &lt; m_up_limit_id)è¡¨ç¤ºè¿™ä¸ªæ•°æ®åœ¨å½“å‰äº‹åŠ¡å¼€å¯å‰å°±å·²ç»è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹è¿‡äº†,æ‰€ä»¥æ˜¯å¯è§çš„ã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDè¡¨ç¤ºçš„æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ä¿®æ”¹çš„æ•°æ®(æ•°æ®è¡Œçš„DB_TRX_ID = m_creator_trx_id) æ—¶ï¼Œæ•°æ®å¯è§ã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDå¤§äºäº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å¤§å€¼(æ•°æ®è¡Œçš„DB_TRX_ID &gt;= m_low_limit_id) è¡¨ç¤ºè¿™ä¸ªæ•°æ®åœ¨å½“å‰äº‹åŠ¡å¼€å¯ååˆ°ä¸‹ä¸€æ¬¡æŸ¥è¯¢ä¹‹é—´åˆè¢«å…¶ä»–çš„äº‹åŠ¡ä¿®æ”¹è¿‡,é‚£ä¹ˆå°±æ˜¯ä¸å¯è§çš„ã€‚ å¦‚æœäº‹åŠ¡é“¾è¡¨ä¸ºç©º,é‚£ä¹ˆä¹Ÿæ˜¯å¯è§çš„,ä¹Ÿå°±æ˜¯å½“å‰äº‹åŠ¡å¼€å§‹çš„æ—¶å€™,æ²¡æœ‰å…¶ä»–ä»»æ„ä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œã€‚ å½“æ£€ç´¢åˆ°çš„æ•°æ®çš„äº‹åŠ¡IDåœ¨äº‹åŠ¡é“¾è¡¨ä¸­çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹é—´ï¼Œä»m_low_limit_idåˆ°m_up_limit_idè¿›è¡Œéå†ï¼Œå–å‡ºDB_ROLL_PTRæŒ‡é’ˆæ‰€æŒ‡å‘çš„å›æ»šæ®µçš„äº‹åŠ¡IDï¼ŒæŠŠå®ƒèµ‹å€¼ç»™ trx_id_current ï¼Œç„¶åä»æ­¥éª¤1é‡æ–°å¼€å§‹åˆ¤æ–­ï¼Œè¿™æ ·æ€»èƒ½æœ€åæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„è®°å½•ã€‚ Undo LogUndo logæ˜¯InnoDB MVCCäº‹åŠ¡ç‰¹æ€§çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚å½“æˆ‘ä»¬å¯¹è®°å½•åšäº†å˜æ›´æ“ä½œæ—¶å°±ä¼šäº§ç”ŸUndoè®°å½•ï¼ŒUndoè®°å½•é»˜è®¤è¢«è®°å½•åˆ°ç³»ç»Ÿè¡¨ç©ºé—´(ibdata)ä¸­ï¼Œä½†ä»5.6å¼€å§‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç‹¬ç«‹çš„Undo è¡¨ç©ºé—´ã€‚ Undoè®°å½•ä¸­å­˜å‚¨çš„æ˜¯è€ç‰ˆæœ¬æ•°æ®ï¼Œå½“ä¸€ä¸ªæ—§çš„äº‹åŠ¡éœ€è¦è¯»å–æ•°æ®æ—¶ï¼Œä¸ºäº†èƒ½è¯»å–åˆ°è€ç‰ˆæœ¬çš„æ•°æ®ï¼Œéœ€è¦é¡ºç€undoé“¾æ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•ã€‚å½“ç‰ˆæœ¬é“¾å¾ˆé•¿æ—¶ï¼Œé€šå¸¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œã€‚ Undo Log æ ¼å¼ åœ¨InnoDBå¼•æ“ä¸­ï¼Œundo logåˆ†ä¸ºï¼š insert undo logï¼š insert undo logæ˜¯æŒ‡åœ¨insertæ“ä½œä¸­äº§ç”Ÿçš„undo logï¼Œå› ä¸ºinsertæ“ä½œçš„è®°å½•ï¼Œåªå¯¹äº‹åŠ¡æœ¬èº«å¯è§ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ï¼ˆè¿™æ˜¯äº‹åŠ¡éš”ç¦»æ€§çš„è¦æ±‚ï¼‰ï¼Œæ•…è¯¥undo logå¯ä»¥åœ¨äº‹åŠ¡æäº¤åç›´æ¥åˆ é™¤ï¼Œä¸éœ€è¦è¿›è¡Œpurgeæ“ä½œã€‚ update undo logï¼š update undo logè®°å½•çš„æ˜¯deleteå’Œupdateæ“ä½œäº§ç”Ÿçš„undo logã€‚è¯¥undo logå¯èƒ½éœ€è¦æä¾›MVCCæœºåˆ¶ï¼Œå› æ­¤ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶å°±è¿›è¡Œåˆ é™¤ï¼Œæäº¤æ—¶æ”¾å…¥undo logé“¾è¡¨ï¼Œç­‰å¾…purgeçº¿ç¨‹è¿›è¡Œæœ€åçš„åˆ é™¤ã€‚ä¸‹é¢æ˜¯ä¸¤ç§undo logçš„ç»“æ„å›¾ã€‚ purgeå¯¹äºä¸€æ¡deleteè¯­å¥ delete from t where a = 1ï¼Œå¦‚æœåˆ—aæœ‰èšé›†ç´¢å¼•ï¼Œåˆ™ä¸ä¼šè¿›è¡ŒçœŸæ­£çš„åˆ é™¤ï¼Œè€Œåªæ˜¯åœ¨ä¸»é”®åˆ—ç­‰äº1çš„è®°å½•delete flagè®¾ç½®ä¸º1ï¼Œå³è®°å½•è¿˜æ˜¯å­˜åœ¨åœ¨B+æ ‘ä¸­ã€‚è€Œå¯¹äºupdateæ“ä½œï¼Œä¸æ˜¯ç›´æ¥å¯¹è®°å½•è¿›è¡Œæ›´æ–°ï¼Œè€Œæ˜¯æ ‡è¯†æ—§è®°å½•ä¸ºåˆ é™¤çŠ¶æ€ï¼Œç„¶åæ–°äº§ç”Ÿä¸€æ¡è®°å½•ã€‚é‚£è¿™äº›æ—§ç‰ˆæœ¬æ ‡è¯†ä½åˆ é™¤çš„è®°å½•ä½•æ—¶çœŸæ­£çš„åˆ é™¤ï¼Ÿæ€ä¹ˆåˆ é™¤ï¼Ÿ å…¶å®InnoDBæ˜¯é€šè¿‡undoæ—¥å¿—æ¥è¿›è¡Œæ—§ç‰ˆæœ¬çš„åˆ é™¤æ“ä½œçš„ï¼Œåœ¨InnoDBå†…éƒ¨ï¼Œè¿™ä¸ªæ“ä½œè¢«ç§°ä¹‹ä¸ºpurgeæ“ä½œï¼ŒåŸæ¥åœ¨srv_master_threadä¸»çº¿ç¨‹ä¸­å®Œæˆï¼Œåæ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¼€è¾Ÿäº†purgeçº¿ç¨‹è¿›è¡Œpurgeæ“ä½œï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®purgeçº¿ç¨‹çš„æ•°é‡ã€‚purgeæ“ä½œæ¯10sè¿›è¡Œä¸€æ¬¡ã€‚ ä¸ºäº†èŠ‚çœå­˜å‚¨ç©ºé—´ï¼ŒInnoDBå­˜å‚¨å¼•æ“çš„undo logè®¾è®¡æ˜¯è¿™æ ·çš„ï¼šä¸€ä¸ªé¡µä¸Šå…è®¸å¤šä¸ªäº‹åŠ¡çš„undo logå­˜åœ¨ã€‚è™½ç„¶è¿™ä¸ä»£è¡¨äº‹åŠ¡åœ¨å…¨å±€è¿‡ç¨‹ä¸­æäº¤çš„é¡ºåºï¼Œä½†æ˜¯åé¢çš„äº‹åŠ¡äº§ç”Ÿçš„undo logæ€»åœ¨æœ€åã€‚æ­¤å¤–ï¼ŒInnoDBå­˜å‚¨å¼•æ“è¿˜æœ‰ä¸€ä¸ªhistoryåˆ—è¡¨ï¼Œå®ƒæ ¹æ®äº‹åŠ¡æäº¤çš„é¡ºåºï¼Œå°†undo logè¿›è¡Œè¿æ¥ï¼Œå¦‚ä¸‹é¢çš„ä¸€ç§æƒ…å†µï¼š åœ¨æ‰§è¡Œpurgeè¿‡ç¨‹ä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“é¦–å…ˆä»history listä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªéœ€è¦è¢«æ¸…ç†çš„è®°å½•ï¼Œè¿™é‡Œä¸ºtrx1ï¼Œæ¸…ç†ä¹‹åInnoDBå­˜å‚¨å¼•æ“ä¼šåœ¨trx1æ‰€åœ¨çš„Undo pageä¸­ç»§ç»­å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¯ä»¥è¢«æ¸…ç†çš„è®°å½•ï¼Œè¿™é‡Œä¼šæ‰¾åˆ°äº‹åŠ¡trx3ï¼Œæ¥ç€æ‰¾åˆ°trx5ï¼Œä½†æ˜¯å‘ç°trx5è¢«å…¶ä»–äº‹åŠ¡æ‰€å¼•ç”¨è€Œä¸èƒ½æ¸…ç†ï¼Œæ•…å†å»history listä¸­å–æŸ¥æ‰¾ï¼Œå‘ç°æœ€å°¾ç«¯çš„è®°å½•æ—¶trx2ï¼Œæ¥ç€æ‰¾åˆ°trx2æ‰€åœ¨çš„Undo pageï¼Œä¾æ¬¡æŠŠtrx6ã€trx4æ¸…ç†ï¼Œç”±äºUndo page2ä¸­æ‰€æœ‰çš„è®°å½•éƒ½è¢«æ¸…ç†äº†ï¼Œå› æ­¤è¯¥Undo pageå¯ä»¥è¿›è¡Œé‡ç”¨ã€‚ InnoDBå­˜å‚¨å¼•æ“è¿™ç§å…ˆä»history listä¸­æ‰¾undo logï¼Œç„¶åå†ä»Undo pageä¸­æ‰¾undo logçš„è®¾è®¡æ¨¡å¼æ˜¯ä¸ºäº†é¿å…å¤§é‡éšæœºè¯»æ“ä½œï¼Œä»è€Œæé«˜purgeçš„æ•ˆç‡ã€‚ å¿«ç…§è¯»ä¸å½“å‰è¯»çš„åŒºåˆ«å¯¹äºè¿™ç§è¯»å–å†å²æ•°æ®çš„æ–¹å¼ï¼Œæˆ‘ä»¬å«å®ƒå¿«ç…§è¯» (snapshot read)ï¼Œè€Œè¯»å–æ•°æ®åº“å½“å‰ç‰ˆæœ¬æ•°æ®çš„æ–¹å¼ï¼Œå«å½“å‰è¯» (current read)ã€‚å¾ˆæ˜¾ç„¶ï¼Œåœ¨MVCCä¸­ï¼š å¿«ç…§è¯»ï¼šå°±æ˜¯select select * from table â€¦.; å½“å‰è¯»ï¼šç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œï¼Œå±äºå½“å‰è¯»ï¼Œå¤„ç†çš„éƒ½æ˜¯å½“å‰çš„æ•°æ®ï¼Œéœ€è¦åŠ é”ã€‚ select * from table where ? lock in share mode; select * from table where ? for update; insert; update ; delete; åœºæ™¯ä¸¾ä¾‹ï¼šæ–°å»ºä¸€å¼ æ•°æ®è¡¨userï¼Œåç»­æ‰€æœ‰æ“ä½œéƒ½ä¾æ‰˜äºåˆå§‹åŒ–çš„è¿™ä¸‰æ¡æ•°æ®ã€‚ id name age 1 zhangsan 1 2 lisi 5 3 wangwu 10 æ“ä½œ1ï¼š æ—¶åˆ» t1 t2 1 begin begin 2 update user set name=â€™zhangsan2â€™ where age=1;commit; 3 select * from user where age=1; æ­¤æ—¶ä¸ç®¡æ˜¯RCè¿˜æ˜¯RRï¼Œt1çš„selectéƒ½èƒ½å¤Ÿè¯»å–åˆ°t2updateçš„å€¼ å› ä¸ºåœ¨t1selectçš„æ—¶åˆ»æ‰ä¼šå»ç”Ÿæˆread viewï¼Œæ ¹æ®å¯è§æ€§ç®—æ³•å¾—å‡ºèƒ½çœ‹åˆ°æœ€æ–°çš„t2æ•°æ® æ“ä½œ2: æ—¶åˆ» t1 t2 1 begin begin 2 select * from user where age=1; 3 update user set name=â€™zhangsan2â€™ where age=1;commit; 4 select * from user where age=1; æ­¤æ—¶RCçº§åˆ«ä¸‹ï¼Œt1çš„ ç¬¬äºŒæ¬¡selectèƒ½å¤ŸæŸ¥çœ‹åˆ°t2updateçš„å€¼ï¼Œå› ä¸ºRCçº§åˆ«ä¸‹æ¯æ¬¡selectéƒ½ä¼šç”Ÿæˆæ–°çš„read view åœ¨RRçº§åˆ«ä¸‹ï¼Œt1çš„ ç¬¬äºŒæ¬¡ä¸èƒ½æŸ¥è¯¢åˆ°t2updateçš„å€¼ï¼Œå› ä¸ºRRçº§åˆ«ä¸‹çš„åé¢æŸ¥è¯¢éƒ½æ˜¯ä½¿ç”¨çš„ç¬¬ä¸€æ¬¡selectç”Ÿæˆçš„read view åŒç†ï¼Œt2è¯­å¥ä¸ºinsertæ—¶ä¹Ÿæ˜¯ä¸€æ ·çš„æƒ…å†µã€‚ æ“ä½œ3: æ—¶åˆ» t1 t2 1 begin begin update user set name=â€™zhangsan2â€™ where age=1; 3 insert into user values (4,â€™hahaâ€™,3);waiting~~~ 5 commit; 6 æ’å…¥æˆåŠŸcommit; RRçº§åˆ«ä¸‹ï¼Œt1è¿›è¡Œå½“å‰è¯»æ—¶ï¼Œä¼šå¯¹æ•°æ®åŠ é”ï¼Œå…·ä½“æ˜¯é—´éš™é”ï½œè¡Œé”ï½œnext-keyï¼Œåé¢ç»†è¯´ï¼Œæ­¤æ—¶t2çš„æ’å…¥ä¼šwaitingï¼Œç›´åˆ°t1é‡Šæäº¤äº‹åŠ¡ï¼Œæ¥è§£å†³insertæƒ…å†µä¸‹çš„å¹»è¯»é—®é¢˜ é‚£ä¹ˆï¼Œæ„Ÿè§‰RRå°±å·²ç»è§£å†³äº†å¹»è¯»ï¼Œä¸ºå•¥è¿˜éœ€è¦ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰ï¼Ÿï¼Ÿï¼Ÿ æ“ä½œ4: æ—¶åˆ» t1 t2 1 begin begin select * from user where age=1; 3 insert into user values (4,â€™hahaâ€™,1);commit; 5 update user set name=â€™zhangsan2â€™ where age=1; 6 commit; RRçº§åˆ«ä¸‹ï¼Œæ­¤æ—¶æƒ³è±¡ä¸­çš„ç»“æœä¸ºä¸‹é¢ï¼Œå› ä¸ºå®é™…ä¸Šåœ¨ç¬¬äº”è¡Œå¦‚æœä¸æ˜¯updateè€Œæ˜¯selectï¼Œæ˜¯è‚¯å®šå·®ä¸åˆ°æ–°æ•°æ®çš„ id name age 1 zhangsan2 1 2 lisi 5 3 wangwu 10 4 haha 1 ä½†æ˜¯å®é™…çš„æ•°æ®åº“ä¸­ç»“æœä¸ºï¼š id name age 1 zhangsan2 1 2 lisi 5 3 wangwu 10 4 zhangsan2 1 å…¶å®åœ¨ MySQLåœ¨RRçº§åˆ«ä¸­å¹¶ä¸æ˜¯å®Œå…¨è§£å†³äº†å¹»è¯»çš„é—®é¢˜ï¼Œå¯¹ç…§æ“ä½œ2ä¸­t2ä½¿ç”¨insertã€æ“ä½œ3ã€ä»¥åŠæ“ä½œ4å¯ä»¥çœ‹å‡ºæŸäº›åœºæ™¯ä¸‹RRè§£å†³äº†å¹»è¯»ï¼Œä½†æ˜¯MVCC å¯¹äºå¹»è¯»çš„è§£å†³æ˜¯ä¸å½»åº•çš„ã€‚ï¼ˆå¿«ç…§è¯»å’Œå½“å‰è¯»çš„æ··åˆä½¿ç”¨ä¼šäº§ç”Ÿå¹»è¯»é—®é¢˜ï¼‰","categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"}]},{"title":"ConcurrentHashMapæºç è§£è¯»","slug":"1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap","date":"2021-12-11T04:02:22.769Z","updated":"2021-12-28T12:02:23.924Z","comments":true,"path":"2021/12/11/1.åŸºç¡€çŸ¥è¯†/ConcurrentHashMap/","link":"","permalink":"https://zhangxin66666.github.io/2021/12/11/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ConcurrentHashMap/","excerpt":"","text":"#1.æˆå‘˜å˜é‡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147//æ•£åˆ—è¡¨æ•°ç»„çš„æœ€å¤§é™åˆ¶private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;//æ•£åˆ—è¡¨é»˜è®¤å€¼private static final int DEFAULT_CAPACITY = 16;static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;//å¹¶å‘çº§åˆ«ï¼šjdk7å†å²é—ç•™é—®é¢˜ï¼Œä»…ä»…åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨åˆ°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ä»£è¡¨å¹¶å‘çº§åˆ«private static final int DEFAULT_CONCURRENCY_LEVEL = 16;//è´Ÿè½½å› å­ï¼ŒJDK1.8ä¸­ ConcurrentHashMap æ˜¯å›ºå®šå€¼private static final float LOAD_FACTOR = 0.75f;//æ ‘åŒ–é˜ˆå€¼ï¼ŒæŒ‡å®šæ¡¶ä½ é“¾è¡¨é•¿åº¦è¾¾åˆ°8çš„è¯ï¼Œæœ‰å¯èƒ½å‘ç”Ÿæ ‘åŒ–æ“ä½œã€‚static final int TREEIFY_THRESHOLD = 8;//çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼static final int UNTREEIFY_THRESHOLD = 6;//è”åˆTREEIFY_THRESHOLDæ§åˆ¶æ¡¶ä½æ˜¯å¦æ ‘åŒ–ï¼Œåªæœ‰å½“tableæ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸” æŸä¸ªæ¡¶ä½ ä¸­çš„é“¾è¡¨é•¿åº¦è¾¾åˆ°8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–static final int MIN_TREEIFY_CAPACITY = 64;//çº¿ç¨‹è¿ç§»æ•°æ®æœ€å°æ­¥é•¿ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡æœ€å°åŒºé—´ä¸€ä¸ªå€¼private static final int MIN_TRANSFER_STRIDE = 16;//è®¡ç®—æ‰©å®¹æ—¶å€™ç”Ÿæˆçš„ä¸€ä¸ª æ ‡è¯†æˆ³private static int RESIZE_STAMP_BITS = 16;//ç»“æœæ˜¯65535 è¡¨ç¤ºå¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°private static final int MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1;//æ‰©å®¹ç›¸å…³private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;//å½“nodeèŠ‚ç‚¹hash=-1 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»è¢«è¿ç§»äº† ï¼ŒfwdèŠ‚ç‚¹static final int MOVED = -1; // hash for forwarding nodes//node hash=-2 è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ– ä¸” å½“å‰èŠ‚ç‚¹ä¸ºtreebinå¯¹è±¡ ï¼Œä»£ç†æ“ä½œçº¢é»‘æ ‘static final int TREEBIN = -2; // hash for roots of treesstatic final int RESERVED = -3; // hash for transient reservations//è½¬åŒ–æˆäºŒè¿›åˆ¶å®é™…ä¸Šæ˜¯ 31ä¸ª 1 å¯ä»¥å°†ä¸€ä¸ªè´Ÿæ•°é€šè¿‡ä½ç§»è¿ç®—å¾—åˆ°ä¸€ä¸ªæ­£æ•°static final int HASH_BITS = 0x7fffffff; // usable bits of normal node hash//å½“å‰ç³»ç»Ÿçš„cpuæ•°é‡static final int NCPU = Runtime.getRuntime().availableProcessors();//ä¸ºäº†å…¼å®¹7ç‰ˆæœ¬çš„chpä¿å­˜çš„ï¼Œæ ¸å¿ƒä»£ç å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°private static final ObjectStreamField[] serialPersistentFields = &#123; new ObjectStreamField(&quot;segments&quot;, Segment[].class), new ObjectStreamField(&quot;segmentMask&quot;, Integer.TYPE), new ObjectStreamField(&quot;segmentShift&quot;, Integer.TYPE) &#125;;//æ•£åˆ—è¡¨ï¼Œé•¿åº¦ä¸€å®šæ˜¯2æ¬¡æ–¹æ•°transient volatile Node&lt;K,V&gt;[] table;//æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–°table èµ‹å€¼ç»™nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸ºNullprivate transient volatile Node&lt;K,V&gt;[] nextTable;//LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶ æˆ–è€… å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ°baseCountä¸­private transient volatile long baseCount;/** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private transient volatile int sizeCtl;/** * * æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œè®°å½•å½“å‰è¿›åº¦ã€‚æ‰€æœ‰çº¿ç¨‹éƒ½éœ€è¦ä»transferIndexä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œå»æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ã€‚ */private transient volatile int transferIndex;/** * LongAdderä¸­çš„cellsBuzy 0è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1è¡¨ç¤ºå½“å‰LongAdderå¯¹è±¡åŠ é”çŠ¶æ€ */private transient volatile int cellsBusy;/** * LongAdderä¸­çš„cellsæ•°ç»„ï¼Œå½“baseCountå‘ç”Ÿç«äº‰åï¼Œä¼šåˆ›å»ºcellsæ•°ç»„ï¼Œ * çº¿ç¨‹ä¼šé€šè¿‡è®¡ç®—hashå€¼ å–åˆ° è‡ªå·±çš„cell ï¼Œå°†å¢é‡ç´¯åŠ åˆ°æŒ‡å®šcellä¸­ * æ€»æ•° = sum(cells) + baseCount */private transient volatile CounterCell[] counterCells;// Unsafe mechanicsprivate static final sun.misc.Unsafe U;/**è¡¨ç¤ºsizeCtlå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long SIZECTL;/**è¡¨ç¤ºtransferIndexå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long TRANSFERINDEX;/**è¡¨ç¤ºbaseCountå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long BASECOUNT;/**è¡¨ç¤ºcellsBusyå±æ€§åœ¨ConcurrentHashMapä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLSBUSY;/**è¡¨ç¤ºcellValueå±æ€§åœ¨CounterCellä¸­å†…å­˜åç§»åœ°å€*/private static final long CELLVALUE;/**è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€*/private static final long ABASE;private static final int ASHIFT;static &#123; try &#123; U = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = ConcurrentHashMap.class; SIZECTL = U.objectFieldOffset (k.getDeclaredField(&quot;sizeCtl&quot;)); TRANSFERINDEX = U.objectFieldOffset (k.getDeclaredField(&quot;transferIndex&quot;)); BASECOUNT = U.objectFieldOffset (k.getDeclaredField(&quot;baseCount&quot;)); CELLSBUSY = U.objectFieldOffset (k.getDeclaredField(&quot;cellsBusy&quot;)); Class&lt;?&gt; ck = CounterCell.class; CELLVALUE = U.objectFieldOffset (ck.getDeclaredField(&quot;value&quot;)); Class&lt;?&gt; ak = Node[].class; ABASE = U.arrayBaseOffset(ak); //è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°,scale è¡¨ç¤ºNode[]æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å° int scale = U.arrayIndexScale(ak); //1 0000 &amp; 0 1111 = 0 if ((scale &amp; (scale - 1)) != 0) throw new Error(&quot;data type scale not a power of two&quot;); //numberOfLeadingZeros() è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€å—ã€‚ //8 =&gt; 1000 numberOfLeadingZeros(8) = 28 //4 =&gt; 100 numberOfLeadingZeros(4) = 29 //ASHIFT = 31 - 29 = 2 ï¼Ÿï¼Ÿ //ABASE + ï¼ˆ5 &lt;&lt; ASHIFTï¼‰ ASHIFT = 31 - Integer.numberOfLeadingZeros(scale); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125; #2.åŸºç¡€æ–¹æ³•##2.1 spreadé«˜ä½è¿ç®— 123static final int spread(int h) &#123; return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;&#125; ##2.2 tabAtè¯¥æ–¹æ³•è·å–å¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„å¯¹è±¡fieldçš„å€¼ã€‚å®é™…ä¸Šè¿™æ®µä»£ç çš„å«ä¹‰ç­‰ä»·äºtab[i],ä½†æ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ tab[i]æ¥è®¡ç®—å‘¢ï¼Ÿ getObjectVolatileï¼Œä¸€æ—¦çœ‹åˆ° volatile å…³é”®å­—ï¼Œå°±è¡¨ç¤ºå¯è§æ€§ã€‚å› ä¸ºå¯¹ volatile å†™æ“ä½œ happen-before äº volatile è¯»æ“ä½œï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹å¯¹ table çš„ä¿®æ”¹å‡å¯¹ get è¯»å–å¯è§ï¼› è™½ç„¶ table æ•°ç»„æœ¬èº«æ˜¯å¢åŠ äº† volatile å±æ€§ï¼Œä½†æ˜¯â€œvolatile çš„æ•°ç»„åªé’ˆå¯¹æ•°ç»„çš„å¼•ç”¨å…·æœ‰volatile çš„è¯­ä¹‰ï¼Œè€Œä¸æ˜¯å®ƒçš„å…ƒç´ â€ã€‚ æ‰€ä»¥å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªæ•°ç»„çš„å…ƒç´ è¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ¥è¯»çš„æ—¶å€™ä¸ä¸€å®šèƒ½è¯»åˆ°æœ€æ–°çš„å€¼ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒDoug Lea ç›´æ¥é€šè¿‡ Unsafe ç±»æ¥å¯¹ table è¿›è¡Œæ“ä½œã€‚ 123static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i) &#123; return (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE);&#125; ##2.3 casTabAtcasè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ 1234static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v) &#123; return U.compareAndSwapObject(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, c, v);&#125; ##2.4 setTabAt 123static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v) &#123; U.putObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, v);&#125; ##2.5 resizeStampresizeStamp ç”¨æ¥ç”Ÿæˆä¸€ä¸ªå’Œæ‰©å®¹æœ‰å…³çš„æ‰©å®¹æˆ³ï¼Œå…·ä½“æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ 123static final int resizeStamp(int n) &#123; return Integer.numberOfLeadingZeros(n) | (1 &lt;&lt; (RESIZE_STAMP_BITS - 1));&#125; Integer.numberOfLeadingZeros è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›æ— ç¬¦å·æ•´æ•° n æœ€é«˜ä½é 0 ä½å‰é¢çš„ 0 çš„ä¸ªæ•°ã€‚ æ¯”å¦‚ 10 çš„äºŒè¿›åˆ¶æ˜¯ 0000 0000 0000 0000 0000 0000 0000 1010ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•è¿”å›çš„å€¼å°±æ˜¯ 28ã€‚ æ ¹æ® resizeStamp çš„è¿ç®—é€»è¾‘ï¼Œæˆ‘ä»¬æ¥æ¨æ¼”ä¸€ä¸‹ï¼Œå‡å¦‚ n=16ï¼Œé‚£ä¹ˆ resizeStamp(16)=32796è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ˜¯[0000 0000 0000 0000 1000 0000 0001 1100] æ¥ç€å†æ¥çœ‹,å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç ï¼š U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)rs å·¦ç§» 16 ä½ï¼Œç›¸å½“äºåŸæœ¬çš„äºŒè¿›åˆ¶ä½ä½å˜æˆäº†é«˜ä½ 1000 0000 0001 1100 0000 0000 00000000 ç„¶åå†+2 =1000 0000 0001 1100 0000 0000 0000 0000+10=1000 0000 0001 1100 0000 00000000 0010 é«˜ 16 ä½ä»£è¡¨æ‰©å®¹çš„æ ‡è®°ã€ä½ 16 ä½ä»£è¡¨å¹¶è¡Œæ‰©å®¹çš„çº¿ç¨‹æ•° è¿™æ ·æ¥å­˜å‚¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ 1ï¼Œé¦–å…ˆåœ¨ CHM ä¸­æ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰çš„æ•°ç»„éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹æ¥å…±åŒè´Ÿè´£ 2ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡æ‰©å®¹éƒ½ç”Ÿæˆå”¯ä¸€çš„ç”Ÿæˆæˆ³ï¼Œæ¯æ¬¡æ–°çš„æ‰©å®¹ï¼Œéƒ½æœ‰ä¸€ä¸ªä¸åŒçš„ nï¼Œè¿™ä¸ªç”Ÿæˆæˆ³å°±æ˜¯æ ¹æ® n æ¥è®¡ç®—å‡ºæ¥çš„ä¸€ä¸ªæ•°å­—ï¼Œn ä¸åŒï¼Œè¿™ä¸ªæ•°å­—ä¹Ÿä¸åŒ ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•æ‰©å®¹çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯+2 å› ä¸º 1 è¡¨ç¤ºåˆå§‹åŒ–ï¼Œ2 è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹ï¼Œè€Œä¸”å¯¹ sizeCtl çš„æ“ä½œéƒ½æ˜¯åŸºäºä½è¿ç®—çš„ï¼Œæ‰€ä»¥ä¸ä¼šå…³å¿ƒå®ƒæœ¬èº«çš„æ•°å€¼æ˜¯å¤šå°‘ï¼Œåªå…³å¿ƒå®ƒåœ¨äºŒè¿›åˆ¶ä¸Šçš„æ•°å€¼ï¼Œè€Œ sc + 1 ä¼šåœ¨ä½ 16 ä½ä¸ŠåŠ  1ã€‚##2.6 tableSizeForç»è¿‡å¤šæ¬¡ä½ç§»è¿”å›å¤§äºç­‰äºcçš„æœ€å°çš„äºŒæ¬¡æ–¹æ•° 1234567891011121314151617181920 /** * Returns a power of two table size for the given desired capacity. * See Hackers Delight, sec 3.2 * è¿”å›&gt;=cçš„æœ€å°çš„2çš„æ¬¡æ–¹æ•° * c=28 * n=27 =&gt; 0b 11011 * 11011 | 01101 =&gt; 11111 * 11111 | 00111 =&gt; 11111 * .... * =&gt; 11111 + 1 =100000 = 32 */private static final int tableSizeFor(int c) &#123; int n = c - 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;&#125; #3. æ„é€ æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public ConcurrentHashMap() &#123;&#125;public ConcurrentHashMap(int initialCapacity) &#123; if (initialCapacity &lt; 0) throw new IllegalArgumentException(); //å¦‚æœæŒ‡å®šçš„å®¹é‡è¶…è¿‡å…è®¸çš„æœ€å¤§å€¼ï¼Œè®¾ç½®ä¸ºæœ€å¤§å€¼ int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1)); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125;public ConcurrentHashMap(Map&lt;? extends K, ? extends V&gt; m) &#123; this.sizeCtl = DEFAULT_CAPACITY; putAll(m);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor) &#123; this(initialCapacity, loadFactor, 1);&#125;public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) &#123; //å‚æ•°æ ¡éªŒ if (!(loadFactor &gt; 0.0f) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0) throw new IllegalArgumentException(); //å¦‚æœåˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«ï¼Œé‚£å°±è®¾ç½®åˆå§‹å®¹é‡ä¸ºå¹¶å‘çº§åˆ« if (initialCapacity &lt; concurrencyLevel) initialCapacity = concurrencyLevel; //16/0.75 +1 = 22 long size = (long)(1.0 + (long)initialCapacity / loadFactor); // 22 - &gt; 32 int cap = (size &gt;= (long)MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)size); /** * sizeCtl &gt; 0 * å½“ç›®å‰tableæœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtlè¡¨ç¤ºåˆå§‹åŒ–å®¹é‡ */ this.sizeCtl = cap;&#125; #4.put 1234public V put(K key, V value) &#123; //å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Œé»˜è®¤æ˜¯false return putVal(key, value, false);&#125; #5 putVal 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129final V putVal(K key, V value, boolean onlyIfAbsent) &#123; //æ§åˆ¶k å’Œ v ä¸èƒ½ä¸ºnull if (key == null || value == null) throw new NullPointerException(); //é€šè¿‡spreadæ–¹æ³•ï¼Œå¯ä»¥è®©é«˜ä½ä¹Ÿèƒ½å‚ä¸è¿›å¯»å€è¿ç®—ã€‚ int hash = spread(key.hashCode()); //binCountè¡¨ç¤ºå½“å‰k-v å°è£…æˆnodeåæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½® //0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸ºnullï¼Œnodeå¯ä»¥ç›´æ¥æ”¾ç€ //2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»å¯èƒ½æ˜¯çº¢é»‘æ ‘ int binCount = 0; //tab å¼•ç”¨mapå¯¹è±¡çš„table //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //f è¡¨ç¤ºæ¡¶ä½çš„å¤´ç»“ç‚¹ //n è¡¨ç¤ºæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ //i è¡¨ç¤ºkeyé€šè¿‡å¯»å€è®¡ç®—åï¼Œå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ //fh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„hashå€¼ Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼šæˆç«‹ï¼Œè¡¨ç¤ºå½“å‰mapä¸­çš„tableå°šæœªåˆå§‹åŒ–.. if (tab == null || (n = tab.length) == 0) //æœ€ç»ˆå½“å‰çº¿ç¨‹éƒ½ä¼šè·å–åˆ°æœ€æ–°çš„map.tableå¼•ç”¨ã€‚ tab = initTable(); //CASE2ï¼ši è¡¨ç¤ºkeyä½¿ç”¨è·¯ç”±å¯»å€ç®—æ³•å¾—åˆ° keyå¯¹åº” tableæ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹ f else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123; //è¿›å…¥åˆ°CASE2ä»£ç å— å‰ç½®æ¡ä»¶ å½“å‰tableæ•°ç»„iæ¡¶ä½æ˜¯Nullæ—¶ã€‚ //ä½¿ç”¨CASæ–¹å¼ è®¾ç½® æŒ‡å®šæ•°ç»„iæ¡¶ä½ ä¸º new Node&lt;K,V&gt;(hash, key, value, null),å¹¶ä¸”æœŸæœ›å€¼æ˜¯null //casæ“ä½œæˆåŠŸ è¡¨ç¤ºokï¼Œç›´æ¥break forå¾ªç¯å³å¯ //casæ“ä½œå¤±è´¥ï¼Œè¡¨ç¤ºåœ¨å½“å‰çº¿ç¨‹ä¹‹å‰ï¼Œæœ‰å…¶å®ƒçº¿ç¨‹å…ˆä½ ä¸€æ­¥å‘æŒ‡å®šiæ¡¶ä½è®¾ç½®å€¼äº†ã€‚ //å½“å‰çº¿ç¨‹åªèƒ½å†æ¬¡è‡ªæ—‹ï¼Œå»èµ°å…¶å®ƒé€»è¾‘ã€‚ if (casTabAt(tab, i, null, new Node&lt;K,V&gt;(hash, key, value, null))) break; // no lock when adding to empty bin &#125; //CASE3ï¼šå‰ç½®æ¡ä»¶ï¼Œæ¡¶ä½çš„å¤´ç»“ç‚¹ä¸€å®šä¸æ˜¯nullã€‚ //æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ ä¸º FWDç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰mapæ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­.. else if ((fh = f.hash) == MOVED) //çœ‹åˆ°fwdèŠ‚ç‚¹åï¼Œå½“å‰èŠ‚ç‚¹æœ‰ä¹‰åŠ¡å¸®åŠ©å½“å‰mapå¯¹è±¡å®Œæˆè¿ç§»æ•°æ®çš„å·¥ä½œ //å¸®åŠ©æ‰©å®¹ tab = helpTransfer(tab, f); //CASE4ï¼šå½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else &#123; //å½“æ’å…¥keyå­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™oldValï¼Œè¿”å›ç»™putæ–¹æ³•è°ƒç”¨å¤„.. V oldVal = null; //ä½¿ç”¨sync åŠ é”â€œå¤´èŠ‚ç‚¹â€ï¼Œç†è®ºä¸Šæ˜¯â€œå¤´ç»“ç‚¹â€ synchronized (f) &#123; //ä¸ºä»€ä¹ˆåˆè¦å¯¹æ¯”ä¸€ä¸‹ï¼Œçœ‹çœ‹å½“å‰æ¡¶ä½çš„å¤´èŠ‚ç‚¹ æ˜¯å¦ä¸º ä¹‹å‰è·å–çš„å¤´ç»“ç‚¹ï¼Ÿ //ä¸ºäº†é¿å…å…¶å®ƒçº¿ç¨‹å°†è¯¥æ¡¶ä½çš„å¤´ç»“ç‚¹ä¿®æ”¹æ‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ä»sync åŠ é” å°±æœ‰é—®é¢˜äº†ã€‚ä¹‹åæ‰€æœ‰æ“ä½œéƒ½ä¸ç”¨åœ¨åšäº†ã€‚ if (tabAt(tab, i) == f) &#123;//æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å’±ä»¬ åŠ é” çš„å¯¹è±¡æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥è¿›æ¥é€ äº†ï¼ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰æ¡¶ä½å°±æ˜¯æ™®é€šé“¾è¡¨æ¡¶ä½ã€‚ if (fh &gt;= 0) &#123; //1.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­æ‰€æœ‰å…ƒç´ çš„keyéƒ½ä¸ä¸€è‡´æ—¶ï¼Œå½“å‰çš„æ’å…¥æ“ä½œæ˜¯è¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ //2.å½“å‰æ’å…¥keyä¸é“¾è¡¨å½“ä¸­çš„æŸä¸ªå…ƒç´ çš„keyä¸€è‡´æ—¶ï¼Œå½“å‰æ’å…¥æ“ä½œå¯èƒ½å°±æ˜¯æ›¿æ¢äº†ã€‚binCountè¡¨ç¤ºå†²çªä½ç½®ï¼ˆbinCount - 1ï¼‰ binCount = 1; //è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œeæ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ã€‚ for (Node&lt;K,V&gt; e = f;; ++binCount) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹ key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash æˆç«‹ è¡¨ç¤ºå¾ªç¯çš„å½“å‰å…ƒç´ çš„hashå€¼ä¸æ’å…¥èŠ‚ç‚¹çš„hashå€¼ä¸€è‡´ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ //æ¡ä»¶äºŒï¼š((ek = e.key) == key ||(ek != null &amp;&amp; key.equals(ek))) // æˆç«‹ï¼šè¯´æ˜å¾ªç¯çš„å½“å‰èŠ‚ç‚¹ä¸æ’å…¥èŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå‘ç”Ÿå†²çªäº† if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å°†å½“å‰å¾ªç¯çš„å…ƒç´ çš„ å€¼ èµ‹å€¼ç»™oldVal oldVal = e.val; if (!onlyIfAbsent) e.val = value; break; &#125; //å½“å‰å…ƒç´  ä¸ æ’å…¥å…ƒç´ çš„keyä¸ä¸€è‡´ æ—¶ï¼Œä¼šèµ°ä¸‹é¢ç¨‹åºã€‚ //1.æ›´æ–°å¾ªç¯å¤„ç†èŠ‚ç‚¹ä¸º å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ //2.åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯nullï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æ˜¯é˜Ÿå°¾äº†ï¼Œæ’å…¥æ•°æ®éœ€è¦è¿½åŠ åˆ°é˜Ÿå°¾èŠ‚ç‚¹çš„åé¢ã€‚ Node&lt;K,V&gt; pred = e; if ((e = e.next) == null) &#123; pred.next = new Node&lt;K,V&gt;(hash, key, value, null); break; &#125; &#125; &#125; //å‰ç½®æ¡ä»¶ï¼Œè¯¥æ¡¶ä½ä¸€å®šä¸æ˜¯é“¾è¡¨ //æ¡ä»¶æˆç«‹ï¼Œè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //p è¡¨ç¤ºçº¢é»‘æ ‘ä¸­å¦‚æœä¸ä½ æ’å…¥èŠ‚ç‚¹çš„key æœ‰å†²çªèŠ‚ç‚¹çš„è¯ ï¼Œåˆ™putTreeVal æ–¹æ³• ä¼šè¿”å›å†²çªèŠ‚ç‚¹çš„å¼•ç”¨ã€‚ Node&lt;K,V&gt; p; //å¼ºåˆ¶è®¾ç½®binCountä¸º2ï¼Œå› ä¸ºbinCount &lt;= 1 æ—¶æœ‰å…¶å®ƒå«ä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºäº†2 binCount = 2; //æ¡ä»¶ä¸€ï¼šæˆç«‹ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„keyä¸çº¢é»‘æ ‘ä¸­çš„æŸä¸ªèŠ‚ç‚¹çš„keyä¸€è‡´ï¼Œå†²çªäº† if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != null) &#123; //å°†å†²çªèŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal oldVal = p.val; if (!onlyIfAbsent) p.val = value; &#125; &#125; &#125; &#125; //è¯´æ˜å½“å‰æ¡¶ä½ä¸ä¸ºnullï¼Œå¯èƒ½æ˜¯çº¢é»‘æ ‘ ä¹Ÿå¯èƒ½æ˜¯é“¾è¡¨ if (binCount != 0) &#123; //å¦‚æœbinCount&gt;=8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ if (binCount &gt;= TREEIFY_THRESHOLD) //è°ƒç”¨è½¬åŒ–é“¾è¡¨ä¸ºçº¢é»‘æ ‘çš„æ–¹æ³• treeifyBin(tab, i); //è¯´æ˜å½“å‰çº¿ç¨‹æ’å…¥çš„æ•°æ®keyï¼Œä¸åŸæœ‰k-vå‘ç”Ÿå†²çªï¼Œéœ€è¦å°†åŸæ•°æ®vè¿”å›ç»™è°ƒç”¨è€…ã€‚ if (oldVal != null) return oldVal; break; &#125; &#125; &#125; //1.ç»Ÿè®¡å½“å‰tableä¸€å…±æœ‰å¤šå°‘æ•°æ® //2.åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹ã€‚ addCount(1L, binCount); return null;&#125; #6 initTableæ•°ç»„åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ã€‚ sizeCtl ï¼šè¿™ä¸ªæ ‡å¿—æ˜¯åœ¨ Node æ•°ç»„åˆå§‹åŒ–æˆ–è€…æ‰©å®¹çš„æ—¶å€™çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†ï¼Œè´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–è€…æ‰©å®¹æ“ä½œã€‚ -1 ä»£è¡¨æ­£åœ¨åˆå§‹åŒ– -N ä»£è¡¨æœ‰ N-1 ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè¿™é‡Œä¸æ˜¯ç®€å•çš„ç†è§£æˆ n ä¸ªçº¿ç¨‹ï¼ŒsizeCtl å°±æ˜¯-N 0 æ ‡è¯† Node æ•°ç»„è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ­£æ•°ä»£è¡¨åˆå§‹åŒ–æˆ–è€…ä¸‹ä¸€æ¬¡æ‰©å®¹çš„å¤§å° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/** * Initializes table, using the size recorded in sizeCtl. * * sizeCtl &lt; 0 * * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * * * sizeCtl &gt; 0 * * * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */private final Node&lt;K,V&gt;[] initTable() &#123; //tab å¼•ç”¨map.table //sc sizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab; int sc; //è‡ªæ—‹ æ¡ä»¶ï¼šmap.table å°šæœªåˆå§‹åŒ– while ((tab = table) == null || tab.length == 0) &#123; if ((sc = sizeCtl) &lt; 0) //å¤§æ¦‚ç‡å°±æ˜¯-1ï¼Œè¡¨ç¤ºå…¶å®ƒçº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆ›å»ºtableçš„è¿‡ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ²¡æœ‰ç«äº‰åˆ°åˆå§‹åŒ–tableçš„é”ã€‚ Thread.yield(); // lost initialization race; just spin //1.sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° //2.å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° //3.å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123; try &#123; //è¿™é‡Œä¸ºä»€ä¹ˆåˆè¦åˆ¤æ–­å‘¢ï¼Ÿ é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œç„¶åå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–..å¯¼è‡´ä¸¢å¤±æ•°æ®ã€‚ //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å…¶å®ƒçº¿ç¨‹éƒ½æ²¡æœ‰è¿›å…¥è¿‡è¿™ä¸ªifå—ï¼Œå½“å‰çº¿ç¨‹å°±æ˜¯å…·å¤‡åˆå§‹åŒ–tableæƒåˆ©äº†ã€‚ if ((tab = table) == null || tab.length == 0) &#123; //scå¤§äº0 åˆ›å»ºtableæ—¶ ä½¿ç”¨ scä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼. int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY; @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n]; //æœ€ç»ˆèµ‹å€¼ç»™ map.table table = tab = nt; //n &gt;&gt;&gt; 2 =&gt; ç­‰äº 1/4 n n - (1/4)n = 3/4 n =&gt; 0.75 * n //sc 0.75 n è¡¨ç¤ºä¸‹ä¸€æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ã€‚ sc = n - (n &gt;&gt;&gt; 2); &#125; &#125; finally &#123; //1.å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹è¯ï¼Œscè¡¨ç¤ºçš„æ˜¯ ä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼ //2.è¡¨ç¤ºå½“å‰çº¿ç¨‹ å¹¶ä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºmap.tableçš„çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥åˆ°else if å— æ—¶ï¼Œå°† //sizeCtl è®¾ç½®ä¸ºäº†-1 ï¼Œé‚£ä¹ˆè¿™æ—¶éœ€è¦å°†å…¶ä¿®æ”¹ä¸º è¿›å…¥æ—¶çš„å€¼ã€‚ sizeCtl = sc; &#125; break; &#125; &#125; return tab;&#125; #7 addCount 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124private final void addCount(long x, int check) &#123; //as è¡¨ç¤º LongAdder.cells //b è¡¨ç¤ºLongAdder.base //s è¡¨ç¤ºå½“å‰map.tableä¸­å…ƒç´ çš„æ•°é‡ CounterCell[] as; long b, s; //æ¡ä»¶ä¸€ï¼štrue-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®ç´¯åŠ åˆ° base //æ¡ä»¶äºŒï¼šfalse-&gt;è¡¨ç¤ºå†™baseæˆåŠŸï¼Œæ•°æ®ç´¯åŠ åˆ°baseä¸­äº†ï¼Œå½“å‰ç«äº‰ä¸æ¿€çƒˆï¼Œä¸éœ€è¦åˆ›å»ºcells // true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ if ((as = counterCells) != null || !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) &#123; //æœ‰å‡ ç§æƒ…å†µè¿›å…¥åˆ°ifå—ä¸­ï¼Ÿ //1.true-&gt;è¡¨ç¤ºcellså·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»ä½¿ç”¨hashå¯»å€æ‰¾åˆ°åˆé€‚çš„cell å»ç´¯åŠ æ•°æ® //2.true-&gt;è¡¨ç¤ºå†™baseå¤±è´¥ï¼Œä¸å…¶ä»–çº¿ç¨‹åœ¨baseä¸Šå‘ç”Ÿäº†ç«äº‰ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å»å°è¯•åˆ›å»ºcellsã€‚ //a è¡¨ç¤ºå½“å‰çº¿ç¨‹hashå¯»å€å‘½ä¸­çš„cell CounterCell a; //v è¡¨ç¤ºå½“å‰çº¿ç¨‹å†™cellæ—¶çš„æœŸæœ›å€¼ long v; //m è¡¨ç¤ºå½“å‰cellsæ•°ç»„çš„é•¿åº¦ int m; //true -&gt; æœªç«äº‰ false-&gt;å‘ç”Ÿç«äº‰ boolean uncontended = true; //æ¡ä»¶ä¸€ï¼šas == null || (m = as.length - 1) &lt; 0 //true-&gt; è¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯é€šè¿‡ å†™baseç«äº‰å¤±è´¥ ç„¶åè¿›å…¥çš„ifå—ï¼Œå°±éœ€è¦è°ƒç”¨fullAddCountæ–¹æ³•å»æ‰©å®¹ æˆ–è€… é‡è¯•.. LongAdder.longAccumulate //æ¡ä»¶äºŒï¼ša = as[ThreadLocalRandom.getProbe() &amp; m]) == null å‰ç½®æ¡ä»¶ï¼šcellså·²ç»åˆå§‹åŒ–äº† //true-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„cellè¡¨æ ¼æ˜¯ä¸ªç©ºï¼Œéœ€è¦å½“å‰çº¿ç¨‹è¿›å…¥fullAddCountæ–¹æ³•å»åˆå§‹åŒ– cellï¼Œæ”¾å…¥å½“å‰ä½ç½®. //æ¡ä»¶ä¸‰ï¼š!(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x) // false-&gt;å–åå¾—åˆ°falseï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellæˆåŠŸ // true-&gt;å–åå¾—åˆ°true,è¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨casæ–¹å¼æ›´æ–°å½“å‰å‘½ä¸­çš„cellå¤±è´¥ï¼Œéœ€è¦è¿›å…¥fullAddCountè¿›è¡Œé‡è¯• æˆ–è€… æ‰©å®¹ cellsã€‚ if (as == null || (m = as.length - 1) &lt; 0 || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null || !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x)) ) &#123; fullAddCount(x, uncontended); //è€ƒè™‘åˆ°fullAddCounté‡Œé¢çš„äº‹æƒ…æ¯”è¾ƒç´¯ï¼Œå°±è®©å½“å‰çº¿ç¨‹ ä¸å‚ä¸åˆ° æ‰©å®¹ç›¸å…³çš„é€»è¾‘äº†ï¼Œç›´æ¥è¿”å›åˆ°è°ƒç”¨ç‚¹ã€‚ return; &#125; if (check &lt;= 1) return; //è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼ s = sumCount(); &#125; //è¡¨ç¤ºä¸€å®šæ˜¯ä¸€ä¸ªputæ“ä½œè°ƒç”¨çš„addCount if (check &gt;= 0) &#123; //tab è¡¨ç¤ºmap.table //nt è¡¨ç¤ºmap.nextTable //n è¡¨ç¤ºmap.tableæ•°ç»„çš„é•¿åº¦ //sc è¡¨ç¤ºsizeCtlçš„ä¸´æ—¶å€¼ Node&lt;K,V&gt;[] tab, nt; int n, sc; /** * sizeCtl &lt; 0 * 1. -1 è¡¨ç¤ºå½“å‰tableæ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»ºtableæ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾….. * 2.è¡¨ç¤ºå½“å‰tableæ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ ,é«˜16ä½è¡¨ç¤ºï¼šæ‰©å®¹çš„æ ‡è¯†æˆ³ ä½16ä½è¡¨ç¤ºï¼šï¼ˆ1 + nThreadï¼‰ å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ * * sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»ºtableæ•°ç»„æ—¶ ä½¿ç”¨DEFAULT_CAPACITYä¸ºå¤§å° * * sizeCtl &gt; 0 * * 1. å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å° * 2. å¦‚æœtableå·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„ è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼‰ */ //è‡ªæ—‹ //æ¡ä»¶ä¸€ï¼šs &gt;= (long)(sc = sizeCtl) // true-&gt; 1.å½“å‰sizeCtlä¸ºä¸€ä¸ªè´Ÿæ•° è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­.. // 2.å½“å‰sizeCtlæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼ // false-&gt; è¡¨ç¤ºå½“å‰tableå°šæœªè¾¾åˆ°æ‰©å®¹æ¡ä»¶ //æ¡ä»¶äºŒï¼š(tab = table) != null // æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š(n = tab.length) &lt; MAXIMUM_CAPACITY // true-&gt;å½“å‰tableé•¿åº¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œåˆ™å¯ä»¥è¿›è¡Œæ‰©å®¹ã€‚ while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp; (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123; //æ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ //16 -&gt; 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011 int rs = resizeStamp(n); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰tableæ­£åœ¨æ‰©å®¹ // å½“å‰çº¿ç¨‹ç†è®ºä¸Šåº”è¯¥ååŠ©tableå®Œæˆæ‰©å®¹ if (sc &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼š(nt = nextTable) == null // true-&gt;è¡¨ç¤ºæœ¬æ¬¡æ‰©å®¹ç»“æŸ // false-&gt;æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0) break; //å‰ç½®æ¡ä»¶ï¼šå½“å‰tableæ­£åœ¨æ‰§è¡Œæ‰©å®¹ä¸­.. å½“å‰çº¿ç¨‹æœ‰æœºä¼šå‚ä¸è¿›æ‰©å®¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸå‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå¹¶ä¸”å°†scä½16ä½å€¼åŠ 1ï¼Œè¡¨ç¤ºå¤šäº†ä¸€ä¸ªçº¿ç¨‹å‚ä¸å·¥ä½œ //æ¡ä»¶å¤±è´¥ï¼š1.å½“å‰æœ‰å¾ˆå¤šçº¿ç¨‹éƒ½åœ¨æ­¤å¤„å°è¯•ä¿®æ”¹sizeCtlï¼Œæœ‰å…¶å®ƒä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æˆåŠŸäº†ï¼Œå¯¼è‡´ä½ çš„scæœŸæœ›å€¼ä¸å†…å­˜ä¸­çš„å€¼ä¸ä¸€è‡´ ä¿®æ”¹å¤±è´¥ // 2.transfer ä»»åŠ¡å†…éƒ¨çš„çº¿ç¨‹ä¹Ÿä¿®æ”¹äº†sizeCtlã€‚ if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) //ååŠ©æ‰©å®¹çº¿ç¨‹ï¼ŒæŒæœ‰nextTableå‚æ•° transfer(tab, nt); &#125; //1000 0000 0001 1011 0000 0000 0000 0000 +2 =&gt; 1000 0000 0001 1011 0000 0000 0000 0010 //æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨transferæ–¹æ³•éœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)) //è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ ä¸æŒæœ‰nextTable transfer(tab, null); s = sumCount(); &#125; &#125;&#125; #8. transferConcurrentHashMap æ”¯æŒå¹¶å‘æ‰©å®¹ï¼Œå®ç°æ–¹å¼æ˜¯ï¼ŒæŠŠ Node æ•°ç»„è¿›è¡Œæ‹†åˆ†ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å¤„ç†è‡ªå·±çš„åŒºåŸŸï¼Œå‡è®¾ table æ•°ç»„æ€»é•¿åº¦æ˜¯ 64ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å¯ä»¥åˆ†åˆ° 16 ä¸ª bucketã€‚ç„¶åæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„èŒƒå›´ï¼ŒæŒ‰ç…§å€’åºæ¥åšè¿ç§»ã€‚ é€šè¿‡ for è‡ªå¾ªç¯å¤„ç†æ¯ä¸ªæ§½ä½ä¸­çš„é“¾è¡¨å…ƒç´ ï¼Œé»˜è®¤ advace ä¸ºçœŸï¼Œé€šè¿‡ CAS è®¾ç½® transferIndexå±æ€§å€¼ï¼Œå¹¶åˆå§‹åŒ– i å’Œ bound å€¼ï¼Œi æŒ‡å½“å‰å¤„ç†çš„æ§½ä½åºå·ï¼Œbound æŒ‡éœ€è¦å¤„ç†çš„æ§½ä½è¾¹ç•Œï¼Œå…ˆå¤„ç†æ§½ä½ 31 çš„èŠ‚ç‚¹ï¼› ï¼ˆbound,iï¼‰ =(16,31) ä» 31 çš„ä½ç½®å¾€å‰æ¨åŠ¨ã€‚ æ¯å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ‰©å®¹æ“ä½œï¼Œå°±é€šè¿‡ cas æ‰§è¡Œ sc-1ã€‚ æ¥ç€åˆ¤æ–­(sc-2) !=resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT ; å¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºå½“å‰ä¸ºæ•´ä¸ªæ‰©å®¹æ“ä½œçš„ æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ„å‘³ç€æ•´ä¸ªæ‰©å®¹æ“ä½œå°±ç»“æŸäº†ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜è¿˜å¾—ç»§ç»­ã€‚ è¿™ä¹ˆåšçš„ç›®çš„ï¼Œä¸€æ–¹é¢æ˜¯é˜²æ­¢ä¸åŒæ‰©å®¹ä¹‹é—´å‡ºç°ç›¸åŒçš„ sizeCtlï¼Œå¦å¤–ä¸€æ–¹é¢ï¼Œè¿˜å¯ä»¥é¿å…sizeCtl çš„ ABA é—®é¢˜å¯¼è‡´çš„æ‰©å®¹é‡å çš„æƒ…å†µã€‚ æ‰©å®¹å›¾è§£åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å½“æ›´æ–°åçš„é”®å€¼å¯¹æ€»æ•° baseCount &gt;= é˜ˆå€¼ sizeCtl æ—¶ï¼Œè¿›è¡Œrehashï¼Œè¿™é‡Œé¢ä¼šæœ‰ä¸¤ä¸ªé€»è¾‘ã€‚ å¦‚æœå½“å‰æ­£åœ¨å¤„äºæ‰©å®¹é˜¶æ®µï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šåŠ å…¥å¹¶ä¸”ååŠ©æ‰©å®¹ã€‚ å¦‚æœå½“å‰æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œåˆ™ç›´æ¥è§¦å‘æ‰©å®¹æ“ä½œã€‚ æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®çš„è½¬ç§»å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯æŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ä½†æ˜¯è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåœ¨æ‰©å®¹çš„æ—¶å€™å…¶ä»–çº¿ç¨‹ä¹Ÿå¯èƒ½æ­£åœ¨æ·»åŠ å…ƒç´ ï¼Œè¿™æ—¶åˆè§¦å‘äº†æ‰©å®¹æ€ä¹ˆåŠï¼Ÿå¯èƒ½å¤§å®¶æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åŠ äº’æ–¥é”ï¼ŒæŠŠè½¬ç§»è¿‡ç¨‹é”ä½ï¼Œè™½ç„¶æ˜¯å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¼šå¸¦æ¥è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ã€‚å› ä¸ºäº’æ–¥é”ä¼šå¯¼è‡´æ‰€æœ‰è®¿é—®ä¸´ç•ŒåŒºçš„çº¿ç¨‹é™·å…¥åˆ°é˜»å¡çŠ¶æ€ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹è€—æ—¶è¶Šé•¿ï¼Œå…¶ä»–ç«äº‰çº¿ç¨‹å°±ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¯¼è‡´ååé‡è¾ƒä½ã€‚è€Œä¸”è¿˜å¯èƒ½å¯¼è‡´æ­»é”ã€‚ è€Œ ConcurrentHashMap å¹¶æ²¡æœ‰ç›´æ¥åŠ é”ï¼Œè€Œæ˜¯é‡‡ç”¨ CAS å®ç°æ— é”çš„å¹¶å‘åŒæ­¥ç­–ç•¥ï¼Œæœ€ç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ã€‚ å®ƒæŠŠ Node æ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹é”è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingNodeèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å®ƒçš„æºç å®ç°ã€‚ fwd:è¿™ä¸ªç±»æ˜¯ä¸ªæ ‡è¯†ç±»ï¼Œç”¨äºæŒ‡å‘æ–°è¡¨ç”¨çš„ï¼Œå…¶ä»–çº¿ç¨‹é‡åˆ°è¿™ä¸ªç±»ä¼šä¸»åŠ¨è·³è¿‡è¿™ä¸ªç±»ï¼Œå› ä¸ºè¿™ä¸ªç±»è¦ä¹ˆå°±æ˜¯æ‰©å®¹è¿ç§»æ­£åœ¨è¿›è¡Œï¼Œè¦ä¹ˆå°±æ˜¯å·²ç»å®Œæˆæ‰©å®¹è¿ç§»ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç±»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå†è¿›è¡Œæ“ä½œã€‚ advance:è¿™ä¸ªå˜é‡æ˜¯ç”¨äºæç¤ºä»£ç æ˜¯å¦è¿›è¡Œæ¨è¿›å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ¡¶å¤„ç†å®Œï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ¡¶çš„æ ‡è¯†ã€‚ finishing:è¿™ä¸ªå˜é‡ç”¨äºæç¤ºæ‰©å®¹æ˜¯å¦ç»“æŸç”¨çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) &#123; //n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰tableæ•°ç»„çš„é•¿åº¦ //stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ int n = tab.length, stride; // stride å›ºå®šä¸º 16 if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE) stride = MIN_TRANSFER_STRIDE; // subdivide range //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œ //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯ååŠ©æ‰©å®¹çš„çº¿ç¨‹.. if (nextTab == null) &#123; // initiating try &#123; //åˆ›å»ºäº†ä¸€ä¸ªæ¯”æ‰©å®¹ä¹‹å‰å¤§ä¸€å€çš„table @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1]; nextTab = nt; &#125; catch (Throwable ex) &#123; // try to cope with OOME sizeCtl = Integer.MAX_VALUE; return; &#125; //èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTable ï¼Œæ–¹ä¾¿ååŠ©æ‰©å®¹çº¿ç¨‹ æ‹¿åˆ°æ–°è¡¨ nextTable = nextTab; //è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ã€‚indexè®¡æ•°æ˜¯ä»1å¼€å§‹è®¡ç®—çš„ã€‚ transferIndex = n; &#125; //è¡¨ç¤ºæ–°æ•°ç»„çš„é•¿åº¦ int nextn = nextTab.length; //fwd èŠ‚ç‚¹ï¼Œå½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸ºfwdèŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹ æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œä¼šæœ‰ä¸åŒé€»è¾‘ã€‚ ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab); //æ¨è¿›æ ‡è®° boolean advance = true; //å®Œæˆæ ‡è®° boolean finishing = false; // to ensure sweep before committing nextTab //i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½ //bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ int i = 0, bound = 0; //è‡ªæ—‹ for (;;) &#123; //f æ¡¶ä½çš„å¤´ç»“ç‚¹ //fh å¤´ç»“ç‚¹çš„hash Node&lt;K,V&gt; f; int fh; /** * 1.ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡åŒºé—´ * 2.ç»´æŠ¤å½“å‰çº¿ç¨‹ä»»åŠ¡è¿›åº¦ï¼ˆi è¡¨ç¤ºå½“å‰å¤„ç†çš„æ¡¶ä½ï¼‰ * 3.ç»´æŠ¤mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„è¿›åº¦ */ while (advance) &#123; //åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ //åˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡ int nextIndex, nextBound; //CASE1: //æ¡ä»¶ä¸€ï¼š--i &gt;= bound //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œè¿˜æœ‰ç›¸åº”çš„åŒºé—´çš„æ¡¶ä½è¦å¤„ç†ï¼Œ--i å°±è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ª æ¡¶ä½. //ä¸æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… if (--i &gt;= bound || finishing) advance = false; //CASE2: //å‰ç½®æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹ä»»åŠ¡å·²å®Œæˆ æˆ– è€…æœªåˆ†é… //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½éƒ½åˆ†é…å®Œæ¯•äº†ï¼Œæ²¡æœ‰åŒºé—´å¯åˆ†é…äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„iå˜é‡ä¸º-1 è·³å‡ºå¾ªç¯åï¼Œæ‰§è¡Œé€€å‡ºè¿ç§»ä»»åŠ¡ç›¸å…³çš„ç¨‹åº //æ¡ä»¶ä¸æˆç«‹ï¼šè¡¨ç¤ºå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„æ¡¶ä½å°šæœªåˆ†é…å®Œæ¯•ï¼Œè¿˜æœ‰åŒºé—´å¯åˆ†é… else if ((nextIndex = transferIndex) &lt;= 0) &#123; i = -1; advance = false; &#125; //CASE3: //å‰ç½®æ¡ä»¶ï¼š1ã€å½“å‰çº¿ç¨‹éœ€è¦åˆ†é…ä»»åŠ¡åŒºé—´ 2.å…¨å±€èŒƒå›´å†…è¿˜æœ‰æ¡¶ä½å°šæœªè¿ç§» //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜ç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡æˆåŠŸ //æ¡ä»¶å¤±è´¥ï¼šè¯´æ˜åˆ†é…ç»™å½“å‰çº¿ç¨‹å¤±è´¥ï¼Œåº”è¯¥æ˜¯å’Œå…¶å®ƒçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰å§ else if (U.compareAndSwapInt (this, TRANSFERINDEX, nextIndex, nextBound = (nextIndex &gt; stride ? nextIndex - stride : 0))) &#123; bound = nextBound; i = nextIndex - 1; advance = false; &#125; &#125; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼ši &lt; 0 //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) &#123; //ä¿å­˜sizeCtl çš„å˜é‡ int sc; if (finishing) &#123; nextTable = null; table = nextTab; sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1); return; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜è®¾ç½®sizeCtl ä½16ä½ -1 æˆåŠŸï¼Œå½“å‰çº¿ç¨‹å¯ä»¥æ­£å¸¸é€€å‡º if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) &#123; //1000 0000 0001 1011 0000 0000 0000 0000 //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯æœ€åä¸€ä¸ªé€€å‡ºtransferä»»åŠ¡çš„çº¿ç¨‹ if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) //æ­£å¸¸é€€å‡º return; finishing = advance = true; i = n; // recheck before commit &#125; &#125; //å‰ç½®æ¡ä»¶ï¼šã€CASE2~CASE4ã€‘ å½“å‰çº¿ç¨‹ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œæ­£åœ¨è¿›è¡Œä¸­ //CASE2: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸ºfwdèŠ‚ç‚¹å³å¯ã€‚ else if ((f = tabAt(tab, i)) == null) advance = casTabAt(tab, i, null, fwd); //CASE3: //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å†æ¬¡æ›´æ–°å½“å‰çº¿ç¨‹ä»»åŠ¡ç´¢å¼•ï¼Œå†æ¬¡å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½ æˆ–è€… å…¶å®ƒæ“ä½œ else if ((fh = f.hash) == MOVED) advance = true; // already processed //CASE4: //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸”nodeèŠ‚ç‚¹ ä¸æ˜¯ fwdèŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»ã€‚ else &#123; //sync åŠ é”å½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ synchronized (f) &#123; //é˜²æ­¢åœ¨ä½ åŠ é”å¤´å¯¹è±¡ä¹‹å‰ï¼Œå½“å‰æ¡¶ä½çš„å¤´å¯¹è±¡è¢«å…¶å®ƒå†™çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œå¯¼è‡´ä½ ç›®å‰åŠ é”å¯¹è±¡é”™è¯¯... if (tabAt(tab, i) == f) &#123; //ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨ //hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨ Node&lt;K,V&gt; ln, hn; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½ if (fh &gt;= 0) &#123; //lastRun //å¯ä»¥è·å–å‡º å½“å‰é“¾è¡¨ æœ«å°¾è¿ç»­é«˜ä½ä¸å˜çš„ node int runBit = fh &amp; n; Node&lt;K,V&gt; lastRun = f; for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º ä½ä½é“¾è¡¨ï¼Œé‚£ä¹ˆå°±è®© ln æŒ‡å‘ ä½ä½é“¾è¡¨ if (runBit == 0) &#123; ln = lastRun; hn = null; &#125; //å¦åˆ™ï¼Œè¯´æ˜lastRunå¼•ç”¨çš„é“¾è¡¨ä¸º é«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘ é«˜ä½é“¾è¡¨ else &#123; hn = lastRun; ln = null; &#125; for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn); &#125; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ ä»£ç†ç»“ç‚¹TreeBin else if (f instanceof TreeBin) &#123; //è½¬æ¢å¤´ç»“ç‚¹ä¸º treeBinå¼•ç”¨ t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //ä½ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘ä½ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘ä½ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; lo = null, loTail = null; //é«˜ä½åŒå‘é“¾è¡¨ lo æŒ‡å‘é«˜ä½é“¾è¡¨çš„å¤´ loTail æŒ‡å‘é«˜ä½é“¾è¡¨çš„å°¾å·´ TreeNode&lt;K,V&gt; hi = null, hiTail = null; //lc è¡¨ç¤ºä½ä½é“¾è¡¨å…ƒç´ æ•°é‡ //hc è¡¨ç¤ºé«˜ä½é“¾è¡¨å…ƒç´ æ•°é‡ int lc = 0, hc = 0; //è¿­ä»£TreeBinä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹ è‡³ å°¾èŠ‚ç‚¹ for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) &#123; // h è¡¨ç¤ºå¾ªç¯å¤„ç†å½“å‰å…ƒç´ çš„ hash int h = e.hash; //ä½¿ç”¨å½“å‰èŠ‚ç‚¹ æ„å»ºå‡ºæ¥çš„ æ–°çš„ TreeNode TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt; (h, e.key, e.val, null, null); //æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹ å±äºä½ä½é“¾ èŠ‚ç‚¹ if ((h &amp; n) == 0) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä½ä½é“¾è¡¨ è¿˜æ²¡æœ‰æ•°æ® if ((p.prev = loTail) == null) lo = p; //è¯´æ˜ ä½ä½é“¾è¡¨å·²ç»æœ‰æ•°æ®äº†ï¼Œæ­¤æ—¶å½“å‰å…ƒç´  è¿½åŠ åˆ° ä½ä½é“¾è¡¨çš„æœ«å°¾å°±è¡Œäº† else loTail.next = p; //å°†ä½ä½é“¾è¡¨å°¾æŒ‡é’ˆæŒ‡å‘ p èŠ‚ç‚¹ loTail = p; ++lc; &#125; //å½“å‰èŠ‚ç‚¹ å±äº é«˜ä½é“¾ èŠ‚ç‚¹ else &#123; if ((p.prev = hiTail) == null) hi = p; else hiTail.next = p; hiTail = p; ++hc; &#125; &#125; ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) : (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t; hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) : (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t; setTabAt(nextTab, i, ln); setTabAt(nextTab, i + n, hn); setTabAt(tab, i, fwd); advance = true; &#125; &#125; &#125; &#125; &#125;&#125; é“¾è¡¨è¿ç§»åŸç† 1ï¼‰é«˜ä½ä½åŸç†åˆ†æ ConcurrentHashMap åœ¨åšé“¾è¡¨è¿ç§»æ—¶ï¼Œä¼šç”¨é«˜ä½ä½æ¥å®ç°ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜è¦åˆ†æä¸€ä¸‹ 1ï¼Œå¦‚ä½•å®ç°é«˜ä½ä½é“¾è¡¨çš„åŒºåˆ† å‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªé˜Ÿåˆ—ç¬¬ 14 ä¸ªæ§½ä½æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åï¼Œé“¾è¡¨å…ƒç´ ä¸ªæ•°å·²ç»è¾¾åˆ°äº† 8ï¼Œä¸”æ•°ç»„é•¿åº¦ä¸º 16ï¼Œä¼˜å…ˆé€šè¿‡æ‰©å®¹æ¥ç¼“è§£é“¾è¡¨è¿‡é•¿çš„é—®é¢˜ å‡å¦‚å½“å‰çº¿ç¨‹æ­£åœ¨å¤„ç†æ§½ä½ä¸º 14 çš„èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œåœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆå®šä¹‰ä¸¤ä¸ªå˜é‡èŠ‚ç‚¹ ln å’Œ hnï¼Œå®é™…å°±æ˜¯ lowNode å’Œ HighNodeï¼Œåˆ†åˆ«ä¿å­˜ hash å€¼çš„ç¬¬ x ä½ä¸º 0 å’Œä¸ç­‰äº0 çš„èŠ‚ç‚¹ é€šè¿‡ fn&amp;n å¯ä»¥æŠŠè¿™ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ åˆ†ä¸ºä¸¤ç±»ï¼ŒA ç±»æ˜¯ hash å€¼çš„ç¬¬ X ä½ä¸º 0ï¼ŒB ç±»æ˜¯ hash å€¼çš„ç¬¬ x ä½ä¸ºä¸ç­‰äº 0ï¼ˆè‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåŒºåˆ†ï¼Œç¨ååˆ†æï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ lastRun è®°å½•æœ€åè¦å¤„ç†çš„èŠ‚ç‚¹ã€‚æœ€ç»ˆè¦è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼ŒA ç±»çš„é“¾è¡¨ä¿æŒä½ç½®ä¸åŠ¨ï¼ŒB ç±»çš„é“¾è¡¨ä¸º 14+16(æ‰©å®¹å¢åŠ çš„é•¿åº¦)=30 æŠŠ 14 æ§½ä½çš„é“¾è¡¨å•ç‹¬ä¼¶å‡ºæ¥ï¼Œç”¨è“è‰²è¡¨ç¤º fn&amp;n=0 çš„èŠ‚ç‚¹ï¼Œå‡å¦‚é“¾è¡¨çš„åˆ†ç±»æ˜¯è¿™æ · 1234567for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125;&#125; é€šè¿‡ä¸Šé¢è¿™æ®µä»£ç éå†ï¼Œä¼šè®°å½• runBit ä»¥åŠ lastRunï¼ŒæŒ‰ç…§ä¸Šé¢è¿™ä¸ªç»“æ„ï¼Œé‚£ä¹ˆ runBit åº”è¯¥æ˜¯è“è‰²èŠ‚ç‚¹ï¼ŒlastRun åº”è¯¥æ˜¯ç¬¬ 6 ä¸ªèŠ‚ç‚¹æ¥ç€ï¼Œå†é€šè¿‡è¿™æ®µä»£ç è¿›è¡Œéå†ï¼Œç”Ÿæˆ ln é“¾ä»¥åŠ hn é“¾ 1234567for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);&#125; æ¥ç€ï¼Œé€šè¿‡ CAS æ“ä½œï¼ŒæŠŠ hn é“¾æ”¾åœ¨ i+n ä¹Ÿå°±æ˜¯ 14+16 çš„ä½ç½®ï¼Œln é“¾ä¿æŒåŸæ¥çš„ä½ç½®ä¸åŠ¨ã€‚å¹¶ä¸”è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º fwdï¼Œè¡¨ç¤ºå·²ç»è¢«å½“å‰çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ 123setTabAt(nextTab, i, ln);setTabAt(nextTab, i + n, hn);setTabAt(tab, i, fwd); è¿ç§»å®Œæˆä»¥åçš„æ•°æ®åˆ†å¸ƒå¦‚ä¸‹ 2ï¼‰ä¸ºä»€ä¹ˆè¦åšé«˜ä½ä½çš„åˆ’åˆ† è¦æƒ³äº†è§£è¿™ä¹ˆè®¾è®¡çš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦ä» ConcurrentHashMap çš„æ ¹æ®ä¸‹æ ‡è·å–å¯¹è±¡çš„ç®—æ³•æ¥çœ‹ï¼Œåœ¨ putVal æ–¹æ³•ä¸­ 1018 è¡Œï¼š (f = tabAt(tab, i = (n - 1) &amp; hash)) == null é€šè¿‡(n-1) &amp; hash æ¥è·å¾—åœ¨ table ä¸­çš„æ•°ç»„ä¸‹æ ‡æ¥è·å–èŠ‚ç‚¹æ•°æ®ï¼Œã€&amp;è¿ç®—æ˜¯äºŒè¿›åˆ¶è¿ç®—ç¬¦ï¼Œ1&amp; 1=1ï¼Œå…¶ä»–éƒ½ä¸º 0ã€‘ã€‚ #9.helpTransferå¦‚æœå¯¹åº”çš„èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ hash æ˜¯ä¸æ˜¯ç­‰äº MOVED(-1)ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ForwardingNode èŠ‚ç‚¹ï¼Œæ„å‘³ç€æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé‚£ä¹ˆå½“å‰ç°åœ¨ç›´æ¥å¸®åŠ©å®ƒè¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤è°ƒç”¨ helpTransferæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455final Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123; //nextTab å¼•ç”¨çš„æ˜¯ fwd.nextTable == map.nextTable ç†è®ºä¸Šæ˜¯è¿™æ ·ã€‚ //sc ä¿å­˜map.sizeCtl Node&lt;K,V&gt;[] nextTab; int sc; //æ¡ä»¶ä¸€ï¼štab != null æ’æˆç«‹ true //æ¡ä»¶äºŒï¼š(f instanceof ForwardingNode) æ’æˆç«‹ true //æ¡ä»¶ä¸‰ï¼š((ForwardingNode&lt;K,V&gt;)f).nextTable) != null æ’æˆç«‹ true if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp; (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != null) &#123; //æ‹¿å½“å‰æ ‡çš„é•¿åº¦ è·å– æ‰©å®¹æ ‡è¯†æˆ³ å‡è®¾ 16 -&gt; 32 æ‰©å®¹ï¼š1000 0000 0001 1011 int rs = resizeStamp(tab.length); //æ¡ä»¶ä¸€ï¼šnextTab == nextTable //æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼š1.nextTableè¢«è®¾ç½®ä¸ºNull äº†ï¼Œæ‰©å®¹å®Œæ¯•åï¼Œä¼šè¢«è®¾ä¸ºNull // 2.å†æ¬¡å‡ºå‘æ‰©å®¹äº†...å’±ä»¬æ‹¿åˆ°çš„nextTab ä¹Ÿå·²ç»è¿‡æœŸäº†... //æ¡ä»¶äºŒï¼štable == tab //æˆç«‹ï¼šè¯´æ˜ æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¿˜æœªå®Œæˆ //ä¸æˆç«‹ï¼šè¯´æ˜æ‰©å®¹å·²ç»ç»“æŸäº†ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œæœ€åé€€å‡ºçš„çº¿ç¨‹ ä¼šè®¾ç½® nextTable ä¸º table //æ¡ä»¶ä¸‰ï¼š(sc = sizeCtl) &lt; 0 //æˆç«‹ï¼šè¯´æ˜æ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ //ä¸æˆç«‹ï¼šè¯´æ˜sizeCtlå½“å‰æ˜¯ä¸€ä¸ªå¤§äº0çš„æ•°ï¼Œæ­¤æ—¶ä»£è¡¨ä¸‹æ¬¡æ‰©å®¹çš„é˜ˆå€¼ï¼Œå½“å‰æ‰©å®¹å·²ç»ç»“æŸã€‚ while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; 0) &#123; //æ¡ä»¶ä¸€ï¼š(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs // true-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ é æœ¬æ‰¹æ¬¡æ‰©å®¹ // false-&gt;è¯´æ˜å½“å‰çº¿ç¨‹è·å–åˆ°çš„æ‰©å®¹å”¯ä¸€æ ‡è¯†æˆ³ æ˜¯ æœ¬æ‰¹æ¬¡æ‰©å®¹ //æ¡ä»¶äºŒï¼š JDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs &lt;&lt; 16 ) + 1 // true-&gt; è¡¨ç¤ºæ‰©å®¹å®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦å†å‚ä¸è¿›æ¥äº† // false-&gt;æ‰©å®¹è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸ //æ¡ä»¶ä¸‰ï¼šJDK1.8 ä¸­æœ‰bug jiraå·²ç»æå‡ºæ¥äº† å…¶å®æƒ³è¡¨è¾¾çš„æ˜¯ = sc == (rs&lt;&lt;16) + MAX_RESIZERS // true-&gt; è¡¨ç¤ºå½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹è¾¾åˆ°äº†æœ€å¤§å€¼ 65535 - 1 // false-&gt;è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯ä»¥å‚ä¸è¿›æ¥ //æ¡ä»¶å››ï¼štransferIndex &lt;= 0 // true-&gt;è¯´æ˜mapå¯¹è±¡å…¨å±€èŒƒå›´å†…çš„ä»»åŠ¡å·²ç»åˆ†é…å®Œäº†ï¼Œå½“å‰çº¿ç¨‹è¿›å»ä¹Ÿæ²¡æ´»å¹².. // false-&gt;è¿˜æœ‰ä»»åŠ¡å¯ä»¥åˆ†é…ã€‚ if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || transferIndex &lt;= 0) break; if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) &#123; transfer(tab, nextTab); break; &#125; &#125; return nextTab; &#125; return table;&#125; #10.get 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public V get(Object key) &#123; //tab å¼•ç”¨map.table //e å½“å‰å…ƒç´  //p ç›®æ ‡èŠ‚ç‚¹ //n tableæ•°ç»„é•¿åº¦ //eh å½“å‰å…ƒç´ hash //ek å½“å‰å…ƒç´ key Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek; //æ‰°åŠ¨è¿ç®—åå¾—åˆ° æ›´æ•£åˆ—çš„hashå€¼ int h = spread(key.hashCode()); //æ¡ä»¶ä¸€ï¼š(tab = table) != null //true-&gt;è¡¨ç¤ºå·²ç»putè¿‡æ•°æ®ï¼Œå¹¶ä¸”mapå†…éƒ¨çš„tableä¹Ÿå·²ç»åˆå§‹åŒ–å®Œæ¯• //false-&gt;è¡¨ç¤ºåˆ›å»ºå®Œmapåï¼Œå¹¶æ²¡æœ‰putè¿‡æ•°æ®ï¼Œmapå†…éƒ¨çš„tableæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å†™æ•°æ®æ—¶ä¼šè§¦å‘åˆ›å»ºé€»è¾‘ã€‚ //æ¡ä»¶äºŒï¼š(n = tab.length) &gt; 0 true-&gt;è¡¨ç¤ºtableå·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(e = tabAt(tab, (n - 1) &amp; h)) != null //true-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ æœ‰å€¼ //false-&gt;å½“å‰keyå¯»å€çš„æ¡¶ä½ä¸­æ˜¯nullï¼Œæ˜¯nullç›´æ¥è¿”å›null if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123; //å‰ç½®æ¡ä»¶ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ® //å¯¹æ¯”å¤´ç»“ç‚¹hashä¸æŸ¥è¯¢keyçš„hashæ˜¯å¦ä¸€è‡´ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹ä¸æŸ¥è¯¢Keyçš„hashå€¼ å®Œå…¨ä¸€è‡´ if ((eh = e.hash) == h) &#123; //å®Œå…¨æ¯”å¯¹ æŸ¥è¯¢key å’Œ å¤´ç»“ç‚¹çš„key //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å¤´ç»“ç‚¹å°±æ˜¯æŸ¥è¯¢æ•°æ® if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) return e.val; &#125; //æ¡ä»¶æˆç«‹ï¼š //1.-1 fwd è¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ï¼Œä¸”å½“å‰æŸ¥è¯¢çš„è¿™ä¸ªæ¡¶ä½çš„æ•°æ® å·²ç»è¢«è¿ç§»èµ°äº† //2.-2 TreeBinèŠ‚ç‚¹ï¼Œéœ€è¦ä½¿ç”¨TreeBin æä¾›çš„find æ–¹æ³•æŸ¥è¯¢ã€‚ else if (eh &lt; 0) return (p = e.find(h, key)) != null ? p.val : null; //å½“å‰æ¡¶ä½å·²ç»å½¢æˆé“¾è¡¨çš„è¿™ç§æƒ…å†µ while ((e = e.next) != null) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) return e.val; &#125; &#125; return null;&#125; #11.remove 123public V remove(Object key) &#123; return replaceNode(key, null, null);&#125; #12.replaceNode 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143final V replaceNode(Object key, V value, Object cv) &#123; //è®¡ç®—keyç»è¿‡æ‰°åŠ¨è¿ç®—åçš„hash int hash = spread(key.hashCode()); //è‡ªæ—‹ for (Node&lt;K,V&gt;[] tab = table;;) &#123; //fè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ //nè¡¨ç¤ºå½“å‰tableæ•°ç»„é•¿åº¦ //iè¡¨ç¤ºhashå‘½ä¸­æ¡¶ä½ä¸‹æ ‡ //fhè¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹ hash Node&lt;K,V&gt; f; int n, i, fh; //CASE1ï¼š //æ¡ä»¶ä¸€ï¼štab == null true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶äºŒï¼š(n = tab.length) == 0 true-&gt;è¡¨ç¤ºå½“å‰map.tableå°šæœªåˆå§‹åŒ–.. false-&gt;å·²ç»åˆå§‹åŒ– //æ¡ä»¶ä¸‰ï¼š(f = tabAt(tab, i = (n - 1) &amp; hash)) == null true -&gt; è¡¨ç¤ºå‘½ä¸­æ¡¶ä½ä¸­ä¸ºnullï¼Œç›´æ¥breakï¼Œ ä¼šè¿”å› if (tab == null || (n = tab.length) == 0 || (f = tabAt(tab, i = (n - 1) &amp; hash)) == null) break; //CASE2ï¼š //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰tableæ­£åœ¨æ‰©å®¹ä¸­ï¼Œå½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ©tableå®Œæˆæ‰©å®¹ã€‚ else if ((fh = f.hash) == MOVED) tab = helpTransfer(tab, f); //CASE3: //å‰ç½®æ¡ä»¶CASE2 ~ CASE3ï¼šå½“å‰æ¡¶ä½ä¸æ˜¯null //å½“å‰æ¡¶ä½ å¯èƒ½æ˜¯ &quot;é“¾è¡¨&quot; ä¹Ÿå¯èƒ½ æ˜¯ &quot;çº¢é»‘æ ‘&quot; TreeBin else &#123; //ä¿ç•™æ›¿æ¢ä¹‹å‰çš„æ•°æ®å¼•ç”¨ V oldVal = null; //æ ¡éªŒæ ‡è®° boolean validated = false; //åŠ é”å½“å‰æ¡¶ä½ å¤´ç»“ç‚¹ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ ä»£ç å—ã€‚ synchronized (f) &#123; //åˆ¤æ–­syncåŠ é”æ˜¯å¦ä¸ºå½“å‰æ¡¶ä½ å¤´èŠ‚ç‚¹ï¼Œé˜²æ­¢å…¶å®ƒçº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹åŠ é”æˆåŠŸä¹‹å‰ï¼Œä¿®æ”¹è¿‡ æ¡¶ä½ çš„å¤´ç»“ç‚¹ã€‚ //æ¡ä»¶æˆç«‹ï¼šå½“å‰æ¡¶ä½å¤´ç»“ç‚¹ ä»ç„¶ä¸ºfï¼Œå…¶å®ƒçº¿ç¨‹æ²¡ä¿®æ”¹è¿‡ã€‚ if (tabAt(tab, i) == f) &#123; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ¡¶ä½ ä¸º é“¾è¡¨ æˆ–è€… å•ä¸ª node if (fh &gt;= 0) &#123; validated = true; //e è¡¨ç¤ºå½“å‰å¾ªç¯å¤„ç†å…ƒç´  //pred è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ Node&lt;K,V&gt; e = f, pred = null; for (;;) &#123; //å½“å‰èŠ‚ç‚¹key K ek; //æ¡ä»¶ä¸€ï¼še.hash == hash true-&gt;è¯´æ˜å½“å‰èŠ‚ç‚¹çš„hashä¸æŸ¥æ‰¾èŠ‚ç‚¹hashä¸€è‡´ //æ¡ä»¶äºŒï¼š((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) //if æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜key ä¸æŸ¥è¯¢çš„keyå®Œå…¨ä¸€è‡´ã€‚ if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; //å½“å‰èŠ‚ç‚¹çš„value V ev = e.val; //æ¡ä»¶ä¸€ï¼šcv == null true-&gt;æ›¿æ¢çš„å€¼ä¸ºnull é‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªåˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == ev || (ev != null &amp;&amp; cv.equals(ev)) é‚£ä¹ˆæ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (cv == null || cv == ev || (ev != null &amp;&amp; cv.equals(ev))) &#123; //åˆ é™¤ æˆ–è€… æ›¿æ¢ //å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ° oldVal = ev; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œ if (value != null) //ç›´æ¥æ›¿æ¢ e.val = value; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰èŠ‚ç‚¹éå¤´ç»“ç‚¹ else if (pred != null) //å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ pred.next = e.next; else //è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸º å¤´ç»“ç‚¹ï¼Œåªéœ€è¦å°† æ¡¶ä½è®¾ç½®ä¸ºå¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ setTabAt(tab, i, e.next); &#125; break; &#125; pred = e; if ((e = e.next) == null) break; &#125; &#125; //æ¡ä»¶æˆç«‹ï¼šTreeBinèŠ‚ç‚¹ã€‚ else if (f instanceof TreeBin) &#123; validated = true; //è½¬æ¢ä¸ºå®é™…ç±»å‹ TreeBin t TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; //r è¡¨ç¤º çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ //p è¡¨ç¤º çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾åˆ°å¯¹åº”key ä¸€è‡´çš„node TreeNode&lt;K,V&gt; r, p; //æ¡ä»¶ä¸€ï¼š(r = t.root) != null ç†è®ºä¸Šæ˜¯æˆç«‹ //æ¡ä»¶äºŒï¼šTreeNode.findTreeNode ä»¥å½“å‰èŠ‚ç‚¹ä¸ºå…¥å£ï¼Œå‘ä¸‹æŸ¥æ‰¾keyï¼ˆåŒ…æ‹¬æœ¬èº«èŠ‚ç‚¹ï¼‰ // true-&gt;è¯´æ˜æŸ¥æ‰¾åˆ°ç›¸åº”key å¯¹åº”çš„nodeèŠ‚ç‚¹ã€‚ä¼šèµ‹å€¼ç»™p if ((r = t.root) != null &amp;&amp; (p = r.findTreeNode(hash, key, null)) != null) &#123; //ä¿å­˜p.val åˆ°pv V pv = p.val; //æ¡ä»¶ä¸€ï¼šcv == null æˆç«‹ï¼šä¸å¿…å¯¹valueï¼Œå°±åšæ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ //æ¡ä»¶äºŒï¼šcv == pv ||(pv != null &amp;&amp; cv.equals(pv)) æˆç«‹ï¼šè¯´æ˜â€œå¯¹æ¯”å€¼â€ä¸å½“å‰pèŠ‚ç‚¹çš„å€¼ ä¸€è‡´ if (cv == null || cv == pv || (pv != null &amp;&amp; cv.equals(pv))) &#123; //æ›¿æ¢æˆ–è€…åˆ é™¤æ“ä½œ oldVal = pv; //æ¡ä»¶æˆç«‹ï¼šæ›¿æ¢æ“ä½œ if (value != null) p.val = value; //åˆ é™¤æ“ä½œ else if (t.removeTreeNode(p)) //è¿™é‡Œæ²¡åšåˆ¤æ–­ï¼Œç›´æ¥æäº†...å¾ˆç–‘æƒ‘ setTabAt(tab, i, untreeify(t.first)); &#125; &#125; &#125; &#125; &#125; //å½“å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½ å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹ é”é”™å¯¹è±¡æ—¶ï¼Œvalidated ä¸ºfalseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡for è‡ªæ—‹ if (validated) &#123; if (oldVal != null) &#123; //æ›¿æ¢çš„å€¼ ä¸ºnullï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼ŒoldVal ï¼=null æˆç«‹ï¼Œè¯´æ˜åˆ é™¤æˆåŠŸï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‚ if (value == null) addCount(-1L, -1); return oldVal; &#125; break; &#125; &#125; &#125; return null;&#125; #13.TreeBin##13.1 å±æ€§ 1234567891011121314151617//çº¢é»‘æ ‘ æ ¹èŠ‚ç‚¹ TreeNode&lt;K,V&gt; root;//é“¾è¡¨çš„å¤´èŠ‚ç‚¹volatile TreeNode&lt;K,V&gt; first;//ç­‰å¾…è€…çº¿ç¨‹ï¼ˆå½“å‰lockStateæ˜¯è¯»é”çŠ¶æ€ï¼‰volatile Thread waiter;/** * 1.å†™é”çŠ¶æ€ å†™æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ°TreeBinä¸­çš„å†™çº¿ç¨‹ åŒä¸€æ—¶åˆ» åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ 1 * 2.è¯»é”çŠ¶æ€ è¯»é”æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBinå¯¹è±¡ä¸­è·å–æ•°æ®ã€‚ æ¯ä¸€ä¸ªçº¿ç¨‹ éƒ½ä¼šç»™ lockStat + 4 * 3.ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“TreeBinä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆå°±å°†lockStateçš„æœ€ä½2ä½ è®¾ç½®ä¸º 0b 10 */volatile int lockState;// values for lockStatestatic final int WRITER = 1; // set while holding write lockstatic final int WAITER = 2; // set when waiting for write lockstatic final int READER = 4; // increment value for setting read lock ##13.2 æ„é€ å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586TreeBin(TreeNode&lt;K,V&gt; b) &#123; //è®¾ç½®èŠ‚ç‚¹hashä¸º-2 è¡¨ç¤ºæ­¤èŠ‚ç‚¹æ˜¯TreeBinèŠ‚ç‚¹ super(TREEBIN, null, null, null); //ä½¿ç”¨first å¼•ç”¨ treeNodeé“¾è¡¨ this.first = b; //r çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹å¼•ç”¨ TreeNode&lt;K,V&gt; r = null; //xè¡¨ç¤ºéå†çš„å½“å‰èŠ‚ç‚¹ for (TreeNode&lt;K,V&gt; x = b, next; x != null; x = next) &#123; next = (TreeNode&lt;K,V&gt;)x.next; //å¼ºåˆ¶è®¾ç½®å½“å‰æ’å…¥èŠ‚ç‚¹çš„å·¦å³å­æ ‘ä¸ºnull x.left = x.right = null; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰çº¢é»‘æ ‘ æ˜¯ä¸€ä¸ªç©ºæ ‘ï¼Œé‚£ä¹ˆè®¾ç½®æ’å…¥å…ƒç´  ä¸ºæ ¹èŠ‚ç‚¹ if (r == null) &#123; //æ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸€å®šä¸º null x.parent = null; //é¢œè‰²æ”¹ä¸ºé»‘è‰² x.red = false; //è®©rå¼•ç”¨xæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚ r = x; &#125; else &#123; //éç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œéƒ½ä¼šæ¥å¸¦elseåˆ†æ”¯ï¼Œæ­¤æ—¶çº¢é»‘æ ‘å·²ç»æœ‰æ•°æ®äº† //k è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„key K k = x.key; //h è¡¨ç¤º æ’å…¥èŠ‚ç‚¹çš„hash int h = x.hash; //kc è¡¨ç¤º æ’å…¥èŠ‚ç‚¹keyçš„classç±»å‹ Class&lt;?&gt; kc = null; //p è¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; p = r; for (;;) &#123; //dir (-1, 1) //-1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼å¤§äº å½“å‰pèŠ‚ç‚¹çš„hash //1 è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰pèŠ‚ç‚¹çš„hash //ph pè¡¨ç¤º ä¸ºæŸ¥æ‰¾æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„hash int dir, ph; //ä¸´æ—¶èŠ‚ç‚¹ key K pk = p.key; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å°äº å½“å‰èŠ‚ç‚¹ if ((ph = p.hash) &gt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å·¦å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = -1; //æ’å…¥èŠ‚ç‚¹çš„hashå€¼ å¤§äº å½“å‰èŠ‚ç‚¹ else if (ph &lt; h) //æ’å…¥èŠ‚ç‚¹å¯èƒ½éœ€è¦æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ æˆ–è€… ç»§ç»­åœ¨å³å­æ ‘ä¸ŠæŸ¥æ‰¾ dir = 1; //å¦‚æœæ‰§è¡Œåˆ° CASE3ï¼Œè¯´æ˜å½“å‰æ’å…¥èŠ‚ç‚¹çš„hash ä¸ å½“å‰èŠ‚ç‚¹çš„hashä¸€è‡´ï¼Œä¼šåœ¨case3 åšå‡ºæœ€ç»ˆæ’åºã€‚æœ€ç»ˆ //æ‹¿åˆ°çš„dir ä¸€å®šä¸æ˜¯0ï¼Œï¼ˆ-1ï¼Œ 1ï¼‰ else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) dir = tieBreakOrder(k, pk); //xp æƒ³è¦è¡¨ç¤ºçš„æ˜¯ æ’å…¥èŠ‚ç‚¹çš„ çˆ¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; xp = p; //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰pèŠ‚ç‚¹ å³ä¸ºæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ //æ¡ä»¶ä¸æˆç«‹ï¼šè¯´æ˜pèŠ‚ç‚¹ åº•ä¸‹è¿˜æœ‰å±‚æ¬¡ï¼Œéœ€è¦å°†pæŒ‡å‘ pçš„å·¦å­èŠ‚ç‚¹ æˆ–è€… å³å­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºç»§ç»­å‘ä¸‹æœç´¢ã€‚ if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //è®¾ç½®æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ ä¸º å½“å‰èŠ‚ç‚¹ x.parent = xp; //å°äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ if (dir &lt;= 0) xp.left = x; //å¤§äºPèŠ‚ç‚¹ï¼Œéœ€è¦æ’å…¥åˆ°PèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ else xp.right = x; //æ’å…¥èŠ‚ç‚¹åï¼Œçº¢é»‘æ ‘æ€§è´¨ å¯èƒ½ä¼šè¢«ç ´åï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ å¹³è¡¡æ–¹æ³• r = balanceInsertion(r, x); break; &#125; &#125; &#125; &#125; //å°†r èµ‹å€¼ç»™ TreeBinå¯¹è±¡çš„ rootå¼•ç”¨ã€‚ this.root = r; assert checkInvariants(root);&#125; ##13.3 putTreeVal 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970final TreeNode&lt;K,V&gt; putTreeVal(int h, K k, V v) &#123; Class&lt;?&gt; kc = null; boolean searched = false; for (TreeNode&lt;K,V&gt; p = root;;) &#123; int dir, ph; K pk; if (p == null) &#123; first = root = new TreeNode&lt;K,V&gt;(h, k, v, null, null); break; &#125; else if ((ph = p.hash) &gt; h) dir = -1; else if (ph &lt; h) dir = 1; else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk))) return p; else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) &#123; if (!searched) &#123; TreeNode&lt;K,V&gt; q, ch; searched = true; if (((ch = p.left) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null) || ((ch = p.right) != null &amp;&amp; (q = ch.findTreeNode(h, k, kc)) != null)) return q; &#125; dir = tieBreakOrder(k, pk); &#125; TreeNode&lt;K,V&gt; xp = p; if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123; //å½“å‰å¾ªç¯èŠ‚ç‚¹xp å³ä¸º x èŠ‚ç‚¹çš„çˆ¸çˆ¸ //x è¡¨ç¤ºæ’å…¥èŠ‚ç‚¹ //f è€çš„å¤´ç»“ç‚¹ TreeNode&lt;K,V&gt; x, f = first; first = x = new TreeNode&lt;K,V&gt;(h, k, v, f, xp); //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜é“¾è¡¨æœ‰æ•°æ® if (f != null) //è®¾ç½®è€çš„å¤´ç»“ç‚¹çš„å‰ç½®å¼•ç”¨ä¸º å½“å‰çš„å¤´ç»“ç‚¹ã€‚ f.prev = x; if (dir &lt;= 0) xp.left = x; else xp.right = x; if (!xp.red) x.red = true; else &#123; //è¡¨ç¤º å½“å‰æ–°æ’å…¥èŠ‚ç‚¹åï¼Œæ–°æ’å…¥èŠ‚ç‚¹ ä¸ çˆ¶èŠ‚ç‚¹ å½¢æˆ â€œçº¢çº¢ç›¸è¿â€ lockRoot(); try &#123; //å¹³è¡¡çº¢é»‘æ ‘ï¼Œä½¿å…¶å†æ¬¡ç¬¦åˆè§„èŒƒã€‚ root = balanceInsertion(root, x); &#125; finally &#123; unlockRoot(); &#125; &#125; break; &#125; &#125; assert checkInvariants(root); return null;&#125; ##13.4 find 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748final Node&lt;K,V&gt; find(int h, Object k) &#123; if (k != null) &#123; //e è¡¨ç¤ºå¾ªç¯è¿­ä»£çš„å½“å‰èŠ‚ç‚¹ è¿­ä»£çš„æ˜¯firstå¼•ç”¨çš„é“¾è¡¨ for (Node&lt;K,V&gt; e = first; e != null; ) &#123; //s ä¿å­˜çš„æ˜¯lockä¸´æ—¶çŠ¶æ€ //ek é“¾è¡¨å½“å‰èŠ‚ç‚¹ çš„key int s; K ek; //(WAITER|WRITER) =&gt; 0010 | 0001 =&gt; 0011 //lockState &amp; 0011 != 0 æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰TreeBin æœ‰ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… ç›®å‰æœ‰å†™æ“ä½œçº¿ç¨‹æ­£åœ¨åŠ é” if (((s = lockState) &amp; (WAITER|WRITER)) != 0) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek)))) return e; e = e.next; &#125; //å‰ç½®æ¡ä»¶ï¼šå½“å‰TreeBinä¸­ ç­‰å¾…è€…çº¿ç¨‹ æˆ–è€… å†™çº¿ç¨‹ éƒ½æ²¡æœ‰ //æ¡ä»¶æˆç«‹ï¼šè¯´æ˜æ·»åŠ è¯»é”æˆåŠŸ else if (U.compareAndSwapInt(this, LOCKSTATE, s, s + READER)) &#123; TreeNode&lt;K,V&gt; r, p; try &#123; //æŸ¥è¯¢æ“ä½œ p = ((r = root) == null ? null : r.findTreeNode(h, k, null)); &#125; finally &#123; //w è¡¨ç¤ºç­‰å¾…è€…çº¿ç¨‹ Thread w; //U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) //1.å½“å‰çº¿ç¨‹æŸ¥è¯¢çº¢é»‘æ ‘ç»“æŸï¼Œé‡Šæ”¾å½“å‰çº¿ç¨‹çš„è¯»é” å°±æ˜¯è®© lockstate å€¼ - 4 //(READER|WAITER) = 0110 =&gt; è¡¨ç¤ºå½“å‰åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œä¸”â€œæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…â€ //å½“å‰è¯»çº¿ç¨‹ä¸º TreeBinä¸­çš„æœ€åä¸€ä¸ªè¯»çº¿ç¨‹ã€‚ //2.(w = waiter) != null è¯´æ˜æœ‰ä¸€ä¸ªå†™çº¿ç¨‹åœ¨ç­‰å¾…è¯»æ“ä½œå…¨éƒ¨ç»“æŸã€‚ if (U.getAndAddInt(this, LOCKSTATE, -READER) == (READER|WAITER) &amp;&amp; (w = waiter) != null) //ä½¿ç”¨unpark è®© å†™çº¿ç¨‹ æ¢å¤è¿è¡ŒçŠ¶æ€ã€‚ LockSupport.unpark(w); &#125; return p; &#125; &#125; &#125; return null;&#125; #æ€»ç»“åœ¨java8ä¸­ï¼ŒConcurrentHashMapä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»„åˆæ–¹å¼ï¼Œåˆ©ç”¨caså’Œsynchronizedä¿è¯å¹¶å‘å†™çš„å®‰å…¨ã€‚ å¼•å…¥çº¢é»‘æ ‘çš„åŸå› ï¼šé“¾è¡¨æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸ºOnï¼Œä½†æ˜¯çº¢é»‘æ ‘çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(log(n)),æ‰€ä»¥åœ¨èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¢é»‘æ ‘å¯ä»¥å¤§å¤§æå‡æ€§èƒ½ã€‚ é“¾å¼æ¡¶æ˜¯ä¸€ä¸ªç”±nodeèŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨ã€‚æ ‘çŠ¶æ¡¶æ˜¯ä¸€é¢—ç”±TreeNodeèŠ‚ç‚¹ç»„æˆçš„çº¢é»‘æ ‘ã€‚è¾“çš„æ ¹èŠ‚ç‚¹ä¸ºTreeBinç±»å‹ã€‚ å½“é“¾è¡¨é•¿åº¦å¤§äº8æ•´ä¸ªhashè¡¨é•¿åº¦å¤§äº64çš„æ—¶å€™ï¼Œå°±ä¼šè½¬åŒ–ä¸ºTreeBinã€‚TreeBinä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯çº¢é»‘æ ‘å¯¹è±¡ã€‚åœ¨ConcurrentHashMapçš„tableæ•°ç»„ä¸­ï¼Œå­˜æ”¾çš„å°±æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNoeå¯¹è±¡ã€‚ æ•°ç»„tableæ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œæ‰€ä»¥initTable()å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ é‡è¦çš„å±æ€§å°±æ˜¯sizeCtlï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹æ“ä½œçš„è¿‡ç¨‹ï¼š â— -1ä»£è¡¨tableæ­£åœ¨åˆå§‹åŒ–ï¼Œå…¶ä»–çº¿ç¨‹ç›´æ¥joinç­‰å¾…ã€‚ â— -Nä»£è¡¨æœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œä¸¥æ ¼æ¥è¯´ï¼Œå½“å…¶ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œåªç”¨åˆ°äº†ä½16ä½ï¼Œå¦‚æœä½16ä½ä¸ºMï¼Œæ­¤æ—¶æœ‰M-1ä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹ã€‚ â— å¤§äº0æœ‰ä¸¤ç§æƒ…å†µï¼šå¦‚æœtableæ²¡æœ‰åˆå§‹åŒ–ï¼Œå¥¹å°±è¡¨ç¤ºtableåˆå§‹åŒ–çš„å¤§å°ï¼Œå¦‚æœtableåˆå§‹åŒ–å®Œäº†ï¼Œå°±è¡¨ç¤ºtableçš„å®¹é‡ï¼Œé»˜è®¤æ˜¯tableå¤§å°çš„å››åˆ†ä¹‹ä¸‰ã€‚ Transfer()æ‰©å®¹ tableæ•°æ®è½¬ç§»åˆ°nextTableã€‚æ‰©å®¹æ“ä½œçš„æ ¸å¿ƒåœ¨äºæ•°æ®çš„è½¬ç§»ï¼ŒæŠŠæ—§æ•°ç»„ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ã€‚ConcurrentHashMapç²¾åçš„éƒ¨åˆ†æ˜¯å®ƒå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æ¥è¿›è¡ŒååŒæ‰©å®¹ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒæŠŠtableæ•°ç»„å½“ä½œå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆæ¥åˆ’åˆ†æ¯ä¸ªçº¿ç¨‹æ‰€è´Ÿè´£çš„åŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡åŒºé—´é€†å‘éå†æ¥å®ç°æ‰©å®¹ï¼Œä¸€ä¸ªå·²ç»è¿ç§»å®Œçš„ Bucketä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªForwardingèŠ‚ç‚¹ï¼Œæ ‡è®°å½“å‰Bucketå·²ç»è¢«å…¶ä»–çº¿ç¨‹è¿ç§»å®Œäº†ã€‚ helpTransfer()å¸®åŠ©æ‰©å®¹ ConcurrentHashMapå¹¶å‘æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œå…¶ä»–çº¿ç¨‹ä¼šå¸®åŠ©æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å¤šçº¿ç¨‹æ‰©å®¹ã€‚ ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œé»˜è®¤åˆå§‹é•¿åº¦ä¸º16ï¼Œå½“å¾€tableä¸­ç»§ç»­æ·»åŠ å…ƒç´ æ—¶ï¼Œé€šè¿‡Hashå€¼è·Ÿæ•°ç»„é•¿åº¦å–ä½™æ¥å†³å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªBucketä½ç½®ï¼Œå¦‚æœå‡ºç°æ”¾åœ¨åŒä¸€ä¸ªä½ç½®ï¼Œå°±ä¼˜å…ˆä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼Œåœ¨åŒä¸€ä¸ªä½ç½®çš„ä¸ªæ•°è¾¾åˆ°äº†8ä¸ªä»¥ä¸Šï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦è¿˜å°äº64ï¼Œå°±ä¼šæ‰©å®¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64ï¼Œå°±ä¼šå°†è¯¥èŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢æˆæ ‘ã€‚ é€šè¿‡æ‰©å®¹æ•°ç»„çš„æ–¹å¼æ¥æŠŠè¿™äº›èŠ‚ç‚¹åˆ†æ•£å¼€ã€‚ç„¶åå°†è¿™äº›å…ƒç´ å¤åˆ¶åˆ°æ‰©å®¹åçš„æ–°æ•°ç»„ä¸­ï¼ŒåŒä¸€ä¸ªBucketä¸­çš„å…ƒç´ é€šè¿‡Hashå€¼çš„æ•°ç»„é•¿åº¦ä½æ¥é‡æ–°ç¡®å®šä½ç½®ï¼Œå¯èƒ½è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®ï¼Œä¹Ÿå¯èƒ½æ”¾åˆ°æ–°çš„ä½ç½®ã€‚è€Œä¸”ï¼Œåœ¨æ‰©å®¹å®Œæˆä¹‹åï¼Œå¦‚æœä¹‹å‰æŸä¸ªèŠ‚ç‚¹æ˜¯æ ‘ï¼Œä½†æ˜¯ç°åœ¨è¯¥èŠ‚ç‚¹çš„â€œKey-Valueå¯¹â€æ•°åˆå°äºç­‰äº6ä¸ªï¼Œå°±ä¼šå°†è¯¥æ ‘è½¬ä¸ºé“¾è¡¨ã€‚ put() JDK1.8åœ¨ä½¿ç”¨CASè‡ªæ—‹å®Œæˆæ¡¶çš„è®¾ç½®æ—¶ï¼Œä½¿ç”¨synchronizedå†…ç½®é”ä¿è¯æ¡¶å†…å¹¶å‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡å¯¹åŒä¸€ä¸ªMapæ“ä½œçš„çº¿ç¨‹äº‰ç”¨ä¼šéå¸¸æ¿€çƒˆï¼Œä½†æ˜¯åœ¨åŒä¸€ä¸ªæ¡¶å†…çš„çº¿ç¨‹äº‰ç”¨é€šå¸¸ä¸ä¼šå¾ˆæ¿€çƒˆï¼Œæ‰€ä»¥ä½¿ç”¨CASè‡ªæ—‹ã€synchronizedä¸ä¼šé™ä½ConcurrentHashMapçš„æ€§èƒ½ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ReentrantLockæ˜¾å¼é”å‘¢?å¦‚æœä¸ºæ¯ ä¸ªæ¡¶éƒ½åˆ›å»ºä¸€ä¸ªReentrantLockå® ä¾‹ï¼Œå°±ä¼šå¸¦æ¥å¤§é‡çš„å†…å­˜æ¶ˆè€—ï¼Œåè¿‡æ¥ï¼Œä½¿ç”¨CASè‡ªæ—‹ã€synchronizedï¼Œå†…å­˜æ¶ˆè€—çš„å¢åŠ æ›´å°ã€‚ get() get()é€šè¿‡UnSafeçš„getObjectVolatile()æ¥è¯»å–æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åš?è™½ç„¶HashEntryæ•°ç»„çš„å¼•ç”¨æ˜¯volatileç±»å‹ï¼Œä½†æ˜¯æ•°ç»„å†…å…ƒç´ çš„ ç”¨ä¸æ˜¯volatileç±»å‹ï¼Œå› æ­¤å¤šçº¿ç¨‹å¯¹ æ•°ç»„å…ƒç´ çš„ä¿®æ”¹æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šåœ¨æ•°ç»„ä¸­è¯»å–åˆ°å°šæœªæ„é€ å®Œæˆçš„å…ƒç´ å¯¹è±¡ã€‚get()æ–¹æ³•é€šè¿‡UnSafeçš„getObjectVolatileæ–¹æ³•æ¥ä¿è¯å…ƒç´ çš„è¯»å–å®‰å…¨ï¼Œè°ƒç”¨getObjectVolatile()å»è¯»å–æ•°ç»„å…ƒç´ éœ€è¦å…ˆè·å¾—å…ƒç´ åœ¨æ•°ç»„ä¸­çš„åç§»é‡ï¼Œåœ¨è¿™é‡Œï¼Œget()æ–¹æ³•æ ¹æ®å“ˆå¸Œç è®¡ç®—å‡ºåç§»é‡ä¸ºuï¼Œç„¶åé€šè¿‡åç§»é‡uæ¥å°è¯•è¯»å–æ•°å€¼ã€‚","categories":[{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://zhangxin66666.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://zhangxin66666.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]}],"categories":[{"name":"7.mysql","slug":"7-mysql","permalink":"https://zhangxin66666.github.io/categories/7-mysql/"},{"name":"1.åŸºç¡€çŸ¥è¯†","slug":"1-åŸºç¡€çŸ¥è¯†","permalink":"https://zhangxin66666.github.io/categories/1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://zhangxin66666.github.io/tags/Mysql/"},{"name":"é›†åˆæºç åˆ†æ","slug":"é›†åˆæºç åˆ†æ","permalink":"https://zhangxin66666.github.io/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]}